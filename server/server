// @bun
var __create=Object.create;var{getPrototypeOf:__getProtoOf,defineProperty:__defProp,getOwnPropertyNames:__getOwnPropNames}=Object;var __hasOwnProp=Object.prototype.hasOwnProperty;var __toESM=(mod,isNodeMode,target)=>{target=mod!=null?__create(__getProtoOf(mod)):{};let to=isNodeMode||!mod||!mod.__esModule?__defProp(target,"default",{value:mod,enumerable:!0}):target;for(let key of __getOwnPropNames(mod))if(!__hasOwnProp.call(to,key))__defProp(to,key,{get:()=>mod[key],enumerable:!0});return to};var __commonJS=(cb,mod)=>()=>(mod||cb((mod={exports:{}}).exports,mod),mod.exports);var __export=(target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:!0,configurable:!0,set:(newValue)=>all[name]=()=>newValue})};var __require=import.meta.require;var require_dist=__commonJS((exports)=>{Object.defineProperty(exports,"__esModule",{value:!0});exports.parse=parse2;exports.serialize=serialize;var cookieNameRegExp=/^[\u0021-\u003A\u003C\u003E-\u007E]+$/,cookieValueRegExp=/^[\u0021-\u003A\u003C-\u007E]*$/,domainValueRegExp=/^([.]?[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?)([.][a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?)*$/i,pathValueRegExp=/^[\u0020-\u003A\u003D-\u007E]*$/,__toString=Object.prototype.toString,NullObject=(()=>{let C=function(){};return C.prototype=Object.create(null),C})();function parse2(str,options){let obj=new NullObject,len=str.length;if(len<2)return obj;let dec=options?.decode||decode2,index=0;do{let eqIdx=str.indexOf("=",index);if(eqIdx===-1)break;let colonIdx=str.indexOf(";",index),endIdx=colonIdx===-1?len:colonIdx;if(eqIdx>endIdx){index=str.lastIndexOf(";",eqIdx-1)+1;continue}let keyStartIdx=startIndex(str,index,eqIdx),keyEndIdx=endIndex(str,eqIdx,keyStartIdx),key=str.slice(keyStartIdx,keyEndIdx);if(obj[key]===void 0){let valStartIdx=startIndex(str,eqIdx+1,endIdx),valEndIdx=endIndex(str,endIdx,valStartIdx),value=dec(str.slice(valStartIdx,valEndIdx));obj[key]=value}index=endIdx+1}while(index<len);return obj}function startIndex(str,index,max){do{let code=str.charCodeAt(index);if(code!==32&&code!==9)return index}while(++index<max);return max}function endIndex(str,index,min){while(index>min){let code=str.charCodeAt(--index);if(code!==32&&code!==9)return index+1}return min}function serialize(name,val,options){let enc=options?.encode||encodeURIComponent;if(!cookieNameRegExp.test(name))throw new TypeError(`argument name is invalid: ${name}`);let value=enc(val);if(!cookieValueRegExp.test(value))throw new TypeError(`argument val is invalid: ${val}`);let str=name+"="+value;if(!options)return str;if(options.maxAge!==void 0){if(!Number.isInteger(options.maxAge))throw new TypeError(`option maxAge is invalid: ${options.maxAge}`);str+="; Max-Age="+options.maxAge}if(options.domain){if(!domainValueRegExp.test(options.domain))throw new TypeError(`option domain is invalid: ${options.domain}`);str+="; Domain="+options.domain}if(options.path){if(!pathValueRegExp.test(options.path))throw new TypeError(`option path is invalid: ${options.path}`);str+="; Path="+options.path}if(options.expires){if(!isDate(options.expires)||!Number.isFinite(options.expires.valueOf()))throw new TypeError(`option expires is invalid: ${options.expires}`);str+="; Expires="+options.expires.toUTCString()}if(options.httpOnly)str+="; HttpOnly";if(options.secure)str+="; Secure";if(options.partitioned)str+="; Partitioned";if(options.priority)switch(typeof options.priority==="string"?options.priority.toLowerCase():void 0){case"low":str+="; Priority=Low";break;case"medium":str+="; Priority=Medium";break;case"high":str+="; Priority=High";break;default:throw new TypeError(`option priority is invalid: ${options.priority}`)}if(options.sameSite)switch(typeof options.sameSite==="string"?options.sameSite.toLowerCase():options.sameSite){case!0:case"strict":str+="; SameSite=Strict";break;case"lax":str+="; SameSite=Lax";break;case"none":str+="; SameSite=None";break;default:throw new TypeError(`option sameSite is invalid: ${options.sameSite}`)}return str}function decode2(str){if(str.indexOf("%")===-1)return str;try{return decodeURIComponent(str)}catch(e){return str}}function isDate(val){return __toString.call(val)==="[object Date]"}});var require_package=__commonJS((exports,module)=>{module.exports={name:"dotenv",version:"16.5.0",description:"Loads environment variables from .env file",main:"lib/main.js",types:"lib/main.d.ts",exports:{".":{types:"./lib/main.d.ts",require:"./lib/main.js",default:"./lib/main.js"},"./config":"./config.js","./config.js":"./config.js","./lib/env-options":"./lib/env-options.js","./lib/env-options.js":"./lib/env-options.js","./lib/cli-options":"./lib/cli-options.js","./lib/cli-options.js":"./lib/cli-options.js","./package.json":"./package.json"},scripts:{"dts-check":"tsc --project tests/types/tsconfig.json",lint:"standard",pretest:"npm run lint && npm run dts-check",test:"tap run --allow-empty-coverage --disable-coverage --timeout=60000","test:coverage":"tap run --show-full-coverage --timeout=60000 --coverage-report=lcov",prerelease:"npm test",release:"standard-version"},repository:{type:"git",url:"git://github.com/motdotla/dotenv.git"},homepage:"https://github.com/motdotla/dotenv#readme",funding:"https://dotenvx.com",keywords:["dotenv","env",".env","environment","variables","config","settings"],readmeFilename:"README.md",license:"BSD-2-Clause",devDependencies:{"@types/node":"^18.11.3",decache:"^4.6.2",sinon:"^14.0.1",standard:"^17.0.0","standard-version":"^9.5.0",tap:"^19.2.0",typescript:"^4.8.4"},engines:{node:">=12"},browser:{fs:!1}}});var require_main=__commonJS((exports,module)=>{var fs=__require("fs"),path=__require("path"),os=__require("os"),crypto2=__require("crypto"),packageJson=require_package(),version2=packageJson.version,LINE=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/mg;function parse3(src){let obj={},lines=src.toString();lines=lines.replace(/\r\n?/mg,`
`);let match;while((match=LINE.exec(lines))!=null){let key=match[1],value=match[2]||"";value=value.trim();let maybeQuote=value[0];if(value=value.replace(/^(['"`])([\s\S]*)\1$/mg,"$2"),maybeQuote==='"')value=value.replace(/\\n/g,`
`),value=value.replace(/\\r/g,"\r");obj[key]=value}return obj}function _parseVault(options){let vaultPath=_vaultPath(options),result=DotenvModule.configDotenv({path:vaultPath});if(!result.parsed){let err=new Error(`MISSING_DATA: Cannot parse ${vaultPath} for an unknown reason`);throw err.code="MISSING_DATA",err}let keys=_dotenvKey(options).split(","),length=keys.length,decrypted;for(let i=0;i<length;i++)try{let key=keys[i].trim(),attrs=_instructions(result,key);decrypted=DotenvModule.decrypt(attrs.ciphertext,attrs.key);break}catch(error2){if(i+1>=length)throw error2}return DotenvModule.parse(decrypted)}function _warn(message){console.log(`[dotenv@${version2}][WARN] ${message}`)}function _debug(message){console.log(`[dotenv@${version2}][DEBUG] ${message}`)}function _dotenvKey(options){if(options&&options.DOTENV_KEY&&options.DOTENV_KEY.length>0)return options.DOTENV_KEY;if(process.env.DOTENV_KEY&&process.env.DOTENV_KEY.length>0)return process.env.DOTENV_KEY;return""}function _instructions(result,dotenvKey){let uri2;try{uri2=new URL(dotenvKey)}catch(error2){if(error2.code==="ERR_INVALID_URL"){let err=new Error("INVALID_DOTENV_KEY: Wrong format. Must be in valid uri format like dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=development");throw err.code="INVALID_DOTENV_KEY",err}throw error2}let key=uri2.password;if(!key){let err=new Error("INVALID_DOTENV_KEY: Missing key part");throw err.code="INVALID_DOTENV_KEY",err}let environment=uri2.searchParams.get("environment");if(!environment){let err=new Error("INVALID_DOTENV_KEY: Missing environment part");throw err.code="INVALID_DOTENV_KEY",err}let environmentKey=`DOTENV_VAULT_${environment.toUpperCase()}`,ciphertext=result.parsed[environmentKey];if(!ciphertext){let err=new Error(`NOT_FOUND_DOTENV_ENVIRONMENT: Cannot locate environment ${environmentKey} in your .env.vault file.`);throw err.code="NOT_FOUND_DOTENV_ENVIRONMENT",err}return{ciphertext,key}}function _vaultPath(options){let possibleVaultPath=null;if(options&&options.path&&options.path.length>0)if(Array.isArray(options.path)){for(let filepath of options.path)if(fs.existsSync(filepath))possibleVaultPath=filepath.endsWith(".vault")?filepath:`${filepath}.vault`}else possibleVaultPath=options.path.endsWith(".vault")?options.path:`${options.path}.vault`;else possibleVaultPath=path.resolve(process.cwd(),".env.vault");if(fs.existsSync(possibleVaultPath))return possibleVaultPath;return null}function _resolveHome(envPath){return envPath[0]==="~"?path.join(os.homedir(),envPath.slice(1)):envPath}function _configVault(options){if(Boolean(options&&options.debug))_debug("Loading env from encrypted .env.vault");let parsed=DotenvModule._parseVault(options),processEnv=process.env;if(options&&options.processEnv!=null)processEnv=options.processEnv;return DotenvModule.populate(processEnv,parsed,options),{parsed}}function configDotenv(options){let dotenvPath=path.resolve(process.cwd(),".env"),encoding="utf8",debug=Boolean(options&&options.debug);if(options&&options.encoding)encoding=options.encoding;else if(debug)_debug("No encoding is specified. UTF-8 is used by default");let optionPaths=[dotenvPath];if(options&&options.path)if(!Array.isArray(options.path))optionPaths=[_resolveHome(options.path)];else{optionPaths=[];for(let filepath of options.path)optionPaths.push(_resolveHome(filepath))}let lastError,parsedAll={};for(let path2 of optionPaths)try{let parsed=DotenvModule.parse(fs.readFileSync(path2,{encoding}));DotenvModule.populate(parsedAll,parsed,options)}catch(e){if(debug)_debug(`Failed to load ${path2} ${e.message}`);lastError=e}let processEnv=process.env;if(options&&options.processEnv!=null)processEnv=options.processEnv;if(DotenvModule.populate(processEnv,parsedAll,options),lastError)return{parsed:parsedAll,error:lastError};else return{parsed:parsedAll}}function config(options){if(_dotenvKey(options).length===0)return DotenvModule.configDotenv(options);let vaultPath=_vaultPath(options);if(!vaultPath)return _warn(`You set DOTENV_KEY but you are missing a .env.vault file at ${vaultPath}. Did you forget to build it?`),DotenvModule.configDotenv(options);return DotenvModule._configVault(options)}function decrypt(encrypted,keyStr){let key=Buffer.from(keyStr.slice(-64),"hex"),ciphertext=Buffer.from(encrypted,"base64"),nonce=ciphertext.subarray(0,12),authTag=ciphertext.subarray(-16);ciphertext=ciphertext.subarray(12,-16);try{let aesgcm=crypto2.createDecipheriv("aes-256-gcm",key,nonce);return aesgcm.setAuthTag(authTag),`${aesgcm.update(ciphertext)}${aesgcm.final()}`}catch(error2){let isRange=error2 instanceof RangeError,invalidKeyLength=error2.message==="Invalid key length",decryptionFailed=error2.message==="Unsupported state or unable to authenticate data";if(isRange||invalidKeyLength){let err=new Error("INVALID_DOTENV_KEY: It must be 64 characters long (or more)");throw err.code="INVALID_DOTENV_KEY",err}else if(decryptionFailed){let err=new Error("DECRYPTION_FAILED: Please check your DOTENV_KEY");throw err.code="DECRYPTION_FAILED",err}else throw error2}}function populate(processEnv,parsed,options={}){let debug=Boolean(options&&options.debug),override=Boolean(options&&options.override);if(typeof parsed!=="object"){let err=new Error("OBJECT_REQUIRED: Please check the processEnv argument being passed to populate");throw err.code="OBJECT_REQUIRED",err}for(let key of Object.keys(parsed))if(Object.prototype.hasOwnProperty.call(processEnv,key)){if(override===!0)processEnv[key]=parsed[key];if(debug)if(override===!0)_debug(`"${key}" is already defined and WAS overwritten`);else _debug(`"${key}" is already defined and was NOT overwritten`)}else processEnv[key]=parsed[key]}var DotenvModule={configDotenv,_configVault,_parseVault,config,decrypt,parse:parse3,populate};exports.configDotenv=DotenvModule.configDotenv;exports._configVault=DotenvModule._configVault;exports._parseVault=DotenvModule._parseVault;exports.config=DotenvModule.config;exports.decrypt=DotenvModule.decrypt;exports.parse=DotenvModule.parse;exports.populate=DotenvModule.populate;module.exports=DotenvModule});var require_env_options=__commonJS((exports,module)=>{var options={};if(process.env.DOTENV_CONFIG_ENCODING!=null)options.encoding=process.env.DOTENV_CONFIG_ENCODING;if(process.env.DOTENV_CONFIG_PATH!=null)options.path=process.env.DOTENV_CONFIG_PATH;if(process.env.DOTENV_CONFIG_DEBUG!=null)options.debug=process.env.DOTENV_CONFIG_DEBUG;if(process.env.DOTENV_CONFIG_OVERRIDE!=null)options.override=process.env.DOTENV_CONFIG_OVERRIDE;if(process.env.DOTENV_CONFIG_DOTENV_KEY!=null)options.DOTENV_KEY=process.env.DOTENV_CONFIG_DOTENV_KEY;module.exports=options});var require_cli_options=__commonJS((exports,module)=>{var re=/^dotenv_config_(encoding|path|debug|override|DOTENV_KEY)=(.+)$/;module.exports=function optionMatcher(args){return args.reduce(function(acc,cur){let matches=cur.match(re);if(matches)acc[matches[1]]=matches[2];return acc},{})}});var require_config=__commonJS(()=>{(function(){require_main().config(Object.assign({},require_env_options(),require_cli_options()(process.argv)))})()});var require_format=__commonJS((exports,module)=>{var idRegex=/^[a-z0-9-]{1,32}$/,nameRegex=/^[a-z0-9-]{1,32}$/,valueRegex=/^[a-zA-Z0-9/+.-]+$/,b64Regex=/^([a-zA-Z0-9/+.-]+|)$/,decimalRegex=/^((-)?[1-9]\d*|0)$/,versionRegex=/^v=(\d+)$/;function objToKeyVal(obj){return objectKeys(obj).map((k2)=>[k2,obj[k2]].join("=")).join(",")}function keyValtoObj(str){let obj={};return str.split(",").forEach((ps)=>{let pss=ps.split("=");if(pss.length<2)throw new TypeError("params must be in the format name=value");obj[pss.shift()]=pss.join("=")}),obj}function objectKeys(object){return Object.keys(object)}function objectValues(object){if(typeof Object.values==="function")return Object.values(object);return objectKeys(object).map((k2)=>object[k2])}function serialize2(opts){let fields=[""];if(typeof opts!=="object"||opts===null)throw new TypeError("opts must be an object");if(typeof opts.id!=="string")throw new TypeError("id must be a string");if(!idRegex.test(opts.id))throw new TypeError(`id must satisfy ${idRegex}`);if(fields.push(opts.id),typeof opts.version!=="undefined"){if(typeof opts.version!=="number"||opts.version<0||!Number.isInteger(opts.version))throw new TypeError("version must be a positive integer number");fields.push(`v=${opts.version}`)}if(typeof opts.params!=="undefined"){if(typeof opts.params!=="object"||opts.params===null)throw new TypeError("params must be an object");let pk=objectKeys(opts.params);if(!pk.every((p)=>nameRegex.test(p)))throw new TypeError(`params names must satisfy ${nameRegex}`);pk.forEach((k2)=>{if(typeof opts.params[k2]==="number")opts.params[k2]=opts.params[k2].toString();else if(Buffer.isBuffer(opts.params[k2]))opts.params[k2]=opts.params[k2].toString("base64").split("=")[0]});let pv=objectValues(opts.params);if(!pv.every((v)=>typeof v==="string"))throw new TypeError("params values must be strings");if(!pv.every((v)=>valueRegex.test(v)))throw new TypeError(`params values must satisfy ${valueRegex}`);let strpar=objToKeyVal(opts.params);fields.push(strpar)}if(typeof opts.salt!=="undefined"){if(!Buffer.isBuffer(opts.salt))throw new TypeError("salt must be a Buffer");if(fields.push(opts.salt.toString("base64").split("=")[0]),typeof opts.hash!=="undefined"){if(!Buffer.isBuffer(opts.hash))throw new TypeError("hash must be a Buffer");fields.push(opts.hash.toString("base64").split("=")[0])}}return fields.join("$")}function deserialize(phcstr){if(typeof phcstr!=="string"||phcstr==="")throw new TypeError("pchstr must be a non-empty string");if(phcstr[0]!=="$")throw new TypeError("pchstr must contain a $ as first char");let fields=phcstr.split("$");fields.shift();let maxf=5;if(!versionRegex.test(fields[1]))maxf--;if(fields.length>maxf)throw new TypeError(`pchstr contains too many fileds: ${fields.length}/${maxf}`);let id=fields.shift();if(!idRegex.test(id))throw new TypeError(`id must satisfy ${idRegex}`);let version2;if(versionRegex.test(fields[0]))version2=parseInt(fields.shift().match(versionRegex)[1],10);let hash2,salt;if(b64Regex.test(fields[fields.length-1]))if(fields.length>1&&b64Regex.test(fields[fields.length-2]))hash2=Buffer.from(fields.pop(),"base64"),salt=Buffer.from(fields.pop(),"base64");else salt=Buffer.from(fields.pop(),"base64");let params;if(fields.length>0){let parstr=fields.pop();if(params=keyValtoObj(parstr),!objectKeys(params).every((p)=>nameRegex.test(p)))throw new TypeError(`params names must satisfy ${nameRegex}`);if(!objectValues(params).every((v)=>valueRegex.test(v)))throw new TypeError(`params values must satisfy ${valueRegex}`);objectKeys(params).forEach((k2)=>{params[k2]=decimalRegex.test(params[k2])?parseInt(params[k2],10):params[k2]})}if(fields.length>0)throw new TypeError(`pchstr contains unrecognized fileds: ${fields}`);let phcobj={id};if(version2)phcobj.version=version2;if(params)phcobj.params=params;if(salt)phcobj.salt=salt;if(hash2)phcobj.hash=hash2;return phcobj}module.exports={serialize:serialize2,deserialize}});var require_node_gyp_build=__commonJS((exports,module)=>{var fs2=__require("fs"),path=__require("path"),os2=__require("os"),runtimeRequire=typeof __webpack_require__==="function"?__non_webpack_require__:__require,vars=process.config&&process.config.variables||{},prebuildsOnly=!!process.env.PREBUILDS_ONLY,abi=process.versions.modules,runtime=isElectron()?"electron":isNwjs()?"node-webkit":"node",arch=process.env.npm_config_arch||os2.arch(),platform=process.env.npm_config_platform||os2.platform(),libc=process.env.LIBC||(isAlpine(platform)?"musl":"glibc"),armv=process.env.ARM_VERSION||(arch==="arm64"?"8":vars.arm_version)||"",uv=(process.versions.uv||"").split(".")[0];module.exports=load;function load(dir){return runtimeRequire(load.resolve(dir))}load.resolve=load.path=function(dir){dir=path.resolve(dir||".");try{var name=runtimeRequire(path.join(dir,"package.json")).name.toUpperCase().replace(/-/g,"_");if(process.env[name+"_PREBUILD"])dir=process.env[name+"_PREBUILD"]}catch(err){}if(!prebuildsOnly){var release=getFirst(path.join(dir,"build/Release"),matchBuild);if(release)return release;var debug=getFirst(path.join(dir,"build/Debug"),matchBuild);if(debug)return debug}var prebuild=resolve(dir);if(prebuild)return prebuild;var nearby=resolve(path.dirname(process.execPath));if(nearby)return nearby;var target=["platform="+platform,"arch="+arch,"runtime="+runtime,"abi="+abi,"uv="+uv,armv?"armv="+armv:"","libc="+libc,"node="+process.versions.node,process.versions.electron?"electron="+process.versions.electron:"",typeof __webpack_require__==="function"?"webpack=true":""].filter(Boolean).join(" ");throw new Error("No native build was found for "+target+`
    loaded from: `+dir+`
`);function resolve(dir2){var tuples2=readdirSync(path.join(dir2,"prebuilds")).map(parseTuple),tuple=tuples2.filter(matchTuple(platform,arch)).sort(compareTuples)[0];if(!tuple)return;var prebuilds=path.join(dir2,"prebuilds",tuple.name),parsed=readdirSync(prebuilds).map(parseTags),candidates=parsed.filter(matchTags(runtime,abi)),winner=candidates.sort(compareTags(runtime))[0];if(winner)return path.join(prebuilds,winner.file)}};function readdirSync(dir){try{return fs2.readdirSync(dir)}catch(err){return[]}}function getFirst(dir,filter){var files=readdirSync(dir).filter(filter);return files[0]&&path.join(dir,files[0])}function matchBuild(name){return/\.node$/.test(name)}function parseTuple(name){var arr=name.split("-");if(arr.length!==2)return;var platform2=arr[0],architectures=arr[1].split("+");if(!platform2)return;if(!architectures.length)return;if(!architectures.every(Boolean))return;return{name,platform:platform2,architectures}}function matchTuple(platform2,arch2){return function(tuple){if(tuple==null)return!1;if(tuple.platform!==platform2)return!1;return tuple.architectures.includes(arch2)}}function compareTuples(a,b2){return a.architectures.length-b2.architectures.length}function parseTags(file){var arr=file.split("."),extension=arr.pop(),tags={file,specificity:0};if(extension!=="node")return;for(var i=0;i<arr.length;i++){var tag=arr[i];if(tag==="node"||tag==="electron"||tag==="node-webkit")tags.runtime=tag;else if(tag==="napi")tags.napi=!0;else if(tag.slice(0,3)==="abi")tags.abi=tag.slice(3);else if(tag.slice(0,2)==="uv")tags.uv=tag.slice(2);else if(tag.slice(0,4)==="armv")tags.armv=tag.slice(4);else if(tag==="glibc"||tag==="musl")tags.libc=tag;else continue;tags.specificity++}return tags}function matchTags(runtime2,abi2){return function(tags){if(tags==null)return!1;if(tags.runtime&&tags.runtime!==runtime2&&!runtimeAgnostic(tags))return!1;if(tags.abi&&tags.abi!==abi2&&!tags.napi)return!1;if(tags.uv&&tags.uv!==uv)return!1;if(tags.armv&&tags.armv!==armv)return!1;if(tags.libc&&tags.libc!==libc)return!1;return!0}}function runtimeAgnostic(tags){return tags.runtime==="node"&&tags.napi}function compareTags(runtime2){return function(a,b2){if(a.runtime!==b2.runtime)return a.runtime===runtime2?-1:1;else if(a.abi!==b2.abi)return a.abi?-1:1;else if(a.specificity!==b2.specificity)return a.specificity>b2.specificity?-1:1;else return 0}}function isNwjs(){return!!(process.versions&&process.versions.nw)}function isElectron(){if(process.versions&&process.versions.electron)return!0;if(process.env.ELECTRON_RUN_AS_NODE)return!0;return typeof window!=="undefined"&&window.process&&window.process.type==="renderer"}function isAlpine(platform2){return platform2==="linux"&&fs2.existsSync("/etc/alpine-release")}load.parseTags=parseTags;load.matchTags=matchTags;load.compareTags=compareTags;load.parseTuple=parseTuple;load.matchTuple=matchTuple;load.compareTuples=compareTuples});var require_node_gyp_build2=__commonJS((exports,module)=>{var runtimeRequire=typeof __webpack_require__==="function"?__non_webpack_require__:__require;if(typeof runtimeRequire.addon==="function")module.exports=runtimeRequire.addon.bind(runtimeRequire);else module.exports=require_node_gyp_build()});var require_argon2=__commonJS((exports,module)=>{var __dirname="/home/twahir/Desktop/postech_dev/server/node_modules/argon2",assert2=__require("assert"),{randomBytes,timingSafeEqual}=__require("crypto"),{promisify}=__require("util"),{deserialize,serialize:serialize2}=require_format(),gypBuild=require_node_gyp_build2(),{hash:bindingsHash}=gypBuild(__dirname),generateSalt=promisify(randomBytes);exports.argon2d=0;exports.argon2i=1;exports.argon2id=2;var types2=Object.freeze({argon2d:0,argon2i:1,argon2id:2}),names=Object.freeze({[types2.argon2d]:"argon2d",[types2.argon2i]:"argon2i",[types2.argon2id]:"argon2id"}),defaults=Object.freeze({hashLength:32,timeCost:3,memoryCost:65536,parallelism:4,type:2,version:19}),limits=Object.freeze({hashLength:{min:4,max:4294967295},memoryCost:{min:1024,max:4294967295},timeCost:{min:2,max:4294967295},parallelism:{min:1,max:16777215}});exports.limits=limits;async function hash2(password,options){let{raw,salt,...rest}={...defaults,...options};for(let[key,{min,max}]of Object.entries(limits)){let value=rest[key];assert2(min<=value&&value<=max,`Invalid ${key}, must be between ${min} and ${max}.`)}salt=salt??await generateSalt(16);let{hashLength,secret=Buffer.alloc(0),type:type2,version:version2,memoryCost:m,timeCost:t2,parallelism:p,associatedData:data=Buffer.alloc(0)}=rest,hash3=await bindingsHash({password:Buffer.from(password),salt,secret,data,hashLength,m,t:t2,p,version:version2,type:type2});if(raw)return hash3;return serialize2({id:names[type2],version:version2,params:{m,t:t2,p,...data.byteLength>0?{data}:{}},salt,hash:hash3})}exports.hash=hash2;function needsRehash(digest,options={}){let{memoryCost,timeCost,version:version2}={...defaults,...options},{version:v,params:{m,t:t2}}=deserialize(digest);return+v!==+version2||+m!==+memoryCost||+t2!==+timeCost}exports.needsRehash=needsRehash;async function verify(digest,password,options={}){let{id,...rest}=deserialize(digest);if(!(id in types2))return!1;let{version:version2=16,params:{m,t:t2,p,data=""},salt,hash:hash3}=rest,{secret=Buffer.alloc(0)}=options;return timingSafeEqual(await bindingsHash({password:Buffer.from(password),salt,secret,data:Buffer.from(data,"base64"),hashLength:hash3.byteLength,m:+m,t:+t2,p:+p,version:+version2,type:types2[id]}),hash3)}exports.verify=verify});var require_default=__commonJS((exports)=>{function getDefaultWhiteList(){var whiteList={};return whiteList["align-content"]=!1,whiteList["align-items"]=!1,whiteList["align-self"]=!1,whiteList["alignment-adjust"]=!1,whiteList["alignment-baseline"]=!1,whiteList.all=!1,whiteList["anchor-point"]=!1,whiteList.animation=!1,whiteList["animation-delay"]=!1,whiteList["animation-direction"]=!1,whiteList["animation-duration"]=!1,whiteList["animation-fill-mode"]=!1,whiteList["animation-iteration-count"]=!1,whiteList["animation-name"]=!1,whiteList["animation-play-state"]=!1,whiteList["animation-timing-function"]=!1,whiteList.azimuth=!1,whiteList["backface-visibility"]=!1,whiteList.background=!0,whiteList["background-attachment"]=!0,whiteList["background-clip"]=!0,whiteList["background-color"]=!0,whiteList["background-image"]=!0,whiteList["background-origin"]=!0,whiteList["background-position"]=!0,whiteList["background-repeat"]=!0,whiteList["background-size"]=!0,whiteList["baseline-shift"]=!1,whiteList.binding=!1,whiteList.bleed=!1,whiteList["bookmark-label"]=!1,whiteList["bookmark-level"]=!1,whiteList["bookmark-state"]=!1,whiteList.border=!0,whiteList["border-bottom"]=!0,whiteList["border-bottom-color"]=!0,whiteList["border-bottom-left-radius"]=!0,whiteList["border-bottom-right-radius"]=!0,whiteList["border-bottom-style"]=!0,whiteList["border-bottom-width"]=!0,whiteList["border-collapse"]=!0,whiteList["border-color"]=!0,whiteList["border-image"]=!0,whiteList["border-image-outset"]=!0,whiteList["border-image-repeat"]=!0,whiteList["border-image-slice"]=!0,whiteList["border-image-source"]=!0,whiteList["border-image-width"]=!0,whiteList["border-left"]=!0,whiteList["border-left-color"]=!0,whiteList["border-left-style"]=!0,whiteList["border-left-width"]=!0,whiteList["border-radius"]=!0,whiteList["border-right"]=!0,whiteList["border-right-color"]=!0,whiteList["border-right-style"]=!0,whiteList["border-right-width"]=!0,whiteList["border-spacing"]=!0,whiteList["border-style"]=!0,whiteList["border-top"]=!0,whiteList["border-top-color"]=!0,whiteList["border-top-left-radius"]=!0,whiteList["border-top-right-radius"]=!0,whiteList["border-top-style"]=!0,whiteList["border-top-width"]=!0,whiteList["border-width"]=!0,whiteList.bottom=!1,whiteList["box-decoration-break"]=!0,whiteList["box-shadow"]=!0,whiteList["box-sizing"]=!0,whiteList["box-snap"]=!0,whiteList["box-suppress"]=!0,whiteList["break-after"]=!0,whiteList["break-before"]=!0,whiteList["break-inside"]=!0,whiteList["caption-side"]=!1,whiteList.chains=!1,whiteList.clear=!0,whiteList.clip=!1,whiteList["clip-path"]=!1,whiteList["clip-rule"]=!1,whiteList.color=!0,whiteList["color-interpolation-filters"]=!0,whiteList["column-count"]=!1,whiteList["column-fill"]=!1,whiteList["column-gap"]=!1,whiteList["column-rule"]=!1,whiteList["column-rule-color"]=!1,whiteList["column-rule-style"]=!1,whiteList["column-rule-width"]=!1,whiteList["column-span"]=!1,whiteList["column-width"]=!1,whiteList.columns=!1,whiteList.contain=!1,whiteList.content=!1,whiteList["counter-increment"]=!1,whiteList["counter-reset"]=!1,whiteList["counter-set"]=!1,whiteList.crop=!1,whiteList.cue=!1,whiteList["cue-after"]=!1,whiteList["cue-before"]=!1,whiteList.cursor=!1,whiteList.direction=!1,whiteList.display=!0,whiteList["display-inside"]=!0,whiteList["display-list"]=!0,whiteList["display-outside"]=!0,whiteList["dominant-baseline"]=!1,whiteList.elevation=!1,whiteList["empty-cells"]=!1,whiteList.filter=!1,whiteList.flex=!1,whiteList["flex-basis"]=!1,whiteList["flex-direction"]=!1,whiteList["flex-flow"]=!1,whiteList["flex-grow"]=!1,whiteList["flex-shrink"]=!1,whiteList["flex-wrap"]=!1,whiteList.float=!1,whiteList["float-offset"]=!1,whiteList["flood-color"]=!1,whiteList["flood-opacity"]=!1,whiteList["flow-from"]=!1,whiteList["flow-into"]=!1,whiteList.font=!0,whiteList["font-family"]=!0,whiteList["font-feature-settings"]=!0,whiteList["font-kerning"]=!0,whiteList["font-language-override"]=!0,whiteList["font-size"]=!0,whiteList["font-size-adjust"]=!0,whiteList["font-stretch"]=!0,whiteList["font-style"]=!0,whiteList["font-synthesis"]=!0,whiteList["font-variant"]=!0,whiteList["font-variant-alternates"]=!0,whiteList["font-variant-caps"]=!0,whiteList["font-variant-east-asian"]=!0,whiteList["font-variant-ligatures"]=!0,whiteList["font-variant-numeric"]=!0,whiteList["font-variant-position"]=!0,whiteList["font-weight"]=!0,whiteList.grid=!1,whiteList["grid-area"]=!1,whiteList["grid-auto-columns"]=!1,whiteList["grid-auto-flow"]=!1,whiteList["grid-auto-rows"]=!1,whiteList["grid-column"]=!1,whiteList["grid-column-end"]=!1,whiteList["grid-column-start"]=!1,whiteList["grid-row"]=!1,whiteList["grid-row-end"]=!1,whiteList["grid-row-start"]=!1,whiteList["grid-template"]=!1,whiteList["grid-template-areas"]=!1,whiteList["grid-template-columns"]=!1,whiteList["grid-template-rows"]=!1,whiteList["hanging-punctuation"]=!1,whiteList.height=!0,whiteList.hyphens=!1,whiteList.icon=!1,whiteList["image-orientation"]=!1,whiteList["image-resolution"]=!1,whiteList["ime-mode"]=!1,whiteList["initial-letters"]=!1,whiteList["inline-box-align"]=!1,whiteList["justify-content"]=!1,whiteList["justify-items"]=!1,whiteList["justify-self"]=!1,whiteList.left=!1,whiteList["letter-spacing"]=!0,whiteList["lighting-color"]=!0,whiteList["line-box-contain"]=!1,whiteList["line-break"]=!1,whiteList["line-grid"]=!1,whiteList["line-height"]=!1,whiteList["line-snap"]=!1,whiteList["line-stacking"]=!1,whiteList["line-stacking-ruby"]=!1,whiteList["line-stacking-shift"]=!1,whiteList["line-stacking-strategy"]=!1,whiteList["list-style"]=!0,whiteList["list-style-image"]=!0,whiteList["list-style-position"]=!0,whiteList["list-style-type"]=!0,whiteList.margin=!0,whiteList["margin-bottom"]=!0,whiteList["margin-left"]=!0,whiteList["margin-right"]=!0,whiteList["margin-top"]=!0,whiteList["marker-offset"]=!1,whiteList["marker-side"]=!1,whiteList.marks=!1,whiteList.mask=!1,whiteList["mask-box"]=!1,whiteList["mask-box-outset"]=!1,whiteList["mask-box-repeat"]=!1,whiteList["mask-box-slice"]=!1,whiteList["mask-box-source"]=!1,whiteList["mask-box-width"]=!1,whiteList["mask-clip"]=!1,whiteList["mask-image"]=!1,whiteList["mask-origin"]=!1,whiteList["mask-position"]=!1,whiteList["mask-repeat"]=!1,whiteList["mask-size"]=!1,whiteList["mask-source-type"]=!1,whiteList["mask-type"]=!1,whiteList["max-height"]=!0,whiteList["max-lines"]=!1,whiteList["max-width"]=!0,whiteList["min-height"]=!0,whiteList["min-width"]=!0,whiteList["move-to"]=!1,whiteList["nav-down"]=!1,whiteList["nav-index"]=!1,whiteList["nav-left"]=!1,whiteList["nav-right"]=!1,whiteList["nav-up"]=!1,whiteList["object-fit"]=!1,whiteList["object-position"]=!1,whiteList.opacity=!1,whiteList.order=!1,whiteList.orphans=!1,whiteList.outline=!1,whiteList["outline-color"]=!1,whiteList["outline-offset"]=!1,whiteList["outline-style"]=!1,whiteList["outline-width"]=!1,whiteList.overflow=!1,whiteList["overflow-wrap"]=!1,whiteList["overflow-x"]=!1,whiteList["overflow-y"]=!1,whiteList.padding=!0,whiteList["padding-bottom"]=!0,whiteList["padding-left"]=!0,whiteList["padding-right"]=!0,whiteList["padding-top"]=!0,whiteList.page=!1,whiteList["page-break-after"]=!1,whiteList["page-break-before"]=!1,whiteList["page-break-inside"]=!1,whiteList["page-policy"]=!1,whiteList.pause=!1,whiteList["pause-after"]=!1,whiteList["pause-before"]=!1,whiteList.perspective=!1,whiteList["perspective-origin"]=!1,whiteList.pitch=!1,whiteList["pitch-range"]=!1,whiteList["play-during"]=!1,whiteList.position=!1,whiteList["presentation-level"]=!1,whiteList.quotes=!1,whiteList["region-fragment"]=!1,whiteList.resize=!1,whiteList.rest=!1,whiteList["rest-after"]=!1,whiteList["rest-before"]=!1,whiteList.richness=!1,whiteList.right=!1,whiteList.rotation=!1,whiteList["rotation-point"]=!1,whiteList["ruby-align"]=!1,whiteList["ruby-merge"]=!1,whiteList["ruby-position"]=!1,whiteList["shape-image-threshold"]=!1,whiteList["shape-outside"]=!1,whiteList["shape-margin"]=!1,whiteList.size=!1,whiteList.speak=!1,whiteList["speak-as"]=!1,whiteList["speak-header"]=!1,whiteList["speak-numeral"]=!1,whiteList["speak-punctuation"]=!1,whiteList["speech-rate"]=!1,whiteList.stress=!1,whiteList["string-set"]=!1,whiteList["tab-size"]=!1,whiteList["table-layout"]=!1,whiteList["text-align"]=!0,whiteList["text-align-last"]=!0,whiteList["text-combine-upright"]=!0,whiteList["text-decoration"]=!0,whiteList["text-decoration-color"]=!0,whiteList["text-decoration-line"]=!0,whiteList["text-decoration-skip"]=!0,whiteList["text-decoration-style"]=!0,whiteList["text-emphasis"]=!0,whiteList["text-emphasis-color"]=!0,whiteList["text-emphasis-position"]=!0,whiteList["text-emphasis-style"]=!0,whiteList["text-height"]=!0,whiteList["text-indent"]=!0,whiteList["text-justify"]=!0,whiteList["text-orientation"]=!0,whiteList["text-overflow"]=!0,whiteList["text-shadow"]=!0,whiteList["text-space-collapse"]=!0,whiteList["text-transform"]=!0,whiteList["text-underline-position"]=!0,whiteList["text-wrap"]=!0,whiteList.top=!1,whiteList.transform=!1,whiteList["transform-origin"]=!1,whiteList["transform-style"]=!1,whiteList.transition=!1,whiteList["transition-delay"]=!1,whiteList["transition-duration"]=!1,whiteList["transition-property"]=!1,whiteList["transition-timing-function"]=!1,whiteList["unicode-bidi"]=!1,whiteList["vertical-align"]=!1,whiteList.visibility=!1,whiteList["voice-balance"]=!1,whiteList["voice-duration"]=!1,whiteList["voice-family"]=!1,whiteList["voice-pitch"]=!1,whiteList["voice-range"]=!1,whiteList["voice-rate"]=!1,whiteList["voice-stress"]=!1,whiteList["voice-volume"]=!1,whiteList.volume=!1,whiteList["white-space"]=!1,whiteList.widows=!1,whiteList.width=!0,whiteList["will-change"]=!1,whiteList["word-break"]=!0,whiteList["word-spacing"]=!0,whiteList["word-wrap"]=!0,whiteList["wrap-flow"]=!1,whiteList["wrap-through"]=!1,whiteList["writing-mode"]=!1,whiteList["z-index"]=!1,whiteList}function onAttr(name,value,options){}function onIgnoreAttr(name,value,options){}var REGEXP_URL_JAVASCRIPT=/javascript\s*\:/img;function safeAttrValue(name,value){if(REGEXP_URL_JAVASCRIPT.test(value))return"";return value}exports.whiteList=getDefaultWhiteList();exports.getDefaultWhiteList=getDefaultWhiteList;exports.onAttr=onAttr;exports.onIgnoreAttr=onIgnoreAttr;exports.safeAttrValue=safeAttrValue});var require_util=__commonJS((exports,module)=>{module.exports={indexOf:function(arr,item){var i,j;if(Array.prototype.indexOf)return arr.indexOf(item);for(i=0,j=arr.length;i<j;i++)if(arr[i]===item)return i;return-1},forEach:function(arr,fn,scope){var i,j;if(Array.prototype.forEach)return arr.forEach(fn,scope);for(i=0,j=arr.length;i<j;i++)fn.call(scope,arr[i],i,arr)},trim:function(str){if(String.prototype.trim)return str.trim();return str.replace(/(^\s*)|(\s*$)/g,"")},trimRight:function(str){if(String.prototype.trimRight)return str.trimRight();return str.replace(/(\s*$)/g,"")}}});var require_parser=__commonJS((exports,module)=>{var _2=require_util();function parseStyle(css,onAttr){if(css=_2.trimRight(css),css[css.length-1]!==";")css+=";";var cssLength=css.length,isParenthesisOpen=!1,lastPos=0,i=0,retCSS="";function addNewAttr(){if(!isParenthesisOpen){var source=_2.trim(css.slice(lastPos,i)),j2=source.indexOf(":");if(j2!==-1){var name=_2.trim(source.slice(0,j2)),value=_2.trim(source.slice(j2+1));if(name){var ret=onAttr(lastPos,retCSS.length,name,value,source);if(ret)retCSS+=ret+"; "}}}lastPos=i+1}for(;i<cssLength;i++){var c=css[i];if(c==="/"&&css[i+1]==="*"){var j=css.indexOf("*/",i+2);if(j===-1)break;i=j+1,lastPos=i+1,isParenthesisOpen=!1}else if(c==="(")isParenthesisOpen=!0;else if(c===")")isParenthesisOpen=!1;else if(c===";")if(isParenthesisOpen);else addNewAttr();else if(c===`
`)addNewAttr()}return _2.trim(retCSS)}module.exports=parseStyle});var require_css=__commonJS((exports,module)=>{var DEFAULT=require_default(),parseStyle=require_parser(),_2=require_util();function isNull2(obj){return obj===void 0||obj===null}function shallowCopyObject(obj){var ret={};for(var i in obj)ret[i]=obj[i];return ret}function FilterCSS(options){options=shallowCopyObject(options||{}),options.whiteList=options.whiteList||DEFAULT.whiteList,options.onAttr=options.onAttr||DEFAULT.onAttr,options.onIgnoreAttr=options.onIgnoreAttr||DEFAULT.onIgnoreAttr,options.safeAttrValue=options.safeAttrValue||DEFAULT.safeAttrValue,this.options=options}FilterCSS.prototype.process=function(css){if(css=css||"",css=css.toString(),!css)return"";var me=this,options=me.options,whiteList=options.whiteList,onAttr=options.onAttr,onIgnoreAttr=options.onIgnoreAttr,safeAttrValue=options.safeAttrValue,retCSS=parseStyle(css,function(sourcePosition,position,name,value,source){var check2=whiteList[name],isWhite=!1;if(check2===!0)isWhite=check2;else if(typeof check2==="function")isWhite=check2(value);else if(check2 instanceof RegExp)isWhite=check2.test(value);if(isWhite!==!0)isWhite=!1;if(value=safeAttrValue(name,value),!value)return;var opts={position,sourcePosition,source,isWhite};if(isWhite){var ret=onAttr(name,value,opts);if(isNull2(ret))return name+":"+value;else return ret}else{var ret=onIgnoreAttr(name,value,opts);if(!isNull2(ret))return ret}});return retCSS};module.exports=FilterCSS});var require_lib=__commonJS((exports,module)=>{var DEFAULT=require_default(),FilterCSS=require_css();function filterCSS(html,options){var xss=new FilterCSS(options);return xss.process(html)}exports=module.exports=filterCSS;exports.FilterCSS=FilterCSS;for(i in DEFAULT)exports[i]=DEFAULT[i];var i;if(typeof window!=="undefined")window.filterCSS=module.exports});var require_util2=__commonJS((exports,module)=>{module.exports={indexOf:function(arr,item){var i,j;if(Array.prototype.indexOf)return arr.indexOf(item);for(i=0,j=arr.length;i<j;i++)if(arr[i]===item)return i;return-1},forEach:function(arr,fn,scope){var i,j;if(Array.prototype.forEach)return arr.forEach(fn,scope);for(i=0,j=arr.length;i<j;i++)fn.call(scope,arr[i],i,arr)},trim:function(str){if(String.prototype.trim)return str.trim();return str.replace(/(^\s*)|(\s*$)/g,"")},spaceIndex:function(str){var reg=/\s|\n|\t/,match=reg.exec(str);return match?match.index:-1}}});var require_default2=__commonJS((exports)=>{var FilterCSS=require_lib().FilterCSS,getDefaultCSSWhiteList=require_lib().getDefaultWhiteList,_2=require_util2();function getDefaultWhiteList(){return{a:["target","href","title"],abbr:["title"],address:[],area:["shape","coords","href","alt"],article:[],aside:[],audio:["autoplay","controls","crossorigin","loop","muted","preload","src"],b:[],bdi:["dir"],bdo:["dir"],big:[],blockquote:["cite"],br:[],caption:[],center:[],cite:[],code:[],col:["align","valign","span","width"],colgroup:["align","valign","span","width"],dd:[],del:["datetime"],details:["open"],div:[],dl:[],dt:[],em:[],figcaption:[],figure:[],font:["color","size","face"],footer:[],h1:[],h2:[],h3:[],h4:[],h5:[],h6:[],header:[],hr:[],i:[],img:["src","alt","title","width","height","loading"],ins:["datetime"],kbd:[],li:[],mark:[],nav:[],ol:[],p:[],pre:[],s:[],section:[],small:[],span:[],sub:[],summary:[],sup:[],strong:[],strike:[],table:["width","border","align","valign"],tbody:["align","valign"],td:["width","rowspan","colspan","align","valign"],tfoot:["align","valign"],th:["width","rowspan","colspan","align","valign"],thead:["align","valign"],tr:["rowspan","align","valign"],tt:[],u:[],ul:[],video:["autoplay","controls","crossorigin","loop","muted","playsinline","poster","preload","src","height","width"]}}var defaultCSSFilter=new FilterCSS;function onTag(tag,html,options){}function onIgnoreTag(tag,html,options){}function onTagAttr(tag,name,value){}function onIgnoreTagAttr(tag,name,value){}function escapeHtml(html){return html.replace(REGEXP_LT,"&lt;").replace(REGEXP_GT,"&gt;")}function safeAttrValue(tag,name,value,cssFilter){if(value=friendlyAttrValue(value),name==="href"||name==="src"){if(value=_2.trim(value),value==="#")return"#";if(!(value.substr(0,7)==="http://"||value.substr(0,8)==="https://"||value.substr(0,7)==="mailto:"||value.substr(0,4)==="tel:"||value.substr(0,11)==="data:image/"||value.substr(0,6)==="ftp://"||value.substr(0,2)==="./"||value.substr(0,3)==="../"||value[0]==="#"||value[0]==="/"))return""}else if(name==="background"){if(REGEXP_DEFAULT_ON_TAG_ATTR_4.lastIndex=0,REGEXP_DEFAULT_ON_TAG_ATTR_4.test(value))return""}else if(name==="style"){if(REGEXP_DEFAULT_ON_TAG_ATTR_7.lastIndex=0,REGEXP_DEFAULT_ON_TAG_ATTR_7.test(value))return"";if(REGEXP_DEFAULT_ON_TAG_ATTR_8.lastIndex=0,REGEXP_DEFAULT_ON_TAG_ATTR_8.test(value)){if(REGEXP_DEFAULT_ON_TAG_ATTR_4.lastIndex=0,REGEXP_DEFAULT_ON_TAG_ATTR_4.test(value))return""}if(cssFilter!==!1)cssFilter=cssFilter||defaultCSSFilter,value=cssFilter.process(value)}return value=escapeAttrValue(value),value}var REGEXP_LT=/</g,REGEXP_GT=/>/g,REGEXP_QUOTE=/"/g,REGEXP_QUOTE_2=/&quot;/g,REGEXP_ATTR_VALUE_1=/&#([a-zA-Z0-9]*);?/gim,REGEXP_ATTR_VALUE_COLON=/&colon;?/gim,REGEXP_ATTR_VALUE_NEWLINE=/&newline;?/gim,REGEXP_DEFAULT_ON_TAG_ATTR_4=/((j\s*a\s*v\s*a|v\s*b|l\s*i\s*v\s*e)\s*s\s*c\s*r\s*i\s*p\s*t\s*|m\s*o\s*c\s*h\s*a):/gi,REGEXP_DEFAULT_ON_TAG_ATTR_7=/e\s*x\s*p\s*r\s*e\s*s\s*s\s*i\s*o\s*n\s*\(.*/gi,REGEXP_DEFAULT_ON_TAG_ATTR_8=/u\s*r\s*l\s*\(.*/gi;function escapeQuote2(str){return str.replace(REGEXP_QUOTE,"&quot;")}function unescapeQuote(str){return str.replace(REGEXP_QUOTE_2,'"')}function escapeHtmlEntities(str){return str.replace(REGEXP_ATTR_VALUE_1,function replaceUnicode(str2,code){return code[0]==="x"||code[0]==="X"?String.fromCharCode(parseInt(code.substr(1),16)):String.fromCharCode(parseInt(code,10))})}function escapeDangerHtml5Entities(str){return str.replace(REGEXP_ATTR_VALUE_COLON,":").replace(REGEXP_ATTR_VALUE_NEWLINE," ")}function clearNonPrintableCharacter(str){var str2="";for(var i=0,len=str.length;i<len;i++)str2+=str.charCodeAt(i)<32?" ":str.charAt(i);return _2.trim(str2)}function friendlyAttrValue(str){return str=unescapeQuote(str),str=escapeHtmlEntities(str),str=escapeDangerHtml5Entities(str),str=clearNonPrintableCharacter(str),str}function escapeAttrValue(str){return str=escapeQuote2(str),str=escapeHtml(str),str}function onIgnoreTagStripAll(){return""}function StripTagBody(tags,next2){if(typeof next2!=="function")next2=function(){};var isRemoveAllTag=!Array.isArray(tags);function isRemoveTag(tag){if(isRemoveAllTag)return!0;return _2.indexOf(tags,tag)!==-1}var removeList=[],posStart=!1;return{onIgnoreTag:function(tag,html,options){if(isRemoveTag(tag))if(options.isClosing){var ret="[/removed]",end=options.position+ret.length;return removeList.push([posStart!==!1?posStart:options.position,end]),posStart=!1,ret}else{if(!posStart)posStart=options.position;return"[removed]"}else return next2(tag,html,options)},remove:function(html){var rethtml="",lastPos=0;return _2.forEach(removeList,function(pos){rethtml+=html.slice(lastPos,pos[0]),lastPos=pos[1]}),rethtml+=html.slice(lastPos),rethtml}}}function stripCommentTag(html){var retHtml="",lastPos=0;while(lastPos<html.length){var i=html.indexOf("<!--",lastPos);if(i===-1){retHtml+=html.slice(lastPos);break}retHtml+=html.slice(lastPos,i);var j=html.indexOf("-->",i);if(j===-1)break;lastPos=j+3}return retHtml}function stripBlankChar(html){var chars=html.split("");return chars=chars.filter(function(char2){var c=char2.charCodeAt(0);if(c===127)return!1;if(c<=31){if(c===10||c===13)return!0;return!1}return!0}),chars.join("")}exports.whiteList=getDefaultWhiteList();exports.getDefaultWhiteList=getDefaultWhiteList;exports.onTag=onTag;exports.onIgnoreTag=onIgnoreTag;exports.onTagAttr=onTagAttr;exports.onIgnoreTagAttr=onIgnoreTagAttr;exports.safeAttrValue=safeAttrValue;exports.escapeHtml=escapeHtml;exports.escapeQuote=escapeQuote2;exports.unescapeQuote=unescapeQuote;exports.escapeHtmlEntities=escapeHtmlEntities;exports.escapeDangerHtml5Entities=escapeDangerHtml5Entities;exports.clearNonPrintableCharacter=clearNonPrintableCharacter;exports.friendlyAttrValue=friendlyAttrValue;exports.escapeAttrValue=escapeAttrValue;exports.onIgnoreTagStripAll=onIgnoreTagStripAll;exports.StripTagBody=StripTagBody;exports.stripCommentTag=stripCommentTag;exports.stripBlankChar=stripBlankChar;exports.attributeWrapSign='"';exports.cssFilter=defaultCSSFilter;exports.getDefaultCSSWhiteList=getDefaultCSSWhiteList});var require_parser2=__commonJS((exports)=>{var _2=require_util2();function getTagName(html){var i=_2.spaceIndex(html),tagName;if(i===-1)tagName=html.slice(1,-1);else tagName=html.slice(1,i+1);if(tagName=_2.trim(tagName).toLowerCase(),tagName.slice(0,1)==="/")tagName=tagName.slice(1);if(tagName.slice(-1)==="/")tagName=tagName.slice(0,-1);return tagName}function isClosing(html){return html.slice(0,2)==="</"}function parseTag(html,onTag,escapeHtml){var rethtml="",lastPos=0,tagStart=!1,quoteStart=!1,currentPos=0,len=html.length,currentTagName="",currentHtml="";chariterator:for(currentPos=0;currentPos<len;currentPos++){var c=html.charAt(currentPos);if(tagStart===!1){if(c==="<"){tagStart=currentPos;continue}}else if(quoteStart===!1){if(c==="<"){rethtml+=escapeHtml(html.slice(lastPos,currentPos)),tagStart=currentPos,lastPos=currentPos;continue}if(c===">"||currentPos===len-1){rethtml+=escapeHtml(html.slice(lastPos,tagStart)),currentHtml=html.slice(tagStart,currentPos+1),currentTagName=getTagName(currentHtml),rethtml+=onTag(tagStart,rethtml.length,currentTagName,currentHtml,isClosing(currentHtml)),lastPos=currentPos+1,tagStart=!1;continue}if(c==='"'||c==="'"){var i=1,ic=html.charAt(currentPos-i);while(ic.trim()===""||ic==="="){if(ic==="="){quoteStart=c;continue chariterator}ic=html.charAt(currentPos-++i)}}}else if(c===quoteStart){quoteStart=!1;continue}}if(lastPos<len)rethtml+=escapeHtml(html.substr(lastPos));return rethtml}var REGEXP_ILLEGAL_ATTR_NAME=/[^a-zA-Z0-9\\_:.-]/gim;function parseAttr(html,onAttr){var lastPos=0,lastMarkPos=0,retAttrs=[],tmpName=!1,len=html.length;function addAttr(name,value){if(name=_2.trim(name),name=name.replace(REGEXP_ILLEGAL_ATTR_NAME,"").toLowerCase(),name.length<1)return;var ret=onAttr(name,value||"");if(ret)retAttrs.push(ret)}for(var i=0;i<len;i++){var c=html.charAt(i),v,j;if(tmpName===!1&&c==="="){tmpName=html.slice(lastPos,i),lastPos=i+1,lastMarkPos=html.charAt(lastPos)==='"'||html.charAt(lastPos)==="'"?lastPos:findNextQuotationMark(html,i+1);continue}if(tmpName!==!1){if(i===lastMarkPos)if(j=html.indexOf(c,i+1),j===-1)break;else{v=_2.trim(html.slice(lastMarkPos+1,j)),addAttr(tmpName,v),tmpName=!1,i=j,lastPos=i+1;continue}}if(/\s|\n|\t/.test(c))if(html=html.replace(/\s|\n|\t/g," "),tmpName===!1)if(j=findNextEqual(html,i),j===-1){v=_2.trim(html.slice(lastPos,i)),addAttr(v),tmpName=!1,lastPos=i+1;continue}else{i=j-1;continue}else if(j=findBeforeEqual(html,i-1),j===-1){v=_2.trim(html.slice(lastPos,i)),v=stripQuoteWrap(v),addAttr(tmpName,v),tmpName=!1,lastPos=i+1;continue}else continue}if(lastPos<html.length)if(tmpName===!1)addAttr(html.slice(lastPos));else addAttr(tmpName,stripQuoteWrap(_2.trim(html.slice(lastPos))));return _2.trim(retAttrs.join(" "))}function findNextEqual(str,i){for(;i<str.length;i++){var c=str[i];if(c===" ")continue;if(c==="=")return i;return-1}}function findNextQuotationMark(str,i){for(;i<str.length;i++){var c=str[i];if(c===" ")continue;if(c==="'"||c==='"')return i;return-1}}function findBeforeEqual(str,i){for(;i>0;i--){var c=str[i];if(c===" ")continue;if(c==="=")return i;return-1}}function isQuoteWrapString(text2){if(text2[0]==='"'&&text2[text2.length-1]==='"'||text2[0]==="'"&&text2[text2.length-1]==="'")return!0;else return!1}function stripQuoteWrap(text2){if(isQuoteWrapString(text2))return text2.substr(1,text2.length-2);else return text2}exports.parseTag=parseTag;exports.parseAttr=parseAttr});var require_xss=__commonJS((exports,module)=>{var FilterCSS=require_lib().FilterCSS,DEFAULT=require_default2(),parser=require_parser2(),parseTag=parser.parseTag,parseAttr=parser.parseAttr,_2=require_util2();function isNull2(obj){return obj===void 0||obj===null}function getAttrs(html){var i=_2.spaceIndex(html);if(i===-1)return{html:"",closing:html[html.length-2]==="/"};html=_2.trim(html.slice(i+1,-1));var isClosing=html[html.length-1]==="/";if(isClosing)html=_2.trim(html.slice(0,-1));return{html,closing:isClosing}}function shallowCopyObject(obj){var ret={};for(var i in obj)ret[i]=obj[i];return ret}function keysToLowerCase(obj){var ret={};for(var i in obj)if(Array.isArray(obj[i]))ret[i.toLowerCase()]=obj[i].map(function(item){return item.toLowerCase()});else ret[i.toLowerCase()]=obj[i];return ret}function FilterXSS(options){if(options=shallowCopyObject(options||{}),options.stripIgnoreTag){if(options.onIgnoreTag)console.error('Notes: cannot use these two options "stripIgnoreTag" and "onIgnoreTag" at the same time');options.onIgnoreTag=DEFAULT.onIgnoreTagStripAll}if(options.whiteList||options.allowList)options.whiteList=keysToLowerCase(options.whiteList||options.allowList);else options.whiteList=DEFAULT.whiteList;if(this.attributeWrapSign=options.singleQuotedAttributeValue===!0?"'":DEFAULT.attributeWrapSign,options.onTag=options.onTag||DEFAULT.onTag,options.onTagAttr=options.onTagAttr||DEFAULT.onTagAttr,options.onIgnoreTag=options.onIgnoreTag||DEFAULT.onIgnoreTag,options.onIgnoreTagAttr=options.onIgnoreTagAttr||DEFAULT.onIgnoreTagAttr,options.safeAttrValue=options.safeAttrValue||DEFAULT.safeAttrValue,options.escapeHtml=options.escapeHtml||DEFAULT.escapeHtml,this.options=options,options.css===!1)this.cssFilter=!1;else options.css=options.css||{},this.cssFilter=new FilterCSS(options.css)}FilterXSS.prototype.process=function(html){if(html=html||"",html=html.toString(),!html)return"";var me=this,options=me.options,whiteList=options.whiteList,onTag=options.onTag,onIgnoreTag=options.onIgnoreTag,onTagAttr=options.onTagAttr,onIgnoreTagAttr=options.onIgnoreTagAttr,safeAttrValue=options.safeAttrValue,escapeHtml=options.escapeHtml,attributeWrapSign=me.attributeWrapSign,cssFilter=me.cssFilter;if(options.stripBlankChar)html=DEFAULT.stripBlankChar(html);if(!options.allowCommentTag)html=DEFAULT.stripCommentTag(html);var stripIgnoreTagBody=!1;if(options.stripIgnoreTagBody)stripIgnoreTagBody=DEFAULT.StripTagBody(options.stripIgnoreTagBody,onIgnoreTag),onIgnoreTag=stripIgnoreTagBody.onIgnoreTag;var retHtml=parseTag(html,function(sourcePosition,position,tag,html2,isClosing){var info={sourcePosition,position,isClosing,isWhite:Object.prototype.hasOwnProperty.call(whiteList,tag)},ret=onTag(tag,html2,info);if(!isNull2(ret))return ret;if(info.isWhite){if(info.isClosing)return"</"+tag+">";var attrs=getAttrs(html2),whiteAttrList=whiteList[tag],attrsHtml=parseAttr(attrs.html,function(name,value){var isWhiteAttr=_2.indexOf(whiteAttrList,name)!==-1,ret2=onTagAttr(tag,name,value,isWhiteAttr);if(!isNull2(ret2))return ret2;if(isWhiteAttr)if(value=safeAttrValue(tag,name,value,cssFilter),value)return name+"="+attributeWrapSign+value+attributeWrapSign;else return name;else{if(ret2=onIgnoreTagAttr(tag,name,value,isWhiteAttr),!isNull2(ret2))return ret2;return}});if(html2="<"+tag,attrsHtml)html2+=" "+attrsHtml;if(attrs.closing)html2+=" /";return html2+=">",html2}else{if(ret=onIgnoreTag(tag,html2,info),!isNull2(ret))return ret;return escapeHtml(html2)}},escapeHtml);if(stripIgnoreTagBody)retHtml=stripIgnoreTagBody.remove(retHtml);return retHtml};module.exports=FilterXSS});var require_lib2=__commonJS((exports,module)=>{var DEFAULT=require_default2(),parser=require_parser2(),FilterXSS=require_xss();function filterXSS(html,options){var xss=new FilterXSS(options);return xss.process(html)}exports=module.exports=filterXSS;exports.filterXSS=filterXSS;exports.FilterXSS=FilterXSS;(function(){for(var i in DEFAULT)exports[i]=DEFAULT[i];for(var j in parser)exports[j]=parser[j]})();if(typeof window!=="undefined")window.filterXSS=module.exports;function isWorkerEnv(){return typeof self!=="undefined"&&typeof DedicatedWorkerGlobalScope!=="undefined"&&self instanceof DedicatedWorkerGlobalScope}if(isWorkerEnv())self.filterXSS=module.exports});var require_cookies=__commonJS((exports,module)=>{var urllib=__require("url");class Cookies{constructor(options){this.options=options||{},this.cookies=[]}set(cookieStr,url){let urlparts=urllib.parse(url||""),cookie=this.parse(cookieStr),domain;if(cookie.domain){if(domain=cookie.domain.replace(/^\./,""),urlparts.hostname.length<domain.length||("."+urlparts.hostname).substr(-domain.length+1)!=="."+domain)cookie.domain=urlparts.hostname}else cookie.domain=urlparts.hostname;if(!cookie.path)cookie.path=this.getPath(urlparts.pathname);if(!cookie.expires)cookie.expires=new Date(Date.now()+(Number(this.options.sessionTimeout||1800)||1800)*1000);return this.add(cookie)}get(url){return this.list(url).map((cookie)=>cookie.name+"="+cookie.value).join("; ")}list(url){let result=[],i,cookie;for(i=this.cookies.length-1;i>=0;i--){if(cookie=this.cookies[i],this.isExpired(cookie)){this.cookies.splice(i,i);continue}if(this.match(cookie,url))result.unshift(cookie)}return result}parse(cookieStr){let cookie={};return(cookieStr||"").toString().split(";").forEach((cookiePart)=>{let valueParts=cookiePart.split("="),key=valueParts.shift().trim().toLowerCase(),value=valueParts.join("=").trim(),domain;if(!key)return;switch(key){case"expires":if(value=new Date(value),value.toString()!=="Invalid Date")cookie.expires=value;break;case"path":cookie.path=value;break;case"domain":if(domain=value.toLowerCase(),domain.length&&domain.charAt(0)!==".")domain="."+domain;cookie.domain=domain;break;case"max-age":cookie.expires=new Date(Date.now()+(Number(value)||0)*1000);break;case"secure":cookie.secure=!0;break;case"httponly":cookie.httponly=!0;break;default:if(!cookie.name)cookie.name=key,cookie.value=value}}),cookie}match(cookie,url){let urlparts=urllib.parse(url||"");if(urlparts.hostname!==cookie.domain&&(cookie.domain.charAt(0)!=="."||("."+urlparts.hostname).substr(-cookie.domain.length)!==cookie.domain))return!1;if(this.getPath(urlparts.pathname).substr(0,cookie.path.length)!==cookie.path)return!1;if(cookie.secure&&urlparts.protocol!=="https:")return!1;return!0}add(cookie){let i,len;if(!cookie||!cookie.name)return!1;for(i=0,len=this.cookies.length;i<len;i++)if(this.compare(this.cookies[i],cookie)){if(this.isExpired(cookie))return this.cookies.splice(i,1),!1;return this.cookies[i]=cookie,!0}if(!this.isExpired(cookie))this.cookies.push(cookie);return!0}compare(a,b2){return a.name===b2.name&&a.path===b2.path&&a.domain===b2.domain&&a.secure===b2.secure&&a.httponly===a.httponly}isExpired(cookie){return cookie.expires&&cookie.expires<new Date||!cookie.value}getPath(pathname){let path=(pathname||"/").split("/");if(path.pop(),path=path.join("/").trim(),path.charAt(0)!=="/")path="/"+path;if(path.substr(-1)!=="/")path+="/";return path}}module.exports=Cookies});var require_package2=__commonJS((exports,module)=>{module.exports={name:"nodemailer",version:"6.10.1",description:"Easy as cake e-mail sending from your Node.js applications",main:"lib/nodemailer.js",scripts:{test:"node --test --test-concurrency=1 test/**/*.test.js test/**/*-test.js","test:coverage":"c8 node --test --test-concurrency=1 test/**/*.test.js test/**/*-test.js",lint:"eslint .",update:"rm -rf node_modules/ package-lock.json && ncu -u && npm install"},repository:{type:"git",url:"https://github.com/nodemailer/nodemailer.git"},keywords:["Nodemailer"],author:"Andris Reinman",license:"MIT-0",bugs:{url:"https://github.com/nodemailer/nodemailer/issues"},homepage:"https://nodemailer.com/",devDependencies:{"@aws-sdk/client-ses":"3.731.1",bunyan:"1.8.15",c8:"10.1.3",eslint:"8.57.0","eslint-config-nodemailer":"1.2.0","eslint-config-prettier":"9.1.0",libbase64:"1.3.0",libmime:"5.3.6",libqp:"2.1.1","nodemailer-ntlm-auth":"1.0.4",proxy:"1.0.2","proxy-test-server":"1.0.0","smtp-server":"3.13.6"},engines:{node:">=6.0.0"}}});var require_fetch=__commonJS((exports,module)=>{var http=__require("http"),https=__require("https"),urllib=__require("url"),zlib=__require("zlib"),PassThrough=__require("stream").PassThrough,Cookies=require_cookies(),packageData=require_package2(),net2=__require("net");module.exports=function(url,options){return nmfetch(url,options)};module.exports.Cookies=Cookies;function nmfetch(url,options){if(options=options||{},options.fetchRes=options.fetchRes||new PassThrough,options.cookies=options.cookies||new Cookies,options.redirects=options.redirects||0,options.maxRedirects=isNaN(options.maxRedirects)?5:options.maxRedirects,options.cookie)[].concat(options.cookie||[]).forEach((cookie)=>{options.cookies.set(cookie,url)}),options.cookie=!1;let fetchRes=options.fetchRes,parsed=urllib.parse(url),method=(options.method||"").toString().trim().toUpperCase()||"GET",finished=!1,cookies,body,handler=parsed.protocol==="https:"?https:http,headers={"accept-encoding":"gzip,deflate","user-agent":"nodemailer/"+packageData.version};if(Object.keys(options.headers||{}).forEach((key)=>{headers[key.toLowerCase().trim()]=options.headers[key]}),options.userAgent)headers["user-agent"]=options.userAgent;if(parsed.auth)headers.Authorization="Basic "+Buffer.from(parsed.auth).toString("base64");if(cookies=options.cookies.get(url))headers.cookie=cookies;if(options.body){if(options.contentType!==!1)headers["Content-Type"]=options.contentType||"application/x-www-form-urlencoded";if(typeof options.body.pipe==="function")headers["Transfer-Encoding"]="chunked",body=options.body,body.on("error",(err)=>{if(finished)return;finished=!0,err.type="FETCH",err.sourceUrl=url,fetchRes.emit("error",err)});else{if(options.body instanceof Buffer)body=options.body;else if(typeof options.body==="object")try{body=Buffer.from(Object.keys(options.body).map((key)=>{let value=options.body[key].toString().trim();return encodeURIComponent(key)+"="+encodeURIComponent(value)}).join("&"))}catch(E){if(finished)return;finished=!0,E.type="FETCH",E.sourceUrl=url,fetchRes.emit("error",E);return}else body=Buffer.from(options.body.toString().trim());headers["Content-Type"]=options.contentType||"application/x-www-form-urlencoded",headers["Content-Length"]=body.length}method=(options.method||"").toString().trim().toUpperCase()||"POST"}let req,reqOptions={method,host:parsed.hostname,path:parsed.path,port:parsed.port?parsed.port:parsed.protocol==="https:"?443:80,headers,rejectUnauthorized:!1,agent:!1};if(options.tls)Object.keys(options.tls).forEach((key)=>{reqOptions[key]=options.tls[key]});if(parsed.protocol==="https:"&&parsed.hostname&&parsed.hostname!==reqOptions.host&&!net2.isIP(parsed.hostname)&&!reqOptions.servername)reqOptions.servername=parsed.hostname;try{req=handler.request(reqOptions)}catch(E){return finished=!0,setImmediate(()=>{E.type="FETCH",E.sourceUrl=url,fetchRes.emit("error",E)}),fetchRes}if(options.timeout)req.setTimeout(options.timeout,()=>{if(finished)return;finished=!0,req.abort();let err=new Error("Request Timeout");err.type="FETCH",err.sourceUrl=url,fetchRes.emit("error",err)});return req.on("error",(err)=>{if(finished)return;finished=!0,err.type="FETCH",err.sourceUrl=url,fetchRes.emit("error",err)}),req.on("response",(res)=>{let inflate;if(finished)return;switch(res.headers["content-encoding"]){case"gzip":case"deflate":inflate=zlib.createUnzip();break}if(res.headers["set-cookie"])[].concat(res.headers["set-cookie"]||[]).forEach((cookie)=>{options.cookies.set(cookie,url)});if([301,302,303,307,308].includes(res.statusCode)&&res.headers.location){if(options.redirects++,options.redirects>options.maxRedirects){finished=!0;let err=new Error("Maximum redirect count exceeded");err.type="FETCH",err.sourceUrl=url,fetchRes.emit("error",err),req.abort();return}return options.method="GET",options.body=!1,nmfetch(urllib.resolve(url,res.headers.location),options)}if(fetchRes.statusCode=res.statusCode,fetchRes.headers=res.headers,res.statusCode>=300&&!options.allowErrorResponse){finished=!0;let err=new Error("Invalid status code "+res.statusCode);err.type="FETCH",err.sourceUrl=url,fetchRes.emit("error",err),req.abort();return}if(res.on("error",(err)=>{if(finished)return;finished=!0,err.type="FETCH",err.sourceUrl=url,fetchRes.emit("error",err),req.abort()}),inflate)res.pipe(inflate).pipe(fetchRes),inflate.on("error",(err)=>{if(finished)return;finished=!0,err.type="FETCH",err.sourceUrl=url,fetchRes.emit("error",err),req.abort()});else res.pipe(fetchRes)}),setImmediate(()=>{if(body)try{if(typeof body.pipe==="function")return body.pipe(req);else req.write(body)}catch(err){finished=!0,err.type="FETCH",err.sourceUrl=url,fetchRes.emit("error",err);return}req.end()}),fetchRes}});var require_shared=__commonJS((exports,module)=>{var urllib=__require("url"),util=__require("util"),fs2=__require("fs"),nmfetch=require_fetch(),dns=__require("dns"),net2=__require("net"),os2=__require("os"),networkInterfaces;try{networkInterfaces=os2.networkInterfaces()}catch(err){}exports.networkInterfaces=networkInterfaces;var isFamilySupported=(family,allowInternal)=>{let networkInterfaces2=exports.networkInterfaces;if(!networkInterfaces2)return!0;return Object.keys(networkInterfaces2).map((key)=>networkInterfaces2[key]).reduce((acc,val)=>acc.concat(val),[]).filter((i)=>!i.internal||allowInternal).filter((i)=>i.family==="IPv"+family||i.family===family).length>0},resolver=(family,hostname,options,callback)=>{if(options=options||{},!isFamilySupported(family,options.allowInternalNetworkInterfaces))return callback(null,[]);(dns.Resolver?new dns.Resolver(options):dns)["resolve"+family](hostname,(err,addresses)=>{if(err){switch(err.code){case dns.NODATA:case dns.NOTFOUND:case dns.NOTIMP:case dns.SERVFAIL:case dns.CONNREFUSED:case dns.REFUSED:case"EAI_AGAIN":return callback(null,[])}return callback(err)}return callback(null,Array.isArray(addresses)?addresses:[].concat(addresses||[]))})},dnsCache=exports.dnsCache=new Map,formatDNSValue=(value,extra)=>{if(!value)return Object.assign({},extra||{});return Object.assign({servername:value.servername,host:!value.addresses||!value.addresses.length?null:value.addresses.length===1?value.addresses[0]:value.addresses[Math.floor(Math.random()*value.addresses.length)]},extra||{})};exports.resolveHostname=(options,callback)=>{if(options=options||{},!options.host&&options.servername)options.host=options.servername;if(!options.host||net2.isIP(options.host)){let value={addresses:[options.host],servername:options.servername||!1};return callback(null,formatDNSValue(value,{cached:!1}))}let cached;if(dnsCache.has(options.host)){if(cached=dnsCache.get(options.host),!cached.expires||cached.expires>=Date.now())return callback(null,formatDNSValue(cached.value,{cached:!0}))}resolver(4,options.host,options,(err,addresses)=>{if(err){if(cached)return callback(null,formatDNSValue(cached.value,{cached:!0,error:err}));return callback(err)}if(addresses&&addresses.length){let value={addresses,servername:options.servername||options.host};return dnsCache.set(options.host,{value,expires:Date.now()+(options.dnsTtl||300000)}),callback(null,formatDNSValue(value,{cached:!1}))}resolver(6,options.host,options,(err2,addresses2)=>{if(err2){if(cached)return callback(null,formatDNSValue(cached.value,{cached:!0,error:err2}));return callback(err2)}if(addresses2&&addresses2.length){let value={addresses:addresses2,servername:options.servername||options.host};return dnsCache.set(options.host,{value,expires:Date.now()+(options.dnsTtl||300000)}),callback(null,formatDNSValue(value,{cached:!1}))}try{dns.lookup(options.host,{all:!0},(err3,addresses3)=>{if(err3){if(cached)return callback(null,formatDNSValue(cached.value,{cached:!0,error:err3}));return callback(err3)}let address=addresses3?addresses3.filter((addr)=>isFamilySupported(addr.family)).map((addr)=>addr.address).shift():!1;if(addresses3&&addresses3.length&&!address)console.warn(`Failed to resolve IPv${addresses3[0].family} addresses with current network`);if(!address&&cached)return callback(null,formatDNSValue(cached.value,{cached:!0}));let value={addresses:address?[address]:[options.host],servername:options.servername||options.host};return dnsCache.set(options.host,{value,expires:Date.now()+(options.dnsTtl||300000)}),callback(null,formatDNSValue(value,{cached:!1}))})}catch(err3){if(cached)return callback(null,formatDNSValue(cached.value,{cached:!0,error:err3}));return callback(err3)}})})};exports.parseConnectionUrl=(str)=>{str=str||"";let options={};return[urllib.parse(str,!0)].forEach((url)=>{let auth;switch(url.protocol){case"smtp:":options.secure=!1;break;case"smtps:":options.secure=!0;break;case"direct:":options.direct=!0;break}if(!isNaN(url.port)&&Number(url.port))options.port=Number(url.port);if(url.hostname)options.host=url.hostname;if(url.auth){if(auth=url.auth.split(":"),!options.auth)options.auth={};options.auth.user=auth.shift(),options.auth.pass=auth.join(":")}Object.keys(url.query||{}).forEach((key)=>{let obj=options,lKey=key,value=url.query[key];if(!isNaN(value))value=Number(value);switch(value){case"true":value=!0;break;case"false":value=!1;break}if(key.indexOf("tls.")===0){if(lKey=key.substr(4),!options.tls)options.tls={};obj=options.tls}else if(key.indexOf(".")>=0)return;if(!(lKey in obj))obj[lKey]=value})}),options};exports._logFunc=(logger,level,defaults,data,message,...args)=>{let entry={};Object.keys(defaults||{}).forEach((key)=>{if(key!=="level")entry[key]=defaults[key]}),Object.keys(data||{}).forEach((key)=>{if(key!=="level")entry[key]=data[key]}),logger[level](entry,message,...args)};exports.getLogger=(options,defaults)=>{options=options||{};let response={},levels=["trace","debug","info","warn","error","fatal"];if(!options.logger)return levels.forEach((level)=>{response[level]=()=>!1}),response;let logger=options.logger;if(options.logger===!0)logger=createDefaultLogger(levels);return levels.forEach((level)=>{response[level]=(data,message,...args)=>{exports._logFunc(logger,level,defaults,data,message,...args)}}),response};exports.callbackPromise=(resolve,reject)=>function(){let args=Array.from(arguments),err=args.shift();if(err)reject(err);else resolve(...args)};exports.parseDataURI=(uri2)=>{let input=uri2,commaPos=input.indexOf(",");if(!commaPos)return uri2;let data=input.substring(commaPos+1),metaStr=input.substring(5,commaPos),encoding,metaEntries=metaStr.split(";"),lastMetaEntry=metaEntries.length>1?metaEntries[metaEntries.length-1]:!1;if(lastMetaEntry&&lastMetaEntry.indexOf("=")<0)encoding=lastMetaEntry.toLowerCase(),metaEntries.pop();let contentType=metaEntries.shift()||"application/octet-stream",params={};for(let entry of metaEntries){let sep=entry.indexOf("=");if(sep>=0){let key=entry.substring(0,sep),value=entry.substring(sep+1);params[key]=value}}switch(encoding){case"base64":data=Buffer.from(data,"base64");break;case"utf8":data=Buffer.from(data);break;default:try{data=Buffer.from(decodeURIComponent(data))}catch(err){data=Buffer.from(data)}data=Buffer.from(data)}return{data,encoding,contentType,params}};exports.resolveContent=(data,key,callback)=>{let promise;if(!callback)promise=new Promise((resolve,reject)=>{callback=exports.callbackPromise(resolve,reject)});let content=data&&data[key]&&data[key].content||data[key],contentStream,encoding=(typeof data[key]==="object"&&data[key].encoding||"utf8").toString().toLowerCase().replace(/[-_\s]/g,"");if(!content)return callback(null,content);if(typeof content==="object"){if(typeof content.pipe==="function")return resolveStream(content,(err,value)=>{if(err)return callback(err);if(data[key].content)data[key].content=value;else data[key]=value;callback(null,value)});else if(/^https?:\/\//i.test(content.path||content.href))return contentStream=nmfetch(content.path||content.href),resolveStream(contentStream,callback);else if(/^data:/i.test(content.path||content.href)){let parsedDataUri=exports.parseDataURI(content.path||content.href);if(!parsedDataUri||!parsedDataUri.data)return callback(null,Buffer.from(0));return callback(null,parsedDataUri.data)}else if(content.path)return resolveStream(fs2.createReadStream(content.path),callback)}if(typeof data[key].content==="string"&&!["utf8","usascii","ascii"].includes(encoding))content=Buffer.from(data[key].content,encoding);return setImmediate(()=>callback(null,content)),promise};exports.assign=function(){let args=Array.from(arguments),target=args.shift()||{};return args.forEach((source)=>{Object.keys(source||{}).forEach((key)=>{if(["tls","auth"].includes(key)&&source[key]&&typeof source[key]==="object"){if(!target[key])target[key]={};Object.keys(source[key]).forEach((subKey)=>{target[key][subKey]=source[key][subKey]})}else target[key]=source[key]})}),target};exports.encodeXText=(str)=>{if(!/[^\x21-\x2A\x2C-\x3C\x3E-\x7E]/.test(str))return str;let buf=Buffer.from(str),result="";for(let i=0,len=buf.length;i<len;i++){let c=buf[i];if(c<33||c>126||c===43||c===61)result+="+"+(c<16?"0":"")+c.toString(16).toUpperCase();else result+=String.fromCharCode(c)}return result};function resolveStream(stream,callback){let responded=!1,chunks=[],chunklen=0;stream.on("error",(err)=>{if(responded)return;responded=!0,callback(err)}),stream.on("readable",()=>{let chunk;while((chunk=stream.read())!==null)chunks.push(chunk),chunklen+=chunk.length}),stream.on("end",()=>{if(responded)return;responded=!0;let value;try{value=Buffer.concat(chunks,chunklen)}catch(E){return callback(E)}callback(null,value)})}function createDefaultLogger(levels){let levelMaxLen=0,levelNames=new Map;levels.forEach((level)=>{if(level.length>levelMaxLen)levelMaxLen=level.length}),levels.forEach((level)=>{let levelName=level.toUpperCase();if(levelName.length<levelMaxLen)levelName+=" ".repeat(levelMaxLen-levelName.length);levelNames.set(level,levelName)});let print=(level,entry,message,...args)=>{let prefix="";if(entry){if(entry.tnx==="server")prefix="S: ";else if(entry.tnx==="client")prefix="C: ";if(entry.sid)prefix="["+entry.sid+"] "+prefix;if(entry.cid)prefix="[#"+entry.cid+"] "+prefix}message=util.format(message,...args),message.split(/\r?\n/).forEach((line2)=>{console.log("[%s] %s %s",new Date().toISOString().substr(0,19).replace(/T/," "),levelNames.get(level),prefix+line2)})},logger={};return levels.forEach((level)=>{logger[level]=print.bind(null,level)}),logger}});var require_mime_types=__commonJS((exports,module)=>{var path=__require("path"),mimeTypes=new Map([["application/acad","dwg"],["application/applixware","aw"],["application/arj","arj"],["application/atom+xml","xml"],["application/atomcat+xml","atomcat"],["application/atomsvc+xml","atomsvc"],["application/base64",["mm","mme"]],["application/binhex","hqx"],["application/binhex4","hqx"],["application/book",["book","boo"]],["application/ccxml+xml,","ccxml"],["application/cdf","cdf"],["application/cdmi-capability","cdmia"],["application/cdmi-container","cdmic"],["application/cdmi-domain","cdmid"],["application/cdmi-object","cdmio"],["application/cdmi-queue","cdmiq"],["application/clariscad","ccad"],["application/commonground","dp"],["application/cu-seeme","cu"],["application/davmount+xml","davmount"],["application/drafting","drw"],["application/dsptype","tsp"],["application/dssc+der","dssc"],["application/dssc+xml","xdssc"],["application/dxf","dxf"],["application/ecmascript",["js","es"]],["application/emma+xml","emma"],["application/envoy","evy"],["application/epub+zip","epub"],["application/excel",["xls","xl","xla","xlb","xlc","xld","xlk","xll","xlm","xlt","xlv","xlw"]],["application/exi","exi"],["application/font-tdpfr","pfr"],["application/fractals","fif"],["application/freeloader","frl"],["application/futuresplash","spl"],["application/geo+json","geojson"],["application/gnutar","tgz"],["application/groupwise","vew"],["application/hlp","hlp"],["application/hta","hta"],["application/hyperstudio","stk"],["application/i-deas","unv"],["application/iges",["iges","igs"]],["application/inf","inf"],["application/internet-property-stream","acx"],["application/ipfix","ipfix"],["application/java","class"],["application/java-archive","jar"],["application/java-byte-code","class"],["application/java-serialized-object","ser"],["application/java-vm","class"],["application/javascript","js"],["application/json","json"],["application/lha","lha"],["application/lzx","lzx"],["application/mac-binary","bin"],["application/mac-binhex","hqx"],["application/mac-binhex40","hqx"],["application/mac-compactpro","cpt"],["application/macbinary","bin"],["application/mads+xml","mads"],["application/marc","mrc"],["application/marcxml+xml","mrcx"],["application/mathematica","ma"],["application/mathml+xml","mathml"],["application/mbedlet","mbd"],["application/mbox","mbox"],["application/mcad","mcd"],["application/mediaservercontrol+xml","mscml"],["application/metalink4+xml","meta4"],["application/mets+xml","mets"],["application/mime","aps"],["application/mods+xml","mods"],["application/mp21","m21"],["application/mp4","mp4"],["application/mspowerpoint",["ppt","pot","pps","ppz"]],["application/msword",["doc","dot","w6w","wiz","word"]],["application/mswrite","wri"],["application/mxf","mxf"],["application/netmc","mcp"],["application/octet-stream",["*"]],["application/oda","oda"],["application/oebps-package+xml","opf"],["application/ogg","ogx"],["application/olescript","axs"],["application/onenote","onetoc"],["application/patch-ops-error+xml","xer"],["application/pdf","pdf"],["application/pgp-encrypted","asc"],["application/pgp-signature","pgp"],["application/pics-rules","prf"],["application/pkcs-12","p12"],["application/pkcs-crl","crl"],["application/pkcs10","p10"],["application/pkcs7-mime",["p7c","p7m"]],["application/pkcs7-signature","p7s"],["application/pkcs8","p8"],["application/pkix-attr-cert","ac"],["application/pkix-cert",["cer","crt"]],["application/pkix-crl","crl"],["application/pkix-pkipath","pkipath"],["application/pkixcmp","pki"],["application/plain","text"],["application/pls+xml","pls"],["application/postscript",["ps","ai","eps"]],["application/powerpoint","ppt"],["application/pro_eng",["part","prt"]],["application/prs.cww","cww"],["application/pskc+xml","pskcxml"],["application/rdf+xml","rdf"],["application/reginfo+xml","rif"],["application/relax-ng-compact-syntax","rnc"],["application/resource-lists+xml","rl"],["application/resource-lists-diff+xml","rld"],["application/ringing-tones","rng"],["application/rls-services+xml","rs"],["application/rsd+xml","rsd"],["application/rss+xml","xml"],["application/rtf",["rtf","rtx"]],["application/sbml+xml","sbml"],["application/scvp-cv-request","scq"],["application/scvp-cv-response","scs"],["application/scvp-vp-request","spq"],["application/scvp-vp-response","spp"],["application/sdp","sdp"],["application/sea","sea"],["application/set","set"],["application/set-payment-initiation","setpay"],["application/set-registration-initiation","setreg"],["application/shf+xml","shf"],["application/sla","stl"],["application/smil",["smi","smil"]],["application/smil+xml","smi"],["application/solids","sol"],["application/sounder","sdr"],["application/sparql-query","rq"],["application/sparql-results+xml","srx"],["application/srgs","gram"],["application/srgs+xml","grxml"],["application/sru+xml","sru"],["application/ssml+xml","ssml"],["application/step",["step","stp"]],["application/streamingmedia","ssm"],["application/tei+xml","tei"],["application/thraud+xml","tfi"],["application/timestamped-data","tsd"],["application/toolbook","tbk"],["application/vda","vda"],["application/vnd.3gpp.pic-bw-large","plb"],["application/vnd.3gpp.pic-bw-small","psb"],["application/vnd.3gpp.pic-bw-var","pvb"],["application/vnd.3gpp2.tcap","tcap"],["application/vnd.3m.post-it-notes","pwn"],["application/vnd.accpac.simply.aso","aso"],["application/vnd.accpac.simply.imp","imp"],["application/vnd.acucobol","acu"],["application/vnd.acucorp","atc"],["application/vnd.adobe.air-application-installer-package+zip","air"],["application/vnd.adobe.fxp","fxp"],["application/vnd.adobe.xdp+xml","xdp"],["application/vnd.adobe.xfdf","xfdf"],["application/vnd.ahead.space","ahead"],["application/vnd.airzip.filesecure.azf","azf"],["application/vnd.airzip.filesecure.azs","azs"],["application/vnd.amazon.ebook","azw"],["application/vnd.americandynamics.acc","acc"],["application/vnd.amiga.ami","ami"],["application/vnd.android.package-archive","apk"],["application/vnd.anser-web-certificate-issue-initiation","cii"],["application/vnd.anser-web-funds-transfer-initiation","fti"],["application/vnd.antix.game-component","atx"],["application/vnd.apple.installer+xml","mpkg"],["application/vnd.apple.mpegurl","m3u8"],["application/vnd.aristanetworks.swi","swi"],["application/vnd.audiograph","aep"],["application/vnd.blueice.multipass","mpm"],["application/vnd.bmi","bmi"],["application/vnd.businessobjects","rep"],["application/vnd.chemdraw+xml","cdxml"],["application/vnd.chipnuts.karaoke-mmd","mmd"],["application/vnd.cinderella","cdy"],["application/vnd.claymore","cla"],["application/vnd.cloanto.rp9","rp9"],["application/vnd.clonk.c4group","c4g"],["application/vnd.cluetrust.cartomobile-config","c11amc"],["application/vnd.cluetrust.cartomobile-config-pkg","c11amz"],["application/vnd.commonspace","csp"],["application/vnd.contact.cmsg","cdbcmsg"],["application/vnd.cosmocaller","cmc"],["application/vnd.crick.clicker","clkx"],["application/vnd.crick.clicker.keyboard","clkk"],["application/vnd.crick.clicker.palette","clkp"],["application/vnd.crick.clicker.template","clkt"],["application/vnd.crick.clicker.wordbank","clkw"],["application/vnd.criticaltools.wbs+xml","wbs"],["application/vnd.ctc-posml","pml"],["application/vnd.cups-ppd","ppd"],["application/vnd.curl.car","car"],["application/vnd.curl.pcurl","pcurl"],["application/vnd.data-vision.rdz","rdz"],["application/vnd.denovo.fcselayout-link","fe_launch"],["application/vnd.dna","dna"],["application/vnd.dolby.mlp","mlp"],["application/vnd.dpgraph","dpg"],["application/vnd.dreamfactory","dfac"],["application/vnd.dvb.ait","ait"],["application/vnd.dvb.service","svc"],["application/vnd.dynageo","geo"],["application/vnd.ecowin.chart","mag"],["application/vnd.enliven","nml"],["application/vnd.epson.esf","esf"],["application/vnd.epson.msf","msf"],["application/vnd.epson.quickanime","qam"],["application/vnd.epson.salt","slt"],["application/vnd.epson.ssf","ssf"],["application/vnd.eszigno3+xml","es3"],["application/vnd.ezpix-album","ez2"],["application/vnd.ezpix-package","ez3"],["application/vnd.fdf","fdf"],["application/vnd.fdsn.seed","seed"],["application/vnd.flographit","gph"],["application/vnd.fluxtime.clip","ftc"],["application/vnd.framemaker","fm"],["application/vnd.frogans.fnc","fnc"],["application/vnd.frogans.ltf","ltf"],["application/vnd.fsc.weblaunch","fsc"],["application/vnd.fujitsu.oasys","oas"],["application/vnd.fujitsu.oasys2","oa2"],["application/vnd.fujitsu.oasys3","oa3"],["application/vnd.fujitsu.oasysgp","fg5"],["application/vnd.fujitsu.oasysprs","bh2"],["application/vnd.fujixerox.ddd","ddd"],["application/vnd.fujixerox.docuworks","xdw"],["application/vnd.fujixerox.docuworks.binder","xbd"],["application/vnd.fuzzysheet","fzs"],["application/vnd.genomatix.tuxedo","txd"],["application/vnd.geogebra.file","ggb"],["application/vnd.geogebra.tool","ggt"],["application/vnd.geometry-explorer","gex"],["application/vnd.geonext","gxt"],["application/vnd.geoplan","g2w"],["application/vnd.geospace","g3w"],["application/vnd.gmx","gmx"],["application/vnd.google-earth.kml+xml","kml"],["application/vnd.google-earth.kmz","kmz"],["application/vnd.grafeq","gqf"],["application/vnd.groove-account","gac"],["application/vnd.groove-help","ghf"],["application/vnd.groove-identity-message","gim"],["application/vnd.groove-injector","grv"],["application/vnd.groove-tool-message","gtm"],["application/vnd.groove-tool-template","tpl"],["application/vnd.groove-vcard","vcg"],["application/vnd.hal+xml","hal"],["application/vnd.handheld-entertainment+xml","zmm"],["application/vnd.hbci","hbci"],["application/vnd.hhe.lesson-player","les"],["application/vnd.hp-hpgl",["hgl","hpg","hpgl"]],["application/vnd.hp-hpid","hpid"],["application/vnd.hp-hps","hps"],["application/vnd.hp-jlyt","jlt"],["application/vnd.hp-pcl","pcl"],["application/vnd.hp-pclxl","pclxl"],["application/vnd.hydrostatix.sof-data","sfd-hdstx"],["application/vnd.hzn-3d-crossword","x3d"],["application/vnd.ibm.minipay","mpy"],["application/vnd.ibm.modcap","afp"],["application/vnd.ibm.rights-management","irm"],["application/vnd.ibm.secure-container","sc"],["application/vnd.iccprofile","icc"],["application/vnd.igloader","igl"],["application/vnd.immervision-ivp","ivp"],["application/vnd.immervision-ivu","ivu"],["application/vnd.insors.igm","igm"],["application/vnd.intercon.formnet","xpw"],["application/vnd.intergeo","i2g"],["application/vnd.intu.qbo","qbo"],["application/vnd.intu.qfx","qfx"],["application/vnd.ipunplugged.rcprofile","rcprofile"],["application/vnd.irepository.package+xml","irp"],["application/vnd.is-xpr","xpr"],["application/vnd.isac.fcs","fcs"],["application/vnd.jam","jam"],["application/vnd.jcp.javame.midlet-rms","rms"],["application/vnd.jisp","jisp"],["application/vnd.joost.joda-archive","joda"],["application/vnd.kahootz","ktz"],["application/vnd.kde.karbon","karbon"],["application/vnd.kde.kchart","chrt"],["application/vnd.kde.kformula","kfo"],["application/vnd.kde.kivio","flw"],["application/vnd.kde.kontour","kon"],["application/vnd.kde.kpresenter","kpr"],["application/vnd.kde.kspread","ksp"],["application/vnd.kde.kword","kwd"],["application/vnd.kenameaapp","htke"],["application/vnd.kidspiration","kia"],["application/vnd.kinar","kne"],["application/vnd.koan","skp"],["application/vnd.kodak-descriptor","sse"],["application/vnd.las.las+xml","lasxml"],["application/vnd.llamagraphics.life-balance.desktop","lbd"],["application/vnd.llamagraphics.life-balance.exchange+xml","lbe"],["application/vnd.lotus-1-2-3","123"],["application/vnd.lotus-approach","apr"],["application/vnd.lotus-freelance","pre"],["application/vnd.lotus-notes","nsf"],["application/vnd.lotus-organizer","org"],["application/vnd.lotus-screencam","scm"],["application/vnd.lotus-wordpro","lwp"],["application/vnd.macports.portpkg","portpkg"],["application/vnd.mcd","mcd"],["application/vnd.medcalcdata","mc1"],["application/vnd.mediastation.cdkey","cdkey"],["application/vnd.mfer","mwf"],["application/vnd.mfmp","mfm"],["application/vnd.micrografx.flo","flo"],["application/vnd.micrografx.igx","igx"],["application/vnd.mif","mif"],["application/vnd.mobius.daf","daf"],["application/vnd.mobius.dis","dis"],["application/vnd.mobius.mbk","mbk"],["application/vnd.mobius.mqy","mqy"],["application/vnd.mobius.msl","msl"],["application/vnd.mobius.plc","plc"],["application/vnd.mobius.txf","txf"],["application/vnd.mophun.application","mpn"],["application/vnd.mophun.certificate","mpc"],["application/vnd.mozilla.xul+xml","xul"],["application/vnd.ms-artgalry","cil"],["application/vnd.ms-cab-compressed","cab"],["application/vnd.ms-excel",["xls","xla","xlc","xlm","xlt","xlw","xlb","xll"]],["application/vnd.ms-excel.addin.macroenabled.12","xlam"],["application/vnd.ms-excel.sheet.binary.macroenabled.12","xlsb"],["application/vnd.ms-excel.sheet.macroenabled.12","xlsm"],["application/vnd.ms-excel.template.macroenabled.12","xltm"],["application/vnd.ms-fontobject","eot"],["application/vnd.ms-htmlhelp","chm"],["application/vnd.ms-ims","ims"],["application/vnd.ms-lrm","lrm"],["application/vnd.ms-officetheme","thmx"],["application/vnd.ms-outlook","msg"],["application/vnd.ms-pki.certstore","sst"],["application/vnd.ms-pki.pko","pko"],["application/vnd.ms-pki.seccat","cat"],["application/vnd.ms-pki.stl","stl"],["application/vnd.ms-pkicertstore","sst"],["application/vnd.ms-pkiseccat","cat"],["application/vnd.ms-pkistl","stl"],["application/vnd.ms-powerpoint",["ppt","pot","pps","ppa","pwz"]],["application/vnd.ms-powerpoint.addin.macroenabled.12","ppam"],["application/vnd.ms-powerpoint.presentation.macroenabled.12","pptm"],["application/vnd.ms-powerpoint.slide.macroenabled.12","sldm"],["application/vnd.ms-powerpoint.slideshow.macroenabled.12","ppsm"],["application/vnd.ms-powerpoint.template.macroenabled.12","potm"],["application/vnd.ms-project","mpp"],["application/vnd.ms-word.document.macroenabled.12","docm"],["application/vnd.ms-word.template.macroenabled.12","dotm"],["application/vnd.ms-works",["wks","wcm","wdb","wps"]],["application/vnd.ms-wpl","wpl"],["application/vnd.ms-xpsdocument","xps"],["application/vnd.mseq","mseq"],["application/vnd.musician","mus"],["application/vnd.muvee.style","msty"],["application/vnd.neurolanguage.nlu","nlu"],["application/vnd.noblenet-directory","nnd"],["application/vnd.noblenet-sealer","nns"],["application/vnd.noblenet-web","nnw"],["application/vnd.nokia.configuration-message","ncm"],["application/vnd.nokia.n-gage.data","ngdat"],["application/vnd.nokia.n-gage.symbian.install","n-gage"],["application/vnd.nokia.radio-preset","rpst"],["application/vnd.nokia.radio-presets","rpss"],["application/vnd.nokia.ringing-tone","rng"],["application/vnd.novadigm.edm","edm"],["application/vnd.novadigm.edx","edx"],["application/vnd.novadigm.ext","ext"],["application/vnd.oasis.opendocument.chart","odc"],["application/vnd.oasis.opendocument.chart-template","otc"],["application/vnd.oasis.opendocument.database","odb"],["application/vnd.oasis.opendocument.formula","odf"],["application/vnd.oasis.opendocument.formula-template","odft"],["application/vnd.oasis.opendocument.graphics","odg"],["application/vnd.oasis.opendocument.graphics-template","otg"],["application/vnd.oasis.opendocument.image","odi"],["application/vnd.oasis.opendocument.image-template","oti"],["application/vnd.oasis.opendocument.presentation","odp"],["application/vnd.oasis.opendocument.presentation-template","otp"],["application/vnd.oasis.opendocument.spreadsheet","ods"],["application/vnd.oasis.opendocument.spreadsheet-template","ots"],["application/vnd.oasis.opendocument.text","odt"],["application/vnd.oasis.opendocument.text-master","odm"],["application/vnd.oasis.opendocument.text-template","ott"],["application/vnd.oasis.opendocument.text-web","oth"],["application/vnd.olpc-sugar","xo"],["application/vnd.oma.dd2+xml","dd2"],["application/vnd.openofficeorg.extension","oxt"],["application/vnd.openxmlformats-officedocument.presentationml.presentation","pptx"],["application/vnd.openxmlformats-officedocument.presentationml.slide","sldx"],["application/vnd.openxmlformats-officedocument.presentationml.slideshow","ppsx"],["application/vnd.openxmlformats-officedocument.presentationml.template","potx"],["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","xlsx"],["application/vnd.openxmlformats-officedocument.spreadsheetml.template","xltx"],["application/vnd.openxmlformats-officedocument.wordprocessingml.document","docx"],["application/vnd.openxmlformats-officedocument.wordprocessingml.template","dotx"],["application/vnd.osgeo.mapguide.package","mgp"],["application/vnd.osgi.dp","dp"],["application/vnd.palm","pdb"],["application/vnd.pawaafile","paw"],["application/vnd.pg.format","str"],["application/vnd.pg.osasli","ei6"],["application/vnd.picsel","efif"],["application/vnd.pmi.widget","wg"],["application/vnd.pocketlearn","plf"],["application/vnd.powerbuilder6","pbd"],["application/vnd.previewsystems.box","box"],["application/vnd.proteus.magazine","mgz"],["application/vnd.publishare-delta-tree","qps"],["application/vnd.pvi.ptid1","ptid"],["application/vnd.quark.quarkxpress","qxd"],["application/vnd.realvnc.bed","bed"],["application/vnd.recordare.musicxml","mxl"],["application/vnd.recordare.musicxml+xml","musicxml"],["application/vnd.rig.cryptonote","cryptonote"],["application/vnd.rim.cod","cod"],["application/vnd.rn-realmedia","rm"],["application/vnd.rn-realplayer","rnx"],["application/vnd.route66.link66+xml","link66"],["application/vnd.sailingtracker.track","st"],["application/vnd.seemail","see"],["application/vnd.sema","sema"],["application/vnd.semd","semd"],["application/vnd.semf","semf"],["application/vnd.shana.informed.formdata","ifm"],["application/vnd.shana.informed.formtemplate","itp"],["application/vnd.shana.informed.interchange","iif"],["application/vnd.shana.informed.package","ipk"],["application/vnd.simtech-mindmapper","twd"],["application/vnd.smaf","mmf"],["application/vnd.smart.teacher","teacher"],["application/vnd.solent.sdkm+xml","sdkm"],["application/vnd.spotfire.dxp","dxp"],["application/vnd.spotfire.sfs","sfs"],["application/vnd.stardivision.calc","sdc"],["application/vnd.stardivision.draw","sda"],["application/vnd.stardivision.impress","sdd"],["application/vnd.stardivision.math","smf"],["application/vnd.stardivision.writer","sdw"],["application/vnd.stardivision.writer-global","sgl"],["application/vnd.stepmania.stepchart","sm"],["application/vnd.sun.xml.calc","sxc"],["application/vnd.sun.xml.calc.template","stc"],["application/vnd.sun.xml.draw","sxd"],["application/vnd.sun.xml.draw.template","std"],["application/vnd.sun.xml.impress","sxi"],["application/vnd.sun.xml.impress.template","sti"],["application/vnd.sun.xml.math","sxm"],["application/vnd.sun.xml.writer","sxw"],["application/vnd.sun.xml.writer.global","sxg"],["application/vnd.sun.xml.writer.template","stw"],["application/vnd.sus-calendar","sus"],["application/vnd.svd","svd"],["application/vnd.symbian.install","sis"],["application/vnd.syncml+xml","xsm"],["application/vnd.syncml.dm+wbxml","bdm"],["application/vnd.syncml.dm+xml","xdm"],["application/vnd.tao.intent-module-archive","tao"],["application/vnd.tmobile-livetv","tmo"],["application/vnd.trid.tpt","tpt"],["application/vnd.triscape.mxs","mxs"],["application/vnd.trueapp","tra"],["application/vnd.ufdl","ufd"],["application/vnd.uiq.theme","utz"],["application/vnd.umajin","umj"],["application/vnd.unity","unityweb"],["application/vnd.uoml+xml","uoml"],["application/vnd.vcx","vcx"],["application/vnd.visio","vsd"],["application/vnd.visionary","vis"],["application/vnd.vsf","vsf"],["application/vnd.wap.wbxml","wbxml"],["application/vnd.wap.wmlc","wmlc"],["application/vnd.wap.wmlscriptc","wmlsc"],["application/vnd.webturbo","wtb"],["application/vnd.wolfram.player","nbp"],["application/vnd.wordperfect","wpd"],["application/vnd.wqd","wqd"],["application/vnd.wt.stf","stf"],["application/vnd.xara",["web","xar"]],["application/vnd.xfdl","xfdl"],["application/vnd.yamaha.hv-dic","hvd"],["application/vnd.yamaha.hv-script","hvs"],["application/vnd.yamaha.hv-voice","hvp"],["application/vnd.yamaha.openscoreformat","osf"],["application/vnd.yamaha.openscoreformat.osfpvg+xml","osfpvg"],["application/vnd.yamaha.smaf-audio","saf"],["application/vnd.yamaha.smaf-phrase","spf"],["application/vnd.yellowriver-custom-menu","cmp"],["application/vnd.zul","zir"],["application/vnd.zzazz.deck+xml","zaz"],["application/vocaltec-media-desc","vmd"],["application/vocaltec-media-file","vmf"],["application/voicexml+xml","vxml"],["application/widget","wgt"],["application/winhlp","hlp"],["application/wordperfect",["wp","wp5","wp6","wpd"]],["application/wordperfect6.0",["w60","wp5"]],["application/wordperfect6.1","w61"],["application/wsdl+xml","wsdl"],["application/wspolicy+xml","wspolicy"],["application/x-123","wk1"],["application/x-7z-compressed","7z"],["application/x-abiword","abw"],["application/x-ace-compressed","ace"],["application/x-aim","aim"],["application/x-authorware-bin","aab"],["application/x-authorware-map","aam"],["application/x-authorware-seg","aas"],["application/x-bcpio","bcpio"],["application/x-binary","bin"],["application/x-binhex40","hqx"],["application/x-bittorrent","torrent"],["application/x-bsh",["bsh","sh","shar"]],["application/x-bytecode.elisp","elc"],["application/x-bytecode.python","pyc"],["application/x-bzip","bz"],["application/x-bzip2",["boz","bz2"]],["application/x-cdf","cdf"],["application/x-cdlink","vcd"],["application/x-chat",["cha","chat"]],["application/x-chess-pgn","pgn"],["application/x-cmu-raster","ras"],["application/x-cocoa","cco"],["application/x-compactpro","cpt"],["application/x-compress","z"],["application/x-compressed",["tgz","gz","z","zip"]],["application/x-conference","nsc"],["application/x-cpio","cpio"],["application/x-cpt","cpt"],["application/x-csh","csh"],["application/x-debian-package","deb"],["application/x-deepv","deepv"],["application/x-director",["dir","dcr","dxr"]],["application/x-doom","wad"],["application/x-dtbncx+xml","ncx"],["application/x-dtbook+xml","dtb"],["application/x-dtbresource+xml","res"],["application/x-dvi","dvi"],["application/x-elc","elc"],["application/x-envoy",["env","evy"]],["application/x-esrehber","es"],["application/x-excel",["xls","xla","xlb","xlc","xld","xlk","xll","xlm","xlt","xlv","xlw"]],["application/x-font-bdf","bdf"],["application/x-font-ghostscript","gsf"],["application/x-font-linux-psf","psf"],["application/x-font-otf","otf"],["application/x-font-pcf","pcf"],["application/x-font-snf","snf"],["application/x-font-ttf","ttf"],["application/x-font-type1","pfa"],["application/x-font-woff","woff"],["application/x-frame","mif"],["application/x-freelance","pre"],["application/x-futuresplash","spl"],["application/x-gnumeric","gnumeric"],["application/x-gsp","gsp"],["application/x-gss","gss"],["application/x-gtar","gtar"],["application/x-gzip",["gz","gzip"]],["application/x-hdf","hdf"],["application/x-helpfile",["help","hlp"]],["application/x-httpd-imap","imap"],["application/x-ima","ima"],["application/x-internet-signup",["ins","isp"]],["application/x-internett-signup","ins"],["application/x-inventor","iv"],["application/x-ip2","ip"],["application/x-iphone","iii"],["application/x-java-class","class"],["application/x-java-commerce","jcm"],["application/x-java-jnlp-file","jnlp"],["application/x-javascript","js"],["application/x-koan",["skd","skm","skp","skt"]],["application/x-ksh","ksh"],["application/x-latex",["latex","ltx"]],["application/x-lha","lha"],["application/x-lisp","lsp"],["application/x-livescreen","ivy"],["application/x-lotus","wq1"],["application/x-lotusscreencam","scm"],["application/x-lzh","lzh"],["application/x-lzx","lzx"],["application/x-mac-binhex40","hqx"],["application/x-macbinary","bin"],["application/x-magic-cap-package-1.0","mc$"],["application/x-mathcad","mcd"],["application/x-meme","mm"],["application/x-midi",["mid","midi"]],["application/x-mif","mif"],["application/x-mix-transfer","nix"],["application/x-mobipocket-ebook","prc"],["application/x-mplayer2","asx"],["application/x-ms-application","application"],["application/x-ms-wmd","wmd"],["application/x-ms-wmz","wmz"],["application/x-ms-xbap","xbap"],["application/x-msaccess","mdb"],["application/x-msbinder","obd"],["application/x-mscardfile","crd"],["application/x-msclip","clp"],["application/x-msdownload",["exe","dll"]],["application/x-msexcel",["xls","xla","xlw"]],["application/x-msmediaview",["mvb","m13","m14"]],["application/x-msmetafile","wmf"],["application/x-msmoney","mny"],["application/x-mspowerpoint","ppt"],["application/x-mspublisher","pub"],["application/x-msschedule","scd"],["application/x-msterminal","trm"],["application/x-mswrite","wri"],["application/x-navi-animation","ani"],["application/x-navidoc","nvd"],["application/x-navimap","map"],["application/x-navistyle","stl"],["application/x-netcdf",["cdf","nc"]],["application/x-newton-compatible-pkg","pkg"],["application/x-nokia-9000-communicator-add-on-software","aos"],["application/x-omc","omc"],["application/x-omcdatamaker","omcd"],["application/x-omcregerator","omcr"],["application/x-pagemaker",["pm4","pm5"]],["application/x-pcl","pcl"],["application/x-perfmon",["pma","pmc","pml","pmr","pmw"]],["application/x-pixclscript","plx"],["application/x-pkcs10","p10"],["application/x-pkcs12",["p12","pfx"]],["application/x-pkcs7-certificates",["p7b","spc"]],["application/x-pkcs7-certreqresp","p7r"],["application/x-pkcs7-mime",["p7m","p7c"]],["application/x-pkcs7-signature",["p7s","p7a"]],["application/x-pointplus","css"],["application/x-portable-anymap","pnm"],["application/x-project",["mpc","mpt","mpv","mpx"]],["application/x-qpro","wb1"],["application/x-rar-compressed","rar"],["application/x-rtf","rtf"],["application/x-sdp","sdp"],["application/x-sea","sea"],["application/x-seelogo","sl"],["application/x-sh","sh"],["application/x-shar",["shar","sh"]],["application/x-shockwave-flash","swf"],["application/x-silverlight-app","xap"],["application/x-sit","sit"],["application/x-sprite",["spr","sprite"]],["application/x-stuffit","sit"],["application/x-stuffitx","sitx"],["application/x-sv4cpio","sv4cpio"],["application/x-sv4crc","sv4crc"],["application/x-tar","tar"],["application/x-tbook",["sbk","tbk"]],["application/x-tcl","tcl"],["application/x-tex","tex"],["application/x-tex-tfm","tfm"],["application/x-texinfo",["texi","texinfo"]],["application/x-troff",["roff","t","tr"]],["application/x-troff-man","man"],["application/x-troff-me","me"],["application/x-troff-ms","ms"],["application/x-troff-msvideo","avi"],["application/x-ustar","ustar"],["application/x-visio",["vsd","vst","vsw"]],["application/x-vnd.audioexplosion.mzz","mzz"],["application/x-vnd.ls-xpix","xpix"],["application/x-vrml","vrml"],["application/x-wais-source",["src","wsrc"]],["application/x-winhelp","hlp"],["application/x-wintalk","wtk"],["application/x-world",["wrl","svr"]],["application/x-wpwin","wpd"],["application/x-wri","wri"],["application/x-x509-ca-cert",["cer","crt","der"]],["application/x-x509-user-cert","crt"],["application/x-xfig","fig"],["application/x-xpinstall","xpi"],["application/x-zip-compressed","zip"],["application/xcap-diff+xml","xdf"],["application/xenc+xml","xenc"],["application/xhtml+xml","xhtml"],["application/xml","xml"],["application/xml-dtd","dtd"],["application/xop+xml","xop"],["application/xslt+xml","xslt"],["application/xspf+xml","xspf"],["application/xv+xml","mxml"],["application/yang","yang"],["application/yin+xml","yin"],["application/ynd.ms-pkipko","pko"],["application/zip","zip"],["audio/adpcm","adp"],["audio/aiff",["aiff","aif","aifc"]],["audio/basic",["snd","au"]],["audio/it","it"],["audio/make",["funk","my","pfunk"]],["audio/make.my.funk","pfunk"],["audio/mid",["mid","rmi"]],["audio/midi",["midi","kar","mid"]],["audio/mod","mod"],["audio/mp4","mp4a"],["audio/mpeg",["mpga","mp3","m2a","mp2","mpa","mpg"]],["audio/mpeg3","mp3"],["audio/nspaudio",["la","lma"]],["audio/ogg","oga"],["audio/s3m","s3m"],["audio/tsp-audio","tsi"],["audio/tsplayer","tsp"],["audio/vnd.dece.audio","uva"],["audio/vnd.digital-winds","eol"],["audio/vnd.dra","dra"],["audio/vnd.dts","dts"],["audio/vnd.dts.hd","dtshd"],["audio/vnd.lucent.voice","lvp"],["audio/vnd.ms-playready.media.pya","pya"],["audio/vnd.nuera.ecelp4800","ecelp4800"],["audio/vnd.nuera.ecelp7470","ecelp7470"],["audio/vnd.nuera.ecelp9600","ecelp9600"],["audio/vnd.qcelp","qcp"],["audio/vnd.rip","rip"],["audio/voc","voc"],["audio/voxware","vox"],["audio/wav","wav"],["audio/webm","weba"],["audio/x-aac","aac"],["audio/x-adpcm","snd"],["audio/x-aiff",["aiff","aif","aifc"]],["audio/x-au","au"],["audio/x-gsm",["gsd","gsm"]],["audio/x-jam","jam"],["audio/x-liveaudio","lam"],["audio/x-mid",["mid","midi"]],["audio/x-midi",["midi","mid"]],["audio/x-mod","mod"],["audio/x-mpeg","mp2"],["audio/x-mpeg-3","mp3"],["audio/x-mpegurl","m3u"],["audio/x-mpequrl","m3u"],["audio/x-ms-wax","wax"],["audio/x-ms-wma","wma"],["audio/x-nspaudio",["la","lma"]],["audio/x-pn-realaudio",["ra","ram","rm","rmm","rmp"]],["audio/x-pn-realaudio-plugin",["ra","rmp","rpm"]],["audio/x-psid","sid"],["audio/x-realaudio","ra"],["audio/x-twinvq","vqf"],["audio/x-twinvq-plugin",["vqe","vql"]],["audio/x-vnd.audioexplosion.mjuicemediafile","mjf"],["audio/x-voc","voc"],["audio/x-wav","wav"],["audio/xm","xm"],["chemical/x-cdx","cdx"],["chemical/x-cif","cif"],["chemical/x-cmdf","cmdf"],["chemical/x-cml","cml"],["chemical/x-csml","csml"],["chemical/x-pdb",["pdb","xyz"]],["chemical/x-xyz","xyz"],["drawing/x-dwf","dwf"],["i-world/i-vrml","ivr"],["image/bmp",["bmp","bm"]],["image/cgm","cgm"],["image/cis-cod","cod"],["image/cmu-raster",["ras","rast"]],["image/fif","fif"],["image/florian",["flo","turbot"]],["image/g3fax","g3"],["image/gif","gif"],["image/ief",["ief","iefs"]],["image/jpeg",["jpeg","jpe","jpg","jfif","jfif-tbnl"]],["image/jutvision","jut"],["image/ktx","ktx"],["image/naplps",["nap","naplps"]],["image/pict",["pic","pict"]],["image/pipeg","jfif"],["image/pjpeg",["jfif","jpe","jpeg","jpg"]],["image/png",["png","x-png"]],["image/prs.btif","btif"],["image/svg+xml","svg"],["image/tiff",["tif","tiff"]],["image/vasa","mcf"],["image/vnd.adobe.photoshop","psd"],["image/vnd.dece.graphic","uvi"],["image/vnd.djvu","djvu"],["image/vnd.dvb.subtitle","sub"],["image/vnd.dwg",["dwg","dxf","svf"]],["image/vnd.dxf","dxf"],["image/vnd.fastbidsheet","fbs"],["image/vnd.fpx","fpx"],["image/vnd.fst","fst"],["image/vnd.fujixerox.edmics-mmr","mmr"],["image/vnd.fujixerox.edmics-rlc","rlc"],["image/vnd.ms-modi","mdi"],["image/vnd.net-fpx",["fpx","npx"]],["image/vnd.rn-realflash","rf"],["image/vnd.rn-realpix","rp"],["image/vnd.wap.wbmp","wbmp"],["image/vnd.xiff","xif"],["image/webp","webp"],["image/x-cmu-raster","ras"],["image/x-cmx","cmx"],["image/x-dwg",["dwg","dxf","svf"]],["image/x-freehand","fh"],["image/x-icon","ico"],["image/x-jg","art"],["image/x-jps","jps"],["image/x-niff",["niff","nif"]],["image/x-pcx","pcx"],["image/x-pict",["pct","pic"]],["image/x-portable-anymap","pnm"],["image/x-portable-bitmap","pbm"],["image/x-portable-graymap","pgm"],["image/x-portable-greymap","pgm"],["image/x-portable-pixmap","ppm"],["image/x-quicktime",["qif","qti","qtif"]],["image/x-rgb","rgb"],["image/x-tiff",["tif","tiff"]],["image/x-windows-bmp","bmp"],["image/x-xbitmap","xbm"],["image/x-xbm","xbm"],["image/x-xpixmap",["xpm","pm"]],["image/x-xwd","xwd"],["image/x-xwindowdump","xwd"],["image/xbm","xbm"],["image/xpm","xpm"],["message/rfc822",["eml","mht","mhtml","nws","mime"]],["model/iges",["iges","igs"]],["model/mesh","msh"],["model/vnd.collada+xml","dae"],["model/vnd.dwf","dwf"],["model/vnd.gdl","gdl"],["model/vnd.gtw","gtw"],["model/vnd.mts","mts"],["model/vnd.vtu","vtu"],["model/vrml",["vrml","wrl","wrz"]],["model/x-pov","pov"],["multipart/x-gzip","gzip"],["multipart/x-ustar","ustar"],["multipart/x-zip","zip"],["music/crescendo",["mid","midi"]],["music/x-karaoke","kar"],["paleovu/x-pv","pvu"],["text/asp","asp"],["text/calendar","ics"],["text/css","css"],["text/csv","csv"],["text/ecmascript","js"],["text/h323","323"],["text/html",["html","htm","stm","acgi","htmls","htx","shtml"]],["text/iuls","uls"],["text/javascript","js"],["text/mcf","mcf"],["text/n3","n3"],["text/pascal","pas"],["text/plain",["txt","bas","c","h","c++","cc","com","conf","cxx","def","f","f90","for","g","hh","idc","jav","java","list","log","lst","m","mar","pl","sdml","text"]],["text/plain-bas","par"],["text/prs.lines.tag","dsc"],["text/richtext",["rtx","rt","rtf"]],["text/scriplet","wsc"],["text/scriptlet","sct"],["text/sgml",["sgm","sgml"]],["text/tab-separated-values","tsv"],["text/troff","t"],["text/turtle","ttl"],["text/uri-list",["uni","unis","uri","uris"]],["text/vnd.abc","abc"],["text/vnd.curl","curl"],["text/vnd.curl.dcurl","dcurl"],["text/vnd.curl.mcurl","mcurl"],["text/vnd.curl.scurl","scurl"],["text/vnd.fly","fly"],["text/vnd.fmi.flexstor","flx"],["text/vnd.graphviz","gv"],["text/vnd.in3d.3dml","3dml"],["text/vnd.in3d.spot","spot"],["text/vnd.rn-realtext","rt"],["text/vnd.sun.j2me.app-descriptor","jad"],["text/vnd.wap.wml","wml"],["text/vnd.wap.wmlscript","wmls"],["text/webviewhtml","htt"],["text/x-asm",["asm","s"]],["text/x-audiosoft-intra","aip"],["text/x-c",["c","cc","cpp"]],["text/x-component","htc"],["text/x-fortran",["for","f","f77","f90"]],["text/x-h",["h","hh"]],["text/x-java-source",["java","jav"]],["text/x-java-source,java","java"],["text/x-la-asf","lsx"],["text/x-m","m"],["text/x-pascal","p"],["text/x-script","hlb"],["text/x-script.csh","csh"],["text/x-script.elisp","el"],["text/x-script.guile","scm"],["text/x-script.ksh","ksh"],["text/x-script.lisp","lsp"],["text/x-script.perl","pl"],["text/x-script.perl-module","pm"],["text/x-script.phyton","py"],["text/x-script.rexx","rexx"],["text/x-script.scheme","scm"],["text/x-script.sh","sh"],["text/x-script.tcl","tcl"],["text/x-script.tcsh","tcsh"],["text/x-script.zsh","zsh"],["text/x-server-parsed-html",["shtml","ssi"]],["text/x-setext","etx"],["text/x-sgml",["sgm","sgml"]],["text/x-speech",["spc","talk"]],["text/x-uil","uil"],["text/x-uuencode",["uu","uue"]],["text/x-vcalendar","vcs"],["text/x-vcard","vcf"],["text/xml","xml"],["video/3gpp","3gp"],["video/3gpp2","3g2"],["video/animaflex","afl"],["video/avi","avi"],["video/avs-video","avs"],["video/dl","dl"],["video/fli","fli"],["video/gl","gl"],["video/h261","h261"],["video/h263","h263"],["video/h264","h264"],["video/jpeg","jpgv"],["video/jpm","jpm"],["video/mj2","mj2"],["video/mp4","mp4"],["video/mpeg",["mpeg","mp2","mpa","mpe","mpg","mpv2","m1v","m2v","mp3"]],["video/msvideo","avi"],["video/ogg","ogv"],["video/quicktime",["mov","qt","moov"]],["video/vdo","vdo"],["video/vivo",["viv","vivo"]],["video/vnd.dece.hd","uvh"],["video/vnd.dece.mobile","uvm"],["video/vnd.dece.pd","uvp"],["video/vnd.dece.sd","uvs"],["video/vnd.dece.video","uvv"],["video/vnd.fvt","fvt"],["video/vnd.mpegurl","mxu"],["video/vnd.ms-playready.media.pyv","pyv"],["video/vnd.rn-realvideo","rv"],["video/vnd.uvvu.mp4","uvu"],["video/vnd.vivo",["viv","vivo"]],["video/vosaic","vos"],["video/webm","webm"],["video/x-amt-demorun","xdr"],["video/x-amt-showrun","xsr"],["video/x-atomic3d-feature","fmf"],["video/x-dl","dl"],["video/x-dv",["dif","dv"]],["video/x-f4v","f4v"],["video/x-fli","fli"],["video/x-flv","flv"],["video/x-gl","gl"],["video/x-isvideo","isu"],["video/x-la-asf",["lsf","lsx"]],["video/x-m4v","m4v"],["video/x-motion-jpeg","mjpg"],["video/x-mpeg",["mp3","mp2"]],["video/x-mpeq2a","mp2"],["video/x-ms-asf",["asf","asr","asx"]],["video/x-ms-asf-plugin","asx"],["video/x-ms-wm","wm"],["video/x-ms-wmv","wmv"],["video/x-ms-wmx","wmx"],["video/x-ms-wvx","wvx"],["video/x-msvideo","avi"],["video/x-qtc","qtc"],["video/x-scm","scm"],["video/x-sgi-movie",["movie","mv"]],["windows/metafile","wmf"],["www/mime","mime"],["x-conference/x-cooltalk","ice"],["x-music/x-midi",["mid","midi"]],["x-world/x-3dmf",["3dm","3dmf","qd3","qd3d"]],["x-world/x-svr","svr"],["x-world/x-vrml",["flr","vrml","wrl","wrz","xaf","xof"]],["x-world/x-vrt","vrt"],["xgl/drawing","xgz"],["xgl/movie","xmz"]]),extensions=new Map([["123","application/vnd.lotus-1-2-3"],["323","text/h323"],["*","application/octet-stream"],["3dm","x-world/x-3dmf"],["3dmf","x-world/x-3dmf"],["3dml","text/vnd.in3d.3dml"],["3g2","video/3gpp2"],["3gp","video/3gpp"],["7z","application/x-7z-compressed"],["a","application/octet-stream"],["aab","application/x-authorware-bin"],["aac","audio/x-aac"],["aam","application/x-authorware-map"],["aas","application/x-authorware-seg"],["abc","text/vnd.abc"],["abw","application/x-abiword"],["ac","application/pkix-attr-cert"],["acc","application/vnd.americandynamics.acc"],["ace","application/x-ace-compressed"],["acgi","text/html"],["acu","application/vnd.acucobol"],["acx","application/internet-property-stream"],["adp","audio/adpcm"],["aep","application/vnd.audiograph"],["afl","video/animaflex"],["afp","application/vnd.ibm.modcap"],["ahead","application/vnd.ahead.space"],["ai","application/postscript"],["aif",["audio/aiff","audio/x-aiff"]],["aifc",["audio/aiff","audio/x-aiff"]],["aiff",["audio/aiff","audio/x-aiff"]],["aim","application/x-aim"],["aip","text/x-audiosoft-intra"],["air","application/vnd.adobe.air-application-installer-package+zip"],["ait","application/vnd.dvb.ait"],["ami","application/vnd.amiga.ami"],["ani","application/x-navi-animation"],["aos","application/x-nokia-9000-communicator-add-on-software"],["apk","application/vnd.android.package-archive"],["application","application/x-ms-application"],["apr","application/vnd.lotus-approach"],["aps","application/mime"],["arc","application/octet-stream"],["arj",["application/arj","application/octet-stream"]],["art","image/x-jg"],["asf","video/x-ms-asf"],["asm","text/x-asm"],["aso","application/vnd.accpac.simply.aso"],["asp","text/asp"],["asr","video/x-ms-asf"],["asx",["video/x-ms-asf","application/x-mplayer2","video/x-ms-asf-plugin"]],["atc","application/vnd.acucorp"],["atomcat","application/atomcat+xml"],["atomsvc","application/atomsvc+xml"],["atx","application/vnd.antix.game-component"],["au",["audio/basic","audio/x-au"]],["avi",["video/avi","video/msvideo","application/x-troff-msvideo","video/x-msvideo"]],["avs","video/avs-video"],["aw","application/applixware"],["axs","application/olescript"],["azf","application/vnd.airzip.filesecure.azf"],["azs","application/vnd.airzip.filesecure.azs"],["azw","application/vnd.amazon.ebook"],["bas","text/plain"],["bcpio","application/x-bcpio"],["bdf","application/x-font-bdf"],["bdm","application/vnd.syncml.dm+wbxml"],["bed","application/vnd.realvnc.bed"],["bh2","application/vnd.fujitsu.oasysprs"],["bin",["application/octet-stream","application/mac-binary","application/macbinary","application/x-macbinary","application/x-binary"]],["bm","image/bmp"],["bmi","application/vnd.bmi"],["bmp",["image/bmp","image/x-windows-bmp"]],["boo","application/book"],["book","application/book"],["box","application/vnd.previewsystems.box"],["boz","application/x-bzip2"],["bsh","application/x-bsh"],["btif","image/prs.btif"],["bz","application/x-bzip"],["bz2","application/x-bzip2"],["c",["text/plain","text/x-c"]],["c++","text/plain"],["c11amc","application/vnd.cluetrust.cartomobile-config"],["c11amz","application/vnd.cluetrust.cartomobile-config-pkg"],["c4g","application/vnd.clonk.c4group"],["cab","application/vnd.ms-cab-compressed"],["car","application/vnd.curl.car"],["cat",["application/vnd.ms-pkiseccat","application/vnd.ms-pki.seccat"]],["cc",["text/plain","text/x-c"]],["ccad","application/clariscad"],["cco","application/x-cocoa"],["ccxml","application/ccxml+xml,"],["cdbcmsg","application/vnd.contact.cmsg"],["cdf",["application/cdf","application/x-cdf","application/x-netcdf"]],["cdkey","application/vnd.mediastation.cdkey"],["cdmia","application/cdmi-capability"],["cdmic","application/cdmi-container"],["cdmid","application/cdmi-domain"],["cdmio","application/cdmi-object"],["cdmiq","application/cdmi-queue"],["cdx","chemical/x-cdx"],["cdxml","application/vnd.chemdraw+xml"],["cdy","application/vnd.cinderella"],["cer",["application/pkix-cert","application/x-x509-ca-cert"]],["cgm","image/cgm"],["cha","application/x-chat"],["chat","application/x-chat"],["chm","application/vnd.ms-htmlhelp"],["chrt","application/vnd.kde.kchart"],["cif","chemical/x-cif"],["cii","application/vnd.anser-web-certificate-issue-initiation"],["cil","application/vnd.ms-artgalry"],["cla","application/vnd.claymore"],["class",["application/octet-stream","application/java","application/java-byte-code","application/java-vm","application/x-java-class"]],["clkk","application/vnd.crick.clicker.keyboard"],["clkp","application/vnd.crick.clicker.palette"],["clkt","application/vnd.crick.clicker.template"],["clkw","application/vnd.crick.clicker.wordbank"],["clkx","application/vnd.crick.clicker"],["clp","application/x-msclip"],["cmc","application/vnd.cosmocaller"],["cmdf","chemical/x-cmdf"],["cml","chemical/x-cml"],["cmp","application/vnd.yellowriver-custom-menu"],["cmx","image/x-cmx"],["cod",["image/cis-cod","application/vnd.rim.cod"]],["com",["application/octet-stream","text/plain"]],["conf","text/plain"],["cpio","application/x-cpio"],["cpp","text/x-c"],["cpt",["application/mac-compactpro","application/x-compactpro","application/x-cpt"]],["crd","application/x-mscardfile"],["crl",["application/pkix-crl","application/pkcs-crl"]],["crt",["application/pkix-cert","application/x-x509-user-cert","application/x-x509-ca-cert"]],["cryptonote","application/vnd.rig.cryptonote"],["csh",["text/x-script.csh","application/x-csh"]],["csml","chemical/x-csml"],["csp","application/vnd.commonspace"],["css",["text/css","application/x-pointplus"]],["csv","text/csv"],["cu","application/cu-seeme"],["curl","text/vnd.curl"],["cww","application/prs.cww"],["cxx","text/plain"],["dae","model/vnd.collada+xml"],["daf","application/vnd.mobius.daf"],["davmount","application/davmount+xml"],["dcr","application/x-director"],["dcurl","text/vnd.curl.dcurl"],["dd2","application/vnd.oma.dd2+xml"],["ddd","application/vnd.fujixerox.ddd"],["deb","application/x-debian-package"],["deepv","application/x-deepv"],["def","text/plain"],["der","application/x-x509-ca-cert"],["dfac","application/vnd.dreamfactory"],["dif","video/x-dv"],["dir","application/x-director"],["dis","application/vnd.mobius.dis"],["djvu","image/vnd.djvu"],["dl",["video/dl","video/x-dl"]],["dll","application/x-msdownload"],["dms","application/octet-stream"],["dna","application/vnd.dna"],["doc","application/msword"],["docm","application/vnd.ms-word.document.macroenabled.12"],["docx","application/vnd.openxmlformats-officedocument.wordprocessingml.document"],["dot","application/msword"],["dotm","application/vnd.ms-word.template.macroenabled.12"],["dotx","application/vnd.openxmlformats-officedocument.wordprocessingml.template"],["dp",["application/commonground","application/vnd.osgi.dp"]],["dpg","application/vnd.dpgraph"],["dra","audio/vnd.dra"],["drw","application/drafting"],["dsc","text/prs.lines.tag"],["dssc","application/dssc+der"],["dtb","application/x-dtbook+xml"],["dtd","application/xml-dtd"],["dts","audio/vnd.dts"],["dtshd","audio/vnd.dts.hd"],["dump","application/octet-stream"],["dv","video/x-dv"],["dvi","application/x-dvi"],["dwf",["model/vnd.dwf","drawing/x-dwf"]],["dwg",["application/acad","image/vnd.dwg","image/x-dwg"]],["dxf",["application/dxf","image/vnd.dwg","image/vnd.dxf","image/x-dwg"]],["dxp","application/vnd.spotfire.dxp"],["dxr","application/x-director"],["ecelp4800","audio/vnd.nuera.ecelp4800"],["ecelp7470","audio/vnd.nuera.ecelp7470"],["ecelp9600","audio/vnd.nuera.ecelp9600"],["edm","application/vnd.novadigm.edm"],["edx","application/vnd.novadigm.edx"],["efif","application/vnd.picsel"],["ei6","application/vnd.pg.osasli"],["el","text/x-script.elisp"],["elc",["application/x-elc","application/x-bytecode.elisp"]],["eml","message/rfc822"],["emma","application/emma+xml"],["env","application/x-envoy"],["eol","audio/vnd.digital-winds"],["eot","application/vnd.ms-fontobject"],["eps","application/postscript"],["epub","application/epub+zip"],["es",["application/ecmascript","application/x-esrehber"]],["es3","application/vnd.eszigno3+xml"],["esf","application/vnd.epson.esf"],["etx","text/x-setext"],["evy",["application/envoy","application/x-envoy"]],["exe",["application/octet-stream","application/x-msdownload"]],["exi","application/exi"],["ext","application/vnd.novadigm.ext"],["ez2","application/vnd.ezpix-album"],["ez3","application/vnd.ezpix-package"],["f",["text/plain","text/x-fortran"]],["f4v","video/x-f4v"],["f77","text/x-fortran"],["f90",["text/plain","text/x-fortran"]],["fbs","image/vnd.fastbidsheet"],["fcs","application/vnd.isac.fcs"],["fdf","application/vnd.fdf"],["fe_launch","application/vnd.denovo.fcselayout-link"],["fg5","application/vnd.fujitsu.oasysgp"],["fh","image/x-freehand"],["fif",["application/fractals","image/fif"]],["fig","application/x-xfig"],["fli",["video/fli","video/x-fli"]],["flo",["image/florian","application/vnd.micrografx.flo"]],["flr","x-world/x-vrml"],["flv","video/x-flv"],["flw","application/vnd.kde.kivio"],["flx","text/vnd.fmi.flexstor"],["fly","text/vnd.fly"],["fm","application/vnd.framemaker"],["fmf","video/x-atomic3d-feature"],["fnc","application/vnd.frogans.fnc"],["for",["text/plain","text/x-fortran"]],["fpx",["image/vnd.fpx","image/vnd.net-fpx"]],["frl","application/freeloader"],["fsc","application/vnd.fsc.weblaunch"],["fst","image/vnd.fst"],["ftc","application/vnd.fluxtime.clip"],["fti","application/vnd.anser-web-funds-transfer-initiation"],["funk","audio/make"],["fvt","video/vnd.fvt"],["fxp","application/vnd.adobe.fxp"],["fzs","application/vnd.fuzzysheet"],["g","text/plain"],["g2w","application/vnd.geoplan"],["g3","image/g3fax"],["g3w","application/vnd.geospace"],["gac","application/vnd.groove-account"],["gdl","model/vnd.gdl"],["geo","application/vnd.dynageo"],["geojson","application/geo+json"],["gex","application/vnd.geometry-explorer"],["ggb","application/vnd.geogebra.file"],["ggt","application/vnd.geogebra.tool"],["ghf","application/vnd.groove-help"],["gif","image/gif"],["gim","application/vnd.groove-identity-message"],["gl",["video/gl","video/x-gl"]],["gmx","application/vnd.gmx"],["gnumeric","application/x-gnumeric"],["gph","application/vnd.flographit"],["gqf","application/vnd.grafeq"],["gram","application/srgs"],["grv","application/vnd.groove-injector"],["grxml","application/srgs+xml"],["gsd","audio/x-gsm"],["gsf","application/x-font-ghostscript"],["gsm","audio/x-gsm"],["gsp","application/x-gsp"],["gss","application/x-gss"],["gtar","application/x-gtar"],["gtm","application/vnd.groove-tool-message"],["gtw","model/vnd.gtw"],["gv","text/vnd.graphviz"],["gxt","application/vnd.geonext"],["gz",["application/x-gzip","application/x-compressed"]],["gzip",["multipart/x-gzip","application/x-gzip"]],["h",["text/plain","text/x-h"]],["h261","video/h261"],["h263","video/h263"],["h264","video/h264"],["hal","application/vnd.hal+xml"],["hbci","application/vnd.hbci"],["hdf","application/x-hdf"],["help","application/x-helpfile"],["hgl","application/vnd.hp-hpgl"],["hh",["text/plain","text/x-h"]],["hlb","text/x-script"],["hlp",["application/winhlp","application/hlp","application/x-helpfile","application/x-winhelp"]],["hpg","application/vnd.hp-hpgl"],["hpgl","application/vnd.hp-hpgl"],["hpid","application/vnd.hp-hpid"],["hps","application/vnd.hp-hps"],["hqx",["application/mac-binhex40","application/binhex","application/binhex4","application/mac-binhex","application/x-binhex40","application/x-mac-binhex40"]],["hta","application/hta"],["htc","text/x-component"],["htke","application/vnd.kenameaapp"],["htm","text/html"],["html","text/html"],["htmls","text/html"],["htt","text/webviewhtml"],["htx","text/html"],["hvd","application/vnd.yamaha.hv-dic"],["hvp","application/vnd.yamaha.hv-voice"],["hvs","application/vnd.yamaha.hv-script"],["i2g","application/vnd.intergeo"],["icc","application/vnd.iccprofile"],["ice","x-conference/x-cooltalk"],["ico","image/x-icon"],["ics","text/calendar"],["idc","text/plain"],["ief","image/ief"],["iefs","image/ief"],["ifm","application/vnd.shana.informed.formdata"],["iges",["application/iges","model/iges"]],["igl","application/vnd.igloader"],["igm","application/vnd.insors.igm"],["igs",["application/iges","model/iges"]],["igx","application/vnd.micrografx.igx"],["iif","application/vnd.shana.informed.interchange"],["iii","application/x-iphone"],["ima","application/x-ima"],["imap","application/x-httpd-imap"],["imp","application/vnd.accpac.simply.imp"],["ims","application/vnd.ms-ims"],["inf","application/inf"],["ins",["application/x-internet-signup","application/x-internett-signup"]],["ip","application/x-ip2"],["ipfix","application/ipfix"],["ipk","application/vnd.shana.informed.package"],["irm","application/vnd.ibm.rights-management"],["irp","application/vnd.irepository.package+xml"],["isp","application/x-internet-signup"],["isu","video/x-isvideo"],["it","audio/it"],["itp","application/vnd.shana.informed.formtemplate"],["iv","application/x-inventor"],["ivp","application/vnd.immervision-ivp"],["ivr","i-world/i-vrml"],["ivu","application/vnd.immervision-ivu"],["ivy","application/x-livescreen"],["jad","text/vnd.sun.j2me.app-descriptor"],["jam",["application/vnd.jam","audio/x-jam"]],["jar","application/java-archive"],["jav",["text/plain","text/x-java-source"]],["java",["text/plain","text/x-java-source,java","text/x-java-source"]],["jcm","application/x-java-commerce"],["jfif",["image/pipeg","image/jpeg","image/pjpeg"]],["jfif-tbnl","image/jpeg"],["jisp","application/vnd.jisp"],["jlt","application/vnd.hp-jlyt"],["jnlp","application/x-java-jnlp-file"],["joda","application/vnd.joost.joda-archive"],["jpe",["image/jpeg","image/pjpeg"]],["jpeg",["image/jpeg","image/pjpeg"]],["jpg",["image/jpeg","image/pjpeg"]],["jpgv","video/jpeg"],["jpm","video/jpm"],["jps","image/x-jps"],["js",["application/javascript","application/ecmascript","text/javascript","text/ecmascript","application/x-javascript"]],["json","application/json"],["jut","image/jutvision"],["kar",["audio/midi","music/x-karaoke"]],["karbon","application/vnd.kde.karbon"],["kfo","application/vnd.kde.kformula"],["kia","application/vnd.kidspiration"],["kml","application/vnd.google-earth.kml+xml"],["kmz","application/vnd.google-earth.kmz"],["kne","application/vnd.kinar"],["kon","application/vnd.kde.kontour"],["kpr","application/vnd.kde.kpresenter"],["ksh",["application/x-ksh","text/x-script.ksh"]],["ksp","application/vnd.kde.kspread"],["ktx","image/ktx"],["ktz","application/vnd.kahootz"],["kwd","application/vnd.kde.kword"],["la",["audio/nspaudio","audio/x-nspaudio"]],["lam","audio/x-liveaudio"],["lasxml","application/vnd.las.las+xml"],["latex","application/x-latex"],["lbd","application/vnd.llamagraphics.life-balance.desktop"],["lbe","application/vnd.llamagraphics.life-balance.exchange+xml"],["les","application/vnd.hhe.lesson-player"],["lha",["application/octet-stream","application/lha","application/x-lha"]],["lhx","application/octet-stream"],["link66","application/vnd.route66.link66+xml"],["list","text/plain"],["lma",["audio/nspaudio","audio/x-nspaudio"]],["log","text/plain"],["lrm","application/vnd.ms-lrm"],["lsf","video/x-la-asf"],["lsp",["application/x-lisp","text/x-script.lisp"]],["lst","text/plain"],["lsx",["video/x-la-asf","text/x-la-asf"]],["ltf","application/vnd.frogans.ltf"],["ltx","application/x-latex"],["lvp","audio/vnd.lucent.voice"],["lwp","application/vnd.lotus-wordpro"],["lzh",["application/octet-stream","application/x-lzh"]],["lzx",["application/lzx","application/octet-stream","application/x-lzx"]],["m",["text/plain","text/x-m"]],["m13","application/x-msmediaview"],["m14","application/x-msmediaview"],["m1v","video/mpeg"],["m21","application/mp21"],["m2a","audio/mpeg"],["m2v","video/mpeg"],["m3u",["audio/x-mpegurl","audio/x-mpequrl"]],["m3u8","application/vnd.apple.mpegurl"],["m4v","video/x-m4v"],["ma","application/mathematica"],["mads","application/mads+xml"],["mag","application/vnd.ecowin.chart"],["man","application/x-troff-man"],["map","application/x-navimap"],["mar","text/plain"],["mathml","application/mathml+xml"],["mbd","application/mbedlet"],["mbk","application/vnd.mobius.mbk"],["mbox","application/mbox"],["mc$","application/x-magic-cap-package-1.0"],["mc1","application/vnd.medcalcdata"],["mcd",["application/mcad","application/vnd.mcd","application/x-mathcad"]],["mcf",["image/vasa","text/mcf"]],["mcp","application/netmc"],["mcurl","text/vnd.curl.mcurl"],["mdb","application/x-msaccess"],["mdi","image/vnd.ms-modi"],["me","application/x-troff-me"],["meta4","application/metalink4+xml"],["mets","application/mets+xml"],["mfm","application/vnd.mfmp"],["mgp","application/vnd.osgeo.mapguide.package"],["mgz","application/vnd.proteus.magazine"],["mht","message/rfc822"],["mhtml","message/rfc822"],["mid",["audio/mid","audio/midi","music/crescendo","x-music/x-midi","audio/x-midi","application/x-midi","audio/x-mid"]],["midi",["audio/midi","music/crescendo","x-music/x-midi","audio/x-midi","application/x-midi","audio/x-mid"]],["mif",["application/vnd.mif","application/x-mif","application/x-frame"]],["mime",["message/rfc822","www/mime"]],["mj2","video/mj2"],["mjf","audio/x-vnd.audioexplosion.mjuicemediafile"],["mjpg","video/x-motion-jpeg"],["mlp","application/vnd.dolby.mlp"],["mm",["application/base64","application/x-meme"]],["mmd","application/vnd.chipnuts.karaoke-mmd"],["mme","application/base64"],["mmf","application/vnd.smaf"],["mmr","image/vnd.fujixerox.edmics-mmr"],["mny","application/x-msmoney"],["mod",["audio/mod","audio/x-mod"]],["mods","application/mods+xml"],["moov","video/quicktime"],["mov","video/quicktime"],["movie","video/x-sgi-movie"],["mp2",["video/mpeg","audio/mpeg","video/x-mpeg","audio/x-mpeg","video/x-mpeq2a"]],["mp3",["audio/mpeg","audio/mpeg3","video/mpeg","audio/x-mpeg-3","video/x-mpeg"]],["mp4",["video/mp4","application/mp4"]],["mp4a","audio/mp4"],["mpa",["video/mpeg","audio/mpeg"]],["mpc",["application/vnd.mophun.certificate","application/x-project"]],["mpe","video/mpeg"],["mpeg","video/mpeg"],["mpg",["video/mpeg","audio/mpeg"]],["mpga","audio/mpeg"],["mpkg","application/vnd.apple.installer+xml"],["mpm","application/vnd.blueice.multipass"],["mpn","application/vnd.mophun.application"],["mpp","application/vnd.ms-project"],["mpt","application/x-project"],["mpv","application/x-project"],["mpv2","video/mpeg"],["mpx","application/x-project"],["mpy","application/vnd.ibm.minipay"],["mqy","application/vnd.mobius.mqy"],["mrc","application/marc"],["mrcx","application/marcxml+xml"],["ms","application/x-troff-ms"],["mscml","application/mediaservercontrol+xml"],["mseq","application/vnd.mseq"],["msf","application/vnd.epson.msf"],["msg","application/vnd.ms-outlook"],["msh","model/mesh"],["msl","application/vnd.mobius.msl"],["msty","application/vnd.muvee.style"],["mts","model/vnd.mts"],["mus","application/vnd.musician"],["musicxml","application/vnd.recordare.musicxml+xml"],["mv","video/x-sgi-movie"],["mvb","application/x-msmediaview"],["mwf","application/vnd.mfer"],["mxf","application/mxf"],["mxl","application/vnd.recordare.musicxml"],["mxml","application/xv+xml"],["mxs","application/vnd.triscape.mxs"],["mxu","video/vnd.mpegurl"],["my","audio/make"],["mzz","application/x-vnd.audioexplosion.mzz"],["n-gage","application/vnd.nokia.n-gage.symbian.install"],["n3","text/n3"],["nap","image/naplps"],["naplps","image/naplps"],["nbp","application/vnd.wolfram.player"],["nc","application/x-netcdf"],["ncm","application/vnd.nokia.configuration-message"],["ncx","application/x-dtbncx+xml"],["ngdat","application/vnd.nokia.n-gage.data"],["nif","image/x-niff"],["niff","image/x-niff"],["nix","application/x-mix-transfer"],["nlu","application/vnd.neurolanguage.nlu"],["nml","application/vnd.enliven"],["nnd","application/vnd.noblenet-directory"],["nns","application/vnd.noblenet-sealer"],["nnw","application/vnd.noblenet-web"],["npx","image/vnd.net-fpx"],["nsc","application/x-conference"],["nsf","application/vnd.lotus-notes"],["nvd","application/x-navidoc"],["nws","message/rfc822"],["o","application/octet-stream"],["oa2","application/vnd.fujitsu.oasys2"],["oa3","application/vnd.fujitsu.oasys3"],["oas","application/vnd.fujitsu.oasys"],["obd","application/x-msbinder"],["oda","application/oda"],["odb","application/vnd.oasis.opendocument.database"],["odc","application/vnd.oasis.opendocument.chart"],["odf","application/vnd.oasis.opendocument.formula"],["odft","application/vnd.oasis.opendocument.formula-template"],["odg","application/vnd.oasis.opendocument.graphics"],["odi","application/vnd.oasis.opendocument.image"],["odm","application/vnd.oasis.opendocument.text-master"],["odp","application/vnd.oasis.opendocument.presentation"],["ods","application/vnd.oasis.opendocument.spreadsheet"],["odt","application/vnd.oasis.opendocument.text"],["oga","audio/ogg"],["ogv","video/ogg"],["ogx","application/ogg"],["omc","application/x-omc"],["omcd","application/x-omcdatamaker"],["omcr","application/x-omcregerator"],["onetoc","application/onenote"],["opf","application/oebps-package+xml"],["org","application/vnd.lotus-organizer"],["osf","application/vnd.yamaha.openscoreformat"],["osfpvg","application/vnd.yamaha.openscoreformat.osfpvg+xml"],["otc","application/vnd.oasis.opendocument.chart-template"],["otf","application/x-font-otf"],["otg","application/vnd.oasis.opendocument.graphics-template"],["oth","application/vnd.oasis.opendocument.text-web"],["oti","application/vnd.oasis.opendocument.image-template"],["otp","application/vnd.oasis.opendocument.presentation-template"],["ots","application/vnd.oasis.opendocument.spreadsheet-template"],["ott","application/vnd.oasis.opendocument.text-template"],["oxt","application/vnd.openofficeorg.extension"],["p","text/x-pascal"],["p10",["application/pkcs10","application/x-pkcs10"]],["p12",["application/pkcs-12","application/x-pkcs12"]],["p7a","application/x-pkcs7-signature"],["p7b","application/x-pkcs7-certificates"],["p7c",["application/pkcs7-mime","application/x-pkcs7-mime"]],["p7m",["application/pkcs7-mime","application/x-pkcs7-mime"]],["p7r","application/x-pkcs7-certreqresp"],["p7s",["application/pkcs7-signature","application/x-pkcs7-signature"]],["p8","application/pkcs8"],["par","text/plain-bas"],["part","application/pro_eng"],["pas","text/pascal"],["paw","application/vnd.pawaafile"],["pbd","application/vnd.powerbuilder6"],["pbm","image/x-portable-bitmap"],["pcf","application/x-font-pcf"],["pcl",["application/vnd.hp-pcl","application/x-pcl"]],["pclxl","application/vnd.hp-pclxl"],["pct","image/x-pict"],["pcurl","application/vnd.curl.pcurl"],["pcx","image/x-pcx"],["pdb",["application/vnd.palm","chemical/x-pdb"]],["pdf","application/pdf"],["pfa","application/x-font-type1"],["pfr","application/font-tdpfr"],["pfunk",["audio/make","audio/make.my.funk"]],["pfx","application/x-pkcs12"],["pgm",["image/x-portable-graymap","image/x-portable-greymap"]],["pgn","application/x-chess-pgn"],["pgp","application/pgp-signature"],["pic",["image/pict","image/x-pict"]],["pict","image/pict"],["pkg","application/x-newton-compatible-pkg"],["pki","application/pkixcmp"],["pkipath","application/pkix-pkipath"],["pko",["application/ynd.ms-pkipko","application/vnd.ms-pki.pko"]],["pl",["text/plain","text/x-script.perl"]],["plb","application/vnd.3gpp.pic-bw-large"],["plc","application/vnd.mobius.plc"],["plf","application/vnd.pocketlearn"],["pls","application/pls+xml"],["plx","application/x-pixclscript"],["pm",["text/x-script.perl-module","image/x-xpixmap"]],["pm4","application/x-pagemaker"],["pm5","application/x-pagemaker"],["pma","application/x-perfmon"],["pmc","application/x-perfmon"],["pml",["application/vnd.ctc-posml","application/x-perfmon"]],["pmr","application/x-perfmon"],["pmw","application/x-perfmon"],["png","image/png"],["pnm",["application/x-portable-anymap","image/x-portable-anymap"]],["portpkg","application/vnd.macports.portpkg"],["pot",["application/vnd.ms-powerpoint","application/mspowerpoint"]],["potm","application/vnd.ms-powerpoint.template.macroenabled.12"],["potx","application/vnd.openxmlformats-officedocument.presentationml.template"],["pov","model/x-pov"],["ppa","application/vnd.ms-powerpoint"],["ppam","application/vnd.ms-powerpoint.addin.macroenabled.12"],["ppd","application/vnd.cups-ppd"],["ppm","image/x-portable-pixmap"],["pps",["application/vnd.ms-powerpoint","application/mspowerpoint"]],["ppsm","application/vnd.ms-powerpoint.slideshow.macroenabled.12"],["ppsx","application/vnd.openxmlformats-officedocument.presentationml.slideshow"],["ppt",["application/vnd.ms-powerpoint","application/mspowerpoint","application/powerpoint","application/x-mspowerpoint"]],["pptm","application/vnd.ms-powerpoint.presentation.macroenabled.12"],["pptx","application/vnd.openxmlformats-officedocument.presentationml.presentation"],["ppz","application/mspowerpoint"],["prc","application/x-mobipocket-ebook"],["pre",["application/vnd.lotus-freelance","application/x-freelance"]],["prf","application/pics-rules"],["prt","application/pro_eng"],["ps","application/postscript"],["psb","application/vnd.3gpp.pic-bw-small"],["psd",["application/octet-stream","image/vnd.adobe.photoshop"]],["psf","application/x-font-linux-psf"],["pskcxml","application/pskc+xml"],["ptid","application/vnd.pvi.ptid1"],["pub","application/x-mspublisher"],["pvb","application/vnd.3gpp.pic-bw-var"],["pvu","paleovu/x-pv"],["pwn","application/vnd.3m.post-it-notes"],["pwz","application/vnd.ms-powerpoint"],["py","text/x-script.phyton"],["pya","audio/vnd.ms-playready.media.pya"],["pyc","application/x-bytecode.python"],["pyv","video/vnd.ms-playready.media.pyv"],["qam","application/vnd.epson.quickanime"],["qbo","application/vnd.intu.qbo"],["qcp","audio/vnd.qcelp"],["qd3","x-world/x-3dmf"],["qd3d","x-world/x-3dmf"],["qfx","application/vnd.intu.qfx"],["qif","image/x-quicktime"],["qps","application/vnd.publishare-delta-tree"],["qt","video/quicktime"],["qtc","video/x-qtc"],["qti","image/x-quicktime"],["qtif","image/x-quicktime"],["qxd","application/vnd.quark.quarkxpress"],["ra",["audio/x-realaudio","audio/x-pn-realaudio","audio/x-pn-realaudio-plugin"]],["ram","audio/x-pn-realaudio"],["rar","application/x-rar-compressed"],["ras",["image/cmu-raster","application/x-cmu-raster","image/x-cmu-raster"]],["rast","image/cmu-raster"],["rcprofile","application/vnd.ipunplugged.rcprofile"],["rdf","application/rdf+xml"],["rdz","application/vnd.data-vision.rdz"],["rep","application/vnd.businessobjects"],["res","application/x-dtbresource+xml"],["rexx","text/x-script.rexx"],["rf","image/vnd.rn-realflash"],["rgb","image/x-rgb"],["rif","application/reginfo+xml"],["rip","audio/vnd.rip"],["rl","application/resource-lists+xml"],["rlc","image/vnd.fujixerox.edmics-rlc"],["rld","application/resource-lists-diff+xml"],["rm",["application/vnd.rn-realmedia","audio/x-pn-realaudio"]],["rmi","audio/mid"],["rmm","audio/x-pn-realaudio"],["rmp",["audio/x-pn-realaudio-plugin","audio/x-pn-realaudio"]],["rms","application/vnd.jcp.javame.midlet-rms"],["rnc","application/relax-ng-compact-syntax"],["rng",["application/ringing-tones","application/vnd.nokia.ringing-tone"]],["rnx","application/vnd.rn-realplayer"],["roff","application/x-troff"],["rp","image/vnd.rn-realpix"],["rp9","application/vnd.cloanto.rp9"],["rpm","audio/x-pn-realaudio-plugin"],["rpss","application/vnd.nokia.radio-presets"],["rpst","application/vnd.nokia.radio-preset"],["rq","application/sparql-query"],["rs","application/rls-services+xml"],["rsd","application/rsd+xml"],["rt",["text/richtext","text/vnd.rn-realtext"]],["rtf",["application/rtf","text/richtext","application/x-rtf"]],["rtx",["text/richtext","application/rtf"]],["rv","video/vnd.rn-realvideo"],["s","text/x-asm"],["s3m","audio/s3m"],["saf","application/vnd.yamaha.smaf-audio"],["saveme","application/octet-stream"],["sbk","application/x-tbook"],["sbml","application/sbml+xml"],["sc","application/vnd.ibm.secure-container"],["scd","application/x-msschedule"],["scm",["application/vnd.lotus-screencam","video/x-scm","text/x-script.guile","application/x-lotusscreencam","text/x-script.scheme"]],["scq","application/scvp-cv-request"],["scs","application/scvp-cv-response"],["sct","text/scriptlet"],["scurl","text/vnd.curl.scurl"],["sda","application/vnd.stardivision.draw"],["sdc","application/vnd.stardivision.calc"],["sdd","application/vnd.stardivision.impress"],["sdkm","application/vnd.solent.sdkm+xml"],["sdml","text/plain"],["sdp",["application/sdp","application/x-sdp"]],["sdr","application/sounder"],["sdw","application/vnd.stardivision.writer"],["sea",["application/sea","application/x-sea"]],["see","application/vnd.seemail"],["seed","application/vnd.fdsn.seed"],["sema","application/vnd.sema"],["semd","application/vnd.semd"],["semf","application/vnd.semf"],["ser","application/java-serialized-object"],["set","application/set"],["setpay","application/set-payment-initiation"],["setreg","application/set-registration-initiation"],["sfd-hdstx","application/vnd.hydrostatix.sof-data"],["sfs","application/vnd.spotfire.sfs"],["sgl","application/vnd.stardivision.writer-global"],["sgm",["text/sgml","text/x-sgml"]],["sgml",["text/sgml","text/x-sgml"]],["sh",["application/x-shar","application/x-bsh","application/x-sh","text/x-script.sh"]],["shar",["application/x-bsh","application/x-shar"]],["shf","application/shf+xml"],["shtml",["text/html","text/x-server-parsed-html"]],["sid","audio/x-psid"],["sis","application/vnd.symbian.install"],["sit",["application/x-stuffit","application/x-sit"]],["sitx","application/x-stuffitx"],["skd","application/x-koan"],["skm","application/x-koan"],["skp",["application/vnd.koan","application/x-koan"]],["skt","application/x-koan"],["sl","application/x-seelogo"],["sldm","application/vnd.ms-powerpoint.slide.macroenabled.12"],["sldx","application/vnd.openxmlformats-officedocument.presentationml.slide"],["slt","application/vnd.epson.salt"],["sm","application/vnd.stepmania.stepchart"],["smf","application/vnd.stardivision.math"],["smi",["application/smil","application/smil+xml"]],["smil","application/smil"],["snd",["audio/basic","audio/x-adpcm"]],["snf","application/x-font-snf"],["sol","application/solids"],["spc",["text/x-speech","application/x-pkcs7-certificates"]],["spf","application/vnd.yamaha.smaf-phrase"],["spl",["application/futuresplash","application/x-futuresplash"]],["spot","text/vnd.in3d.spot"],["spp","application/scvp-vp-response"],["spq","application/scvp-vp-request"],["spr","application/x-sprite"],["sprite","application/x-sprite"],["src","application/x-wais-source"],["sru","application/sru+xml"],["srx","application/sparql-results+xml"],["sse","application/vnd.kodak-descriptor"],["ssf","application/vnd.epson.ssf"],["ssi","text/x-server-parsed-html"],["ssm","application/streamingmedia"],["ssml","application/ssml+xml"],["sst",["application/vnd.ms-pkicertstore","application/vnd.ms-pki.certstore"]],["st","application/vnd.sailingtracker.track"],["stc","application/vnd.sun.xml.calc.template"],["std","application/vnd.sun.xml.draw.template"],["step","application/step"],["stf","application/vnd.wt.stf"],["sti","application/vnd.sun.xml.impress.template"],["stk","application/hyperstudio"],["stl",["application/vnd.ms-pkistl","application/sla","application/vnd.ms-pki.stl","application/x-navistyle"]],["stm","text/html"],["stp","application/step"],["str","application/vnd.pg.format"],["stw","application/vnd.sun.xml.writer.template"],["sub","image/vnd.dvb.subtitle"],["sus","application/vnd.sus-calendar"],["sv4cpio","application/x-sv4cpio"],["sv4crc","application/x-sv4crc"],["svc","application/vnd.dvb.service"],["svd","application/vnd.svd"],["svf",["image/vnd.dwg","image/x-dwg"]],["svg","image/svg+xml"],["svr",["x-world/x-svr","application/x-world"]],["swf","application/x-shockwave-flash"],["swi","application/vnd.aristanetworks.swi"],["sxc","application/vnd.sun.xml.calc"],["sxd","application/vnd.sun.xml.draw"],["sxg","application/vnd.sun.xml.writer.global"],["sxi","application/vnd.sun.xml.impress"],["sxm","application/vnd.sun.xml.math"],["sxw","application/vnd.sun.xml.writer"],["t",["text/troff","application/x-troff"]],["talk","text/x-speech"],["tao","application/vnd.tao.intent-module-archive"],["tar","application/x-tar"],["tbk",["application/toolbook","application/x-tbook"]],["tcap","application/vnd.3gpp2.tcap"],["tcl",["text/x-script.tcl","application/x-tcl"]],["tcsh","text/x-script.tcsh"],["teacher","application/vnd.smart.teacher"],["tei","application/tei+xml"],["tex","application/x-tex"],["texi","application/x-texinfo"],["texinfo","application/x-texinfo"],["text",["application/plain","text/plain"]],["tfi","application/thraud+xml"],["tfm","application/x-tex-tfm"],["tgz",["application/gnutar","application/x-compressed"]],["thmx","application/vnd.ms-officetheme"],["tif",["image/tiff","image/x-tiff"]],["tiff",["image/tiff","image/x-tiff"]],["tmo","application/vnd.tmobile-livetv"],["torrent","application/x-bittorrent"],["tpl","application/vnd.groove-tool-template"],["tpt","application/vnd.trid.tpt"],["tr","application/x-troff"],["tra","application/vnd.trueapp"],["trm","application/x-msterminal"],["tsd","application/timestamped-data"],["tsi","audio/tsp-audio"],["tsp",["application/dsptype","audio/tsplayer"]],["tsv","text/tab-separated-values"],["ttf","application/x-font-ttf"],["ttl","text/turtle"],["turbot","image/florian"],["twd","application/vnd.simtech-mindmapper"],["txd","application/vnd.genomatix.tuxedo"],["txf","application/vnd.mobius.txf"],["txt","text/plain"],["ufd","application/vnd.ufdl"],["uil","text/x-uil"],["uls","text/iuls"],["umj","application/vnd.umajin"],["uni","text/uri-list"],["unis","text/uri-list"],["unityweb","application/vnd.unity"],["unv","application/i-deas"],["uoml","application/vnd.uoml+xml"],["uri","text/uri-list"],["uris","text/uri-list"],["ustar",["application/x-ustar","multipart/x-ustar"]],["utz","application/vnd.uiq.theme"],["uu",["application/octet-stream","text/x-uuencode"]],["uue","text/x-uuencode"],["uva","audio/vnd.dece.audio"],["uvh","video/vnd.dece.hd"],["uvi","image/vnd.dece.graphic"],["uvm","video/vnd.dece.mobile"],["uvp","video/vnd.dece.pd"],["uvs","video/vnd.dece.sd"],["uvu","video/vnd.uvvu.mp4"],["uvv","video/vnd.dece.video"],["vcd","application/x-cdlink"],["vcf","text/x-vcard"],["vcg","application/vnd.groove-vcard"],["vcs","text/x-vcalendar"],["vcx","application/vnd.vcx"],["vda","application/vda"],["vdo","video/vdo"],["vew","application/groupwise"],["vis","application/vnd.visionary"],["viv",["video/vivo","video/vnd.vivo"]],["vivo",["video/vivo","video/vnd.vivo"]],["vmd","application/vocaltec-media-desc"],["vmf","application/vocaltec-media-file"],["voc",["audio/voc","audio/x-voc"]],["vos","video/vosaic"],["vox","audio/voxware"],["vqe","audio/x-twinvq-plugin"],["vqf","audio/x-twinvq"],["vql","audio/x-twinvq-plugin"],["vrml",["model/vrml","x-world/x-vrml","application/x-vrml"]],["vrt","x-world/x-vrt"],["vsd",["application/vnd.visio","application/x-visio"]],["vsf","application/vnd.vsf"],["vst","application/x-visio"],["vsw","application/x-visio"],["vtu","model/vnd.vtu"],["vxml","application/voicexml+xml"],["w60","application/wordperfect6.0"],["w61","application/wordperfect6.1"],["w6w","application/msword"],["wad","application/x-doom"],["wav",["audio/wav","audio/x-wav"]],["wax","audio/x-ms-wax"],["wb1","application/x-qpro"],["wbmp","image/vnd.wap.wbmp"],["wbs","application/vnd.criticaltools.wbs+xml"],["wbxml","application/vnd.wap.wbxml"],["wcm","application/vnd.ms-works"],["wdb","application/vnd.ms-works"],["web","application/vnd.xara"],["weba","audio/webm"],["webm","video/webm"],["webp","image/webp"],["wg","application/vnd.pmi.widget"],["wgt","application/widget"],["wiz","application/msword"],["wk1","application/x-123"],["wks","application/vnd.ms-works"],["wm","video/x-ms-wm"],["wma","audio/x-ms-wma"],["wmd","application/x-ms-wmd"],["wmf",["windows/metafile","application/x-msmetafile"]],["wml","text/vnd.wap.wml"],["wmlc","application/vnd.wap.wmlc"],["wmls","text/vnd.wap.wmlscript"],["wmlsc","application/vnd.wap.wmlscriptc"],["wmv","video/x-ms-wmv"],["wmx","video/x-ms-wmx"],["wmz","application/x-ms-wmz"],["woff","application/x-font-woff"],["word","application/msword"],["wp","application/wordperfect"],["wp5",["application/wordperfect","application/wordperfect6.0"]],["wp6","application/wordperfect"],["wpd",["application/wordperfect","application/vnd.wordperfect","application/x-wpwin"]],["wpl","application/vnd.ms-wpl"],["wps","application/vnd.ms-works"],["wq1","application/x-lotus"],["wqd","application/vnd.wqd"],["wri",["application/mswrite","application/x-wri","application/x-mswrite"]],["wrl",["model/vrml","x-world/x-vrml","application/x-world"]],["wrz",["model/vrml","x-world/x-vrml"]],["wsc","text/scriplet"],["wsdl","application/wsdl+xml"],["wspolicy","application/wspolicy+xml"],["wsrc","application/x-wais-source"],["wtb","application/vnd.webturbo"],["wtk","application/x-wintalk"],["wvx","video/x-ms-wvx"],["x-png","image/png"],["x3d","application/vnd.hzn-3d-crossword"],["xaf","x-world/x-vrml"],["xap","application/x-silverlight-app"],["xar","application/vnd.xara"],["xbap","application/x-ms-xbap"],["xbd","application/vnd.fujixerox.docuworks.binder"],["xbm",["image/xbm","image/x-xbm","image/x-xbitmap"]],["xdf","application/xcap-diff+xml"],["xdm","application/vnd.syncml.dm+xml"],["xdp","application/vnd.adobe.xdp+xml"],["xdr","video/x-amt-demorun"],["xdssc","application/dssc+xml"],["xdw","application/vnd.fujixerox.docuworks"],["xenc","application/xenc+xml"],["xer","application/patch-ops-error+xml"],["xfdf","application/vnd.adobe.xfdf"],["xfdl","application/vnd.xfdl"],["xgz","xgl/drawing"],["xhtml","application/xhtml+xml"],["xif","image/vnd.xiff"],["xl","application/excel"],["xla",["application/vnd.ms-excel","application/excel","application/x-msexcel","application/x-excel"]],["xlam","application/vnd.ms-excel.addin.macroenabled.12"],["xlb",["application/excel","application/vnd.ms-excel","application/x-excel"]],["xlc",["application/vnd.ms-excel","application/excel","application/x-excel"]],["xld",["application/excel","application/x-excel"]],["xlk",["application/excel","application/x-excel"]],["xll",["application/excel","application/vnd.ms-excel","application/x-excel"]],["xlm",["application/vnd.ms-excel","application/excel","application/x-excel"]],["xls",["application/vnd.ms-excel","application/excel","application/x-msexcel","application/x-excel"]],["xlsb","application/vnd.ms-excel.sheet.binary.macroenabled.12"],["xlsm","application/vnd.ms-excel.sheet.macroenabled.12"],["xlsx","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"],["xlt",["application/vnd.ms-excel","application/excel","application/x-excel"]],["xltm","application/vnd.ms-excel.template.macroenabled.12"],["xltx","application/vnd.openxmlformats-officedocument.spreadsheetml.template"],["xlv",["application/excel","application/x-excel"]],["xlw",["application/vnd.ms-excel","application/excel","application/x-msexcel","application/x-excel"]],["xm","audio/xm"],["xml",["application/xml","text/xml","application/atom+xml","application/rss+xml"]],["xmz","xgl/movie"],["xo","application/vnd.olpc-sugar"],["xof","x-world/x-vrml"],["xop","application/xop+xml"],["xpi","application/x-xpinstall"],["xpix","application/x-vnd.ls-xpix"],["xpm",["image/xpm","image/x-xpixmap"]],["xpr","application/vnd.is-xpr"],["xps","application/vnd.ms-xpsdocument"],["xpw","application/vnd.intercon.formnet"],["xslt","application/xslt+xml"],["xsm","application/vnd.syncml+xml"],["xspf","application/xspf+xml"],["xsr","video/x-amt-showrun"],["xul","application/vnd.mozilla.xul+xml"],["xwd",["image/x-xwd","image/x-xwindowdump"]],["xyz",["chemical/x-xyz","chemical/x-pdb"]],["yang","application/yang"],["yin","application/yin+xml"],["z",["application/x-compressed","application/x-compress"]],["zaz","application/vnd.zzazz.deck+xml"],["zip",["application/zip","multipart/x-zip","application/x-zip-compressed","application/x-compressed"]],["zir","application/vnd.zul"],["zmm","application/vnd.handheld-entertainment+xml"],["zoo","application/octet-stream"],["zsh","text/x-script.zsh"]]);module.exports={detectMimeType(filename){if(!filename)return"application/octet-stream";let parsed=path.parse(filename),extension=(parsed.ext.substr(1)||parsed.name||"").split("?").shift().trim().toLowerCase(),value="application/octet-stream";if(extensions.has(extension))value=extensions.get(extension);if(Array.isArray(value))return value[0];return value},detectExtension(mimeType){if(!mimeType)return"bin";let parts=(mimeType||"").toLowerCase().trim().split("/"),rootType=parts.shift().trim(),subType=parts.join("/").trim();if(mimeTypes.has(rootType+"/"+subType)){let value=mimeTypes.get(rootType+"/"+subType);if(Array.isArray(value))return value[0];return value}switch(rootType){case"text":return"txt";default:return"bin"}}}});var require_punycode=__commonJS((exports,module)=>{var regexPunycode=/^xn--/,regexNonASCII=/[^\0-\x7F]/,regexSeparators=/[\x2E\u3002\uFF0E\uFF61]/g,errors={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},floor=Math.floor,stringFromCharCode=String.fromCharCode;function error2(type2){throw new RangeError(errors[type2])}function map3(array,callback){let result=[],length=array.length;while(length--)result[length]=callback(array[length]);return result}function mapDomain(domain,callback){let parts=domain.split("@"),result="";if(parts.length>1)result=parts[0]+"@",domain=parts[1];domain=domain.replace(regexSeparators,".");let labels=domain.split("."),encoded=map3(labels,callback).join(".");return result+encoded}function ucs2decode(string){let output=[],counter=0,length=string.length;while(counter<length){let value=string.charCodeAt(counter++);if(value>=55296&&value<=56319&&counter<length){let extra=string.charCodeAt(counter++);if((extra&64512)==56320)output.push(((value&1023)<<10)+(extra&1023)+65536);else output.push(value),counter--}else output.push(value)}return output}var ucs2encode=(codePoints)=>String.fromCodePoint(...codePoints),basicToDigit=function(codePoint){if(codePoint>=48&&codePoint<58)return 26+(codePoint-48);if(codePoint>=65&&codePoint<91)return codePoint-65;if(codePoint>=97&&codePoint<123)return codePoint-97;return 36},digitToBasic=function(digit,flag){return digit+22+75*(digit<26)-((flag!=0)<<5)},adapt=function(delta2,numPoints,firstTime){let k2=0;delta2=firstTime?floor(delta2/700):delta2>>1,delta2+=floor(delta2/numPoints);for(;delta2>455;k2+=36)delta2=floor(delta2/35);return floor(k2+36*delta2/(delta2+38))},decode3=function(input){let output=[],inputLength=input.length,i=0,n=128,bias=72,basic=input.lastIndexOf("-");if(basic<0)basic=0;for(let j=0;j<basic;++j){if(input.charCodeAt(j)>=128)error2("not-basic");output.push(input.charCodeAt(j))}for(let index2=basic>0?basic+1:0;index2<inputLength;){let oldi=i;for(let w=1,k2=36;;k2+=36){if(index2>=inputLength)error2("invalid-input");let digit=basicToDigit(input.charCodeAt(index2++));if(digit>=36)error2("invalid-input");if(digit>floor((2147483647-i)/w))error2("overflow");i+=digit*w;let t2=k2<=bias?1:k2>=bias+26?26:k2-bias;if(digit<t2)break;let baseMinusT=36-t2;if(w>floor(2147483647/baseMinusT))error2("overflow");w*=baseMinusT}let out=output.length+1;if(bias=adapt(i-oldi,out,oldi==0),floor(i/out)>2147483647-n)error2("overflow");n+=floor(i/out),i%=out,output.splice(i++,0,n)}return String.fromCodePoint(...output)},encode2=function(input){let output=[];input=ucs2decode(input);let inputLength=input.length,n=128,delta2=0,bias=72;for(let currentValue of input)if(currentValue<128)output.push(stringFromCharCode(currentValue));let basicLength=output.length,handledCPCount=basicLength;if(basicLength)output.push("-");while(handledCPCount<inputLength){let m=2147483647;for(let currentValue of input)if(currentValue>=n&&currentValue<m)m=currentValue;let handledCPCountPlusOne=handledCPCount+1;if(m-n>floor((2147483647-delta2)/handledCPCountPlusOne))error2("overflow");delta2+=(m-n)*handledCPCountPlusOne,n=m;for(let currentValue of input){if(currentValue<n&&++delta2>2147483647)error2("overflow");if(currentValue===n){let q=delta2;for(let k2=36;;k2+=36){let t2=k2<=bias?1:k2>=bias+26?26:k2-bias;if(q<t2)break;let qMinusT=q-t2,baseMinusT=36-t2;output.push(stringFromCharCode(digitToBasic(t2+qMinusT%baseMinusT,0))),q=floor(qMinusT/baseMinusT)}output.push(stringFromCharCode(digitToBasic(q,0))),bias=adapt(delta2,handledCPCountPlusOne,handledCPCount===basicLength),delta2=0,++handledCPCount}}++delta2,++n}return output.join("")},toUnicode=function(input){return mapDomain(input,function(string){return regexPunycode.test(string)?decode3(string.slice(4).toLowerCase()):string})},toASCII=function(input){return mapDomain(input,function(string){return regexNonASCII.test(string)?"xn--"+encode2(string):string})},punycode={version:"2.3.1",ucs2:{decode:ucs2decode,encode:ucs2encode},decode:decode3,encode:encode2,toASCII,toUnicode};module.exports=punycode});var require_base64=__commonJS((exports,module)=>{var Transform2=__require("stream").Transform;function encode2(buffer2){if(typeof buffer2==="string")buffer2=Buffer.from(buffer2,"utf-8");return buffer2.toString("base64")}function wrap(str,lineLength){if(str=(str||"").toString(),lineLength=lineLength||76,str.length<=lineLength)return str;let result=[],pos=0,chunkLength=lineLength*1024;while(pos<str.length){let wrappedLines=str.substr(pos,chunkLength).replace(new RegExp(".{"+lineLength+"}","g"),`$&\r
`).trim();result.push(wrappedLines),pos+=chunkLength}return result.join(`\r
`).trim()}class Encoder extends Transform2{constructor(options){super();if(this.options=options||{},this.options.lineLength!==!1)this.options.lineLength=this.options.lineLength||76;this._curLine="",this._remainingBytes=!1,this.inputBytes=0,this.outputBytes=0}_transform(chunk,encoding,done){if(encoding!=="buffer")chunk=Buffer.from(chunk,encoding);if(!chunk||!chunk.length)return setImmediate(done);if(this.inputBytes+=chunk.length,this._remainingBytes&&this._remainingBytes.length)chunk=Buffer.concat([this._remainingBytes,chunk],this._remainingBytes.length+chunk.length),this._remainingBytes=!1;if(chunk.length%3)this._remainingBytes=chunk.slice(chunk.length-chunk.length%3),chunk=chunk.slice(0,chunk.length-chunk.length%3);else this._remainingBytes=!1;let b64=this._curLine+encode2(chunk);if(this.options.lineLength){b64=wrap(b64,this.options.lineLength);let lastLF=b64.lastIndexOf(`
`);if(lastLF<0)this._curLine=b64,b64="";else if(lastLF===b64.length-1)this._curLine="";else this._curLine=b64.substr(lastLF+1),b64=b64.substr(0,lastLF+1)}if(b64)this.outputBytes+=b64.length,this.push(Buffer.from(b64,"ascii"));setImmediate(done)}_flush(done){if(this._remainingBytes&&this._remainingBytes.length)this._curLine+=encode2(this._remainingBytes);if(this._curLine)this._curLine=wrap(this._curLine,this.options.lineLength),this.outputBytes+=this._curLine.length,this.push(this._curLine,"ascii"),this._curLine="";done()}}module.exports={encode:encode2,wrap,Encoder}});var require_qp=__commonJS((exports,module)=>{var Transform2=__require("stream").Transform;function encode2(buffer2){if(typeof buffer2==="string")buffer2=Buffer.from(buffer2,"utf-8");let ranges=[[9],[10],[13],[32,60],[62,126]],result="",ord;for(let i=0,len=buffer2.length;i<len;i++){if(ord=buffer2[i],checkRanges(ord,ranges)&&!((ord===32||ord===9)&&(i===len-1||buffer2[i+1]===10||buffer2[i+1]===13))){result+=String.fromCharCode(ord);continue}result+="="+(ord<16?"0":"")+ord.toString(16).toUpperCase()}return result}function wrap(str,lineLength){if(str=(str||"").toString(),lineLength=lineLength||76,str.length<=lineLength)return str;let pos=0,len=str.length,match,code,line2,lineMargin=Math.floor(lineLength/3),result="";while(pos<len){if(line2=str.substr(pos,lineLength),match=line2.match(/\r\n/)){line2=line2.substr(0,match.index+match[0].length),result+=line2,pos+=line2.length;continue}if(line2.substr(-1)===`
`){result+=line2,pos+=line2.length;continue}else if(match=line2.substr(-lineMargin).match(/\n.*?$/)){line2=line2.substr(0,line2.length-(match[0].length-1)),result+=line2,pos+=line2.length;continue}else if(line2.length>lineLength-lineMargin&&(match=line2.substr(-lineMargin).match(/[ \t.,!?][^ \t.,!?]*$/)))line2=line2.substr(0,line2.length-(match[0].length-1));else if(line2.match(/[=][\da-f]{0,2}$/i)){if(match=line2.match(/[=][\da-f]{0,1}$/i))line2=line2.substr(0,line2.length-match[0].length);while(line2.length>3&&line2.length<len-pos&&!line2.match(/^(?:=[\da-f]{2}){1,4}$/i)&&(match=line2.match(/[=][\da-f]{2}$/gi))){if(code=parseInt(match[0].substr(1,2),16),code<128)break;if(line2=line2.substr(0,line2.length-3),code>=192)break}}if(pos+line2.length<len&&line2.substr(-1)!==`
`){if(line2.length===lineLength&&line2.match(/[=][\da-f]{2}$/i))line2=line2.substr(0,line2.length-3);else if(line2.length===lineLength)line2=line2.substr(0,line2.length-1);pos+=line2.length,line2+=`=\r
`}else pos+=line2.length;result+=line2}return result}function checkRanges(nr,ranges){for(let i=ranges.length-1;i>=0;i--){if(!ranges[i].length)continue;if(ranges[i].length===1&&nr===ranges[i][0])return!0;if(ranges[i].length===2&&nr>=ranges[i][0]&&nr<=ranges[i][1])return!0}return!1}class Encoder extends Transform2{constructor(options){super();if(this.options=options||{},this.options.lineLength!==!1)this.options.lineLength=this.options.lineLength||76;this._curLine="",this.inputBytes=0,this.outputBytes=0}_transform(chunk,encoding,done){let qp;if(encoding!=="buffer")chunk=Buffer.from(chunk,encoding);if(!chunk||!chunk.length)return done();if(this.inputBytes+=chunk.length,this.options.lineLength){if(qp=this._curLine+encode2(chunk),qp=wrap(qp,this.options.lineLength),qp=qp.replace(/(^|\n)([^\n]*)$/,(match,lineBreak,lastLine)=>{return this._curLine=lastLine,lineBreak}),qp)this.outputBytes+=qp.length,this.push(qp)}else qp=encode2(chunk),this.outputBytes+=qp.length,this.push(qp,"ascii");done()}_flush(done){if(this._curLine)this.outputBytes+=this._curLine.length,this.push(this._curLine,"ascii");done()}}module.exports={encode:encode2,wrap,Encoder}});var require_mime_funcs=__commonJS((exports,module)=>{var base64=require_base64(),qp=require_qp(),mimeTypes=require_mime_types();module.exports={isPlainText(value,isParam){if(typeof value!=="string"||(isParam?/[\x00-\x08\x0b\x0c\x0e-\x1f"\u0080-\uFFFF]/:/[\x00-\x08\x0b\x0c\x0e-\x1f\u0080-\uFFFF]/).test(value))return!1;else return!0},hasLongerLines(str,lineLength){if(str.length>131072)return!0;return new RegExp("^.{"+(lineLength+1)+",}","m").test(str)},encodeWord(data,mimeWordEncoding,maxLength){mimeWordEncoding=(mimeWordEncoding||"Q").toString().toUpperCase().trim().charAt(0),maxLength=maxLength||0;let encodedStr,toCharset="UTF-8";if(maxLength&&maxLength>7+toCharset.length)maxLength-=7+toCharset.length;if(mimeWordEncoding==="Q")encodedStr=qp.encode(data).replace(/[^a-z0-9!*+\-/=]/gi,(chr)=>{let ord=chr.charCodeAt(0).toString(16).toUpperCase();if(chr===" ")return"_";else return"="+(ord.length===1?"0"+ord:ord)});else if(mimeWordEncoding==="B")encodedStr=typeof data==="string"?data:base64.encode(data),maxLength=maxLength?Math.max(3,(maxLength-maxLength%4)/4*3):0;if(maxLength&&(mimeWordEncoding!=="B"?encodedStr:base64.encode(data)).length>maxLength)if(mimeWordEncoding==="Q")encodedStr=this.splitMimeEncodedString(encodedStr,maxLength).join("?= =?"+toCharset+"?"+mimeWordEncoding+"?");else{let parts=[],lpart="";for(let i=0,len=encodedStr.length;i<len;i++){let chr=encodedStr.charAt(i);if(/[\ud83c\ud83d\ud83e]/.test(chr)&&i<len-1)chr+=encodedStr.charAt(++i);if(Buffer.byteLength(lpart+chr)<=maxLength||i===0)lpart+=chr;else parts.push(base64.encode(lpart)),lpart=chr}if(lpart)parts.push(base64.encode(lpart));if(parts.length>1)encodedStr=parts.join("?= =?"+toCharset+"?"+mimeWordEncoding+"?");else encodedStr=parts.join("")}else if(mimeWordEncoding==="B")encodedStr=base64.encode(data);return"=?"+toCharset+"?"+mimeWordEncoding+"?"+encodedStr+(encodedStr.substr(-2)==="?="?"":"?=")},encodeWords(value,mimeWordEncoding,maxLength,encodeAll){maxLength=maxLength||0;let encodedValue,firstMatch=value.match(/(?:^|\s)([^\s]*["\u0080-\uFFFF])/);if(!firstMatch)return value;if(encodeAll)return this.encodeWord(value,mimeWordEncoding,maxLength);let lastMatch=value.match(/(["\u0080-\uFFFF][^\s]*)[^"\u0080-\uFFFF]*$/);if(!lastMatch)return value;let startIndex=firstMatch.index+(firstMatch[0].match(/[^\s]/)||{index:0}).index,endIndex=lastMatch.index+(lastMatch[1]||"").length;return encodedValue=(startIndex?value.substr(0,startIndex):"")+this.encodeWord(value.substring(startIndex,endIndex),mimeWordEncoding||"Q",maxLength)+(endIndex<value.length?value.substr(endIndex):""),encodedValue},buildHeaderValue(structured){let paramsArray=[];return Object.keys(structured.params||{}).forEach((param)=>{let value=structured.params[param];if(!this.isPlainText(value,!0)||value.length>=75)this.buildHeaderParam(param,value,50).forEach((encodedParam)=>{if(!/[\s"\\;:/=(),<>@[\]?]|^[-']|'$/.test(encodedParam.value)||encodedParam.key.substr(-1)==="*")paramsArray.push(encodedParam.key+"="+encodedParam.value);else paramsArray.push(encodedParam.key+"="+JSON.stringify(encodedParam.value))});else if(/[\s'"\\;:/=(),<>@[\]?]|^-/.test(value))paramsArray.push(param+"="+JSON.stringify(value));else paramsArray.push(param+"="+value)}),structured.value+(paramsArray.length?"; "+paramsArray.join("; "):"")},buildHeaderParam(key,data,maxLength){let list=[],encodedStr=typeof data==="string"?data:(data||"").toString(),encodedStrArr,chr,ord,line2,startPos=0,i,len;if(maxLength=maxLength||50,this.isPlainText(data,!0)){if(encodedStr.length<=maxLength)return[{key,value:encodedStr}];if(encodedStr=encodedStr.replace(new RegExp(".{"+maxLength+"}","g"),(str)=>{return list.push({line:str}),""}),encodedStr)list.push({line:encodedStr})}else{if(/[\uD800-\uDBFF]/.test(encodedStr)){encodedStrArr=[];for(i=0,len=encodedStr.length;i<len;i++)if(chr=encodedStr.charAt(i),ord=chr.charCodeAt(0),ord>=55296&&ord<=56319&&i<len-1)chr+=encodedStr.charAt(i+1),encodedStrArr.push(chr),i++;else encodedStrArr.push(chr);encodedStr=encodedStrArr}line2="utf-8''";let encoded=!0;startPos=0;for(i=0,len=encodedStr.length;i<len;i++){if(chr=encodedStr[i],encoded)chr=this.safeEncodeURIComponent(chr);else if(chr=chr===" "?chr:this.safeEncodeURIComponent(chr),chr!==encodedStr[i])if((this.safeEncodeURIComponent(line2)+chr).length>=maxLength)list.push({line:line2,encoded}),line2="",startPos=i-1;else{encoded=!0,i=startPos,line2="";continue}if((line2+chr).length>=maxLength)if(list.push({line:line2,encoded}),line2=chr=encodedStr[i]===" "?" ":this.safeEncodeURIComponent(encodedStr[i]),chr===encodedStr[i])encoded=!1,startPos=i-1;else encoded=!0;else line2+=chr}if(line2)list.push({line:line2,encoded})}return list.map((item,i2)=>({key:key+"*"+i2+(item.encoded?"*":""),value:item.line}))},parseHeaderValue(str){let response={value:!1,params:{}},key=!1,value="",type2="value",quote=!1,escaped=!1,chr;for(let i=0,len=str.length;i<len;i++)if(chr=str.charAt(i),type2==="key"){if(chr==="="){key=value.trim().toLowerCase(),type2="value",value="";continue}value+=chr}else{if(escaped)value+=chr;else if(chr==="\\"){escaped=!0;continue}else if(quote&&chr===quote)quote=!1;else if(!quote&&chr==='"')quote=chr;else if(!quote&&chr===";"){if(key===!1)response.value=value.trim();else response.params[key]=value.trim();type2="key",value=""}else value+=chr;escaped=!1}if(type2==="value")if(key===!1)response.value=value.trim();else response.params[key]=value.trim();else if(value.trim())response.params[value.trim().toLowerCase()]="";return Object.keys(response.params).forEach((key2)=>{let actualKey,nr,match,value2;if(match=key2.match(/(\*(\d+)|\*(\d+)\*|\*)$/)){if(actualKey=key2.substr(0,match.index),nr=Number(match[2]||match[3])||0,!response.params[actualKey]||typeof response.params[actualKey]!=="object")response.params[actualKey]={charset:!1,values:[]};if(value2=response.params[key2],nr===0&&match[0].substr(-1)==="*"&&(match=value2.match(/^([^']*)'[^']*'(.*)$/)))response.params[actualKey].charset=match[1]||"iso-8859-1",value2=match[2];response.params[actualKey].values[nr]=value2,delete response.params[key2]}}),Object.keys(response.params).forEach((key2)=>{let value2;if(response.params[key2]&&Array.isArray(response.params[key2].values))if(value2=response.params[key2].values.map((val)=>val||"").join(""),response.params[key2].charset)response.params[key2]="=?"+response.params[key2].charset+"?Q?"+value2.replace(/[=?_\s]/g,(s)=>{let c=s.charCodeAt(0).toString(16);if(s===" ")return"_";else return"%"+(c.length<2?"0":"")+c}).replace(/%/g,"=")+"?=";else response.params[key2]=value2}),response},detectExtension:(mimeType)=>mimeTypes.detectExtension(mimeType),detectMimeType:(extension)=>mimeTypes.detectMimeType(extension),foldLines(str,lineLength,afterSpace){str=(str||"").toString(),lineLength=lineLength||76;let pos=0,len=str.length,result="",line2,match;while(pos<len){if(line2=str.substr(pos,lineLength),line2.length<lineLength){result+=line2;break}if(match=line2.match(/^[^\n\r]*(\r?\n|\r)/)){line2=match[0],result+=line2,pos+=line2.length;continue}else if((match=line2.match(/(\s+)[^\s]*$/))&&match[0].length-(afterSpace?(match[1]||"").length:0)<line2.length)line2=line2.substr(0,line2.length-(match[0].length-(afterSpace?(match[1]||"").length:0)));else if(match=str.substr(pos+line2.length).match(/^[^\s]+(\s*)/))line2=line2+match[0].substr(0,match[0].length-(!afterSpace?(match[1]||"").length:0));if(result+=line2,pos+=line2.length,pos<len)result+=`\r
`}return result},splitMimeEncodedString:(str,maxlen)=>{let curLine,match,chr,done,lines=[];maxlen=Math.max(maxlen||0,12);while(str.length){if(curLine=str.substr(0,maxlen),match=curLine.match(/[=][0-9A-F]?$/i))curLine=curLine.substr(0,match.index);done=!1;while(!done)if(done=!0,match=str.substr(curLine.length).match(/^[=]([0-9A-F]{2})/i)){if(chr=parseInt(match[1],16),chr<194&&chr>127)curLine=curLine.substr(0,curLine.length-3),done=!1}if(curLine.length)lines.push(curLine);str=str.substr(curLine.length)}return lines},encodeURICharComponent:(chr)=>{let res="",ord=chr.charCodeAt(0).toString(16).toUpperCase();if(ord.length%2)ord="0"+ord;if(ord.length>2)for(let i=0,len=ord.length/2;i<len;i++)res+="%"+ord.substr(i,2);else res+="%"+ord;return res},safeEncodeURIComponent(str){str=(str||"").toString();try{str=encodeURIComponent(str)}catch(E){return str.replace(/[^\x00-\x1F *'()<>@,;:\\"[\]?=\u007F-\uFFFF]+/g,"")}return str.replace(/[\x00-\x1F *'()<>@,;:\\"[\]?=\u007F-\uFFFF]/g,(chr)=>this.encodeURICharComponent(chr))}}});var require_addressparser=__commonJS((exports,module)=>{function _handleAddress(tokens){let isGroup=!1,state="text",address,addresses=[],data={address:[],comment:[],group:[],text:[]},i,len;for(i=0,len=tokens.length;i<len;i++){let token=tokens[i],prevToken=i?tokens[i-1]:null;if(token.type==="operator")switch(token.value){case"<":state="address";break;case"(":state="comment";break;case":":state="group",isGroup=!0;break;default:state="text";break}else if(token.value){if(state==="address")token.value=token.value.replace(/^[^<]*<\s*/,"");if(prevToken&&prevToken.noBreak&&data[state].length)data[state][data[state].length-1]+=token.value;else data[state].push(token.value)}}if(!data.text.length&&data.comment.length)data.text=data.comment,data.comment=[];if(isGroup)data.text=data.text.join(" "),addresses.push({name:data.text||address&&address.name,group:data.group.length?addressparser(data.group.join(",")):[]});else{if(!data.address.length&&data.text.length){for(i=data.text.length-1;i>=0;i--)if(data.text[i].match(/^[^@\s]+@[^@\s]+$/)){data.address=data.text.splice(i,1);break}let _regexHandler=function(address2){if(!data.address.length)return data.address=[address2.trim()]," ";else return address2};if(!data.address.length){for(i=data.text.length-1;i>=0;i--)if(data.text[i]=data.text[i].replace(/\s*\b[^@\s]+@[^\s]+\b\s*/,_regexHandler).trim(),data.address.length)break}}if(!data.text.length&&data.comment.length)data.text=data.comment,data.comment=[];if(data.address.length>1)data.text=data.text.concat(data.address.splice(1));if(data.text=data.text.join(" "),data.address=data.address.join(" "),!data.address&&isGroup)return[];else{if(address={address:data.address||data.text||"",name:data.text||data.address||""},address.address===address.name)if((address.address||"").match(/@/))address.name="";else address.address="";addresses.push(address)}}return addresses}class Tokenizer{constructor(str){this.str=(str||"").toString(),this.operatorCurrent="",this.operatorExpecting="",this.node=null,this.escaped=!1,this.list=[],this.operators={'"':'"',"(":")","<":">",",":"",":":";",";":""}}tokenize(){let list=[];for(let i=0,len=this.str.length;i<len;i++){let chr=this.str.charAt(i),nextChr=i<len-1?this.str.charAt(i+1):null;this.checkChar(chr,nextChr)}return this.list.forEach((node)=>{if(node.value=(node.value||"").toString().trim(),node.value)list.push(node)}),list}checkChar(chr,nextChr){if(this.escaped);else if(chr===this.operatorExpecting){if(this.node={type:"operator",value:chr},nextChr&&![" ","\t","\r",`
`,",",";"].includes(nextChr))this.node.noBreak=!0;this.list.push(this.node),this.node=null,this.operatorExpecting="",this.escaped=!1;return}else if(!this.operatorExpecting&&chr in this.operators){this.node={type:"operator",value:chr},this.list.push(this.node),this.node=null,this.operatorExpecting=this.operators[chr],this.escaped=!1;return}else if(['"',"'"].includes(this.operatorExpecting)&&chr==="\\"){this.escaped=!0;return}if(!this.node)this.node={type:"text",value:""},this.list.push(this.node);if(chr===`
`)chr=" ";if(chr.charCodeAt(0)>=33||[" ","\t"].includes(chr))this.node.value+=chr;this.escaped=!1}}function addressparser(str,options){options=options||{};let tokens=new Tokenizer(str).tokenize(),addresses=[],address=[],parsedAddresses=[];if(tokens.forEach((token)=>{if(token.type==="operator"&&(token.value===","||token.value===";")){if(address.length)addresses.push(address);address=[]}else address.push(token)}),address.length)addresses.push(address);if(addresses.forEach((address2)=>{if(address2=_handleAddress(address2),address2.length)parsedAddresses=parsedAddresses.concat(address2)}),options.flatten){let addresses2=[],walkAddressList=(list)=>{list.forEach((address2)=>{if(address2.group)return walkAddressList(address2.group);else addresses2.push(address2)})};return walkAddressList(parsedAddresses),addresses2}return parsedAddresses}module.exports=addressparser});var require_last_newline=__commonJS((exports,module)=>{var Transform2=__require("stream").Transform;class LastNewline extends Transform2{constructor(){super();this.lastByte=!1}_transform(chunk,encoding,done){if(chunk.length)this.lastByte=chunk[chunk.length-1];this.push(chunk),done()}_flush(done){if(this.lastByte===10)return done();if(this.lastByte===13)return this.push(Buffer.from(`
`)),done();return this.push(Buffer.from(`\r
`)),done()}}module.exports=LastNewline});var require_le_windows=__commonJS((exports,module)=>{var stream=__require("stream"),Transform2=stream.Transform;class LeWindows extends Transform2{constructor(options){super(options);this.options=options||{},this.lastByte=!1}_transform(chunk,encoding,done){let buf,lastPos=0;for(let i=0,len=chunk.length;i<len;i++)if(chunk[i]===10){if(i&&chunk[i-1]!==13||!i&&this.lastByte!==13){if(i>lastPos)buf=chunk.slice(lastPos,i),this.push(buf);this.push(Buffer.from(`\r
`)),lastPos=i+1}}if(lastPos&&lastPos<chunk.length)buf=chunk.slice(lastPos),this.push(buf);else if(!lastPos)this.push(chunk);this.lastByte=chunk[chunk.length-1],done()}}module.exports=LeWindows});var require_le_unix=__commonJS((exports,module)=>{var stream=__require("stream"),Transform2=stream.Transform;class LeWindows extends Transform2{constructor(options){super(options);this.options=options||{}}_transform(chunk,encoding,done){let buf,lastPos=0;for(let i=0,len=chunk.length;i<len;i++)if(chunk[i]===13)buf=chunk.slice(lastPos,i),lastPos=i+1,this.push(buf);if(lastPos&&lastPos<chunk.length)buf=chunk.slice(lastPos),this.push(buf);else if(!lastPos)this.push(chunk);done()}}module.exports=LeWindows});var require_mime_node=__commonJS((exports,module)=>{var crypto3=__require("crypto"),fs2=__require("fs"),punycode=require_punycode(),PassThrough=__require("stream").PassThrough,shared=require_shared(),mimeFuncs=require_mime_funcs(),qp=require_qp(),base64=require_base64(),addressparser=require_addressparser(),nmfetch=require_fetch(),LastNewline=require_last_newline(),LeWindows=require_le_windows(),LeUnix=require_le_unix();class MimeNode{constructor(contentType,options){if(this.nodeCounter=0,options=options||{},this.baseBoundary=options.baseBoundary||crypto3.randomBytes(8).toString("hex"),this.boundaryPrefix=options.boundaryPrefix||"--_NmP",this.disableFileAccess=!!options.disableFileAccess,this.disableUrlAccess=!!options.disableUrlAccess,this.normalizeHeaderKey=options.normalizeHeaderKey,this.date=new Date,this.rootNode=options.rootNode||this,this.keepBcc=!!options.keepBcc,options.filename){if(this.filename=options.filename,!contentType)contentType=mimeFuncs.detectMimeType(this.filename.split(".").pop())}if(this.textEncoding=(options.textEncoding||"").toString().trim().charAt(0).toUpperCase(),this.parentNode=options.parentNode,this.hostname=options.hostname,this.newline=options.newline,this.childNodes=[],this._nodeId=++this.rootNode.nodeCounter,this._headers=[],this._isPlainText=!1,this._hasLongLines=!1,this._envelope=!1,this._raw=!1,this._transforms=[],this._processFuncs=[],contentType)this.setHeader("Content-Type",contentType)}createChild(contentType,options){if(!options&&typeof contentType==="object")options=contentType,contentType=void 0;let node=new MimeNode(contentType,options);return this.appendChild(node),node}appendChild(childNode){if(childNode.rootNode!==this.rootNode)childNode.rootNode=this.rootNode,childNode._nodeId=++this.rootNode.nodeCounter;return childNode.parentNode=this,this.childNodes.push(childNode),childNode}replace(node){if(node===this)return this;return this.parentNode.childNodes.forEach((childNode,i)=>{if(childNode===this)node.rootNode=this.rootNode,node.parentNode=this.parentNode,node._nodeId=this._nodeId,this.rootNode=this,this.parentNode=void 0,node.parentNode.childNodes[i]=node}),node}remove(){if(!this.parentNode)return this;for(let i=this.parentNode.childNodes.length-1;i>=0;i--)if(this.parentNode.childNodes[i]===this)return this.parentNode.childNodes.splice(i,1),this.parentNode=void 0,this.rootNode=this,this}setHeader(key,value){let added=!1,headerValue;if(!value&&key&&typeof key==="object"){if(key.key&&"value"in key)this.setHeader(key.key,key.value);else if(Array.isArray(key))key.forEach((i)=>{this.setHeader(i.key,i.value)});else Object.keys(key).forEach((i)=>{this.setHeader(i,key[i])});return this}key=this._normalizeHeaderKey(key),headerValue={key,value};for(let i=0,len=this._headers.length;i<len;i++)if(this._headers[i].key===key)if(!added)this._headers[i]=headerValue,added=!0;else this._headers.splice(i,1),i--,len--;if(!added)this._headers.push(headerValue);return this}addHeader(key,value){if(!value&&key&&typeof key==="object"){if(key.key&&key.value)this.addHeader(key.key,key.value);else if(Array.isArray(key))key.forEach((i)=>{this.addHeader(i.key,i.value)});else Object.keys(key).forEach((i)=>{this.addHeader(i,key[i])});return this}else if(Array.isArray(value))return value.forEach((val)=>{this.addHeader(key,val)}),this;return this._headers.push({key:this._normalizeHeaderKey(key),value}),this}getHeader(key){key=this._normalizeHeaderKey(key);for(let i=0,len=this._headers.length;i<len;i++)if(this._headers[i].key===key)return this._headers[i].value}setContent(content){if(this.content=content,typeof this.content.pipe==="function")this._contentErrorHandler=(err)=>{this.content.removeListener("error",this._contentErrorHandler),this.content=err},this.content.once("error",this._contentErrorHandler);else if(typeof this.content==="string"){if(this._isPlainText=mimeFuncs.isPlainText(this.content),this._isPlainText&&mimeFuncs.hasLongerLines(this.content,76))this._hasLongLines=!0}return this}build(callback){let promise;if(!callback)promise=new Promise((resolve,reject)=>{callback=shared.callbackPromise(resolve,reject)});let stream=this.createReadStream(),buf=[],buflen=0,returned=!1;return stream.on("readable",()=>{let chunk;while((chunk=stream.read())!==null)buf.push(chunk),buflen+=chunk.length}),stream.once("error",(err)=>{if(returned)return;return returned=!0,callback(err)}),stream.once("end",(chunk)=>{if(returned)return;if(returned=!0,chunk&&chunk.length)buf.push(chunk),buflen+=chunk.length;return callback(null,Buffer.concat(buf,buflen))}),promise}getTransferEncoding(){let transferEncoding=!1,contentType=(this.getHeader("Content-Type")||"").toString().toLowerCase().trim();if(this.content){if(transferEncoding=(this.getHeader("Content-Transfer-Encoding")||"").toString().toLowerCase().trim(),!transferEncoding||!["base64","quoted-printable"].includes(transferEncoding)){if(/^text\//i.test(contentType))if(this._isPlainText&&!this._hasLongLines)transferEncoding="7bit";else if(typeof this.content==="string"||this.content instanceof Buffer)transferEncoding=this._getTextEncoding(this.content)==="Q"?"quoted-printable":"base64";else transferEncoding=this.textEncoding==="B"?"base64":"quoted-printable";else if(!/^(multipart|message)\//i.test(contentType))transferEncoding=transferEncoding||"base64"}}return transferEncoding}buildHeaders(){let transferEncoding=this.getTransferEncoding(),headers=[];if(transferEncoding)this.setHeader("Content-Transfer-Encoding",transferEncoding);if(this.filename&&!this.getHeader("Content-Disposition"))this.setHeader("Content-Disposition","attachment");if(this.rootNode===this){if(!this.getHeader("Date"))this.setHeader("Date",this.date.toUTCString().replace(/GMT/,"+0000"));if(this.messageId(),!this.getHeader("MIME-Version"))this.setHeader("MIME-Version","1.0");for(let i=this._headers.length-2;i>=0;i--){let header=this._headers[i];if(header.key==="Content-Type")this._headers.splice(i,1),this._headers.push(header)}}return this._headers.forEach((header)=>{let{key,value}=header,structured,param,options={};if(value&&typeof value==="object"&&!["From","Sender","To","Cc","Bcc","Reply-To","Date","References"].includes(key)){if(Object.keys(value).forEach((key2)=>{if(key2!=="value")options[key2]=value[key2]}),value=(value.value||"").toString(),!value.trim())return}if(options.prepared){if(options.foldLines)headers.push(mimeFuncs.foldLines(key+": "+value));else headers.push(key+": "+value);return}switch(header.key){case"Content-Disposition":if(structured=mimeFuncs.parseHeaderValue(value),this.filename)structured.params.filename=this.filename;value=mimeFuncs.buildHeaderValue(structured);break;case"Content-Type":if(structured=mimeFuncs.parseHeaderValue(value),this._handleContentType(structured),structured.value.match(/^text\/plain\b/)&&typeof this.content==="string"&&/[\u0080-\uFFFF]/.test(this.content))structured.params.charset="utf-8";if(value=mimeFuncs.buildHeaderValue(structured),this.filename){if(param=this._encodeWords(this.filename),param!==this.filename||/[\s'"\\;:/=(),<>@[\]?]|^-/.test(param))param='"'+param+'"';value+="; name="+param}break;case"Bcc":if(!this.keepBcc)return;break}if(value=this._encodeHeaderValue(key,value),!(value||"").toString().trim())return;if(typeof this.normalizeHeaderKey==="function"){let normalized=this.normalizeHeaderKey(key,value);if(normalized&&typeof normalized==="string"&&normalized.length)key=normalized}headers.push(mimeFuncs.foldLines(key+": "+value,76))}),headers.join(`\r
`)}createReadStream(options){options=options||{};let stream=new PassThrough(options),outputStream=stream,transform2;this.stream(stream,options,(err)=>{if(err){outputStream.emit("error",err);return}stream.end()});for(let i=0,len=this._transforms.length;i<len;i++)transform2=typeof this._transforms[i]==="function"?this._transforms[i]():this._transforms[i],outputStream.once("error",(err)=>{transform2.emit("error",err)}),outputStream=outputStream.pipe(transform2);transform2=new LastNewline,outputStream.once("error",(err)=>{transform2.emit("error",err)}),outputStream=outputStream.pipe(transform2);for(let i=0,len=this._processFuncs.length;i<len;i++)transform2=this._processFuncs[i],outputStream=transform2(outputStream);if(this.newline){let newlineTransform=["win","windows","dos",`\r
`].includes(this.newline.toString().toLowerCase())?new LeWindows:new LeUnix,stream2=outputStream.pipe(newlineTransform);return outputStream.on("error",(err)=>stream2.emit("error",err)),stream2}return outputStream}transform(transform2){this._transforms.push(transform2)}processFunc(processFunc){this._processFuncs.push(processFunc)}stream(outputStream,options,done){let transferEncoding=this.getTransferEncoding(),contentStream,localStream,returned=!1,callback=(err)=>{if(returned)return;returned=!0,done(err)},finalize=()=>{let childId=0,processChildNode=()=>{if(childId>=this.childNodes.length)return outputStream.write(`\r
--`+this.boundary+`--\r
`),callback();let child=this.childNodes[childId++];outputStream.write((childId>1?`\r
`:"")+"--"+this.boundary+`\r
`),child.stream(outputStream,options,(err)=>{if(err)return callback(err);setImmediate(processChildNode)})};if(this.multipart)setImmediate(processChildNode);else return callback()},sendContent=()=>{if(this.content){if(Object.prototype.toString.call(this.content)==="[object Error]")return callback(this.content);if(typeof this.content.pipe==="function")this.content.removeListener("error",this._contentErrorHandler),this._contentErrorHandler=(err)=>callback(err),this.content.once("error",this._contentErrorHandler);let createStream=()=>{if(["quoted-printable","base64"].includes(transferEncoding))contentStream=new(transferEncoding==="base64"?base64:qp).Encoder(options),contentStream.pipe(outputStream,{end:!1}),contentStream.once("end",finalize),contentStream.once("error",(err)=>callback(err)),localStream=this._getStream(this.content),localStream.pipe(contentStream);else localStream=this._getStream(this.content),localStream.pipe(outputStream,{end:!1}),localStream.once("end",finalize);localStream.once("error",(err)=>callback(err))};if(this.content._resolve){let chunks=[],chunklen=0,returned2=!1,sourceStream=this._getStream(this.content);sourceStream.on("error",(err)=>{if(returned2)return;returned2=!0,callback(err)}),sourceStream.on("readable",()=>{let chunk;while((chunk=sourceStream.read())!==null)chunks.push(chunk),chunklen+=chunk.length}),sourceStream.on("end",()=>{if(returned2)return;returned2=!0,this.content._resolve=!1,this.content._resolvedValue=Buffer.concat(chunks,chunklen),setImmediate(createStream)})}else setImmediate(createStream);return}else return setImmediate(finalize)};if(this._raw)setImmediate(()=>{if(Object.prototype.toString.call(this._raw)==="[object Error]")return callback(this._raw);if(typeof this._raw.pipe==="function")this._raw.removeListener("error",this._contentErrorHandler);let raw=this._getStream(this._raw);raw.pipe(outputStream,{end:!1}),raw.on("error",(err)=>outputStream.emit("error",err)),raw.on("end",finalize)});else outputStream.write(this.buildHeaders()+`\r
\r
`),setImmediate(sendContent)}setEnvelope(envelope){let list;if(this._envelope={from:!1,to:[]},envelope.from){if(list=[],this._convertAddresses(this._parseAddresses(envelope.from),list),list=list.filter((address)=>address&&address.address),list.length&&list[0])this._envelope.from=list[0].address}["to","cc","bcc"].forEach((key)=>{if(envelope[key])this._convertAddresses(this._parseAddresses(envelope[key]),this._envelope.to)}),this._envelope.to=this._envelope.to.map((to)=>to.address).filter((address)=>address);let standardFields=["to","cc","bcc","from"];return Object.keys(envelope).forEach((key)=>{if(!standardFields.includes(key))this._envelope[key]=envelope[key]}),this}getAddresses(){let addresses={};return this._headers.forEach((header)=>{let key=header.key.toLowerCase();if(["from","sender","reply-to","to","cc","bcc"].includes(key)){if(!Array.isArray(addresses[key]))addresses[key]=[];this._convertAddresses(this._parseAddresses(header.value),addresses[key])}}),addresses}getEnvelope(){if(this._envelope)return this._envelope;let envelope={from:!1,to:[]};return this._headers.forEach((header)=>{let list=[];if(header.key==="From"||!envelope.from&&["Reply-To","Sender"].includes(header.key)){if(this._convertAddresses(this._parseAddresses(header.value),list),list.length&&list[0])envelope.from=list[0].address}else if(["To","Cc","Bcc"].includes(header.key))this._convertAddresses(this._parseAddresses(header.value),envelope.to)}),envelope.to=envelope.to.map((to)=>to.address),envelope}messageId(){let messageId=this.getHeader("Message-ID");if(!messageId)messageId=this._generateMessageId(),this.setHeader("Message-ID",messageId);return messageId}setRaw(raw){if(this._raw=raw,this._raw&&typeof this._raw.pipe==="function")this._contentErrorHandler=(err)=>{this._raw.removeListener("error",this._contentErrorHandler),this._raw=err},this._raw.once("error",this._contentErrorHandler);return this}_getStream(content){let contentStream;if(content._resolvedValue)return contentStream=new PassThrough,setImmediate(()=>{try{contentStream.end(content._resolvedValue)}catch(err){contentStream.emit("error",err)}}),contentStream;else if(typeof content.pipe==="function")return content;else if(content&&typeof content.path==="string"&&!content.href){if(this.disableFileAccess)return contentStream=new PassThrough,setImmediate(()=>contentStream.emit("error",new Error("File access rejected for "+content.path))),contentStream;return fs2.createReadStream(content.path)}else if(content&&typeof content.href==="string"){if(this.disableUrlAccess)return contentStream=new PassThrough,setImmediate(()=>contentStream.emit("error",new Error("Url access rejected for "+content.href))),contentStream;return nmfetch(content.href,{headers:content.httpHeaders})}else return contentStream=new PassThrough,setImmediate(()=>{try{contentStream.end(content||"")}catch(err){contentStream.emit("error",err)}}),contentStream}_parseAddresses(addresses){return[].concat.apply([],[].concat(addresses).map((address)=>{if(address&&address.address)return address.address=this._normalizeAddress(address.address),address.name=address.name||"",[address];return addressparser(address)}))}_normalizeHeaderKey(key){return key=(key||"").toString().replace(/\r?\n|\r/g," ").trim().toLowerCase().replace(/^X-SMTPAPI$|^(MIME|DKIM|ARC|BIMI)\b|^[a-z]|-(SPF|FBL|ID|MD5)$|-[a-z]/gi,(c)=>c.toUpperCase()).replace(/^Content-Features$/i,"Content-features"),key}_handleContentType(structured){if(this.contentType=structured.value.trim().toLowerCase(),this.multipart=/^multipart\//i.test(this.contentType)?this.contentType.substr(this.contentType.indexOf("/")+1):!1,this.multipart)this.boundary=structured.params.boundary=structured.params.boundary||this.boundary||this._generateBoundary();else this.boundary=!1}_generateBoundary(){return this.rootNode.boundaryPrefix+"-"+this.rootNode.baseBoundary+"-Part_"+this._nodeId}_encodeHeaderValue(key,value){switch(key=this._normalizeHeaderKey(key),key){case"From":case"Sender":case"To":case"Cc":case"Bcc":case"Reply-To":return this._convertAddresses(this._parseAddresses(value));case"Message-ID":case"In-Reply-To":case"Content-Id":if(value=(value||"").toString().replace(/\r?\n|\r/g," "),value.charAt(0)!=="<")value="<"+value;if(value.charAt(value.length-1)!==">")value=value+">";return value;case"References":return value=[].concat.apply([],[].concat(value||"").map((elm)=>{return elm=(elm||"").toString().replace(/\r?\n|\r/g," ").trim(),elm.replace(/<[^>]*>/g,(str)=>str.replace(/\s/g,"")).split(/\s+/)})).map((elm)=>{if(elm.charAt(0)!=="<")elm="<"+elm;if(elm.charAt(elm.length-1)!==">")elm=elm+">";return elm}),value.join(" ").trim();case"Date":if(Object.prototype.toString.call(value)==="[object Date]")return value.toUTCString().replace(/GMT/,"+0000");return value=(value||"").toString().replace(/\r?\n|\r/g," "),this._encodeWords(value);case"Content-Type":case"Content-Disposition":return(value||"").toString().replace(/\r?\n|\r/g," ");default:return value=(value||"").toString().replace(/\r?\n|\r/g," "),this._encodeWords(value)}}_convertAddresses(addresses,uniqueList){let values2=[];return uniqueList=uniqueList||[],[].concat(addresses||[]).forEach((address)=>{if(address.address){if(address.address=this._normalizeAddress(address.address),!address.name)values2.push(address.address.indexOf(" ")>=0?`<${address.address}>`:`${address.address}`);else if(address.name)values2.push(`${this._encodeAddressName(address.name)} <${address.address}>`);if(address.address){if(!uniqueList.filter((a)=>a.address===address.address).length)uniqueList.push(address)}}else if(address.group){let groupListAddresses=(address.group.length?this._convertAddresses(address.group,uniqueList):"").trim();values2.push(`${this._encodeAddressName(address.name)}:${groupListAddresses};`)}}),values2.join(", ")}_normalizeAddress(address){address=(address||"").toString().replace(/[\x00-\x1F<>]+/g," ").trim();let lastAt=address.lastIndexOf("@");if(lastAt<0)return address;let user=address.substr(0,lastAt),domain=address.substr(lastAt+1),encodedDomain;try{encodedDomain=punycode.toASCII(domain.toLowerCase())}catch(err){}if(user.indexOf(" ")>=0){if(user.charAt(0)!=='"')user='"'+user;if(user.substr(-1)!=='"')user=user+'"'}return`${user}@${encodedDomain}`}_encodeAddressName(name){if(!/^[\w ]*$/.test(name))if(/^[\x20-\x7e]*$/.test(name))return'"'+name.replace(/([\\"])/g,"\\$1")+'"';else return mimeFuncs.encodeWord(name,this._getTextEncoding(name),52);return name}_encodeWords(value){return mimeFuncs.encodeWords(value,this._getTextEncoding(value),52,!0)}_getTextEncoding(value){value=(value||"").toString();let encoding=this.textEncoding,latinLen,nonLatinLen;if(!encoding)nonLatinLen=(value.match(/[\x00-\x08\x0B\x0C\x0E-\x1F\u0080-\uFFFF]/g)||[]).length,latinLen=(value.match(/[a-z]/gi)||[]).length,encoding=nonLatinLen<latinLen?"Q":"B";return encoding}_generateMessageId(){return"<"+[2,2,2,6].reduce((prev,len)=>prev+"-"+crypto3.randomBytes(len).toString("hex"),crypto3.randomBytes(4).toString("hex"))+"@"+(this.getEnvelope().from||this.hostname||"localhost").split("@").pop()+">"}}module.exports=MimeNode});var require_mail_composer=__commonJS((exports,module)=>{var MimeNode=require_mime_node(),mimeFuncs=require_mime_funcs(),parseDataURI=require_shared().parseDataURI;class MailComposer{constructor(mail){this.mail=mail||{},this.message=!1}compile(){if(this._alternatives=this.getAlternatives(),this._htmlNode=this._alternatives.filter((alternative)=>/^text\/html\b/i.test(alternative.contentType)).pop(),this._attachments=this.getAttachments(!!this._htmlNode),this._useRelated=!!(this._htmlNode&&this._attachments.related.length),this._useAlternative=this._alternatives.length>1,this._useMixed=this._attachments.attached.length>1||this._alternatives.length&&this._attachments.attached.length===1,this.mail.raw)this.message=new MimeNode("message/rfc822",{newline:this.mail.newline}).setRaw(this.mail.raw);else if(this._useMixed)this.message=this._createMixed();else if(this._useAlternative)this.message=this._createAlternative();else if(this._useRelated)this.message=this._createRelated();else this.message=this._createContentNode(!1,[].concat(this._alternatives||[]).concat(this._attachments.attached||[]).shift()||{contentType:"text/plain",content:""});if(this.mail.headers)this.message.addHeader(this.mail.headers);if(["from","sender","to","cc","bcc","reply-to","in-reply-to","references","subject","message-id","date"].forEach((header)=>{let key=header.replace(/-(\w)/g,(o,c)=>c.toUpperCase());if(this.mail[key])this.message.setHeader(header,this.mail[key])}),this.mail.envelope)this.message.setEnvelope(this.mail.envelope);return this.message.messageId(),this.message}getAttachments(findRelated){let icalEvent,eventObject,attachments=[].concat(this.mail.attachments||[]).map((attachment,i)=>{let data,isMessageNode=/^message\//i.test(attachment.contentType);if(/^data:/i.test(attachment.path||attachment.href))attachment=this._processDataUrl(attachment);let contentType=attachment.contentType||mimeFuncs.detectMimeType(attachment.filename||attachment.path||attachment.href||"bin"),isImage=/^image\//i.test(contentType),contentDisposition=attachment.contentDisposition||(isMessageNode||isImage&&attachment.cid?"inline":"attachment");if(data={contentType,contentDisposition,contentTransferEncoding:"contentTransferEncoding"in attachment?attachment.contentTransferEncoding:"base64"},attachment.filename)data.filename=attachment.filename;else if(!isMessageNode&&attachment.filename!==!1){if(data.filename=(attachment.path||attachment.href||"").split("/").pop().split("?").shift()||"attachment-"+(i+1),data.filename.indexOf(".")<0)data.filename+="."+mimeFuncs.detectExtension(data.contentType)}if(/^https?:\/\//i.test(attachment.path))attachment.href=attachment.path,attachment.path=void 0;if(attachment.cid)data.cid=attachment.cid;if(attachment.raw)data.raw=attachment.raw;else if(attachment.path)data.content={path:attachment.path};else if(attachment.href)data.content={href:attachment.href,httpHeaders:attachment.httpHeaders};else data.content=attachment.content||"";if(attachment.encoding)data.encoding=attachment.encoding;if(attachment.headers)data.headers=attachment.headers;return data});if(this.mail.icalEvent){if(typeof this.mail.icalEvent==="object"&&(this.mail.icalEvent.content||this.mail.icalEvent.path||this.mail.icalEvent.href||this.mail.icalEvent.raw))icalEvent=this.mail.icalEvent;else icalEvent={content:this.mail.icalEvent};if(eventObject={},Object.keys(icalEvent).forEach((key)=>{eventObject[key]=icalEvent[key]}),eventObject.contentType="application/ics",!eventObject.headers)eventObject.headers={};eventObject.filename=eventObject.filename||"invite.ics",eventObject.headers["Content-Disposition"]="attachment",eventObject.headers["Content-Transfer-Encoding"]="base64"}if(!findRelated)return{attached:attachments.concat(eventObject||[]),related:[]};else return{attached:attachments.filter((attachment)=>!attachment.cid).concat(eventObject||[]),related:attachments.filter((attachment)=>!!attachment.cid)}}getAlternatives(){let alternatives=[],text2,html,watchHtml,amp,icalEvent,eventObject;if(this.mail.text){if(typeof this.mail.text==="object"&&(this.mail.text.content||this.mail.text.path||this.mail.text.href||this.mail.text.raw))text2=this.mail.text;else text2={content:this.mail.text};text2.contentType="text/plain; charset=utf-8"}if(this.mail.watchHtml){if(typeof this.mail.watchHtml==="object"&&(this.mail.watchHtml.content||this.mail.watchHtml.path||this.mail.watchHtml.href||this.mail.watchHtml.raw))watchHtml=this.mail.watchHtml;else watchHtml={content:this.mail.watchHtml};watchHtml.contentType="text/watch-html; charset=utf-8"}if(this.mail.amp){if(typeof this.mail.amp==="object"&&(this.mail.amp.content||this.mail.amp.path||this.mail.amp.href||this.mail.amp.raw))amp=this.mail.amp;else amp={content:this.mail.amp};amp.contentType="text/x-amp-html; charset=utf-8"}if(this.mail.icalEvent){if(typeof this.mail.icalEvent==="object"&&(this.mail.icalEvent.content||this.mail.icalEvent.path||this.mail.icalEvent.href||this.mail.icalEvent.raw))icalEvent=this.mail.icalEvent;else icalEvent={content:this.mail.icalEvent};if(eventObject={},Object.keys(icalEvent).forEach((key)=>{eventObject[key]=icalEvent[key]}),eventObject.content&&typeof eventObject.content==="object")eventObject.content._resolve=!0;if(eventObject.filename=!1,eventObject.contentType="text/calendar; charset=utf-8; method="+(eventObject.method||"PUBLISH").toString().trim().toUpperCase(),!eventObject.headers)eventObject.headers={}}if(this.mail.html){if(typeof this.mail.html==="object"&&(this.mail.html.content||this.mail.html.path||this.mail.html.href||this.mail.html.raw))html=this.mail.html;else html={content:this.mail.html};html.contentType="text/html; charset=utf-8"}return[].concat(text2||[]).concat(watchHtml||[]).concat(amp||[]).concat(html||[]).concat(eventObject||[]).concat(this.mail.alternatives||[]).forEach((alternative)=>{let data;if(/^data:/i.test(alternative.path||alternative.href))alternative=this._processDataUrl(alternative);if(data={contentType:alternative.contentType||mimeFuncs.detectMimeType(alternative.filename||alternative.path||alternative.href||"txt"),contentTransferEncoding:alternative.contentTransferEncoding},alternative.filename)data.filename=alternative.filename;if(/^https?:\/\//i.test(alternative.path))alternative.href=alternative.path,alternative.path=void 0;if(alternative.raw)data.raw=alternative.raw;else if(alternative.path)data.content={path:alternative.path};else if(alternative.href)data.content={href:alternative.href};else data.content=alternative.content||"";if(alternative.encoding)data.encoding=alternative.encoding;if(alternative.headers)data.headers=alternative.headers;alternatives.push(data)}),alternatives}_createMixed(parentNode){let node;if(!parentNode)node=new MimeNode("multipart/mixed",{baseBoundary:this.mail.baseBoundary,textEncoding:this.mail.textEncoding,boundaryPrefix:this.mail.boundaryPrefix,disableUrlAccess:this.mail.disableUrlAccess,disableFileAccess:this.mail.disableFileAccess,normalizeHeaderKey:this.mail.normalizeHeaderKey,newline:this.mail.newline});else node=parentNode.createChild("multipart/mixed",{disableUrlAccess:this.mail.disableUrlAccess,disableFileAccess:this.mail.disableFileAccess,normalizeHeaderKey:this.mail.normalizeHeaderKey,newline:this.mail.newline});if(this._useAlternative)this._createAlternative(node);else if(this._useRelated)this._createRelated(node);return[].concat(!this._useAlternative&&this._alternatives||[]).concat(this._attachments.attached||[]).forEach((element)=>{if(!this._useRelated||element!==this._htmlNode)this._createContentNode(node,element)}),node}_createAlternative(parentNode){let node;if(!parentNode)node=new MimeNode("multipart/alternative",{baseBoundary:this.mail.baseBoundary,textEncoding:this.mail.textEncoding,boundaryPrefix:this.mail.boundaryPrefix,disableUrlAccess:this.mail.disableUrlAccess,disableFileAccess:this.mail.disableFileAccess,normalizeHeaderKey:this.mail.normalizeHeaderKey,newline:this.mail.newline});else node=parentNode.createChild("multipart/alternative",{disableUrlAccess:this.mail.disableUrlAccess,disableFileAccess:this.mail.disableFileAccess,normalizeHeaderKey:this.mail.normalizeHeaderKey,newline:this.mail.newline});return this._alternatives.forEach((alternative)=>{if(this._useRelated&&this._htmlNode===alternative)this._createRelated(node);else this._createContentNode(node,alternative)}),node}_createRelated(parentNode){let node;if(!parentNode)node=new MimeNode('multipart/related; type="text/html"',{baseBoundary:this.mail.baseBoundary,textEncoding:this.mail.textEncoding,boundaryPrefix:this.mail.boundaryPrefix,disableUrlAccess:this.mail.disableUrlAccess,disableFileAccess:this.mail.disableFileAccess,normalizeHeaderKey:this.mail.normalizeHeaderKey,newline:this.mail.newline});else node=parentNode.createChild('multipart/related; type="text/html"',{disableUrlAccess:this.mail.disableUrlAccess,disableFileAccess:this.mail.disableFileAccess,normalizeHeaderKey:this.mail.normalizeHeaderKey,newline:this.mail.newline});return this._createContentNode(node,this._htmlNode),this._attachments.related.forEach((alternative)=>this._createContentNode(node,alternative)),node}_createContentNode(parentNode,element){element=element||{},element.content=element.content||"";let node,encoding=(element.encoding||"utf8").toString().toLowerCase().replace(/[-_\s]/g,"");if(!parentNode)node=new MimeNode(element.contentType,{filename:element.filename,baseBoundary:this.mail.baseBoundary,textEncoding:this.mail.textEncoding,boundaryPrefix:this.mail.boundaryPrefix,disableUrlAccess:this.mail.disableUrlAccess,disableFileAccess:this.mail.disableFileAccess,normalizeHeaderKey:this.mail.normalizeHeaderKey,newline:this.mail.newline});else node=parentNode.createChild(element.contentType,{filename:element.filename,textEncoding:this.mail.textEncoding,disableUrlAccess:this.mail.disableUrlAccess,disableFileAccess:this.mail.disableFileAccess,normalizeHeaderKey:this.mail.normalizeHeaderKey,newline:this.mail.newline});if(element.headers)node.addHeader(element.headers);if(element.cid)node.setHeader("Content-Id","<"+element.cid.replace(/[<>]/g,"")+">");if(element.contentTransferEncoding)node.setHeader("Content-Transfer-Encoding",element.contentTransferEncoding);else if(this.mail.encoding&&/^text\//i.test(element.contentType))node.setHeader("Content-Transfer-Encoding",this.mail.encoding);if(!/^text\//i.test(element.contentType)||element.contentDisposition)node.setHeader("Content-Disposition",element.contentDisposition||(element.cid&&/^image\//i.test(element.contentType)?"inline":"attachment"));if(typeof element.content==="string"&&!["utf8","usascii","ascii"].includes(encoding))element.content=Buffer.from(element.content,encoding);if(element.raw)node.setRaw(element.raw);else node.setContent(element.content);return node}_processDataUrl(element){let parsedDataUri;if((element.path||element.href).match(/^data:/))parsedDataUri=parseDataURI(element.path||element.href);if(!parsedDataUri)return element;if(element.content=parsedDataUri.data,element.contentType=element.contentType||parsedDataUri.contentType,"path"in element)element.path=!1;if("href"in element)element.href=!1;return element}}module.exports=MailComposer});var require_message_parser=__commonJS((exports,module)=>{var Transform2=__require("stream").Transform;class MessageParser extends Transform2{constructor(options){super(options);this.lastBytes=Buffer.alloc(4),this.headersParsed=!1,this.headerBytes=0,this.headerChunks=[],this.rawHeaders=!1,this.bodySize=0}updateLastBytes(data){let lblen=this.lastBytes.length,nblen=Math.min(data.length,lblen);for(let i=0,len=lblen-nblen;i<len;i++)this.lastBytes[i]=this.lastBytes[i+nblen];for(let i=1;i<=nblen;i++)this.lastBytes[lblen-i]=data[data.length-i]}checkHeaders(data){if(this.headersParsed)return!0;let lblen=this.lastBytes.length,headerPos=0;this.curLinePos=0;for(let i=0,len=this.lastBytes.length+data.length;i<len;i++){let chr;if(i<lblen)chr=this.lastBytes[i];else chr=data[i-lblen];if(chr===10&&i){let pr1=i-1<lblen?this.lastBytes[i-1]:data[i-1-lblen],pr2=i>1?i-2<lblen?this.lastBytes[i-2]:data[i-2-lblen]:!1;if(pr1===10){this.headersParsed=!0,headerPos=i-lblen+1,this.headerBytes+=headerPos;break}else if(pr1===13&&pr2===10){this.headersParsed=!0,headerPos=i-lblen+1,this.headerBytes+=headerPos;break}}}if(this.headersParsed){if(this.headerChunks.push(data.slice(0,headerPos)),this.rawHeaders=Buffer.concat(this.headerChunks,this.headerBytes),this.headerChunks=null,this.emit("headers",this.parseHeaders()),data.length-1>headerPos){let chunk=data.slice(headerPos);this.bodySize+=chunk.length,setImmediate(()=>this.push(chunk))}return!1}else this.headerBytes+=data.length,this.headerChunks.push(data);return this.updateLastBytes(data),!1}_transform(chunk,encoding,callback){if(!chunk||!chunk.length)return callback();if(typeof chunk==="string")chunk=Buffer.from(chunk,encoding);let headersFound;try{headersFound=this.checkHeaders(chunk)}catch(E){return callback(E)}if(headersFound)this.bodySize+=chunk.length,this.push(chunk);setImmediate(callback)}_flush(callback){if(this.headerChunks){let chunk=Buffer.concat(this.headerChunks,this.headerBytes);this.bodySize+=chunk.length,this.push(chunk),this.headerChunks=null}callback()}parseHeaders(){let lines=(this.rawHeaders||"").toString().split(/\r?\n/);for(let i=lines.length-1;i>0;i--)if(/^\s/.test(lines[i]))lines[i-1]+=`
`+lines[i],lines.splice(i,1);return lines.filter((line2)=>line2.trim()).map((line2)=>({key:line2.substr(0,line2.indexOf(":")).trim().toLowerCase(),line:line2}))}}module.exports=MessageParser});var require_relaxed_body=__commonJS((exports,module)=>{var Transform2=__require("stream").Transform,crypto3=__require("crypto");class RelaxedBody extends Transform2{constructor(options){super();options=options||{},this.chunkBuffer=[],this.chunkBufferLen=0,this.bodyHash=crypto3.createHash(options.hashAlgo||"sha1"),this.remainder="",this.byteLength=0,this.debug=options.debug,this._debugBody=options.debug?[]:!1}updateHash(chunk){let bodyStr,nextRemainder="",state="file";for(let i=chunk.length-1;i>=0;i--){let c=chunk[i];if(state==="file"&&(c===10||c===13));else if(state==="file"&&(c===9||c===32))state="line";else if(state==="line"&&(c===9||c===32));else if(state==="file"||state==="line"){if(state="body",i===chunk.length-1)break}if(i===0){if(state==="file"&&(!this.remainder||/[\r\n]$/.test(this.remainder))||state==="line"&&(!this.remainder||/[ \t]$/.test(this.remainder))){this.remainder+=chunk.toString("binary");return}else if(state==="line"||state==="file"){nextRemainder=chunk.toString("binary"),chunk=!1;break}}if(state!=="body")continue;nextRemainder=chunk.slice(i+1).toString("binary"),chunk=chunk.slice(0,i+1);break}let needsFixing=!!this.remainder;if(chunk&&!needsFixing){for(let i=0,len=chunk.length;i<len;i++)if(i&&chunk[i]===10&&chunk[i-1]!==13){needsFixing=!0;break}else if(i&&chunk[i]===13&&chunk[i-1]===32){needsFixing=!0;break}else if(i&&chunk[i]===32&&chunk[i-1]===32){needsFixing=!0;break}else if(chunk[i]===9){needsFixing=!0;break}}if(needsFixing)bodyStr=this.remainder+(chunk?chunk.toString("binary"):""),this.remainder=nextRemainder,bodyStr=bodyStr.replace(/\r?\n/g,`
`).replace(/[ \t]*$/gm,"").replace(/[ \t]+/gm," ").replace(/\n/g,`\r
`),chunk=Buffer.from(bodyStr,"binary");else if(nextRemainder)this.remainder=nextRemainder;if(this.debug)this._debugBody.push(chunk);this.bodyHash.update(chunk)}_transform(chunk,encoding,callback){if(!chunk||!chunk.length)return callback();if(typeof chunk==="string")chunk=Buffer.from(chunk,encoding);this.updateHash(chunk),this.byteLength+=chunk.length,this.push(chunk),callback()}_flush(callback){if(/[\r\n]$/.test(this.remainder)&&this.byteLength>2)this.bodyHash.update(Buffer.from(`\r
`));if(!this.byteLength)this.push(Buffer.from(`\r
`));this.emit("hash",this.bodyHash.digest("base64"),this.debug?Buffer.concat(this._debugBody):!1),callback()}}module.exports=RelaxedBody});var require_sign=__commonJS((exports,module)=>{var punycode=require_punycode(),mimeFuncs=require_mime_funcs(),crypto3=__require("crypto");module.exports=(headers,hashAlgo,bodyHash,options)=>{options=options||{};let defaultFieldNames="From:Sender:Reply-To:Subject:Date:Message-ID:To:Cc:MIME-Version:Content-Type:Content-Transfer-Encoding:Content-ID:Content-Description:Resent-Date:Resent-From:Resent-Sender:Resent-To:Resent-Cc:Resent-Message-ID:In-Reply-To:References:List-Id:List-Help:List-Unsubscribe:List-Subscribe:List-Post:List-Owner:List-Archive",fieldNames=options.headerFieldNames||defaultFieldNames,canonicalizedHeaderData=relaxedHeaders(headers,fieldNames,options.skipFields),dkimHeader=generateDKIMHeader(options.domainName,options.keySelector,canonicalizedHeaderData.fieldNames,hashAlgo,bodyHash),signer,signature;canonicalizedHeaderData.headers+="dkim-signature:"+relaxedHeaderLine(dkimHeader),signer=crypto3.createSign(("rsa-"+hashAlgo).toUpperCase()),signer.update(canonicalizedHeaderData.headers);try{signature=signer.sign(options.privateKey,"base64")}catch(E){return!1}return dkimHeader+signature.replace(/(^.{73}|.{75}(?!\r?\n|\r))/g,`$&\r
 `).trim()};module.exports.relaxedHeaders=relaxedHeaders;function generateDKIMHeader(domainName,keySelector,fieldNames,hashAlgo,bodyHash){let dkim=["v=1","a=rsa-"+hashAlgo,"c=relaxed/relaxed","d="+punycode.toASCII(domainName),"q=dns/txt","s="+keySelector,"bh="+bodyHash,"h="+fieldNames].join("; ");return mimeFuncs.foldLines("DKIM-Signature: "+dkim,76)+`;\r
 b=`}function relaxedHeaders(headers,fieldNames,skipFields){let includedFields=new Set,skip=new Set,headerFields=new Map;(skipFields||"").toLowerCase().split(":").forEach((field)=>{skip.add(field.trim())}),(fieldNames||"").toLowerCase().split(":").filter((field)=>!skip.has(field.trim())).forEach((field)=>{includedFields.add(field.trim())});for(let i=headers.length-1;i>=0;i--){let line2=headers[i];if(includedFields.has(line2.key)&&!headerFields.has(line2.key))headerFields.set(line2.key,relaxedHeaderLine(line2.line))}let headersList=[],fields=[];return includedFields.forEach((field)=>{if(headerFields.has(field))fields.push(field),headersList.push(field+":"+headerFields.get(field))}),{headers:headersList.join(`\r
`)+`\r
`,fieldNames:fields.join(":")}}function relaxedHeaderLine(line2){return line2.substr(line2.indexOf(":")+1).replace(/\r?\n/g,"").replace(/\s+/g," ").trim()}});var require_dkim=__commonJS((exports,module)=>{var MessageParser=require_message_parser(),RelaxedBody=require_relaxed_body(),sign=require_sign(),PassThrough=__require("stream").PassThrough,fs2=__require("fs"),path=__require("path"),crypto3=__require("crypto");class DKIMSigner{constructor(options,keys,input,output){this.options=options||{},this.keys=keys,this.cacheTreshold=Number(this.options.cacheTreshold)||131072,this.hashAlgo=this.options.hashAlgo||"sha256",this.cacheDir=this.options.cacheDir||!1,this.chunks=[],this.chunklen=0,this.readPos=0,this.cachePath=this.cacheDir?path.join(this.cacheDir,"message."+Date.now()+"-"+crypto3.randomBytes(14).toString("hex")):!1,this.cache=!1,this.headers=!1,this.bodyHash=!1,this.parser=!1,this.relaxedBody=!1,this.input=input,this.output=output,this.output.usingCache=!1,this.hasErrored=!1,this.input.on("error",(err)=>{this.hasErrored=!0,this.cleanup(),output.emit("error",err)})}cleanup(){if(!this.cache||!this.cachePath)return;fs2.unlink(this.cachePath,()=>!1)}createReadCache(){this.cache=fs2.createReadStream(this.cachePath),this.cache.once("error",(err)=>{this.cleanup(),this.output.emit("error",err)}),this.cache.once("close",()=>{this.cleanup()}),this.cache.pipe(this.output)}sendNextChunk(){if(this.hasErrored)return;if(this.readPos>=this.chunks.length){if(!this.cache)return this.output.end();return this.createReadCache()}let chunk=this.chunks[this.readPos++];if(this.output.write(chunk)===!1)return this.output.once("drain",()=>{this.sendNextChunk()});setImmediate(()=>this.sendNextChunk())}sendSignedOutput(){let keyPos=0,signNextKey=()=>{if(keyPos>=this.keys.length)return this.output.write(this.parser.rawHeaders),setImmediate(()=>this.sendNextChunk());let key=this.keys[keyPos++],dkimField=sign(this.headers,this.hashAlgo,this.bodyHash,{domainName:key.domainName,keySelector:key.keySelector,privateKey:key.privateKey,headerFieldNames:this.options.headerFieldNames,skipFields:this.options.skipFields});if(dkimField)this.output.write(Buffer.from(dkimField+`\r
`));return setImmediate(signNextKey)};if(this.bodyHash&&this.headers)return signNextKey();this.output.write(this.parser.rawHeaders),this.sendNextChunk()}createWriteCache(){this.output.usingCache=!0,this.cache=fs2.createWriteStream(this.cachePath),this.cache.once("error",(err)=>{this.cleanup(),this.relaxedBody.unpipe(this.cache),this.relaxedBody.on("readable",()=>{while(this.relaxedBody.read()!==null);}),this.hasErrored=!0,this.output.emit("error",err)}),this.cache.once("close",()=>{this.sendSignedOutput()}),this.relaxedBody.removeAllListeners("readable"),this.relaxedBody.pipe(this.cache)}signStream(){this.parser=new MessageParser,this.relaxedBody=new RelaxedBody({hashAlgo:this.hashAlgo}),this.parser.on("headers",(value)=>{this.headers=value}),this.relaxedBody.on("hash",(value)=>{this.bodyHash=value}),this.relaxedBody.on("readable",()=>{let chunk;if(this.cache)return;while((chunk=this.relaxedBody.read())!==null)if(this.chunks.push(chunk),this.chunklen+=chunk.length,this.chunklen>=this.cacheTreshold&&this.cachePath)return this.createWriteCache()}),this.relaxedBody.on("end",()=>{if(this.cache)return;this.sendSignedOutput()}),this.parser.pipe(this.relaxedBody),setImmediate(()=>this.input.pipe(this.parser))}}class DKIM{constructor(options){this.options=options||{},this.keys=[].concat(this.options.keys||{domainName:options.domainName,keySelector:options.keySelector,privateKey:options.privateKey})}sign(input,extraOptions){let output=new PassThrough,inputStream=input,writeValue=!1;if(Buffer.isBuffer(input))writeValue=input,inputStream=new PassThrough;else if(typeof input==="string")writeValue=Buffer.from(input),inputStream=new PassThrough;let options=this.options;if(extraOptions&&Object.keys(extraOptions).length)options={},Object.keys(this.options||{}).forEach((key)=>{options[key]=this.options[key]}),Object.keys(extraOptions||{}).forEach((key)=>{if(!(key in options))options[key]=extraOptions[key]});let signer=new DKIMSigner(options,this.keys,inputStream,output);return setImmediate(()=>{if(signer.signStream(),writeValue)setImmediate(()=>{inputStream.end(writeValue)})}),output}}module.exports=DKIM});var require_http_proxy_client=__commonJS((exports,module)=>{var net2=__require("net"),tls2=__require("tls"),urllib=__require("url");function httpProxyClient(proxyUrl,destinationPort,destinationHost,callback){let proxy=urllib.parse(proxyUrl),options,connect,socket;if(options={host:proxy.hostname,port:Number(proxy.port)?Number(proxy.port):proxy.protocol==="https:"?443:80},proxy.protocol==="https:")options.rejectUnauthorized=!1,connect=tls2.connect.bind(tls2);else connect=net2.connect.bind(net2);let finished=!1,tempSocketErr=(err)=>{if(finished)return;finished=!0;try{socket.destroy()}catch(E){}callback(err)},timeoutErr=()=>{let err=new Error("Proxy socket timed out");err.code="ETIMEDOUT",tempSocketErr(err)};socket=connect(options,()=>{if(finished)return;let reqHeaders={Host:destinationHost+":"+destinationPort,Connection:"close"};if(proxy.auth)reqHeaders["Proxy-Authorization"]="Basic "+Buffer.from(proxy.auth).toString("base64");socket.write("CONNECT "+destinationHost+":"+destinationPort+` HTTP/1.1\r
`+Object.keys(reqHeaders).map((key)=>key+": "+reqHeaders[key]).join(`\r
`)+`\r
\r
`);let headers="",onSocketData=(chunk)=>{let match,remainder;if(finished)return;if(headers+=chunk.toString("binary"),match=headers.match(/\r\n\r\n/)){if(socket.removeListener("data",onSocketData),remainder=headers.substr(match.index+match[0].length),headers=headers.substr(0,match.index),remainder)socket.unshift(Buffer.from(remainder,"binary"));if(finished=!0,match=headers.match(/^HTTP\/\d+\.\d+ (\d+)/i),!match||(match[1]||"").charAt(0)!=="2"){try{socket.destroy()}catch(E){}return callback(new Error("Invalid response from proxy"+(match&&": "+match[1]||"")))}return socket.removeListener("error",tempSocketErr),socket.removeListener("timeout",timeoutErr),socket.setTimeout(0),callback(null,socket)}};socket.on("data",onSocketData)}),socket.setTimeout(httpProxyClient.timeout||30000),socket.on("timeout",timeoutErr),socket.once("error",tempSocketErr)}module.exports=httpProxyClient});var require_mail_message=__commonJS((exports,module)=>{var shared=require_shared(),MimeNode=require_mime_node(),mimeFuncs=require_mime_funcs();class MailMessage{constructor(mailer,data){this.mailer=mailer,this.data={},this.message=null,data=data||{};let options=mailer.options||{},defaults=mailer._defaults||{};Object.keys(data).forEach((key)=>{this.data[key]=data[key]}),this.data.headers=this.data.headers||{},Object.keys(defaults).forEach((key)=>{if(!(key in this.data))this.data[key]=defaults[key];else if(key==="headers")Object.keys(defaults.headers).forEach((key2)=>{if(!(key2 in this.data.headers))this.data.headers[key2]=defaults.headers[key2]})}),["disableFileAccess","disableUrlAccess","normalizeHeaderKey"].forEach((key)=>{if(key in options)this.data[key]=options[key]})}resolveContent(...args){return shared.resolveContent(...args)}resolveAll(callback){let keys=[[this.data,"html"],[this.data,"text"],[this.data,"watchHtml"],[this.data,"amp"],[this.data,"icalEvent"]];if(this.data.alternatives&&this.data.alternatives.length)this.data.alternatives.forEach((alternative,i)=>{keys.push([this.data.alternatives,i])});if(this.data.attachments&&this.data.attachments.length)this.data.attachments.forEach((attachment,i)=>{if(!attachment.filename){if(attachment.filename=(attachment.path||attachment.href||"").split("/").pop().split("?").shift()||"attachment-"+(i+1),attachment.filename.indexOf(".")<0)attachment.filename+="."+mimeFuncs.detectExtension(attachment.contentType)}if(!attachment.contentType)attachment.contentType=mimeFuncs.detectMimeType(attachment.filename||attachment.path||attachment.href||"bin");keys.push([this.data.attachments,i])});let mimeNode=new MimeNode;["from","to","cc","bcc","sender","replyTo"].forEach((address)=>{let value;if(this.message)value=[].concat(mimeNode._parseAddresses(this.message.getHeader(address==="replyTo"?"reply-to":address))||[]);else if(this.data[address])value=[].concat(mimeNode._parseAddresses(this.data[address])||[]);if(value&&value.length)this.data[address]=value;else if(address in this.data)this.data[address]=null}),["from","sender"].forEach((address)=>{if(this.data[address])this.data[address]=this.data[address].shift()});let pos=0,resolveNext=()=>{if(pos>=keys.length)return callback(null,this.data);let args=keys[pos++];if(!args[0]||!args[0][args[1]])return resolveNext();shared.resolveContent(...args,(err,value)=>{if(err)return callback(err);let node={content:value};if(args[0][args[1]]&&typeof args[0][args[1]]==="object"&&!Buffer.isBuffer(args[0][args[1]]))Object.keys(args[0][args[1]]).forEach((key)=>{if(!(key in node)&&!["content","path","href","raw"].includes(key))node[key]=args[0][args[1]][key]});args[0][args[1]]=node,resolveNext()})};setImmediate(()=>resolveNext())}normalize(callback){let envelope=this.data.envelope||this.message.getEnvelope(),messageId=this.message.messageId();this.resolveAll((err,data)=>{if(err)return callback(err);if(data.envelope=envelope,data.messageId=messageId,["html","text","watchHtml","amp"].forEach((key)=>{if(data[key]&&data[key].content){if(typeof data[key].content==="string")data[key]=data[key].content;else if(Buffer.isBuffer(data[key].content))data[key]=data[key].content.toString()}}),data.icalEvent&&Buffer.isBuffer(data.icalEvent.content))data.icalEvent.content=data.icalEvent.content.toString("base64"),data.icalEvent.encoding="base64";if(data.alternatives&&data.alternatives.length)data.alternatives.forEach((alternative)=>{if(alternative&&alternative.content&&Buffer.isBuffer(alternative.content))alternative.content=alternative.content.toString("base64"),alternative.encoding="base64"});if(data.attachments&&data.attachments.length)data.attachments.forEach((attachment)=>{if(attachment&&attachment.content&&Buffer.isBuffer(attachment.content))attachment.content=attachment.content.toString("base64"),attachment.encoding="base64"});if(data.normalizedHeaders={},Object.keys(data.headers||{}).forEach((key)=>{let value=[].concat(data.headers[key]||[]).shift();if(value=value&&value.value||value,value){if(["references","in-reply-to","message-id","content-id"].includes(key))value=this.message._encodeHeaderValue(key,value);data.normalizedHeaders[key]=value}}),data.list&&typeof data.list==="object")this._getListHeaders(data.list).forEach((entry)=>{data.normalizedHeaders[entry.key]=entry.value.map((val)=>val&&val.value||val).join(", ")});if(data.references)data.normalizedHeaders.references=this.message._encodeHeaderValue("references",data.references);if(data.inReplyTo)data.normalizedHeaders["in-reply-to"]=this.message._encodeHeaderValue("in-reply-to",data.inReplyTo);return callback(null,data)})}setMailerHeader(){if(!this.message||!this.data.xMailer)return;this.message.setHeader("X-Mailer",this.data.xMailer)}setPriorityHeaders(){if(!this.message||!this.data.priority)return;switch((this.data.priority||"").toString().toLowerCase()){case"high":this.message.setHeader("X-Priority","1 (Highest)"),this.message.setHeader("X-MSMail-Priority","High"),this.message.setHeader("Importance","High");break;case"low":this.message.setHeader("X-Priority","5 (Lowest)"),this.message.setHeader("X-MSMail-Priority","Low"),this.message.setHeader("Importance","Low");break;default:}}setListHeaders(){if(!this.message||!this.data.list||typeof this.data.list!=="object")return;if(this.data.list&&typeof this.data.list==="object")this._getListHeaders(this.data.list).forEach((listHeader)=>{listHeader.value.forEach((value)=>{this.message.addHeader(listHeader.key,value)})})}_getListHeaders(listData){return Object.keys(listData).map((key)=>({key:"list-"+key.toLowerCase().trim(),value:[].concat(listData[key]||[]).map((value)=>({prepared:!0,foldLines:!0,value:[].concat(value||[]).map((value2)=>{if(typeof value2==="string")value2={url:value2};if(value2&&value2.url){if(key.toLowerCase().trim()==="id"){let comment2=value2.comment||"";if(mimeFuncs.isPlainText(comment2))comment2='"'+comment2+'"';else comment2=mimeFuncs.encodeWord(comment2);return(value2.comment?comment2+" ":"")+this._formatListUrl(value2.url).replace(/^<[^:]+\/{,2}/,"")}let comment=value2.comment||"";if(!mimeFuncs.isPlainText(comment))comment=mimeFuncs.encodeWord(comment);return this._formatListUrl(value2.url)+(value2.comment?" ("+comment+")":"")}return""}).filter((value2)=>value2).join(", ")}))}))}_formatListUrl(url){if(url=url.replace(/[\s<]+|[\s>]+/g,""),/^(https?|mailto|ftp):/.test(url))return"<"+url+">";if(/^[^@]+@[^@]+$/.test(url))return"<mailto:"+url+">";return"<http://"+url+">"}}module.exports=MailMessage});var require_mailer=__commonJS((exports,module)=>{var EventEmitter=__require("events"),shared=require_shared(),mimeTypes=require_mime_types(),MailComposer=require_mail_composer(),DKIM=require_dkim(),httpProxyClient=require_http_proxy_client(),util=__require("util"),urllib=__require("url"),packageData=require_package2(),MailMessage=require_mail_message(),net2=__require("net"),dns=__require("dns"),crypto3=__require("crypto");class Mail extends EventEmitter{constructor(transporter,options,defaults){super();if(this.options=options||{},this._defaults=defaults||{},this._defaultPlugins={compile:[(...args)=>this._convertDataImages(...args)],stream:[]},this._userPlugins={compile:[],stream:[]},this.meta=new Map,this.dkim=this.options.dkim?new DKIM(this.options.dkim):!1,this.transporter=transporter,this.transporter.mailer=this,this.logger=shared.getLogger(this.options,{component:this.options.component||"mail"}),this.logger.debug({tnx:"create"},"Creating transport: %s",this.getVersionString()),typeof this.transporter.on==="function")this.transporter.on("log",(log)=>{this.logger.debug({tnx:"transport"},"%s: %s",log.type,log.message)}),this.transporter.on("error",(err)=>{this.logger.error({err,tnx:"transport"},"Transport Error: %s",err.message),this.emit("error",err)}),this.transporter.on("idle",(...args)=>{this.emit("idle",...args)});if(["close","isIdle","verify"].forEach((method)=>{this[method]=(...args)=>{if(typeof this.transporter[method]==="function"){if(method==="verify"&&typeof this.getSocket==="function")this.transporter.getSocket=this.getSocket,this.getSocket=!1;return this.transporter[method](...args)}else return this.logger.warn({tnx:"transport",methodName:method},"Non existing method %s called for transport",method),!1}}),this.options.proxy&&typeof this.options.proxy==="string")this.setupProxy(this.options.proxy)}use(step,plugin){if(step=(step||"").toString(),!this._userPlugins.hasOwnProperty(step))this._userPlugins[step]=[plugin];else this._userPlugins[step].push(plugin);return this}sendMail(data,callback=null){let promise;if(!callback)promise=new Promise((resolve,reject)=>{callback=shared.callbackPromise(resolve,reject)});if(typeof this.getSocket==="function")this.transporter.getSocket=this.getSocket,this.getSocket=!1;let mail=new MailMessage(this,data);return this.logger.debug({tnx:"transport",name:this.transporter.name,version:this.transporter.version,action:"send"},"Sending mail using %s/%s",this.transporter.name,this.transporter.version),this._processPlugins("compile",mail,(err)=>{if(err)return this.logger.error({err,tnx:"plugin",action:"compile"},"PluginCompile Error: %s",err.message),callback(err);mail.message=new MailComposer(mail.data).compile(),mail.setMailerHeader(),mail.setPriorityHeaders(),mail.setListHeaders(),this._processPlugins("stream",mail,(err2)=>{if(err2)return this.logger.error({err:err2,tnx:"plugin",action:"stream"},"PluginStream Error: %s",err2.message),callback(err2);if(mail.data.dkim||this.dkim)mail.message.processFunc((input)=>{let dkim=mail.data.dkim?new DKIM(mail.data.dkim):this.dkim;return this.logger.debug({tnx:"DKIM",messageId:mail.message.messageId(),dkimDomains:dkim.keys.map((key)=>key.keySelector+"."+key.domainName).join(", ")},"Signing outgoing message with %s keys",dkim.keys.length),dkim.sign(input,mail.data._dkim)});this.transporter.send(mail,(...args)=>{if(args[0])this.logger.error({err:args[0],tnx:"transport",action:"send"},"Send Error: %s",args[0].message);callback(...args)})})}),promise}getVersionString(){return util.format("%s (%s; +%s; %s/%s)",packageData.name,packageData.version,packageData.homepage,this.transporter.name,this.transporter.version)}_processPlugins(step,mail,callback){if(step=(step||"").toString(),!this._userPlugins.hasOwnProperty(step))return callback();let userPlugins=this._userPlugins[step]||[],defaultPlugins=this._defaultPlugins[step]||[];if(userPlugins.length)this.logger.debug({tnx:"transaction",pluginCount:userPlugins.length,step},"Using %s plugins for %s",userPlugins.length,step);if(userPlugins.length+defaultPlugins.length===0)return callback();let pos=0,block="default",processPlugins=()=>{let curplugins=block==="default"?defaultPlugins:userPlugins;if(pos>=curplugins.length)if(block==="default"&&userPlugins.length)block="user",pos=0,curplugins=userPlugins;else return callback();let plugin=curplugins[pos++];plugin(mail,(err)=>{if(err)return callback(err);processPlugins()})};processPlugins()}setupProxy(proxyUrl){let proxy=urllib.parse(proxyUrl);this.getSocket=(options,callback)=>{let protocol=proxy.protocol.replace(/:$/,"").toLowerCase();if(this.meta.has("proxy_handler_"+protocol))return this.meta.get("proxy_handler_"+protocol)(proxy,options,callback);switch(protocol){case"http":case"https":httpProxyClient(proxy.href,options.port,options.host,(err,socket)=>{if(err)return callback(err);return callback(null,{connection:socket})});return;case"socks":case"socks5":case"socks4":case"socks4a":{if(!this.meta.has("proxy_socks_module"))return callback(new Error("Socks module not loaded"));let connect=(ipaddress)=>{let proxyV2=!!this.meta.get("proxy_socks_module").SocksClient,socksClient=proxyV2?this.meta.get("proxy_socks_module").SocksClient:this.meta.get("proxy_socks_module"),proxyType=Number(proxy.protocol.replace(/\D/g,""))||5,connectionOpts={proxy:{ipaddress,port:Number(proxy.port),type:proxyType},[proxyV2?"destination":"target"]:{host:options.host,port:options.port},command:"connect"};if(proxy.auth){let username=decodeURIComponent(proxy.auth.split(":").shift()),password=decodeURIComponent(proxy.auth.split(":").pop());if(proxyV2)connectionOpts.proxy.userId=username,connectionOpts.proxy.password=password;else if(proxyType===4)connectionOpts.userid=username;else connectionOpts.authentication={username,password}}socksClient.createConnection(connectionOpts,(err,info)=>{if(err)return callback(err);return callback(null,{connection:info.socket||info})})};if(net2.isIP(proxy.hostname))return connect(proxy.hostname);return dns.resolve(proxy.hostname,(err,address)=>{if(err)return callback(err);connect(Array.isArray(address)?address[0]:address)})}}callback(new Error("Unknown proxy configuration"))}}_convertDataImages(mail,callback){if(!this.options.attachDataUrls&&!mail.data.attachDataUrls||!mail.data.html)return callback();mail.resolveContent(mail.data,"html",(err,html)=>{if(err)return callback(err);let cidCounter=0;html=(html||"").toString().replace(/(<img\b[^<>]{0,1024} src\s{0,20}=[\s"']{0,20})(data:([^;]+);[^"'>\s]+)/gi,(match,prefix,dataUri,mimeType)=>{let cid=crypto3.randomBytes(10).toString("hex")+"@localhost";if(!mail.data.attachments)mail.data.attachments=[];if(!Array.isArray(mail.data.attachments))mail.data.attachments=[].concat(mail.data.attachments||[]);return mail.data.attachments.push({path:dataUri,cid,filename:"image-"+ ++cidCounter+"."+mimeTypes.detectExtension(mimeType)}),prefix+"cid:"+cid}),mail.data.html=html,callback()})}set(key,value){return this.meta.set(key,value)}get(key){return this.meta.get(key)}}module.exports=Mail});var require_data_stream=__commonJS((exports,module)=>{var stream=__require("stream"),Transform2=stream.Transform;class DataStream extends Transform2{constructor(options){super(options);this.options=options||{},this._curLine="",this.inByteCount=0,this.outByteCount=0,this.lastByte=!1}_transform(chunk,encoding,done){let chunks=[],chunklen=0,i,len,lastPos=0,buf;if(!chunk||!chunk.length)return done();if(typeof chunk==="string")chunk=Buffer.from(chunk);this.inByteCount+=chunk.length;for(i=0,len=chunk.length;i<len;i++)if(chunk[i]===46){if(i&&chunk[i-1]===10||!i&&(!this.lastByte||this.lastByte===10))buf=chunk.slice(lastPos,i+1),chunks.push(buf),chunks.push(Buffer.from(".")),chunklen+=buf.length+1,lastPos=i+1}else if(chunk[i]===10){if(i&&chunk[i-1]!==13||!i&&this.lastByte!==13){if(i>lastPos)buf=chunk.slice(lastPos,i),chunks.push(buf),chunklen+=buf.length+2;else chunklen+=2;chunks.push(Buffer.from(`\r
`)),lastPos=i+1}}if(chunklen){if(lastPos<chunk.length)buf=chunk.slice(lastPos),chunks.push(buf),chunklen+=buf.length;this.outByteCount+=chunklen,this.push(Buffer.concat(chunks,chunklen))}else this.outByteCount+=chunk.length,this.push(chunk);this.lastByte=chunk[chunk.length-1],done()}_flush(done){let buf;if(this.lastByte===10)buf=Buffer.from(`.\r
`);else if(this.lastByte===13)buf=Buffer.from(`
.\r
`);else buf=Buffer.from(`\r
.\r
`);this.outByteCount+=buf.length,this.push(buf),done()}}module.exports=DataStream});var require_smtp_connection=__commonJS((exports,module)=>{var packageInfo=require_package2(),EventEmitter=__require("events").EventEmitter,net2=__require("net"),tls2=__require("tls"),os2=__require("os"),crypto3=__require("crypto"),DataStream=require_data_stream(),PassThrough=__require("stream").PassThrough,shared=require_shared();class SMTPConnection extends EventEmitter{constructor(options){super(options);if(this.id=crypto3.randomBytes(8).toString("base64").replace(/\W/g,""),this.stage="init",this.options=options||{},this.secureConnection=!!this.options.secure,this.alreadySecured=!!this.options.secured,this.port=Number(this.options.port)||(this.secureConnection?465:587),this.host=this.options.host||"localhost",this.servername=this.options.servername?this.options.servername:!net2.isIP(this.host)?this.host:!1,this.allowInternalNetworkInterfaces=this.options.allowInternalNetworkInterfaces||!1,typeof this.options.secure==="undefined"&&this.port===465)this.secureConnection=!0;this.name=this.options.name||this._getHostname(),this.logger=shared.getLogger(this.options,{component:this.options.component||"smtp-connection",sid:this.id}),this.customAuth=new Map,Object.keys(this.options.customAuth||{}).forEach((key)=>{let mapKey=(key||"").toString().trim().toUpperCase();if(!mapKey)return;this.customAuth.set(mapKey,this.options.customAuth[key])}),this.version=packageInfo.version,this.authenticated=!1,this.destroyed=!1,this.secure=!!this.secureConnection,this._remainder="",this._responseQueue=[],this.lastServerResponse=!1,this._socket=!1,this._supportedAuth=[],this.allowsAuth=!1,this._envelope=!1,this._supportedExtensions=[],this._maxAllowedSize=0,this._responseActions=[],this._recipientQueue=[],this._greetingTimeout=!1,this._connectionTimeout=!1,this._destroyed=!1,this._closing=!1,this._onSocketData=(chunk)=>this._onData(chunk),this._onSocketError=(error2)=>this._onError(error2,"ESOCKET",!1,"CONN"),this._onSocketClose=()=>this._onClose(),this._onSocketEnd=()=>this._onEnd(),this._onSocketTimeout=()=>this._onTimeout()}connect(connectCallback){if(typeof connectCallback==="function"){this.once("connect",()=>{this.logger.debug({tnx:"smtp"},"SMTP handshake finished"),connectCallback()});let isDestroyedMessage=this._isDestroyedMessage("connect");if(isDestroyedMessage)return connectCallback(this._formatError(isDestroyedMessage,"ECONNECTION",!1,"CONN"))}let opts={port:this.port,host:this.host,allowInternalNetworkInterfaces:this.allowInternalNetworkInterfaces,timeout:this.options.dnsTimeout||30000};if(this.options.localAddress)opts.localAddress=this.options.localAddress;let setupConnectionHandlers=()=>{this._connectionTimeout=setTimeout(()=>{this._onError("Connection timeout","ETIMEDOUT",!1,"CONN")},this.options.connectionTimeout||120000),this._socket.on("error",this._onSocketError)};if(this.options.connection){if(this._socket=this.options.connection,setupConnectionHandlers(),this.secureConnection&&!this.alreadySecured)setImmediate(()=>this._upgradeConnection((err)=>{if(err){this._onError(new Error("Error initiating TLS - "+(err.message||err)),"ETLS",!1,"CONN");return}this._onConnect()}));else setImmediate(()=>this._onConnect());return}else if(this.options.socket)return this._socket=this.options.socket,shared.resolveHostname(opts,(err,resolved)=>{if(err)return setImmediate(()=>this._onError(err,"EDNS",!1,"CONN"));this.logger.debug({tnx:"dns",source:opts.host,resolved:resolved.host,cached:!!resolved.cached},"Resolved %s as %s [cache %s]",opts.host,resolved.host,resolved.cached?"hit":"miss"),Object.keys(resolved).forEach((key)=>{if(key.charAt(0)!=="_"&&resolved[key])opts[key]=resolved[key]});try{this._socket.connect(this.port,this.host,()=>{this._socket.setKeepAlive(!0),this._onConnect()}),setupConnectionHandlers()}catch(E){return setImmediate(()=>this._onError(E,"ECONNECTION",!1,"CONN"))}});else if(this.secureConnection){if(this.options.tls)Object.keys(this.options.tls).forEach((key)=>{opts[key]=this.options.tls[key]});if(this.servername&&!opts.servername)opts.servername=this.servername;return shared.resolveHostname(opts,(err,resolved)=>{if(err)return setImmediate(()=>this._onError(err,"EDNS",!1,"CONN"));this.logger.debug({tnx:"dns",source:opts.host,resolved:resolved.host,cached:!!resolved.cached},"Resolved %s as %s [cache %s]",opts.host,resolved.host,resolved.cached?"hit":"miss"),Object.keys(resolved).forEach((key)=>{if(key.charAt(0)!=="_"&&resolved[key])opts[key]=resolved[key]});try{this._socket=tls2.connect(opts,()=>{this._socket.setKeepAlive(!0),this._onConnect()}),setupConnectionHandlers()}catch(E){return setImmediate(()=>this._onError(E,"ECONNECTION",!1,"CONN"))}})}else return shared.resolveHostname(opts,(err,resolved)=>{if(err)return setImmediate(()=>this._onError(err,"EDNS",!1,"CONN"));this.logger.debug({tnx:"dns",source:opts.host,resolved:resolved.host,cached:!!resolved.cached},"Resolved %s as %s [cache %s]",opts.host,resolved.host,resolved.cached?"hit":"miss"),Object.keys(resolved).forEach((key)=>{if(key.charAt(0)!=="_"&&resolved[key])opts[key]=resolved[key]});try{this._socket=net2.connect(opts,()=>{this._socket.setKeepAlive(!0),this._onConnect()}),setupConnectionHandlers()}catch(E){return setImmediate(()=>this._onError(E,"ECONNECTION",!1,"CONN"))}})}quit(){this._sendCommand("QUIT"),this._responseActions.push(this.close)}close(){if(clearTimeout(this._connectionTimeout),clearTimeout(this._greetingTimeout),this._responseActions=[],this._closing)return;this._closing=!0;let closeMethod="end";if(this.stage==="init")closeMethod="destroy";this.logger.debug({tnx:"smtp"},'Closing connection to the server using "%s"',closeMethod);let socket=this._socket&&this._socket.socket||this._socket;if(socket&&!socket.destroyed)try{socket[closeMethod]()}catch(E){}this._destroy()}login(authData,callback){let isDestroyedMessage=this._isDestroyedMessage("login");if(isDestroyedMessage)return callback(this._formatError(isDestroyedMessage,"ECONNECTION",!1,"API"));if(this._auth=authData||{},this._authMethod=(this._auth.method||"").toString().trim().toUpperCase()||!1,!this._authMethod&&this._auth.oauth2&&!this._auth.credentials)this._authMethod="XOAUTH2";else if(!this._authMethod||this._authMethod==="XOAUTH2"&&!this._auth.oauth2)this._authMethod=(this._supportedAuth[0]||"PLAIN").toUpperCase().trim();if(this._authMethod!=="XOAUTH2"&&(!this._auth.credentials||!this._auth.credentials.user||!this._auth.credentials.pass))if(this._auth.user&&this._auth.pass||this.customAuth.has(this._authMethod))this._auth.credentials={user:this._auth.user,pass:this._auth.pass,options:this._auth.options};else return callback(this._formatError('Missing credentials for "'+this._authMethod+'"',"EAUTH",!1,"API"));if(this.customAuth.has(this._authMethod)){let handler=this.customAuth.get(this._authMethod),lastResponse,returned=!1,resolve=()=>{if(returned)return;returned=!0,this.logger.info({tnx:"smtp",username:this._auth.user,action:"authenticated",method:this._authMethod},"User %s authenticated",JSON.stringify(this._auth.user)),this.authenticated=!0,callback(null,!0)},reject=(err)=>{if(returned)return;returned=!0,callback(this._formatError(err,"EAUTH",lastResponse,"AUTH "+this._authMethod))},handlerResponse=handler({auth:this._auth,method:this._authMethod,extensions:[].concat(this._supportedExtensions),authMethods:[].concat(this._supportedAuth),maxAllowedSize:this._maxAllowedSize||!1,sendCommand:(cmd,done)=>{let promise;if(!done)promise=new Promise((resolve2,reject2)=>{done=shared.callbackPromise(resolve2,reject2)});return this._responseActions.push((str)=>{lastResponse=str;let codes=str.match(/^(\d+)(?:\s(\d+\.\d+\.\d+))?\s/),data={command:cmd,response:str};if(codes){if(data.status=Number(codes[1])||0,codes[2])data.code=codes[2];data.text=str.substr(codes[0].length)}else data.text=str,data.status=0;done(null,data)}),setImmediate(()=>this._sendCommand(cmd)),promise},resolve,reject});if(handlerResponse&&typeof handlerResponse.catch==="function")handlerResponse.then(resolve).catch(reject);return}switch(this._authMethod){case"XOAUTH2":this._handleXOauth2Token(!1,callback);return;case"LOGIN":this._responseActions.push((str)=>{this._actionAUTH_LOGIN_USER(str,callback)}),this._sendCommand("AUTH LOGIN");return;case"PLAIN":this._responseActions.push((str)=>{this._actionAUTHComplete(str,callback)}),this._sendCommand("AUTH PLAIN "+Buffer.from("\x00"+this._auth.credentials.user+"\x00"+this._auth.credentials.pass,"utf-8").toString("base64"),"AUTH PLAIN "+Buffer.from("\x00"+this._auth.credentials.user+"\x00/* secret */","utf-8").toString("base64"));return;case"CRAM-MD5":this._responseActions.push((str)=>{this._actionAUTH_CRAM_MD5(str,callback)}),this._sendCommand("AUTH CRAM-MD5");return}return callback(this._formatError('Unknown authentication method "'+this._authMethod+'"',"EAUTH",!1,"API"))}send(envelope,message,done){if(!message)return done(this._formatError("Empty message","EMESSAGE",!1,"API"));let isDestroyedMessage=this._isDestroyedMessage("send message");if(isDestroyedMessage)return done(this._formatError(isDestroyedMessage,"ECONNECTION",!1,"API"));if(this._maxAllowedSize&&envelope.size>this._maxAllowedSize)return setImmediate(()=>{done(this._formatError("Message size larger than allowed "+this._maxAllowedSize,"EMESSAGE",!1,"MAIL FROM"))});let returned=!1,callback=function(){if(returned)return;returned=!0,done(...arguments)};if(typeof message.on==="function")message.on("error",(err)=>callback(this._formatError(err,"ESTREAM",!1,"API")));let startTime=Date.now();this._setEnvelope(envelope,(err,info)=>{if(err){let stream2=new PassThrough;if(typeof message.pipe==="function")message.pipe(stream2);else stream2.write(message),stream2.end();return callback(err)}let envelopeTime=Date.now(),stream=this._createSendStream((err2,str)=>{if(err2)return callback(err2);return info.envelopeTime=envelopeTime-startTime,info.messageTime=Date.now()-envelopeTime,info.messageSize=stream.outByteCount,info.response=str,callback(null,info)});if(typeof message.pipe==="function")message.pipe(stream);else stream.write(message),stream.end()})}reset(callback){this._sendCommand("RSET"),this._responseActions.push((str)=>{if(str.charAt(0)!=="2")return callback(this._formatError("Could not reset session state. response="+str,"EPROTOCOL",str,"RSET"));return this._envelope=!1,callback(null,!0)})}_onConnect(){if(clearTimeout(this._connectionTimeout),this.logger.info({tnx:"network",localAddress:this._socket.localAddress,localPort:this._socket.localPort,remoteAddress:this._socket.remoteAddress,remotePort:this._socket.remotePort},"%s established to %s:%s",this.secure?"Secure connection":"Connection",this._socket.remoteAddress,this._socket.remotePort),this._destroyed){this.close();return}this.stage="connected",this._socket.removeListener("data",this._onSocketData),this._socket.removeListener("timeout",this._onSocketTimeout),this._socket.removeListener("close",this._onSocketClose),this._socket.removeListener("end",this._onSocketEnd),this._socket.on("data",this._onSocketData),this._socket.once("close",this._onSocketClose),this._socket.once("end",this._onSocketEnd),this._socket.setTimeout(this.options.socketTimeout||600000),this._socket.on("timeout",this._onSocketTimeout),this._greetingTimeout=setTimeout(()=>{if(this._socket&&!this._destroyed&&this._responseActions[0]===this._actionGreeting)this._onError("Greeting never received","ETIMEDOUT",!1,"CONN")},this.options.greetingTimeout||30000),this._responseActions.push(this._actionGreeting),this._socket.resume()}_onData(chunk){if(this._destroyed||!chunk||!chunk.length)return;let data=(chunk||"").toString("binary"),lines=(this._remainder+data).split(/\r?\n/),lastline;this._remainder=lines.pop();for(let i=0,len=lines.length;i<len;i++){if(this._responseQueue.length){if(lastline=this._responseQueue[this._responseQueue.length-1],/^\d+-/.test(lastline.split(`
`).pop())){this._responseQueue[this._responseQueue.length-1]+=`
`+lines[i];continue}}this._responseQueue.push(lines[i])}if(this._responseQueue.length){if(lastline=this._responseQueue[this._responseQueue.length-1],/^\d+-/.test(lastline.split(`
`).pop()))return}this._processResponse()}_onError(err,type2,data,command){if(clearTimeout(this._connectionTimeout),clearTimeout(this._greetingTimeout),this._destroyed)return;err=this._formatError(err,type2,data,command),this.logger.error(data,err.message),this.emit("error",err),this.close()}_formatError(message,type2,response,command){let err;if(/Error\]$/i.test(Object.prototype.toString.call(message)))err=message;else err=new Error(message);if(type2&&type2!=="Error")err.code=type2;if(response)err.response=response,err.message+=": "+response;let responseCode=typeof response==="string"&&Number((response.match(/^\d+/)||[])[0])||!1;if(responseCode)err.responseCode=responseCode;if(command)err.command=command;return err}_onClose(){let serverResponse=!1;if(this._remainder&&this._remainder.trim()){if(this.options.debug||this.options.transactionLog)this.logger.debug({tnx:"server"},this._remainder.replace(/\r?\n$/,""));this.lastServerResponse=serverResponse=this._remainder.trim()}if(this.logger.info({tnx:"network"},"Connection closed"),this.upgrading&&!this._destroyed)return this._onError(new Error("Connection closed unexpectedly"),"ETLS",serverResponse,"CONN");else if(![this._actionGreeting,this.close].includes(this._responseActions[0])&&!this._destroyed)return this._onError(new Error("Connection closed unexpectedly"),"ECONNECTION",serverResponse,"CONN");else if(/^[45]\d{2}\b/.test(serverResponse))return this._onError(new Error("Connection closed unexpectedly"),"ECONNECTION",serverResponse,"CONN");this._destroy()}_onEnd(){if(this._socket&&!this._socket.destroyed)this._socket.destroy()}_onTimeout(){return this._onError(new Error("Timeout"),"ETIMEDOUT",!1,"CONN")}_destroy(){if(this._destroyed)return;this._destroyed=!0,this.emit("end")}_upgradeConnection(callback){this._socket.removeListener("data",this._onSocketData),this._socket.removeListener("timeout",this._onSocketTimeout);let socketPlain=this._socket,opts={socket:this._socket,host:this.host};if(Object.keys(this.options.tls||{}).forEach((key)=>{opts[key]=this.options.tls[key]}),this.servername&&!opts.servername)opts.servername=this.servername;this.upgrading=!0;try{this._socket=tls2.connect(opts,()=>{return this.secure=!0,this.upgrading=!1,this._socket.on("data",this._onSocketData),socketPlain.removeListener("close",this._onSocketClose),socketPlain.removeListener("end",this._onSocketEnd),callback(null,!0)})}catch(err){return callback(err)}this._socket.on("error",this._onSocketError),this._socket.once("close",this._onSocketClose),this._socket.once("end",this._onSocketEnd),this._socket.setTimeout(this.options.socketTimeout||600000),this._socket.on("timeout",this._onSocketTimeout),socketPlain.resume()}_processResponse(){if(!this._responseQueue.length)return!1;let str=this.lastServerResponse=(this._responseQueue.shift()||"").toString();if(/^\d+-/.test(str.split(`
`).pop()))return;if(this.options.debug||this.options.transactionLog)this.logger.debug({tnx:"server"},str.replace(/\r?\n$/,""));if(!str.trim())setImmediate(()=>this._processResponse());let action=this._responseActions.shift();if(typeof action==="function")action.call(this,str),setImmediate(()=>this._processResponse());else return this._onError(new Error("Unexpected Response"),"EPROTOCOL",str,"CONN")}_sendCommand(str,logStr){if(this._destroyed)return;if(this._socket.destroyed)return this.close();if(this.options.debug||this.options.transactionLog)this.logger.debug({tnx:"client"},(logStr||str||"").toString().replace(/\r?\n$/,""));this._socket.write(Buffer.from(str+`\r
`,"utf-8"))}_setEnvelope(envelope,callback){let args=[],useSmtpUtf8=!1;if(this._envelope=envelope||{},this._envelope.from=(this._envelope.from&&this._envelope.from.address||this._envelope.from||"").toString().trim(),this._envelope.to=[].concat(this._envelope.to||[]).map((to)=>(to&&to.address||to||"").toString().trim()),!this._envelope.to.length)return callback(this._formatError("No recipients defined","EENVELOPE",!1,"API"));if(this._envelope.from&&/[\r\n<>]/.test(this._envelope.from))return callback(this._formatError("Invalid sender "+JSON.stringify(this._envelope.from),"EENVELOPE",!1,"API"));if(/[\x80-\uFFFF]/.test(this._envelope.from))useSmtpUtf8=!0;for(let i=0,len=this._envelope.to.length;i<len;i++){if(!this._envelope.to[i]||/[\r\n<>]/.test(this._envelope.to[i]))return callback(this._formatError("Invalid recipient "+JSON.stringify(this._envelope.to[i]),"EENVELOPE",!1,"API"));if(/[\x80-\uFFFF]/.test(this._envelope.to[i]))useSmtpUtf8=!0}if(this._envelope.rcptQueue=JSON.parse(JSON.stringify(this._envelope.to||[])),this._envelope.rejected=[],this._envelope.rejectedErrors=[],this._envelope.accepted=[],this._envelope.dsn)try{this._envelope.dsn=this._setDsnEnvelope(this._envelope.dsn)}catch(err){return callback(this._formatError("Invalid DSN "+err.message,"EENVELOPE",!1,"API"))}if(this._responseActions.push((str)=>{this._actionMAIL(str,callback)}),useSmtpUtf8&&this._supportedExtensions.includes("SMTPUTF8"))args.push("SMTPUTF8"),this._usingSmtpUtf8=!0;if(this._envelope.use8BitMime&&this._supportedExtensions.includes("8BITMIME"))args.push("BODY=8BITMIME"),this._using8BitMime=!0;if(this._envelope.size&&this._supportedExtensions.includes("SIZE"))args.push("SIZE="+this._envelope.size);if(this._envelope.dsn&&this._supportedExtensions.includes("DSN")){if(this._envelope.dsn.ret)args.push("RET="+shared.encodeXText(this._envelope.dsn.ret));if(this._envelope.dsn.envid)args.push("ENVID="+shared.encodeXText(this._envelope.dsn.envid))}this._sendCommand("MAIL FROM:<"+this._envelope.from+">"+(args.length?" "+args.join(" "):""))}_setDsnEnvelope(params){let ret=(params.ret||params.return||"").toString().toUpperCase()||null;if(ret)switch(ret){case"HDRS":case"HEADERS":ret="HDRS";break;case"FULL":case"BODY":ret="FULL";break}if(ret&&!["FULL","HDRS"].includes(ret))throw new Error("ret: "+JSON.stringify(ret));let envid=(params.envid||params.id||"").toString()||null,notify=params.notify||null;if(notify){if(typeof notify==="string")notify=notify.split(",");notify=notify.map((n)=>n.trim().toUpperCase());let validNotify=["NEVER","SUCCESS","FAILURE","DELAY"];if(notify.filter((n)=>!validNotify.includes(n)).length||notify.length>1&&notify.includes("NEVER"))throw new Error("notify: "+JSON.stringify(notify.join(",")));notify=notify.join(",")}let orcpt=(params.recipient||params.orcpt||"").toString()||null;if(orcpt&&orcpt.indexOf(";")<0)orcpt="rfc822;"+orcpt;return{ret,envid,notify,orcpt}}_getDsnRcptToArgs(){let args=[];if(this._envelope.dsn&&this._supportedExtensions.includes("DSN")){if(this._envelope.dsn.notify)args.push("NOTIFY="+shared.encodeXText(this._envelope.dsn.notify));if(this._envelope.dsn.orcpt)args.push("ORCPT="+shared.encodeXText(this._envelope.dsn.orcpt))}return args.length?" "+args.join(" "):""}_createSendStream(callback){let dataStream=new DataStream,logStream;if(this.options.lmtp)this._envelope.accepted.forEach((recipient,i)=>{let final=i===this._envelope.accepted.length-1;this._responseActions.push((str)=>{this._actionLMTPStream(recipient,final,str,callback)})});else this._responseActions.push((str)=>{this._actionSMTPStream(str,callback)});if(dataStream.pipe(this._socket,{end:!1}),this.options.debug)logStream=new PassThrough,logStream.on("readable",()=>{let chunk;while(chunk=logStream.read())this.logger.debug({tnx:"message"},chunk.toString("binary").replace(/\r?\n$/,""))}),dataStream.pipe(logStream);return dataStream.once("end",()=>{this.logger.info({tnx:"message",inByteCount:dataStream.inByteCount,outByteCount:dataStream.outByteCount},"<%s bytes encoded mime message (source size %s bytes)>",dataStream.outByteCount,dataStream.inByteCount)}),dataStream}_actionGreeting(str){if(clearTimeout(this._greetingTimeout),str.substr(0,3)!=="220"){this._onError(new Error("Invalid greeting. response="+str),"EPROTOCOL",str,"CONN");return}if(this.options.lmtp)this._responseActions.push(this._actionLHLO),this._sendCommand("LHLO "+this.name);else this._responseActions.push(this._actionEHLO),this._sendCommand("EHLO "+this.name)}_actionLHLO(str){if(str.charAt(0)!=="2"){this._onError(new Error("Invalid LHLO. response="+str),"EPROTOCOL",str,"LHLO");return}this._actionEHLO(str)}_actionEHLO(str){let match;if(str.substr(0,3)==="421"){this._onError(new Error("Server terminates connection. response="+str),"ECONNECTION",str,"EHLO");return}if(str.charAt(0)!=="2"){if(this.options.requireTLS){this._onError(new Error("EHLO failed but HELO does not support required STARTTLS. response="+str),"ECONNECTION",str,"EHLO");return}this._responseActions.push(this._actionHELO),this._sendCommand("HELO "+this.name);return}if(this._ehloLines=str.split(/\r?\n/).map((line2)=>line2.replace(/^\d+[ -]/,"").trim()).filter((line2)=>line2).slice(1),!this.secure&&!this.options.ignoreTLS&&(/[ -]STARTTLS\b/im.test(str)||this.options.requireTLS)){this._sendCommand("STARTTLS"),this._responseActions.push(this._actionSTARTTLS);return}if(/[ -]SMTPUTF8\b/im.test(str))this._supportedExtensions.push("SMTPUTF8");if(/[ -]DSN\b/im.test(str))this._supportedExtensions.push("DSN");if(/[ -]8BITMIME\b/im.test(str))this._supportedExtensions.push("8BITMIME");if(/[ -]PIPELINING\b/im.test(str))this._supportedExtensions.push("PIPELINING");if(/[ -]AUTH\b/i.test(str))this.allowsAuth=!0;if(/[ -]AUTH(?:(\s+|=)[^\n]*\s+|\s+|=)PLAIN/i.test(str))this._supportedAuth.push("PLAIN");if(/[ -]AUTH(?:(\s+|=)[^\n]*\s+|\s+|=)LOGIN/i.test(str))this._supportedAuth.push("LOGIN");if(/[ -]AUTH(?:(\s+|=)[^\n]*\s+|\s+|=)CRAM-MD5/i.test(str))this._supportedAuth.push("CRAM-MD5");if(/[ -]AUTH(?:(\s+|=)[^\n]*\s+|\s+|=)XOAUTH2/i.test(str))this._supportedAuth.push("XOAUTH2");if(match=str.match(/[ -]SIZE(?:[ \t]+(\d+))?/im))this._supportedExtensions.push("SIZE"),this._maxAllowedSize=Number(match[1])||0;this.emit("connect")}_actionHELO(str){if(str.charAt(0)!=="2"){this._onError(new Error("Invalid HELO. response="+str),"EPROTOCOL",str,"HELO");return}this.allowsAuth=!0,this.emit("connect")}_actionSTARTTLS(str){if(str.charAt(0)!=="2"){if(this.options.opportunisticTLS)return this.logger.info({tnx:"smtp"},"Failed STARTTLS upgrade, continuing unencrypted"),this.emit("connect");this._onError(new Error("Error upgrading connection with STARTTLS"),"ETLS",str,"STARTTLS");return}this._upgradeConnection((err,secured)=>{if(err){this._onError(new Error("Error initiating TLS - "+(err.message||err)),"ETLS",!1,"STARTTLS");return}if(this.logger.info({tnx:"smtp"},"Connection upgraded with STARTTLS"),secured)if(this.options.lmtp)this._responseActions.push(this._actionLHLO),this._sendCommand("LHLO "+this.name);else this._responseActions.push(this._actionEHLO),this._sendCommand("EHLO "+this.name);else this.emit("connect")})}_actionAUTH_LOGIN_USER(str,callback){if(!/^334[ -]/.test(str)){callback(this._formatError('Invalid login sequence while waiting for "334 VXNlcm5hbWU6"',"EAUTH",str,"AUTH LOGIN"));return}this._responseActions.push((str2)=>{this._actionAUTH_LOGIN_PASS(str2,callback)}),this._sendCommand(Buffer.from(this._auth.credentials.user+"","utf-8").toString("base64"))}_actionAUTH_CRAM_MD5(str,callback){let challengeMatch=str.match(/^334\s+(.+)$/),challengeString="";if(!challengeMatch)return callback(this._formatError("Invalid login sequence while waiting for server challenge string","EAUTH",str,"AUTH CRAM-MD5"));else challengeString=challengeMatch[1];let base64decoded=Buffer.from(challengeString,"base64").toString("ascii"),hmacMD5=crypto3.createHmac("md5",this._auth.credentials.pass);hmacMD5.update(base64decoded);let prepended=this._auth.credentials.user+" "+hmacMD5.digest("hex");this._responseActions.push((str2)=>{this._actionAUTH_CRAM_MD5_PASS(str2,callback)}),this._sendCommand(Buffer.from(prepended).toString("base64"),Buffer.from(this._auth.credentials.user+" /* secret */").toString("base64"))}_actionAUTH_CRAM_MD5_PASS(str,callback){if(!str.match(/^235\s+/))return callback(this._formatError('Invalid login sequence while waiting for "235"',"EAUTH",str,"AUTH CRAM-MD5"));this.logger.info({tnx:"smtp",username:this._auth.user,action:"authenticated",method:this._authMethod},"User %s authenticated",JSON.stringify(this._auth.user)),this.authenticated=!0,callback(null,!0)}_actionAUTH_LOGIN_PASS(str,callback){if(!/^334[ -]/.test(str))return callback(this._formatError('Invalid login sequence while waiting for "334 UGFzc3dvcmQ6"',"EAUTH",str,"AUTH LOGIN"));this._responseActions.push((str2)=>{this._actionAUTHComplete(str2,callback)}),this._sendCommand(Buffer.from((this._auth.credentials.pass||"").toString(),"utf-8").toString("base64"),Buffer.from("/* secret */","utf-8").toString("base64"))}_actionAUTHComplete(str,isRetry,callback){if(!callback&&typeof isRetry==="function")callback=isRetry,isRetry=!1;if(str.substr(0,3)==="334"){this._responseActions.push((str2)=>{if(isRetry||this._authMethod!=="XOAUTH2")this._actionAUTHComplete(str2,!0,callback);else setImmediate(()=>this._handleXOauth2Token(!0,callback))}),this._sendCommand("");return}if(str.charAt(0)!=="2")return this.logger.info({tnx:"smtp",username:this._auth.user,action:"authfail",method:this._authMethod},"User %s failed to authenticate",JSON.stringify(this._auth.user)),callback(this._formatError("Invalid login","EAUTH",str,"AUTH "+this._authMethod));this.logger.info({tnx:"smtp",username:this._auth.user,action:"authenticated",method:this._authMethod},"User %s authenticated",JSON.stringify(this._auth.user)),this.authenticated=!0,callback(null,!0)}_actionMAIL(str,callback){let message,curRecipient;if(Number(str.charAt(0))!==2){if(this._usingSmtpUtf8&&/^550 /.test(str)&&/[\x80-\uFFFF]/.test(this._envelope.from))message="Internationalized mailbox name not allowed";else message="Mail command failed";return callback(this._formatError(message,"EENVELOPE",str,"MAIL FROM"))}if(!this._envelope.rcptQueue.length)return callback(this._formatError("Can't send mail - no recipients defined","EENVELOPE",!1,"API"));else if(this._recipientQueue=[],this._supportedExtensions.includes("PIPELINING"))while(this._envelope.rcptQueue.length)curRecipient=this._envelope.rcptQueue.shift(),this._recipientQueue.push(curRecipient),this._responseActions.push((str2)=>{this._actionRCPT(str2,callback)}),this._sendCommand("RCPT TO:<"+curRecipient+">"+this._getDsnRcptToArgs());else curRecipient=this._envelope.rcptQueue.shift(),this._recipientQueue.push(curRecipient),this._responseActions.push((str2)=>{this._actionRCPT(str2,callback)}),this._sendCommand("RCPT TO:<"+curRecipient+">"+this._getDsnRcptToArgs())}_actionRCPT(str,callback){let message,err,curRecipient=this._recipientQueue.shift();if(Number(str.charAt(0))!==2){if(this._usingSmtpUtf8&&/^553 /.test(str)&&/[\x80-\uFFFF]/.test(curRecipient))message="Internationalized mailbox name not allowed";else message="Recipient command failed";this._envelope.rejected.push(curRecipient),err=this._formatError(message,"EENVELOPE",str,"RCPT TO"),err.recipient=curRecipient,this._envelope.rejectedErrors.push(err)}else this._envelope.accepted.push(curRecipient);if(!this._envelope.rcptQueue.length&&!this._recipientQueue.length)if(this._envelope.rejected.length<this._envelope.to.length)this._responseActions.push((str2)=>{this._actionDATA(str2,callback)}),this._sendCommand("DATA");else return err=this._formatError("Can't send mail - all recipients were rejected","EENVELOPE",str,"RCPT TO"),err.rejected=this._envelope.rejected,err.rejectedErrors=this._envelope.rejectedErrors,callback(err);else if(this._envelope.rcptQueue.length)curRecipient=this._envelope.rcptQueue.shift(),this._recipientQueue.push(curRecipient),this._responseActions.push((str2)=>{this._actionRCPT(str2,callback)}),this._sendCommand("RCPT TO:<"+curRecipient+">"+this._getDsnRcptToArgs())}_actionDATA(str,callback){if(!/^[23]/.test(str))return callback(this._formatError("Data command failed","EENVELOPE",str,"DATA"));let response={accepted:this._envelope.accepted,rejected:this._envelope.rejected};if(this._ehloLines&&this._ehloLines.length)response.ehlo=this._ehloLines;if(this._envelope.rejectedErrors.length)response.rejectedErrors=this._envelope.rejectedErrors;callback(null,response)}_actionSMTPStream(str,callback){if(Number(str.charAt(0))!==2)return callback(this._formatError("Message failed","EMESSAGE",str,"DATA"));else return callback(null,str)}_actionLMTPStream(recipient,final,str,callback){let err;if(Number(str.charAt(0))!==2){err=this._formatError("Message failed for recipient "+recipient,"EMESSAGE",str,"DATA"),err.recipient=recipient,this._envelope.rejected.push(recipient),this._envelope.rejectedErrors.push(err);for(let i=0,len=this._envelope.accepted.length;i<len;i++)if(this._envelope.accepted[i]===recipient)this._envelope.accepted.splice(i,1)}if(final)return callback(null,str)}_handleXOauth2Token(isRetry,callback){this._auth.oauth2.getToken(isRetry,(err,accessToken)=>{if(err)return this.logger.info({tnx:"smtp",username:this._auth.user,action:"authfail",method:this._authMethod},"User %s failed to authenticate",JSON.stringify(this._auth.user)),callback(this._formatError(err,"EAUTH",!1,"AUTH XOAUTH2"));this._responseActions.push((str)=>{this._actionAUTHComplete(str,isRetry,callback)}),this._sendCommand("AUTH XOAUTH2 "+this._auth.oauth2.buildXOAuth2Token(accessToken),"AUTH XOAUTH2 "+this._auth.oauth2.buildXOAuth2Token("/* secret */"))})}_isDestroyedMessage(command){if(this._destroyed)return"Cannot "+command+" - smtp connection is already destroyed.";if(this._socket){if(this._socket.destroyed)return"Cannot "+command+" - smtp connection socket is already destroyed.";if(!this._socket.writable)return"Cannot "+command+" - smtp connection socket is already half-closed."}}_getHostname(){let defaultHostname;try{defaultHostname=os2.hostname()||""}catch(err){defaultHostname="localhost"}if(!defaultHostname||defaultHostname.indexOf(".")<0)defaultHostname="[127.0.0.1]";if(defaultHostname.match(/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/))defaultHostname="["+defaultHostname+"]";return defaultHostname}}module.exports=SMTPConnection});var require_xoauth2=__commonJS((exports,module)=>{var Stream3=__require("stream").Stream,nmfetch=require_fetch(),crypto3=__require("crypto"),shared=require_shared();class XOAuth2 extends Stream3{constructor(options,logger){super();if(this.options=options||{},options&&options.serviceClient){if(!options.privateKey||!options.user){setImmediate(()=>this.emit("error",new Error('Options "privateKey" and "user" are required for service account!')));return}let serviceRequestTimeout=Math.min(Math.max(Number(this.options.serviceRequestTimeout)||0,0),3600);this.options.serviceRequestTimeout=serviceRequestTimeout||300}if(this.logger=shared.getLogger({logger},{component:this.options.component||"OAuth2"}),this.provisionCallback=typeof this.options.provisionCallback==="function"?this.options.provisionCallback:!1,this.options.accessUrl=this.options.accessUrl||"https://accounts.google.com/o/oauth2/token",this.options.customHeaders=this.options.customHeaders||{},this.options.customParams=this.options.customParams||{},this.accessToken=this.options.accessToken||!1,this.options.expires&&Number(this.options.expires))this.expires=this.options.expires;else{let timeout=Math.max(Number(this.options.timeout)||0,0);this.expires=timeout&&Date.now()+timeout*1000||0}}getToken(renew,callback){if(!renew&&this.accessToken&&(!this.expires||this.expires>Date.now()))return callback(null,this.accessToken);let generateCallback=(...args)=>{if(args[0])this.logger.error({err:args[0],tnx:"OAUTH2",user:this.options.user,action:"renew"},"Failed generating new Access Token for %s",this.options.user);else this.logger.info({tnx:"OAUTH2",user:this.options.user,action:"renew"},"Generated new Access Token for %s",this.options.user);callback(...args)};if(this.provisionCallback)this.provisionCallback(this.options.user,!!renew,(err,accessToken,expires)=>{if(!err&&accessToken)this.accessToken=accessToken,this.expires=expires||0;generateCallback(err,accessToken)});else this.generateToken(generateCallback)}updateToken(accessToken,timeout){this.accessToken=accessToken,timeout=Math.max(Number(timeout)||0,0),this.expires=timeout&&Date.now()+timeout*1000||0,this.emit("token",{user:this.options.user,accessToken:accessToken||"",expires:this.expires})}generateToken(callback){let urlOptions,loggedUrlOptions;if(this.options.serviceClient){let iat=Math.floor(Date.now()/1000),tokenData={iss:this.options.serviceClient,scope:this.options.scope||"https://mail.google.com/",sub:this.options.user,aud:this.options.accessUrl,iat,exp:iat+this.options.serviceRequestTimeout},token;try{token=this.jwtSignRS256(tokenData)}catch(err){return callback(new Error("Can't generate token. Check your auth options"))}urlOptions={grant_type:"urn:ietf:params:oauth:grant-type:jwt-bearer",assertion:token},loggedUrlOptions={grant_type:"urn:ietf:params:oauth:grant-type:jwt-bearer",assertion:tokenData}}else{if(!this.options.refreshToken)return callback(new Error("Can't create new access token for user"));urlOptions={client_id:this.options.clientId||"",client_secret:this.options.clientSecret||"",refresh_token:this.options.refreshToken,grant_type:"refresh_token"},loggedUrlOptions={client_id:this.options.clientId||"",client_secret:(this.options.clientSecret||"").substr(0,6)+"...",refresh_token:(this.options.refreshToken||"").substr(0,6)+"...",grant_type:"refresh_token"}}Object.keys(this.options.customParams).forEach((key)=>{urlOptions[key]=this.options.customParams[key],loggedUrlOptions[key]=this.options.customParams[key]}),this.logger.debug({tnx:"OAUTH2",user:this.options.user,action:"generate"},"Requesting token using: %s",JSON.stringify(loggedUrlOptions)),this.postRequest(this.options.accessUrl,urlOptions,this.options,(error2,body)=>{let data;if(error2)return callback(error2);try{data=JSON.parse(body.toString())}catch(E){return callback(E)}if(!data||typeof data!=="object")return this.logger.debug({tnx:"OAUTH2",user:this.options.user,action:"post"},"Response: %s",(body||"").toString()),callback(new Error("Invalid authentication response"));let logData={};if(Object.keys(data).forEach((key)=>{if(key!=="access_token")logData[key]=data[key];else logData[key]=(data[key]||"").toString().substr(0,6)+"..."}),this.logger.debug({tnx:"OAUTH2",user:this.options.user,action:"post"},"Response: %s",JSON.stringify(logData)),data.error){let errorMessage=data.error;if(data.error_description)errorMessage+=": "+data.error_description;if(data.error_uri)errorMessage+=" ("+data.error_uri+")";return callback(new Error(errorMessage))}if(data.access_token)return this.updateToken(data.access_token,data.expires_in),callback(null,this.accessToken);return callback(new Error("No access token"))})}buildXOAuth2Token(accessToken){let authData=["user="+(this.options.user||""),"auth=Bearer "+(accessToken||this.accessToken),"",""];return Buffer.from(authData.join("\x01"),"utf-8").toString("base64")}postRequest(url,payload,params,callback){let returned=!1,chunks=[],chunklen=0,req=nmfetch(url,{method:"post",headers:params.customHeaders,body:payload,allowErrorResponse:!0});req.on("readable",()=>{let chunk;while((chunk=req.read())!==null)chunks.push(chunk),chunklen+=chunk.length}),req.once("error",(err)=>{if(returned)return;return returned=!0,callback(err)}),req.once("end",()=>{if(returned)return;return returned=!0,callback(null,Buffer.concat(chunks,chunklen))})}toBase64URL(data){if(typeof data==="string")data=Buffer.from(data);return data.toString("base64").replace(/[=]+/g,"").replace(/\+/g,"-").replace(/\//g,"_")}jwtSignRS256(payload){payload=['{"alg":"RS256","typ":"JWT"}',JSON.stringify(payload)].map((val)=>this.toBase64URL(val)).join(".");let signature=crypto3.createSign("RSA-SHA256").update(payload).sign(this.options.privateKey);return payload+"."+this.toBase64URL(signature)}}module.exports=XOAuth2});var require_pool_resource=__commonJS((exports,module)=>{var SMTPConnection=require_smtp_connection(),assign=require_shared().assign,XOAuth2=require_xoauth2(),EventEmitter=__require("events");class PoolResource extends EventEmitter{constructor(pool){super();if(this.pool=pool,this.options=pool.options,this.logger=this.pool.logger,this.options.auth)switch((this.options.auth.type||"").toString().toUpperCase()){case"OAUTH2":{let oauth2=new XOAuth2(this.options.auth,this.logger);oauth2.provisionCallback=this.pool.mailer&&this.pool.mailer.get("oauth2_provision_cb")||oauth2.provisionCallback,this.auth={type:"OAUTH2",user:this.options.auth.user,oauth2,method:"XOAUTH2"},oauth2.on("token",(token)=>this.pool.mailer.emit("token",token)),oauth2.on("error",(err)=>this.emit("error",err));break}default:if(!this.options.auth.user&&!this.options.auth.pass)break;this.auth={type:(this.options.auth.type||"").toString().toUpperCase()||"LOGIN",user:this.options.auth.user,credentials:{user:this.options.auth.user||"",pass:this.options.auth.pass,options:this.options.auth.options},method:(this.options.auth.method||"").trim().toUpperCase()||this.options.authMethod||!1}}this._connection=!1,this._connected=!1,this.messages=0,this.available=!0}connect(callback){this.pool.getSocket(this.options,(err,socketOptions)=>{if(err)return callback(err);let returned=!1,options=this.options;if(socketOptions&&socketOptions.connection)this.logger.info({tnx:"proxy",remoteAddress:socketOptions.connection.remoteAddress,remotePort:socketOptions.connection.remotePort,destHost:options.host||"",destPort:options.port||"",action:"connected"},"Using proxied socket from %s:%s to %s:%s",socketOptions.connection.remoteAddress,socketOptions.connection.remotePort,options.host||"",options.port||""),options=assign(!1,options),Object.keys(socketOptions).forEach((key)=>{options[key]=socketOptions[key]});this.connection=new SMTPConnection(options),this.connection.once("error",(err2)=>{if(this.emit("error",err2),returned)return;return returned=!0,callback(err2)}),this.connection.once("end",()=>{if(this.close(),returned)return;returned=!0;let timer2=setTimeout(()=>{if(returned)return;let err2=new Error("Unexpected socket close");if(this.connection&&this.connection._socket&&this.connection._socket.upgrading)err2.code="ETLS";callback(err2)},1000);try{timer2.unref()}catch(E){}}),this.connection.connect(()=>{if(returned)return;if(this.auth&&(this.connection.allowsAuth||options.forceAuth))this.connection.login(this.auth,(err2)=>{if(returned)return;if(returned=!0,err2)return this.connection.close(),this.emit("error",err2),callback(err2);this._connected=!0,callback(null,!0)});else return returned=!0,this._connected=!0,callback(null,!0)})})}send(mail,callback){if(!this._connected)return this.connect((err)=>{if(err)return callback(err);return this.send(mail,callback)});let envelope=mail.message.getEnvelope(),messageId=mail.message.messageId(),recipients=[].concat(envelope.to||[]);if(recipients.length>3)recipients.push("...and "+recipients.splice(2).length+" more");if(this.logger.info({tnx:"send",messageId,cid:this.id},"Sending message %s using #%s to <%s>",messageId,this.id,recipients.join(", ")),mail.data.dsn)envelope.dsn=mail.data.dsn;this.connection.send(envelope,mail.message.createReadStream(),(err,info)=>{if(this.messages++,err)return this.connection.close(),this.emit("error",err),callback(err);info.envelope={from:envelope.from,to:envelope.to},info.messageId=messageId,setImmediate(()=>{let err2;if(this.messages>=this.options.maxMessages)err2=new Error("Resource exhausted"),err2.code="EMAXLIMIT",this.connection.close(),this.emit("error",err2);else this.pool._checkRateLimit(()=>{this.available=!0,this.emit("available")})}),callback(null,info)})}close(){if(this._connected=!1,this.auth&&this.auth.oauth2)this.auth.oauth2.removeAllListeners();if(this.connection)this.connection.close();this.emit("close")}}module.exports=PoolResource});var require_services=__commonJS((exports,module)=>{module.exports={"1und1":{host:"smtp.1und1.de",port:465,secure:!0,authMethod:"LOGIN"},Aliyun:{domains:["aliyun.com"],host:"smtp.aliyun.com",port:465,secure:!0},AOL:{domains:["aol.com"],host:"smtp.aol.com",port:587},Bluewin:{host:"smtpauths.bluewin.ch",domains:["bluewin.ch"],port:465},DebugMail:{host:"debugmail.io",port:25},DynectEmail:{aliases:["Dynect"],host:"smtp.dynect.net",port:25},Ethereal:{aliases:["ethereal.email"],host:"smtp.ethereal.email",port:587},FastMail:{domains:["fastmail.fm"],host:"smtp.fastmail.com",port:465,secure:!0},"Forward Email":{aliases:["FE","ForwardEmail"],domains:["forwardemail.net"],host:"smtp.forwardemail.net",port:465,secure:!0},"Feishu Mail":{aliases:["Feishu","FeishuMail"],domains:["www.feishu.cn"],host:"smtp.feishu.cn",port:465,secure:!0},GandiMail:{aliases:["Gandi","Gandi Mail"],host:"mail.gandi.net",port:587},Gmail:{aliases:["Google Mail"],domains:["gmail.com","googlemail.com"],host:"smtp.gmail.com",port:465,secure:!0},Godaddy:{host:"smtpout.secureserver.net",port:25},GodaddyAsia:{host:"smtp.asia.secureserver.net",port:25},GodaddyEurope:{host:"smtp.europe.secureserver.net",port:25},"hot.ee":{host:"mail.hot.ee"},Hotmail:{aliases:["Outlook","Outlook.com","Hotmail.com"],domains:["hotmail.com","outlook.com"],host:"smtp-mail.outlook.com",port:587},iCloud:{aliases:["Me","Mac"],domains:["me.com","mac.com"],host:"smtp.mail.me.com",port:587},Infomaniak:{host:"mail.infomaniak.com",domains:["ik.me","ikmail.com","etik.com"],port:587},Loopia:{host:"mailcluster.loopia.se",port:465},"mail.ee":{host:"smtp.mail.ee"},"Mail.ru":{host:"smtp.mail.ru",port:465,secure:!0},"Mailcatch.app":{host:"sandbox-smtp.mailcatch.app",port:2525},Maildev:{port:1025,ignoreTLS:!0},Mailgun:{host:"smtp.mailgun.org",port:465,secure:!0},Mailjet:{host:"in.mailjet.com",port:587},Mailosaur:{host:"mailosaur.io",port:25},Mailtrap:{host:"live.smtp.mailtrap.io",port:587},Mandrill:{host:"smtp.mandrillapp.com",port:587},Naver:{host:"smtp.naver.com",port:587},One:{host:"send.one.com",port:465,secure:!0},OpenMailBox:{aliases:["OMB","openmailbox.org"],host:"smtp.openmailbox.org",port:465,secure:!0},Outlook365:{host:"smtp.office365.com",port:587,secure:!1},OhMySMTP:{host:"smtp.ohmysmtp.com",port:587,secure:!1},Postmark:{aliases:["PostmarkApp"],host:"smtp.postmarkapp.com",port:2525},Proton:{aliases:["ProtonMail","Proton.me","Protonmail.com","Protonmail.ch"],domains:["proton.me","protonmail.com","pm.me","protonmail.ch"],host:"smtp.protonmail.ch",port:587,requireTLS:!0},"qiye.aliyun":{host:"smtp.mxhichina.com",port:"465",secure:!0},QQ:{domains:["qq.com"],host:"smtp.qq.com",port:465,secure:!0},QQex:{aliases:["QQ Enterprise"],domains:["exmail.qq.com"],host:"smtp.exmail.qq.com",port:465,secure:!0},SendCloud:{host:"smtp.sendcloud.net",port:2525},SendGrid:{host:"smtp.sendgrid.net",port:587},SendinBlue:{aliases:["Brevo"],host:"smtp-relay.brevo.com",port:587},SendPulse:{host:"smtp-pulse.com",port:465,secure:!0},SES:{host:"email-smtp.us-east-1.amazonaws.com",port:465,secure:!0},"SES-US-EAST-1":{host:"email-smtp.us-east-1.amazonaws.com",port:465,secure:!0},"SES-US-WEST-2":{host:"email-smtp.us-west-2.amazonaws.com",port:465,secure:!0},"SES-EU-WEST-1":{host:"email-smtp.eu-west-1.amazonaws.com",port:465,secure:!0},"SES-AP-SOUTH-1":{host:"email-smtp.ap-south-1.amazonaws.com",port:465,secure:!0},"SES-AP-NORTHEAST-1":{host:"email-smtp.ap-northeast-1.amazonaws.com",port:465,secure:!0},"SES-AP-NORTHEAST-2":{host:"email-smtp.ap-northeast-2.amazonaws.com",port:465,secure:!0},"SES-AP-NORTHEAST-3":{host:"email-smtp.ap-northeast-3.amazonaws.com",port:465,secure:!0},"SES-AP-SOUTHEAST-1":{host:"email-smtp.ap-southeast-1.amazonaws.com",port:465,secure:!0},"SES-AP-SOUTHEAST-2":{host:"email-smtp.ap-southeast-2.amazonaws.com",port:465,secure:!0},Seznam:{aliases:["Seznam Email"],domains:["seznam.cz","email.cz","post.cz","spoluzaci.cz"],host:"smtp.seznam.cz",port:465,secure:!0},Sparkpost:{aliases:["SparkPost","SparkPost Mail"],domains:["sparkpost.com"],host:"smtp.sparkpostmail.com",port:587,secure:!1},Tipimail:{host:"smtp.tipimail.com",port:587},Yahoo:{domains:["yahoo.com"],host:"smtp.mail.yahoo.com",port:465,secure:!0},Yandex:{domains:["yandex.ru"],host:"smtp.yandex.ru",port:465,secure:!0},Zoho:{host:"smtp.zoho.com",port:465,secure:!0,authMethod:"LOGIN"},"126":{host:"smtp.126.com",port:465,secure:!0},"163":{host:"smtp.163.com",port:465,secure:!0}}});var require_well_known=__commonJS((exports,module)=>{var services=require_services(),normalized={};Object.keys(services).forEach((key)=>{let service=services[key];normalized[normalizeKey(key)]=normalizeService(service),[].concat(service.aliases||[]).forEach((alias)=>{normalized[normalizeKey(alias)]=normalizeService(service)}),[].concat(service.domains||[]).forEach((domain)=>{normalized[normalizeKey(domain)]=normalizeService(service)})});function normalizeKey(key){return key.replace(/[^a-zA-Z0-9.-]/g,"").toLowerCase()}function normalizeService(service){let filter=["domains","aliases"],response={};return Object.keys(service).forEach((key)=>{if(filter.indexOf(key)<0)response[key]=service[key]}),response}module.exports=function(key){return key=normalizeKey(key.split("@").pop()),normalized[key]||!1}});var require_smtp_pool=__commonJS((exports,module)=>{var EventEmitter=__require("events"),PoolResource=require_pool_resource(),SMTPConnection=require_smtp_connection(),wellKnown=require_well_known(),shared=require_shared(),packageData=require_package2();class SMTPPool extends EventEmitter{constructor(options){super();if(options=options||{},typeof options==="string")options={url:options};let urlData,service=options.service;if(typeof options.getSocket==="function")this.getSocket=options.getSocket;if(options.url)urlData=shared.parseConnectionUrl(options.url),service=service||urlData.service;this.options=shared.assign(!1,options,urlData,service&&wellKnown(service)),this.options.maxConnections=this.options.maxConnections||5,this.options.maxMessages=this.options.maxMessages||100,this.logger=shared.getLogger(this.options,{component:this.options.component||"smtp-pool"});let connection2=new SMTPConnection(this.options);this.name="SMTP (pool)",this.version=packageData.version+"[client:"+connection2.version+"]",this._rateLimit={counter:0,timeout:null,waiting:[],checkpoint:!1,delta:Number(this.options.rateDelta)||1000,limit:Number(this.options.rateLimit)||0},this._closed=!1,this._queue=[],this._connections=[],this._connectionCounter=0,this.idling=!0,setImmediate(()=>{if(this.idling)this.emit("idle")})}getSocket(options,callback){return setImmediate(()=>callback(null,!1))}send(mail,callback){if(this._closed)return!1;if(this._queue.push({mail,requeueAttempts:0,callback}),this.idling&&this._queue.length>=this.options.maxConnections)this.idling=!1;return setImmediate(()=>this._processMessages()),!0}close(){let connection2,len=this._connections.length;if(this._closed=!0,clearTimeout(this._rateLimit.timeout),!len&&!this._queue.length)return;for(let i=len-1;i>=0;i--)if(this._connections[i]&&this._connections[i].available)connection2=this._connections[i],connection2.close(),this.logger.info({tnx:"connection",cid:connection2.id,action:"removed"},"Connection #%s removed",connection2.id);if(len&&!this._connections.length)this.logger.debug({tnx:"connection"},"All connections removed");if(!this._queue.length)return;let invokeCallbacks=()=>{if(!this._queue.length){this.logger.debug({tnx:"connection"},"Pending queue entries cleared");return}let entry=this._queue.shift();if(entry&&typeof entry.callback==="function")try{entry.callback(new Error("Connection pool was closed"))}catch(E){this.logger.error({err:E,tnx:"callback",cid:connection2.id},"Callback error for #%s: %s",connection2.id,E.message)}setImmediate(invokeCallbacks)};setImmediate(invokeCallbacks)}_processMessages(){let connection2,i,len;if(this._closed)return;if(!this._queue.length){if(!this.idling)this.idling=!0,this.emit("idle");return}for(i=0,len=this._connections.length;i<len;i++)if(this._connections[i].available){connection2=this._connections[i];break}if(!connection2&&this._connections.length<this.options.maxConnections)connection2=this._createConnection();if(!connection2){this.idling=!1;return}if(!this.idling&&this._queue.length<this.options.maxConnections)this.idling=!0,this.emit("idle");let entry=connection2.queueEntry=this._queue.shift();if(entry.messageId=(connection2.queueEntry.mail.message.getHeader("message-id")||"").replace(/[<>\s]/g,""),connection2.available=!1,this.logger.debug({tnx:"pool",cid:connection2.id,messageId:entry.messageId,action:"assign"},"Assigned message <%s> to #%s (%s)",entry.messageId,connection2.id,connection2.messages+1),this._rateLimit.limit){if(this._rateLimit.counter++,!this._rateLimit.checkpoint)this._rateLimit.checkpoint=Date.now()}connection2.send(entry.mail,(err,info)=>{if(entry===connection2.queueEntry){try{entry.callback(err,info)}catch(E){this.logger.error({err:E,tnx:"callback",cid:connection2.id},"Callback error for #%s: %s",connection2.id,E.message)}connection2.queueEntry=!1}})}_createConnection(){let connection2=new PoolResource(this);return connection2.id=++this._connectionCounter,this.logger.info({tnx:"pool",cid:connection2.id,action:"conection"},"Created new pool resource #%s",connection2.id),connection2.on("available",()=>{if(this.logger.debug({tnx:"connection",cid:connection2.id,action:"available"},"Connection #%s became available",connection2.id),this._closed)this.close();else this._processMessages()}),connection2.once("error",(err)=>{if(err.code!=="EMAXLIMIT")this.logger.error({err,tnx:"pool",cid:connection2.id},"Pool Error for #%s: %s",connection2.id,err.message);else this.logger.debug({tnx:"pool",cid:connection2.id,action:"maxlimit"},"Max messages limit exchausted for #%s",connection2.id);if(connection2.queueEntry){try{connection2.queueEntry.callback(err)}catch(E){this.logger.error({err:E,tnx:"callback",cid:connection2.id},"Callback error for #%s: %s",connection2.id,E.message)}connection2.queueEntry=!1}this._removeConnection(connection2),this._continueProcessing()}),connection2.once("close",()=>{if(this.logger.info({tnx:"connection",cid:connection2.id,action:"closed"},"Connection #%s was closed",connection2.id),this._removeConnection(connection2),connection2.queueEntry)setTimeout(()=>{if(connection2.queueEntry)if(this._shouldRequeuOnConnectionClose(connection2.queueEntry))this._requeueEntryOnConnectionClose(connection2);else this._failDeliveryOnConnectionClose(connection2);this._continueProcessing()},50);else this._continueProcessing()}),this._connections.push(connection2),connection2}_shouldRequeuOnConnectionClose(queueEntry){if(this.options.maxRequeues===void 0||this.options.maxRequeues<0)return!0;return queueEntry.requeueAttempts<this.options.maxRequeues}_failDeliveryOnConnectionClose(connection2){if(connection2.queueEntry&&connection2.queueEntry.callback){try{connection2.queueEntry.callback(new Error("Reached maximum number of retries after connection was closed"))}catch(E){this.logger.error({err:E,tnx:"callback",messageId:connection2.queueEntry.messageId,cid:connection2.id},"Callback error for #%s: %s",connection2.id,E.message)}connection2.queueEntry=!1}}_requeueEntryOnConnectionClose(connection2){connection2.queueEntry.requeueAttempts=connection2.queueEntry.requeueAttempts+1,this.logger.debug({tnx:"pool",cid:connection2.id,messageId:connection2.queueEntry.messageId,action:"requeue"},"Re-queued message <%s> for #%s. Attempt: #%s",connection2.queueEntry.messageId,connection2.id,connection2.queueEntry.requeueAttempts),this._queue.unshift(connection2.queueEntry),connection2.queueEntry=!1}_continueProcessing(){if(this._closed)this.close();else setTimeout(()=>this._processMessages(),100)}_removeConnection(connection2){let index2=this._connections.indexOf(connection2);if(index2!==-1)this._connections.splice(index2,1)}_checkRateLimit(callback){if(!this._rateLimit.limit)return callback();let now=Date.now();if(this._rateLimit.counter<this._rateLimit.limit)return callback();if(this._rateLimit.waiting.push(callback),this._rateLimit.checkpoint<=now-this._rateLimit.delta)return this._clearRateLimit();else if(!this._rateLimit.timeout)this._rateLimit.timeout=setTimeout(()=>this._clearRateLimit(),this._rateLimit.delta-(now-this._rateLimit.checkpoint)),this._rateLimit.checkpoint=now}_clearRateLimit(){clearTimeout(this._rateLimit.timeout),this._rateLimit.timeout=null,this._rateLimit.counter=0,this._rateLimit.checkpoint=!1;while(this._rateLimit.waiting.length){let cb=this._rateLimit.waiting.shift();setImmediate(cb)}}isIdle(){return this.idling}verify(callback){let promise;if(!callback)promise=new Promise((resolve,reject)=>{callback=shared.callbackPromise(resolve,reject)});let auth=new PoolResource(this).auth;return this.getSocket(this.options,(err,socketOptions)=>{if(err)return callback(err);let options=this.options;if(socketOptions&&socketOptions.connection)this.logger.info({tnx:"proxy",remoteAddress:socketOptions.connection.remoteAddress,remotePort:socketOptions.connection.remotePort,destHost:options.host||"",destPort:options.port||"",action:"connected"},"Using proxied socket from %s:%s to %s:%s",socketOptions.connection.remoteAddress,socketOptions.connection.remotePort,options.host||"",options.port||""),options=shared.assign(!1,options),Object.keys(socketOptions).forEach((key)=>{options[key]=socketOptions[key]});let connection2=new SMTPConnection(options),returned=!1;connection2.once("error",(err2)=>{if(returned)return;return returned=!0,connection2.close(),callback(err2)}),connection2.once("end",()=>{if(returned)return;return returned=!0,callback(new Error("Connection closed"))});let finalize=()=>{if(returned)return;return returned=!0,connection2.quit(),callback(null,!0)};connection2.connect(()=>{if(returned)return;if(auth&&(connection2.allowsAuth||options.forceAuth))connection2.login(auth,(err2)=>{if(returned)return;if(err2)return returned=!0,connection2.close(),callback(err2);finalize()});else if(!auth&&connection2.allowsAuth&&options.forceAuth){let err2=new Error("Authentication info was not provided");return err2.code="NoAuth",returned=!0,connection2.close(),callback(err2)}else finalize()})}),promise}}module.exports=SMTPPool});var require_smtp_transport=__commonJS((exports,module)=>{var EventEmitter=__require("events"),SMTPConnection=require_smtp_connection(),wellKnown=require_well_known(),shared=require_shared(),XOAuth2=require_xoauth2(),packageData=require_package2();class SMTPTransport extends EventEmitter{constructor(options){super();if(options=options||{},typeof options==="string")options={url:options};let urlData,service=options.service;if(typeof options.getSocket==="function")this.getSocket=options.getSocket;if(options.url)urlData=shared.parseConnectionUrl(options.url),service=service||urlData.service;this.options=shared.assign(!1,options,urlData,service&&wellKnown(service)),this.logger=shared.getLogger(this.options,{component:this.options.component||"smtp-transport"});let connection2=new SMTPConnection(this.options);if(this.name="SMTP",this.version=packageData.version+"[client:"+connection2.version+"]",this.options.auth)this.auth=this.getAuth({})}getSocket(options,callback){return setImmediate(()=>callback(null,!1))}getAuth(authOpts){if(!authOpts)return this.auth;let hasAuth=!1,authData={};if(this.options.auth&&typeof this.options.auth==="object")Object.keys(this.options.auth).forEach((key)=>{hasAuth=!0,authData[key]=this.options.auth[key]});if(authOpts&&typeof authOpts==="object")Object.keys(authOpts).forEach((key)=>{hasAuth=!0,authData[key]=authOpts[key]});if(!hasAuth)return!1;switch((authData.type||"").toString().toUpperCase()){case"OAUTH2":{if(!authData.service&&!authData.user)return!1;let oauth2=new XOAuth2(authData,this.logger);return oauth2.provisionCallback=this.mailer&&this.mailer.get("oauth2_provision_cb")||oauth2.provisionCallback,oauth2.on("token",(token)=>this.mailer.emit("token",token)),oauth2.on("error",(err)=>this.emit("error",err)),{type:"OAUTH2",user:authData.user,oauth2,method:"XOAUTH2"}}default:return{type:(authData.type||"").toString().toUpperCase()||"LOGIN",user:authData.user,credentials:{user:authData.user||"",pass:authData.pass,options:authData.options},method:(authData.method||"").trim().toUpperCase()||this.options.authMethod||!1}}}send(mail,callback){this.getSocket(this.options,(err,socketOptions)=>{if(err)return callback(err);let returned=!1,options=this.options;if(socketOptions&&socketOptions.connection)this.logger.info({tnx:"proxy",remoteAddress:socketOptions.connection.remoteAddress,remotePort:socketOptions.connection.remotePort,destHost:options.host||"",destPort:options.port||"",action:"connected"},"Using proxied socket from %s:%s to %s:%s",socketOptions.connection.remoteAddress,socketOptions.connection.remotePort,options.host||"",options.port||""),options=shared.assign(!1,options),Object.keys(socketOptions).forEach((key)=>{options[key]=socketOptions[key]});let connection2=new SMTPConnection(options);connection2.once("error",(err2)=>{if(returned)return;return returned=!0,connection2.close(),callback(err2)}),connection2.once("end",()=>{if(returned)return;let timer2=setTimeout(()=>{if(returned)return;returned=!0;let err2=new Error("Unexpected socket close");if(connection2&&connection2._socket&&connection2._socket.upgrading)err2.code="ETLS";callback(err2)},1000);try{timer2.unref()}catch(E){}});let sendMessage=()=>{let envelope=mail.message.getEnvelope(),messageId=mail.message.messageId(),recipients=[].concat(envelope.to||[]);if(recipients.length>3)recipients.push("...and "+recipients.splice(2).length+" more");if(mail.data.dsn)envelope.dsn=mail.data.dsn;this.logger.info({tnx:"send",messageId},"Sending message %s to <%s>",messageId,recipients.join(", ")),connection2.send(envelope,mail.message.createReadStream(),(err2,info)=>{if(returned=!0,connection2.close(),err2)return this.logger.error({err:err2,tnx:"send"},"Send error for %s: %s",messageId,err2.message),callback(err2);info.envelope={from:envelope.from,to:envelope.to},info.messageId=messageId;try{return callback(null,info)}catch(E){this.logger.error({err:E,tnx:"callback"},"Callback error for %s: %s",messageId,E.message)}})};connection2.connect(()=>{if(returned)return;let auth=this.getAuth(mail.data.auth);if(auth&&(connection2.allowsAuth||options.forceAuth))connection2.login(auth,(err2)=>{if(auth&&auth!==this.auth&&auth.oauth2)auth.oauth2.removeAllListeners();if(returned)return;if(err2)return returned=!0,connection2.close(),callback(err2);sendMessage()});else sendMessage()})})}verify(callback){let promise;if(!callback)promise=new Promise((resolve,reject)=>{callback=shared.callbackPromise(resolve,reject)});return this.getSocket(this.options,(err,socketOptions)=>{if(err)return callback(err);let options=this.options;if(socketOptions&&socketOptions.connection)this.logger.info({tnx:"proxy",remoteAddress:socketOptions.connection.remoteAddress,remotePort:socketOptions.connection.remotePort,destHost:options.host||"",destPort:options.port||"",action:"connected"},"Using proxied socket from %s:%s to %s:%s",socketOptions.connection.remoteAddress,socketOptions.connection.remotePort,options.host||"",options.port||""),options=shared.assign(!1,options),Object.keys(socketOptions).forEach((key)=>{options[key]=socketOptions[key]});let connection2=new SMTPConnection(options),returned=!1;connection2.once("error",(err2)=>{if(returned)return;return returned=!0,connection2.close(),callback(err2)}),connection2.once("end",()=>{if(returned)return;return returned=!0,callback(new Error("Connection closed"))});let finalize=()=>{if(returned)return;return returned=!0,connection2.quit(),callback(null,!0)};connection2.connect(()=>{if(returned)return;let authData=this.getAuth({});if(authData&&(connection2.allowsAuth||options.forceAuth))connection2.login(authData,(err2)=>{if(returned)return;if(err2)return returned=!0,connection2.close(),callback(err2);finalize()});else if(!authData&&connection2.allowsAuth&&options.forceAuth){let err2=new Error("Authentication info was not provided");return err2.code="NoAuth",returned=!0,connection2.close(),callback(err2)}else finalize()})}),promise}close(){if(this.auth&&this.auth.oauth2)this.auth.oauth2.removeAllListeners();this.emit("close")}}module.exports=SMTPTransport});var require_sendmail_transport=__commonJS((exports,module)=>{var spawn=__require("child_process").spawn,packageData=require_package2(),shared=require_shared();class SendmailTransport{constructor(options){if(options=options||{},this._spawn=spawn,this.options=options||{},this.name="Sendmail",this.version=packageData.version,this.path="sendmail",this.args=!1,this.winbreak=!1,this.logger=shared.getLogger(this.options,{component:this.options.component||"sendmail"}),options){if(typeof options==="string")this.path=options;else if(typeof options==="object"){if(options.path)this.path=options.path;if(Array.isArray(options.args))this.args=options.args;this.winbreak=["win","windows","dos",`\r
`].includes((options.newline||"").toString().toLowerCase())}}}send(mail,done){mail.message.keepBcc=!0;let envelope=mail.data.envelope||mail.message.getEnvelope(),messageId=mail.message.messageId(),args,sendmail,returned;if([].concat(envelope.from||[]).concat(envelope.to||[]).some((addr)=>/^-/.test(addr)))return done(new Error("Can not send mail. Invalid envelope addresses."));if(this.args)args=["-i"].concat(this.args).concat(envelope.to);else args=["-i"].concat(envelope.from?["-f",envelope.from]:[]).concat(envelope.to);let callback=(err)=>{if(returned)return;if(returned=!0,typeof done==="function")if(err)return done(err);else return done(null,{envelope:mail.data.envelope||mail.message.getEnvelope(),messageId,response:"Messages queued for delivery"})};try{sendmail=this._spawn(this.path,args)}catch(E){return this.logger.error({err:E,tnx:"spawn",messageId},"Error occurred while spawning sendmail. %s",E.message),callback(E)}if(sendmail){sendmail.on("error",(err)=>{this.logger.error({err,tnx:"spawn",messageId},"Error occurred when sending message %s. %s",messageId,err.message),callback(err)}),sendmail.once("exit",(code)=>{if(!code)return callback();let err;if(code===127)err=new Error("Sendmail command not found, process exited with code "+code);else err=new Error("Sendmail exited with code "+code);this.logger.error({err,tnx:"stdin",messageId},"Error sending message %s to sendmail. %s",messageId,err.message),callback(err)}),sendmail.once("close",callback),sendmail.stdin.on("error",(err)=>{this.logger.error({err,tnx:"stdin",messageId},"Error occurred when piping message %s to sendmail. %s",messageId,err.message),callback(err)});let recipients=[].concat(envelope.to||[]);if(recipients.length>3)recipients.push("...and "+recipients.splice(2).length+" more");this.logger.info({tnx:"send",messageId},"Sending message %s to <%s>",messageId,recipients.join(", "));let sourceStream=mail.message.createReadStream();sourceStream.once("error",(err)=>{this.logger.error({err,tnx:"stdin",messageId},"Error occurred when generating message %s. %s",messageId,err.message),sendmail.kill("SIGINT"),callback(err)}),sourceStream.pipe(sendmail.stdin)}else return callback(new Error("sendmail was not found"))}}module.exports=SendmailTransport});var require_stream_transport=__commonJS((exports,module)=>{var packageData=require_package2(),shared=require_shared();class StreamTransport{constructor(options){options=options||{},this.options=options||{},this.name="StreamTransport",this.version=packageData.version,this.logger=shared.getLogger(this.options,{component:this.options.component||"stream-transport"}),this.winbreak=["win","windows","dos",`\r
`].includes((options.newline||"").toString().toLowerCase())}send(mail,done){mail.message.keepBcc=!0;let envelope=mail.data.envelope||mail.message.getEnvelope(),messageId=mail.message.messageId(),recipients=[].concat(envelope.to||[]);if(recipients.length>3)recipients.push("...and "+recipients.splice(2).length+" more");this.logger.info({tnx:"send",messageId},"Sending message %s to <%s> using %s line breaks",messageId,recipients.join(", "),this.winbreak?"<CR><LF>":"<LF>"),setImmediate(()=>{let stream;try{stream=mail.message.createReadStream()}catch(E){return this.logger.error({err:E,tnx:"send",messageId},"Creating send stream failed for %s. %s",messageId,E.message),done(E)}if(!this.options.buffer)return stream.once("error",(err)=>{this.logger.error({err,tnx:"send",messageId},"Failed creating message for %s. %s",messageId,err.message)}),done(null,{envelope:mail.data.envelope||mail.message.getEnvelope(),messageId,message:stream});let chunks=[],chunklen=0;stream.on("readable",()=>{let chunk;while((chunk=stream.read())!==null)chunks.push(chunk),chunklen+=chunk.length}),stream.once("error",(err)=>{return this.logger.error({err,tnx:"send",messageId},"Failed creating message for %s. %s",messageId,err.message),done(err)}),stream.on("end",()=>done(null,{envelope:mail.data.envelope||mail.message.getEnvelope(),messageId,message:Buffer.concat(chunks,chunklen)}))})}}module.exports=StreamTransport});var require_json_transport=__commonJS((exports,module)=>{var packageData=require_package2(),shared=require_shared();class JSONTransport{constructor(options){options=options||{},this.options=options||{},this.name="JSONTransport",this.version=packageData.version,this.logger=shared.getLogger(this.options,{component:this.options.component||"json-transport"})}send(mail,done){mail.message.keepBcc=!0;let envelope=mail.data.envelope||mail.message.getEnvelope(),messageId=mail.message.messageId(),recipients=[].concat(envelope.to||[]);if(recipients.length>3)recipients.push("...and "+recipients.splice(2).length+" more");this.logger.info({tnx:"send",messageId},"Composing JSON structure of %s to <%s>",messageId,recipients.join(", ")),setImmediate(()=>{mail.normalize((err,data)=>{if(err)return this.logger.error({err,tnx:"send",messageId},"Failed building JSON structure for %s. %s",messageId,err.message),done(err);return delete data.envelope,delete data.normalizedHeaders,done(null,{envelope,messageId,message:this.options.skipEncoding?data:JSON.stringify(data)})})})}}module.exports=JSONTransport});var require_ses_transport=__commonJS((exports,module)=>{var EventEmitter=__require("events"),packageData=require_package2(),shared=require_shared(),LeWindows=require_le_windows();class SESTransport extends EventEmitter{constructor(options){super();options=options||{},this.options=options||{},this.ses=this.options.SES,this.name="SESTransport",this.version=packageData.version,this.logger=shared.getLogger(this.options,{component:this.options.component||"ses-transport"}),this.maxConnections=Number(this.options.maxConnections)||1/0,this.connections=0,this.sendingRate=Number(this.options.sendingRate)||1/0,this.sendingRateTTL=null,this.rateInterval=1000,this.rateMessages=[],this.pending=[],this.idling=!0,setImmediate(()=>{if(this.idling)this.emit("idle")})}send(mail,callback){if(this.connections>=this.maxConnections)return this.idling=!1,this.pending.push({mail,callback});if(!this._checkSendingRate())return this.idling=!1,this.pending.push({mail,callback});this._send(mail,(...args)=>{setImmediate(()=>callback(...args)),this._sent()})}_checkRatedQueue(){if(this.connections>=this.maxConnections||!this._checkSendingRate())return;if(!this.pending.length){if(!this.idling)this.idling=!0,this.emit("idle");return}let next2=this.pending.shift();this._send(next2.mail,(...args)=>{setImmediate(()=>next2.callback(...args)),this._sent()})}_checkSendingRate(){clearTimeout(this.sendingRateTTL);let now=Date.now(),oldest=!1;for(let i=this.rateMessages.length-1;i>=0;i--){if(this.rateMessages[i].ts>=now-this.rateInterval&&(!oldest||this.rateMessages[i].ts<oldest))oldest=this.rateMessages[i].ts;if(this.rateMessages[i].ts<now-this.rateInterval&&!this.rateMessages[i].pending)this.rateMessages.splice(i,1)}if(this.rateMessages.length<this.sendingRate)return!0;let delay=Math.max(oldest+1001,now+20);this.sendingRateTTL=setTimeout(()=>this._checkRatedQueue(),now-delay);try{this.sendingRateTTL.unref()}catch(E){}return!1}_sent(){this.connections--,this._checkRatedQueue()}isIdle(){return this.idling}_send(mail,callback){let statObject={ts:Date.now(),pending:!0};this.connections++,this.rateMessages.push(statObject);let envelope=mail.data.envelope||mail.message.getEnvelope(),messageId=mail.message.messageId(),recipients=[].concat(envelope.to||[]);if(recipients.length>3)recipients.push("...and "+recipients.splice(2).length+" more");this.logger.info({tnx:"send",messageId},"Sending message %s to <%s>",messageId,recipients.join(", "));let getRawMessage=(next2)=>{if(!mail.data._dkim)mail.data._dkim={};if(mail.data._dkim.skipFields&&typeof mail.data._dkim.skipFields==="string")mail.data._dkim.skipFields+=":date:message-id";else mail.data._dkim.skipFields="date:message-id";let sourceStream=mail.message.createReadStream(),stream=sourceStream.pipe(new LeWindows),chunks=[],chunklen=0;stream.on("readable",()=>{let chunk;while((chunk=stream.read())!==null)chunks.push(chunk),chunklen+=chunk.length}),sourceStream.once("error",(err)=>stream.emit("error",err)),stream.once("error",(err)=>{next2(err)}),stream.once("end",()=>next2(null,Buffer.concat(chunks,chunklen)))};setImmediate(()=>getRawMessage((err,raw)=>{if(err)return this.logger.error({err,tnx:"send",messageId},"Failed creating message for %s. %s",messageId,err.message),statObject.pending=!1,callback(err);let sesMessage={RawMessage:{Data:raw},Source:envelope.from,Destinations:envelope.to};Object.keys(mail.data.ses||{}).forEach((key)=>{sesMessage[key]=mail.data.ses[key]});let ses=(this.ses.aws?this.ses.ses:this.ses)||{},aws=this.ses.aws||{};((cb)=>{if(ses.config&&typeof ses.config.region==="function")return ses.config.region().then((region)=>cb(null,region)).catch((err2)=>cb(err2));return cb(null,ses.config&&ses.config.region||"us-east-1")})((err2,region)=>{if(err2||!region)region="us-east-1";let sendPromise;if(typeof ses.send==="function"&&aws.SendRawEmailCommand)sendPromise=ses.send(new aws.SendRawEmailCommand(sesMessage));else sendPromise=ses.sendRawEmail(sesMessage).promise();sendPromise.then((data)=>{if(region==="us-east-1")region="email";statObject.pending=!1,callback(null,{envelope:{from:envelope.from,to:envelope.to},messageId:"<"+data.MessageId+(!/@/.test(data.MessageId)?"@"+region+".amazonses.com":"")+">",response:data.MessageId,raw})}).catch((err3)=>{this.logger.error({err:err3,tnx:"send"},"Send error for %s: %s",messageId,err3.message),statObject.pending=!1,callback(err3)})})}))}verify(callback){let promise,ses=(this.ses.aws?this.ses.ses:this.ses)||{},aws=this.ses.aws||{},sesMessage={RawMessage:{Data:`From: invalid@invalid\r
To: invalid@invalid\r
 Subject: Invalid\r
\r
Invalid`},Source:"invalid@invalid",Destinations:["invalid@invalid"]};if(!callback)promise=new Promise((resolve,reject)=>{callback=shared.callbackPromise(resolve,reject)});let cb=(err)=>{if(err&&(err.code||err.Code)!=="InvalidParameterValue")return callback(err);return callback(null,!0)};if(typeof ses.send==="function"&&aws.SendRawEmailCommand)sesMessage.RawMessage.Data=Buffer.from(sesMessage.RawMessage.Data),ses.send(new aws.SendRawEmailCommand(sesMessage),cb);else ses.sendRawEmail(sesMessage,cb);return promise}}module.exports=SESTransport});var require_nodemailer=__commonJS((exports,module)=>{var Mailer=require_mailer(),shared=require_shared(),SMTPPool=require_smtp_pool(),SMTPTransport=require_smtp_transport(),SendmailTransport=require_sendmail_transport(),StreamTransport=require_stream_transport(),JSONTransport=require_json_transport(),SESTransport=require_ses_transport(),nmfetch=require_fetch(),packageData=require_package2(),ETHEREAL_API=(process.env.ETHEREAL_API||"https://api.nodemailer.com").replace(/\/+$/,""),ETHEREAL_WEB=(process.env.ETHEREAL_WEB||"https://ethereal.email").replace(/\/+$/,""),ETHEREAL_API_KEY=(process.env.ETHEREAL_API_KEY||"").replace(/\s*/g,"")||null,ETHEREAL_CACHE=["true","yes","y","1"].includes((process.env.ETHEREAL_CACHE||"yes").toString().trim().toLowerCase()),testAccount=!1;exports.createTransport=function(transporter,defaults){let urlConfig,options,mailer;if(typeof transporter==="object"&&typeof transporter.send!=="function"||typeof transporter==="string"&&/^(smtps?|direct):/i.test(transporter)){if(urlConfig=typeof transporter==="string"?transporter:transporter.url)options=shared.parseConnectionUrl(urlConfig);else options=transporter;if(options.pool)transporter=new SMTPPool(options);else if(options.sendmail)transporter=new SendmailTransport(options);else if(options.streamTransport)transporter=new StreamTransport(options);else if(options.jsonTransport)transporter=new JSONTransport(options);else if(options.SES)transporter=new SESTransport(options);else transporter=new SMTPTransport(options)}return mailer=new Mailer(transporter,options,defaults),mailer};exports.createTestAccount=function(apiUrl,callback){let promise;if(!callback&&typeof apiUrl==="function")callback=apiUrl,apiUrl=!1;if(!callback)promise=new Promise((resolve,reject)=>{callback=shared.callbackPromise(resolve,reject)});if(ETHEREAL_CACHE&&testAccount)return setImmediate(()=>callback(null,testAccount)),promise;apiUrl=apiUrl||ETHEREAL_API;let chunks=[],chunklen=0,requestHeaders={},requestBody={requestor:packageData.name,version:packageData.version};if(ETHEREAL_API_KEY)requestHeaders.Authorization="Bearer "+ETHEREAL_API_KEY;let req=nmfetch(apiUrl+"/user",{contentType:"application/json",method:"POST",headers:requestHeaders,body:Buffer.from(JSON.stringify(requestBody))});return req.on("readable",()=>{let chunk;while((chunk=req.read())!==null)chunks.push(chunk),chunklen+=chunk.length}),req.once("error",(err)=>callback(err)),req.once("end",()=>{let res=Buffer.concat(chunks,chunklen),data,err;try{data=JSON.parse(res.toString())}catch(E){err=E}if(err)return callback(err);if(data.status!=="success"||data.error)return callback(new Error(data.error||"Request failed"));delete data.status,testAccount=data,callback(null,testAccount)}),promise};exports.getTestMessageUrl=function(info){if(!info||!info.response)return!1;let infoProps=new Map;if(info.response.replace(/\[([^\]]+)\]$/,(m,props)=>{props.replace(/\b([A-Z0-9]+)=([^\s]+)/g,(m2,key,value)=>{infoProps.set(key,value)})}),infoProps.has("STATUS")&&infoProps.has("MSGID"))return(testAccount.web||ETHEREAL_WEB)+"/message/"+infoProps.get("MSGID");return!1}});var Y=(A,b)=>{let v=b?.length?{}:null;if(v)for(let K of b)v[K.part.charCodeAt(0)]=K;return{part:A,store:null,inert:v,params:null,wildcardStore:null}},k=(A,b)=>({...A,part:b}),T=(A)=>({name:A,store:null,inert:null});class _{config;root={};history=[];deferred=[];constructor(A={}){if(this.config=A,A.lazy)this.find=this.lazyFind}static regex={static:/:.+?(?=\/|$)/,params:/:.+?(?=\/|$)/g,optionalParams:/:.+?\?(?=\/|$)/g};lazyFind=(A,b)=>{if(!this.config.lazy)return this.find;return this.build(),this.find(A,b)};build(){if(!this.config.lazy)return;for(let[A,b,v]of this.deferred)this.add(A,b,v,{lazy:!1,ignoreHistory:!0});this.deferred=[],this.find=(A,b)=>{let v=this.root[A];if(!v)return null;return $(b,b.length,v,0)}}add(A,b,v,{ignoreError:K=!1,ignoreHistory:V=!1,lazy:U=this.config.lazy}={}){if(U)return this.find=this.lazyFind,this.deferred.push([A,b,v]),v;if(typeof b!=="string")throw new TypeError("Route path must be a string");if(b==="")b="/";else if(b[0]!=="/")b=`/${b}`;let J=b[b.length-1]==="*",F=b.match(_.regex.optionalParams);if(F){let S=b.replaceAll("?","");this.add(A,S,v,{ignoreError:K,ignoreHistory:V,lazy:U});for(let D=0;D<F.length;D++){let B=b.replace("/"+F[D],"");this.add(A,B,v,{ignoreError:!0,ignoreHistory:V,lazy:U})}return v}if(F)b=b.replaceAll("?","");if(this.history.find(([S,D,B])=>S===A&&D===b))return v;if(J||F&&b.charCodeAt(b.length-1)===63)b=b.slice(0,-1);if(!V)this.history.push([A,b,v]);let G=b.split(_.regex.static),X=b.match(_.regex.params)||[];if(G[G.length-1]==="")G.pop();let q;if(!this.root[A])q=this.root[A]=Y("/");else q=this.root[A];let O=0;for(let S=0;S<G.length;++S){let D=G[S];if(S>0){let B=X[O++].slice(1);if(q.params===null)q.params=T(B);else if(q.params.name!==B)if(K)return v;else throw new Error(`Cannot create route "${b}" with parameter "${B}" because a route already exists with a different parameter name ("${q.params.name}") in the same location`);let Q=q.params;if(Q.inert===null){q=Q.inert=Y(D);continue}q=Q.inert}for(let B=0;;){if(B===D.length){if(B<q.part.length){let Q=k(q,q.part.slice(B));Object.assign(q,Y(D,[Q]))}break}if(B===q.part.length){if(q.inert===null)q.inert={};let Q=q.inert[D.charCodeAt(B)];if(Q){q=Q,D=D.slice(B),B=0;continue}let Z=Y(D.slice(B));q.inert[D.charCodeAt(B)]=Z,q=Z;break}if(D[B]!==q.part[B]){let Q=k(q,q.part.slice(B)),Z=Y(D.slice(B));Object.assign(q,Y(q.part.slice(0,B),[Q,Z])),q=Z;break}++B}}if(O<X.length){let D=X[O].slice(1);if(q.params===null)q.params=T(D);else if(q.params.name!==D)if(K)return v;else throw new Error(`Cannot create route "${b}" with parameter "${D}" because a route already exists with a different parameter name ("${q.params.name}") in the same location`);if(q.params.store===null)q.params.store=v;return q.params.store}if(J){if(q.wildcardStore===null)q.wildcardStore=v;return q.wildcardStore}if(q.store===null)q.store=v;return q.store}find(A,b){let v=this.root[A];if(!v)return null;return $(b,b.length,v,0)}}var $=(A,b,v,K)=>{let V=v.part,U=V.length,J=K+U;if(U>1){if(J>b)return null;if(U<15){for(let F=1,G=K+1;F<U;++F,++G)if(V.charCodeAt(F)!==A.charCodeAt(G))return null}else if(A.slice(K,J)!==V)return null}if(J===b){if(v.store!==null)return{store:v.store,params:{}};if(v.wildcardStore!==null)return{store:v.wildcardStore,params:{"*":""}};return null}if(v.inert!==null){let F=v.inert[A.charCodeAt(J)];if(F!==void 0){let G=$(A,b,F,J);if(G!==null)return G}}if(v.params!==null){let{store:F,name:G,inert:X}=v.params,q=A.indexOf("/",J);if(q!==J){if(q===-1||q>=b){if(F!==null){let O={};return O[G]=A.substring(J,b),{store:F,params:O}}}else if(X!==null){let O=$(A,b,X,q);if(O!==null)return O.params[G]=A.substring(J,q),O}}}if(v.wildcardStore!==null)return{store:v.wildcardStore,params:{"*":A.substring(J,b)}};return null};var exports_value={};__export(exports_value,{IsUndefined:()=>IsUndefined,IsUint8Array:()=>IsUint8Array,IsSymbol:()=>IsSymbol,IsString:()=>IsString,IsRegExp:()=>IsRegExp,IsObject:()=>IsObject,IsNumber:()=>IsNumber,IsNull:()=>IsNull,IsIterator:()=>IsIterator,IsFunction:()=>IsFunction,IsDate:()=>IsDate,IsBoolean:()=>IsBoolean,IsBigInt:()=>IsBigInt,IsAsyncIterator:()=>IsAsyncIterator,IsArray:()=>IsArray,HasPropertyKey:()=>HasPropertyKey});function HasPropertyKey(value,key){return key in value}function IsAsyncIterator(value){return IsObject(value)&&!IsArray(value)&&!IsUint8Array(value)&&Symbol.asyncIterator in value}function IsArray(value){return Array.isArray(value)}function IsBigInt(value){return typeof value==="bigint"}function IsBoolean(value){return typeof value==="boolean"}function IsDate(value){return value instanceof globalThis.Date}function IsFunction(value){return typeof value==="function"}function IsIterator(value){return IsObject(value)&&!IsArray(value)&&!IsUint8Array(value)&&Symbol.iterator in value}function IsNull(value){return value===null}function IsNumber(value){return typeof value==="number"}function IsObject(value){return typeof value==="object"&&value!==null}function IsRegExp(value){return value instanceof globalThis.RegExp}function IsString(value){return typeof value==="string"}function IsSymbol(value){return typeof value==="symbol"}function IsUint8Array(value){return value instanceof globalThis.Uint8Array}function IsUndefined(value){return value===void 0}function ArrayType(value){return value.map((value2)=>Visit(value2))}function DateType(value){return new Date(value.getTime())}function Uint8ArrayType(value){return new Uint8Array(value)}function RegExpType(value){return new RegExp(value.source,value.flags)}function ObjectType(value){let result={};for(let key of Object.getOwnPropertyNames(value))result[key]=Visit(value[key]);for(let key of Object.getOwnPropertySymbols(value))result[key]=Visit(value[key]);return result}function Visit(value){return IsArray(value)?ArrayType(value):IsDate(value)?DateType(value):IsUint8Array(value)?Uint8ArrayType(value):IsRegExp(value)?RegExpType(value):IsObject(value)?ObjectType(value):value}function Clone(value){return Visit(value)}function CloneType(schema,options){return options===void 0?Clone(schema):Clone({...options,...schema})}function IsAsyncIterator2(value){return IsObject2(value)&&globalThis.Symbol.asyncIterator in value}function IsIterator2(value){return IsObject2(value)&&globalThis.Symbol.iterator in value}function IsStandardObject(value){return IsObject2(value)&&(globalThis.Object.getPrototypeOf(value)===Object.prototype||globalThis.Object.getPrototypeOf(value)===null)}function IsPromise(value){return value instanceof globalThis.Promise}function IsDate2(value){return value instanceof Date&&globalThis.Number.isFinite(value.getTime())}function IsMap(value){return value instanceof globalThis.Map}function IsSet(value){return value instanceof globalThis.Set}function IsTypedArray(value){return globalThis.ArrayBuffer.isView(value)}function IsUint8Array2(value){return value instanceof globalThis.Uint8Array}function HasPropertyKey2(value,key){return key in value}function IsObject2(value){return value!==null&&typeof value==="object"}function IsArray2(value){return globalThis.Array.isArray(value)&&!globalThis.ArrayBuffer.isView(value)}function IsUndefined2(value){return value===void 0}function IsNull2(value){return value===null}function IsBoolean2(value){return typeof value==="boolean"}function IsNumber2(value){return typeof value==="number"}function IsInteger(value){return globalThis.Number.isInteger(value)}function IsBigInt2(value){return typeof value==="bigint"}function IsString2(value){return typeof value==="string"}function IsFunction2(value){return typeof value==="function"}function IsSymbol2(value){return typeof value==="symbol"}function IsValueType(value){return IsBigInt2(value)||IsBoolean2(value)||IsNull2(value)||IsNumber2(value)||IsString2(value)||IsSymbol2(value)||IsUndefined2(value)}var TypeSystemPolicy;(function(TypeSystemPolicy2){TypeSystemPolicy2.InstanceMode="default",TypeSystemPolicy2.ExactOptionalPropertyTypes=!1,TypeSystemPolicy2.AllowArrayObject=!1,TypeSystemPolicy2.AllowNaN=!1,TypeSystemPolicy2.AllowNullVoid=!1;function IsExactOptionalProperty(value,key){return TypeSystemPolicy2.ExactOptionalPropertyTypes?key in value:value[key]!==void 0}TypeSystemPolicy2.IsExactOptionalProperty=IsExactOptionalProperty;function IsObjectLike(value){let isObject=IsObject2(value);return TypeSystemPolicy2.AllowArrayObject?isObject:isObject&&!IsArray2(value)}TypeSystemPolicy2.IsObjectLike=IsObjectLike;function IsRecordLike(value){return IsObjectLike(value)&&!(value instanceof Date)&&!(value instanceof Uint8Array)}TypeSystemPolicy2.IsRecordLike=IsRecordLike;function IsNumberLike(value){return TypeSystemPolicy2.AllowNaN?IsNumber2(value):Number.isFinite(value)}TypeSystemPolicy2.IsNumberLike=IsNumberLike;function IsVoidLike(value){let isUndefined=IsUndefined2(value);return TypeSystemPolicy2.AllowNullVoid?isUndefined||value===null:isUndefined}TypeSystemPolicy2.IsVoidLike=IsVoidLike})(TypeSystemPolicy||(TypeSystemPolicy={}));function ImmutableArray(value){return globalThis.Object.freeze(value).map((value2)=>Immutable(value2))}function ImmutableDate(value){return value}function ImmutableUint8Array(value){return value}function ImmutableRegExp(value){return value}function ImmutableObject(value){let result={};for(let key of Object.getOwnPropertyNames(value))result[key]=Immutable(value[key]);for(let key of Object.getOwnPropertySymbols(value))result[key]=Immutable(value[key]);return globalThis.Object.freeze(result)}function Immutable(value){return IsArray(value)?ImmutableArray(value):IsDate(value)?ImmutableDate(value):IsUint8Array(value)?ImmutableUint8Array(value):IsRegExp(value)?ImmutableRegExp(value):IsObject(value)?ImmutableObject(value):value}function CreateType(schema,options){let result=options!==void 0?{...options,...schema}:schema;switch(TypeSystemPolicy.InstanceMode){case"freeze":return Immutable(result);case"clone":return Clone(result);default:return result}}class TypeBoxError extends Error{constructor(message){super(message)}}var TransformKind=Symbol.for("TypeBox.Transform"),ReadonlyKind=Symbol.for("TypeBox.Readonly"),OptionalKind=Symbol.for("TypeBox.Optional"),Hint=Symbol.for("TypeBox.Hint"),Kind=Symbol.for("TypeBox.Kind");function IsReadonly(value){return IsObject(value)&&value[ReadonlyKind]==="Readonly"}function IsOptional(value){return IsObject(value)&&value[OptionalKind]==="Optional"}function IsAny(value){return IsKindOf(value,"Any")}function IsArgument(value){return IsKindOf(value,"Argument")}function IsArray3(value){return IsKindOf(value,"Array")}function IsAsyncIterator3(value){return IsKindOf(value,"AsyncIterator")}function IsBigInt3(value){return IsKindOf(value,"BigInt")}function IsBoolean3(value){return IsKindOf(value,"Boolean")}function IsComputed(value){return IsKindOf(value,"Computed")}function IsConstructor(value){return IsKindOf(value,"Constructor")}function IsDate3(value){return IsKindOf(value,"Date")}function IsFunction3(value){return IsKindOf(value,"Function")}function IsInteger2(value){return IsKindOf(value,"Integer")}function IsIntersect(value){return IsKindOf(value,"Intersect")}function IsIterator3(value){return IsKindOf(value,"Iterator")}function IsKindOf(value,kind){return IsObject(value)&&Kind in value&&value[Kind]===kind}function IsLiteralValue(value){return IsBoolean(value)||IsNumber(value)||IsString(value)}function IsLiteral(value){return IsKindOf(value,"Literal")}function IsMappedKey(value){return IsKindOf(value,"MappedKey")}function IsMappedResult(value){return IsKindOf(value,"MappedResult")}function IsNever(value){return IsKindOf(value,"Never")}function IsNot(value){return IsKindOf(value,"Not")}function IsNull3(value){return IsKindOf(value,"Null")}function IsNumber3(value){return IsKindOf(value,"Number")}function IsObject3(value){return IsKindOf(value,"Object")}function IsPromise2(value){return IsKindOf(value,"Promise")}function IsRecord(value){return IsKindOf(value,"Record")}function IsRef(value){return IsKindOf(value,"Ref")}function IsRegExp2(value){return IsKindOf(value,"RegExp")}function IsString3(value){return IsKindOf(value,"String")}function IsSymbol3(value){return IsKindOf(value,"Symbol")}function IsTemplateLiteral(value){return IsKindOf(value,"TemplateLiteral")}function IsThis(value){return IsKindOf(value,"This")}function IsTransform(value){return IsObject(value)&&TransformKind in value}function IsTuple(value){return IsKindOf(value,"Tuple")}function IsUndefined3(value){return IsKindOf(value,"Undefined")}function IsUnion(value){return IsKindOf(value,"Union")}function IsUint8Array3(value){return IsKindOf(value,"Uint8Array")}function IsUnknown(value){return IsKindOf(value,"Unknown")}function IsUnsafe(value){return IsKindOf(value,"Unsafe")}function IsVoid(value){return IsKindOf(value,"Void")}function IsKind(value){return IsObject(value)&&Kind in value&&IsString(value[Kind])}function IsSchema(value){return IsAny(value)||IsArgument(value)||IsArray3(value)||IsBoolean3(value)||IsBigInt3(value)||IsAsyncIterator3(value)||IsComputed(value)||IsConstructor(value)||IsDate3(value)||IsFunction3(value)||IsInteger2(value)||IsIntersect(value)||IsIterator3(value)||IsLiteral(value)||IsMappedKey(value)||IsMappedResult(value)||IsNever(value)||IsNot(value)||IsNull3(value)||IsNumber3(value)||IsObject3(value)||IsPromise2(value)||IsRecord(value)||IsRef(value)||IsRegExp2(value)||IsString3(value)||IsSymbol3(value)||IsTemplateLiteral(value)||IsThis(value)||IsTuple(value)||IsUndefined3(value)||IsUnion(value)||IsUint8Array3(value)||IsUnknown(value)||IsUnsafe(value)||IsVoid(value)||IsKind(value)}var exports_type={};__export(exports_type,{TypeGuardUnknownTypeError:()=>TypeGuardUnknownTypeError,IsVoid:()=>IsVoid2,IsUnsafe:()=>IsUnsafe2,IsUnknown:()=>IsUnknown2,IsUnionLiteral:()=>IsUnionLiteral,IsUnion:()=>IsUnion2,IsUndefined:()=>IsUndefined4,IsUint8Array:()=>IsUint8Array4,IsTuple:()=>IsTuple2,IsTransform:()=>IsTransform2,IsThis:()=>IsThis2,IsTemplateLiteral:()=>IsTemplateLiteral2,IsSymbol:()=>IsSymbol4,IsString:()=>IsString4,IsSchema:()=>IsSchema2,IsRegExp:()=>IsRegExp3,IsRef:()=>IsRef2,IsRecursive:()=>IsRecursive,IsRecord:()=>IsRecord2,IsReadonly:()=>IsReadonly2,IsProperties:()=>IsProperties,IsPromise:()=>IsPromise3,IsOptional:()=>IsOptional2,IsObject:()=>IsObject4,IsNumber:()=>IsNumber4,IsNull:()=>IsNull4,IsNot:()=>IsNot2,IsNever:()=>IsNever2,IsMappedResult:()=>IsMappedResult2,IsMappedKey:()=>IsMappedKey2,IsLiteralValue:()=>IsLiteralValue2,IsLiteralString:()=>IsLiteralString,IsLiteralNumber:()=>IsLiteralNumber,IsLiteralBoolean:()=>IsLiteralBoolean,IsLiteral:()=>IsLiteral2,IsKindOf:()=>IsKindOf2,IsKind:()=>IsKind2,IsIterator:()=>IsIterator4,IsIntersect:()=>IsIntersect2,IsInteger:()=>IsInteger3,IsImport:()=>IsImport,IsFunction:()=>IsFunction4,IsDate:()=>IsDate4,IsConstructor:()=>IsConstructor2,IsComputed:()=>IsComputed2,IsBoolean:()=>IsBoolean4,IsBigInt:()=>IsBigInt4,IsAsyncIterator:()=>IsAsyncIterator4,IsArray:()=>IsArray4,IsArgument:()=>IsArgument2,IsAny:()=>IsAny2});class TypeGuardUnknownTypeError extends TypeBoxError{}var KnownTypes=["Argument","Any","Array","AsyncIterator","BigInt","Boolean","Computed","Constructor","Date","Enum","Function","Integer","Intersect","Iterator","Literal","MappedKey","MappedResult","Not","Null","Number","Object","Promise","Record","Ref","RegExp","String","Symbol","TemplateLiteral","This","Tuple","Undefined","Union","Uint8Array","Unknown","Void"];function IsPattern(value){try{return new RegExp(value),!0}catch{return!1}}function IsControlCharacterFree(value){if(!IsString(value))return!1;for(let i=0;i<value.length;i++){let code=value.charCodeAt(i);if(code>=7&&code<=13||code===27||code===127)return!1}return!0}function IsAdditionalProperties(value){return IsOptionalBoolean(value)||IsSchema2(value)}function IsOptionalBigInt(value){return IsUndefined(value)||IsBigInt(value)}function IsOptionalNumber(value){return IsUndefined(value)||IsNumber(value)}function IsOptionalBoolean(value){return IsUndefined(value)||IsBoolean(value)}function IsOptionalString(value){return IsUndefined(value)||IsString(value)}function IsOptionalPattern(value){return IsUndefined(value)||IsString(value)&&IsControlCharacterFree(value)&&IsPattern(value)}function IsOptionalFormat(value){return IsUndefined(value)||IsString(value)&&IsControlCharacterFree(value)}function IsOptionalSchema(value){return IsUndefined(value)||IsSchema2(value)}function IsReadonly2(value){return IsObject(value)&&value[ReadonlyKind]==="Readonly"}function IsOptional2(value){return IsObject(value)&&value[OptionalKind]==="Optional"}function IsAny2(value){return IsKindOf2(value,"Any")&&IsOptionalString(value.$id)}function IsArgument2(value){return IsKindOf2(value,"Argument")&&IsNumber(value.index)}function IsArray4(value){return IsKindOf2(value,"Array")&&value.type==="array"&&IsOptionalString(value.$id)&&IsSchema2(value.items)&&IsOptionalNumber(value.minItems)&&IsOptionalNumber(value.maxItems)&&IsOptionalBoolean(value.uniqueItems)&&IsOptionalSchema(value.contains)&&IsOptionalNumber(value.minContains)&&IsOptionalNumber(value.maxContains)}function IsAsyncIterator4(value){return IsKindOf2(value,"AsyncIterator")&&value.type==="AsyncIterator"&&IsOptionalString(value.$id)&&IsSchema2(value.items)}function IsBigInt4(value){return IsKindOf2(value,"BigInt")&&value.type==="bigint"&&IsOptionalString(value.$id)&&IsOptionalBigInt(value.exclusiveMaximum)&&IsOptionalBigInt(value.exclusiveMinimum)&&IsOptionalBigInt(value.maximum)&&IsOptionalBigInt(value.minimum)&&IsOptionalBigInt(value.multipleOf)}function IsBoolean4(value){return IsKindOf2(value,"Boolean")&&value.type==="boolean"&&IsOptionalString(value.$id)}function IsComputed2(value){return IsKindOf2(value,"Computed")&&IsString(value.target)&&IsArray(value.parameters)&&value.parameters.every((schema)=>IsSchema2(schema))}function IsConstructor2(value){return IsKindOf2(value,"Constructor")&&value.type==="Constructor"&&IsOptionalString(value.$id)&&IsArray(value.parameters)&&value.parameters.every((schema)=>IsSchema2(schema))&&IsSchema2(value.returns)}function IsDate4(value){return IsKindOf2(value,"Date")&&value.type==="Date"&&IsOptionalString(value.$id)&&IsOptionalNumber(value.exclusiveMaximumTimestamp)&&IsOptionalNumber(value.exclusiveMinimumTimestamp)&&IsOptionalNumber(value.maximumTimestamp)&&IsOptionalNumber(value.minimumTimestamp)&&IsOptionalNumber(value.multipleOfTimestamp)}function IsFunction4(value){return IsKindOf2(value,"Function")&&value.type==="Function"&&IsOptionalString(value.$id)&&IsArray(value.parameters)&&value.parameters.every((schema)=>IsSchema2(schema))&&IsSchema2(value.returns)}function IsImport(value){return IsKindOf2(value,"Import")&&HasPropertyKey(value,"$defs")&&IsObject(value.$defs)&&IsProperties(value.$defs)&&HasPropertyKey(value,"$ref")&&IsString(value.$ref)&&value.$ref in value.$defs}function IsInteger3(value){return IsKindOf2(value,"Integer")&&value.type==="integer"&&IsOptionalString(value.$id)&&IsOptionalNumber(value.exclusiveMaximum)&&IsOptionalNumber(value.exclusiveMinimum)&&IsOptionalNumber(value.maximum)&&IsOptionalNumber(value.minimum)&&IsOptionalNumber(value.multipleOf)}function IsProperties(value){return IsObject(value)&&Object.entries(value).every(([key,schema])=>IsControlCharacterFree(key)&&IsSchema2(schema))}function IsIntersect2(value){return IsKindOf2(value,"Intersect")&&(IsString(value.type)&&value.type!=="object"?!1:!0)&&IsArray(value.allOf)&&value.allOf.every((schema)=>IsSchema2(schema)&&!IsTransform2(schema))&&IsOptionalString(value.type)&&(IsOptionalBoolean(value.unevaluatedProperties)||IsOptionalSchema(value.unevaluatedProperties))&&IsOptionalString(value.$id)}function IsIterator4(value){return IsKindOf2(value,"Iterator")&&value.type==="Iterator"&&IsOptionalString(value.$id)&&IsSchema2(value.items)}function IsKindOf2(value,kind){return IsObject(value)&&Kind in value&&value[Kind]===kind}function IsLiteralString(value){return IsLiteral2(value)&&IsString(value.const)}function IsLiteralNumber(value){return IsLiteral2(value)&&IsNumber(value.const)}function IsLiteralBoolean(value){return IsLiteral2(value)&&IsBoolean(value.const)}function IsLiteral2(value){return IsKindOf2(value,"Literal")&&IsOptionalString(value.$id)&&IsLiteralValue2(value.const)}function IsLiteralValue2(value){return IsBoolean(value)||IsNumber(value)||IsString(value)}function IsMappedKey2(value){return IsKindOf2(value,"MappedKey")&&IsArray(value.keys)&&value.keys.every((key)=>IsNumber(key)||IsString(key))}function IsMappedResult2(value){return IsKindOf2(value,"MappedResult")&&IsProperties(value.properties)}function IsNever2(value){return IsKindOf2(value,"Never")&&IsObject(value.not)&&Object.getOwnPropertyNames(value.not).length===0}function IsNot2(value){return IsKindOf2(value,"Not")&&IsSchema2(value.not)}function IsNull4(value){return IsKindOf2(value,"Null")&&value.type==="null"&&IsOptionalString(value.$id)}function IsNumber4(value){return IsKindOf2(value,"Number")&&value.type==="number"&&IsOptionalString(value.$id)&&IsOptionalNumber(value.exclusiveMaximum)&&IsOptionalNumber(value.exclusiveMinimum)&&IsOptionalNumber(value.maximum)&&IsOptionalNumber(value.minimum)&&IsOptionalNumber(value.multipleOf)}function IsObject4(value){return IsKindOf2(value,"Object")&&value.type==="object"&&IsOptionalString(value.$id)&&IsProperties(value.properties)&&IsAdditionalProperties(value.additionalProperties)&&IsOptionalNumber(value.minProperties)&&IsOptionalNumber(value.maxProperties)}function IsPromise3(value){return IsKindOf2(value,"Promise")&&value.type==="Promise"&&IsOptionalString(value.$id)&&IsSchema2(value.item)}function IsRecord2(value){return IsKindOf2(value,"Record")&&value.type==="object"&&IsOptionalString(value.$id)&&IsAdditionalProperties(value.additionalProperties)&&IsObject(value.patternProperties)&&((schema)=>{let keys=Object.getOwnPropertyNames(schema.patternProperties);return keys.length===1&&IsPattern(keys[0])&&IsObject(schema.patternProperties)&&IsSchema2(schema.patternProperties[keys[0]])})(value)}function IsRecursive(value){return IsObject(value)&&Hint in value&&value[Hint]==="Recursive"}function IsRef2(value){return IsKindOf2(value,"Ref")&&IsOptionalString(value.$id)&&IsString(value.$ref)}function IsRegExp3(value){return IsKindOf2(value,"RegExp")&&IsOptionalString(value.$id)&&IsString(value.source)&&IsString(value.flags)&&IsOptionalNumber(value.maxLength)&&IsOptionalNumber(value.minLength)}function IsString4(value){return IsKindOf2(value,"String")&&value.type==="string"&&IsOptionalString(value.$id)&&IsOptionalNumber(value.minLength)&&IsOptionalNumber(value.maxLength)&&IsOptionalPattern(value.pattern)&&IsOptionalFormat(value.format)}function IsSymbol4(value){return IsKindOf2(value,"Symbol")&&value.type==="symbol"&&IsOptionalString(value.$id)}function IsTemplateLiteral2(value){return IsKindOf2(value,"TemplateLiteral")&&value.type==="string"&&IsString(value.pattern)&&value.pattern[0]==="^"&&value.pattern[value.pattern.length-1]==="$"}function IsThis2(value){return IsKindOf2(value,"This")&&IsOptionalString(value.$id)&&IsString(value.$ref)}function IsTransform2(value){return IsObject(value)&&TransformKind in value}function IsTuple2(value){return IsKindOf2(value,"Tuple")&&value.type==="array"&&IsOptionalString(value.$id)&&IsNumber(value.minItems)&&IsNumber(value.maxItems)&&value.minItems===value.maxItems&&(IsUndefined(value.items)&&IsUndefined(value.additionalItems)&&value.minItems===0||IsArray(value.items)&&value.items.every((schema)=>IsSchema2(schema)))}function IsUndefined4(value){return IsKindOf2(value,"Undefined")&&value.type==="undefined"&&IsOptionalString(value.$id)}function IsUnionLiteral(value){return IsUnion2(value)&&value.anyOf.every((schema)=>IsLiteralString(schema)||IsLiteralNumber(schema))}function IsUnion2(value){return IsKindOf2(value,"Union")&&IsOptionalString(value.$id)&&IsObject(value)&&IsArray(value.anyOf)&&value.anyOf.every((schema)=>IsSchema2(schema))}function IsUint8Array4(value){return IsKindOf2(value,"Uint8Array")&&value.type==="Uint8Array"&&IsOptionalString(value.$id)&&IsOptionalNumber(value.minByteLength)&&IsOptionalNumber(value.maxByteLength)}function IsUnknown2(value){return IsKindOf2(value,"Unknown")&&IsOptionalString(value.$id)}function IsUnsafe2(value){return IsKindOf2(value,"Unsafe")}function IsVoid2(value){return IsKindOf2(value,"Void")&&value.type==="void"&&IsOptionalString(value.$id)}function IsKind2(value){return IsObject(value)&&Kind in value&&IsString(value[Kind])&&!KnownTypes.includes(value[Kind])}function IsSchema2(value){return IsObject(value)&&(IsAny2(value)||IsArgument2(value)||IsArray4(value)||IsBoolean4(value)||IsBigInt4(value)||IsAsyncIterator4(value)||IsComputed2(value)||IsConstructor2(value)||IsDate4(value)||IsFunction4(value)||IsInteger3(value)||IsIntersect2(value)||IsIterator4(value)||IsLiteral2(value)||IsMappedKey2(value)||IsMappedResult2(value)||IsNever2(value)||IsNot2(value)||IsNull4(value)||IsNumber4(value)||IsObject4(value)||IsPromise3(value)||IsRecord2(value)||IsRef2(value)||IsRegExp3(value)||IsString4(value)||IsSymbol4(value)||IsTemplateLiteral2(value)||IsThis2(value)||IsTuple2(value)||IsUndefined4(value)||IsUnion2(value)||IsUint8Array4(value)||IsUnknown2(value)||IsUnsafe2(value)||IsVoid2(value)||IsKind2(value))}var PatternBoolean="(true|false)",PatternNumber="(0|[1-9][0-9]*)",PatternString="(.*)";var PatternNumberExact="^(0|[1-9][0-9]*)$",PatternStringExact="^(.*)$",PatternNeverExact="^(?!.*)$";var exports_format={};__export(exports_format,{Set:()=>Set2,Has:()=>Has,Get:()=>Get,Entries:()=>Entries,Delete:()=>Delete,Clear:()=>Clear});var map=new Map;function Entries(){return new Map(map)}function Clear(){return map.clear()}function Delete(format){return map.delete(format)}function Has(format){return map.has(format)}function Set2(format,func){map.set(format,func)}function Get(format){return map.get(format)}var exports_type2={};__export(exports_type2,{Set:()=>Set3,Has:()=>Has2,Get:()=>Get2,Entries:()=>Entries2,Delete:()=>Delete2,Clear:()=>Clear2});var map2=new Map;function Entries2(){return new Map(map2)}function Clear2(){return map2.clear()}function Delete2(kind){return map2.delete(kind)}function Has2(kind){return map2.has(kind)}function Set3(kind,func){map2.set(kind,func)}function Get2(kind){return map2.get(kind)}function SetIncludes(T2,S){return T2.includes(S)}function SetDistinct(T2){return[...new Set(T2)]}function SetIntersect(T2,S){return T2.filter((L)=>S.includes(L))}function SetIntersectManyResolve(T2,Init){return T2.reduce((Acc,L)=>{return SetIntersect(Acc,L)},Init)}function SetIntersectMany(T2){return T2.length===1?T2[0]:T2.length>1?SetIntersectManyResolve(T2.slice(1),T2[0]):[]}function SetUnionMany(T2){let Acc=[];for(let L of T2)Acc.push(...L);return Acc}function Any(options){return CreateType({[Kind]:"Any"},options)}function Array2(items,options){return CreateType({[Kind]:"Array",type:"array",items},options)}function Argument(index){return CreateType({[Kind]:"Argument",index})}function AsyncIterator(items,options){return CreateType({[Kind]:"AsyncIterator",type:"AsyncIterator",items},options)}function Computed(target,parameters,options){return CreateType({[Kind]:"Computed",target,parameters},options)}function DiscardKey(value,key){let{[key]:_2,...rest}=value;return rest}function Discard(value,keys){return keys.reduce((acc,key)=>DiscardKey(acc,key),value)}function Never(options){return CreateType({[Kind]:"Never",not:{}},options)}function MappedResult(properties){return CreateType({[Kind]:"MappedResult",properties})}function Constructor(parameters,returns,options){return CreateType({[Kind]:"Constructor",type:"Constructor",parameters,returns},options)}function Function2(parameters,returns,options){return CreateType({[Kind]:"Function",type:"Function",parameters,returns},options)}function UnionCreate(T2,options){return CreateType({[Kind]:"Union",anyOf:T2},options)}function IsUnionOptional(types){return types.some((type)=>IsOptional(type))}function RemoveOptionalFromRest(types){return types.map((left)=>IsOptional(left)?RemoveOptionalFromType(left):left)}function RemoveOptionalFromType(T2){return Discard(T2,[OptionalKind])}function ResolveUnion(types,options){return IsUnionOptional(types)?Optional(UnionCreate(RemoveOptionalFromRest(types),options)):UnionCreate(RemoveOptionalFromRest(types),options)}function UnionEvaluated(T2,options){return T2.length===1?CreateType(T2[0],options):T2.length===0?Never(options):ResolveUnion(T2,options)}function Union(types,options){return types.length===0?Never(options):types.length===1?CreateType(types[0],options):UnionCreate(types,options)}class TemplateLiteralParserError extends TypeBoxError{}function Unescape(pattern){return pattern.replace(/\\\$/g,"$").replace(/\\\*/g,"*").replace(/\\\^/g,"^").replace(/\\\|/g,"|").replace(/\\\(/g,"(").replace(/\\\)/g,")")}function IsNonEscaped(pattern,index,char){return pattern[index]===char&&pattern.charCodeAt(index-1)!==92}function IsOpenParen(pattern,index){return IsNonEscaped(pattern,index,"(")}function IsCloseParen(pattern,index){return IsNonEscaped(pattern,index,")")}function IsSeparator(pattern,index){return IsNonEscaped(pattern,index,"|")}function IsGroup(pattern){if(!(IsOpenParen(pattern,0)&&IsCloseParen(pattern,pattern.length-1)))return!1;let count=0;for(let index=0;index<pattern.length;index++){if(IsOpenParen(pattern,index))count+=1;if(IsCloseParen(pattern,index))count-=1;if(count===0&&index!==pattern.length-1)return!1}return!0}function InGroup(pattern){return pattern.slice(1,pattern.length-1)}function IsPrecedenceOr(pattern){let count=0;for(let index=0;index<pattern.length;index++){if(IsOpenParen(pattern,index))count+=1;if(IsCloseParen(pattern,index))count-=1;if(IsSeparator(pattern,index)&&count===0)return!0}return!1}function IsPrecedenceAnd(pattern){for(let index=0;index<pattern.length;index++)if(IsOpenParen(pattern,index))return!0;return!1}function Or(pattern){let[count,start]=[0,0],expressions=[];for(let index=0;index<pattern.length;index++){if(IsOpenParen(pattern,index))count+=1;if(IsCloseParen(pattern,index))count-=1;if(IsSeparator(pattern,index)&&count===0){let range2=pattern.slice(start,index);if(range2.length>0)expressions.push(TemplateLiteralParse(range2));start=index+1}}let range=pattern.slice(start);if(range.length>0)expressions.push(TemplateLiteralParse(range));if(expressions.length===0)return{type:"const",const:""};if(expressions.length===1)return expressions[0];return{type:"or",expr:expressions}}function And(pattern){function Group(value,index){if(!IsOpenParen(value,index))throw new TemplateLiteralParserError("TemplateLiteralParser: Index must point to open parens");let count=0;for(let scan=index;scan<value.length;scan++){if(IsOpenParen(value,scan))count+=1;if(IsCloseParen(value,scan))count-=1;if(count===0)return[index,scan]}throw new TemplateLiteralParserError("TemplateLiteralParser: Unclosed group parens in expression")}function Range(pattern2,index){for(let scan=index;scan<pattern2.length;scan++)if(IsOpenParen(pattern2,scan))return[index,scan];return[index,pattern2.length]}let expressions=[];for(let index=0;index<pattern.length;index++)if(IsOpenParen(pattern,index)){let[start,end]=Group(pattern,index),range=pattern.slice(start,end+1);expressions.push(TemplateLiteralParse(range)),index=end}else{let[start,end]=Range(pattern,index),range=pattern.slice(start,end);if(range.length>0)expressions.push(TemplateLiteralParse(range));index=end-1}return expressions.length===0?{type:"const",const:""}:expressions.length===1?expressions[0]:{type:"and",expr:expressions}}function TemplateLiteralParse(pattern){return IsGroup(pattern)?TemplateLiteralParse(InGroup(pattern)):IsPrecedenceOr(pattern)?Or(pattern):IsPrecedenceAnd(pattern)?And(pattern):{type:"const",const:Unescape(pattern)}}function TemplateLiteralParseExact(pattern){return TemplateLiteralParse(pattern.slice(1,pattern.length-1))}class TemplateLiteralFiniteError extends TypeBoxError{}function IsNumberExpression(expression){return expression.type==="or"&&expression.expr.length===2&&expression.expr[0].type==="const"&&expression.expr[0].const==="0"&&expression.expr[1].type==="const"&&expression.expr[1].const==="[1-9][0-9]*"}function IsBooleanExpression(expression){return expression.type==="or"&&expression.expr.length===2&&expression.expr[0].type==="const"&&expression.expr[0].const==="true"&&expression.expr[1].type==="const"&&expression.expr[1].const==="false"}function IsStringExpression(expression){return expression.type==="const"&&expression.const===".*"}function IsTemplateLiteralExpressionFinite(expression){return IsNumberExpression(expression)||IsStringExpression(expression)?!1:IsBooleanExpression(expression)?!0:expression.type==="and"?expression.expr.every((expr)=>IsTemplateLiteralExpressionFinite(expr)):expression.type==="or"?expression.expr.every((expr)=>IsTemplateLiteralExpressionFinite(expr)):expression.type==="const"?!0:(()=>{throw new TemplateLiteralFiniteError("Unknown expression type")})()}function IsTemplateLiteralFinite(schema){let expression=TemplateLiteralParseExact(schema.pattern);return IsTemplateLiteralExpressionFinite(expression)}class TemplateLiteralGenerateError extends TypeBoxError{}function*GenerateReduce(buffer){if(buffer.length===1)return yield*buffer[0];for(let left of buffer[0])for(let right of GenerateReduce(buffer.slice(1)))yield`${left}${right}`}function*GenerateAnd(expression){return yield*GenerateReduce(expression.expr.map((expr)=>[...TemplateLiteralExpressionGenerate(expr)]))}function*GenerateOr(expression){for(let expr of expression.expr)yield*TemplateLiteralExpressionGenerate(expr)}function*GenerateConst(expression){return yield expression.const}function*TemplateLiteralExpressionGenerate(expression){return expression.type==="and"?yield*GenerateAnd(expression):expression.type==="or"?yield*GenerateOr(expression):expression.type==="const"?yield*GenerateConst(expression):(()=>{throw new TemplateLiteralGenerateError("Unknown expression")})()}function TemplateLiteralGenerate(schema){let expression=TemplateLiteralParseExact(schema.pattern);return IsTemplateLiteralExpressionFinite(expression)?[...TemplateLiteralExpressionGenerate(expression)]:[]}function Literal(value,options){return CreateType({[Kind]:"Literal",const:value,type:typeof value},options)}function Boolean2(options){return CreateType({[Kind]:"Boolean",type:"boolean"},options)}function BigInt2(options){return CreateType({[Kind]:"BigInt",type:"bigint"},options)}function Number2(options){return CreateType({[Kind]:"Number",type:"number"},options)}function String2(options){return CreateType({[Kind]:"String",type:"string"},options)}function*FromUnion(syntax){let trim=syntax.trim().replace(/"|'/g,"");return trim==="boolean"?yield Boolean2():trim==="number"?yield Number2():trim==="bigint"?yield BigInt2():trim==="string"?yield String2():yield(()=>{let literals=trim.split("|").map((literal)=>Literal(literal.trim()));return literals.length===0?Never():literals.length===1?literals[0]:UnionEvaluated(literals)})()}function*FromTerminal(syntax){if(syntax[1]!=="{"){let L=Literal("$"),R=FromSyntax(syntax.slice(1));return yield*[L,...R]}for(let i=2;i<syntax.length;i++)if(syntax[i]==="}"){let L=FromUnion(syntax.slice(2,i)),R=FromSyntax(syntax.slice(i+1));return yield*[...L,...R]}yield Literal(syntax)}function*FromSyntax(syntax){for(let i=0;i<syntax.length;i++)if(syntax[i]==="$"){let L=Literal(syntax.slice(0,i)),R=FromTerminal(syntax.slice(i));return yield*[L,...R]}yield Literal(syntax)}function TemplateLiteralSyntax(syntax){return[...FromSyntax(syntax)]}class TemplateLiteralPatternError extends TypeBoxError{}function Escape(value){return value.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Visit2(schema,acc){return IsTemplateLiteral(schema)?schema.pattern.slice(1,schema.pattern.length-1):IsUnion(schema)?`(${schema.anyOf.map((schema2)=>Visit2(schema2,acc)).join("|")})`:IsNumber3(schema)?`${acc}${PatternNumber}`:IsInteger2(schema)?`${acc}${PatternNumber}`:IsBigInt3(schema)?`${acc}${PatternNumber}`:IsString3(schema)?`${acc}${PatternString}`:IsLiteral(schema)?`${acc}${Escape(schema.const.toString())}`:IsBoolean3(schema)?`${acc}${PatternBoolean}`:(()=>{throw new TemplateLiteralPatternError(`Unexpected Kind '${schema[Kind]}'`)})()}function TemplateLiteralPattern(kinds){return`^${kinds.map((schema)=>Visit2(schema,"")).join("")}$`}function TemplateLiteralToUnion(schema){let L=TemplateLiteralGenerate(schema).map((S)=>Literal(S));return UnionEvaluated(L)}function TemplateLiteral(unresolved,options){let pattern=IsString(unresolved)?TemplateLiteralPattern(TemplateLiteralSyntax(unresolved)):TemplateLiteralPattern(unresolved);return CreateType({[Kind]:"TemplateLiteral",type:"string",pattern},options)}function FromTemplateLiteral(templateLiteral){return TemplateLiteralGenerate(templateLiteral).map((key)=>key.toString())}function FromUnion2(types){let result=[];for(let type of types)result.push(...IndexPropertyKeys(type));return result}function FromLiteral(literalValue){return[literalValue.toString()]}function IndexPropertyKeys(type){return[...new Set(IsTemplateLiteral(type)?FromTemplateLiteral(type):IsUnion(type)?FromUnion2(type.anyOf):IsLiteral(type)?FromLiteral(type.const):IsNumber3(type)?["[number]"]:IsInteger2(type)?["[number]"]:[])]}function FromProperties(type,properties,options){let result={};for(let K2 of Object.getOwnPropertyNames(properties))result[K2]=Index(type,IndexPropertyKeys(properties[K2]),options);return result}function FromMappedResult(type,mappedResult,options){return FromProperties(type,mappedResult.properties,options)}function IndexFromMappedResult(type,mappedResult,options){let properties=FromMappedResult(type,mappedResult,options);return MappedResult(properties)}function FromRest(types,key){return types.map((type)=>IndexFromPropertyKey(type,key))}function FromIntersectRest(types){return types.filter((type)=>!IsNever(type))}function FromIntersect(types,key){return IntersectEvaluated(FromIntersectRest(FromRest(types,key)))}function FromUnionRest(types){return types.some((L)=>IsNever(L))?[]:types}function FromUnion3(types,key){return UnionEvaluated(FromUnionRest(FromRest(types,key)))}function FromTuple(types,key){return key in types?types[key]:key==="[number]"?UnionEvaluated(types):Never()}function FromArray(type,key){return key==="[number]"?type:Never()}function FromProperty(properties,propertyKey){return propertyKey in properties?properties[propertyKey]:Never()}function IndexFromPropertyKey(type,propertyKey){return IsIntersect(type)?FromIntersect(type.allOf,propertyKey):IsUnion(type)?FromUnion3(type.anyOf,propertyKey):IsTuple(type)?FromTuple(type.items??[],propertyKey):IsArray3(type)?FromArray(type.items,propertyKey):IsObject3(type)?FromProperty(type.properties,propertyKey):Never()}function IndexFromPropertyKeys(type,propertyKeys){return propertyKeys.map((propertyKey)=>IndexFromPropertyKey(type,propertyKey))}function FromSchema(type,propertyKeys){return UnionEvaluated(IndexFromPropertyKeys(type,propertyKeys))}function Index(type,key,options){if(IsRef(type)||IsRef(key)){if(!IsSchema(type)||!IsSchema(key))throw new TypeBoxError("Index types using Ref parameters require both Type and Key to be of TSchema");return Computed("Index",[type,key])}if(IsMappedResult(key))return IndexFromMappedResult(type,key,options);if(IsMappedKey(key))return IndexFromMappedKey(type,key,options);return CreateType(IsSchema(key)?FromSchema(type,IndexPropertyKeys(key)):FromSchema(type,key),options)}function MappedIndexPropertyKey(type,key,options){return{[key]:Index(type,[key],Clone(options))}}function MappedIndexPropertyKeys(type,propertyKeys,options){return propertyKeys.reduce((result,left)=>{return{...result,...MappedIndexPropertyKey(type,left,options)}},{})}function MappedIndexProperties(type,mappedKey,options){return MappedIndexPropertyKeys(type,mappedKey.keys,options)}function IndexFromMappedKey(type,mappedKey,options){let properties=MappedIndexProperties(type,mappedKey,options);return MappedResult(properties)}function Iterator(items,options){return CreateType({[Kind]:"Iterator",type:"Iterator",items},options)}function RequiredKeys(properties){let keys=[];for(let key in properties)if(!IsOptional(properties[key]))keys.push(key);return keys}function _Object(properties,options){let required=RequiredKeys(properties),schematic=required.length>0?{[Kind]:"Object",type:"object",properties,required}:{[Kind]:"Object",type:"object",properties};return CreateType(schematic,options)}var Object2=_Object;function Promise2(item,options){return CreateType({[Kind]:"Promise",type:"Promise",item},options)}function RemoveReadonly(schema){return CreateType(Discard(schema,[ReadonlyKind]))}function AddReadonly(schema){return CreateType({...schema,[ReadonlyKind]:"Readonly"})}function ReadonlyWithFlag(schema,F){return F===!1?RemoveReadonly(schema):AddReadonly(schema)}function Readonly(schema,enable){let F=enable??!0;return IsMappedResult(schema)?ReadonlyFromMappedResult(schema,F):ReadonlyWithFlag(schema,F)}function FromProperties2(K,F){let Acc={};for(let K2 of globalThis.Object.getOwnPropertyNames(K))Acc[K2]=Readonly(K[K2],F);return Acc}function FromMappedResult2(R,F){return FromProperties2(R.properties,F)}function ReadonlyFromMappedResult(R,F){let P=FromMappedResult2(R,F);return MappedResult(P)}function Tuple(types,options){return CreateType(types.length>0?{[Kind]:"Tuple",type:"array",items:types,additionalItems:!1,minItems:types.length,maxItems:types.length}:{[Kind]:"Tuple",type:"array",minItems:types.length,maxItems:types.length},options)}function FromMappedResult3(K,P){return K in P?FromSchemaType(K,P[K]):MappedResult(P)}function MappedKeyToKnownMappedResultProperties(K){return{[K]:Literal(K)}}function MappedKeyToUnknownMappedResultProperties(P){let Acc={};for(let L of P)Acc[L]=Literal(L);return Acc}function MappedKeyToMappedResultProperties(K,P){return SetIncludes(P,K)?MappedKeyToKnownMappedResultProperties(K):MappedKeyToUnknownMappedResultProperties(P)}function FromMappedKey(K,P){let R=MappedKeyToMappedResultProperties(K,P);return FromMappedResult3(K,R)}function FromRest2(K,T2){return T2.map((L)=>FromSchemaType(K,L))}function FromProperties3(K,T2){let Acc={};for(let K2 of globalThis.Object.getOwnPropertyNames(T2))Acc[K2]=FromSchemaType(K,T2[K2]);return Acc}function FromSchemaType(K,T2){let options={...T2};return IsOptional(T2)?Optional(FromSchemaType(K,Discard(T2,[OptionalKind]))):IsReadonly(T2)?Readonly(FromSchemaType(K,Discard(T2,[ReadonlyKind]))):IsMappedResult(T2)?FromMappedResult3(K,T2.properties):IsMappedKey(T2)?FromMappedKey(K,T2.keys):IsConstructor(T2)?Constructor(FromRest2(K,T2.parameters),FromSchemaType(K,T2.returns),options):IsFunction3(T2)?Function2(FromRest2(K,T2.parameters),FromSchemaType(K,T2.returns),options):IsAsyncIterator3(T2)?AsyncIterator(FromSchemaType(K,T2.items),options):IsIterator3(T2)?Iterator(FromSchemaType(K,T2.items),options):IsIntersect(T2)?Intersect(FromRest2(K,T2.allOf),options):IsUnion(T2)?Union(FromRest2(K,T2.anyOf),options):IsTuple(T2)?Tuple(FromRest2(K,T2.items??[]),options):IsObject3(T2)?Object2(FromProperties3(K,T2.properties),options):IsArray3(T2)?Array2(FromSchemaType(K,T2.items),options):IsPromise2(T2)?Promise2(FromSchemaType(K,T2.item),options):T2}function MappedFunctionReturnType(K,T2){let Acc={};for(let L of K)Acc[L]=FromSchemaType(L,T2);return Acc}function Mapped(key,map3,options){let K=IsSchema(key)?IndexPropertyKeys(key):key,RT=map3({[Kind]:"MappedKey",keys:K}),R=MappedFunctionReturnType(K,RT);return Object2(R,options)}function RemoveOptional(schema){return CreateType(Discard(schema,[OptionalKind]))}function AddOptional(schema){return CreateType({...schema,[OptionalKind]:"Optional"})}function OptionalWithFlag(schema,F){return F===!1?RemoveOptional(schema):AddOptional(schema)}function Optional(schema,enable){let F=enable??!0;return IsMappedResult(schema)?OptionalFromMappedResult(schema,F):OptionalWithFlag(schema,F)}function FromProperties4(P,F){let Acc={};for(let K2 of globalThis.Object.getOwnPropertyNames(P))Acc[K2]=Optional(P[K2],F);return Acc}function FromMappedResult4(R,F){return FromProperties4(R.properties,F)}function OptionalFromMappedResult(R,F){let P=FromMappedResult4(R,F);return MappedResult(P)}function IntersectCreate(T2,options={}){let allObjects=T2.every((schema)=>IsObject3(schema)),clonedUnevaluatedProperties=IsSchema(options.unevaluatedProperties)?{unevaluatedProperties:options.unevaluatedProperties}:{};return CreateType(options.unevaluatedProperties===!1||IsSchema(options.unevaluatedProperties)||allObjects?{...clonedUnevaluatedProperties,[Kind]:"Intersect",type:"object",allOf:T2}:{...clonedUnevaluatedProperties,[Kind]:"Intersect",allOf:T2},options)}function IsIntersectOptional(types){return types.every((left)=>IsOptional(left))}function RemoveOptionalFromType2(type){return Discard(type,[OptionalKind])}function RemoveOptionalFromRest2(types){return types.map((left)=>IsOptional(left)?RemoveOptionalFromType2(left):left)}function ResolveIntersect(types,options){return IsIntersectOptional(types)?Optional(IntersectCreate(RemoveOptionalFromRest2(types),options)):IntersectCreate(RemoveOptionalFromRest2(types),options)}function IntersectEvaluated(types,options={}){if(types.length===1)return CreateType(types[0],options);if(types.length===0)return Never(options);if(types.some((schema)=>IsTransform(schema)))throw new Error("Cannot intersect transform types");return ResolveIntersect(types,options)}function Intersect(types,options){if(types.length===1)return CreateType(types[0],options);if(types.length===0)return Never(options);if(types.some((schema)=>IsTransform(schema)))throw new Error("Cannot intersect transform types");return IntersectCreate(types,options)}function Ref(...args){let[$ref,options]=typeof args[0]==="string"?[args[0],args[1]]:[args[0].$id,args[1]];if(typeof $ref!=="string")throw new TypeBoxError("Ref: $ref must be a string");return CreateType({[Kind]:"Ref",$ref},options)}function FromComputed(target,parameters){return Computed("Awaited",[Computed(target,parameters)])}function FromRef($ref){return Computed("Awaited",[Ref($ref)])}function FromIntersect2(types){return Intersect(FromRest3(types))}function FromUnion4(types){return Union(FromRest3(types))}function FromPromise(type){return Awaited(type)}function FromRest3(types){return types.map((type)=>Awaited(type))}function Awaited(type,options){return CreateType(IsComputed(type)?FromComputed(type.target,type.parameters):IsIntersect(type)?FromIntersect2(type.allOf):IsUnion(type)?FromUnion4(type.anyOf):IsPromise2(type)?FromPromise(type.item):IsRef(type)?FromRef(type.$ref):type,options)}function FromRest4(types){let result=[];for(let L of types)result.push(KeyOfPropertyKeys(L));return result}function FromIntersect3(types){let propertyKeysArray=FromRest4(types);return SetUnionMany(propertyKeysArray)}function FromUnion5(types){let propertyKeysArray=FromRest4(types);return SetIntersectMany(propertyKeysArray)}function FromTuple2(types){return types.map((_2,indexer)=>indexer.toString())}function FromArray2(_2){return["[number]"]}function FromProperties5(T2){return globalThis.Object.getOwnPropertyNames(T2)}function FromPatternProperties(patternProperties){if(!includePatternProperties)return[];return globalThis.Object.getOwnPropertyNames(patternProperties).map((key)=>{return key[0]==="^"&&key[key.length-1]==="$"?key.slice(1,key.length-1):key})}function KeyOfPropertyKeys(type){return IsIntersect(type)?FromIntersect3(type.allOf):IsUnion(type)?FromUnion5(type.anyOf):IsTuple(type)?FromTuple2(type.items??[]):IsArray3(type)?FromArray2(type.items):IsObject3(type)?FromProperties5(type.properties):IsRecord(type)?FromPatternProperties(type.patternProperties):[]}var includePatternProperties=!1;function KeyOfPattern(schema){includePatternProperties=!0;let keys=KeyOfPropertyKeys(schema);return includePatternProperties=!1,`^(${keys.map((key)=>`(${key})`).join("|")})$`}function FromComputed2(target,parameters){return Computed("KeyOf",[Computed(target,parameters)])}function FromRef2($ref){return Computed("KeyOf",[Ref($ref)])}function KeyOfFromType(type,options){let propertyKeys=KeyOfPropertyKeys(type),propertyKeyTypes=KeyOfPropertyKeysToRest(propertyKeys),result=UnionEvaluated(propertyKeyTypes);return CreateType(result,options)}function KeyOfPropertyKeysToRest(propertyKeys){return propertyKeys.map((L)=>L==="[number]"?Number2():Literal(L))}function KeyOf(type,options){return IsComputed(type)?FromComputed2(type.target,type.parameters):IsRef(type)?FromRef2(type.$ref):IsMappedResult(type)?KeyOfFromMappedResult(type,options):KeyOfFromType(type,options)}function FromProperties6(properties,options){let result={};for(let K2 of globalThis.Object.getOwnPropertyNames(properties))result[K2]=KeyOf(properties[K2],Clone(options));return result}function FromMappedResult5(mappedResult,options){return FromProperties6(mappedResult.properties,options)}function KeyOfFromMappedResult(mappedResult,options){let properties=FromMappedResult5(mappedResult,options);return MappedResult(properties)}function KeyOfPropertyEntries(schema){let keys=KeyOfPropertyKeys(schema),schemas=IndexFromPropertyKeys(schema,keys);return keys.map((_2,index)=>[keys[index],schemas[index]])}function CompositeKeys(T2){let Acc=[];for(let L of T2)Acc.push(...KeyOfPropertyKeys(L));return SetDistinct(Acc)}function FilterNever(T2){return T2.filter((L)=>!IsNever(L))}function CompositeProperty(T2,K){let Acc=[];for(let L of T2)Acc.push(...IndexFromPropertyKeys(L,[K]));return FilterNever(Acc)}function CompositeProperties(T2,K){let Acc={};for(let L of K)Acc[L]=IntersectEvaluated(CompositeProperty(T2,L));return Acc}function Composite(T2,options){let K=CompositeKeys(T2),P=CompositeProperties(T2,K);return Object2(P,options)}function Date2(options){return CreateType({[Kind]:"Date",type:"Date"},options)}function Null(options){return CreateType({[Kind]:"Null",type:"null"},options)}function Symbol2(options){return CreateType({[Kind]:"Symbol",type:"symbol"},options)}function Undefined(options){return CreateType({[Kind]:"Undefined",type:"undefined"},options)}function Uint8Array2(options){return CreateType({[Kind]:"Uint8Array",type:"Uint8Array"},options)}function Unknown(options){return CreateType({[Kind]:"Unknown"},options)}function FromArray3(T2){return T2.map((L)=>FromValue(L,!1))}function FromProperties7(value){let Acc={};for(let K of globalThis.Object.getOwnPropertyNames(value))Acc[K]=Readonly(FromValue(value[K],!1));return Acc}function ConditionalReadonly(T2,root){return root===!0?T2:Readonly(T2)}function FromValue(value,root){return IsAsyncIterator(value)?ConditionalReadonly(Any(),root):IsIterator(value)?ConditionalReadonly(Any(),root):IsArray(value)?Readonly(Tuple(FromArray3(value))):IsUint8Array(value)?Uint8Array2():IsDate(value)?Date2():IsObject(value)?ConditionalReadonly(Object2(FromProperties7(value)),root):IsFunction(value)?ConditionalReadonly(Function2([],Unknown()),root):IsUndefined(value)?Undefined():IsNull(value)?Null():IsSymbol(value)?Symbol2():IsBigInt(value)?BigInt2():IsNumber(value)?Literal(value):IsBoolean(value)?Literal(value):IsString(value)?Literal(value):Object2({})}function Const(T2,options){return CreateType(FromValue(T2,!0),options)}function ConstructorParameters(schema,options){return IsConstructor(schema)?Tuple(schema.parameters,options):Never(options)}function Enum(item,options){if(IsUndefined(item))throw new Error("Enum undefined or empty");let values1=globalThis.Object.getOwnPropertyNames(item).filter((key)=>isNaN(key)).map((key)=>item[key]),anyOf=[...new Set(values1)].map((value)=>Literal(value));return Union(anyOf,{...options,[Hint]:"Enum"})}class ExtendsResolverError extends TypeBoxError{}var ExtendsResult;(function(ExtendsResult2){ExtendsResult2[ExtendsResult2.Union=0]="Union",ExtendsResult2[ExtendsResult2.True=1]="True",ExtendsResult2[ExtendsResult2.False=2]="False"})(ExtendsResult||(ExtendsResult={}));function IntoBooleanResult(result){return result===ExtendsResult.False?result:ExtendsResult.True}function Throw(message){throw new ExtendsResolverError(message)}function IsStructuralRight(right){return exports_type.IsNever(right)||exports_type.IsIntersect(right)||exports_type.IsUnion(right)||exports_type.IsUnknown(right)||exports_type.IsAny(right)}function StructuralRight(left,right){return exports_type.IsNever(right)?FromNeverRight(left,right):exports_type.IsIntersect(right)?FromIntersectRight(left,right):exports_type.IsUnion(right)?FromUnionRight(left,right):exports_type.IsUnknown(right)?FromUnknownRight(left,right):exports_type.IsAny(right)?FromAnyRight(left,right):Throw("StructuralRight")}function FromAnyRight(left,right){return ExtendsResult.True}function FromAny(left,right){return exports_type.IsIntersect(right)?FromIntersectRight(left,right):exports_type.IsUnion(right)&&right.anyOf.some((schema)=>exports_type.IsAny(schema)||exports_type.IsUnknown(schema))?ExtendsResult.True:exports_type.IsUnion(right)?ExtendsResult.Union:exports_type.IsUnknown(right)?ExtendsResult.True:exports_type.IsAny(right)?ExtendsResult.True:ExtendsResult.Union}function FromArrayRight(left,right){return exports_type.IsUnknown(left)?ExtendsResult.False:exports_type.IsAny(left)?ExtendsResult.Union:exports_type.IsNever(left)?ExtendsResult.True:ExtendsResult.False}function FromArray4(left,right){return exports_type.IsObject(right)&&IsObjectArrayLike(right)?ExtendsResult.True:IsStructuralRight(right)?StructuralRight(left,right):!exports_type.IsArray(right)?ExtendsResult.False:IntoBooleanResult(Visit3(left.items,right.items))}function FromAsyncIterator(left,right){return IsStructuralRight(right)?StructuralRight(left,right):!exports_type.IsAsyncIterator(right)?ExtendsResult.False:IntoBooleanResult(Visit3(left.items,right.items))}function FromBigInt(left,right){return IsStructuralRight(right)?StructuralRight(left,right):exports_type.IsObject(right)?FromObjectRight(left,right):exports_type.IsRecord(right)?FromRecordRight(left,right):exports_type.IsBigInt(right)?ExtendsResult.True:ExtendsResult.False}function FromBooleanRight(left,right){return exports_type.IsLiteralBoolean(left)?ExtendsResult.True:exports_type.IsBoolean(left)?ExtendsResult.True:ExtendsResult.False}function FromBoolean(left,right){return IsStructuralRight(right)?StructuralRight(left,right):exports_type.IsObject(right)?FromObjectRight(left,right):exports_type.IsRecord(right)?FromRecordRight(left,right):exports_type.IsBoolean(right)?ExtendsResult.True:ExtendsResult.False}function FromConstructor(left,right){return IsStructuralRight(right)?StructuralRight(left,right):exports_type.IsObject(right)?FromObjectRight(left,right):!exports_type.IsConstructor(right)?ExtendsResult.False:left.parameters.length>right.parameters.length?ExtendsResult.False:!left.parameters.every((schema,index)=>IntoBooleanResult(Visit3(right.parameters[index],schema))===ExtendsResult.True)?ExtendsResult.False:IntoBooleanResult(Visit3(left.returns,right.returns))}function FromDate(left,right){return IsStructuralRight(right)?StructuralRight(left,right):exports_type.IsObject(right)?FromObjectRight(left,right):exports_type.IsRecord(right)?FromRecordRight(left,right):exports_type.IsDate(right)?ExtendsResult.True:ExtendsResult.False}function FromFunction(left,right){return IsStructuralRight(right)?StructuralRight(left,right):exports_type.IsObject(right)?FromObjectRight(left,right):!exports_type.IsFunction(right)?ExtendsResult.False:left.parameters.length>right.parameters.length?ExtendsResult.False:!left.parameters.every((schema,index)=>IntoBooleanResult(Visit3(right.parameters[index],schema))===ExtendsResult.True)?ExtendsResult.False:IntoBooleanResult(Visit3(left.returns,right.returns))}function FromIntegerRight(left,right){return exports_type.IsLiteral(left)&&exports_value.IsNumber(left.const)?ExtendsResult.True:exports_type.IsNumber(left)||exports_type.IsInteger(left)?ExtendsResult.True:ExtendsResult.False}function FromInteger(left,right){return exports_type.IsInteger(right)||exports_type.IsNumber(right)?ExtendsResult.True:IsStructuralRight(right)?StructuralRight(left,right):exports_type.IsObject(right)?FromObjectRight(left,right):exports_type.IsRecord(right)?FromRecordRight(left,right):ExtendsResult.False}function FromIntersectRight(left,right){return right.allOf.every((schema)=>Visit3(left,schema)===ExtendsResult.True)?ExtendsResult.True:ExtendsResult.False}function FromIntersect4(left,right){return left.allOf.some((schema)=>Visit3(schema,right)===ExtendsResult.True)?ExtendsResult.True:ExtendsResult.False}function FromIterator(left,right){return IsStructuralRight(right)?StructuralRight(left,right):!exports_type.IsIterator(right)?ExtendsResult.False:IntoBooleanResult(Visit3(left.items,right.items))}function FromLiteral2(left,right){return exports_type.IsLiteral(right)&&right.const===left.const?ExtendsResult.True:IsStructuralRight(right)?StructuralRight(left,right):exports_type.IsObject(right)?FromObjectRight(left,right):exports_type.IsRecord(right)?FromRecordRight(left,right):exports_type.IsString(right)?FromStringRight(left,right):exports_type.IsNumber(right)?FromNumberRight(left,right):exports_type.IsInteger(right)?FromIntegerRight(left,right):exports_type.IsBoolean(right)?FromBooleanRight(left,right):ExtendsResult.False}function FromNeverRight(left,right){return ExtendsResult.False}function FromNever(left,right){return ExtendsResult.True}function UnwrapTNot(schema){let[current,depth]=[schema,0];while(!0){if(!exports_type.IsNot(current))break;current=current.not,depth+=1}return depth%2===0?current:Unknown()}function FromNot(left,right){return exports_type.IsNot(left)?Visit3(UnwrapTNot(left),right):exports_type.IsNot(right)?Visit3(left,UnwrapTNot(right)):Throw("Invalid fallthrough for Not")}function FromNull(left,right){return IsStructuralRight(right)?StructuralRight(left,right):exports_type.IsObject(right)?FromObjectRight(left,right):exports_type.IsRecord(right)?FromRecordRight(left,right):exports_type.IsNull(right)?ExtendsResult.True:ExtendsResult.False}function FromNumberRight(left,right){return exports_type.IsLiteralNumber(left)?ExtendsResult.True:exports_type.IsNumber(left)||exports_type.IsInteger(left)?ExtendsResult.True:ExtendsResult.False}function FromNumber(left,right){return IsStructuralRight(right)?StructuralRight(left,right):exports_type.IsObject(right)?FromObjectRight(left,right):exports_type.IsRecord(right)?FromRecordRight(left,right):exports_type.IsInteger(right)||exports_type.IsNumber(right)?ExtendsResult.True:ExtendsResult.False}function IsObjectPropertyCount(schema,count){return Object.getOwnPropertyNames(schema.properties).length===count}function IsObjectStringLike(schema){return IsObjectArrayLike(schema)}function IsObjectSymbolLike(schema){return IsObjectPropertyCount(schema,0)||IsObjectPropertyCount(schema,1)&&"description"in schema.properties&&exports_type.IsUnion(schema.properties.description)&&schema.properties.description.anyOf.length===2&&(exports_type.IsString(schema.properties.description.anyOf[0])&&exports_type.IsUndefined(schema.properties.description.anyOf[1])||exports_type.IsString(schema.properties.description.anyOf[1])&&exports_type.IsUndefined(schema.properties.description.anyOf[0]))}function IsObjectNumberLike(schema){return IsObjectPropertyCount(schema,0)}function IsObjectBooleanLike(schema){return IsObjectPropertyCount(schema,0)}function IsObjectBigIntLike(schema){return IsObjectPropertyCount(schema,0)}function IsObjectDateLike(schema){return IsObjectPropertyCount(schema,0)}function IsObjectUint8ArrayLike(schema){return IsObjectArrayLike(schema)}function IsObjectFunctionLike(schema){let length=Number2();return IsObjectPropertyCount(schema,0)||IsObjectPropertyCount(schema,1)&&"length"in schema.properties&&IntoBooleanResult(Visit3(schema.properties.length,length))===ExtendsResult.True}function IsObjectConstructorLike(schema){return IsObjectPropertyCount(schema,0)}function IsObjectArrayLike(schema){let length=Number2();return IsObjectPropertyCount(schema,0)||IsObjectPropertyCount(schema,1)&&"length"in schema.properties&&IntoBooleanResult(Visit3(schema.properties.length,length))===ExtendsResult.True}function IsObjectPromiseLike(schema){let then=Function2([Any()],Any());return IsObjectPropertyCount(schema,0)||IsObjectPropertyCount(schema,1)&&"then"in schema.properties&&IntoBooleanResult(Visit3(schema.properties.then,then))===ExtendsResult.True}function Property(left,right){return Visit3(left,right)===ExtendsResult.False?ExtendsResult.False:exports_type.IsOptional(left)&&!exports_type.IsOptional(right)?ExtendsResult.False:ExtendsResult.True}function FromObjectRight(left,right){return exports_type.IsUnknown(left)?ExtendsResult.False:exports_type.IsAny(left)?ExtendsResult.Union:exports_type.IsNever(left)||exports_type.IsLiteralString(left)&&IsObjectStringLike(right)||exports_type.IsLiteralNumber(left)&&IsObjectNumberLike(right)||exports_type.IsLiteralBoolean(left)&&IsObjectBooleanLike(right)||exports_type.IsSymbol(left)&&IsObjectSymbolLike(right)||exports_type.IsBigInt(left)&&IsObjectBigIntLike(right)||exports_type.IsString(left)&&IsObjectStringLike(right)||exports_type.IsSymbol(left)&&IsObjectSymbolLike(right)||exports_type.IsNumber(left)&&IsObjectNumberLike(right)||exports_type.IsInteger(left)&&IsObjectNumberLike(right)||exports_type.IsBoolean(left)&&IsObjectBooleanLike(right)||exports_type.IsUint8Array(left)&&IsObjectUint8ArrayLike(right)||exports_type.IsDate(left)&&IsObjectDateLike(right)||exports_type.IsConstructor(left)&&IsObjectConstructorLike(right)||exports_type.IsFunction(left)&&IsObjectFunctionLike(right)?ExtendsResult.True:exports_type.IsRecord(left)&&exports_type.IsString(RecordKey(left))?(()=>{return right[Hint]==="Record"?ExtendsResult.True:ExtendsResult.False})():exports_type.IsRecord(left)&&exports_type.IsNumber(RecordKey(left))?(()=>{return IsObjectPropertyCount(right,0)?ExtendsResult.True:ExtendsResult.False})():ExtendsResult.False}function FromObject(left,right){return IsStructuralRight(right)?StructuralRight(left,right):exports_type.IsRecord(right)?FromRecordRight(left,right):!exports_type.IsObject(right)?ExtendsResult.False:(()=>{for(let key of Object.getOwnPropertyNames(right.properties)){if(!(key in left.properties)&&!exports_type.IsOptional(right.properties[key]))return ExtendsResult.False;if(exports_type.IsOptional(right.properties[key]))return ExtendsResult.True;if(Property(left.properties[key],right.properties[key])===ExtendsResult.False)return ExtendsResult.False}return ExtendsResult.True})()}function FromPromise2(left,right){return IsStructuralRight(right)?StructuralRight(left,right):exports_type.IsObject(right)&&IsObjectPromiseLike(right)?ExtendsResult.True:!exports_type.IsPromise(right)?ExtendsResult.False:IntoBooleanResult(Visit3(left.item,right.item))}function RecordKey(schema){return PatternNumberExact in schema.patternProperties?Number2():(PatternStringExact in schema.patternProperties)?String2():Throw("Unknown record key pattern")}function RecordValue(schema){return PatternNumberExact in schema.patternProperties?schema.patternProperties[PatternNumberExact]:(PatternStringExact in schema.patternProperties)?schema.patternProperties[PatternStringExact]:Throw("Unable to get record value schema")}function FromRecordRight(left,right){let[Key,Value]=[RecordKey(right),RecordValue(right)];return exports_type.IsLiteralString(left)&&exports_type.IsNumber(Key)&&IntoBooleanResult(Visit3(left,Value))===ExtendsResult.True?ExtendsResult.True:exports_type.IsUint8Array(left)&&exports_type.IsNumber(Key)?Visit3(left,Value):exports_type.IsString(left)&&exports_type.IsNumber(Key)?Visit3(left,Value):exports_type.IsArray(left)&&exports_type.IsNumber(Key)?Visit3(left,Value):exports_type.IsObject(left)?(()=>{for(let key of Object.getOwnPropertyNames(left.properties))if(Property(Value,left.properties[key])===ExtendsResult.False)return ExtendsResult.False;return ExtendsResult.True})():ExtendsResult.False}function FromRecord(left,right){return IsStructuralRight(right)?StructuralRight(left,right):exports_type.IsObject(right)?FromObjectRight(left,right):!exports_type.IsRecord(right)?ExtendsResult.False:Visit3(RecordValue(left),RecordValue(right))}function FromRegExp(left,right){let L=exports_type.IsRegExp(left)?String2():left,R=exports_type.IsRegExp(right)?String2():right;return Visit3(L,R)}function FromStringRight(left,right){return exports_type.IsLiteral(left)&&exports_value.IsString(left.const)?ExtendsResult.True:exports_type.IsString(left)?ExtendsResult.True:ExtendsResult.False}function FromString(left,right){return IsStructuralRight(right)?StructuralRight(left,right):exports_type.IsObject(right)?FromObjectRight(left,right):exports_type.IsRecord(right)?FromRecordRight(left,right):exports_type.IsString(right)?ExtendsResult.True:ExtendsResult.False}function FromSymbol(left,right){return IsStructuralRight(right)?StructuralRight(left,right):exports_type.IsObject(right)?FromObjectRight(left,right):exports_type.IsRecord(right)?FromRecordRight(left,right):exports_type.IsSymbol(right)?ExtendsResult.True:ExtendsResult.False}function FromTemplateLiteral2(left,right){return exports_type.IsTemplateLiteral(left)?Visit3(TemplateLiteralToUnion(left),right):exports_type.IsTemplateLiteral(right)?Visit3(left,TemplateLiteralToUnion(right)):Throw("Invalid fallthrough for TemplateLiteral")}function IsArrayOfTuple(left,right){return exports_type.IsArray(right)&&left.items!==void 0&&left.items.every((schema)=>Visit3(schema,right.items)===ExtendsResult.True)}function FromTupleRight(left,right){return exports_type.IsNever(left)?ExtendsResult.True:exports_type.IsUnknown(left)?ExtendsResult.False:exports_type.IsAny(left)?ExtendsResult.Union:ExtendsResult.False}function FromTuple3(left,right){return IsStructuralRight(right)?StructuralRight(left,right):exports_type.IsObject(right)&&IsObjectArrayLike(right)?ExtendsResult.True:exports_type.IsArray(right)&&IsArrayOfTuple(left,right)?ExtendsResult.True:!exports_type.IsTuple(right)?ExtendsResult.False:exports_value.IsUndefined(left.items)&&!exports_value.IsUndefined(right.items)||!exports_value.IsUndefined(left.items)&&exports_value.IsUndefined(right.items)?ExtendsResult.False:exports_value.IsUndefined(left.items)&&!exports_value.IsUndefined(right.items)?ExtendsResult.True:left.items.every((schema,index)=>Visit3(schema,right.items[index])===ExtendsResult.True)?ExtendsResult.True:ExtendsResult.False}function FromUint8Array(left,right){return IsStructuralRight(right)?StructuralRight(left,right):exports_type.IsObject(right)?FromObjectRight(left,right):exports_type.IsRecord(right)?FromRecordRight(left,right):exports_type.IsUint8Array(right)?ExtendsResult.True:ExtendsResult.False}function FromUndefined(left,right){return IsStructuralRight(right)?StructuralRight(left,right):exports_type.IsObject(right)?FromObjectRight(left,right):exports_type.IsRecord(right)?FromRecordRight(left,right):exports_type.IsVoid(right)?FromVoidRight(left,right):exports_type.IsUndefined(right)?ExtendsResult.True:ExtendsResult.False}function FromUnionRight(left,right){return right.anyOf.some((schema)=>Visit3(left,schema)===ExtendsResult.True)?ExtendsResult.True:ExtendsResult.False}function FromUnion6(left,right){return left.anyOf.every((schema)=>Visit3(schema,right)===ExtendsResult.True)?ExtendsResult.True:ExtendsResult.False}function FromUnknownRight(left,right){return ExtendsResult.True}function FromUnknown(left,right){return exports_type.IsNever(right)?FromNeverRight(left,right):exports_type.IsIntersect(right)?FromIntersectRight(left,right):exports_type.IsUnion(right)?FromUnionRight(left,right):exports_type.IsAny(right)?FromAnyRight(left,right):exports_type.IsString(right)?FromStringRight(left,right):exports_type.IsNumber(right)?FromNumberRight(left,right):exports_type.IsInteger(right)?FromIntegerRight(left,right):exports_type.IsBoolean(right)?FromBooleanRight(left,right):exports_type.IsArray(right)?FromArrayRight(left,right):exports_type.IsTuple(right)?FromTupleRight(left,right):exports_type.IsObject(right)?FromObjectRight(left,right):exports_type.IsUnknown(right)?ExtendsResult.True:ExtendsResult.False}function FromVoidRight(left,right){return exports_type.IsUndefined(left)?ExtendsResult.True:exports_type.IsUndefined(left)?ExtendsResult.True:ExtendsResult.False}function FromVoid(left,right){return exports_type.IsIntersect(right)?FromIntersectRight(left,right):exports_type.IsUnion(right)?FromUnionRight(left,right):exports_type.IsUnknown(right)?FromUnknownRight(left,right):exports_type.IsAny(right)?FromAnyRight(left,right):exports_type.IsObject(right)?FromObjectRight(left,right):exports_type.IsVoid(right)?ExtendsResult.True:ExtendsResult.False}function Visit3(left,right){return exports_type.IsTemplateLiteral(left)||exports_type.IsTemplateLiteral(right)?FromTemplateLiteral2(left,right):exports_type.IsRegExp(left)||exports_type.IsRegExp(right)?FromRegExp(left,right):exports_type.IsNot(left)||exports_type.IsNot(right)?FromNot(left,right):exports_type.IsAny(left)?FromAny(left,right):exports_type.IsArray(left)?FromArray4(left,right):exports_type.IsBigInt(left)?FromBigInt(left,right):exports_type.IsBoolean(left)?FromBoolean(left,right):exports_type.IsAsyncIterator(left)?FromAsyncIterator(left,right):exports_type.IsConstructor(left)?FromConstructor(left,right):exports_type.IsDate(left)?FromDate(left,right):exports_type.IsFunction(left)?FromFunction(left,right):exports_type.IsInteger(left)?FromInteger(left,right):exports_type.IsIntersect(left)?FromIntersect4(left,right):exports_type.IsIterator(left)?FromIterator(left,right):exports_type.IsLiteral(left)?FromLiteral2(left,right):exports_type.IsNever(left)?FromNever(left,right):exports_type.IsNull(left)?FromNull(left,right):exports_type.IsNumber(left)?FromNumber(left,right):exports_type.IsObject(left)?FromObject(left,right):exports_type.IsRecord(left)?FromRecord(left,right):exports_type.IsString(left)?FromString(left,right):exports_type.IsSymbol(left)?FromSymbol(left,right):exports_type.IsTuple(left)?FromTuple3(left,right):exports_type.IsPromise(left)?FromPromise2(left,right):exports_type.IsUint8Array(left)?FromUint8Array(left,right):exports_type.IsUndefined(left)?FromUndefined(left,right):exports_type.IsUnion(left)?FromUnion6(left,right):exports_type.IsUnknown(left)?FromUnknown(left,right):exports_type.IsVoid(left)?FromVoid(left,right):Throw(`Unknown left type operand '${left[Kind]}'`)}function ExtendsCheck(left,right){return Visit3(left,right)}function FromProperties8(P,Right,True,False,options){let Acc={};for(let K2 of globalThis.Object.getOwnPropertyNames(P))Acc[K2]=Extends(P[K2],Right,True,False,Clone(options));return Acc}function FromMappedResult6(Left,Right,True,False,options){return FromProperties8(Left.properties,Right,True,False,options)}function ExtendsFromMappedResult(Left,Right,True,False,options){let P=FromMappedResult6(Left,Right,True,False,options);return MappedResult(P)}function ExtendsResolve(left,right,trueType,falseType){let R=ExtendsCheck(left,right);return R===ExtendsResult.Union?Union([trueType,falseType]):R===ExtendsResult.True?trueType:falseType}function Extends(L,R,T2,F,options){return IsMappedResult(L)?ExtendsFromMappedResult(L,R,T2,F,options):IsMappedKey(L)?CreateType(ExtendsFromMappedKey(L,R,T2,F,options)):CreateType(ExtendsResolve(L,R,T2,F),options)}function FromPropertyKey(K,U,L,R,options){return{[K]:Extends(Literal(K),U,L,R,Clone(options))}}function FromPropertyKeys(K,U,L,R,options){return K.reduce((Acc,LK)=>{return{...Acc,...FromPropertyKey(LK,U,L,R,options)}},{})}function FromMappedKey2(K,U,L,R,options){return FromPropertyKeys(K.keys,U,L,R,options)}function ExtendsFromMappedKey(T2,U,L,R,options){let P=FromMappedKey2(T2,U,L,R,options);return MappedResult(P)}function Intersect2(schema){return schema.allOf.every((schema2)=>ExtendsUndefinedCheck(schema2))}function Union2(schema){return schema.anyOf.some((schema2)=>ExtendsUndefinedCheck(schema2))}function Not(schema){return!ExtendsUndefinedCheck(schema.not)}function ExtendsUndefinedCheck(schema){return schema[Kind]==="Intersect"?Intersect2(schema):schema[Kind]==="Union"?Union2(schema):schema[Kind]==="Not"?Not(schema):schema[Kind]==="Undefined"?!0:!1}function ExcludeFromTemplateLiteral(L,R){return Exclude(TemplateLiteralToUnion(L),R)}function ExcludeRest(L,R){let excluded=L.filter((inner)=>ExtendsCheck(inner,R)===ExtendsResult.False);return excluded.length===1?excluded[0]:Union(excluded)}function Exclude(L,R,options={}){if(IsTemplateLiteral(L))return CreateType(ExcludeFromTemplateLiteral(L,R),options);if(IsMappedResult(L))return CreateType(ExcludeFromMappedResult(L,R),options);return CreateType(IsUnion(L)?ExcludeRest(L.anyOf,R):ExtendsCheck(L,R)!==ExtendsResult.False?Never():L,options)}function FromProperties9(P,U){let Acc={};for(let K2 of globalThis.Object.getOwnPropertyNames(P))Acc[K2]=Exclude(P[K2],U);return Acc}function FromMappedResult7(R,T2){return FromProperties9(R.properties,T2)}function ExcludeFromMappedResult(R,T2){let P=FromMappedResult7(R,T2);return MappedResult(P)}function ExtractFromTemplateLiteral(L,R){return Extract(TemplateLiteralToUnion(L),R)}function ExtractRest(L,R){let extracted=L.filter((inner)=>ExtendsCheck(inner,R)!==ExtendsResult.False);return extracted.length===1?extracted[0]:Union(extracted)}function Extract(L,R,options){if(IsTemplateLiteral(L))return CreateType(ExtractFromTemplateLiteral(L,R),options);if(IsMappedResult(L))return CreateType(ExtractFromMappedResult(L,R),options);return CreateType(IsUnion(L)?ExtractRest(L.anyOf,R):ExtendsCheck(L,R)!==ExtendsResult.False?L:Never(),options)}function FromProperties10(P,T2){let Acc={};for(let K2 of globalThis.Object.getOwnPropertyNames(P))Acc[K2]=Extract(P[K2],T2);return Acc}function FromMappedResult8(R,T2){return FromProperties10(R.properties,T2)}function ExtractFromMappedResult(R,T2){let P=FromMappedResult8(R,T2);return MappedResult(P)}function InstanceType(schema,options){return IsConstructor(schema)?CreateType(schema.returns,options):Never(options)}function ReadonlyOptional(schema){return Readonly(Optional(schema))}function RecordCreateFromPattern(pattern,T2,options){return CreateType({[Kind]:"Record",type:"object",patternProperties:{[pattern]:T2}},options)}function RecordCreateFromKeys(K,T2,options){let result={};for(let K2 of K)result[K2]=T2;return Object2(result,{...options,[Hint]:"Record"})}function FromTemplateLiteralKey(K,T2,options){return IsTemplateLiteralFinite(K)?RecordCreateFromKeys(IndexPropertyKeys(K),T2,options):RecordCreateFromPattern(K.pattern,T2,options)}function FromUnionKey(key,type,options){return RecordCreateFromKeys(IndexPropertyKeys(Union(key)),type,options)}function FromLiteralKey(key,type,options){return RecordCreateFromKeys([key.toString()],type,options)}function FromRegExpKey(key,type,options){return RecordCreateFromPattern(key.source,type,options)}function FromStringKey(key,type,options){let pattern=IsUndefined(key.pattern)?PatternStringExact:key.pattern;return RecordCreateFromPattern(pattern,type,options)}function FromAnyKey(_2,type,options){return RecordCreateFromPattern(PatternStringExact,type,options)}function FromNeverKey(_key,type,options){return RecordCreateFromPattern(PatternNeverExact,type,options)}function FromBooleanKey(_key,type,options){return Object2({true:type,false:type},options)}function FromIntegerKey(_key,type,options){return RecordCreateFromPattern(PatternNumberExact,type,options)}function FromNumberKey(_2,type,options){return RecordCreateFromPattern(PatternNumberExact,type,options)}function Record(key,type,options={}){return IsUnion(key)?FromUnionKey(key.anyOf,type,options):IsTemplateLiteral(key)?FromTemplateLiteralKey(key,type,options):IsLiteral(key)?FromLiteralKey(key.const,type,options):IsBoolean3(key)?FromBooleanKey(key,type,options):IsInteger2(key)?FromIntegerKey(key,type,options):IsNumber3(key)?FromNumberKey(key,type,options):IsRegExp2(key)?FromRegExpKey(key,type,options):IsString3(key)?FromStringKey(key,type,options):IsAny(key)?FromAnyKey(key,type,options):IsNever(key)?FromNeverKey(key,type,options):Never(options)}function RecordPattern(record){return globalThis.Object.getOwnPropertyNames(record.patternProperties)[0]}function RecordKey2(type){let pattern=RecordPattern(type);return pattern===PatternStringExact?String2():pattern===PatternNumberExact?Number2():String2({pattern})}function RecordValue2(type){return type.patternProperties[RecordPattern(type)]}function FromConstructor2(args,type){return type.parameters=FromTypes(args,type.parameters),type.returns=FromType(args,type.returns),type}function FromFunction2(args,type){return type.parameters=FromTypes(args,type.parameters),type.returns=FromType(args,type.returns),type}function FromIntersect5(args,type){return type.allOf=FromTypes(args,type.allOf),type}function FromUnion7(args,type){return type.anyOf=FromTypes(args,type.anyOf),type}function FromTuple4(args,type){if(IsUndefined(type.items))return type;return type.items=FromTypes(args,type.items),type}function FromArray5(args,type){return type.items=FromType(args,type.items),type}function FromAsyncIterator2(args,type){return type.items=FromType(args,type.items),type}function FromIterator2(args,type){return type.items=FromType(args,type.items),type}function FromPromise3(args,type){return type.item=FromType(args,type.item),type}function FromObject2(args,type){let mappedProperties=FromProperties11(args,type.properties);return{...type,...Object2(mappedProperties)}}function FromRecord2(args,type){let mappedKey=FromType(args,RecordKey2(type)),mappedValue=FromType(args,RecordValue2(type)),result=Record(mappedKey,mappedValue);return{...type,...result}}function FromArgument(args,argument){return argument.index in args?args[argument.index]:Unknown()}function FromProperty2(args,type){let isReadonly=IsReadonly(type),isOptional=IsOptional(type),mapped=FromType(args,type);return isReadonly&&isOptional?ReadonlyOptional(mapped):isReadonly&&!isOptional?Readonly(mapped):!isReadonly&&isOptional?Optional(mapped):mapped}function FromProperties11(args,properties){return globalThis.Object.getOwnPropertyNames(properties).reduce((result,key)=>{return{...result,[key]:FromProperty2(args,properties[key])}},{})}function FromTypes(args,types){return types.map((type)=>FromType(args,type))}function FromType(args,type){return IsConstructor(type)?FromConstructor2(args,type):IsFunction3(type)?FromFunction2(args,type):IsIntersect(type)?FromIntersect5(args,type):IsUnion(type)?FromUnion7(args,type):IsTuple(type)?FromTuple4(args,type):IsArray3(type)?FromArray5(args,type):IsAsyncIterator3(type)?FromAsyncIterator2(args,type):IsIterator3(type)?FromIterator2(args,type):IsPromise2(type)?FromPromise3(args,type):IsObject3(type)?FromObject2(args,type):IsRecord(type)?FromRecord2(args,type):IsArgument(type)?FromArgument(args,type):type}function Instantiate(type,args){return FromType(args,CloneType(type))}function Integer(options){return CreateType({[Kind]:"Integer",type:"integer"},options)}function MappedIntrinsicPropertyKey(K,M,options){return{[K]:Intrinsic(Literal(K),M,Clone(options))}}function MappedIntrinsicPropertyKeys(K,M,options){return K.reduce((Acc,L)=>{return{...Acc,...MappedIntrinsicPropertyKey(L,M,options)}},{})}function MappedIntrinsicProperties(T2,M,options){return MappedIntrinsicPropertyKeys(T2.keys,M,options)}function IntrinsicFromMappedKey(T2,M,options){let P=MappedIntrinsicProperties(T2,M,options);return MappedResult(P)}function ApplyUncapitalize(value){let[first,rest]=[value.slice(0,1),value.slice(1)];return[first.toLowerCase(),rest].join("")}function ApplyCapitalize(value){let[first,rest]=[value.slice(0,1),value.slice(1)];return[first.toUpperCase(),rest].join("")}function ApplyUppercase(value){return value.toUpperCase()}function ApplyLowercase(value){return value.toLowerCase()}function FromTemplateLiteral3(schema,mode,options){let expression=TemplateLiteralParseExact(schema.pattern);if(!IsTemplateLiteralExpressionFinite(expression))return{...schema,pattern:FromLiteralValue(schema.pattern,mode)};let literals=[...TemplateLiteralExpressionGenerate(expression)].map((value)=>Literal(value)),mapped=FromRest5(literals,mode),union=Union(mapped);return TemplateLiteral([union],options)}function FromLiteralValue(value,mode){return typeof value==="string"?mode==="Uncapitalize"?ApplyUncapitalize(value):mode==="Capitalize"?ApplyCapitalize(value):mode==="Uppercase"?ApplyUppercase(value):mode==="Lowercase"?ApplyLowercase(value):value:value.toString()}function FromRest5(T2,M){return T2.map((L)=>Intrinsic(L,M))}function Intrinsic(schema,mode,options={}){return IsMappedKey(schema)?IntrinsicFromMappedKey(schema,mode,options):IsTemplateLiteral(schema)?FromTemplateLiteral3(schema,mode,options):IsUnion(schema)?Union(FromRest5(schema.anyOf,mode),options):IsLiteral(schema)?Literal(FromLiteralValue(schema.const,mode),options):CreateType(schema,options)}function Capitalize(T2,options={}){return Intrinsic(T2,"Capitalize",options)}function Lowercase(T2,options={}){return Intrinsic(T2,"Lowercase",options)}function Uncapitalize(T2,options={}){return Intrinsic(T2,"Uncapitalize",options)}function Uppercase(T2,options={}){return Intrinsic(T2,"Uppercase",options)}function FromProperties12(properties,propertyKeys,options){let result={};for(let K2 of globalThis.Object.getOwnPropertyNames(properties))result[K2]=Omit(properties[K2],propertyKeys,Clone(options));return result}function FromMappedResult9(mappedResult,propertyKeys,options){return FromProperties12(mappedResult.properties,propertyKeys,options)}function OmitFromMappedResult(mappedResult,propertyKeys,options){let properties=FromMappedResult9(mappedResult,propertyKeys,options);return MappedResult(properties)}function FromIntersect6(types,propertyKeys){return types.map((type)=>OmitResolve(type,propertyKeys))}function FromUnion8(types,propertyKeys){return types.map((type)=>OmitResolve(type,propertyKeys))}function FromProperty3(properties,key){let{[key]:_2,...R}=properties;return R}function FromProperties13(properties,propertyKeys){return propertyKeys.reduce((T2,K2)=>FromProperty3(T2,K2),properties)}function FromObject3(properties,propertyKeys){let options=Discard(properties,[TransformKind,"$id","required","properties"]),omittedProperties=FromProperties13(properties.properties,propertyKeys);return Object2(omittedProperties,options)}function UnionFromPropertyKeys(propertyKeys){let result=propertyKeys.reduce((result2,key)=>IsLiteralValue(key)?[...result2,Literal(key)]:result2,[]);return Union(result)}function OmitResolve(properties,propertyKeys){return IsIntersect(properties)?Intersect(FromIntersect6(properties.allOf,propertyKeys)):IsUnion(properties)?Union(FromUnion8(properties.anyOf,propertyKeys)):IsObject3(properties)?FromObject3(properties,propertyKeys):Object2({})}function Omit(type,key,options){let typeKey=IsArray(key)?UnionFromPropertyKeys(key):key,propertyKeys=IsSchema(key)?IndexPropertyKeys(key):key,isTypeRef=IsRef(type),isKeyRef=IsRef(key);return IsMappedResult(type)?OmitFromMappedResult(type,propertyKeys,options):IsMappedKey(key)?OmitFromMappedKey(type,key,options):isTypeRef&&isKeyRef?Computed("Omit",[type,typeKey],options):!isTypeRef&&isKeyRef?Computed("Omit",[type,typeKey],options):isTypeRef&&!isKeyRef?Computed("Omit",[type,typeKey],options):CreateType({...OmitResolve(type,propertyKeys),...options})}function FromPropertyKey2(type,key,options){return{[key]:Omit(type,[key],Clone(options))}}function FromPropertyKeys2(type,propertyKeys,options){return propertyKeys.reduce((Acc,LK)=>{return{...Acc,...FromPropertyKey2(type,LK,options)}},{})}function FromMappedKey3(type,mappedKey,options){return FromPropertyKeys2(type,mappedKey.keys,options)}function OmitFromMappedKey(type,mappedKey,options){let properties=FromMappedKey3(type,mappedKey,options);return MappedResult(properties)}function FromProperties14(properties,propertyKeys,options){let result={};for(let K2 of globalThis.Object.getOwnPropertyNames(properties))result[K2]=Pick(properties[K2],propertyKeys,Clone(options));return result}function FromMappedResult10(mappedResult,propertyKeys,options){return FromProperties14(mappedResult.properties,propertyKeys,options)}function PickFromMappedResult(mappedResult,propertyKeys,options){let properties=FromMappedResult10(mappedResult,propertyKeys,options);return MappedResult(properties)}function FromIntersect7(types,propertyKeys){return types.map((type)=>PickResolve(type,propertyKeys))}function FromUnion9(types,propertyKeys){return types.map((type)=>PickResolve(type,propertyKeys))}function FromProperties15(properties,propertyKeys){let result={};for(let K2 of propertyKeys)if(K2 in properties)result[K2]=properties[K2];return result}function FromObject4(T2,K){let options=Discard(T2,[TransformKind,"$id","required","properties"]),properties=FromProperties15(T2.properties,K);return Object2(properties,options)}function UnionFromPropertyKeys2(propertyKeys){let result=propertyKeys.reduce((result2,key)=>IsLiteralValue(key)?[...result2,Literal(key)]:result2,[]);return Union(result)}function PickResolve(properties,propertyKeys){return IsIntersect(properties)?Intersect(FromIntersect7(properties.allOf,propertyKeys)):IsUnion(properties)?Union(FromUnion9(properties.anyOf,propertyKeys)):IsObject3(properties)?FromObject4(properties,propertyKeys):Object2({})}function Pick(type,key,options){let typeKey=IsArray(key)?UnionFromPropertyKeys2(key):key,propertyKeys=IsSchema(key)?IndexPropertyKeys(key):key,isTypeRef=IsRef(type),isKeyRef=IsRef(key);return IsMappedResult(type)?PickFromMappedResult(type,propertyKeys,options):IsMappedKey(key)?PickFromMappedKey(type,key,options):isTypeRef&&isKeyRef?Computed("Pick",[type,typeKey],options):!isTypeRef&&isKeyRef?Computed("Pick",[type,typeKey],options):isTypeRef&&!isKeyRef?Computed("Pick",[type,typeKey],options):CreateType({...PickResolve(type,propertyKeys),...options})}function FromPropertyKey3(type,key,options){return{[key]:Pick(type,[key],Clone(options))}}function FromPropertyKeys3(type,propertyKeys,options){return propertyKeys.reduce((result,leftKey)=>{return{...result,...FromPropertyKey3(type,leftKey,options)}},{})}function FromMappedKey4(type,mappedKey,options){return FromPropertyKeys3(type,mappedKey.keys,options)}function PickFromMappedKey(type,mappedKey,options){let properties=FromMappedKey4(type,mappedKey,options);return MappedResult(properties)}function FromComputed3(target,parameters){return Computed("Partial",[Computed(target,parameters)])}function FromRef3($ref){return Computed("Partial",[Ref($ref)])}function FromProperties16(properties){let partialProperties={};for(let K of globalThis.Object.getOwnPropertyNames(properties))partialProperties[K]=Optional(properties[K]);return partialProperties}function FromObject5(type){let options=Discard(type,[TransformKind,"$id","required","properties"]),properties=FromProperties16(type.properties);return Object2(properties,options)}function FromRest6(types){return types.map((type)=>PartialResolve(type))}function PartialResolve(type){return IsComputed(type)?FromComputed3(type.target,type.parameters):IsRef(type)?FromRef3(type.$ref):IsIntersect(type)?Intersect(FromRest6(type.allOf)):IsUnion(type)?Union(FromRest6(type.anyOf)):IsObject3(type)?FromObject5(type):IsBigInt3(type)?type:IsBoolean3(type)?type:IsInteger2(type)?type:IsLiteral(type)?type:IsNull3(type)?type:IsNumber3(type)?type:IsString3(type)?type:IsSymbol3(type)?type:IsUndefined3(type)?type:Object2({})}function Partial(type,options){if(IsMappedResult(type))return PartialFromMappedResult(type,options);else return CreateType({...PartialResolve(type),...options})}function FromProperties17(K,options){let Acc={};for(let K2 of globalThis.Object.getOwnPropertyNames(K))Acc[K2]=Partial(K[K2],Clone(options));return Acc}function FromMappedResult11(R,options){return FromProperties17(R.properties,options)}function PartialFromMappedResult(R,options){let P=FromMappedResult11(R,options);return MappedResult(P)}function FromComputed4(target,parameters){return Computed("Required",[Computed(target,parameters)])}function FromRef4($ref){return Computed("Required",[Ref($ref)])}function FromProperties18(properties){let requiredProperties={};for(let K of globalThis.Object.getOwnPropertyNames(properties))requiredProperties[K]=Discard(properties[K],[OptionalKind]);return requiredProperties}function FromObject6(type){let options=Discard(type,[TransformKind,"$id","required","properties"]),properties=FromProperties18(type.properties);return Object2(properties,options)}function FromRest7(types){return types.map((type)=>RequiredResolve(type))}function RequiredResolve(type){return IsComputed(type)?FromComputed4(type.target,type.parameters):IsRef(type)?FromRef4(type.$ref):IsIntersect(type)?Intersect(FromRest7(type.allOf)):IsUnion(type)?Union(FromRest7(type.anyOf)):IsObject3(type)?FromObject6(type):IsBigInt3(type)?type:IsBoolean3(type)?type:IsInteger2(type)?type:IsLiteral(type)?type:IsNull3(type)?type:IsNumber3(type)?type:IsString3(type)?type:IsSymbol3(type)?type:IsUndefined3(type)?type:Object2({})}function Required(type,options){if(IsMappedResult(type))return RequiredFromMappedResult(type,options);else return CreateType({...RequiredResolve(type),...options})}function FromProperties19(P,options){let Acc={};for(let K2 of globalThis.Object.getOwnPropertyNames(P))Acc[K2]=Required(P[K2],options);return Acc}function FromMappedResult12(R,options){return FromProperties19(R.properties,options)}function RequiredFromMappedResult(R,options){let P=FromMappedResult12(R,options);return MappedResult(P)}function DereferenceParameters(moduleProperties,types){return types.map((type)=>{return IsRef(type)?Dereference(moduleProperties,type.$ref):FromType2(moduleProperties,type)})}function Dereference(moduleProperties,ref){return ref in moduleProperties?IsRef(moduleProperties[ref])?Dereference(moduleProperties,moduleProperties[ref].$ref):FromType2(moduleProperties,moduleProperties[ref]):Never()}function FromAwaited(parameters){return Awaited(parameters[0])}function FromIndex(parameters){return Index(parameters[0],parameters[1])}function FromKeyOf(parameters){return KeyOf(parameters[0])}function FromPartial(parameters){return Partial(parameters[0])}function FromOmit(parameters){return Omit(parameters[0],parameters[1])}function FromPick(parameters){return Pick(parameters[0],parameters[1])}function FromRequired(parameters){return Required(parameters[0])}function FromComputed5(moduleProperties,target,parameters){let dereferenced=DereferenceParameters(moduleProperties,parameters);return target==="Awaited"?FromAwaited(dereferenced):target==="Index"?FromIndex(dereferenced):target==="KeyOf"?FromKeyOf(dereferenced):target==="Partial"?FromPartial(dereferenced):target==="Omit"?FromOmit(dereferenced):target==="Pick"?FromPick(dereferenced):target==="Required"?FromRequired(dereferenced):Never()}function FromArray6(moduleProperties,type){return Array2(FromType2(moduleProperties,type))}function FromAsyncIterator3(moduleProperties,type){return AsyncIterator(FromType2(moduleProperties,type))}function FromConstructor3(moduleProperties,parameters,instanceType){return Constructor(FromTypes2(moduleProperties,parameters),FromType2(moduleProperties,instanceType))}function FromFunction3(moduleProperties,parameters,returnType){return Function2(FromTypes2(moduleProperties,parameters),FromType2(moduleProperties,returnType))}function FromIntersect8(moduleProperties,types){return Intersect(FromTypes2(moduleProperties,types))}function FromIterator3(moduleProperties,type){return Iterator(FromType2(moduleProperties,type))}function FromObject7(moduleProperties,properties){return Object2(globalThis.Object.keys(properties).reduce((result,key)=>{return{...result,[key]:FromType2(moduleProperties,properties[key])}},{}))}function FromRecord3(moduleProperties,type){let[value,pattern]=[FromType2(moduleProperties,RecordValue2(type)),RecordPattern(type)],result=CloneType(type);return result.patternProperties[pattern]=value,result}function FromTransform(moduleProperties,transform){return IsRef(transform)?{...Dereference(moduleProperties,transform.$ref),[TransformKind]:transform[TransformKind]}:transform}function FromTuple5(moduleProperties,types){return Tuple(FromTypes2(moduleProperties,types))}function FromUnion10(moduleProperties,types){return Union(FromTypes2(moduleProperties,types))}function FromTypes2(moduleProperties,types){return types.map((type)=>FromType2(moduleProperties,type))}function FromType2(moduleProperties,type){return IsOptional(type)?CreateType(FromType2(moduleProperties,Discard(type,[OptionalKind])),type):IsReadonly(type)?CreateType(FromType2(moduleProperties,Discard(type,[ReadonlyKind])),type):IsTransform(type)?CreateType(FromTransform(moduleProperties,type),type):IsArray3(type)?CreateType(FromArray6(moduleProperties,type.items),type):IsAsyncIterator3(type)?CreateType(FromAsyncIterator3(moduleProperties,type.items),type):IsComputed(type)?CreateType(FromComputed5(moduleProperties,type.target,type.parameters)):IsConstructor(type)?CreateType(FromConstructor3(moduleProperties,type.parameters,type.returns),type):IsFunction3(type)?CreateType(FromFunction3(moduleProperties,type.parameters,type.returns),type):IsIntersect(type)?CreateType(FromIntersect8(moduleProperties,type.allOf),type):IsIterator3(type)?CreateType(FromIterator3(moduleProperties,type.items),type):IsObject3(type)?CreateType(FromObject7(moduleProperties,type.properties),type):IsRecord(type)?CreateType(FromRecord3(moduleProperties,type)):IsTuple(type)?CreateType(FromTuple5(moduleProperties,type.items||[]),type):IsUnion(type)?CreateType(FromUnion10(moduleProperties,type.anyOf),type):type}function ComputeType(moduleProperties,key){return key in moduleProperties?FromType2(moduleProperties,moduleProperties[key]):Never()}function ComputeModuleProperties(moduleProperties){return globalThis.Object.getOwnPropertyNames(moduleProperties).reduce((result,key)=>{return{...result,[key]:ComputeType(moduleProperties,key)}},{})}class TModule{constructor($defs){let computed=ComputeModuleProperties($defs),identified=this.WithIdentifiers(computed);this.$defs=identified}Import(key,options){let $defs={...this.$defs,[key]:CreateType(this.$defs[key],options)};return CreateType({[Kind]:"Import",$defs,$ref:key})}WithIdentifiers($defs){return globalThis.Object.getOwnPropertyNames($defs).reduce((result,key)=>{return{...result,[key]:{...$defs[key],$id:key}}},{})}}function Module(properties){return new TModule(properties)}function Not2(type,options){return CreateType({[Kind]:"Not",not:type},options)}function Parameters(schema,options){return IsFunction3(schema)?Tuple(schema.parameters,options):Never()}var Ordinal=0;function Recursive(callback,options={}){if(IsUndefined(options.$id))options.$id=`T${Ordinal++}`;let thisType=CloneType(callback({[Kind]:"This",$ref:`${options.$id}`}));return thisType.$id=options.$id,CreateType({[Hint]:"Recursive",...thisType},options)}function RegExp2(unresolved,options){let expr=IsString(unresolved)?new globalThis.RegExp(unresolved):unresolved;return CreateType({[Kind]:"RegExp",type:"RegExp",source:expr.source,flags:expr.flags},options)}function RestResolve(T2){return IsIntersect(T2)?T2.allOf:IsUnion(T2)?T2.anyOf:IsTuple(T2)?T2.items??[]:[]}function Rest(T2){return RestResolve(T2)}function ReturnType(schema,options){return IsFunction3(schema)?CreateType(schema.returns,options):Never(options)}class TransformDecodeBuilder{constructor(schema){this.schema=schema}Decode(decode){return new TransformEncodeBuilder(this.schema,decode)}}class TransformEncodeBuilder{constructor(schema,decode){this.schema=schema,this.decode=decode}EncodeTransform(encode,schema){let Codec={Encode:(value)=>schema[TransformKind].Encode(encode(value)),Decode:(value)=>this.decode(schema[TransformKind].Decode(value))};return{...schema,[TransformKind]:Codec}}EncodeSchema(encode,schema){let Codec={Decode:this.decode,Encode:encode};return{...schema,[TransformKind]:Codec}}Encode(encode){return IsTransform(this.schema)?this.EncodeTransform(encode,this.schema):this.EncodeSchema(encode,this.schema)}}function Transform(schema){return new TransformDecodeBuilder(schema)}function Unsafe(options={}){return CreateType({[Kind]:options[Kind]??"Unsafe"},options)}function Void(options){return CreateType({[Kind]:"Void",type:"void"},options)}var exports_type3={};__export(exports_type3,{Void:()=>Void,Uppercase:()=>Uppercase,Unsafe:()=>Unsafe,Unknown:()=>Unknown,Union:()=>Union,Undefined:()=>Undefined,Uncapitalize:()=>Uncapitalize,Uint8Array:()=>Uint8Array2,Tuple:()=>Tuple,Transform:()=>Transform,TemplateLiteral:()=>TemplateLiteral,Symbol:()=>Symbol2,String:()=>String2,ReturnType:()=>ReturnType,Rest:()=>Rest,Required:()=>Required,RegExp:()=>RegExp2,Ref:()=>Ref,Recursive:()=>Recursive,Record:()=>Record,ReadonlyOptional:()=>ReadonlyOptional,Readonly:()=>Readonly,Promise:()=>Promise2,Pick:()=>Pick,Partial:()=>Partial,Parameters:()=>Parameters,Optional:()=>Optional,Omit:()=>Omit,Object:()=>Object2,Number:()=>Number2,Null:()=>Null,Not:()=>Not2,Never:()=>Never,Module:()=>Module,Mapped:()=>Mapped,Lowercase:()=>Lowercase,Literal:()=>Literal,KeyOf:()=>KeyOf,Iterator:()=>Iterator,Intersect:()=>Intersect,Integer:()=>Integer,Instantiate:()=>Instantiate,InstanceType:()=>InstanceType,Index:()=>Index,Function:()=>Function2,Extract:()=>Extract,Extends:()=>Extends,Exclude:()=>Exclude,Enum:()=>Enum,Date:()=>Date2,ConstructorParameters:()=>ConstructorParameters,Constructor:()=>Constructor,Const:()=>Const,Composite:()=>Composite,Capitalize:()=>Capitalize,Boolean:()=>Boolean2,BigInt:()=>BigInt2,Awaited:()=>Awaited,AsyncIterator:()=>AsyncIterator,Array:()=>Array2,Argument:()=>Argument,Any:()=>Any});var Type=exports_type3;function DefaultErrorFunction(error){switch(error.errorType){case ValueErrorType.ArrayContains:return"Expected array to contain at least one matching value";case ValueErrorType.ArrayMaxContains:return`Expected array to contain no more than ${error.schema.maxContains} matching values`;case ValueErrorType.ArrayMinContains:return`Expected array to contain at least ${error.schema.minContains} matching values`;case ValueErrorType.ArrayMaxItems:return`Expected array length to be less or equal to ${error.schema.maxItems}`;case ValueErrorType.ArrayMinItems:return`Expected array length to be greater or equal to ${error.schema.minItems}`;case ValueErrorType.ArrayUniqueItems:return"Expected array elements to be unique";case ValueErrorType.Array:return"Expected array";case ValueErrorType.AsyncIterator:return"Expected AsyncIterator";case ValueErrorType.BigIntExclusiveMaximum:return`Expected bigint to be less than ${error.schema.exclusiveMaximum}`;case ValueErrorType.BigIntExclusiveMinimum:return`Expected bigint to be greater than ${error.schema.exclusiveMinimum}`;case ValueErrorType.BigIntMaximum:return`Expected bigint to be less or equal to ${error.schema.maximum}`;case ValueErrorType.BigIntMinimum:return`Expected bigint to be greater or equal to ${error.schema.minimum}`;case ValueErrorType.BigIntMultipleOf:return`Expected bigint to be a multiple of ${error.schema.multipleOf}`;case ValueErrorType.BigInt:return"Expected bigint";case ValueErrorType.Boolean:return"Expected boolean";case ValueErrorType.DateExclusiveMinimumTimestamp:return`Expected Date timestamp to be greater than ${error.schema.exclusiveMinimumTimestamp}`;case ValueErrorType.DateExclusiveMaximumTimestamp:return`Expected Date timestamp to be less than ${error.schema.exclusiveMaximumTimestamp}`;case ValueErrorType.DateMinimumTimestamp:return`Expected Date timestamp to be greater or equal to ${error.schema.minimumTimestamp}`;case ValueErrorType.DateMaximumTimestamp:return`Expected Date timestamp to be less or equal to ${error.schema.maximumTimestamp}`;case ValueErrorType.DateMultipleOfTimestamp:return`Expected Date timestamp to be a multiple of ${error.schema.multipleOfTimestamp}`;case ValueErrorType.Date:return"Expected Date";case ValueErrorType.Function:return"Expected function";case ValueErrorType.IntegerExclusiveMaximum:return`Expected integer to be less than ${error.schema.exclusiveMaximum}`;case ValueErrorType.IntegerExclusiveMinimum:return`Expected integer to be greater than ${error.schema.exclusiveMinimum}`;case ValueErrorType.IntegerMaximum:return`Expected integer to be less or equal to ${error.schema.maximum}`;case ValueErrorType.IntegerMinimum:return`Expected integer to be greater or equal to ${error.schema.minimum}`;case ValueErrorType.IntegerMultipleOf:return`Expected integer to be a multiple of ${error.schema.multipleOf}`;case ValueErrorType.Integer:return"Expected integer";case ValueErrorType.IntersectUnevaluatedProperties:return"Unexpected property";case ValueErrorType.Intersect:return"Expected all values to match";case ValueErrorType.Iterator:return"Expected Iterator";case ValueErrorType.Literal:return`Expected ${typeof error.schema.const==="string"?`'${error.schema.const}'`:error.schema.const}`;case ValueErrorType.Never:return"Never";case ValueErrorType.Not:return"Value should not match";case ValueErrorType.Null:return"Expected null";case ValueErrorType.NumberExclusiveMaximum:return`Expected number to be less than ${error.schema.exclusiveMaximum}`;case ValueErrorType.NumberExclusiveMinimum:return`Expected number to be greater than ${error.schema.exclusiveMinimum}`;case ValueErrorType.NumberMaximum:return`Expected number to be less or equal to ${error.schema.maximum}`;case ValueErrorType.NumberMinimum:return`Expected number to be greater or equal to ${error.schema.minimum}`;case ValueErrorType.NumberMultipleOf:return`Expected number to be a multiple of ${error.schema.multipleOf}`;case ValueErrorType.Number:return"Expected number";case ValueErrorType.Object:return"Expected object";case ValueErrorType.ObjectAdditionalProperties:return"Unexpected property";case ValueErrorType.ObjectMaxProperties:return`Expected object to have no more than ${error.schema.maxProperties} properties`;case ValueErrorType.ObjectMinProperties:return`Expected object to have at least ${error.schema.minProperties} properties`;case ValueErrorType.ObjectRequiredProperty:return"Expected required property";case ValueErrorType.Promise:return"Expected Promise";case ValueErrorType.RegExp:return"Expected string to match regular expression";case ValueErrorType.StringFormatUnknown:return`Unknown format '${error.schema.format}'`;case ValueErrorType.StringFormat:return`Expected string to match '${error.schema.format}' format`;case ValueErrorType.StringMaxLength:return`Expected string length less or equal to ${error.schema.maxLength}`;case ValueErrorType.StringMinLength:return`Expected string length greater or equal to ${error.schema.minLength}`;case ValueErrorType.StringPattern:return`Expected string to match '${error.schema.pattern}'`;case ValueErrorType.String:return"Expected string";case ValueErrorType.Symbol:return"Expected symbol";case ValueErrorType.TupleLength:return`Expected tuple to have ${error.schema.maxItems||0} elements`;case ValueErrorType.Tuple:return"Expected tuple";case ValueErrorType.Uint8ArrayMaxByteLength:return`Expected byte length less or equal to ${error.schema.maxByteLength}`;case ValueErrorType.Uint8ArrayMinByteLength:return`Expected byte length greater or equal to ${error.schema.minByteLength}`;case ValueErrorType.Uint8Array:return"Expected Uint8Array";case ValueErrorType.Undefined:return"Expected undefined";case ValueErrorType.Union:return"Expected union value";case ValueErrorType.Void:return"Expected void";case ValueErrorType.Kind:return`Expected kind '${error.schema[Kind]}'`;default:return"Unknown error type"}}var errorFunction=DefaultErrorFunction;function GetErrorFunction(){return errorFunction}class TypeDereferenceError extends TypeBoxError{constructor(schema){super(`Unable to dereference schema with $id '${schema.$ref}'`);this.schema=schema}}function Resolve(schema,references){let target=references.find((target2)=>target2.$id===schema.$ref);if(target===void 0)throw new TypeDereferenceError(schema);return Deref(target,references)}function Pushref(schema,references){if(!IsString2(schema.$id)||references.some((target)=>target.$id===schema.$id))return references;return references.push(schema),references}function Deref(schema,references){return schema[Kind]==="This"||schema[Kind]==="Ref"?Resolve(schema,references):schema}class ValueHashError extends TypeBoxError{constructor(value){super("Unable to hash value");this.value=value}}var ByteMarker;(function(ByteMarker2){ByteMarker2[ByteMarker2.Undefined=0]="Undefined",ByteMarker2[ByteMarker2.Null=1]="Null",ByteMarker2[ByteMarker2.Boolean=2]="Boolean",ByteMarker2[ByteMarker2.Number=3]="Number",ByteMarker2[ByteMarker2.String=4]="String",ByteMarker2[ByteMarker2.Object=5]="Object",ByteMarker2[ByteMarker2.Array=6]="Array",ByteMarker2[ByteMarker2.Date=7]="Date",ByteMarker2[ByteMarker2.Uint8Array=8]="Uint8Array",ByteMarker2[ByteMarker2.Symbol=9]="Symbol",ByteMarker2[ByteMarker2.BigInt=10]="BigInt"})(ByteMarker||(ByteMarker={}));var Accumulator=BigInt("14695981039346656037"),[Prime,Size]=[BigInt("1099511628211"),BigInt("18446744073709551616")],Bytes=Array.from({length:256}).map((_2,i)=>BigInt(i)),F64=new Float64Array(1),F64In=new DataView(F64.buffer),F64Out=new Uint8Array(F64.buffer);function*NumberToBytes(value){let byteCount=value===0?1:Math.ceil(Math.floor(Math.log2(value)+1)/8);for(let i=0;i<byteCount;i++)yield value>>8*(byteCount-1-i)&255}function ArrayType2(value){FNV1A64(ByteMarker.Array);for(let item of value)Visit4(item)}function BooleanType(value){FNV1A64(ByteMarker.Boolean),FNV1A64(value?1:0)}function BigIntType(value){FNV1A64(ByteMarker.BigInt),F64In.setBigInt64(0,value);for(let byte of F64Out)FNV1A64(byte)}function DateType2(value){FNV1A64(ByteMarker.Date),Visit4(value.getTime())}function NullType(value){FNV1A64(ByteMarker.Null)}function NumberType(value){FNV1A64(ByteMarker.Number),F64In.setFloat64(0,value);for(let byte of F64Out)FNV1A64(byte)}function ObjectType2(value){FNV1A64(ByteMarker.Object);for(let key of globalThis.Object.getOwnPropertyNames(value).sort())Visit4(key),Visit4(value[key])}function StringType(value){FNV1A64(ByteMarker.String);for(let i=0;i<value.length;i++)for(let byte of NumberToBytes(value.charCodeAt(i)))FNV1A64(byte)}function SymbolType(value){FNV1A64(ByteMarker.Symbol),Visit4(value.description)}function Uint8ArrayType2(value){FNV1A64(ByteMarker.Uint8Array);for(let i=0;i<value.length;i++)FNV1A64(value[i])}function UndefinedType(value){return FNV1A64(ByteMarker.Undefined)}function Visit4(value){if(IsArray2(value))return ArrayType2(value);if(IsBoolean2(value))return BooleanType(value);if(IsBigInt2(value))return BigIntType(value);if(IsDate2(value))return DateType2(value);if(IsNull2(value))return NullType(value);if(IsNumber2(value))return NumberType(value);if(IsObject2(value))return ObjectType2(value);if(IsString2(value))return StringType(value);if(IsSymbol2(value))return SymbolType(value);if(IsUint8Array2(value))return Uint8ArrayType2(value);if(IsUndefined2(value))return UndefinedType(value);throw new ValueHashError(value)}function FNV1A64(byte){Accumulator=Accumulator^Bytes[byte],Accumulator=Accumulator*Prime%Size}function Hash(value){return Accumulator=BigInt("14695981039346656037"),Visit4(value),Accumulator}class ValueCheckUnknownTypeError extends TypeBoxError{constructor(schema){super("Unknown type");this.schema=schema}}function IsAnyOrUnknown(schema){return schema[Kind]==="Any"||schema[Kind]==="Unknown"}function IsDefined(value){return value!==void 0}function FromAny2(schema,references,value){return!0}function FromArgument2(schema,references,value){return!0}function FromArray7(schema,references,value){if(!IsArray2(value))return!1;if(IsDefined(schema.minItems)&&!(value.length>=schema.minItems))return!1;if(IsDefined(schema.maxItems)&&!(value.length<=schema.maxItems))return!1;if(!value.every((value2)=>Visit5(schema.items,references,value2)))return!1;if(schema.uniqueItems===!0&&!function(){let set2=new Set;for(let element of value){let hashed=Hash(element);if(set2.has(hashed))return!1;else set2.add(hashed)}return!0}())return!1;if(!(IsDefined(schema.contains)||IsNumber2(schema.minContains)||IsNumber2(schema.maxContains)))return!0;let containsSchema=IsDefined(schema.contains)?schema.contains:Never(),containsCount=value.reduce((acc,value2)=>Visit5(containsSchema,references,value2)?acc+1:acc,0);if(containsCount===0)return!1;if(IsNumber2(schema.minContains)&&containsCount<schema.minContains)return!1;if(IsNumber2(schema.maxContains)&&containsCount>schema.maxContains)return!1;return!0}function FromAsyncIterator4(schema,references,value){return IsAsyncIterator2(value)}function FromBigInt2(schema,references,value){if(!IsBigInt2(value))return!1;if(IsDefined(schema.exclusiveMaximum)&&!(value<schema.exclusiveMaximum))return!1;if(IsDefined(schema.exclusiveMinimum)&&!(value>schema.exclusiveMinimum))return!1;if(IsDefined(schema.maximum)&&!(value<=schema.maximum))return!1;if(IsDefined(schema.minimum)&&!(value>=schema.minimum))return!1;if(IsDefined(schema.multipleOf)&&value%schema.multipleOf!==BigInt(0))return!1;return!0}function FromBoolean2(schema,references,value){return IsBoolean2(value)}function FromConstructor4(schema,references,value){return Visit5(schema.returns,references,value.prototype)}function FromDate2(schema,references,value){if(!IsDate2(value))return!1;if(IsDefined(schema.exclusiveMaximumTimestamp)&&!(value.getTime()<schema.exclusiveMaximumTimestamp))return!1;if(IsDefined(schema.exclusiveMinimumTimestamp)&&!(value.getTime()>schema.exclusiveMinimumTimestamp))return!1;if(IsDefined(schema.maximumTimestamp)&&!(value.getTime()<=schema.maximumTimestamp))return!1;if(IsDefined(schema.minimumTimestamp)&&!(value.getTime()>=schema.minimumTimestamp))return!1;if(IsDefined(schema.multipleOfTimestamp)&&value.getTime()%schema.multipleOfTimestamp!==0)return!1;return!0}function FromFunction4(schema,references,value){return IsFunction2(value)}function FromImport(schema,references,value){let definitions=globalThis.Object.values(schema.$defs),target=schema.$defs[schema.$ref];return Visit5(target,[...references,...definitions],value)}function FromInteger2(schema,references,value){if(!IsInteger(value))return!1;if(IsDefined(schema.exclusiveMaximum)&&!(value<schema.exclusiveMaximum))return!1;if(IsDefined(schema.exclusiveMinimum)&&!(value>schema.exclusiveMinimum))return!1;if(IsDefined(schema.maximum)&&!(value<=schema.maximum))return!1;if(IsDefined(schema.minimum)&&!(value>=schema.minimum))return!1;if(IsDefined(schema.multipleOf)&&value%schema.multipleOf!==0)return!1;return!0}function FromIntersect9(schema,references,value){let check1=schema.allOf.every((schema2)=>Visit5(schema2,references,value));if(schema.unevaluatedProperties===!1){let keyPattern=new RegExp(KeyOfPattern(schema)),check2=Object.getOwnPropertyNames(value).every((key)=>keyPattern.test(key));return check1&&check2}else if(IsSchema(schema.unevaluatedProperties)){let keyCheck=new RegExp(KeyOfPattern(schema)),check2=Object.getOwnPropertyNames(value).every((key)=>keyCheck.test(key)||Visit5(schema.unevaluatedProperties,references,value[key]));return check1&&check2}else return check1}function FromIterator4(schema,references,value){return IsIterator2(value)}function FromLiteral3(schema,references,value){return value===schema.const}function FromNever2(schema,references,value){return!1}function FromNot2(schema,references,value){return!Visit5(schema.not,references,value)}function FromNull2(schema,references,value){return IsNull2(value)}function FromNumber2(schema,references,value){if(!TypeSystemPolicy.IsNumberLike(value))return!1;if(IsDefined(schema.exclusiveMaximum)&&!(value<schema.exclusiveMaximum))return!1;if(IsDefined(schema.exclusiveMinimum)&&!(value>schema.exclusiveMinimum))return!1;if(IsDefined(schema.minimum)&&!(value>=schema.minimum))return!1;if(IsDefined(schema.maximum)&&!(value<=schema.maximum))return!1;if(IsDefined(schema.multipleOf)&&value%schema.multipleOf!==0)return!1;return!0}function FromObject8(schema,references,value){if(!TypeSystemPolicy.IsObjectLike(value))return!1;if(IsDefined(schema.minProperties)&&!(Object.getOwnPropertyNames(value).length>=schema.minProperties))return!1;if(IsDefined(schema.maxProperties)&&!(Object.getOwnPropertyNames(value).length<=schema.maxProperties))return!1;let knownKeys=Object.getOwnPropertyNames(schema.properties);for(let knownKey of knownKeys){let property=schema.properties[knownKey];if(schema.required&&schema.required.includes(knownKey)){if(!Visit5(property,references,value[knownKey]))return!1;if((ExtendsUndefinedCheck(property)||IsAnyOrUnknown(property))&&!(knownKey in value))return!1}else if(TypeSystemPolicy.IsExactOptionalProperty(value,knownKey)&&!Visit5(property,references,value[knownKey]))return!1}if(schema.additionalProperties===!1){let valueKeys=Object.getOwnPropertyNames(value);if(schema.required&&schema.required.length===knownKeys.length&&valueKeys.length===knownKeys.length)return!0;else return valueKeys.every((valueKey)=>knownKeys.includes(valueKey))}else if(typeof schema.additionalProperties==="object")return Object.getOwnPropertyNames(value).every((key)=>knownKeys.includes(key)||Visit5(schema.additionalProperties,references,value[key]));else return!0}function FromPromise4(schema,references,value){return IsPromise(value)}function FromRecord4(schema,references,value){if(!TypeSystemPolicy.IsRecordLike(value))return!1;if(IsDefined(schema.minProperties)&&!(Object.getOwnPropertyNames(value).length>=schema.minProperties))return!1;if(IsDefined(schema.maxProperties)&&!(Object.getOwnPropertyNames(value).length<=schema.maxProperties))return!1;let[patternKey,patternSchema]=Object.entries(schema.patternProperties)[0],regex=new RegExp(patternKey),check1=Object.entries(value).every(([key,value2])=>{return regex.test(key)?Visit5(patternSchema,references,value2):!0}),check2=typeof schema.additionalProperties==="object"?Object.entries(value).every(([key,value2])=>{return!regex.test(key)?Visit5(schema.additionalProperties,references,value2):!0}):!0,check3=schema.additionalProperties===!1?Object.getOwnPropertyNames(value).every((key)=>{return regex.test(key)}):!0;return check1&&check2&&check3}function FromRef5(schema,references,value){return Visit5(Deref(schema,references),references,value)}function FromRegExp2(schema,references,value){let regex=new RegExp(schema.source,schema.flags);if(IsDefined(schema.minLength)){if(!(value.length>=schema.minLength))return!1}if(IsDefined(schema.maxLength)){if(!(value.length<=schema.maxLength))return!1}return regex.test(value)}function FromString2(schema,references,value){if(!IsString2(value))return!1;if(IsDefined(schema.minLength)){if(!(value.length>=schema.minLength))return!1}if(IsDefined(schema.maxLength)){if(!(value.length<=schema.maxLength))return!1}if(IsDefined(schema.pattern)){if(!new RegExp(schema.pattern).test(value))return!1}if(IsDefined(schema.format)){if(!exports_format.Has(schema.format))return!1;return exports_format.Get(schema.format)(value)}return!0}function FromSymbol2(schema,references,value){return IsSymbol2(value)}function FromTemplateLiteral4(schema,references,value){return IsString2(value)&&new RegExp(schema.pattern).test(value)}function FromThis(schema,references,value){return Visit5(Deref(schema,references),references,value)}function FromTuple6(schema,references,value){if(!IsArray2(value))return!1;if(schema.items===void 0&&value.length!==0)return!1;if(value.length!==schema.maxItems)return!1;if(!schema.items)return!0;for(let i=0;i<schema.items.length;i++)if(!Visit5(schema.items[i],references,value[i]))return!1;return!0}function FromUndefined2(schema,references,value){return IsUndefined2(value)}function FromUnion11(schema,references,value){return schema.anyOf.some((inner)=>Visit5(inner,references,value))}function FromUint8Array2(schema,references,value){if(!IsUint8Array2(value))return!1;if(IsDefined(schema.maxByteLength)&&!(value.length<=schema.maxByteLength))return!1;if(IsDefined(schema.minByteLength)&&!(value.length>=schema.minByteLength))return!1;return!0}function FromUnknown2(schema,references,value){return!0}function FromVoid2(schema,references,value){return TypeSystemPolicy.IsVoidLike(value)}function FromKind(schema,references,value){if(!exports_type2.Has(schema[Kind]))return!1;return exports_type2.Get(schema[Kind])(schema,value)}function Visit5(schema,references,value){let references_=IsDefined(schema.$id)?Pushref(schema,references):references,schema_=schema;switch(schema_[Kind]){case"Any":return FromAny2(schema_,references_,value);case"Argument":return FromArgument2(schema_,references_,value);case"Array":return FromArray7(schema_,references_,value);case"AsyncIterator":return FromAsyncIterator4(schema_,references_,value);case"BigInt":return FromBigInt2(schema_,references_,value);case"Boolean":return FromBoolean2(schema_,references_,value);case"Constructor":return FromConstructor4(schema_,references_,value);case"Date":return FromDate2(schema_,references_,value);case"Function":return FromFunction4(schema_,references_,value);case"Import":return FromImport(schema_,references_,value);case"Integer":return FromInteger2(schema_,references_,value);case"Intersect":return FromIntersect9(schema_,references_,value);case"Iterator":return FromIterator4(schema_,references_,value);case"Literal":return FromLiteral3(schema_,references_,value);case"Never":return FromNever2(schema_,references_,value);case"Not":return FromNot2(schema_,references_,value);case"Null":return FromNull2(schema_,references_,value);case"Number":return FromNumber2(schema_,references_,value);case"Object":return FromObject8(schema_,references_,value);case"Promise":return FromPromise4(schema_,references_,value);case"Record":return FromRecord4(schema_,references_,value);case"Ref":return FromRef5(schema_,references_,value);case"RegExp":return FromRegExp2(schema_,references_,value);case"String":return FromString2(schema_,references_,value);case"Symbol":return FromSymbol2(schema_,references_,value);case"TemplateLiteral":return FromTemplateLiteral4(schema_,references_,value);case"This":return FromThis(schema_,references_,value);case"Tuple":return FromTuple6(schema_,references_,value);case"Undefined":return FromUndefined2(schema_,references_,value);case"Union":return FromUnion11(schema_,references_,value);case"Uint8Array":return FromUint8Array2(schema_,references_,value);case"Unknown":return FromUnknown2(schema_,references_,value);case"Void":return FromVoid2(schema_,references_,value);default:if(!exports_type2.Has(schema_[Kind]))throw new ValueCheckUnknownTypeError(schema_);return FromKind(schema_,references_,value)}}function Check(...args){return args.length===3?Visit5(args[0],args[1],args[2]):Visit5(args[0],[],args[1])}var ValueErrorType;(function(ValueErrorType2){ValueErrorType2[ValueErrorType2.ArrayContains=0]="ArrayContains",ValueErrorType2[ValueErrorType2.ArrayMaxContains=1]="ArrayMaxContains",ValueErrorType2[ValueErrorType2.ArrayMaxItems=2]="ArrayMaxItems",ValueErrorType2[ValueErrorType2.ArrayMinContains=3]="ArrayMinContains",ValueErrorType2[ValueErrorType2.ArrayMinItems=4]="ArrayMinItems",ValueErrorType2[ValueErrorType2.ArrayUniqueItems=5]="ArrayUniqueItems",ValueErrorType2[ValueErrorType2.Array=6]="Array",ValueErrorType2[ValueErrorType2.AsyncIterator=7]="AsyncIterator",ValueErrorType2[ValueErrorType2.BigIntExclusiveMaximum=8]="BigIntExclusiveMaximum",ValueErrorType2[ValueErrorType2.BigIntExclusiveMinimum=9]="BigIntExclusiveMinimum",ValueErrorType2[ValueErrorType2.BigIntMaximum=10]="BigIntMaximum",ValueErrorType2[ValueErrorType2.BigIntMinimum=11]="BigIntMinimum",ValueErrorType2[ValueErrorType2.BigIntMultipleOf=12]="BigIntMultipleOf",ValueErrorType2[ValueErrorType2.BigInt=13]="BigInt",ValueErrorType2[ValueErrorType2.Boolean=14]="Boolean",ValueErrorType2[ValueErrorType2.DateExclusiveMaximumTimestamp=15]="DateExclusiveMaximumTimestamp",ValueErrorType2[ValueErrorType2.DateExclusiveMinimumTimestamp=16]="DateExclusiveMinimumTimestamp",ValueErrorType2[ValueErrorType2.DateMaximumTimestamp=17]="DateMaximumTimestamp",ValueErrorType2[ValueErrorType2.DateMinimumTimestamp=18]="DateMinimumTimestamp",ValueErrorType2[ValueErrorType2.DateMultipleOfTimestamp=19]="DateMultipleOfTimestamp",ValueErrorType2[ValueErrorType2.Date=20]="Date",ValueErrorType2[ValueErrorType2.Function=21]="Function",ValueErrorType2[ValueErrorType2.IntegerExclusiveMaximum=22]="IntegerExclusiveMaximum",ValueErrorType2[ValueErrorType2.IntegerExclusiveMinimum=23]="IntegerExclusiveMinimum",ValueErrorType2[ValueErrorType2.IntegerMaximum=24]="IntegerMaximum",ValueErrorType2[ValueErrorType2.IntegerMinimum=25]="IntegerMinimum",ValueErrorType2[ValueErrorType2.IntegerMultipleOf=26]="IntegerMultipleOf",ValueErrorType2[ValueErrorType2.Integer=27]="Integer",ValueErrorType2[ValueErrorType2.IntersectUnevaluatedProperties=28]="IntersectUnevaluatedProperties",ValueErrorType2[ValueErrorType2.Intersect=29]="Intersect",ValueErrorType2[ValueErrorType2.Iterator=30]="Iterator",ValueErrorType2[ValueErrorType2.Kind=31]="Kind",ValueErrorType2[ValueErrorType2.Literal=32]="Literal",ValueErrorType2[ValueErrorType2.Never=33]="Never",ValueErrorType2[ValueErrorType2.Not=34]="Not",ValueErrorType2[ValueErrorType2.Null=35]="Null",ValueErrorType2[ValueErrorType2.NumberExclusiveMaximum=36]="NumberExclusiveMaximum",ValueErrorType2[ValueErrorType2.NumberExclusiveMinimum=37]="NumberExclusiveMinimum",ValueErrorType2[ValueErrorType2.NumberMaximum=38]="NumberMaximum",ValueErrorType2[ValueErrorType2.NumberMinimum=39]="NumberMinimum",ValueErrorType2[ValueErrorType2.NumberMultipleOf=40]="NumberMultipleOf",ValueErrorType2[ValueErrorType2.Number=41]="Number",ValueErrorType2[ValueErrorType2.ObjectAdditionalProperties=42]="ObjectAdditionalProperties",ValueErrorType2[ValueErrorType2.ObjectMaxProperties=43]="ObjectMaxProperties",ValueErrorType2[ValueErrorType2.ObjectMinProperties=44]="ObjectMinProperties",ValueErrorType2[ValueErrorType2.ObjectRequiredProperty=45]="ObjectRequiredProperty",ValueErrorType2[ValueErrorType2.Object=46]="Object",ValueErrorType2[ValueErrorType2.Promise=47]="Promise",ValueErrorType2[ValueErrorType2.RegExp=48]="RegExp",ValueErrorType2[ValueErrorType2.StringFormatUnknown=49]="StringFormatUnknown",ValueErrorType2[ValueErrorType2.StringFormat=50]="StringFormat",ValueErrorType2[ValueErrorType2.StringMaxLength=51]="StringMaxLength",ValueErrorType2[ValueErrorType2.StringMinLength=52]="StringMinLength",ValueErrorType2[ValueErrorType2.StringPattern=53]="StringPattern",ValueErrorType2[ValueErrorType2.String=54]="String",ValueErrorType2[ValueErrorType2.Symbol=55]="Symbol",ValueErrorType2[ValueErrorType2.TupleLength=56]="TupleLength",ValueErrorType2[ValueErrorType2.Tuple=57]="Tuple",ValueErrorType2[ValueErrorType2.Uint8ArrayMaxByteLength=58]="Uint8ArrayMaxByteLength",ValueErrorType2[ValueErrorType2.Uint8ArrayMinByteLength=59]="Uint8ArrayMinByteLength",ValueErrorType2[ValueErrorType2.Uint8Array=60]="Uint8Array",ValueErrorType2[ValueErrorType2.Undefined=61]="Undefined",ValueErrorType2[ValueErrorType2.Union=62]="Union",ValueErrorType2[ValueErrorType2.Void=63]="Void"})(ValueErrorType||(ValueErrorType={}));class ValueErrorsUnknownTypeError extends TypeBoxError{constructor(schema){super("Unknown type");this.schema=schema}}function EscapeKey(key){return key.replace(/~/g,"~0").replace(/\//g,"~1")}function IsDefined2(value){return value!==void 0}class ValueErrorIterator{constructor(iterator){this.iterator=iterator}[Symbol.iterator](){return this.iterator}First(){let next=this.iterator.next();return next.done?void 0:next.value}}function Create(errorType,schema,path,value,errors=[]){return{type:errorType,schema,path,value,message:GetErrorFunction()({errorType,path,schema,value,errors}),errors}}function*FromAny3(schema,references,path,value){}function*FromArgument3(schema,references,path,value){}function*FromArray8(schema,references,path,value){if(!IsArray2(value))return yield Create(ValueErrorType.Array,schema,path,value);if(IsDefined2(schema.minItems)&&!(value.length>=schema.minItems))yield Create(ValueErrorType.ArrayMinItems,schema,path,value);if(IsDefined2(schema.maxItems)&&!(value.length<=schema.maxItems))yield Create(ValueErrorType.ArrayMaxItems,schema,path,value);for(let i=0;i<value.length;i++)yield*Visit6(schema.items,references,`${path}/${i}`,value[i]);if(schema.uniqueItems===!0&&!function(){let set2=new Set;for(let element of value){let hashed=Hash(element);if(set2.has(hashed))return!1;else set2.add(hashed)}return!0}())yield Create(ValueErrorType.ArrayUniqueItems,schema,path,value);if(!(IsDefined2(schema.contains)||IsDefined2(schema.minContains)||IsDefined2(schema.maxContains)))return;let containsSchema=IsDefined2(schema.contains)?schema.contains:Never(),containsCount=value.reduce((acc,value2,index)=>Visit6(containsSchema,references,`${path}${index}`,value2).next().done===!0?acc+1:acc,0);if(containsCount===0)yield Create(ValueErrorType.ArrayContains,schema,path,value);if(IsNumber2(schema.minContains)&&containsCount<schema.minContains)yield Create(ValueErrorType.ArrayMinContains,schema,path,value);if(IsNumber2(schema.maxContains)&&containsCount>schema.maxContains)yield Create(ValueErrorType.ArrayMaxContains,schema,path,value)}function*FromAsyncIterator5(schema,references,path,value){if(!IsAsyncIterator2(value))yield Create(ValueErrorType.AsyncIterator,schema,path,value)}function*FromBigInt3(schema,references,path,value){if(!IsBigInt2(value))return yield Create(ValueErrorType.BigInt,schema,path,value);if(IsDefined2(schema.exclusiveMaximum)&&!(value<schema.exclusiveMaximum))yield Create(ValueErrorType.BigIntExclusiveMaximum,schema,path,value);if(IsDefined2(schema.exclusiveMinimum)&&!(value>schema.exclusiveMinimum))yield Create(ValueErrorType.BigIntExclusiveMinimum,schema,path,value);if(IsDefined2(schema.maximum)&&!(value<=schema.maximum))yield Create(ValueErrorType.BigIntMaximum,schema,path,value);if(IsDefined2(schema.minimum)&&!(value>=schema.minimum))yield Create(ValueErrorType.BigIntMinimum,schema,path,value);if(IsDefined2(schema.multipleOf)&&value%schema.multipleOf!==BigInt(0))yield Create(ValueErrorType.BigIntMultipleOf,schema,path,value)}function*FromBoolean3(schema,references,path,value){if(!IsBoolean2(value))yield Create(ValueErrorType.Boolean,schema,path,value)}function*FromConstructor5(schema,references,path,value){yield*Visit6(schema.returns,references,path,value.prototype)}function*FromDate3(schema,references,path,value){if(!IsDate2(value))return yield Create(ValueErrorType.Date,schema,path,value);if(IsDefined2(schema.exclusiveMaximumTimestamp)&&!(value.getTime()<schema.exclusiveMaximumTimestamp))yield Create(ValueErrorType.DateExclusiveMaximumTimestamp,schema,path,value);if(IsDefined2(schema.exclusiveMinimumTimestamp)&&!(value.getTime()>schema.exclusiveMinimumTimestamp))yield Create(ValueErrorType.DateExclusiveMinimumTimestamp,schema,path,value);if(IsDefined2(schema.maximumTimestamp)&&!(value.getTime()<=schema.maximumTimestamp))yield Create(ValueErrorType.DateMaximumTimestamp,schema,path,value);if(IsDefined2(schema.minimumTimestamp)&&!(value.getTime()>=schema.minimumTimestamp))yield Create(ValueErrorType.DateMinimumTimestamp,schema,path,value);if(IsDefined2(schema.multipleOfTimestamp)&&value.getTime()%schema.multipleOfTimestamp!==0)yield Create(ValueErrorType.DateMultipleOfTimestamp,schema,path,value)}function*FromFunction5(schema,references,path,value){if(!IsFunction2(value))yield Create(ValueErrorType.Function,schema,path,value)}function*FromImport2(schema,references,path,value){let definitions=globalThis.Object.values(schema.$defs),target=schema.$defs[schema.$ref];yield*Visit6(target,[...references,...definitions],path,value)}function*FromInteger3(schema,references,path,value){if(!IsInteger(value))return yield Create(ValueErrorType.Integer,schema,path,value);if(IsDefined2(schema.exclusiveMaximum)&&!(value<schema.exclusiveMaximum))yield Create(ValueErrorType.IntegerExclusiveMaximum,schema,path,value);if(IsDefined2(schema.exclusiveMinimum)&&!(value>schema.exclusiveMinimum))yield Create(ValueErrorType.IntegerExclusiveMinimum,schema,path,value);if(IsDefined2(schema.maximum)&&!(value<=schema.maximum))yield Create(ValueErrorType.IntegerMaximum,schema,path,value);if(IsDefined2(schema.minimum)&&!(value>=schema.minimum))yield Create(ValueErrorType.IntegerMinimum,schema,path,value);if(IsDefined2(schema.multipleOf)&&value%schema.multipleOf!==0)yield Create(ValueErrorType.IntegerMultipleOf,schema,path,value)}function*FromIntersect10(schema,references,path,value){let hasError=!1;for(let inner of schema.allOf)for(let error of Visit6(inner,references,path,value))hasError=!0,yield error;if(hasError)return yield Create(ValueErrorType.Intersect,schema,path,value);if(schema.unevaluatedProperties===!1){let keyCheck=new RegExp(KeyOfPattern(schema));for(let valueKey of Object.getOwnPropertyNames(value))if(!keyCheck.test(valueKey))yield Create(ValueErrorType.IntersectUnevaluatedProperties,schema,`${path}/${valueKey}`,value)}if(typeof schema.unevaluatedProperties==="object"){let keyCheck=new RegExp(KeyOfPattern(schema));for(let valueKey of Object.getOwnPropertyNames(value))if(!keyCheck.test(valueKey)){let next=Visit6(schema.unevaluatedProperties,references,`${path}/${valueKey}`,value[valueKey]).next();if(!next.done)yield next.value}}}function*FromIterator5(schema,references,path,value){if(!IsIterator2(value))yield Create(ValueErrorType.Iterator,schema,path,value)}function*FromLiteral4(schema,references,path,value){if(value!==schema.const)yield Create(ValueErrorType.Literal,schema,path,value)}function*FromNever3(schema,references,path,value){yield Create(ValueErrorType.Never,schema,path,value)}function*FromNot3(schema,references,path,value){if(Visit6(schema.not,references,path,value).next().done===!0)yield Create(ValueErrorType.Not,schema,path,value)}function*FromNull3(schema,references,path,value){if(!IsNull2(value))yield Create(ValueErrorType.Null,schema,path,value)}function*FromNumber3(schema,references,path,value){if(!TypeSystemPolicy.IsNumberLike(value))return yield Create(ValueErrorType.Number,schema,path,value);if(IsDefined2(schema.exclusiveMaximum)&&!(value<schema.exclusiveMaximum))yield Create(ValueErrorType.NumberExclusiveMaximum,schema,path,value);if(IsDefined2(schema.exclusiveMinimum)&&!(value>schema.exclusiveMinimum))yield Create(ValueErrorType.NumberExclusiveMinimum,schema,path,value);if(IsDefined2(schema.maximum)&&!(value<=schema.maximum))yield Create(ValueErrorType.NumberMaximum,schema,path,value);if(IsDefined2(schema.minimum)&&!(value>=schema.minimum))yield Create(ValueErrorType.NumberMinimum,schema,path,value);if(IsDefined2(schema.multipleOf)&&value%schema.multipleOf!==0)yield Create(ValueErrorType.NumberMultipleOf,schema,path,value)}function*FromObject9(schema,references,path,value){if(!TypeSystemPolicy.IsObjectLike(value))return yield Create(ValueErrorType.Object,schema,path,value);if(IsDefined2(schema.minProperties)&&!(Object.getOwnPropertyNames(value).length>=schema.minProperties))yield Create(ValueErrorType.ObjectMinProperties,schema,path,value);if(IsDefined2(schema.maxProperties)&&!(Object.getOwnPropertyNames(value).length<=schema.maxProperties))yield Create(ValueErrorType.ObjectMaxProperties,schema,path,value);let requiredKeys=Array.isArray(schema.required)?schema.required:[],knownKeys=Object.getOwnPropertyNames(schema.properties),unknownKeys=Object.getOwnPropertyNames(value);for(let requiredKey of requiredKeys){if(unknownKeys.includes(requiredKey))continue;yield Create(ValueErrorType.ObjectRequiredProperty,schema.properties[requiredKey],`${path}/${EscapeKey(requiredKey)}`,void 0)}if(schema.additionalProperties===!1){for(let valueKey of unknownKeys)if(!knownKeys.includes(valueKey))yield Create(ValueErrorType.ObjectAdditionalProperties,schema,`${path}/${EscapeKey(valueKey)}`,value[valueKey])}if(typeof schema.additionalProperties==="object")for(let valueKey of unknownKeys){if(knownKeys.includes(valueKey))continue;yield*Visit6(schema.additionalProperties,references,`${path}/${EscapeKey(valueKey)}`,value[valueKey])}for(let knownKey of knownKeys){let property=schema.properties[knownKey];if(schema.required&&schema.required.includes(knownKey)){if(yield*Visit6(property,references,`${path}/${EscapeKey(knownKey)}`,value[knownKey]),ExtendsUndefinedCheck(schema)&&!(knownKey in value))yield Create(ValueErrorType.ObjectRequiredProperty,property,`${path}/${EscapeKey(knownKey)}`,void 0)}else if(TypeSystemPolicy.IsExactOptionalProperty(value,knownKey))yield*Visit6(property,references,`${path}/${EscapeKey(knownKey)}`,value[knownKey])}}function*FromPromise5(schema,references,path,value){if(!IsPromise(value))yield Create(ValueErrorType.Promise,schema,path,value)}function*FromRecord5(schema,references,path,value){if(!TypeSystemPolicy.IsRecordLike(value))return yield Create(ValueErrorType.Object,schema,path,value);if(IsDefined2(schema.minProperties)&&!(Object.getOwnPropertyNames(value).length>=schema.minProperties))yield Create(ValueErrorType.ObjectMinProperties,schema,path,value);if(IsDefined2(schema.maxProperties)&&!(Object.getOwnPropertyNames(value).length<=schema.maxProperties))yield Create(ValueErrorType.ObjectMaxProperties,schema,path,value);let[patternKey,patternSchema]=Object.entries(schema.patternProperties)[0],regex=new RegExp(patternKey);for(let[propertyKey,propertyValue]of Object.entries(value))if(regex.test(propertyKey))yield*Visit6(patternSchema,references,`${path}/${EscapeKey(propertyKey)}`,propertyValue);if(typeof schema.additionalProperties==="object"){for(let[propertyKey,propertyValue]of Object.entries(value))if(!regex.test(propertyKey))yield*Visit6(schema.additionalProperties,references,`${path}/${EscapeKey(propertyKey)}`,propertyValue)}if(schema.additionalProperties===!1)for(let[propertyKey,propertyValue]of Object.entries(value)){if(regex.test(propertyKey))continue;return yield Create(ValueErrorType.ObjectAdditionalProperties,schema,`${path}/${EscapeKey(propertyKey)}`,propertyValue)}}function*FromRef6(schema,references,path,value){yield*Visit6(Deref(schema,references),references,path,value)}function*FromRegExp3(schema,references,path,value){if(!IsString2(value))return yield Create(ValueErrorType.String,schema,path,value);if(IsDefined2(schema.minLength)&&!(value.length>=schema.minLength))yield Create(ValueErrorType.StringMinLength,schema,path,value);if(IsDefined2(schema.maxLength)&&!(value.length<=schema.maxLength))yield Create(ValueErrorType.StringMaxLength,schema,path,value);if(!new RegExp(schema.source,schema.flags).test(value))return yield Create(ValueErrorType.RegExp,schema,path,value)}function*FromString3(schema,references,path,value){if(!IsString2(value))return yield Create(ValueErrorType.String,schema,path,value);if(IsDefined2(schema.minLength)&&!(value.length>=schema.minLength))yield Create(ValueErrorType.StringMinLength,schema,path,value);if(IsDefined2(schema.maxLength)&&!(value.length<=schema.maxLength))yield Create(ValueErrorType.StringMaxLength,schema,path,value);if(IsString2(schema.pattern)){if(!new RegExp(schema.pattern).test(value))yield Create(ValueErrorType.StringPattern,schema,path,value)}if(IsString2(schema.format)){if(!exports_format.Has(schema.format))yield Create(ValueErrorType.StringFormatUnknown,schema,path,value);else if(!exports_format.Get(schema.format)(value))yield Create(ValueErrorType.StringFormat,schema,path,value)}}function*FromSymbol3(schema,references,path,value){if(!IsSymbol2(value))yield Create(ValueErrorType.Symbol,schema,path,value)}function*FromTemplateLiteral5(schema,references,path,value){if(!IsString2(value))return yield Create(ValueErrorType.String,schema,path,value);if(!new RegExp(schema.pattern).test(value))yield Create(ValueErrorType.StringPattern,schema,path,value)}function*FromThis2(schema,references,path,value){yield*Visit6(Deref(schema,references),references,path,value)}function*FromTuple7(schema,references,path,value){if(!IsArray2(value))return yield Create(ValueErrorType.Tuple,schema,path,value);if(schema.items===void 0&&value.length!==0)return yield Create(ValueErrorType.TupleLength,schema,path,value);if(value.length!==schema.maxItems)return yield Create(ValueErrorType.TupleLength,schema,path,value);if(!schema.items)return;for(let i=0;i<schema.items.length;i++)yield*Visit6(schema.items[i],references,`${path}/${i}`,value[i])}function*FromUndefined3(schema,references,path,value){if(!IsUndefined2(value))yield Create(ValueErrorType.Undefined,schema,path,value)}function*FromUnion12(schema,references,path,value){if(Check(schema,references,value))return;let errors=schema.anyOf.map((variant)=>new ValueErrorIterator(Visit6(variant,references,path,value)));yield Create(ValueErrorType.Union,schema,path,value,errors)}function*FromUint8Array3(schema,references,path,value){if(!IsUint8Array2(value))return yield Create(ValueErrorType.Uint8Array,schema,path,value);if(IsDefined2(schema.maxByteLength)&&!(value.length<=schema.maxByteLength))yield Create(ValueErrorType.Uint8ArrayMaxByteLength,schema,path,value);if(IsDefined2(schema.minByteLength)&&!(value.length>=schema.minByteLength))yield Create(ValueErrorType.Uint8ArrayMinByteLength,schema,path,value)}function*FromUnknown3(schema,references,path,value){}function*FromVoid3(schema,references,path,value){if(!TypeSystemPolicy.IsVoidLike(value))yield Create(ValueErrorType.Void,schema,path,value)}function*FromKind2(schema,references,path,value){if(!exports_type2.Get(schema[Kind])(schema,value))yield Create(ValueErrorType.Kind,schema,path,value)}function*Visit6(schema,references,path,value){let references_=IsDefined2(schema.$id)?[...references,schema]:references,schema_=schema;switch(schema_[Kind]){case"Any":return yield*FromAny3(schema_,references_,path,value);case"Argument":return yield*FromArgument3(schema_,references_,path,value);case"Array":return yield*FromArray8(schema_,references_,path,value);case"AsyncIterator":return yield*FromAsyncIterator5(schema_,references_,path,value);case"BigInt":return yield*FromBigInt3(schema_,references_,path,value);case"Boolean":return yield*FromBoolean3(schema_,references_,path,value);case"Constructor":return yield*FromConstructor5(schema_,references_,path,value);case"Date":return yield*FromDate3(schema_,references_,path,value);case"Function":return yield*FromFunction5(schema_,references_,path,value);case"Import":return yield*FromImport2(schema_,references_,path,value);case"Integer":return yield*FromInteger3(schema_,references_,path,value);case"Intersect":return yield*FromIntersect10(schema_,references_,path,value);case"Iterator":return yield*FromIterator5(schema_,references_,path,value);case"Literal":return yield*FromLiteral4(schema_,references_,path,value);case"Never":return yield*FromNever3(schema_,references_,path,value);case"Not":return yield*FromNot3(schema_,references_,path,value);case"Null":return yield*FromNull3(schema_,references_,path,value);case"Number":return yield*FromNumber3(schema_,references_,path,value);case"Object":return yield*FromObject9(schema_,references_,path,value);case"Promise":return yield*FromPromise5(schema_,references_,path,value);case"Record":return yield*FromRecord5(schema_,references_,path,value);case"Ref":return yield*FromRef6(schema_,references_,path,value);case"RegExp":return yield*FromRegExp3(schema_,references_,path,value);case"String":return yield*FromString3(schema_,references_,path,value);case"Symbol":return yield*FromSymbol3(schema_,references_,path,value);case"TemplateLiteral":return yield*FromTemplateLiteral5(schema_,references_,path,value);case"This":return yield*FromThis2(schema_,references_,path,value);case"Tuple":return yield*FromTuple7(schema_,references_,path,value);case"Undefined":return yield*FromUndefined3(schema_,references_,path,value);case"Union":return yield*FromUnion12(schema_,references_,path,value);case"Uint8Array":return yield*FromUint8Array3(schema_,references_,path,value);case"Unknown":return yield*FromUnknown3(schema_,references_,path,value);case"Void":return yield*FromVoid3(schema_,references_,path,value);default:if(!exports_type2.Has(schema_[Kind]))throw new ValueErrorsUnknownTypeError(schema);return yield*FromKind2(schema_,references_,path,value)}}function Errors(...args){let iterator=args.length===3?Visit6(args[0],args[1],"",args[2]):Visit6(args[0],[],"",args[1]);return new ValueErrorIterator(iterator)}class TransformDecodeCheckError extends TypeBoxError{constructor(schema,value,error){super("Unable to decode value as it does not match the expected schema");this.schema=schema,this.value=value,this.error=error}}class TransformDecodeError extends TypeBoxError{constructor(schema,path,value,error){super(error instanceof Error?error.message:"Unknown error");this.schema=schema,this.path=path,this.value=value,this.error=error}}function Default(schema,path,value){try{return IsTransform(schema)?schema[TransformKind].Decode(value):value}catch(error){throw new TransformDecodeError(schema,path,value,error)}}function FromArray9(schema,references,path,value){return IsArray2(value)?Default(schema,path,value.map((value2,index)=>Visit7(schema.items,references,`${path}/${index}`,value2))):Default(schema,path,value)}function FromIntersect11(schema,references,path,value){if(!IsObject2(value)||IsValueType(value))return Default(schema,path,value);let knownEntries=KeyOfPropertyEntries(schema),knownKeys=knownEntries.map((entry)=>entry[0]),knownProperties={...value};for(let[knownKey,knownSchema]of knownEntries)if(knownKey in knownProperties)knownProperties[knownKey]=Visit7(knownSchema,references,`${path}/${knownKey}`,knownProperties[knownKey]);if(!IsTransform(schema.unevaluatedProperties))return Default(schema,path,knownProperties);let unknownKeys=Object.getOwnPropertyNames(knownProperties),unevaluatedProperties=schema.unevaluatedProperties,unknownProperties={...knownProperties};for(let key of unknownKeys)if(!knownKeys.includes(key))unknownProperties[key]=Default(unevaluatedProperties,`${path}/${key}`,unknownProperties[key]);return Default(schema,path,unknownProperties)}function FromImport3(schema,references,path,value){let additional=globalThis.Object.values(schema.$defs),target=schema.$defs[schema.$ref],result=Visit7(target,[...references,...additional],path,value);return Default(schema,path,result)}function FromNot4(schema,references,path,value){return Default(schema,path,Visit7(schema.not,references,path,value))}function FromObject10(schema,references,path,value){if(!IsObject2(value))return Default(schema,path,value);let knownKeys=KeyOfPropertyKeys(schema),knownProperties={...value};for(let key of knownKeys){if(!HasPropertyKey2(knownProperties,key))continue;if(IsUndefined2(knownProperties[key])&&(!IsUndefined3(schema.properties[key])||TypeSystemPolicy.IsExactOptionalProperty(knownProperties,key)))continue;knownProperties[key]=Visit7(schema.properties[key],references,`${path}/${key}`,knownProperties[key])}if(!IsSchema(schema.additionalProperties))return Default(schema,path,knownProperties);let unknownKeys=Object.getOwnPropertyNames(knownProperties),additionalProperties=schema.additionalProperties,unknownProperties={...knownProperties};for(let key of unknownKeys)if(!knownKeys.includes(key))unknownProperties[key]=Default(additionalProperties,`${path}/${key}`,unknownProperties[key]);return Default(schema,path,unknownProperties)}function FromRecord6(schema,references,path,value){if(!IsObject2(value))return Default(schema,path,value);let pattern=Object.getOwnPropertyNames(schema.patternProperties)[0],knownKeys=new RegExp(pattern),knownProperties={...value};for(let key of Object.getOwnPropertyNames(value))if(knownKeys.test(key))knownProperties[key]=Visit7(schema.patternProperties[pattern],references,`${path}/${key}`,knownProperties[key]);if(!IsSchema(schema.additionalProperties))return Default(schema,path,knownProperties);let unknownKeys=Object.getOwnPropertyNames(knownProperties),additionalProperties=schema.additionalProperties,unknownProperties={...knownProperties};for(let key of unknownKeys)if(!knownKeys.test(key))unknownProperties[key]=Default(additionalProperties,`${path}/${key}`,unknownProperties[key]);return Default(schema,path,unknownProperties)}function FromRef7(schema,references,path,value){let target=Deref(schema,references);return Default(schema,path,Visit7(target,references,path,value))}function FromThis3(schema,references,path,value){let target=Deref(schema,references);return Default(schema,path,Visit7(target,references,path,value))}function FromTuple8(schema,references,path,value){return IsArray2(value)&&IsArray2(schema.items)?Default(schema,path,schema.items.map((schema2,index)=>Visit7(schema2,references,`${path}/${index}`,value[index]))):Default(schema,path,value)}function FromUnion13(schema,references,path,value){for(let subschema of schema.anyOf){if(!Check(subschema,references,value))continue;let decoded=Visit7(subschema,references,path,value);return Default(schema,path,decoded)}return Default(schema,path,value)}function Visit7(schema,references,path,value){let references_=Pushref(schema,references),schema_=schema;switch(schema[Kind]){case"Array":return FromArray9(schema_,references_,path,value);case"Import":return FromImport3(schema_,references_,path,value);case"Intersect":return FromIntersect11(schema_,references_,path,value);case"Not":return FromNot4(schema_,references_,path,value);case"Object":return FromObject10(schema_,references_,path,value);case"Record":return FromRecord6(schema_,references_,path,value);case"Ref":return FromRef7(schema_,references_,path,value);case"Symbol":return Default(schema_,path,value);case"This":return FromThis3(schema_,references_,path,value);case"Tuple":return FromTuple8(schema_,references_,path,value);case"Union":return FromUnion13(schema_,references_,path,value);default:return Default(schema_,path,value)}}function TransformDecode(schema,references,value){return Visit7(schema,references,"",value)}class TransformEncodeCheckError extends TypeBoxError{constructor(schema,value,error){super("The encoded value does not match the expected schema");this.schema=schema,this.value=value,this.error=error}}class TransformEncodeError extends TypeBoxError{constructor(schema,path,value,error){super(`${error instanceof Error?error.message:"Unknown error"}`);this.schema=schema,this.path=path,this.value=value,this.error=error}}function Default2(schema,path,value){try{return IsTransform(schema)?schema[TransformKind].Encode(value):value}catch(error){throw new TransformEncodeError(schema,path,value,error)}}function FromArray10(schema,references,path,value){let defaulted=Default2(schema,path,value);return IsArray2(defaulted)?defaulted.map((value2,index)=>Visit8(schema.items,references,`${path}/${index}`,value2)):defaulted}function FromImport4(schema,references,path,value){let additional=globalThis.Object.values(schema.$defs),target=schema.$defs[schema.$ref],result=Default2(schema,path,value);return Visit8(target,[...references,...additional],path,result)}function FromIntersect12(schema,references,path,value){let defaulted=Default2(schema,path,value);if(!IsObject2(value)||IsValueType(value))return defaulted;let knownEntries=KeyOfPropertyEntries(schema),knownKeys=knownEntries.map((entry)=>entry[0]),knownProperties={...defaulted};for(let[knownKey,knownSchema]of knownEntries)if(knownKey in knownProperties)knownProperties[knownKey]=Visit8(knownSchema,references,`${path}/${knownKey}`,knownProperties[knownKey]);if(!IsTransform(schema.unevaluatedProperties))return knownProperties;let unknownKeys=Object.getOwnPropertyNames(knownProperties),unevaluatedProperties=schema.unevaluatedProperties,properties={...knownProperties};for(let key of unknownKeys)if(!knownKeys.includes(key))properties[key]=Default2(unevaluatedProperties,`${path}/${key}`,properties[key]);return properties}function FromNot5(schema,references,path,value){return Default2(schema.not,path,Default2(schema,path,value))}function FromObject11(schema,references,path,value){let defaulted=Default2(schema,path,value);if(!IsObject2(defaulted))return defaulted;let knownKeys=KeyOfPropertyKeys(schema),knownProperties={...defaulted};for(let key of knownKeys){if(!HasPropertyKey2(knownProperties,key))continue;if(IsUndefined2(knownProperties[key])&&(!IsUndefined3(schema.properties[key])||TypeSystemPolicy.IsExactOptionalProperty(knownProperties,key)))continue;knownProperties[key]=Visit8(schema.properties[key],references,`${path}/${key}`,knownProperties[key])}if(!IsSchema(schema.additionalProperties))return knownProperties;let unknownKeys=Object.getOwnPropertyNames(knownProperties),additionalProperties=schema.additionalProperties,properties={...knownProperties};for(let key of unknownKeys)if(!knownKeys.includes(key))properties[key]=Default2(additionalProperties,`${path}/${key}`,properties[key]);return properties}function FromRecord7(schema,references,path,value){let defaulted=Default2(schema,path,value);if(!IsObject2(value))return defaulted;let pattern=Object.getOwnPropertyNames(schema.patternProperties)[0],knownKeys=new RegExp(pattern),knownProperties={...defaulted};for(let key of Object.getOwnPropertyNames(value))if(knownKeys.test(key))knownProperties[key]=Visit8(schema.patternProperties[pattern],references,`${path}/${key}`,knownProperties[key]);if(!IsSchema(schema.additionalProperties))return knownProperties;let unknownKeys=Object.getOwnPropertyNames(knownProperties),additionalProperties=schema.additionalProperties,properties={...knownProperties};for(let key of unknownKeys)if(!knownKeys.test(key))properties[key]=Default2(additionalProperties,`${path}/${key}`,properties[key]);return properties}function FromRef8(schema,references,path,value){let target=Deref(schema,references),resolved=Visit8(target,references,path,value);return Default2(schema,path,resolved)}function FromThis4(schema,references,path,value){let target=Deref(schema,references),resolved=Visit8(target,references,path,value);return Default2(schema,path,resolved)}function FromTuple9(schema,references,path,value){let value1=Default2(schema,path,value);return IsArray2(schema.items)?schema.items.map((schema2,index)=>Visit8(schema2,references,`${path}/${index}`,value1[index])):[]}function FromUnion14(schema,references,path,value){for(let subschema of schema.anyOf){if(!Check(subschema,references,value))continue;let value1=Visit8(subschema,references,path,value);return Default2(schema,path,value1)}for(let subschema of schema.anyOf){let value1=Visit8(subschema,references,path,value);if(!Check(schema,references,value1))continue;return Default2(schema,path,value1)}return Default2(schema,path,value)}function Visit8(schema,references,path,value){let references_=Pushref(schema,references),schema_=schema;switch(schema[Kind]){case"Array":return FromArray10(schema_,references_,path,value);case"Import":return FromImport4(schema_,references_,path,value);case"Intersect":return FromIntersect12(schema_,references_,path,value);case"Not":return FromNot5(schema_,references_,path,value);case"Object":return FromObject11(schema_,references_,path,value);case"Record":return FromRecord7(schema_,references_,path,value);case"Ref":return FromRef8(schema_,references_,path,value);case"This":return FromThis4(schema_,references_,path,value);case"Tuple":return FromTuple9(schema_,references_,path,value);case"Union":return FromUnion14(schema_,references_,path,value);default:return Default2(schema_,path,value)}}function TransformEncode(schema,references,value){return Visit8(schema,references,"",value)}function FromArray11(schema,references){return IsTransform(schema)||Visit9(schema.items,references)}function FromAsyncIterator6(schema,references){return IsTransform(schema)||Visit9(schema.items,references)}function FromConstructor6(schema,references){return IsTransform(schema)||Visit9(schema.returns,references)||schema.parameters.some((schema2)=>Visit9(schema2,references))}function FromFunction6(schema,references){return IsTransform(schema)||Visit9(schema.returns,references)||schema.parameters.some((schema2)=>Visit9(schema2,references))}function FromIntersect13(schema,references){return IsTransform(schema)||IsTransform(schema.unevaluatedProperties)||schema.allOf.some((schema2)=>Visit9(schema2,references))}function FromImport5(schema,references){let additional=globalThis.Object.getOwnPropertyNames(schema.$defs).reduce((result,key)=>[...result,schema.$defs[key]],[]),target=schema.$defs[schema.$ref];return IsTransform(schema)||Visit9(target,[...additional,...references])}function FromIterator6(schema,references){return IsTransform(schema)||Visit9(schema.items,references)}function FromNot6(schema,references){return IsTransform(schema)||Visit9(schema.not,references)}function FromObject12(schema,references){return IsTransform(schema)||Object.values(schema.properties).some((schema2)=>Visit9(schema2,references))||IsSchema(schema.additionalProperties)&&Visit9(schema.additionalProperties,references)}function FromPromise6(schema,references){return IsTransform(schema)||Visit9(schema.item,references)}function FromRecord8(schema,references){let pattern=Object.getOwnPropertyNames(schema.patternProperties)[0],property=schema.patternProperties[pattern];return IsTransform(schema)||Visit9(property,references)||IsSchema(schema.additionalProperties)&&IsTransform(schema.additionalProperties)}function FromRef9(schema,references){if(IsTransform(schema))return!0;return Visit9(Deref(schema,references),references)}function FromThis5(schema,references){if(IsTransform(schema))return!0;return Visit9(Deref(schema,references),references)}function FromTuple10(schema,references){return IsTransform(schema)||!IsUndefined2(schema.items)&&schema.items.some((schema2)=>Visit9(schema2,references))}function FromUnion15(schema,references){return IsTransform(schema)||schema.anyOf.some((schema2)=>Visit9(schema2,references))}function Visit9(schema,references){let references_=Pushref(schema,references),schema_=schema;if(schema.$id&&visited.has(schema.$id))return!1;if(schema.$id)visited.add(schema.$id);switch(schema[Kind]){case"Array":return FromArray11(schema_,references_);case"AsyncIterator":return FromAsyncIterator6(schema_,references_);case"Constructor":return FromConstructor6(schema_,references_);case"Function":return FromFunction6(schema_,references_);case"Import":return FromImport5(schema_,references_);case"Intersect":return FromIntersect13(schema_,references_);case"Iterator":return FromIterator6(schema_,references_);case"Not":return FromNot6(schema_,references_);case"Object":return FromObject12(schema_,references_);case"Promise":return FromPromise6(schema_,references_);case"Record":return FromRecord8(schema_,references_);case"Ref":return FromRef9(schema_,references_);case"This":return FromThis5(schema_,references_);case"Tuple":return FromTuple10(schema_,references_);case"Union":return FromUnion15(schema_,references_);default:return IsTransform(schema)}}var visited=new Set;function HasTransform(schema,references){return visited.clear(),Visit9(schema,references)}class TypeCheck{constructor(schema,references,checkFunc,code){this.schema=schema,this.references=references,this.checkFunc=checkFunc,this.code=code,this.hasTransform=HasTransform(schema,references)}Code(){return this.code}Schema(){return this.schema}References(){return this.references}Errors(value){return Errors(this.schema,this.references,value)}Check(value){return this.checkFunc(value)}Decode(value){if(!this.checkFunc(value))throw new TransformDecodeCheckError(this.schema,value,this.Errors(value).First());return this.hasTransform?TransformDecode(this.schema,this.references,value):value}Encode(value){let encoded=this.hasTransform?TransformEncode(this.schema,this.references,value):value;if(!this.checkFunc(encoded))throw new TransformEncodeCheckError(this.schema,value,this.Errors(value).First());return encoded}}var Character;(function(Character2){function DollarSign(code){return code===36}Character2.DollarSign=DollarSign;function IsUnderscore(code){return code===95}Character2.IsUnderscore=IsUnderscore;function IsAlpha(code){return code>=65&&code<=90||code>=97&&code<=122}Character2.IsAlpha=IsAlpha;function IsNumeric(code){return code>=48&&code<=57}Character2.IsNumeric=IsNumeric})(Character||(Character={}));var MemberExpression;(function(MemberExpression2){function IsFirstCharacterNumeric(value){if(value.length===0)return!1;return Character.IsNumeric(value.charCodeAt(0))}function IsAccessor(value){if(IsFirstCharacterNumeric(value))return!1;for(let i=0;i<value.length;i++){let code=value.charCodeAt(i);if(!(Character.IsAlpha(code)||Character.IsNumeric(code)||Character.DollarSign(code)||Character.IsUnderscore(code)))return!1}return!0}function EscapeHyphen(key){return key.replace(/'/g,"\\'")}function Encode(object,key){return IsAccessor(key)?`${object}.${key}`:`${object}['${EscapeHyphen(key)}']`}MemberExpression2.Encode=Encode})(MemberExpression||(MemberExpression={}));var Identifier;(function(Identifier2){function Encode($id){let buffer=[];for(let i=0;i<$id.length;i++){let code=$id.charCodeAt(i);if(Character.IsNumeric(code)||Character.IsAlpha(code))buffer.push($id.charAt(i));else buffer.push(`_${code}_`)}return buffer.join("").replace(/__/g,"_")}Identifier2.Encode=Encode})(Identifier||(Identifier={}));var LiteralString;(function(LiteralString2){function Escape2(content){return content.replace(/'/g,"\\'")}LiteralString2.Escape=Escape2})(LiteralString||(LiteralString={}));class TypeCompilerUnknownTypeError extends TypeBoxError{constructor(schema){super("Unknown type");this.schema=schema}}class TypeCompilerTypeGuardError extends TypeBoxError{constructor(schema){super("Preflight validation check failed to guard for the given schema");this.schema=schema}}var Policy;(function(Policy2){function IsExactOptionalProperty(value,key,expression){return TypeSystemPolicy.ExactOptionalPropertyTypes?`('${key}' in ${value} ? ${expression} : true)`:`(${MemberExpression.Encode(value,key)} !== undefined ? ${expression} : true)`}Policy2.IsExactOptionalProperty=IsExactOptionalProperty;function IsObjectLike(value){return!TypeSystemPolicy.AllowArrayObject?`(typeof ${value} === 'object' && ${value} !== null && !Array.isArray(${value}))`:`(typeof ${value} === 'object' && ${value} !== null)`}Policy2.IsObjectLike=IsObjectLike;function IsRecordLike(value){return!TypeSystemPolicy.AllowArrayObject?`(typeof ${value} === 'object' && ${value} !== null && !Array.isArray(${value}) && !(${value} instanceof Date) && !(${value} instanceof Uint8Array))`:`(typeof ${value} === 'object' && ${value} !== null && !(${value} instanceof Date) && !(${value} instanceof Uint8Array))`}Policy2.IsRecordLike=IsRecordLike;function IsNumberLike(value){return TypeSystemPolicy.AllowNaN?`typeof ${value} === 'number'`:`Number.isFinite(${value})`}Policy2.IsNumberLike=IsNumberLike;function IsVoidLike(value){return TypeSystemPolicy.AllowNullVoid?`(${value} === undefined || ${value} === null)`:`${value} === undefined`}Policy2.IsVoidLike=IsVoidLike})(Policy||(Policy={}));var TypeCompiler;(function(TypeCompiler2){function IsAnyOrUnknown2(schema){return schema[Kind]==="Any"||schema[Kind]==="Unknown"}function*FromAny4(schema,references,value){yield"true"}function*FromArgument4(schema,references,value){yield"true"}function*FromArray12(schema,references,value){yield`Array.isArray(${value})`;let[parameter,accumulator]=[CreateParameter("value","any"),CreateParameter("acc","number")];if(IsNumber2(schema.maxItems))yield`${value}.length <= ${schema.maxItems}`;if(IsNumber2(schema.minItems))yield`${value}.length >= ${schema.minItems}`;let elementExpression=CreateExpression(schema.items,references,"value");if(yield`${value}.every((${parameter}) => ${elementExpression})`,IsSchema2(schema.contains)||IsNumber2(schema.minContains)||IsNumber2(schema.maxContains)){let containsSchema=IsSchema2(schema.contains)?schema.contains:Never(),checkExpression=CreateExpression(containsSchema,references,"value"),checkMinContains=IsNumber2(schema.minContains)?[`(count >= ${schema.minContains})`]:[],checkMaxContains=IsNumber2(schema.maxContains)?[`(count <= ${schema.maxContains})`]:[],checkCount=`const count = value.reduce((${accumulator}, ${parameter}) => ${checkExpression} ? acc + 1 : acc, 0)`,check=["(count > 0)",...checkMinContains,...checkMaxContains].join(" && ");yield`((${parameter}) => { ${checkCount}; return ${check}})(${value})`}if(schema.uniqueItems===!0)yield`((${parameter}) => { const set = new Set(); for(const element of value) { const hashed = hash(element); if(set.has(hashed)) { return false } else { set.add(hashed) } } return true } )(${value})`}function*FromAsyncIterator7(schema,references,value){yield`(typeof value === 'object' && Symbol.asyncIterator in ${value})`}function*FromBigInt4(schema,references,value){if(yield`(typeof ${value} === 'bigint')`,IsBigInt2(schema.exclusiveMaximum))yield`${value} < BigInt(${schema.exclusiveMaximum})`;if(IsBigInt2(schema.exclusiveMinimum))yield`${value} > BigInt(${schema.exclusiveMinimum})`;if(IsBigInt2(schema.maximum))yield`${value} <= BigInt(${schema.maximum})`;if(IsBigInt2(schema.minimum))yield`${value} >= BigInt(${schema.minimum})`;if(IsBigInt2(schema.multipleOf))yield`(${value} % BigInt(${schema.multipleOf})) === 0`}function*FromBoolean4(schema,references,value){yield`(typeof ${value} === 'boolean')`}function*FromConstructor7(schema,references,value){yield*Visit10(schema.returns,references,`${value}.prototype`)}function*FromDate4(schema,references,value){if(yield`(${value} instanceof Date) && Number.isFinite(${value}.getTime())`,IsNumber2(schema.exclusiveMaximumTimestamp))yield`${value}.getTime() < ${schema.exclusiveMaximumTimestamp}`;if(IsNumber2(schema.exclusiveMinimumTimestamp))yield`${value}.getTime() > ${schema.exclusiveMinimumTimestamp}`;if(IsNumber2(schema.maximumTimestamp))yield`${value}.getTime() <= ${schema.maximumTimestamp}`;if(IsNumber2(schema.minimumTimestamp))yield`${value}.getTime() >= ${schema.minimumTimestamp}`;if(IsNumber2(schema.multipleOfTimestamp))yield`(${value}.getTime() % ${schema.multipleOfTimestamp}) === 0`}function*FromFunction7(schema,references,value){yield`(typeof ${value} === 'function')`}function*FromImport6(schema,references,value){let members=globalThis.Object.getOwnPropertyNames(schema.$defs).reduce((result,key)=>{return[...result,schema.$defs[key]]},[]);yield*Visit10(Ref(schema.$ref),[...references,...members],value)}function*FromInteger4(schema,references,value){if(yield`Number.isInteger(${value})`,IsNumber2(schema.exclusiveMaximum))yield`${value} < ${schema.exclusiveMaximum}`;if(IsNumber2(schema.exclusiveMinimum))yield`${value} > ${schema.exclusiveMinimum}`;if(IsNumber2(schema.maximum))yield`${value} <= ${schema.maximum}`;if(IsNumber2(schema.minimum))yield`${value} >= ${schema.minimum}`;if(IsNumber2(schema.multipleOf))yield`(${value} % ${schema.multipleOf}) === 0`}function*FromIntersect14(schema,references,value){let check1=schema.allOf.map((schema2)=>CreateExpression(schema2,references,value)).join(" && ");if(schema.unevaluatedProperties===!1){let keyCheck=CreateVariable(`${new RegExp(KeyOfPattern(schema))};`),check2=`Object.getOwnPropertyNames(${value}).every(key => ${keyCheck}.test(key))`;yield`(${check1} && ${check2})`}else if(IsSchema2(schema.unevaluatedProperties)){let keyCheck=CreateVariable(`${new RegExp(KeyOfPattern(schema))};`),check2=`Object.getOwnPropertyNames(${value}).every(key => ${keyCheck}.test(key) || ${CreateExpression(schema.unevaluatedProperties,references,`${value}[key]`)})`;yield`(${check1} && ${check2})`}else yield`(${check1})`}function*FromIterator7(schema,references,value){yield`(typeof value === 'object' && Symbol.iterator in ${value})`}function*FromLiteral5(schema,references,value){if(typeof schema.const==="number"||typeof schema.const==="boolean")yield`(${value} === ${schema.const})`;else yield`(${value} === '${LiteralString.Escape(schema.const)}')`}function*FromNever4(schema,references,value){yield"false"}function*FromNot7(schema,references,value){yield`(!${CreateExpression(schema.not,references,value)})`}function*FromNull4(schema,references,value){yield`(${value} === null)`}function*FromNumber4(schema,references,value){if(yield Policy.IsNumberLike(value),IsNumber2(schema.exclusiveMaximum))yield`${value} < ${schema.exclusiveMaximum}`;if(IsNumber2(schema.exclusiveMinimum))yield`${value} > ${schema.exclusiveMinimum}`;if(IsNumber2(schema.maximum))yield`${value} <= ${schema.maximum}`;if(IsNumber2(schema.minimum))yield`${value} >= ${schema.minimum}`;if(IsNumber2(schema.multipleOf))yield`(${value} % ${schema.multipleOf}) === 0`}function*FromObject13(schema,references,value){if(yield Policy.IsObjectLike(value),IsNumber2(schema.minProperties))yield`Object.getOwnPropertyNames(${value}).length >= ${schema.minProperties}`;if(IsNumber2(schema.maxProperties))yield`Object.getOwnPropertyNames(${value}).length <= ${schema.maxProperties}`;let knownKeys=Object.getOwnPropertyNames(schema.properties);for(let knownKey of knownKeys){let memberExpression=MemberExpression.Encode(value,knownKey),property=schema.properties[knownKey];if(schema.required&&schema.required.includes(knownKey)){if(yield*Visit10(property,references,memberExpression),ExtendsUndefinedCheck(property)||IsAnyOrUnknown2(property))yield`('${knownKey}' in ${value})`}else{let expression=CreateExpression(property,references,memberExpression);yield Policy.IsExactOptionalProperty(value,knownKey,expression)}}if(schema.additionalProperties===!1)if(schema.required&&schema.required.length===knownKeys.length)yield`Object.getOwnPropertyNames(${value}).length === ${knownKeys.length}`;else{let keys=`[${knownKeys.map((key)=>`'${key}'`).join(", ")}]`;yield`Object.getOwnPropertyNames(${value}).every(key => ${keys}.includes(key))`}if(typeof schema.additionalProperties==="object"){let expression=CreateExpression(schema.additionalProperties,references,`${value}[key]`),keys=`[${knownKeys.map((key)=>`'${key}'`).join(", ")}]`;yield`(Object.getOwnPropertyNames(${value}).every(key => ${keys}.includes(key) || ${expression}))`}}function*FromPromise7(schema,references,value){yield`${value} instanceof Promise`}function*FromRecord9(schema,references,value){if(yield Policy.IsRecordLike(value),IsNumber2(schema.minProperties))yield`Object.getOwnPropertyNames(${value}).length >= ${schema.minProperties}`;if(IsNumber2(schema.maxProperties))yield`Object.getOwnPropertyNames(${value}).length <= ${schema.maxProperties}`;let[patternKey,patternSchema]=Object.entries(schema.patternProperties)[0],variable=CreateVariable(`${new RegExp(patternKey)}`),check1=CreateExpression(patternSchema,references,"value"),check2=IsSchema2(schema.additionalProperties)?CreateExpression(schema.additionalProperties,references,value):schema.additionalProperties===!1?"false":"true",expression=`(${variable}.test(key) ? ${check1} : ${check2})`;yield`(Object.entries(${value}).every(([key, value]) => ${expression}))`}function*FromRef10(schema,references,value){let target=Deref(schema,references);if(state.functions.has(schema.$ref))return yield`${CreateFunctionName(schema.$ref)}(${value})`;yield*Visit10(target,references,value)}function*FromRegExp4(schema,references,value){let variable=CreateVariable(`${new RegExp(schema.source,schema.flags)};`);if(yield`(typeof ${value} === 'string')`,IsNumber2(schema.maxLength))yield`${value}.length <= ${schema.maxLength}`;if(IsNumber2(schema.minLength))yield`${value}.length >= ${schema.minLength}`;yield`${variable}.test(${value})`}function*FromString4(schema,references,value){if(yield`(typeof ${value} === 'string')`,IsNumber2(schema.maxLength))yield`${value}.length <= ${schema.maxLength}`;if(IsNumber2(schema.minLength))yield`${value}.length >= ${schema.minLength}`;if(schema.pattern!==void 0)yield`${CreateVariable(`${new RegExp(schema.pattern)};`)}.test(${value})`;if(schema.format!==void 0)yield`format('${schema.format}', ${value})`}function*FromSymbol4(schema,references,value){yield`(typeof ${value} === 'symbol')`}function*FromTemplateLiteral6(schema,references,value){yield`(typeof ${value} === 'string')`,yield`${CreateVariable(`${new RegExp(schema.pattern)};`)}.test(${value})`}function*FromThis6(schema,references,value){yield`${CreateFunctionName(schema.$ref)}(${value})`}function*FromTuple11(schema,references,value){if(yield`Array.isArray(${value})`,schema.items===void 0)return yield`${value}.length === 0`;yield`(${value}.length === ${schema.maxItems})`;for(let i=0;i<schema.items.length;i++)yield`${CreateExpression(schema.items[i],references,`${value}[${i}]`)}`}function*FromUndefined4(schema,references,value){yield`${value} === undefined`}function*FromUnion16(schema,references,value){yield`(${schema.anyOf.map((schema2)=>CreateExpression(schema2,references,value)).join(" || ")})`}function*FromUint8Array4(schema,references,value){if(yield`${value} instanceof Uint8Array`,IsNumber2(schema.maxByteLength))yield`(${value}.length <= ${schema.maxByteLength})`;if(IsNumber2(schema.minByteLength))yield`(${value}.length >= ${schema.minByteLength})`}function*FromUnknown4(schema,references,value){yield"true"}function*FromVoid4(schema,references,value){yield Policy.IsVoidLike(value)}function*FromKind3(schema,references,value){let instance=state.instances.size;state.instances.set(instance,schema),yield`kind('${schema[Kind]}', ${instance}, ${value})`}function*Visit10(schema,references,value,useHoisting=!0){let references_=IsString2(schema.$id)?[...references,schema]:references,schema_=schema;if(useHoisting&&IsString2(schema.$id)){let functionName=CreateFunctionName(schema.$id);if(state.functions.has(functionName))return yield`${functionName}(${value})`;else{state.functions.set(functionName,"<deferred>");let functionCode=CreateFunction(functionName,schema,references,"value",!1);return state.functions.set(functionName,functionCode),yield`${functionName}(${value})`}}switch(schema_[Kind]){case"Any":return yield*FromAny4(schema_,references_,value);case"Argument":return yield*FromArgument4(schema_,references_,value);case"Array":return yield*FromArray12(schema_,references_,value);case"AsyncIterator":return yield*FromAsyncIterator7(schema_,references_,value);case"BigInt":return yield*FromBigInt4(schema_,references_,value);case"Boolean":return yield*FromBoolean4(schema_,references_,value);case"Constructor":return yield*FromConstructor7(schema_,references_,value);case"Date":return yield*FromDate4(schema_,references_,value);case"Function":return yield*FromFunction7(schema_,references_,value);case"Import":return yield*FromImport6(schema_,references_,value);case"Integer":return yield*FromInteger4(schema_,references_,value);case"Intersect":return yield*FromIntersect14(schema_,references_,value);case"Iterator":return yield*FromIterator7(schema_,references_,value);case"Literal":return yield*FromLiteral5(schema_,references_,value);case"Never":return yield*FromNever4(schema_,references_,value);case"Not":return yield*FromNot7(schema_,references_,value);case"Null":return yield*FromNull4(schema_,references_,value);case"Number":return yield*FromNumber4(schema_,references_,value);case"Object":return yield*FromObject13(schema_,references_,value);case"Promise":return yield*FromPromise7(schema_,references_,value);case"Record":return yield*FromRecord9(schema_,references_,value);case"Ref":return yield*FromRef10(schema_,references_,value);case"RegExp":return yield*FromRegExp4(schema_,references_,value);case"String":return yield*FromString4(schema_,references_,value);case"Symbol":return yield*FromSymbol4(schema_,references_,value);case"TemplateLiteral":return yield*FromTemplateLiteral6(schema_,references_,value);case"This":return yield*FromThis6(schema_,references_,value);case"Tuple":return yield*FromTuple11(schema_,references_,value);case"Undefined":return yield*FromUndefined4(schema_,references_,value);case"Union":return yield*FromUnion16(schema_,references_,value);case"Uint8Array":return yield*FromUint8Array4(schema_,references_,value);case"Unknown":return yield*FromUnknown4(schema_,references_,value);case"Void":return yield*FromVoid4(schema_,references_,value);default:if(!exports_type2.Has(schema_[Kind]))throw new TypeCompilerUnknownTypeError(schema);return yield*FromKind3(schema_,references_,value)}}let state={language:"javascript",functions:new Map,variables:new Map,instances:new Map};function CreateExpression(schema,references,value,useHoisting=!0){return`(${[...Visit10(schema,references,value,useHoisting)].join(" && ")})`}function CreateFunctionName($id){return`check_${Identifier.Encode($id)}`}function CreateVariable(expression){let variableName=`local_${state.variables.size}`;return state.variables.set(variableName,`const ${variableName} = ${expression}`),variableName}function CreateFunction(name,schema,references,value,useHoisting=!0){let[newline,pad]=[`
`,(length)=>"".padStart(length," ")],parameter=CreateParameter("value","any"),returns=CreateReturns("boolean"),expression=[...Visit10(schema,references,value,useHoisting)].map((expression2)=>`${pad(4)}${expression2}`).join(` &&${newline}`);return`function ${name}(${parameter})${returns} {${newline}${pad(2)}return (${newline}${expression}${newline}${pad(2)})
}`}function CreateParameter(name,type){let annotation=state.language==="typescript"?`: ${type}`:"";return`${name}${annotation}`}function CreateReturns(type){return state.language==="typescript"?`: ${type}`:""}function Build(schema,references,options){let functionCode=CreateFunction("check",schema,references,"value"),parameter=CreateParameter("value","any"),returns=CreateReturns("boolean"),functions=[...state.functions.values()],variables=[...state.variables.values()],checkFunction=IsString2(schema.$id)?`return function check(${parameter})${returns} {
  return ${CreateFunctionName(schema.$id)}(value)
}`:`return ${functionCode}`;return[...variables,...functions,checkFunction].join(`
`)}function Code(...args){let defaults={language:"javascript"},[schema,references,options]=args.length===2&&IsArray2(args[1])?[args[0],args[1],defaults]:args.length===2&&!IsArray2(args[1])?[args[0],[],args[1]]:args.length===3?[args[0],args[1],args[2]]:args.length===1?[args[0],[],defaults]:[null,[],defaults];if(state.language=options.language,state.variables.clear(),state.functions.clear(),state.instances.clear(),!IsSchema2(schema))throw new TypeCompilerTypeGuardError(schema);for(let schema2 of references)if(!IsSchema2(schema2))throw new TypeCompilerTypeGuardError(schema2);return Build(schema,references,options)}TypeCompiler2.Code=Code;function Compile(schema,references=[]){let generatedCode=Code(schema,references,{language:"javascript"}),compiledFunction=globalThis.Function("kind","format","hash",generatedCode),instances=new Map(state.instances);function typeRegistryFunction(kind,instance,value){if(!exports_type2.Has(kind)||!instances.has(instance))return!1;let checkFunc=exports_type2.Get(kind),schema2=instances.get(instance);return checkFunc(schema2,value)}function formatRegistryFunction(format,value){if(!exports_format.Has(format))return!1;return exports_format.Get(format)(value)}function hashFunction(value){return Hash(value)}let checkFunction=compiledFunction(typeRegistryFunction,formatRegistryFunction,hashFunction);return new TypeCheck(schema,references,checkFunction,generatedCode)}TypeCompiler2.Compile=Compile})(TypeCompiler||(TypeCompiler={}));var __classPrivateFieldSet=function(receiver,state,value,kind,f){if(kind==="m")throw new TypeError("Private method is not writable");if(kind==="a"&&!f)throw new TypeError("Private accessor was defined without a setter");if(typeof state==="function"?receiver!==state||!f:!state.has(receiver))throw new TypeError("Cannot write private member to an object whose class did not declare it");return kind==="a"?f.call(receiver,value):f?f.value=value:state.set(receiver,value),value},__classPrivateFieldGet=function(receiver,state,kind,f){if(kind==="a"&&!f)throw new TypeError("Private accessor was defined without a getter");if(typeof state==="function"?receiver!==state||!f:!state.has(receiver))throw new TypeError("Cannot read private member from an object whose class did not declare it");return kind==="m"?f:kind==="a"?f.call(receiver):f?f.value:state.get(receiver)},_AssertError_instances,_AssertError_iterator,_AssertError_Iterator;class AssertError extends TypeBoxError{constructor(iterator){let error=iterator.First();super(error===void 0?"Invalid Value":error.message);_AssertError_instances.add(this),_AssertError_iterator.set(this,void 0),__classPrivateFieldSet(this,_AssertError_iterator,iterator,"f"),this.error=error}Errors(){return new ValueErrorIterator(__classPrivateFieldGet(this,_AssertError_instances,"m",_AssertError_Iterator).call(this))}}_AssertError_iterator=new WeakMap,_AssertError_instances=new WeakSet,_AssertError_Iterator=function*_AssertError_Iterator2(){if(this.error)yield this.error;yield*__classPrivateFieldGet(this,_AssertError_iterator,"f")};function AssertValue(schema,references,value){if(Check(schema,references,value))return;throw new AssertError(Errors(schema,references,value))}function Assert(...args){return args.length===3?AssertValue(args[0],args[1],args[2]):AssertValue(args[0],[],args[1])}function FromObject13(value){let Acc={};for(let key of Object.getOwnPropertyNames(value))Acc[key]=Clone2(value[key]);for(let key of Object.getOwnPropertySymbols(value))Acc[key]=Clone2(value[key]);return Acc}function FromArray12(value){return value.map((element)=>Clone2(element))}function FromTypedArray(value){return value.slice()}function FromMap(value){return new Map(Clone2([...value.entries()]))}function FromSet(value){return new Set(Clone2([...value.entries()]))}function FromDate4(value){return new Date(value.toISOString())}function FromValue2(value){return value}function Clone2(value){if(IsArray2(value))return FromArray12(value);if(IsDate2(value))return FromDate4(value);if(IsTypedArray(value))return FromTypedArray(value);if(IsMap(value))return FromMap(value);if(IsSet(value))return FromSet(value);if(IsObject2(value))return FromObject13(value);if(IsValueType(value))return FromValue2(value);throw new Error("ValueClone: Unable to clone value")}class ValueCreateError extends TypeBoxError{constructor(schema,message){super(message);this.schema=schema}}function FromDefault(value){return IsFunction2(value)?value():Clone2(value)}function FromAny4(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else return{}}function FromArgument4(schema,references){return{}}function FromArray13(schema,references){if(schema.uniqueItems===!0&&!HasPropertyKey2(schema,"default"))throw new ValueCreateError(schema,"Array with the uniqueItems constraint requires a default value");else if("contains"in schema&&!HasPropertyKey2(schema,"default"))throw new ValueCreateError(schema,"Array with the contains constraint requires a default value");else if("default"in schema)return FromDefault(schema.default);else if(schema.minItems!==void 0)return Array.from({length:schema.minItems}).map((item)=>{return Visit10(schema.items,references)});else return[]}function FromAsyncIterator7(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else return async function*(){}()}function FromBigInt4(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else return BigInt(0)}function FromBoolean4(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else return!1}function FromConstructor7(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else{let value=Visit10(schema.returns,references);if(typeof value==="object"&&!Array.isArray(value))return class{constructor(){for(let[key,val]of Object.entries(value)){let self2=this;self2[key]=val}}};else return class{}}}function FromDate5(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else if(schema.minimumTimestamp!==void 0)return new Date(schema.minimumTimestamp);else return new Date}function FromFunction7(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else return()=>Visit10(schema.returns,references)}function FromImport6(schema,references){let definitions=globalThis.Object.values(schema.$defs),target=schema.$defs[schema.$ref];return Visit10(target,[...references,...definitions])}function FromInteger4(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else if(schema.minimum!==void 0)return schema.minimum;else return 0}function FromIntersect14(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else{let value=schema.allOf.reduce((acc,schema2)=>{let next=Visit10(schema2,references);return typeof next==="object"?{...acc,...next}:next},{});if(!Check(schema,references,value))throw new ValueCreateError(schema,"Intersect produced invalid value. Consider using a default value.");return value}}function FromIterator7(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else return function*(){}()}function FromLiteral5(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else return schema.const}function FromNever4(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else throw new ValueCreateError(schema,"Never types cannot be created. Consider using a default value.")}function FromNot7(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else throw new ValueCreateError(schema,"Not types must have a default value")}function FromNull4(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else return null}function FromNumber4(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else if(schema.minimum!==void 0)return schema.minimum;else return 0}function FromObject14(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else{let required=new Set(schema.required),Acc={};for(let[key,subschema]of Object.entries(schema.properties)){if(!required.has(key))continue;Acc[key]=Visit10(subschema,references)}return Acc}}function FromPromise7(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else return Promise.resolve(Visit10(schema.item,references))}function FromRecord9(schema,references){let[keyPattern,valueSchema]=Object.entries(schema.patternProperties)[0];if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else if(!(keyPattern===PatternStringExact||keyPattern===PatternNumberExact)){let propertyKeys=keyPattern.slice(1,keyPattern.length-1).split("|"),Acc={};for(let key of propertyKeys)Acc[key]=Visit10(valueSchema,references);return Acc}else return{}}function FromRef10(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else return Visit10(Deref(schema,references),references)}function FromRegExp4(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else throw new ValueCreateError(schema,"RegExp types cannot be created. Consider using a default value.")}function FromString4(schema,references){if(schema.pattern!==void 0)if(!HasPropertyKey2(schema,"default"))throw new ValueCreateError(schema,"String types with patterns must specify a default value");else return FromDefault(schema.default);else if(schema.format!==void 0)if(!HasPropertyKey2(schema,"default"))throw new ValueCreateError(schema,"String types with formats must specify a default value");else return FromDefault(schema.default);else if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else if(schema.minLength!==void 0)return Array.from({length:schema.minLength}).map(()=>" ").join("");else return""}function FromSymbol4(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else if("value"in schema)return Symbol.for(schema.value);else return Symbol()}function FromTemplateLiteral6(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);if(!IsTemplateLiteralFinite(schema))throw new ValueCreateError(schema,"Can only create template literals that produce a finite variants. Consider using a default value.");return TemplateLiteralGenerate(schema)[0]}function FromThis6(schema,references){if(recursiveDepth++>recursiveMaxDepth)throw new ValueCreateError(schema,"Cannot create recursive type as it appears possibly infinite. Consider using a default.");if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else return Visit10(Deref(schema,references),references)}function FromTuple11(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);if(schema.items===void 0)return[];else return Array.from({length:schema.minItems}).map((_2,index)=>Visit10(schema.items[index],references))}function FromUndefined4(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else return}function FromUnion16(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else if(schema.anyOf.length===0)throw new Error("ValueCreate.Union: Cannot create Union with zero variants");else return Visit10(schema.anyOf[0],references)}function FromUint8Array4(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else if(schema.minByteLength!==void 0)return new Uint8Array(schema.minByteLength);else return new Uint8Array(0)}function FromUnknown4(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else return{}}function FromVoid4(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else return}function FromKind3(schema,references){if(HasPropertyKey2(schema,"default"))return FromDefault(schema.default);else throw new Error("User defined types must specify a default value")}function Visit10(schema,references){let references_=Pushref(schema,references),schema_=schema;switch(schema_[Kind]){case"Any":return FromAny4(schema_,references_);case"Argument":return FromArgument4(schema_,references_);case"Array":return FromArray13(schema_,references_);case"AsyncIterator":return FromAsyncIterator7(schema_,references_);case"BigInt":return FromBigInt4(schema_,references_);case"Boolean":return FromBoolean4(schema_,references_);case"Constructor":return FromConstructor7(schema_,references_);case"Date":return FromDate5(schema_,references_);case"Function":return FromFunction7(schema_,references_);case"Import":return FromImport6(schema_,references_);case"Integer":return FromInteger4(schema_,references_);case"Intersect":return FromIntersect14(schema_,references_);case"Iterator":return FromIterator7(schema_,references_);case"Literal":return FromLiteral5(schema_,references_);case"Never":return FromNever4(schema_,references_);case"Not":return FromNot7(schema_,references_);case"Null":return FromNull4(schema_,references_);case"Number":return FromNumber4(schema_,references_);case"Object":return FromObject14(schema_,references_);case"Promise":return FromPromise7(schema_,references_);case"Record":return FromRecord9(schema_,references_);case"Ref":return FromRef10(schema_,references_);case"RegExp":return FromRegExp4(schema_,references_);case"String":return FromString4(schema_,references_);case"Symbol":return FromSymbol4(schema_,references_);case"TemplateLiteral":return FromTemplateLiteral6(schema_,references_);case"This":return FromThis6(schema_,references_);case"Tuple":return FromTuple11(schema_,references_);case"Undefined":return FromUndefined4(schema_,references_);case"Union":return FromUnion16(schema_,references_);case"Uint8Array":return FromUint8Array4(schema_,references_);case"Unknown":return FromUnknown4(schema_,references_);case"Void":return FromVoid4(schema_,references_);default:if(!exports_type2.Has(schema_[Kind]))throw new ValueCreateError(schema_,"Unknown type");return FromKind3(schema_,references_)}}var recursiveMaxDepth=512,recursiveDepth=0;function Create2(...args){return recursiveDepth=0,args.length===2?Visit10(args[0],args[1]):Visit10(args[0],[])}class ValueCastError extends TypeBoxError{constructor(schema,message){super(message);this.schema=schema}}function ScoreUnion(schema,references,value){if(schema[Kind]==="Object"&&typeof value==="object"&&!IsNull2(value)){let object=schema,keys=Object.getOwnPropertyNames(value),entries=Object.entries(object.properties),[point,max]=[1/entries.length,entries.length];return entries.reduce((acc,[key,schema2])=>{let literal=schema2[Kind]==="Literal"&&schema2.const===value[key]?max:0,checks=Check(schema2,references,value[key])?point:0,exists=keys.includes(key)?point:0;return acc+(literal+checks+exists)},0)}else return Check(schema,references,value)?1:0}function SelectUnion(union,references,value){let schemas=union.anyOf.map((schema)=>Deref(schema,references)),[select,best]=[schemas[0],0];for(let schema of schemas){let score=ScoreUnion(schema,references,value);if(score>best)select=schema,best=score}return select}function CastUnion(union,references,value){if("default"in union)return typeof value==="function"?union.default:Clone2(union.default);else{let schema=SelectUnion(union,references,value);return Cast(schema,references,value)}}function DefaultClone(schema,references,value){return Check(schema,references,value)?Clone2(value):Create2(schema,references)}function Default3(schema,references,value){return Check(schema,references,value)?value:Create2(schema,references)}function FromArray14(schema,references,value){if(Check(schema,references,value))return Clone2(value);let created=IsArray2(value)?Clone2(value):Create2(schema,references),minimum=IsNumber2(schema.minItems)&&created.length<schema.minItems?[...created,...Array.from({length:schema.minItems-created.length},()=>null)]:created,casted=(IsNumber2(schema.maxItems)&&minimum.length>schema.maxItems?minimum.slice(0,schema.maxItems):minimum).map((value2)=>Visit11(schema.items,references,value2));if(schema.uniqueItems!==!0)return casted;let unique=[...new Set(casted)];if(!Check(schema,references,unique))throw new ValueCastError(schema,"Array cast produced invalid data due to uniqueItems constraint");return unique}function FromConstructor8(schema,references,value){if(Check(schema,references,value))return Create2(schema,references);let required=new Set(schema.returns.required||[]),result=function(){};for(let[key,property]of Object.entries(schema.returns.properties)){if(!required.has(key)&&value.prototype[key]===void 0)continue;result.prototype[key]=Visit11(property,references,value.prototype[key])}return result}function FromImport7(schema,references,value){let definitions=globalThis.Object.values(schema.$defs),target=schema.$defs[schema.$ref];return Visit11(target,[...references,...definitions],value)}function FromIntersect15(schema,references,value){let created=Create2(schema,references),mapped=IsObject2(created)&&IsObject2(value)?{...created,...value}:value;return Check(schema,references,mapped)?mapped:Create2(schema,references)}function FromNever5(schema,references,value){throw new ValueCastError(schema,"Never types cannot be cast")}function FromObject15(schema,references,value){if(Check(schema,references,value))return value;if(value===null||typeof value!=="object")return Create2(schema,references);let required=new Set(schema.required||[]),result={};for(let[key,property]of Object.entries(schema.properties)){if(!required.has(key)&&value[key]===void 0)continue;result[key]=Visit11(property,references,value[key])}if(typeof schema.additionalProperties==="object"){let propertyNames=Object.getOwnPropertyNames(schema.properties);for(let propertyName of Object.getOwnPropertyNames(value)){if(propertyNames.includes(propertyName))continue;result[propertyName]=Visit11(schema.additionalProperties,references,value[propertyName])}}return result}function FromRecord10(schema,references,value){if(Check(schema,references,value))return Clone2(value);if(value===null||typeof value!=="object"||Array.isArray(value)||value instanceof Date)return Create2(schema,references);let subschemaPropertyName=Object.getOwnPropertyNames(schema.patternProperties)[0],subschema=schema.patternProperties[subschemaPropertyName],result={};for(let[propKey,propValue]of Object.entries(value))result[propKey]=Visit11(subschema,references,propValue);return result}function FromRef11(schema,references,value){return Visit11(Deref(schema,references),references,value)}function FromThis7(schema,references,value){return Visit11(Deref(schema,references),references,value)}function FromTuple12(schema,references,value){if(Check(schema,references,value))return Clone2(value);if(!IsArray2(value))return Create2(schema,references);if(schema.items===void 0)return[];return schema.items.map((schema2,index)=>Visit11(schema2,references,value[index]))}function FromUnion17(schema,references,value){return Check(schema,references,value)?Clone2(value):CastUnion(schema,references,value)}function Visit11(schema,references,value){let references_=IsString2(schema.$id)?Pushref(schema,references):references,schema_=schema;switch(schema[Kind]){case"Array":return FromArray14(schema_,references_,value);case"Constructor":return FromConstructor8(schema_,references_,value);case"Import":return FromImport7(schema_,references_,value);case"Intersect":return FromIntersect15(schema_,references_,value);case"Never":return FromNever5(schema_,references_,value);case"Object":return FromObject15(schema_,references_,value);case"Record":return FromRecord10(schema_,references_,value);case"Ref":return FromRef11(schema_,references_,value);case"This":return FromThis7(schema_,references_,value);case"Tuple":return FromTuple12(schema_,references_,value);case"Union":return FromUnion17(schema_,references_,value);case"Date":case"Symbol":case"Uint8Array":return DefaultClone(schema,references,value);default:return Default3(schema_,references_,value)}}function Cast(...args){return args.length===3?Visit11(args[0],args[1],args[2]):Visit11(args[0],[],args[1])}function IsCheckable(schema){return IsKind(schema)&&schema[Kind]!=="Unsafe"}function FromArray15(schema,references,value){if(!IsArray2(value))return value;return value.map((value2)=>Visit12(schema.items,references,value2))}function FromImport8(schema,references,value){let definitions=globalThis.Object.values(schema.$defs),target=schema.$defs[schema.$ref];return Visit12(target,[...references,...definitions],value)}function FromIntersect16(schema,references,value){let unevaluatedProperties=schema.unevaluatedProperties,composite=schema.allOf.map((schema2)=>Visit12(schema2,references,Clone2(value))).reduce((acc,value2)=>IsObject2(value2)?{...acc,...value2}:value2,{});if(!IsObject2(value)||!IsObject2(composite)||!IsKind(unevaluatedProperties))return composite;let knownkeys=KeyOfPropertyKeys(schema);for(let key of Object.getOwnPropertyNames(value)){if(knownkeys.includes(key))continue;if(Check(unevaluatedProperties,references,value[key]))composite[key]=Visit12(unevaluatedProperties,references,value[key])}return composite}function FromObject16(schema,references,value){if(!IsObject2(value)||IsArray2(value))return value;let additionalProperties=schema.additionalProperties;for(let key of Object.getOwnPropertyNames(value)){if(HasPropertyKey2(schema.properties,key)){value[key]=Visit12(schema.properties[key],references,value[key]);continue}if(IsKind(additionalProperties)&&Check(additionalProperties,references,value[key])){value[key]=Visit12(additionalProperties,references,value[key]);continue}delete value[key]}return value}function FromRecord11(schema,references,value){if(!IsObject2(value))return value;let additionalProperties=schema.additionalProperties,propertyKeys=Object.getOwnPropertyNames(value),[propertyKey,propertySchema]=Object.entries(schema.patternProperties)[0],propertyKeyTest=new RegExp(propertyKey);for(let key of propertyKeys){if(propertyKeyTest.test(key)){value[key]=Visit12(propertySchema,references,value[key]);continue}if(IsKind(additionalProperties)&&Check(additionalProperties,references,value[key])){value[key]=Visit12(additionalProperties,references,value[key]);continue}delete value[key]}return value}function FromRef12(schema,references,value){return Visit12(Deref(schema,references),references,value)}function FromThis8(schema,references,value){return Visit12(Deref(schema,references),references,value)}function FromTuple13(schema,references,value){if(!IsArray2(value))return value;if(IsUndefined2(schema.items))return[];let length=Math.min(value.length,schema.items.length);for(let i=0;i<length;i++)value[i]=Visit12(schema.items[i],references,value[i]);return value.length>length?value.slice(0,length):value}function FromUnion18(schema,references,value){for(let inner of schema.anyOf)if(IsCheckable(inner)&&Check(inner,references,value))return Visit12(inner,references,value);return value}function Visit12(schema,references,value){let references_=IsString2(schema.$id)?Pushref(schema,references):references,schema_=schema;switch(schema_[Kind]){case"Array":return FromArray15(schema_,references_,value);case"Import":return FromImport8(schema_,references_,value);case"Intersect":return FromIntersect16(schema_,references_,value);case"Object":return FromObject16(schema_,references_,value);case"Record":return FromRecord11(schema_,references_,value);case"Ref":return FromRef12(schema_,references_,value);case"This":return FromThis8(schema_,references_,value);case"Tuple":return FromTuple13(schema_,references_,value);case"Union":return FromUnion18(schema_,references_,value);default:return value}}function Clean(...args){return args.length===3?Visit12(args[0],args[1],args[2]):Visit12(args[0],[],args[1])}function IsStringNumeric(value){return IsString2(value)&&!isNaN(value)&&!isNaN(parseFloat(value))}function IsValueToString(value){return IsBigInt2(value)||IsBoolean2(value)||IsNumber2(value)}function IsValueTrue(value){return value===!0||IsNumber2(value)&&value===1||IsBigInt2(value)&&value===BigInt("1")||IsString2(value)&&(value.toLowerCase()==="true"||value==="1")}function IsValueFalse(value){return value===!1||IsNumber2(value)&&(value===0||Object.is(value,-0))||IsBigInt2(value)&&value===BigInt("0")||IsString2(value)&&(value.toLowerCase()==="false"||value==="0"||value==="-0")}function IsTimeStringWithTimeZone(value){return IsString2(value)&&/^(?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)$/i.test(value)}function IsTimeStringWithoutTimeZone(value){return IsString2(value)&&/^(?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)?$/i.test(value)}function IsDateTimeStringWithTimeZone(value){return IsString2(value)&&/^\d\d\d\d-[0-1]\d-[0-3]\dt(?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)$/i.test(value)}function IsDateTimeStringWithoutTimeZone(value){return IsString2(value)&&/^\d\d\d\d-[0-1]\d-[0-3]\dt(?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)?$/i.test(value)}function IsDateString(value){return IsString2(value)&&/^\d\d\d\d-[0-1]\d-[0-3]\d$/i.test(value)}function TryConvertLiteralString(value,target){let conversion=TryConvertString(value);return conversion===target?conversion:value}function TryConvertLiteralNumber(value,target){let conversion=TryConvertNumber(value);return conversion===target?conversion:value}function TryConvertLiteralBoolean(value,target){let conversion=TryConvertBoolean(value);return conversion===target?conversion:value}function TryConvertLiteral(schema,value){return IsString2(schema.const)?TryConvertLiteralString(value,schema.const):IsNumber2(schema.const)?TryConvertLiteralNumber(value,schema.const):IsBoolean2(schema.const)?TryConvertLiteralBoolean(value,schema.const):value}function TryConvertBoolean(value){return IsValueTrue(value)?!0:IsValueFalse(value)?!1:value}function TryConvertBigInt(value){let truncateInteger=(value2)=>value2.split(".")[0];return IsStringNumeric(value)?BigInt(truncateInteger(value)):IsNumber2(value)?BigInt(Math.trunc(value)):IsValueFalse(value)?BigInt(0):IsValueTrue(value)?BigInt(1):value}function TryConvertString(value){return IsSymbol2(value)&&value.description!==void 0?value.description.toString():IsValueToString(value)?value.toString():value}function TryConvertNumber(value){return IsStringNumeric(value)?parseFloat(value):IsValueTrue(value)?1:IsValueFalse(value)?0:value}function TryConvertInteger(value){return IsStringNumeric(value)?parseInt(value):IsNumber2(value)?Math.trunc(value):IsValueTrue(value)?1:IsValueFalse(value)?0:value}function TryConvertNull(value){return IsString2(value)&&value.toLowerCase()==="null"?null:value}function TryConvertUndefined(value){return IsString2(value)&&value==="undefined"?void 0:value}function TryConvertDate(value){return IsDate2(value)?value:IsNumber2(value)?new Date(value):IsValueTrue(value)?new Date(1):IsValueFalse(value)?new Date(0):IsStringNumeric(value)?new Date(parseInt(value)):IsTimeStringWithoutTimeZone(value)?new Date(`1970-01-01T${value}.000Z`):IsTimeStringWithTimeZone(value)?new Date(`1970-01-01T${value}`):IsDateTimeStringWithoutTimeZone(value)?new Date(`${value}.000Z`):IsDateTimeStringWithTimeZone(value)?new Date(value):IsDateString(value)?new Date(`${value}T00:00:00.000Z`):value}function Default4(value){return value}function FromArray16(schema,references,value){return(IsArray2(value)?value:[value]).map((element)=>Visit13(schema.items,references,element))}function FromBigInt5(schema,references,value){return TryConvertBigInt(value)}function FromBoolean5(schema,references,value){return TryConvertBoolean(value)}function FromDate6(schema,references,value){return TryConvertDate(value)}function FromImport9(schema,references,value){let definitions=globalThis.Object.values(schema.$defs),target=schema.$defs[schema.$ref];return Visit13(target,[...references,...definitions],value)}function FromInteger5(schema,references,value){return TryConvertInteger(value)}function FromIntersect17(schema,references,value){return schema.allOf.reduce((value2,schema2)=>Visit13(schema2,references,value2),value)}function FromLiteral6(schema,references,value){return TryConvertLiteral(schema,value)}function FromNull5(schema,references,value){return TryConvertNull(value)}function FromNumber5(schema,references,value){return TryConvertNumber(value)}function FromObject17(schema,references,value){if(!IsObject2(value))return value;for(let propertyKey of Object.getOwnPropertyNames(schema.properties)){if(!HasPropertyKey2(value,propertyKey))continue;value[propertyKey]=Visit13(schema.properties[propertyKey],references,value[propertyKey])}return value}function FromRecord12(schema,references,value){if(!IsObject2(value))return value;let propertyKey=Object.getOwnPropertyNames(schema.patternProperties)[0],property=schema.patternProperties[propertyKey];for(let[propKey,propValue]of Object.entries(value))value[propKey]=Visit13(property,references,propValue);return value}function FromRef13(schema,references,value){return Visit13(Deref(schema,references),references,value)}function FromString5(schema,references,value){return TryConvertString(value)}function FromSymbol5(schema,references,value){return IsString2(value)||IsNumber2(value)?Symbol(value):value}function FromThis9(schema,references,value){return Visit13(Deref(schema,references),references,value)}function FromTuple14(schema,references,value){if(!(IsArray2(value)&&!IsUndefined2(schema.items)))return value;return value.map((value2,index)=>{return index<schema.items.length?Visit13(schema.items[index],references,value2):value2})}function FromUndefined5(schema,references,value){return TryConvertUndefined(value)}function FromUnion19(schema,references,value){for(let subschema of schema.anyOf){let converted=Visit13(subschema,references,Clone2(value));if(!Check(subschema,references,converted))continue;return converted}return value}function Visit13(schema,references,value){let references_=Pushref(schema,references),schema_=schema;switch(schema[Kind]){case"Array":return FromArray16(schema_,references_,value);case"BigInt":return FromBigInt5(schema_,references_,value);case"Boolean":return FromBoolean5(schema_,references_,value);case"Date":return FromDate6(schema_,references_,value);case"Import":return FromImport9(schema_,references_,value);case"Integer":return FromInteger5(schema_,references_,value);case"Intersect":return FromIntersect17(schema_,references_,value);case"Literal":return FromLiteral6(schema_,references_,value);case"Null":return FromNull5(schema_,references_,value);case"Number":return FromNumber5(schema_,references_,value);case"Object":return FromObject17(schema_,references_,value);case"Record":return FromRecord12(schema_,references_,value);case"Ref":return FromRef13(schema_,references_,value);case"String":return FromString5(schema_,references_,value);case"Symbol":return FromSymbol5(schema_,references_,value);case"This":return FromThis9(schema_,references_,value);case"Tuple":return FromTuple14(schema_,references_,value);case"Undefined":return FromUndefined5(schema_,references_,value);case"Union":return FromUnion19(schema_,references_,value);default:return Default4(value)}}function Convert(...args){return args.length===3?Visit13(args[0],args[1],args[2]):Visit13(args[0],[],args[1])}function Decode(...args){let[schema,references,value]=args.length===3?[args[0],args[1],args[2]]:[args[0],[],args[1]];if(!Check(schema,references,value))throw new TransformDecodeCheckError(schema,value,Errors(schema,references,value).First());return HasTransform(schema,references)?TransformDecode(schema,references,value):value}function ValueOrDefault(schema,value){let defaultValue=HasPropertyKey2(schema,"default")?schema.default:void 0,clone=IsFunction2(defaultValue)?defaultValue():Clone2(defaultValue);return IsUndefined2(value)?clone:IsObject2(value)&&IsObject2(clone)?Object.assign(clone,value):value}function HasDefaultProperty(schema){return IsKind(schema)&&"default"in schema}function FromArray17(schema,references,value){if(IsArray2(value)){for(let i=0;i<value.length;i++)value[i]=Visit14(schema.items,references,value[i]);return value}let defaulted=ValueOrDefault(schema,value);if(!IsArray2(defaulted))return defaulted;for(let i=0;i<defaulted.length;i++)defaulted[i]=Visit14(schema.items,references,defaulted[i]);return defaulted}function FromDate7(schema,references,value){return IsDate2(value)?value:ValueOrDefault(schema,value)}function FromImport10(schema,references,value){let definitions=globalThis.Object.values(schema.$defs),target=schema.$defs[schema.$ref];return Visit14(target,[...references,...definitions],value)}function FromIntersect18(schema,references,value){let defaulted=ValueOrDefault(schema,value);return schema.allOf.reduce((acc,schema2)=>{let next=Visit14(schema2,references,defaulted);return IsObject2(next)?{...acc,...next}:next},{})}function FromObject18(schema,references,value){let defaulted=ValueOrDefault(schema,value);if(!IsObject2(defaulted))return defaulted;let knownPropertyKeys=Object.getOwnPropertyNames(schema.properties);for(let key of knownPropertyKeys){let propertyValue=Visit14(schema.properties[key],references,defaulted[key]);if(IsUndefined2(propertyValue))continue;defaulted[key]=Visit14(schema.properties[key],references,defaulted[key])}if(!HasDefaultProperty(schema.additionalProperties))return defaulted;for(let key of Object.getOwnPropertyNames(defaulted)){if(knownPropertyKeys.includes(key))continue;defaulted[key]=Visit14(schema.additionalProperties,references,defaulted[key])}return defaulted}function FromRecord13(schema,references,value){let defaulted=ValueOrDefault(schema,value);if(!IsObject2(defaulted))return defaulted;let additionalPropertiesSchema=schema.additionalProperties,[propertyKeyPattern,propertySchema]=Object.entries(schema.patternProperties)[0],knownPropertyKey=new RegExp(propertyKeyPattern);for(let key of Object.getOwnPropertyNames(defaulted)){if(!(knownPropertyKey.test(key)&&HasDefaultProperty(propertySchema)))continue;defaulted[key]=Visit14(propertySchema,references,defaulted[key])}if(!HasDefaultProperty(additionalPropertiesSchema))return defaulted;for(let key of Object.getOwnPropertyNames(defaulted)){if(knownPropertyKey.test(key))continue;defaulted[key]=Visit14(additionalPropertiesSchema,references,defaulted[key])}return defaulted}function FromRef14(schema,references,value){return Visit14(Deref(schema,references),references,ValueOrDefault(schema,value))}function FromThis10(schema,references,value){return Visit14(Deref(schema,references),references,value)}function FromTuple15(schema,references,value){let defaulted=ValueOrDefault(schema,value);if(!IsArray2(defaulted)||IsUndefined2(schema.items))return defaulted;let[items,max]=[schema.items,Math.max(schema.items.length,defaulted.length)];for(let i=0;i<max;i++)if(i<items.length)defaulted[i]=Visit14(items[i],references,defaulted[i]);return defaulted}function FromUnion20(schema,references,value){let defaulted=ValueOrDefault(schema,value);for(let inner of schema.anyOf){let result=Visit14(inner,references,Clone2(defaulted));if(Check(inner,references,result))return result}return defaulted}function Visit14(schema,references,value){let references_=Pushref(schema,references),schema_=schema;switch(schema_[Kind]){case"Array":return FromArray17(schema_,references_,value);case"Date":return FromDate7(schema_,references_,value);case"Import":return FromImport10(schema_,references_,value);case"Intersect":return FromIntersect18(schema_,references_,value);case"Object":return FromObject18(schema_,references_,value);case"Record":return FromRecord13(schema_,references_,value);case"Ref":return FromRef14(schema_,references_,value);case"This":return FromThis10(schema_,references_,value);case"Tuple":return FromTuple15(schema_,references_,value);case"Union":return FromUnion20(schema_,references_,value);default:return ValueOrDefault(schema_,value)}}function Default5(...args){return args.length===3?Visit14(args[0],args[1],args[2]):Visit14(args[0],[],args[1])}var exports_pointer={};__export(exports_pointer,{ValuePointerRootSetError:()=>ValuePointerRootSetError,ValuePointerRootDeleteError:()=>ValuePointerRootDeleteError,Set:()=>Set4,Has:()=>Has3,Get:()=>Get3,Format:()=>Format,Delete:()=>Delete3});class ValuePointerRootSetError extends TypeBoxError{constructor(value,path,update){super("Cannot set root value");this.value=value,this.path=path,this.update=update}}class ValuePointerRootDeleteError extends TypeBoxError{constructor(value,path){super("Cannot delete root value");this.value=value,this.path=path}}function Escape2(component){return component.indexOf("~")===-1?component:component.replace(/~1/g,"/").replace(/~0/g,"~")}function*Format(pointer){if(pointer==="")return;let[start,end]=[0,0];for(let i=0;i<pointer.length;i++)if(pointer.charAt(i)==="/")if(i===0)start=i+1;else end=i,yield Escape2(pointer.slice(start,end)),start=i+1;else end=i;yield Escape2(pointer.slice(start))}function Set4(value,pointer,update){if(pointer==="")throw new ValuePointerRootSetError(value,pointer,update);let[owner,next,key]=[null,value,""];for(let component of Format(pointer)){if(next[component]===void 0)next[component]={};owner=next,next=next[component],key=component}owner[key]=update}function Delete3(value,pointer){if(pointer==="")throw new ValuePointerRootDeleteError(value,pointer);let[owner,next,key]=[null,value,""];for(let component of Format(pointer)){if(next[component]===void 0||next[component]===null)return;owner=next,next=next[component],key=component}if(Array.isArray(owner)){let index=parseInt(key);owner.splice(index,1)}else delete owner[key]}function Has3(value,pointer){if(pointer==="")return!0;let[owner,next,key]=[null,value,""];for(let component of Format(pointer)){if(next[component]===void 0)return!1;owner=next,next=next[component],key=component}return Object.getOwnPropertyNames(owner).includes(key)}function Get3(value,pointer){if(pointer==="")return value;let current=value;for(let component of Format(pointer)){if(current[component]===void 0)return;current=current[component]}return current}function ObjectType3(left,right){if(!IsObject2(right))return!1;let leftKeys=[...Object.keys(left),...Object.getOwnPropertySymbols(left)],rightKeys=[...Object.keys(right),...Object.getOwnPropertySymbols(right)];if(leftKeys.length!==rightKeys.length)return!1;return leftKeys.every((key)=>Equal(left[key],right[key]))}function DateType3(left,right){return IsDate2(right)&&left.getTime()===right.getTime()}function ArrayType3(left,right){if(!IsArray2(right)||left.length!==right.length)return!1;return left.every((value,index)=>Equal(value,right[index]))}function TypedArrayType(left,right){if(!IsTypedArray(right)||left.length!==right.length||Object.getPrototypeOf(left).constructor.name!==Object.getPrototypeOf(right).constructor.name)return!1;return left.every((value,index)=>Equal(value,right[index]))}function ValueType(left,right){return left===right}function Equal(left,right){if(IsDate2(left))return DateType3(left,right);if(IsTypedArray(left))return TypedArrayType(left,right);if(IsArray2(left))return ArrayType3(left,right);if(IsObject2(left))return ObjectType3(left,right);if(IsValueType(left))return ValueType(left,right);throw new Error("ValueEquals: Unable to compare value")}var Insert=Object2({type:Literal("insert"),path:String2(),value:Unknown()}),Update=Object2({type:Literal("update"),path:String2(),value:Unknown()}),Delete4=Object2({type:Literal("delete"),path:String2()}),Edit=Union([Insert,Update,Delete4]);class ValueDiffError extends TypeBoxError{constructor(value,message){super(message);this.value=value}}function CreateUpdate(path,value){return{type:"update",path,value}}function CreateInsert(path,value){return{type:"insert",path,value}}function CreateDelete(path){return{type:"delete",path}}function AssertDiffable(value){if(globalThis.Object.getOwnPropertySymbols(value).length>0)throw new ValueDiffError(value,"Cannot diff objects with symbols")}function*ObjectType4(path,current,next){if(AssertDiffable(current),AssertDiffable(next),!IsStandardObject(next))return yield CreateUpdate(path,next);let currentKeys=globalThis.Object.getOwnPropertyNames(current),nextKeys=globalThis.Object.getOwnPropertyNames(next);for(let key of nextKeys){if(HasPropertyKey2(current,key))continue;yield CreateInsert(`${path}/${key}`,next[key])}for(let key of currentKeys){if(!HasPropertyKey2(next,key))continue;if(Equal(current,next))continue;yield*Visit15(`${path}/${key}`,current[key],next[key])}for(let key of currentKeys){if(HasPropertyKey2(next,key))continue;yield CreateDelete(`${path}/${key}`)}}function*ArrayType4(path,current,next){if(!IsArray2(next))return yield CreateUpdate(path,next);for(let i=0;i<Math.min(current.length,next.length);i++)yield*Visit15(`${path}/${i}`,current[i],next[i]);for(let i=0;i<next.length;i++){if(i<current.length)continue;yield CreateInsert(`${path}/${i}`,next[i])}for(let i=current.length-1;i>=0;i--){if(i<next.length)continue;yield CreateDelete(`${path}/${i}`)}}function*TypedArrayType2(path,current,next){if(!IsTypedArray(next)||current.length!==next.length||globalThis.Object.getPrototypeOf(current).constructor.name!==globalThis.Object.getPrototypeOf(next).constructor.name)return yield CreateUpdate(path,next);for(let i=0;i<Math.min(current.length,next.length);i++)yield*Visit15(`${path}/${i}`,current[i],next[i])}function*ValueType2(path,current,next){if(current===next)return;yield CreateUpdate(path,next)}function*Visit15(path,current,next){if(IsStandardObject(current))return yield*ObjectType4(path,current,next);if(IsArray2(current))return yield*ArrayType4(path,current,next);if(IsTypedArray(current))return yield*TypedArrayType2(path,current,next);if(IsValueType(current))return yield*ValueType2(path,current,next);throw new ValueDiffError(current,"Unable to diff value")}function Diff(current,next){return[...Visit15("",current,next)]}function IsRootUpdate(edits){return edits.length>0&&edits[0].path===""&&edits[0].type==="update"}function IsIdentity(edits){return edits.length===0}function Patch(current,edits){if(IsRootUpdate(edits))return Clone2(edits[0].value);if(IsIdentity(edits))return Clone2(current);let clone=Clone2(current);for(let edit of edits)switch(edit.type){case"insert":{exports_pointer.Set(clone,edit.path,edit.value);break}case"update":{exports_pointer.Set(clone,edit.path,edit.value);break}case"delete":{exports_pointer.Delete(clone,edit.path);break}}return clone}function Encode(...args){let[schema,references,value]=args.length===3?[args[0],args[1],args[2]]:[args[0],[],args[1]],encoded=HasTransform(schema,references)?TransformEncode(schema,references,value):value;if(!Check(schema,references,encoded))throw new TransformEncodeCheckError(schema,encoded,Errors(schema,references,encoded).First());return encoded}function IsStandardObject2(value){return IsObject2(value)&&!IsArray2(value)}class ValueMutateError extends TypeBoxError{constructor(message){super(message)}}function ObjectType5(root,path,current,next){if(!IsStandardObject2(current))exports_pointer.Set(root,path,Clone2(next));else{let currentKeys=Object.getOwnPropertyNames(current),nextKeys=Object.getOwnPropertyNames(next);for(let currentKey of currentKeys)if(!nextKeys.includes(currentKey))delete current[currentKey];for(let nextKey of nextKeys)if(!currentKeys.includes(nextKey))current[nextKey]=null;for(let nextKey of nextKeys)Visit16(root,`${path}/${nextKey}`,current[nextKey],next[nextKey])}}function ArrayType5(root,path,current,next){if(!IsArray2(current))exports_pointer.Set(root,path,Clone2(next));else{for(let index=0;index<next.length;index++)Visit16(root,`${path}/${index}`,current[index],next[index]);current.splice(next.length)}}function TypedArrayType3(root,path,current,next){if(IsTypedArray(current)&&current.length===next.length)for(let i=0;i<current.length;i++)current[i]=next[i];else exports_pointer.Set(root,path,Clone2(next))}function ValueType3(root,path,current,next){if(current===next)return;exports_pointer.Set(root,path,next)}function Visit16(root,path,current,next){if(IsArray2(next))return ArrayType5(root,path,current,next);if(IsTypedArray(next))return TypedArrayType3(root,path,current,next);if(IsStandardObject2(next))return ObjectType5(root,path,current,next);if(IsValueType(next))return ValueType3(root,path,current,next)}function IsNonMutableValue(value){return IsTypedArray(value)||IsValueType(value)}function IsMismatchedValue(current,next){return IsStandardObject2(current)&&IsArray2(next)||IsArray2(current)&&IsStandardObject2(next)}function Mutate(current,next){if(IsNonMutableValue(current)||IsNonMutableValue(next))throw new ValueMutateError("Only object and array types can be mutated at the root level");if(IsMismatchedValue(current,next))throw new ValueMutateError("Cannot assign due type mismatch of assignable values");Visit16(current,"",current,next)}class ParseError extends TypeBoxError{constructor(message){super(message)}}var ParseRegistry;(function(ParseRegistry2){let registry=new Map([["Assert",(type,references,value)=>{return Assert(type,references,value),value}],["Cast",(type,references,value)=>Cast(type,references,value)],["Clean",(type,references,value)=>Clean(type,references,value)],["Clone",(_type,_references,value)=>Clone2(value)],["Convert",(type,references,value)=>Convert(type,references,value)],["Decode",(type,references,value)=>HasTransform(type,references)?TransformDecode(type,references,value):value],["Default",(type,references,value)=>Default5(type,references,value)],["Encode",(type,references,value)=>HasTransform(type,references)?TransformEncode(type,references,value):value]]);function Delete5(key){registry.delete(key)}ParseRegistry2.Delete=Delete5;function Set5(key,callback){registry.set(key,callback)}ParseRegistry2.Set=Set5;function Get4(key){return registry.get(key)}ParseRegistry2.Get=Get4})(ParseRegistry||(ParseRegistry={}));var ParseDefault=["Clone","Clean","Default","Convert","Assert","Decode"];function ParseValue(operations,type,references,value){return operations.reduce((value2,operationKey)=>{let operation=ParseRegistry.Get(operationKey);if(IsUndefined2(operation))throw new ParseError(`Unable to find Parse operation '${operationKey}'`);return operation(type,references,value2)},value)}function Parse(...args){let[operations,schema,references,value]=args.length===4?[args[0],args[1],args[2],args[3]]:args.length===3?IsArray2(args[0])?[args[0],args[1],[],args[2]]:[ParseDefault,args[0],args[1],args[2]]:args.length===2?[ParseDefault,args[0],[],args[1]]:(()=>{throw new ParseError("Invalid Arguments")})();return ParseValue(operations,schema,references,value)}var exports_value2={};__export(exports_value2,{ValueErrorIterator:()=>ValueErrorIterator,Patch:()=>Patch,Parse:()=>Parse,Mutate:()=>Mutate,Hash:()=>Hash,Errors:()=>Errors,Equal:()=>Equal,Encode:()=>Encode,Edit:()=>Edit,Diff:()=>Diff,Default:()=>Default5,Decode:()=>Decode,Create:()=>Create2,Convert:()=>Convert,Clone:()=>Clone2,Clean:()=>Clean,Check:()=>Check,Cast:()=>Cast,Assert:()=>Assert});var import_cookie=__toESM(require_dist(),1);var fullFormats={date,time:getTime(!0),"date-time":getDateTime(!0),"iso-time":getTime(!1),"iso-date-time":getDateTime(!1),duration:/^P(?!$)((\d+Y)?(\d+M)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+S)?)?|(\d+W)?)$/,uri,"uri-reference":/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,"uri-template":/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,url:/^(?:https?|ftp):\/\/(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z0-9\u{00a1}-\u{ffff}]+-)*[a-z0-9\u{00a1}-\u{ffff}]+)(?:\.(?:[a-z0-9\u{00a1}-\u{ffff}]+-)*[a-z0-9\u{00a1}-\u{ffff}]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,email:/^[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?$/i,hostname:/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,ipv4:/^(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)\.){3}(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)$/,ipv6:/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,regex,uuid:/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,"json-pointer":/^(?:\/(?:[^~/]|~0|~1)*)*$/,"json-pointer-uri-fragment":/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,"relative-json-pointer":/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,byte,int32:{type:"number",validate:validateInt32},int64:{type:"number",validate:validateInt64},float:{type:"number",validate:validateNumber},double:{type:"number",validate:validateNumber},password:!0,binary:!0};function isLeapYear(year){return year%4===0&&(year%100!==0||year%400===0)}var DATE=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,DAYS=[0,31,28,31,30,31,30,31,31,30,31,30,31];function date(str){let matches=DATE.exec(str);if(!matches)return!1;let year=+matches[1],month=+matches[2],day=+matches[3];return month>=1&&month<=12&&day>=1&&day<=(month===2&&isLeapYear(year)?29:DAYS[month])}var TIME=/^(\d\d):(\d\d):(\d\d(?:\.\d+)?)(z|([+-])(\d\d)(?::?(\d\d))?)?$/i;function getTime(strictTimeZone){return function time(str){let matches=TIME.exec(str);if(!matches)return!1;let hr=+matches[1],min=+matches[2],sec=+matches[3],tz=matches[4],tzSign=matches[5]==="-"?-1:1,tzH=+(matches[6]||0),tzM=+(matches[7]||0);if(tzH>23||tzM>59||strictTimeZone&&!tz)return!1;if(hr<=23&&min<=59&&sec<60)return!0;let utcMin=min-tzM*tzSign,utcHr=hr-tzH*tzSign-(utcMin<0?1:0);return(utcHr===23||utcHr===-1)&&(utcMin===59||utcMin===-1)&&sec<61}}var DATE_TIME_SEPARATOR=/t|\s/i;function getDateTime(strictTimeZone){let time=getTime(strictTimeZone);return function date_time(str){let dateTime=str.split(DATE_TIME_SEPARATOR);return dateTime.length===2&&date(dateTime[0])&&time(dateTime[1])}}var NOT_URI_FRAGMENT=/\/|:/,URI=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;function uri(str){return NOT_URI_FRAGMENT.test(str)&&URI.test(str)}var BYTE=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/gm;function byte(str){return BYTE.lastIndex=0,BYTE.test(str)}var MIN_INT32=-2147483648,MAX_INT32=2147483647;function validateInt32(value){return Number.isInteger(value)&&value<=MAX_INT32&&value>=MIN_INT32}function validateInt64(value){return Number.isInteger(value)}function validateNumber(){return!0}var Z_ANCHOR=/[^\\]\\Z/;function regex(str){if(Z_ANCHOR.test(str))return!1;try{return new RegExp(str),!0}catch(e){return!1}}var hasHeaderShorthand="toJSON"in new Headers,replaceUrlPath=(url,pathname)=>{let urlObject=new URL(url);return urlObject.pathname=pathname,urlObject.toString()},isClass=(v)=>typeof v==="function"&&/^\s*class\s+/.test(v.toString())||v.toString&&v.toString().startsWith("[object ")&&v.toString()!=="[object Object]"||isNotEmpty(Object.getPrototypeOf(v)),isObject=(item)=>item&&typeof item==="object"&&!Array.isArray(item),mergeDeep=(target,source,{skipKeys,override=!0}={})=>{if(!isObject(target)||!isObject(source))return target;for(let[key,value]of Object.entries(source)){if(skipKeys?.includes(key))continue;if(!isObject(value)||!(key in target)||isClass(value)){if(override||!(key in target))target[key]=value;continue}target[key]=mergeDeep(target[key],value,{skipKeys,override})}return target},mergeCookie=(a,b)=>{let v=mergeDeep(Object.assign({},a),b,{skipKeys:["properties"]});if("properties"in v)delete v.properties;return v},mergeObjectArray=(a=[],b=[])=>{if(!a)return;if(!b)return a;let array=[],checksums=[];if(!Array.isArray(a))a=[a];if(!Array.isArray(b))b=[b];for(let item of a)if(array.push(item),item.checksum)checksums.push(item.checksum);for(let item of b)if(!checksums.includes(item.checksum))array.push(item);return array},primitiveHooks=["start","request","parse","transform","resolve","beforeHandle","afterHandle","mapResponse","afterResponse","trace","error","stop","body","headers","params","query","response","type","detail"],primitiveHookMap=primitiveHooks.reduce((acc,x)=>(acc[x]=!0,acc),{}),mergeResponse=(a,b)=>{let isRecordNumber=(x)=>typeof x==="object"&&Object.keys(x).every(isNumericString);if(isRecordNumber(a)&&isRecordNumber(b))return Object.assign(a,b);else if(a&&!isRecordNumber(a)&&isRecordNumber(b))return Object.assign({200:a},b);return b??a},mergeSchemaValidator=(a,b)=>{return{body:b?.body??a?.body,headers:b?.headers??a?.headers,params:b?.params??a?.params,query:b?.query??a?.query,cookie:b?.cookie??a?.cookie,response:mergeResponse(a?.response,b?.response)}},mergeHook=(a,b)=>{let{resolve:resolveA,...restA}=a??{},{resolve:resolveB,...restB}=b??{};return{...restA,...restB,body:b?.body??a?.body,headers:b?.headers??a?.headers,params:b?.params??a?.params,query:b?.query??a?.query,cookie:b?.cookie??a?.cookie,response:mergeResponse(a?.response,b?.response),type:a?.type||b?.type,detail:mergeDeep(b?.detail??{},a?.detail??{}),parse:mergeObjectArray(a?.parse,b?.parse),transform:mergeObjectArray(a?.transform,b?.transform),beforeHandle:mergeObjectArray(mergeObjectArray(fnToContainer(resolveA,"resolve"),a?.beforeHandle),mergeObjectArray(fnToContainer(resolveB,"resolve"),b?.beforeHandle)),afterHandle:mergeObjectArray(a?.afterHandle,b?.afterHandle),mapResponse:mergeObjectArray(a?.mapResponse,b?.mapResponse),afterResponse:mergeObjectArray(a?.afterResponse,b?.afterResponse),trace:mergeObjectArray(a?.trace,b?.trace),error:mergeObjectArray(a?.error,b?.error)}},replaceSchemaType=(schema,options,root=!0)=>{if(!Array.isArray(options))return options.original=schema,_replaceSchemaType(schema,options,root);for(let option of options)option.original=schema,schema=_replaceSchemaType(schema,option,root);return schema},_replaceSchemaType=(schema,options,root=!0)=>{if(!schema)return schema;if(options.untilObjectFound&&!root&&schema.type==="object")return schema;let fromSymbol=options.from[Kind];if(schema.oneOf){for(let i=0;i<schema.oneOf.length;i++)schema.oneOf[i]=_replaceSchemaType(schema.oneOf[i],options,root);return schema}if(schema.anyOf){for(let i=0;i<schema.anyOf.length;i++)schema.anyOf[i]=_replaceSchemaType(schema.anyOf[i],options,root);return schema}if(schema.allOf){for(let i=0;i<schema.allOf.length;i++)schema.allOf[i]=_replaceSchemaType(schema.allOf[i],options,root);return schema}if(schema.not)return _replaceSchemaType(schema.not,options,root);let isRoot=root&&!!options.excludeRoot;if(schema[Kind]===fromSymbol){let{anyOf,oneOf,allOf,not,properties:properties2,items,...rest}=schema,to=options.to(rest);if(!to)return schema;let transform2,composeProperties=(v)=>{if(properties2&&v.type==="object"){let newProperties={};for(let[key,value2]of Object.entries(properties2))newProperties[key]=_replaceSchemaType(value2,options,!1);return{...rest,...v,properties:newProperties}}if(items&&v.type==="array")return{...rest,...v,items:_replaceSchemaType(items,options,!1)};let value={...rest,...v};if(delete value.required,properties2&&v.type==="string"&&v.format==="ObjectString"&&v.default==="{}")transform2=t.ObjectString(properties2,rest),value.default=JSON.stringify(exports_value2.Create(t.Object(properties2))),value.properties=properties2;if(items&&v.type==="string"&&v.format==="ArrayString"&&v.default==="[]")transform2=t.ArrayString(items,rest),value.default=JSON.stringify(exports_value2.Create(t.Array(items))),value.items=items;return value};if(isRoot){if(properties2){let newProperties={};for(let[key,value]of Object.entries(properties2))newProperties[key]=_replaceSchemaType(value,options,!1);return{...rest,properties:newProperties}}else if(items?.map)return{...rest,items:items.map((v)=>_replaceSchemaType(v,options,!1))};return rest}if(to.anyOf)for(let i=0;i<to.anyOf.length;i++)to.anyOf[i]=composeProperties(to.anyOf[i]);else if(to.oneOf)for(let i=0;i<to.oneOf.length;i++)to.oneOf[i]=composeProperties(to.oneOf[i]);else if(to.allOf)for(let i=0;i<to.allOf.length;i++)to.allOf[i]=composeProperties(to.allOf[i]);else if(to.not)to.not=composeProperties(to.not);if(transform2)to[TransformKind]=transform2[TransformKind];if(to.anyOf||to.oneOf||to.allOf||to.not)return to;if(properties2){let newProperties={};for(let[key,value]of Object.entries(properties2))newProperties[key]=_replaceSchemaType(value,options,!1);return{...rest,...to,properties:newProperties}}else if(items?.map)return{...rest,...to,items:items.map((v)=>_replaceSchemaType(v,options,!1))};return{...rest,...to}}let properties=schema?.properties;if(properties&&root&&options.rootOnly!==!0)for(let[key,value]of Object.entries(properties))switch(value[Kind]){case fromSymbol:let{anyOf,oneOf,allOf,not,type,...rest}=value,to=options.to(rest);if(!to)return schema;if(to.anyOf)for(let i=0;i<to.anyOf.length;i++)to.anyOf[i]={...rest,...to.anyOf[i]};else if(to.oneOf)for(let i=0;i<to.oneOf.length;i++)to.oneOf[i]={...rest,...to.oneOf[i]};else if(to.allOf)for(let i=0;i<to.allOf.length;i++)to.allOf[i]={...rest,...to.allOf[i]};else if(to.not)to.not={...rest,...to.not};properties[key]={...rest,..._replaceSchemaType(rest,options,!1)};break;case"Object":case"Union":properties[key]=_replaceSchemaType(value,options,!1);break;default:if(Array.isArray(value.items))for(let i=0;i<value.items.length;i++)value.items[i]=_replaceSchemaType(value.items[i],options,!1);else if(value.anyOf||value.oneOf||value.allOf||value.not)properties[key]=_replaceSchemaType(value,options,!1);else if(value.type==="array")value.items=_replaceSchemaType(value.items,options,!1);break}return schema},createCleaner=(schema)=>(value)=>{if(typeof value==="object")try{return exports_value2.Clean(schema,structuredClone(value))}catch{try{return exports_value2.Clean(schema,value)}catch{return value}}return value},getSchemaValidator=(s,{models={},dynamic=!1,modules,normalize=!1,additionalProperties=!1,coerce=!1,additionalCoerce=[]}={modules:t.Module({})})=>{if(!s)return;let schema;if(typeof s!=="string")schema=s;else{let isArray=s.endsWith("[]"),key=isArray?s.substring(0,s.length-2):s;if(schema=modules.Import(key)??models[key],isArray)schema=t.Array(schema)}if(!schema)return;if(coerce||additionalCoerce)if(coerce)schema=replaceSchemaType(schema,[{from:t.Ref(""),to:(options)=>modules.Import(options.$ref)},{from:t.Number(),to:(options)=>t.Numeric(options),untilObjectFound:!0},{from:t.Boolean(),to:(options)=>t.BooleanString(options),untilObjectFound:!0},...Array.isArray(additionalCoerce)?additionalCoerce:[additionalCoerce]]);else schema=replaceSchemaType(schema,[{from:t.Ref(""),to:(options)=>modules.Import(options.$ref)},...Array.isArray(additionalCoerce)?additionalCoerce:[additionalCoerce]]);if(schema.type==="object"&&"additionalProperties"in schema===!1)schema.additionalProperties=additionalProperties;if(dynamic){let validator={schema,references:"",checkFunc:()=>{},code:"",Check:(value)=>exports_value2.Check(schema,value),Errors:(value)=>exports_value2.Errors(schema,value),Code:()=>"",Clean:createCleaner(schema),Decode:(value)=>exports_value2.Decode(schema,value),Encode:(value)=>exports_value2.Encode(schema,value)};if(normalize&&schema.additionalProperties===!1)validator.Clean=createCleaner(schema);if(schema.config){if(validator.config=schema.config,validator?.schema?.config)delete validator.schema.config}return validator.parse=(v)=>{try{return validator.Decode(v)}catch(error){throw[...validator.Errors(v)].map(mapValueError)}},validator.safeParse=(v)=>{try{return{success:!0,data:validator.Decode(v),error:null}}catch(error){let errors=[...compiled.Errors(v)].map(mapValueError);return{success:!1,data:null,error:errors[0]?.summary,errors}}},validator}let compiled=TypeCompiler.Compile(schema,Object.values(models));if(compiled.Clean=createCleaner(schema),schema.config){if(compiled.config=schema.config,compiled?.schema?.config)delete compiled.schema.config}return compiled.parse=(v)=>{try{return compiled.Decode(v)}catch(error){throw[...compiled.Errors(v)].map(mapValueError)}},compiled.safeParse=(v)=>{try{return{success:!0,data:compiled.Decode(v),error:null}}catch(error){let errors=[...compiled.Errors(v)].map(mapValueError);return{success:!1,data:null,error:errors[0]?.summary,errors}}},compiled},getResponseSchemaValidator=(s,{models={},modules,dynamic=!1,normalize=!1,additionalProperties=!1})=>{if(!s)return;let maybeSchemaOrRecord;if(typeof s!=="string")maybeSchemaOrRecord=s;else{let isArray=s.endsWith("[]"),key=isArray?s.substring(0,s.length-2):s;if(maybeSchemaOrRecord=modules.Import(key)??models[key],isArray)maybeSchemaOrRecord=t.Array(maybeSchemaOrRecord)}if(!maybeSchemaOrRecord)return;let compile=(schema,references)=>{if(dynamic)return{schema,references:"",checkFunc:()=>{},code:"",Check:(value)=>exports_value2.Check(schema,value),Errors:(value)=>exports_value2.Errors(schema,value),Code:()=>"",Clean:createCleaner(schema),Decode:(value)=>exports_value2.Decode(schema,value),Encode:(value)=>exports_value2.Encode(schema,value)};let compiledValidator=TypeCompiler.Compile(schema,references);if(normalize&&schema.additionalProperties===!1)compiledValidator.Clean=createCleaner(schema);return compiledValidator},modelValues=Object.values(models);if(Kind in maybeSchemaOrRecord){if("additionalProperties"in maybeSchemaOrRecord===!1)maybeSchemaOrRecord.additionalProperties=additionalProperties;return{200:compile(maybeSchemaOrRecord,modelValues)}}let record={};return Object.keys(maybeSchemaOrRecord).forEach((status)=>{let maybeNameOrSchema=maybeSchemaOrRecord[+status];if(typeof maybeNameOrSchema==="string"){if(maybeNameOrSchema in models){let schema=models[maybeNameOrSchema];schema.type==="object"&&"additionalProperties"in schema,record[+status]=Kind in schema?compile(schema,modelValues):schema}return}if(maybeNameOrSchema.type==="object"&&"additionalProperties"in maybeNameOrSchema===!1)maybeNameOrSchema.additionalProperties=additionalProperties;record[+status]=Kind in maybeNameOrSchema?compile(maybeNameOrSchema,modelValues):maybeNameOrSchema}),record},isBun=typeof Bun!=="undefined",hasHash=isBun&&typeof Bun.hash==="function",checksum=(s)=>{if(hasHash)return Bun.hash(s);let h=9;for(let i=0;i<s.length;)h=Math.imul(h^s.charCodeAt(i++),387420489);return h=h^h>>>9},_stringToStructureCoercions,stringToStructureCoercions=()=>{if(!_stringToStructureCoercions)_stringToStructureCoercions=[{from:t.Object({}),to:()=>t.ObjectString({}),excludeRoot:!0},{from:t.Array(t.Any()),to:()=>t.ArrayString(t.Any())}];return _stringToStructureCoercions},_coercePrimitiveRoot,coercePrimitiveRoot=()=>{if(!_coercePrimitiveRoot)_coercePrimitiveRoot=[{from:t.Number(),to:(options)=>t.Numeric(options),rootOnly:!0},{from:t.Boolean(),to:(options)=>t.BooleanString(options),rootOnly:!0}];return _coercePrimitiveRoot},getCookieValidator=({validator,modules,defaultConfig={},config,dynamic,models})=>{let cookieValidator=getSchemaValidator(validator,{modules,dynamic,models,additionalProperties:!0,coerce:!0,additionalCoerce:stringToStructureCoercions()});if(isNotEmpty(defaultConfig))if(cookieValidator)cookieValidator.config=mergeCookie(cookieValidator.config,config);else cookieValidator=getSchemaValidator(t.Cookie({}),{modules,dynamic,models,additionalProperties:!0}),cookieValidator.config=defaultConfig;return cookieValidator},injectChecksum=(checksum2,x)=>{if(!x)return;if(!Array.isArray(x)){let fn=x;if(checksum2&&!fn.checksum)fn.checksum=checksum2;if(fn.scope==="scoped")fn.scope="local";return fn}let fns=[...x];for(let fn of fns){if(checksum2&&!fn.checksum)fn.checksum=checksum2;if(fn.scope==="scoped")fn.scope="local"}return fns},mergeLifeCycle=(a,b,checksum2)=>{return{start:mergeObjectArray(a.start,injectChecksum(checksum2,b?.start)),request:mergeObjectArray(a.request,injectChecksum(checksum2,b?.request)),parse:mergeObjectArray(a.parse,injectChecksum(checksum2,b?.parse)),transform:mergeObjectArray(a.transform,injectChecksum(checksum2,b?.transform)),beforeHandle:mergeObjectArray(mergeObjectArray(fnToContainer(a.resolve,"resolve"),a.beforeHandle),injectChecksum(checksum2,mergeObjectArray(fnToContainer(b?.resolve,"resolve"),b?.beforeHandle))),afterHandle:mergeObjectArray(a.afterHandle,injectChecksum(checksum2,b?.afterHandle)),mapResponse:mergeObjectArray(a.mapResponse,injectChecksum(checksum2,b?.mapResponse)),afterResponse:mergeObjectArray(a.afterResponse,injectChecksum(checksum2,b?.afterResponse)),trace:mergeObjectArray(a.trace,injectChecksum(checksum2,b?.trace)),error:mergeObjectArray(a.error,injectChecksum(checksum2,b?.error)),stop:mergeObjectArray(a.stop,injectChecksum(checksum2,b?.stop))}},asHookType=(fn,inject,{skipIfHasType=!1}={})=>{if(!fn)return fn;if(!Array.isArray(fn)){if(skipIfHasType)fn.scope??=inject;else fn.scope=inject;return fn}for(let x of fn)if(skipIfHasType)x.scope??=inject;else x.scope=inject;return fn},filterGlobal=(fn)=>{if(!fn)return fn;if(!Array.isArray(fn))switch(fn.scope){case"global":case"scoped":return{...fn};default:return{fn}}let array=[];for(let x of fn)switch(x.scope){case"global":case"scoped":array.push({...x});break}return array},filterGlobalHook=(hook)=>{return{...hook,type:hook?.type,detail:hook?.detail,parse:filterGlobal(hook?.parse),transform:filterGlobal(hook?.transform),beforeHandle:filterGlobal(hook?.beforeHandle),afterHandle:filterGlobal(hook?.afterHandle),mapResponse:filterGlobal(hook?.mapResponse),afterResponse:filterGlobal(hook?.afterResponse),error:filterGlobal(hook?.error),trace:filterGlobal(hook?.trace)}},StatusMap={Continue:100,"Switching Protocols":101,Processing:102,"Early Hints":103,OK:200,Created:201,Accepted:202,"Non-Authoritative Information":203,"No Content":204,"Reset Content":205,"Partial Content":206,"Multi-Status":207,"Already Reported":208,"Multiple Choices":300,"Moved Permanently":301,Found:302,"See Other":303,"Not Modified":304,"Temporary Redirect":307,"Permanent Redirect":308,"Bad Request":400,Unauthorized:401,"Payment Required":402,Forbidden:403,"Not Found":404,"Method Not Allowed":405,"Not Acceptable":406,"Proxy Authentication Required":407,"Request Timeout":408,Conflict:409,Gone:410,"Length Required":411,"Precondition Failed":412,"Payload Too Large":413,"URI Too Long":414,"Unsupported Media Type":415,"Range Not Satisfiable":416,"Expectation Failed":417,"I'm a teapot":418,"Misdirected Request":421,"Unprocessable Content":422,Locked:423,"Failed Dependency":424,"Too Early":425,"Upgrade Required":426,"Precondition Required":428,"Too Many Requests":429,"Request Header Fields Too Large":431,"Unavailable For Legal Reasons":451,"Internal Server Error":500,"Not Implemented":501,"Bad Gateway":502,"Service Unavailable":503,"Gateway Timeout":504,"HTTP Version Not Supported":505,"Variant Also Negotiates":506,"Insufficient Storage":507,"Loop Detected":508,"Not Extended":510,"Network Authentication Required":511},InvertedStatusMap=Object.fromEntries(Object.entries(StatusMap).map(([k2,v])=>[v,k2]));function removeTrailingEquals(digest){let trimmedDigest=digest;while(trimmedDigest.endsWith("="))trimmedDigest=trimmedDigest.slice(0,-1);return trimmedDigest}var encoder=new TextEncoder,signCookie=async(val,secret)=>{if(typeof val!=="string")throw new TypeError("Cookie value must be provided as a string.");if(secret===null)throw new TypeError("Secret key must be provided.");let secretKey=await crypto.subtle.importKey("raw",encoder.encode(secret),{name:"HMAC",hash:"SHA-256"},!1,["sign"]),hmacBuffer=await crypto.subtle.sign("HMAC",secretKey,encoder.encode(val));return val+"."+removeTrailingEquals(Buffer.from(hmacBuffer).toString("base64"))},unsignCookie=async(input,secret)=>{if(typeof input!=="string")throw new TypeError("Signed cookie string must be provided.");if(secret===null)throw new TypeError("Secret key must be provided.");let tentativeValue=input.slice(0,input.lastIndexOf("."));return await signCookie(tentativeValue,secret)===input?tentativeValue:!1},traceBackMacro=(extension,property,manage)=>{if(!extension||typeof extension!=="object"||!property)return;for(let[key,value]of Object.entries(property)){if(key in primitiveHookMap||!(key in extension))continue;let v=extension[key];if(typeof v==="function"){let hook=v(value);if(typeof hook==="object")for(let[k2,v2]of Object.entries(hook))manage(k2)({fn:v2})}delete property[key]}},createMacroManager=({globalHook,localHook})=>(stackName)=>(type,fn)=>{if(typeof type==="function")type={fn:type};if(stackName==="resolve")type={...type,subType:"resolve"};if("fn"in type||Array.isArray(type)){if(!localHook[stackName])localHook[stackName]=[];if(typeof localHook[stackName]==="function")localHook[stackName]=[localHook[stackName]];if(Array.isArray(type))localHook[stackName]=localHook[stackName].concat(type);else localHook[stackName].push(type);return}let{insert="after",stack="local"}=type;if(typeof fn==="function")fn={fn};if(stack==="global")if(!Array.isArray(fn))if(insert==="before")globalHook[stackName].unshift(fn);else globalHook[stackName].push(fn);else if(insert==="before")globalHook[stackName]=fn.concat(globalHook[stackName]);else globalHook[stackName]=globalHook[stackName].concat(fn);else{if(!localHook[stackName])localHook[stackName]=[];if(typeof localHook[stackName]==="function")localHook[stackName]=[localHook[stackName]];if(!Array.isArray(fn))if(insert==="before")localHook[stackName].unshift(fn);else localHook[stackName].push(fn);else if(insert==="before")localHook[stackName]=fn.concat(localHook[stackName]);else localHook[stackName]=localHook[stackName].concat(fn)}},parseNumericString=(message)=>{if(typeof message==="number")return message;if(message.length<16){if(message.trim().length===0)return null;let length=Number(message);if(Number.isNaN(length))return null;return length}if(message.length===16){if(message.trim().length===0)return null;let number=Number(message);if(Number.isNaN(number)||number.toString()!==message)return null;return number}return null},isNumericString=(message)=>parseNumericString(message)!==null;class PromiseGroup{onError;root=null;promises=[];constructor(onError=console.error){this.onError=onError}get size(){return this.promises.length}add(promise){return this.promises.push(promise),this.root||=this.drain(),promise}async drain(){while(this.promises.length>0){try{await this.promises[0]}catch(error){this.onError(error)}this.promises.shift()}this.root=null}then(onfulfilled,onrejected){return(this.root??Promise.resolve()).then(onfulfilled,onrejected)}}var fnToContainer=(fn,subType)=>{if(!fn)return fn;if(!Array.isArray(fn)){if(typeof fn==="function"||typeof fn==="string")return subType?{fn,subType}:{fn};else if("fn"in fn)return fn}let fns=[];for(let x of fn)if(typeof x==="function"||typeof x==="string")fns.push(subType?{fn:x,subType}:{fn:x});else if("fn"in x)fns.push(x);return fns},localHookToLifeCycleStore=(a)=>{return{...a,start:fnToContainer(a?.start),request:fnToContainer(a?.request),parse:fnToContainer(a?.parse),transform:fnToContainer(a?.transform),beforeHandle:fnToContainer(a?.beforeHandle),afterHandle:fnToContainer(a?.afterHandle),mapResponse:fnToContainer(a?.mapResponse),afterResponse:fnToContainer(a?.afterResponse),trace:fnToContainer(a?.trace),error:fnToContainer(a?.error),stop:fnToContainer(a?.stop)}},lifeCycleToFn=(a)=>{let hook={};if(a.start?.map)hook.start=a.start.map((x)=>x.fn);if(a.request?.map)hook.request=a.request.map((x)=>x.fn);if(a.parse?.map)hook.parse=a.parse.map((x)=>x.fn);if(a.transform?.map)hook.transform=a.transform.map((x)=>x.fn);if(a.beforeHandle?.map)hook.beforeHandle=a.beforeHandle.map((x)=>x.fn);if(a.afterHandle?.map)hook.afterHandle=a.afterHandle.map((x)=>x.fn);if(a.mapResponse?.map)hook.mapResponse=a.mapResponse.map((x)=>x.fn);if(a.afterResponse?.map)hook.afterResponse=a.afterResponse.map((x)=>x.fn);if(a.trace?.map)hook.trace=a.trace.map((x)=>x.fn);if(a.error?.map)hook.error=a.error.map((x)=>x.fn);if(a.stop?.map)hook.stop=a.stop.map((x)=>x.fn);return hook},cloneInference=(inference)=>({body:inference.body,cookie:inference.cookie,headers:inference.headers,query:inference.query,set:inference.set,server:inference.server,request:inference.request,route:inference.route}),redirect=(url,status=302)=>Response.redirect(url,status),ELYSIA_FORM_DATA=Symbol("ElysiaFormData"),ELYSIA_REQUEST_ID=Symbol("ElysiaRequestId");var randomId=()=>{let uuid=crypto.randomUUID();return uuid.slice(0,8)+uuid.slice(24,32)},deduplicateChecksum=(array)=>{let hashes=[];for(let i=0;i<array.length;i++){let item=array[i];if(item.checksum){if(hashes.includes(item.checksum))array.splice(i,1),i--;hashes.push(item.checksum)}}return array},promoteEvent=(events,as="scoped")=>{if(!events)return;if(as==="scoped"){for(let event of events)if("scope"in event&&event.scope==="local")event.scope="scoped";return}for(let event of events)if("scope"in event)event.scope="global"},getLoosePath=(path)=>{if(path.charCodeAt(path.length-1)===47)return path.slice(0,path.length-1);return path+"/"},isNotEmpty=(obj)=>{if(!obj)return!1;for(let x in obj)return!0;return!1},isEmptyHookProperty=(prop)=>{if(Array.isArray(prop))return prop.length===0;return!prop},compressHistoryHook=(hook)=>{let history={...hook};if(isEmptyHookProperty(hook.afterHandle))delete history.afterHandle;if(isEmptyHookProperty(hook.afterResponse))delete history.afterResponse;if(isEmptyHookProperty(hook.beforeHandle))delete history.beforeHandle;if(isEmptyHookProperty(hook.error))delete history.error;if(isEmptyHookProperty(hook.mapResponse))delete history.mapResponse;if(isEmptyHookProperty(hook.parse))delete history.parse;if(isEmptyHookProperty(hook.request))delete history.request;if(isEmptyHookProperty(hook.start))delete history.start;if(isEmptyHookProperty(hook.stop))delete history.stop;if(isEmptyHookProperty(hook.trace))delete history.trace;if(isEmptyHookProperty(hook.transform))delete history.transform;if(!history.type)delete history.type;if(history.detail&&!Object.keys(history.detail).length)delete history.detail;if(!history.body)delete history.body;if(!history.cookie)delete history.cookie;if(!history.headers)delete history.headers;if(!history.query)delete history.query;if(!history.params)delete history.params;if(!history.response)delete history.response;return history},encodePath=(path,{dynamic=!1}={})=>{let encoded=encodeURIComponent(path).replace(/%2F/g,"/");if(dynamic)encoded=encoded.replace(/%3A/g,":").replace(/%3F/g,"?");return encoded},env=typeof Bun!=="undefined"?Bun.env:typeof process!=="undefined"?process?.env:void 0,ERROR_CODE=Symbol("ElysiaErrorCode"),isProduction=(env?.NODE_ENV??env?.ENV)==="production";class ElysiaCustomStatusResponse{code;response;constructor(code,response){let res=response??(code in InvertedStatusMap?InvertedStatusMap[code]:code);this.code=StatusMap[code]??code,this.response=res}}var error=(code,response)=>new ElysiaCustomStatusResponse(code,response);class InternalServerError extends Error{code="INTERNAL_SERVER_ERROR";status=500;constructor(message){super(message??"INTERNAL_SERVER_ERROR")}}class NotFoundError extends Error{code="NOT_FOUND";status=404;constructor(message){super(message??"NOT_FOUND")}}class ParseError2 extends Error{code="PARSE";status=400;constructor(){super("Bad Request")}}class InvalidCookieSignature extends Error{key;code="INVALID_COOKIE_SIGNATURE";status=400;constructor(key,message){super(message??`"${key}" has invalid cookie signature`);this.key=key}}var mapValueError=(error2)=>{if(!error2)return{summary:void 0};let{message,path,value,type}=error2,property=path.slice(1).replaceAll("/","."),isRoot=path==="";switch(type){case 42:return{...error2,summary:isRoot?"Value should not be provided":`Property '${property}' should not be provided`};case 45:return{...error2,summary:isRoot?"Value is missing":`Property '${property}' is missing`};case 50:let quoteIndex=message.indexOf("'"),format=message.slice(quoteIndex+1,message.indexOf("'",quoteIndex+1));return{...error2,summary:isRoot?"Value should be an email":`Property '${property}' should be ${format}`};case 54:return{...error2,summary:`${message.slice(0,9)} property '${property}' to be ${message.slice(8)} but found: ${value}`};case 62:let union=error2.schema.anyOf.map((x)=>`'${x?.format??x.type}'`).join(", ");return{...error2,summary:isRoot?`Value should be one of ${union}`:`Property '${property}' should be one of: ${union}`};default:return{summary:message,...error2}}};class ValidationError extends Error{type;validator;value;code="VALIDATION";status=422;constructor(type,validator,value){if(value&&typeof value==="object"&&value instanceof ElysiaCustomStatusResponse)value=value.response;let error2=isProduction?void 0:("Errors"in validator)?validator.Errors(value).First():exports_value2.Errors(validator,value).First(),customError=error2?.schema?.message||error2?.schema?.error!==void 0?typeof error2.schema.error==="function"?error2.schema.error({type,validator,value,get errors(){return[...validator.Errors(value)].map(mapValueError)}}):error2.schema.error:void 0,accessor=error2?.path||"root",message="";if(customError!==void 0)message=typeof customError==="object"?JSON.stringify(customError):customError+"";else if(isProduction)message=JSON.stringify({type:"validation",on:type,summary:mapValueError(error2).summary,message:error2?.message,found:value});else{let schema=validator?.schema??validator,errors="Errors"in validator?[...validator.Errors(value)].map(mapValueError):[...exports_value2.Errors(validator,value)].map(mapValueError),expected;try{expected=exports_value2.Create(schema)}catch(error3){expected={type:"Could not create expected value",message:error3?.message,error:error3}}message=JSON.stringify({type:"validation",on:type,summary:mapValueError(error2).summary,property:accessor,message:error2?.message,expected,found:value,errors},null,2)}super(message);this.type=type,this.validator=validator,this.value=value,Object.setPrototypeOf(this,ValidationError.prototype)}get all(){return"Errors"in this.validator?[...this.validator.Errors(this.value)].map(mapValueError):[...exports_value2.Errors(this.validator,this.value)].map(mapValueError)}static simplifyModel(validator){let model="schema"in validator?validator.schema:validator;try{return exports_value2.Create(model)}catch{return model}}get model(){return ValidationError.simplifyModel(this.validator)}toResponse(headers){return new Response(this.message,{status:400,headers:{...headers,"content-type":"application/json"}})}}var isISO8601=/(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))/,isFormalDate=/(?:Sun|Mon|Tue|Wed|Thu|Fri|Sat)\s(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s\d{2}\s\d{4}\s\d{2}:\d{2}:\d{2}\sGMT(?:\+|-)\d{4}\s\([^)]+\)/,isShortenDate=/^(?:(?:(?:(?:0?[1-9]|[12][0-9]|3[01])[/\s-](?:0?[1-9]|1[0-2])[/\s-](?:19|20)\d{2})|(?:(?:19|20)\d{2}[/\s-](?:0?[1-9]|1[0-2])[/\s-](?:0?[1-9]|[12][0-9]|3[01]))))(?:\s(?:1[012]|0?[1-9]):[0-5][0-9](?::[0-5][0-9])?(?:\s[AP]M)?)?$/,_validateDate=fullFormats.date,_validateDateTime=fullFormats["date-time"];if(!exports_format.Has("date"))exports_format.Set("date",(value)=>{let temp=value.replace(/"/g,"");if(isISO8601.test(temp)||isFormalDate.test(temp)||isShortenDate.test(temp)||_validateDate(temp)){let date2=new Date(temp);if(!Number.isNaN(date2.getTime()))return!0}return!1});if(!exports_format.Has("date-time"))exports_format.Set("date-time",(value)=>{let temp=value.replace(/"/g,"");if(isISO8601.test(temp)||isFormalDate.test(temp)||isShortenDate.test(temp)||_validateDateTime(temp)){let date2=new Date(temp);if(!Number.isNaN(date2.getTime()))return!0}return!1});Object.entries(fullFormats).forEach((formatEntry)=>{let[formatName,formatValue]=formatEntry;if(!exports_format.Has(formatName)){if(formatValue instanceof RegExp)exports_format.Set(formatName,(value)=>formatValue.test(value));else if(typeof formatValue==="function")exports_format.Set(formatName,formatValue)}});var t=Object.assign({},Type),parseFileUnit=(size)=>{if(typeof size==="string")switch(size.slice(-1)){case"k":return+size.slice(0,size.length-1)*1024;case"m":return+size.slice(0,size.length-1)*1048576;default:return+size}return size},checkFileExtension=(type,extension)=>{if(type.startsWith(extension))return!0;return extension.charCodeAt(extension.length-1)===42&&extension.charCodeAt(extension.length-2)===47&&type.startsWith(extension.slice(0,-1))},validateFile=(options,value)=>{if(!(value instanceof Blob))return!1;if(options.minSize&&value.size<parseFileUnit(options.minSize))return!1;if(options.maxSize&&value.size>parseFileUnit(options.maxSize))return!1;if(options.extension){if(typeof options.extension==="string")return checkFileExtension(value.type,options.extension);for(let i=0;i<options.extension.length;i++)if(checkFileExtension(value.type,options.extension[i]))return!0;return!1}return!0},File2=getOrSetType("File",validateFile),Files=getOrSetType("Files",(options,value)=>{if(!Array.isArray(value))return validateFile(options,value);if(options.minItems&&value.length<options.minItems)return!1;if(options.maxItems&&value.length>options.maxItems)return!1;for(let i=0;i<value.length;i++)if(!validateFile(options,value[i]))return!1;return!0});if(!exports_format.Has("numeric"))exports_format.Set("numeric",(value)=>!!value&&!isNaN(+value));if(!exports_format.Has("integer"))exports_format.Set("integer",(value)=>!!value&&Number.isInteger(+value));if(!exports_format.Has("boolean"))exports_format.Set("boolean",(value)=>value==="true"||value==="false");if(!exports_format.Has("ObjectString"))exports_format.Set("ObjectString",(value)=>{let start=value.charCodeAt(0);if(start===9||start===10||start===32)start=value.trimStart().charCodeAt(0);if(start!==123&&start!==91)return!1;try{return JSON.parse(value),!0}catch{return!1}});if(!exports_format.Has("ArrayString"))exports_format.Set("ArrayString",(value)=>{let start=value.charCodeAt(0);if(start===9||start===10||start===32)start=value.trimStart().charCodeAt(0);if(start!==123&&start!==91)return!1;try{return JSON.parse(value),!0}catch{return!1}});if(!exports_type2.Has("UnionEnum"))exports_type2.Set("UnionEnum",(schema,value)=>{return(typeof value==="number"||typeof value==="string"||value===null)&&schema.enum.includes(value)});var ElysiaType={Numeric:(property)=>{let schema=Type.Number(property);return t.Transform(t.Union([t.String({format:"numeric",default:0}),t.Number(property)],property)).Decode((value)=>{let number=+value;if(isNaN(number))return value;if(property&&!exports_value2.Check(schema,number))throw new ValidationError("property",schema,number);return number}).Encode((value)=>value)},Integer:(property)=>{let schema=Type.Integer(property);return t.Transform(t.Union([t.String({format:"integer",default:0}),Type.Integer(property)],property)).Decode((value)=>{let number=+value;if(!exports_value2.Check(schema,number))throw new ValidationError("property",schema,number);return number}).Encode((value)=>value)},Date:(property)=>{let schema=Type.Date(property),_default=property?.default?new Date(property.default):void 0;return t.Transform(t.Union([Type.Date(property),t.String({format:"date",default:_default?.toISOString()}),t.String({format:"date-time",default:_default?.toISOString()}),t.Number({default:_default?.getTime()})],property)).Decode((value)=>{if(typeof value==="number"){let date3=new Date(value);if(!exports_value2.Check(schema,date3))throw new ValidationError("property",schema,date3);return date3}if(value instanceof Date)return value;let date2=new Date(value);if(!date2||isNaN(date2.getTime()))throw new ValidationError("property",schema,date2);if(!exports_value2.Check(schema,date2))throw new ValidationError("property",schema,date2);return date2}).Encode((value)=>value.toISOString())},BooleanString:(property)=>{let schema=Type.Boolean(property);return t.Transform(t.Union([t.Boolean(property),t.String({format:"boolean",default:!1})],property)).Decode((value)=>{if(typeof value==="string")return value==="true";if(value!==void 0&&!exports_value2.Check(schema,value))throw new ValidationError("property",schema,value);return value}).Encode((value)=>value)},ObjectString:(properties,options)=>{let schema=t.Object(properties,options),defaultValue=JSON.stringify(exports_value2.Create(schema)),compiler;try{compiler=TypeCompiler.Compile(schema)}catch{}return t.Transform(t.Union([t.String({format:"ObjectString",default:defaultValue}),schema])).Decode((value)=>{if(typeof value==="string"){if(value.charCodeAt(0)!==123)throw new ValidationError("property",schema,value);try{value=JSON.parse(value)}catch{throw new ValidationError("property",schema,value)}if(compiler){if(!compiler.Check(value))throw new ValidationError("property",schema,value);return compiler.Decode(value)}if(!exports_value2.Check(schema,value))throw new ValidationError("property",schema,value);return exports_value2.Decode(schema,value)}return value}).Encode((value)=>{if(typeof value==="string")try{value=JSON.parse(value)}catch{throw new ValidationError("property",schema,value)}if(!exports_value2.Check(schema,value))throw new ValidationError("property",schema,value);return JSON.stringify(value)})},ArrayString:(children=t.String(),options)=>{let schema=t.Array(children,options),compiler;try{compiler=TypeCompiler.Compile(schema)}catch{}let decode2=(value,isProperty=!1)=>{if(value.charCodeAt(0)===91){try{value=JSON.parse(value)}catch{throw new ValidationError("property",schema,value)}if(compiler){if(!compiler.Check(value))throw new ValidationError("property",schema,value);return compiler.Decode(value)}if(!exports_value2.Check(schema,value))throw new ValidationError("property",schema,value);return exports_value2.Decode(schema,value)}if(value.indexOf(",")!==-1){let newValue=value.split(",").map((v)=>v.trim());if(compiler){if(!compiler.Check(newValue))throw new ValidationError("property",schema,value);return compiler.Decode(newValue)}if(!exports_value2.Check(schema,newValue))throw new ValidationError("property",schema,newValue);return exports_value2.Decode(schema,newValue)}if(isProperty)return value;throw new ValidationError("property",schema,value)};return t.Transform(t.Union([t.String({format:"ArrayString",default:options?.default}),schema])).Decode((value)=>{if(Array.isArray(value)){let values=[];for(let i=0;i<value.length;i++){let v=value[i];if(typeof v==="string"){let t2=decode2(v,!0);if(Array.isArray(t2))values=values.concat(t2);else values.push(t2);continue}values.push(v)}return values}if(typeof value==="string")return decode2(value);return value}).Encode((value)=>{if(typeof value==="string")try{value=JSON.parse(value)}catch{throw new ValidationError("property",schema,value)}if(!exports_value2.Check(schema,value))throw new ValidationError("property",schema,value);return JSON.stringify(value)})},File:File2,Files:(options={})=>t.Transform(Files(options)).Decode((value)=>{if(Array.isArray(value))return value;return[value]}).Encode((value)=>value),Nullable:(schema,options)=>t.Union([schema,t.Null()],options),MaybeEmpty:(schema,options)=>t.Union([schema,t.Null(),t.Undefined()],options),Cookie:(properties,{domain,expires,httpOnly,maxAge,path,priority,sameSite,secure,secrets,sign,...options}={})=>{let v=t.Object(properties,options);return v.config={domain,expires,httpOnly,maxAge,path,priority,sameSite,secure,secrets,sign},v},UnionEnum:(values,options={})=>{let type=values.every((value)=>typeof value==="string")?{type:"string"}:values.every((value)=>typeof value==="number")?{type:"number"}:values.every((value)=>value===null)?{type:"null"}:{};if(values.some((x)=>typeof x==="object"&&x!==null))throw new Error("This type does not support objects or arrays");return{default:values[0],...options,[Kind]:"UnionEnum",...type,enum:values}}};t.BooleanString=ElysiaType.BooleanString;t.ObjectString=ElysiaType.ObjectString;t.ArrayString=ElysiaType.ArrayString;t.Numeric=ElysiaType.Numeric;t.Integer=ElysiaType.Integer;t.File=(arg={})=>ElysiaType.File({default:"File",...arg,extension:arg?.type,type:"string",format:"binary"});t.Files=(arg={})=>ElysiaType.Files({...arg,elysiaMeta:"Files",default:"Files",extension:arg?.type,type:"array",items:{...arg,default:"Files",type:"string",format:"binary"}});t.Nullable=(schema)=>ElysiaType.Nullable(schema);t.MaybeEmpty=ElysiaType.MaybeEmpty;t.Cookie=ElysiaType.Cookie;t.Date=ElysiaType.Date;t.UnionEnum=ElysiaType.UnionEnum;function getOrSetType(kind,func){if(!exports_type2.Has(kind))exports_type2.Set(kind,func);return(options={})=>Unsafe({...options,[Kind]:kind})}var hasReturn=(fn)=>{let fnLiteral=typeof fn==="object"?fn.fn.toString():typeof fn==="string"?fn.toString():fn,parenthesisEnd=fnLiteral.indexOf(")");if(fnLiteral.charCodeAt(parenthesisEnd+2)===61&&fnLiteral.charCodeAt(parenthesisEnd+5)!==123)return!0;return fnLiteral.includes("return")},separateFunction=(code)=>{if(code.startsWith("async"))code=code.slice(5);code=code.trimStart();let index=-1;if(code.charCodeAt(0)===40){if(index=code.indexOf("=>",code.indexOf(")")),index!==-1){let bracketEndIndex=index;while(bracketEndIndex>0)if(code.charCodeAt(--bracketEndIndex)===41)break;let body=code.slice(index+2);if(body.charCodeAt(0)===32)body=body.trimStart();return[code.slice(1,bracketEndIndex),body,{isArrowReturn:body.charCodeAt(0)!==123}]}}if(/^(\w+)=>/g.test(code)){if(index=code.indexOf("=>"),index!==-1){let body=code.slice(index+2);if(body.charCodeAt(0)===32)body=body.trimStart();return[code.slice(0,index),body,{isArrowReturn:body.charCodeAt(0)!==123}]}}if(code.startsWith("function")){index=code.indexOf("(");let end=code.indexOf(")");return[code.slice(index+1,end),code.slice(end+2),{isArrowReturn:!1}]}let start=code.indexOf("(");if(start!==-1){let sep=code.indexOf(`
`,2),parameter=code.slice(0,sep),end=parameter.lastIndexOf(")")+1,body=code.slice(sep+1);return[parameter.slice(start,end),"{"+body,{isArrowReturn:!1}]}let x=code.split(`
`,2);return[x[0],x[1],{isArrowReturn:!1}]},bracketPairRange=(parameter)=>{let start=parameter.indexOf("{");if(start===-1)return[-1,0];let end=start+1,deep=1;for(;end<parameter.length;end++){let char=parameter.charCodeAt(end);if(char===123)deep++;else if(char===125)deep--;if(deep===0)break}if(deep!==0)return[0,parameter.length];return[start,end+1]},bracketPairRangeReverse=(parameter)=>{let end=parameter.lastIndexOf("}");if(end===-1)return[-1,0];let start=end-1,deep=1;for(;start>=0;start--){let char=parameter.charCodeAt(start);if(char===125)deep++;else if(char===123)deep--;if(deep===0)break}if(deep!==0)return[-1,0];return[start,end+1]},removeColonAlias=(parameter)=>{while(!0){let start=parameter.indexOf(":");if(start===-1)break;let end=parameter.indexOf(",",start);if(end===-1)end=parameter.indexOf("}",start)-1;if(end===-2)end=parameter.length;parameter=parameter.slice(0,start)+parameter.slice(end)}return parameter},retrieveRootParamters=(parameter)=>{let hasParenthesis=!1;if(parameter.charCodeAt(0)===40)parameter=parameter.slice(1,-1);if(parameter.charCodeAt(0)===123)hasParenthesis=!0,parameter=parameter.slice(1,-1);parameter=parameter.replace(/( |\t|\n)/g,"").trim();let parameters=[];while(!0){let[start,end]=bracketPairRange(parameter);if(start===-1)break;if(parameters.push(parameter.slice(0,start-1)),parameter.charCodeAt(end)===44)end++;parameter=parameter.slice(end)}if(parameter=removeColonAlias(parameter),parameter)parameters=parameters.concat(parameter.split(","));let newParameters=[];for(let p of parameters){if(p.indexOf(",")===-1){newParameters.push(p);continue}for(let q of p.split(","))newParameters.push(q.trim())}return parameters=newParameters,{hasParenthesis,parameters}},findParameterReference=(parameter,inference)=>{let{parameters,hasParenthesis}=retrieveRootParamters(parameter);if(!inference.query&&parameters.includes("query"))inference.query=!0;if(!inference.headers&&parameters.includes("headers"))inference.headers=!0;if(!inference.body&&parameters.includes("body"))inference.body=!0;if(!inference.cookie&&parameters.includes("cookie"))inference.cookie=!0;if(!inference.set&&parameters.includes("set"))inference.set=!0;if(!inference.server&&parameters.includes("server"))inference.server=!0;if(!inference.request&&parameters.includes("request"))inference.request=!0;if(!inference.route&&parameters.includes("route"))inference.route=!0;if(hasParenthesis)return`{ ${parameters.join(", ")} }`;return parameters.join(", ")},findEndIndex=(type,content,index)=>{let newLineIndex=content.indexOf(type+`
`,index),newTabIndex=content.indexOf(type+"\t",index),commaIndex=content.indexOf(type+",",index),semicolonIndex=content.indexOf(type+";",index),emptyIndex=content.indexOf(type+" ",index);return[newLineIndex,newTabIndex,commaIndex,semicolonIndex,emptyIndex].filter((i)=>i>0).sort((a,b)=>a-b)[0]||-1},findAlias=(type,body,depth=0)=>{if(depth>5)return[];let aliases=[],content=body;while(!0){let index=findEndIndex(" = "+type,content);if(index===-1)index=findEndIndex("="+type,content);if(index===-1){let lastIndex=content.indexOf(" = "+type);if(lastIndex===-1)lastIndex=content.indexOf("="+type);if(lastIndex+3+type.length!==content.length)break;index=lastIndex}let part=content.slice(0,index),lastPart=part.lastIndexOf(" "),variable=part.slice(lastPart!==-1?lastPart+1:-1);if(variable==="}"){let[start,end]=bracketPairRangeReverse(part);aliases.push(removeColonAlias(content.slice(start,end))),content=content.slice(index+3+type.length);continue}while(variable.charCodeAt(0)===44)variable=variable.slice(1);while(variable.charCodeAt(0)===9)variable=variable.slice(1);if(!variable.includes("("))aliases.push(variable);content=content.slice(index+3+type.length)}for(let alias of aliases){if(alias.charCodeAt(0)===123)continue;let deepAlias=findAlias(alias,body);if(deepAlias.length>0)aliases.push(...deepAlias)}return aliases},extractMainParameter=(parameter)=>{if(!parameter)return;if(parameter.charCodeAt(0)!==123)return parameter;if(parameter=parameter.slice(2,-2),!parameter.includes(",")){if(parameter.includes("..."))return parameter.slice(parameter.indexOf("...")+3);return}let spreadIndex=parameter.indexOf("...");if(spreadIndex===-1)return;return parameter.slice(spreadIndex+3).trimEnd()},inferBodyReference=(code,aliases,inference)=>{let access=(type,alias)=>code.includes(alias+"."+type)||code.includes(alias+'["'+type+'"]')||code.includes(alias+"['"+type+"']");for(let alias of aliases){if(!alias)continue;if(alias.charCodeAt(0)===123){let parameters=retrieveRootParamters(alias).parameters;if(!inference.query&&parameters.includes("query"))inference.query=!0;if(!inference.headers&&parameters.includes("headers"))inference.headers=!0;if(!inference.body&&parameters.includes("body"))inference.body=!0;if(!inference.cookie&&parameters.includes("cookie"))inference.cookie=!0;if(!inference.set&&parameters.includes("set"))inference.set=!0;if(!inference.query&&parameters.includes("server"))inference.server=!0;if(!inference.request&&parameters.includes("request"))inference.request=!0;if(!inference.route&&parameters.includes("route"))inference.route=!0;continue}if(!inference.query&&access("query",alias))inference.query=!0;if(code.includes("return "+alias)||code.includes("return "+alias+".query"))inference.query=!0;if(!inference.headers&&access("headers",alias))inference.headers=!0;if(!inference.body&&access("body",alias))inference.body=!0;if(!inference.cookie&&access("cookie",alias))inference.cookie=!0;if(!inference.set&&access("set",alias))inference.set=!0;if(!inference.server&&access("server",alias))inference.server=!0;if(inference.query&&inference.headers&&inference.body&&inference.cookie&&inference.set&&inference.server&&inference.server&&inference.route)break}return aliases},isContextPassToFunction=(context,body,inference)=>{try{let captureFunction=new RegExp(`(?:\\w)\\((?:.*)?${context}`,"gs");captureFunction.test(body);let nextChar=body.charCodeAt(captureFunction.lastIndex);if(nextChar===41||nextChar===44)return inference.query=!0,inference.headers=!0,inference.body=!0,inference.cookie=!0,inference.set=!0,inference.server=!0,inference.route=!0,inference.request=!0,!0;return!1}catch(error2){return console.log("[Sucrose] warning: unexpected isContextPassToFunction error, you may continue development as usual but please report the following to maintainers:"),console.log("--- body ---"),console.log(body),console.log("--- context ---"),console.log(context),!0}},sucrose=(lifeCycle,inference={query:!1,headers:!1,body:!1,cookie:!1,set:!1,server:!1,request:!1,route:!1})=>{let events=[];if(lifeCycle.handler&&typeof lifeCycle.handler==="function")events.push(lifeCycle.handler);if(lifeCycle.request?.length)events.push(...lifeCycle.request);if(lifeCycle.beforeHandle?.length)events.push(...lifeCycle.beforeHandle);if(lifeCycle.parse?.length)events.push(...lifeCycle.parse);if(lifeCycle.error?.length)events.push(...lifeCycle.error);if(lifeCycle.transform?.length)events.push(...lifeCycle.transform);if(lifeCycle.afterHandle?.length)events.push(...lifeCycle.afterHandle);if(lifeCycle.mapResponse?.length)events.push(...lifeCycle.mapResponse);if(lifeCycle.afterResponse?.length)events.push(...lifeCycle.afterResponse);for(let e of events){if(!e)continue;let event="fn"in e?e.fn:e;if(typeof event!=="function")continue;let[parameter,body,{isArrowReturn}]=separateFunction(event.toString()),rootParameters=findParameterReference(parameter,inference),mainParameter=extractMainParameter(rootParameters);if(mainParameter){let aliases=findAlias(mainParameter,body.slice(1,-1));aliases.splice(0,-1,mainParameter);let code=body;if(code.charCodeAt(0)===123&&code.charCodeAt(body.length-1)===125)code=code.slice(1,-1);if(!isContextPassToFunction(mainParameter,code,inference))inferBodyReference(code,aliases,inference);if(!inference.query&&code.includes("return "+mainParameter+".query"))inference.query=!0}if(inference.query&&inference.headers&&inference.body&&inference.cookie&&inference.set&&inference.server&&inference.request&&inference.route)break}return inference},hex=[];for(let i=48;i<58;i++)hex[i]=i-48;for(let i=0;i<6;i++)hex[i+65]=hex[i+97]=i+10;var calcHex=(a,b)=>{if(a in hex&&b in hex)return hex[a]<<4|hex[b];return 255},type=[...new Array(128).fill(0),...new Array(16).fill(1),...new Array(16).fill(2),...new Array(32).fill(3),4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,7,7,7,7,7,7,7,7,7,7,7,7,8,7,7,10,9,9,9,11,4,4,4,4,4,4,4,4,4,4,4],next=[0,0,0,0,0,0,0,0,0,0,0,0,12,0,0,0,0,24,36,48,60,72,84,96,0,12,12,12,0,0,0,0,0,0,0,0,0,0,0,24,0,0,0,0,0,0,0,0,0,24,24,24,0,0,0,0,0,0,0,0,0,24,24,0,0,0,0,0,0,0,0,0,0,48,48,48,0,0,0,0,0,0,0,0,0,0,48,48,0,0,0,0,0,0,0,0,0,48,0,0,0,0,0,0,0,0,0,0],mask=type.map((val)=>[127,63,63,63,0,31,15,15,15,7,7,7][val]),decode2=(url)=>{let percentPosition=url.indexOf("%");if(percentPosition===-1)return url;let end=url.length-3;if(percentPosition>end)return null;let decoded="",start=0,codepoint=0,startOfOctets=percentPosition,state=12,byte2;for(;;){if(byte2=calcHex(url.charCodeAt(percentPosition+1),url.charCodeAt(percentPosition+2)),state=next[state+type[byte2]],state===0)return null;if(state===12){if(decoded+=url.substring(start,startOfOctets),codepoint=codepoint<<6|byte2&mask[byte2],codepoint>65535)decoded+=String.fromCharCode(55232+(codepoint>>10),56320+(codepoint&1023));else decoded+=String.fromCharCode(codepoint);if(start=percentPosition+3,percentPosition=url.indexOf("%",start),percentPosition===-1)return decoded+url.substring(start);if(percentPosition>end)return null;startOfOctets=percentPosition,codepoint=0}else{if(percentPosition+=3,percentPosition>end||url.charCodeAt(percentPosition)!==37)return null;codepoint=codepoint<<6|byte2&mask[byte2]}}};class Cookie{name;jar;initial;constructor(name,jar,initial={}){this.name=name,this.jar=jar,this.initial=initial}get cookie(){return this.jar[this.name]??this.initial}set cookie(jar){if(!(this.name in this.jar))this.jar[this.name]=this.initial;this.jar[this.name]=jar}get setCookie(){if(!(this.name in this.jar))this.jar[this.name]=this.initial;return this.jar[this.name]}set setCookie(jar){this.cookie=jar}get value(){return this.cookie.value}set value(value){this.setCookie.value=value}get expires(){return this.cookie.expires}set expires(expires){this.setCookie.expires=expires}get maxAge(){return this.cookie.maxAge}set maxAge(maxAge){this.setCookie.maxAge=maxAge}get domain(){return this.cookie.domain}set domain(domain){this.setCookie.domain=domain}get path(){return this.cookie.path}set path(path){this.setCookie.path=path}get secure(){return this.cookie.secure}set secure(secure){this.setCookie.secure=secure}get httpOnly(){return this.cookie.httpOnly}set httpOnly(httpOnly){this.setCookie.httpOnly=httpOnly}get sameSite(){return this.cookie.sameSite}set sameSite(sameSite){this.setCookie.sameSite=sameSite}get priority(){return this.cookie.priority}set priority(priority){this.setCookie.priority=priority}get partitioned(){return this.cookie.partitioned}set partitioned(partitioned){this.setCookie.partitioned=partitioned}get secrets(){return this.cookie.secrets}set secrets(secrets){this.setCookie.secrets=secrets}update(config){return this.setCookie=Object.assign(this.cookie,typeof config==="function"?config(this.cookie):config),this}set(config){return this.setCookie=Object.assign({...this.initial,value:this.value},typeof config==="function"?config(this.cookie):config),this}remove(){if(this.value===void 0)return;return this.set({expires:new Date(0),maxAge:0,value:""}),this}toString(){return typeof this.value==="object"?JSON.stringify(this.value):this.value?.toString()??""}}var createCookieJar=(set2,store,initial)=>{if(!set2.cookie)set2.cookie={};return new Proxy(store,{get(_2,key){if(key in store)return new Cookie(key,set2.cookie,Object.assign({},initial??{},store[key]));return new Cookie(key,set2.cookie,Object.assign({},initial))}})},parseCookie=async(set2,cookieString,{secrets,sign,...initial}={})=>{if(!cookieString)return createCookieJar(set2,{},initial);let isStringKey=typeof secrets==="string";if(sign&&sign!==!0&&!Array.isArray(sign))sign=[sign];let jar={},cookies=import_cookie.parse(cookieString);for(let[name,v]of Object.entries(cookies)){if(v===void 0)continue;let value=decode2(v);if(sign===!0||sign?.includes(name)){if(!secrets)throw new Error("No secret is provided to cookie plugin");if(isStringKey){let temp=await unsignCookie(value,secrets);if(temp===!1)throw new InvalidCookieSignature(name);value=temp}else{let decoded=!0;for(let i=0;i<secrets.length;i++){let temp=await unsignCookie(value,secrets[i]);if(temp!==!1){decoded=!0,value=temp;break}}if(!decoded)throw new InvalidCookieSignature(name)}}jar[name]={value}}return createCookieJar(set2,jar,initial)},serializeCookie=(cookies)=>{if(!cookies||!isNotEmpty(cookies))return;let set2=[];for(let[key,property]of Object.entries(cookies)){if(!key||!property)continue;let value=property.value;if(value===void 0||value===null)continue;set2.push(import_cookie.serialize(key,typeof value==="object"?JSON.stringify(value):value+"",property))}if(set2.length===0)return;if(set2.length===1)return set2[0];return set2},handleFile=(response,set2)=>{let size=response.size;if(!set2&&size||size&&set2&&set2.status!==206&&set2.status!==304&&set2.status!==412&&set2.status!==416){if(set2){if(set2.headers instanceof Headers){let setHeaders={"accept-ranges":"bytes","content-range":`bytes 0-${size-1}/${size}`,"transfer-encoding":"chunked"};if(hasHeaderShorthand)setHeaders=set2.headers.toJSON();else{setHeaders={};for(let[key,value]of set2.headers.entries())if(key in set2.headers)setHeaders[key]=value}return new Response(response,{status:set2.status,headers:setHeaders})}if(isNotEmpty(set2.headers))return new Response(response,{status:set2.status,headers:Object.assign({"accept-ranges":"bytes","content-range":`bytes 0-${size-1}/${size}`,"transfer-encoding":"chunked"},set2.headers)})}return new Response(response,{headers:{"accept-ranges":"bytes","content-range":`bytes 0-${size-1}/${size}`,"transfer-encoding":"chunked"}})}return new Response(response)},parseSetCookies=(headers,setCookie)=>{if(!headers)return headers;headers.delete("set-cookie");for(let i=0;i<setCookie.length;i++){let index=setCookie[i].indexOf("=");headers.append("set-cookie",`${setCookie[i].slice(0,index)}=${setCookie[i].slice(index+1)||""}`)}return headers},responseToSetHeaders=(response,set2)=>{if(set2?.headers){if(response){if(hasHeaderShorthand)Object.assign(set2.headers,response.headers.toJSON());else for(let[key,value]of response.headers.entries())if(key in set2.headers)set2.headers[key]=value}if(set2.status===200)set2.status=response.status;if(set2.headers["content-encoding"])delete set2.headers["content-encoding"];return set2}if(!response)return{headers:{},status:set2?.status??200};if(hasHeaderShorthand){if(set2={headers:response.headers.toJSON(),status:set2?.status??200},set2.headers["content-encoding"])delete set2.headers["content-encoding"];return set2}set2={headers:{},status:set2?.status??200};for(let[key,value]of response.headers.entries()){if(key==="content-encoding")continue;if(key in set2.headers)set2.headers[key]=value}return set2},handleStream=async(generator,set2,request)=>{let init=generator.next();if(init instanceof Promise)init=await init;if(init.done){if(set2)return mapResponse(init.value,set2,request);return mapCompactResponse(init.value,request)}if(set2?.headers){if(!set2.headers["transfer-encoding"])set2.headers["transfer-encoding"]="chunked";if(!set2.headers["content-type"])set2.headers["content-type"]="text/event-stream; charset=utf-8"}else set2={status:200,headers:{"content-type":"text/event-stream; charset=utf-8","transfer-encoding":"chunked"}};return new Response(new ReadableStream({async start(controller){let end=!1;if(request?.signal?.addEventListener("abort",()=>{end=!0;try{controller.close()}catch{}}),init.value!==void 0&&init.value!==null)if(typeof init.value==="object")try{controller.enqueue(Buffer.from(JSON.stringify(init.value)))}catch{controller.enqueue(Buffer.from(init.value.toString()))}else controller.enqueue(Buffer.from(init.value.toString()));for await(let chunk of generator){if(end)break;if(chunk===void 0||chunk===null)continue;if(typeof chunk==="object")try{controller.enqueue(Buffer.from(JSON.stringify(chunk)))}catch{controller.enqueue(Buffer.from(chunk.toString()))}else controller.enqueue(Buffer.from(chunk.toString()));await new Promise((resolve)=>setTimeout(()=>resolve(),0))}try{controller.close()}catch{}}}),set2)};async function*streamResponse(response){let body=response.body;if(!body)return;let reader=body.getReader(),decoder=new TextDecoder;try{while(!0){let{done,value}=await reader.read();if(done)break;yield decoder.decode(value)}}finally{reader.releaseLock()}}var handleSet=(set2)=>{if(typeof set2.status==="string")set2.status=StatusMap[set2.status];if(set2.cookie&&isNotEmpty(set2.cookie)){let cookie=serializeCookie(set2.cookie);if(cookie)set2.headers["set-cookie"]=cookie}if(set2.headers["set-cookie"]&&Array.isArray(set2.headers["set-cookie"]))set2.headers=parseSetCookies(new Headers(set2.headers),set2.headers["set-cookie"])},mergeResponseWithSetHeaders=(response,set2)=>{if(response.status!==set2.status&&set2.status!==200&&(response.status<=300||response.status>400))response=new Response(response.body,{headers:response.headers,status:set2.status});let isCookieSet=!1;if(set2.headers instanceof Headers)for(let key of set2.headers.keys())if(key==="set-cookie"){if(isCookieSet)continue;isCookieSet=!0;for(let cookie of set2.headers.getSetCookie())response.headers.append("set-cookie",cookie)}else response.headers.append(key,set2.headers?.get(key)??"");else for(let key in set2.headers)response.headers.append(key,set2.headers[key]);return response},mapResponse=(response,set2,request)=>{if(isNotEmpty(set2.headers)||set2.status!==200||set2.cookie)switch(handleSet(set2),response?.constructor?.name){case"String":return new Response(response,set2);case"Array":case"Object":return Response.json(response,set2);case"ElysiaFile":return handleFile(response.value);case"Blob":return handleFile(response,set2);case"ElysiaCustomStatusResponse":return set2.status=response.code,mapResponse(response.response,set2,request);case"ReadableStream":if(!set2.headers["content-type"]?.startsWith("text/event-stream"))set2.headers["content-type"]="text/event-stream; charset=utf-8";return request?.signal?.addEventListener("abort",{handleEvent(){if(request?.signal&&!request?.signal?.aborted)response.cancel()}},{once:!0}),new Response(response,set2);case void 0:if(!response)return new Response("",set2);return Response.json(response,set2);case"Response":if(response=mergeResponseWithSetHeaders(response,set2),!response.headers.has("content-length")&&response.headers.get("transfer-encoding")==="chunked")return handleStream(streamResponse(response),responseToSetHeaders(response,set2),request);return response;case"Error":return errorToResponse(response,set2);case"Promise":return response.then((x)=>mapResponse(x,set2,request));case"Function":return mapResponse(response(),set2,request);case"Number":case"Boolean":return new Response(response.toString(),set2);case"Cookie":if(response instanceof Cookie)return new Response(response.value,set2);return new Response(response?.toString(),set2);case"FormData":return new Response(response,set2);default:if(response instanceof Response){if(response=mergeResponseWithSetHeaders(response,set2),response.headers.get("transfer-encoding")==="chunked")return handleStream(streamResponse(response),responseToSetHeaders(response,set2),request);return response}if(response instanceof Promise)return response.then((x)=>mapResponse(x,set2));if(response instanceof Error)return errorToResponse(response,set2);if(response instanceof ElysiaCustomStatusResponse)return set2.status=response.code,mapResponse(response.response,set2,request);if(typeof response?.next==="function")return handleStream(response,set2,request);if(typeof response?.then==="function")return response.then((x)=>mapResponse(x,set2));if(typeof response?.toResponse==="function")return mapResponse(response.toResponse(),set2);if("charCodeAt"in response){let code=response.charCodeAt(0);if(code===123||code===91){if(!set2.headers["Content-Type"])set2.headers["Content-Type"]="application/json";return new Response(JSON.stringify(response),set2)}}return new Response(response,set2)}if(response instanceof Response&&!response.headers.has("content-length")&&response.headers.get("transfer-encoding")==="chunked")return handleStream(streamResponse(response),responseToSetHeaders(response,set2),request);if(typeof response?.next==="function"||response instanceof ReadableStream)return handleStream(response,set2,request);return mapCompactResponse(response,request)},mapEarlyResponse=(response,set2,request)=>{if(response===void 0||response===null)return;if(isNotEmpty(set2.headers)||set2.status!==200||set2.cookie)switch(handleSet(set2),response?.constructor?.name){case"String":return new Response(response,set2);case"Array":case"Object":return Response.json(response,set2);case"ElysiaFile":return handleFile(response.value);case"Blob":return handleFile(response,set2);case"ElysiaCustomStatusResponse":return set2.status=response.code,mapEarlyResponse(response.response,set2,request);case"ReadableStream":if(!set2.headers["content-type"]?.startsWith("text/event-stream"))set2.headers["content-type"]="text/event-stream; charset=utf-8";return request?.signal?.addEventListener("abort",{handleEvent(){if(request?.signal&&!request?.signal?.aborted)response.cancel()}},{once:!0}),new Response(response,set2);case void 0:if(!response)return;return Response.json(response,set2);case"Response":if(response=mergeResponseWithSetHeaders(response,set2),!response.headers.has("content-length")&&response.headers.get("transfer-encoding")==="chunked")return handleStream(streamResponse(response),responseToSetHeaders(response,set2),request);return response;case"Promise":return response.then((x)=>mapEarlyResponse(x,set2));case"Error":return errorToResponse(response,set2);case"Function":return mapEarlyResponse(response(),set2);case"Number":case"Boolean":return new Response(response.toString(),set2);case"FormData":return new Response(response);case"Cookie":if(response instanceof Cookie)return new Response(response.value,set2);return new Response(response?.toString(),set2);default:if(response instanceof Response){if(response=mergeResponseWithSetHeaders(response,set2),response.headers.get("transfer-encoding")==="chunked")return handleStream(streamResponse(response),responseToSetHeaders(response,set2),request);return response}if(response instanceof Promise)return response.then((x)=>mapEarlyResponse(x,set2));if(response instanceof Error)return errorToResponse(response,set2);if(response instanceof ElysiaCustomStatusResponse)return set2.status=response.code,mapEarlyResponse(response.response,set2,request);if(typeof response?.next==="function")return handleStream(response,set2,request);if(typeof response?.then==="function")return response.then((x)=>mapEarlyResponse(x,set2));if(typeof response?.toResponse==="function")return mapEarlyResponse(response.toResponse(),set2);if("charCodeAt"in response){let code=response.charCodeAt(0);if(code===123||code===91){if(!set2.headers["Content-Type"])set2.headers["Content-Type"]="application/json";return new Response(JSON.stringify(response),set2)}}return new Response(response,set2)}else switch(response?.constructor?.name){case"String":return new Response(response);case"Array":case"Object":return Response.json(response,set2);case"ElysiaFile":return handleFile(response.value);case"Blob":return handleFile(response,set2);case"ElysiaCustomStatusResponse":return set2.status=response.code,mapEarlyResponse(response.response,set2,request);case"ReadableStream":return request?.signal?.addEventListener("abort",{handleEvent(){if(request?.signal&&!request?.signal?.aborted)response.cancel()}},{once:!0}),new Response(response,{headers:{"Content-Type":"text/event-stream; charset=utf-8"}});case void 0:if(!response)return new Response("");return new Response(JSON.stringify(response),{headers:{"content-type":"application/json"}});case"Response":if(!response.headers.has("content-length")&&response.headers.get("transfer-encoding")==="chunked")return handleStream(streamResponse(response),responseToSetHeaders(response),request);return response;case"Promise":return response.then((x)=>{let r=mapEarlyResponse(x,set2);if(r!==void 0)return r});case"Error":return errorToResponse(response,set2);case"Function":return mapCompactResponse(response(),request);case"Number":case"Boolean":return new Response(response.toString());case"Cookie":if(response instanceof Cookie)return new Response(response.value,set2);return new Response(response?.toString(),set2);case"FormData":return new Response(response);default:if(response instanceof Response)return response;if(response instanceof Promise)return response.then((x)=>mapEarlyResponse(x,set2));if(response instanceof Error)return errorToResponse(response,set2);if(response instanceof ElysiaCustomStatusResponse)return set2.status=response.code,mapEarlyResponse(response.response,set2,request);if(typeof response?.next==="function")return handleStream(response,set2,request);if(typeof response?.then==="function")return response.then((x)=>mapEarlyResponse(x,set2));if(typeof response?.toResponse==="function")return mapEarlyResponse(response.toResponse(),set2);if("charCodeAt"in response){let code=response.charCodeAt(0);if(code===123||code===91){if(!set2.headers["Content-Type"])set2.headers["Content-Type"]="application/json";return new Response(JSON.stringify(response),set2)}}return new Response(response)}},mapCompactResponse=(response,request)=>{switch(response?.constructor?.name){case"String":return new Response(response);case"Object":case"Array":return Response.json(response);case"ElysiaFile":return handleFile(response.value);case"Blob":return handleFile(response);case"ElysiaCustomStatusResponse":return mapResponse(response.response,{status:response.code,headers:{}});case"ReadableStream":return request?.signal?.addEventListener("abort",{handleEvent(){if(request?.signal&&!request?.signal?.aborted)response.cancel()}},{once:!0}),new Response(response,{headers:{"Content-Type":"text/event-stream; charset=utf-8"}});case void 0:if(!response)return new Response("");return new Response(JSON.stringify(response),{headers:{"content-type":"application/json"}});case"Response":if(response.headers.get("transfer-encoding")==="chunked")return handleStream(streamResponse(response),responseToSetHeaders(response),request);return response;case"Error":return errorToResponse(response);case"Promise":return response.then((x)=>mapCompactResponse(x,request));case"Function":return mapCompactResponse(response(),request);case"Number":case"Boolean":return new Response(response.toString());case"FormData":return new Response(response);default:if(response instanceof Response)return response;if(response instanceof Promise)return response.then((x)=>mapCompactResponse(x,request));if(response instanceof Error)return errorToResponse(response);if(response instanceof ElysiaCustomStatusResponse)return mapResponse(response.response,{status:response.code,headers:{}});if(typeof response?.next==="function")return handleStream(response,void 0,request);if(typeof response?.then==="function")return response.then((x)=>mapResponse(x,set));if(typeof response?.toResponse==="function")return mapCompactResponse(response.toResponse());if("charCodeAt"in response){let code=response.charCodeAt(0);if(code===123||code===91)return new Response(JSON.stringify(response),{headers:{"Content-Type":"application/json"}})}return new Response(response)}},errorToResponse=(error2,set2)=>new Response(JSON.stringify({name:error2?.name,message:error2?.message,cause:error2?.cause}),{status:set2?.status!==200?set2?.status??500:500,headers:set2?.headers}),createStaticHandler=(handle,hooks,setHeaders={})=>{if(typeof handle==="function")return;let response=mapResponse(handle,{headers:setHeaders});if(!hooks.parse?.length&&!hooks.transform?.length&&!hooks.beforeHandle?.length&&!hooks.afterHandle?.length)return response.clone.bind(response)},WebStandardAdapter={name:"web-standard",isWebStandard:!0,handler:{mapResponse,mapEarlyResponse,mapCompactResponse,createStaticHandler},composeHandler:{mapResponseContext:"c.request",preferWebstandardHeaders:!0,headers:`c.headers = {}
for (const [key, value] of c.request.headers.entries())c.headers[key] = value
`,parser:{json(isOptional){if(isOptional)return`try{c.body=await c.request.json()}catch{}
`;return`c.body=await c.request.json()
`},text(){return`c.body=await c.request.text()
`},urlencoded(){return`c.body=parseQuery(await c.request.text())
`},arrayBuffer(){return`c.body=await c.request.arrayBuffer()
`},formData(isOptional){let fnLiteral=`
c.body={}
`;if(isOptional)fnLiteral+="let form;try{form=await c.request.formData()}catch{}";else fnLiteral+=`const form=await c.request.formData()
`;return fnLiteral+`for(const key of form.keys()){if(c.body[key]) continue
const value=form.getAll(key)
if(value.length===1)c.body[key]=value[0]
else c.body[key]=value}`}}},composeGeneralHandler:{parameters:"r",createContext(app){let decoratorsLiteral="",fnLiteral="",defaultHeaders=app.setHeaders;for(let key of Object.keys(app.singleton.decorator))decoratorsLiteral+=`,${key}: decorator['${key}']`;let standardHostname=app.config.handler?.standardHostname??!0,hasTrace=!!app.event.trace?.length;if(fnLiteral+=`const u=r.url,s=u.indexOf('/',${standardHostname?11:7}),qi=u.indexOf('?', s + 1)
let p
if(qi===-1)p=u.substring(s)
else p=u.substring(s, qi)
`,hasTrace)fnLiteral+=`const id=randomId()
`;if(fnLiteral+="const c={request:r,store,qi,path:p,url:u,redirect,error,set:{headers:",fnLiteral+=Object.keys(defaultHeaders??{}).length?"Object.assign({}, app.setHeaders)":"{}",fnLiteral+=",status:200}",app.inference.server)fnLiteral+=",get server(){return app.getServer()}";if(hasTrace)fnLiteral+=",[ELYSIA_REQUEST_ID]:id";return fnLiteral+=decoratorsLiteral,fnLiteral+=`}
`,fnLiteral},websocket(app){let fnLiteral="",wsPaths=app.router.static.ws,router=app.router.http;if(router.build(),Object.keys(wsPaths).length||router.root.ws||router.history.find((x)=>x["0"]==="ws")){fnLiteral+="if(r.method==='GET'){switch(p){";for(let[path,index]of Object.entries(wsPaths))fnLiteral+=`case'${path}':`+(app.config.strictPath!==!0?`case'${getLoosePath(path)}':`:"")+`if(r.headers.get('upgrade')==='websocket')return ht[${index}].composed(c)
`;fnLiteral+=`default:if(r.headers.get('upgrade')==='websocket'){const route=router.find('ws',p)
if(route){c.params=route.params
if(route.store.handler)return route.store.handler(c)
return (route.store.handler=route.store.compile())(c)}}break}}`}return fnLiteral},error404(hasEventHook,hasErrorHook){let findDynamicRoute="if(route===null)return ";if(hasErrorHook)findDynamicRoute+=`app.handleError(c,notFound,false,${this.parameters})`;else findDynamicRoute+=hasEventHook?"new Response(error404Message,{status:c.set.status===200?404:c.set.status,headers:c.set.headers})":"error404.clone()";return{declare:hasErrorHook?"":`const error404Message=notFound.message.toString()
const error404=new Response(error404Message,{status:404})
`,code:findDynamicRoute}}},composeError:{mapResponseContext:"",validationError:"return new Response(error.message,{headers:Object.assign({'content-type':'application/json'},set.headers),status:set.status})",unknownError:"return new Response(error.message,{headers:set.headers,status:error.status??set.status??500})"},listen(){return()=>{throw new Error("WebStandard does not support listen, you might want to export default Elysia.fetch instead")}}},createNativeStaticHandler=(handle,hooks,setHeaders={})=>{if(typeof handle==="function"||handle instanceof Blob)return;if(typeof handle==="object"&&handle?.toString()==="[object HTMLBundle]")return()=>handle;let response=mapResponse(handle,{headers:setHeaders});if(!hooks.parse?.length&&!hooks.transform?.length&&!hooks.beforeHandle?.length&&!hooks.afterHandle?.length){if(!response.headers.has("content-type"))response.headers.append("content-type","text/plain;charset=utf-8");return response.clone.bind(response)}},websocket={open(ws){ws.data.open?.(ws)},message(ws,message){ws.data.message?.(ws,message)},drain(ws){ws.data.drain?.(ws)},close(ws,code,reason){ws.data.close?.(ws,code,reason)}};class ElysiaWS{raw;data;body;validator;["~types"];get id(){return this.data.id}constructor(raw,data,body=void 0){this.raw=raw,this.data=data,this.body=body,this.validator=raw.data?.validator,this.sendText=raw.sendText.bind(raw),this.sendBinary=raw.sendBinary.bind(raw),this.close=raw.close.bind(raw),this.terminate=raw.terminate.bind(raw),this.publishText=raw.publishText.bind(raw),this.publishBinary=raw.publishBinary.bind(raw),this.subscribe=raw.subscribe.bind(raw),this.unsubscribe=raw.unsubscribe.bind(raw),this.isSubscribed=raw.isSubscribed.bind(raw),this.cork=raw.cork.bind(raw),this.remoteAddress=raw.remoteAddress,this.binaryType=raw.binaryType,this.data=raw.data,this.send=this.send.bind(this),this.ping=this.ping.bind(this),this.pong=this.pong.bind(this),this.publish=this.publish.bind(this)}send(data,compress){if(Buffer.isBuffer(data))return this.raw.send(data,compress);if(this.validator?.Check(data)===!1)return this.raw.send(new ValidationError("message",this.validator,data).message);if(typeof data==="object")data=JSON.stringify(data);return this.raw.send(data,compress)}ping(data){if(Buffer.isBuffer(data))return this.raw.ping(data);if(this.validator?.Check(data)===!1)return this.raw.send(new ValidationError("message",this.validator,data).message);if(typeof data==="object")data=JSON.stringify(data);return this.raw.ping(data)}pong(data){if(Buffer.isBuffer(data))return this.raw.pong(data);if(this.validator?.Check(data)===!1)return this.raw.send(new ValidationError("message",this.validator,data).message);if(typeof data==="object")data=JSON.stringify(data);return this.raw.pong(data)}publish(topic,data,compress){if(Buffer.isBuffer(data))return this.raw.publish(topic,data,compress);if(this.validator?.Check(data)===!1)return this.raw.send(new ValidationError("message",this.validator,data).message);if(typeof data==="object")data=JSON.stringify(data);return this.raw.publish(topic,data,compress)}sendText;sendBinary;close;terminate;publishText;publishBinary;subscribe;unsubscribe;isSubscribed;cork;remoteAddress;binaryType;get readyState(){return this.raw.readyState}}var createWSMessageParser=(parse22)=>{let parsers=typeof parse22==="function"?[parse22]:parse22;return async function parseMessage(ws,message){if(typeof message==="string"){let start=message?.charCodeAt(0);if(start===34||start===47||start===91||start===123)try{message=JSON.parse(message)}catch{}else if(isNumericString(message))message=+message;else if(message==="true")message=!0;else if(message==="false")message=!1;else if(message==="null")message=null}if(parsers)for(let i=0;i<parsers.length;i++){let temp=parsers[i](ws,message);if(temp instanceof Promise)temp=await temp;if(temp!==void 0)return temp}return message}},createHandleWSResponse=(validateResponse)=>{let handleWSResponse=(ws,data)=>{if(data instanceof Promise)return data.then((data2)=>handleWSResponse(ws,data2));if(Buffer.isBuffer(data))return ws.send(data.toString());if(data===void 0)return;let send=(datum)=>{if(validateResponse?.Check(datum)===!1)return ws.send(new ValidationError("message",validateResponse,datum).message);if(typeof datum==="object")return ws.send(JSON.stringify(datum));ws.send(datum)};if(typeof data?.next!=="function")return void send(data);let init=data.next();if(init instanceof Promise)return(async()=>{let first=await init;if(validateResponse?.Check(first)===!1)return ws.send(new ValidationError("message",validateResponse,first).message);if(send(first.value),!first.done)for await(let datum of data)send(datum)})();if(send(init.value),!init.done)for(let datum of data)send(datum)};return handleWSResponse},BunAdapter={...WebStandardAdapter,name:"bun",handler:{...WebStandardAdapter.handler,createNativeStaticHandler},composeHandler:{...WebStandardAdapter.composeHandler,headers:hasHeaderShorthand?`c.headers = c.request.headers.toJSON()
`:`c.headers = {}
for (const [key, value] of c.request.headers.entries())c.headers[key] = value
`},listen(app){return(options,callback)=>{if(typeof Bun==="undefined")throw new Error(".listen() is designed to run on Bun only. If you are running Elysia in other environment please use a dedicated plugin or export the handler via Elysia.fetch");if(app.compile(),typeof options==="string"){if(!isNumericString(options))throw new Error("Port must be a numeric value");options=parseInt(options)}let fetch2=app.fetch,serve=typeof options==="object"?{development:!isProduction,reusePort:!0,...app.config.serve||{},...options||{},static:{...app.router.static.http.static,...app.config.serve?.static},websocket:{...app.config.websocket||{},...websocket||{}},fetch:fetch2,error:app.outerErrorHandler}:{development:!isProduction,reusePort:!0,...app.config.serve||{},static:app.router.static.http.static,websocket:{...app.config.websocket||{},...websocket||{}},port:options,fetch:fetch2,error:app.outerErrorHandler};if(app.server=Bun?.serve(serve),app.event.start)for(let i=0;i<app.event.start.length;i++)app.event.start[i].fn(app);if(callback)callback(app.server);process.on("beforeExit",()=>{if(app.server){if(app.server.stop?.(),app.server=null,app.event.stop)for(let i=0;i<app.event.stop.length;i++)app.event.stop[i].fn(app)}}),app.promisedModules.then(()=>{Bun?.gc(!1)})}},ws(app,path,options){let{parse:parse22,body,response,...rest}=options,validateMessage=getSchemaValidator(body,{modules:app.definitions.typebox,models:app.definitions.type,normalize:app.config.normalize}),validateResponse=getSchemaValidator(response,{modules:app.definitions.typebox,models:app.definitions.type,normalize:app.config.normalize});app.route("$INTERNALWS",path,async(context)=>{let server=app.getServer(),{set:set2,path:path2,qi,headers,query,params}=context;if(context.validator=validateResponse,options.upgrade){if(typeof options.upgrade==="function"){let temp=options.upgrade(context);if(temp instanceof Promise)await temp}else if(options.upgrade)Object.assign(set2.headers,options.upgrade)}if(set2.cookie&&isNotEmpty(set2.cookie)){let cookie=serializeCookie(set2.cookie);if(cookie)set2.headers["set-cookie"]=cookie}if(set2.headers["set-cookie"]&&Array.isArray(set2.headers["set-cookie"]))set2.headers=parseSetCookies(new Headers(set2.headers),set2.headers["set-cookie"]);let handleResponse=createHandleWSResponse(validateResponse),parseMessage=createWSMessageParser(parse22),_id,errorHandlers=[...Array.isArray(options.error)?options.error:[options.error],...(app.event.error??[]).map((x)=>typeof x==="function"?x:x.fn)],handleErrors=!errorHandlers.length?()=>{}:async(ws,error2)=>{for(let handleError of errorHandlers){let response2=handleError(Object.assign(context,{error:error2}));if(response2 instanceof Promise)response2=await response2;if(await handleResponse(ws,response2),response2)break}};if(server?.upgrade(context.request,{headers:isNotEmpty(set2.headers)?set2.headers:void 0,data:{...context,get id(){if(_id)return _id;return _id=randomId()},validator:validateResponse,ping(data){options.ping?.(data)},pong(data){options.pong?.(data)},open(ws){try{handleResponse(ws,options.open?.(new ElysiaWS(ws,context)))}catch(error2){handleErrors(ws,error2)}},message:async(ws,_message)=>{let message=await parseMessage(ws,_message);if(validateMessage?.Check(message)===!1)return void ws.send(new ValidationError("message",validateMessage,message).message);try{handleResponse(ws,options.message?.(new ElysiaWS(ws,context,message),message))}catch(error2){handleErrors(ws,error2)}},drain(ws){try{handleResponse(ws,options.drain?.(new ElysiaWS(ws,context)))}catch(error2){handleErrors(ws,error2)}},close(ws,code,reason){try{handleResponse(ws,options.close?.(new ElysiaWS(ws,context),code,reason))}catch(error2){handleErrors(ws,error2)}}}}))return;return set2.status=400,"Expected a websocket connection"},{...rest,websocket:options})}},isBun2=typeof Bun!=="undefined",env2=isBun2?Bun.env:typeof process!=="undefined"&&process?.env?process.env:{},plusRegex=/\+/g;function parseQueryFromURL(input){let result={};if(typeof input!=="string")return result;let key="",value="",startingIndex=-1,equalityIndex=-1,flags=0,l=input.length;for(let i=0;i<l;i++)switch(input.charCodeAt(i)){case 38:let hasBothKeyValuePair=equalityIndex>startingIndex;if(!hasBothKeyValuePair)equalityIndex=i;if(key=input.slice(startingIndex+1,equalityIndex),hasBothKeyValuePair||key.length>0){if(flags&1)key=key.replace(plusRegex," ");if(flags&2)key=decode2(key)||key;if(!result[key]){if(hasBothKeyValuePair){if(value=input.slice(equalityIndex+1,i),flags&4)value=value.replace(plusRegex," ");if(flags&8)value=decode2(value)||value}result[key]=value}}key="",value="",startingIndex=i,equalityIndex=i,flags=0;break;case 61:if(equalityIndex<=startingIndex)equalityIndex=i;else flags|=8;break;case 43:if(equalityIndex>startingIndex)flags|=4;else flags|=1;break;case 37:if(equalityIndex>startingIndex)flags|=8;else flags|=2;break}if(startingIndex<l){let hasBothKeyValuePair=equalityIndex>startingIndex;if(key=input.slice(startingIndex+1,hasBothKeyValuePair?equalityIndex:l),hasBothKeyValuePair||key.length>0){if(flags&1)key=key.replace(plusRegex," ");if(flags&2)key=decode2(key)||key;if(!result[key]){if(hasBothKeyValuePair){if(value=input.slice(equalityIndex+1,l),flags&4)value=value.replace(plusRegex," ");if(flags&8)value=decode2(value)||value}result[key]=value}}}return result}var parseQuery=(input)=>{let result={};if(typeof input!=="string")return result;let inputLength=input.length,key="",value="",startingIndex=-1,equalityIndex=-1,shouldDecodeKey=!1,shouldDecodeValue=!1,keyHasPlus=!1,valueHasPlus=!1,hasBothKeyValuePair=!1,c=0;for(let i=0;i<inputLength+1;i++){if(i!==inputLength)c=input.charCodeAt(i);else c=38;switch(c){case 38:{if(hasBothKeyValuePair=equalityIndex>startingIndex,!hasBothKeyValuePair)equalityIndex=i;if(key=input.slice(startingIndex+1,equalityIndex),hasBothKeyValuePair||key.length>0){if(keyHasPlus)key=key.replace(plusRegex," ");if(shouldDecodeKey)key=decode2(key)||key;if(hasBothKeyValuePair){if(value=input.slice(equalityIndex+1,i),valueHasPlus)value=value.replace(plusRegex," ");if(shouldDecodeValue)value=decode2(value)||value}let currentValue=result[key];if(currentValue===void 0)result[key]=value;else if(currentValue.pop)currentValue.push(value);else result[key]=[currentValue,value]}value="",startingIndex=i,equalityIndex=i,shouldDecodeKey=!1,shouldDecodeValue=!1,keyHasPlus=!1,valueHasPlus=!1;break}case 61:if(equalityIndex<=startingIndex)equalityIndex=i;else shouldDecodeValue=!0;break;case 43:if(equalityIndex>startingIndex)valueHasPlus=!0;else keyHasPlus=!0;break;case 37:if(equalityIndex>startingIndex)shouldDecodeValue=!0;else shouldDecodeKey=!0;break}}return result},ELYSIA_TRACE=Symbol("ElysiaTrace"),createProcess=()=>{let{promise,resolve}=Promise.withResolvers(),{promise:end,resolve:resolveEnd}=Promise.withResolvers(),{promise:error2,resolve:resolveError}=Promise.withResolvers(),callbacks=[],callbacksEnd=[];return[(callback)=>{if(callback)callbacks.push(callback);return promise},(process2)=>{let processes=[],resolvers=[],groupError=null;for(let i=0;i<(process2.total??0);i++){let{promise:promise2,resolve:resolve2}=Promise.withResolvers(),{promise:end2,resolve:resolveEnd2}=Promise.withResolvers(),{promise:error3,resolve:resolveError2}=Promise.withResolvers(),callbacks2=[],callbacksEnd2=[];processes.push((callback)=>{if(callback)callbacks2.push(callback);return promise2}),resolvers.push((process3)=>{let result2={...process3,end:end2,error:error3,index:i,onStop(callback){if(callback)callbacksEnd2.push(callback);return end2}};resolve2(result2);for(let i2=0;i2<callbacks2.length;i2++)callbacks2[i2](result2);return(error4=null)=>{let end3=performance.now();if(error4)groupError=error4;let detail={end:end3,error:error4,get elapsed(){return end3-process3.begin}};for(let i2=0;i2<callbacksEnd2.length;i2++)callbacksEnd2[i2](detail);resolveEnd2(end3),resolveError2(error4)}})}let result={...process2,end,error:error2,onEvent(callback){for(let i=0;i<processes.length;i++)processes[i](callback)},onStop(callback){if(callback)callbacksEnd.push(callback);return end}};resolve(result);for(let i=0;i<callbacks.length;i++)callbacks[i](result);return{resolveChild:resolvers,resolve(error3=null){let end2=performance.now();if(!error3&&groupError)error3=groupError;let detail={end:end2,error:error3,get elapsed(){return end2-process2.begin}};for(let i=0;i<callbacksEnd.length;i++)callbacksEnd[i](detail);resolveEnd(end2),resolveError(error3)}}}]},createTracer=(traceListener)=>{return(context)=>{let[onRequest,resolveRequest]=createProcess(),[onParse,resolveParse]=createProcess(),[onTransform,resolveTransform]=createProcess(),[onBeforeHandle,resolveBeforeHandle]=createProcess(),[onHandle,resolveHandle]=createProcess(),[onAfterHandle,resolveAfterHandle]=createProcess(),[onError,resolveError]=createProcess(),[onMapResponse,resolveMapResponse]=createProcess(),[onAfterResponse,resolveAfterResponse]=createProcess();return traceListener({id:context[ELYSIA_REQUEST_ID],context,set:context.set,onRequest,onParse,onTransform,onBeforeHandle,onHandle,onAfterHandle,onMapResponse,onAfterResponse,onError}),{request:resolveRequest,parse:resolveParse,transform:resolveTransform,beforeHandle:resolveBeforeHandle,handle:resolveHandle,afterHandle:resolveAfterHandle,error:resolveError,mapResponse:resolveMapResponse,afterResponse:resolveAfterResponse}}},TypeBoxSymbol={optional:Symbol.for("TypeBox.Optional"),kind:Symbol.for("TypeBox.Kind")},isOptional=(validator)=>{if(!validator)return!1;let schema=validator?.schema;if(schema?.[TypeBoxSymbol.kind]==="Import")return validator.References().some(isOptional);return!!schema&&TypeBoxSymbol.optional in schema},allocateIf=(value,condition)=>condition?value:"",defaultParsers=["json","text","urlencoded","arrayBuffer","formdata","application/json","text/plain","application/x-www-form-urlencoded","application/octet-stream","multipart/form-data"],hasAdditionalProperties=(_schema)=>{if(!_schema)return!1;let schema=_schema?.schema??_schema;if(schema[TypeBoxSymbol.kind]==="Import"&&_schema.References())return _schema.References().some(hasAdditionalProperties);if(schema.anyOf)return schema.anyOf.some(hasAdditionalProperties);if(schema.someOf)return schema.someOf.some(hasAdditionalProperties);if(schema.allOf)return schema.allOf.some(hasAdditionalProperties);if(schema.not)return schema.not.some(hasAdditionalProperties);if(schema.type==="object"){let properties=schema.properties;if("additionalProperties"in schema)return schema.additionalProperties;if("patternProperties"in schema)return!1;for(let key of Object.keys(properties)){let property=properties[key];if(property.type==="object"){if(hasAdditionalProperties(property))return!0}else if(property.anyOf){for(let i=0;i<property.anyOf.length;i++)if(hasAdditionalProperties(property.anyOf[i]))return!0}return property.additionalProperties}return!1}return!1},createReport=({context="c",trace=[],addFn})=>{if(!trace.length)return()=>{return{resolveChild(){return()=>{}},resolve(){}}};for(let i=0;i<trace.length;i++)addFn(`let report${i}, reportChild${i}, reportErr${i}, reportErrChild${i};let trace${i} = ${context}[ELYSIA_TRACE]?.[${i}] ?? trace[${i}](${context});
`);return(event,{name,total=0}={})=>{if(!name)name="anonymous";let reporter=event==="error"?"reportErr":"report";for(let i=0;i<trace.length;i++)addFn(`${reporter}${i} = trace${i}.${event}({id,event:'${event}',name:'${name}',begin:performance.now(),total:${total}})
`);return{resolve(){for(let i=0;i<trace.length;i++)addFn(`${reporter}${i}.resolve()
`)},resolveChild(name2){for(let i=0;i<trace.length;i++)addFn(`${reporter}Child${i}=${reporter}${i}.resolveChild?.shift()?.({id,event:'${event}',name:'${name2}',begin:performance.now()})
`);return(binding)=>{for(let i=0;i<trace.length;i++)if(binding)addFn(`if(${binding} instanceof Error){${reporter}Child${i}?.(${binding}) }else{${reporter}Child${i}?.()}`);else addFn(`${reporter}Child${i}?.()
`)}}}}},composeValidationFactory=({injectResponse="",normalize=!1,validator,encodeSchema=!1})=>({composeValidation:(type2,value=`c.${type2}`)=>`c.set.status=422;throw new ValidationError('${type2}',validator.${type2},${value})`,composeResponseValidation:(name="r")=>{let code=injectResponse+`
`;code+=`if(${name} instanceof ElysiaCustomStatusResponse){c.set.status=${name}.code
${name}=${name}.response}const isResponse=${name} instanceof Response
switch(c.set.status){`;for(let[status,value]of Object.entries(validator.response)){if(code+=`
case ${status}:if(!isResponse){`,normalize&&"Clean"in value&&!hasAdditionalProperties(value))code+=`${name}=validator.response['${status}'].Clean(${name})
`;if(encodeSchema&&(value.hasTransform||typeof value.Decode==="function"))code+=`${name}=validator.response['${status}'].Encode(${name})
`;code+=`if(validator.response['${status}'].Check(${name})===false){c.set.status=422
throw new ValidationError('response',validator.response['${status}'],${name})}c.set.status = ${status}}
`,code+=`break
`}return code+"}"}}),KindSymbol=Symbol.for("TypeBox.Kind"),hasProperty=(expectedProperty,_schema)=>{if(!_schema)return;let schema=_schema.schema??_schema;if(schema[TypeBoxSymbol.kind]==="Import")return _schema.References().some((schema2)=>hasProperty(expectedProperty,schema2));if(schema.type==="object"){let properties=schema.properties;if(!properties)return!1;for(let key of Object.keys(properties)){let property=properties[key];if(expectedProperty in property)return!0;if(property.type==="object"){if(hasProperty(expectedProperty,property))return!0}else if(property.anyOf){for(let i=0;i<property.anyOf.length;i++)if(hasProperty(expectedProperty,property.anyOf[i]))return!0}}return!1}return expectedProperty in schema},TransformSymbol=Symbol.for("TypeBox.Transform"),hasTransform=(schema)=>{if(!schema)return!1;if(schema.$ref&&schema.$defs&&schema.$ref in schema.$defs&&hasTransform(schema.$defs[schema.$ref]))return!0;if(schema.oneOf){for(let i=0;i<schema.oneOf.length;i++)if(hasTransform(schema.oneOf[i]))return!0}if(schema.anyOf){for(let i=0;i<schema.anyOf.length;i++)if(hasTransform(schema.anyOf[i]))return!0}if(schema.allOf){for(let i=0;i<schema.allOf.length;i++)if(hasTransform(schema.allOf[i]))return!0}if(schema.not&&hasTransform(schema.not))return!0;if(schema.type==="object"&&schema.properties){let properties=schema.properties;for(let key of Object.keys(properties)){let property=properties[key];if(hasTransform(property))return!0;if(property.type==="array"&&property.items&&hasTransform(property.items))return!0}}if(schema.type==="array"&&schema.items&&hasTransform(schema.items))return!0;return TransformSymbol in schema},matchFnReturn=/(?:return|=>) \S+\(/g,isAsyncName=(v)=>{return(v?.fn??v).constructor.name==="AsyncFunction"},isAsync=(v)=>{let fn=v?.fn??v;if(fn.constructor.name==="AsyncFunction")return!0;let literal=fn.toString();if(literal.includes("=> response.clone("))return!1;if(literal.includes("await"))return!0;if(literal.includes("async"))return!0;if(literal.includes("=>response.clone("))return!1;return!!literal.match(matchFnReturn)},isGenerator=(v)=>{let fn=v?.fn??v;return fn.constructor.name==="AsyncGeneratorFunction"||fn.constructor.name==="GeneratorFunction"},composeHandler=({app,path,method,hooks,validator,handler,allowMeta=!1,inference,asManifest=!1})=>{let adapter=app["~adapter"].composeHandler,adapterHandler=app["~adapter"].handler,isHandleFn=typeof handler==="function";if(!isHandleFn){if(handler=adapterHandler.mapResponse(handler,{headers:app.setHeaders??{}}),hooks.parse?.length&&hooks.transform?.length&&hooks.beforeHandle?.length&&hooks.afterHandle?.length){if(handler instanceof Response)return Function("a","return function(){return a.clone()}")(handler);return Function("a","return function(){return a}")(handler)}}let handle=isHandleFn?"handler(c)":"handler",hasAfterResponse=!!hooks.afterResponse?.length,hasTrace=!!hooks.trace?.length,fnLiteral="";if(inference=sucrose(Object.assign({},hooks,{handler}),inference),adapter.declare){let literal=adapter.declare(inference);if(literal)fnLiteral+=literal}if(inference.server)fnLiteral+=`Object.defineProperty(c,'server',{get:function(){return getServer()}})
`;validator.createBody?.(),validator.createQuery?.(),validator.createHeaders?.(),validator.createParams?.(),validator.createCookie?.(),validator.createResponse?.();let hasValidation=validator.body||validator.headers||validator.params||validator.query||validator.cookie||validator.response,hasQuery=inference.query||!!validator.query,requestNoBody=hooks.parse?.length===1&&hooks.parse[0].fn==="none",hasBody=method!=="$INTERNALWS"&&method!=="GET"&&method!=="HEAD"&&(inference.body||!!validator.body||!!hooks.parse?.length)&&!requestNoBody;if(hasBody)fnLiteral+=`let isParsing=false
`;let defaultHeaders=app.setHeaders,hasDefaultHeaders=defaultHeaders&&!!Object.keys(defaultHeaders).length,hasHeaders=inference.headers||validator.headers||adapter.preferWebstandardHeaders!==!0&&inference.body,hasCookie=inference.cookie||!!validator.cookie,cookieValidator=hasCookie?getCookieValidator({modules:app.definitions.typebox,validator:validator.cookie,defaultConfig:app.config.cookie,dynamic:!!app.config.aot,config:validator.cookie?.config??{},models:app.definitions.type}):void 0,cookieMeta=cookieValidator?.config,encodeCookie="";if(cookieMeta?.sign){if(!cookieMeta.secrets)throw new Error(`t.Cookie required secret which is not set in (${method}) ${path}.`);let secret=!cookieMeta.secrets?void 0:typeof cookieMeta.secrets==="string"?cookieMeta.secrets:cookieMeta.secrets[0];if(encodeCookie+=`const _setCookie = c.set.cookie
if(_setCookie){`,cookieMeta.sign===!0)encodeCookie+=`for(const [key, cookie] of Object.entries(_setCookie)){c.set.cookie[key].value=await signCookie(cookie.value,'${secret}')}`;else for(let name of cookieMeta.sign)encodeCookie+=`if(_setCookie['${name}']?.value){c.set.cookie['${name}'].value=await signCookie(_setCookie['${name}'].value,'${secret}')}`;encodeCookie+=`}
`}let normalize=app.config.normalize,encodeSchema=app.config.experimental?.encodeSchema,{composeValidation,composeResponseValidation}=composeValidationFactory({normalize,validator,encodeSchema});if(hasHeaders)fnLiteral+=adapter.headers;if(hasTrace)fnLiteral+=`const id=c[ELYSIA_REQUEST_ID]
`;let report=createReport({trace:hooks.trace,addFn:(word)=>{fnLiteral+=word}});if(fnLiteral+="try{",hasCookie){let get=(name,defaultValue)=>{let value=cookieMeta?.[name]??defaultValue;if(!value)return typeof defaultValue==="string"?`${name}:"${defaultValue}",`:`${name}:${defaultValue},`;if(typeof value==="string")return`${name}:'${value}',`;if(value instanceof Date)return`${name}: new Date(${value.getTime()}),`;return`${name}:${value},`},options=cookieMeta?`{secrets:${cookieMeta.secrets!==void 0?typeof cookieMeta.secrets==="string"?`'${cookieMeta.secrets}'`:"["+cookieMeta.secrets.reduce((a,b)=>a+`'${b}',`,"")+"]":"undefined"},sign:${cookieMeta.sign===!0?!0:cookieMeta.sign!==void 0?"["+cookieMeta.sign.reduce((a,b)=>a+`'${b}',`,"")+"]":"undefined"},`+get("domain")+get("expires")+get("httpOnly")+get("maxAge")+get("path","/")+get("priority")+get("sameSite")+get("secure")+"}":"undefined";if(hasHeaders)fnLiteral+=`
c.cookie=await parseCookie(c.set,c.headers.cookie,${options})
`;else fnLiteral+=`
c.cookie=await parseCookie(c.set,c.request.headers.get('cookie'),${options})
`}if(hasQuery){let destructured=[];if(validator.query&&validator.query.schema.type==="object"){let properties=validator.query.schema.properties;if(!hasAdditionalProperties(validator.query))for(let[key,_value]of Object.entries(properties)){let value=_value,isArray=value.type==="array"||!!value.anyOf?.some((v)=>v.type==="string"&&v.format==="ArrayString");if(value&&TypeBoxSymbol.optional in value&&value.type==="array"&&value.items)value=value.items;let{type:type2,anyOf}=value;destructured.push({key,isArray,isNestedObjectArray:isArray&&value.items?.type==="object"||!!value.items?.anyOf?.some((x)=>x.type==="object"||x.type==="array"),isObject:type2==="object"||anyOf?.some((v)=>v.type==="string"&&v.format==="ArrayString"),anyOf:!!anyOf})}}if(!destructured.length)fnLiteral+="if(c.qi===-1){c.query={}}else{c.query=parseQueryFromURL(c.url.slice(c.qi + 1))}";else{fnLiteral+=`if(c.qi!==-1){let url='&'+c.url.slice(c.qi + 1)
`;let index=0;for(let{key,isArray,isObject:isObject2,isNestedObjectArray,anyOf}of destructured){let init2=(index===0?"let ":"")+`memory=url.indexOf('&${key}=')
let a${index}
`;if(isArray)if(fnLiteral+=init2,isNestedObjectArray)fnLiteral+=`while(memory!==-1){const start=memory+${key.length+2}
memory=url.indexOf('&',start)
if(a${index}===undefined)
a${index}=''
else
a${index}+=','
let temp
if(memory===-1)temp=decodeURIComponent(url.slice(start).replace(/\\+/g,' '))
else temp=decodeURIComponent(url.slice(start, memory).replace(/\\+/g,' '))
const charCode=temp.charCodeAt(0)
if(charCode!==91&&charCode !== 123)
temp='"'+temp+'"'
a${index}+=temp
if(memory===-1)break
memory=url.indexOf('&${key}=',memory)
if(memory===-1)break}try{if(a${index}.charCodeAt(0)===91)a${index} = JSON.parse(a${index})
else
a${index}=JSON.parse('['+a${index}+']')}catch{}
`;else fnLiteral+=`while(memory!==-1){const start=memory+${key.length+2}
memory=url.indexOf('&',start)
if(a${index}===undefined)a${index}=[]
if(memory===-1){const temp=decodeURIComponent(url.slice(start)).replace(/\\+/g,' ')
if(temp.includes(',')){a${index}=a${index}.concat(temp.split(','))}else{a${index}.push(decodeURIComponent(url.slice(start)).replace(/\\+/g,' '))}
break}else{const temp=decodeURIComponent(url.slice(start, memory)).replace(/\\+/g,' ')
if(temp.includes(',')){a${index}=a${index}.concat(temp.split(','))}else{a${index}.push(temp)}
}memory=url.indexOf('&${key}=',memory)
if(memory===-1) break
}`;else if(isObject2)fnLiteral+=init2+`if(memory!==-1){const start=memory+${key.length+2}
memory=url.indexOf('&',start)
if(memory===-1)a${index}=decodeURIComponent(url.slice(start).replace(/\\+/g,' '))else a${index}=decodeURIComponent(url.slice(start,memory).replace(/\\+/g,' '))if(a${index}!==undefined)try{a${index}=JSON.parse(a${index})}catch{}}`;else{if(fnLiteral+=init2+`if(memory!==-1){const start=memory+${key.length+2}
memory=url.indexOf('&',start)
if(memory===-1)a${index}=decodeURIComponent(url.slice(start).replace(/\\+/g,' '))
else{a${index}=decodeURIComponent(url.slice(start,memory).replace(/\\+/g,' '))`,anyOf)fnLiteral+=`
let deepMemory=url.indexOf('&${key}=',memory)
if(deepMemory!==-1){a${index}=[a${index}]
let first=true
while(true){const start=deepMemory+${key.length+2}
if(first)first=false
else deepMemory = url.indexOf('&', start)
let value
if(deepMemory===-1)value=url.slice(start).replace(/\\+/g,' ')
else value=url.slice(start, deepMemory).replace(/\\+/g,' ')
value=decodeURIComponent(value)
if(value===null){if(deepMemory===-1){break}else{continue}}
const vStart=value.charCodeAt(0)
const vEnd=value.charCodeAt(value.length - 1)
if((vStart===91&&vEnd===93)||(vStart===123&&vEnd===125))
try{a${index}.push(JSON.parse(value))}catch{a${index}.push(value)}if(deepMemory===-1)break}}`;fnLiteral+="}}"}index++,fnLiteral+=`
`}fnLiteral+="c.query={"+destructured.map(({key},index2)=>`'${key}':a${index2}`).join(",")+"}",fnLiteral+=`} else c.query = {}
`}}let isAsyncHandler=typeof handler==="function"&&isAsync(handler),saveResponse=hasTrace||hooks.afterResponse?.length?"c.response= ":"",maybeAsync=hasCookie||hasBody||isAsyncHandler||!!hooks.parse?.length||!!hooks.afterHandle?.some(isAsync)||!!hooks.beforeHandle?.some(isAsync)||!!hooks.transform?.some(isAsync)||!!hooks.mapResponse?.some(isAsync),maybeStream=(typeof handler==="function"?isGenerator(handler):!1)||!!hooks.beforeHandle?.some(isGenerator)||!!hooks.afterHandle?.some(isGenerator)||!!hooks.transform?.some(isGenerator),hasSet=inference.cookie||inference.set||hasHeaders||hasTrace||validator.response||isHandleFn&&hasDefaultHeaders||maybeStream,mapResponseContext=adapter.mapResponseContext?`,${adapter.mapResponseContext}`:"";if(hasTrace||inference.route)fnLiteral+=`c.route=\`${path}\`
`;let parseReporter=report("parse",{total:hooks.parse?.length});if(hasBody){let isOptionalBody=isOptional(validator.body),hasBodyInference=!!hooks.parse?.length||inference.body||validator.body;if(adapter.parser.declare)fnLiteral+=adapter.parser.declare;fnLiteral+=`
isParsing=true
`;let parser=typeof hooks.parse==="string"?hooks.parse:Array.isArray(hooks.parse)&&hooks.parse.length===1?typeof hooks.parse[0]==="string"?hooks.parse[0]:typeof hooks.parse[0].fn==="string"?hooks.parse[0].fn:void 0:void 0;if(parser&&defaultParsers.includes(parser)){let reporter=report("parse",{total:hooks.parse?.length});switch(parser){case"json":case"application/json":fnLiteral+=adapter.parser.json(isOptionalBody);break;case"text":case"text/plain":fnLiteral+=adapter.parser.text(isOptionalBody);break;case"urlencoded":case"application/x-www-form-urlencoded":fnLiteral+=adapter.parser.urlencoded(isOptionalBody);break;case"arrayBuffer":case"application/octet-stream":fnLiteral+=adapter.parser.arrayBuffer(isOptionalBody);break;case"formdata":case"multipart/form-data":fnLiteral+=adapter.parser.formData(isOptionalBody);break;default:if(parser[0]in app["~parser"])fnLiteral+=hasHeaders?"let contentType = c.headers['content-type']":"let contentType = c.request.headers.get('content-type')",fnLiteral+=`
if(contentType){const index=contentType.indexOf(';')
if(index!==-1)contentType=contentType.substring(0, index)}
else{contentType=''}c.contentType=contentType
`,fnLiteral+=`let result=parser['${parser}'](c, contentType)
if(result instanceof Promise)result=await result
if(result instanceof ElysiaCustomStatusResponse)throw result
if(result!==undefined)c.body=result
delete c.contentType
`;break}reporter.resolve()}else if(hasBodyInference){if(fnLiteral+=`
`,fnLiteral+=hasHeaders?"let contentType = c.headers['content-type']":"let contentType = c.request.headers.get('content-type')",fnLiteral+=`
if(contentType){const index=contentType.indexOf(';')
if(index!==-1)contentType=contentType.substring(0, index)}
else{contentType=''}c.contentType=contentType
`,hooks.parse?.length)fnLiteral+=`let used=false
`;let reporter=report("parse",{total:hooks.parse?.length}),hasDefaultParser=!1;if(hooks.parse)for(let i=0;i<hooks.parse.length;i++){let name=`bo${i}`;if(i!==0)fnLiteral+=`
if(!used){`;if(typeof hooks.parse[i].fn==="string"){let endUnit=reporter.resolveChild(hooks.parse[i].fn);switch(hooks.parse[i].fn){case"json":case"application/json":hasDefaultParser=!0,fnLiteral+=adapter.parser.json(isOptionalBody);break;case"text":case"text/plain":hasDefaultParser=!0,fnLiteral+=adapter.parser.text(isOptionalBody);break;case"urlencoded":case"application/x-www-form-urlencoded":hasDefaultParser=!0,fnLiteral+=adapter.parser.urlencoded(isOptionalBody);break;case"arrayBuffer":case"application/octet-stream":hasDefaultParser=!0,fnLiteral+=adapter.parser.arrayBuffer(isOptionalBody);break;case"formdata":case"multipart/form-data":hasDefaultParser=!0,fnLiteral+=adapter.parser.formData(isOptionalBody);break;default:fnLiteral+=`${name}=parser['${hooks.parse[i].fn}'](c,contentType)
if(${name} instanceof Promise)${name}=await ${name}
if(${name}!==undefined){c.body=${name};used=true}
`}endUnit()}else{let endUnit=reporter.resolveChild(hooks.parse[i].fn.name);fnLiteral+=`let ${name}=e.parse[${i}]
${name}=${name}(c,contentType)
if(${name} instanceof Promise)${name}=await ${name}
if(${name}!==undefined){c.body=${name};used=true}`,endUnit()}if(i!==0)fnLiteral+="}";if(hasDefaultParser)break}if(reporter.resolve(),!hasDefaultParser){if(hooks.parse?.length)fnLiteral+=`
if(!used){
if(!contentType) throw new ParseError()
`;fnLiteral+="switch(contentType){",fnLiteral+=`case 'application/json':
`+adapter.parser.json(isOptionalBody)+`break
case 'text/plain':`+adapter.parser.text(isOptionalBody)+`break
case 'application/x-www-form-urlencoded':`+adapter.parser.urlencoded(isOptionalBody)+`break
case 'application/octet-stream':`+adapter.parser.arrayBuffer(isOptionalBody)+`break
case 'multipart/form-data':`+adapter.parser.formData(isOptionalBody)+`break
`;for(let key of Object.keys(app["~parser"]))fnLiteral+=`case '${key}':let bo${key}=parser['${key}'](c,contentType)
if(bo${key} instanceof Promise)bo${key}=await bo${key}
if(bo${key} instanceof ElysiaCustomStatusResponse)throw result
if(bo${key}!==undefined)c.body=bo${key}
break
`;if(hooks.parse?.length)fnLiteral+="}";fnLiteral+="}"}}fnLiteral+=`
delete c.contentType`,fnLiteral+=`
isParsing=false
`}if(parseReporter.resolve(),hooks?.transform){let reporter=report("transform",{total:hooks.transform.length});if(hooks.transform.length)fnLiteral+=`let transformed
`;for(let i=0;i<hooks.transform.length;i++){let transform2=hooks.transform[i],endUnit=reporter.resolveChild(transform2.fn.name);if(fnLiteral+=isAsync(transform2)?`transformed=await e.transform[${i}](c)
`:`transformed=e.transform[${i}](c)
`,transform2.subType==="mapDerive")fnLiteral+=`if(transformed instanceof ElysiaCustomStatusResponse)throw transformed
else{transformed.request=c.request
transformed.store=c.store
transformed.qi=c.qi
transformed.path=c.path
transformed.url=c.url
transformed.redirect=c.redirect
transformed.set=c.set
transformed.error=c.error
c=transformed}`;else fnLiteral+=`if(transformed instanceof ElysiaCustomStatusResponse)throw transformed
else Object.assign(c,transformed)
`;endUnit()}reporter.resolve()}if(validator){if(validator.headers){if(normalize&&"Clean"in validator.headers&&!hasAdditionalProperties(validator.headers))fnLiteral+=`c.headers=validator.headers.Clean(c.headers);
`;if(hasProperty("default",validator.headers))for(let[key,value]of Object.entries(exports_value2.Default(validator.headers.schema,{}))){let parsed=typeof value==="object"?JSON.stringify(value):typeof value==="string"?`'${value}'`:value;if(parsed!==void 0)fnLiteral+=`c.headers['${key}']??=${parsed}
`}if(isOptional(validator.headers))fnLiteral+="if(isNotEmpty(c.headers)){";if(fnLiteral+="if(validator.headers.Check(c.headers) === false){"+composeValidation("headers")+"}",hasTransform(validator.headers.schema))fnLiteral+=`c.headers=validator.headers.Decode(c.headers)
`;if(isOptional(validator.headers))fnLiteral+="}"}if(validator.params){if(hasProperty("default",validator.params))for(let[key,value]of Object.entries(exports_value2.Default(validator.params.schema,{}))){let parsed=typeof value==="object"?JSON.stringify(value):typeof value==="string"?`'${value}'`:value;if(parsed!==void 0)fnLiteral+=`c.params['${key}']??=${parsed}
`}if(fnLiteral+="if(validator.params.Check(c.params)===false){"+composeValidation("params")+"}",hasTransform(validator.params.schema))fnLiteral+=`c.params=validator.params.Decode(c.params)
`}if(validator.query){if(normalize&&"Clean"in validator.query&&!hasAdditionalProperties(validator.query))fnLiteral+=`c.query=validator.query.Clean(c.query)
`;if(hasProperty("default",validator.query))for(let[key,value]of Object.entries(exports_value2.Default(validator.query.schema,{}))){let parsed=typeof value==="object"?JSON.stringify(value):typeof value==="string"?`'${value}'`:value;if(parsed!==void 0)fnLiteral+=`if(c.query['${key}']===undefined)c.query['${key}']=${parsed}
`}if(isOptional(validator.query))fnLiteral+="if(isNotEmpty(c.query)){";if(fnLiteral+="if(validator.query.Check(c.query)===false){"+composeValidation("query")+"}",hasTransform(validator.query.schema))fnLiteral+=`c.query=validator.query.Decode(Object.assign({},c.query))
`;if(isOptional(validator.query))fnLiteral+="}"}if(validator.body){if(normalize&&"Clean"in validator.body&&!hasAdditionalProperties(validator.body))fnLiteral+=`c.body=validator.body.Clean(c.body)
`;let doesHaveTransform=hasTransform(validator.body.schema);if(doesHaveTransform||isOptional(validator.body))fnLiteral+=`const isNotEmptyObject=c.body&&(typeof c.body==="object"&&isNotEmpty(c.body))
`;if(hasProperty("default",validator.body)){let schema=validator.body.schema,value=exports_value2.Default(schema,schema.type==="object"||schema[TypeBoxSymbol.kind]==="Import"&&schema.$defs[schema.$ref][TypeBoxSymbol.kind]==="Object"?{}:void 0),parsed=typeof value==="object"?JSON.stringify(value):typeof value==="string"?`'${value}'`:value;if(fnLiteral+="if(validator.body.Check(c.body)===false){",value!==void 0&&value!==null)fnLiteral+=`if(typeof c.body==='object')c.body=Object.assign(${parsed},c.body)
else c.body=${parsed}
`;if(isOptional(validator.body))fnLiteral+="if(isNotEmptyObject&&validator.body.Check(c.body)===false){"+composeValidation("body")+"}";else fnLiteral+="if(validator.body.Check(c.body)===false){"+composeValidation("body")+"}";fnLiteral+="}"}else if(isOptional(validator.body))fnLiteral+="if(isNotEmptyObject&&validator.body.Check(c.body)===false){"+composeValidation("body")+"}";else fnLiteral+="if(validator.body.Check(c.body)===false){"+composeValidation("body")+"}";if(doesHaveTransform)fnLiteral+=`if(isNotEmptyObject)c.body=validator.body.Decode(c.body)
`}if(cookieValidator&&isNotEmpty(cookieValidator?.schema?.properties??cookieValidator?.schema?.schema??{})){if(fnLiteral+=`const cookieValue={}
for(const [key,value] of Object.entries(c.cookie))cookieValue[key]=value.value
`,hasProperty("default",cookieValidator))for(let[key,value]of Object.entries(exports_value2.Default(cookieValidator.schema,{})))fnLiteral+=`cookieValue['${key}'] = ${typeof value==="object"?JSON.stringify(value):value}
`;if(isOptional(validator.cookie))fnLiteral+="if(isNotEmpty(c.cookie)){";if(fnLiteral+="if(validator.cookie.Check(cookieValue)===false){"+composeValidation("cookie","cookieValue")+"}",hasTransform(validator.cookie.schema))fnLiteral+=`for(const [key,value] of Object.entries(validator.cookie.Decode(cookieValue)))c.cookie[key].value=value
`;if(isOptional(validator.cookie))fnLiteral+="}"}}if(hooks?.beforeHandle){let reporter=report("beforeHandle",{total:hooks.beforeHandle.length}),hasResolve=!1;for(let i=0;i<hooks.beforeHandle.length;i++){let beforeHandle=hooks.beforeHandle[i],endUnit=reporter.resolveChild(beforeHandle.fn.name),returning=hasReturn(beforeHandle);if(beforeHandle.subType==="resolve"||beforeHandle.subType==="mapResolve"){if(!hasResolve)hasResolve=!0,fnLiteral+=`
let resolved
`;if(fnLiteral+=isAsync(beforeHandle)?`resolved=await e.beforeHandle[${i}](c);
`:`resolved=e.beforeHandle[${i}](c);
`,beforeHandle.subType==="mapResolve")fnLiteral+=`if(resolved instanceof ElysiaCustomStatusResponse)throw resolved
else{resolved.request = c.request
resolved.store = c.store
resolved.qi = c.qi
resolved.path = c.path
resolved.url = c.url
resolved.redirect = c.redirect
resolved.set = c.set
resolved.error = c.error
c = resolved}`;else fnLiteral+=`if(resolved instanceof ElysiaCustomStatusResponse)throw resolved
else Object.assign(c, resolved)
`}else if(!returning)fnLiteral+=isAsync(beforeHandle)?`await e.beforeHandle[${i}](c)
`:`e.beforeHandle[${i}](c)
`,endUnit();else{if(fnLiteral+=isAsync(beforeHandle)?`be=await e.beforeHandle[${i}](c)
`:`be=e.beforeHandle[${i}](c)
`,endUnit("be"),fnLiteral+="if(be!==undefined){",reporter.resolve(),hooks.afterHandle?.length){report("handle",{name:isHandleFn?handler.name:void 0}).resolve();let reporter2=report("afterHandle",{total:hooks.afterHandle.length});for(let i2=0;i2<hooks.afterHandle.length;i2++){let hook=hooks.afterHandle[i2],returning2=hasReturn(hook),endUnit2=reporter2.resolveChild(hook.fn.name);if(fnLiteral+=`c.response = be
`,!returning2)fnLiteral+=isAsync(hook.fn)?`await e.afterHandle[${i2}](c, be)
`:`e.afterHandle[${i2}](c, be)
`;else fnLiteral+=isAsync(hook.fn)?`af = await e.afterHandle[${i2}](c)
`:`af = e.afterHandle[${i2}](c)
`,fnLiteral+=`if(af!==undefined) c.response=be=af
`;endUnit2("af")}reporter2.resolve()}if(validator.response)fnLiteral+=composeResponseValidation("be");let mapResponseReporter=report("mapResponse",{total:hooks.mapResponse?.length});if(hooks.mapResponse?.length){fnLiteral+=`c.response=be
`;for(let i2=0;i2<hooks.mapResponse.length;i2++){let mapResponse2=hooks.mapResponse[i2],endUnit2=mapResponseReporter.resolveChild(mapResponse2.fn.name);fnLiteral+=`if(mr===undefined){mr=${isAsyncName(mapResponse2)?"await ":""}e.mapResponse[${i2}](c)
if(mr!==undefined)be=c.response=mr}`,endUnit2()}}mapResponseReporter.resolve(),fnLiteral+=encodeCookie,fnLiteral+=`return mapEarlyResponse(${saveResponse}be,c.set${mapResponseContext})}
`}}reporter.resolve()}if(hooks.afterHandle?.length){let handleReporter=report("handle",{name:isHandleFn?handler.name:void 0});if(hooks.afterHandle.length)fnLiteral+=isAsyncHandler?`let r=c.response=await ${handle}
`:`let r=c.response=${handle}
`;else fnLiteral+=isAsyncHandler?`let r=await ${handle}
`:`let r=${handle}
`;handleReporter.resolve();let reporter=report("afterHandle",{total:hooks.afterHandle.length});for(let i=0;i<hooks.afterHandle.length;i++){let hook=hooks.afterHandle[i],returning=hasReturn(hook),endUnit=reporter.resolveChild(hook.fn.name);if(!returning)fnLiteral+=isAsync(hook.fn)?`await e.afterHandle[${i}](c)
`:`e.afterHandle[${i}](c)
`,endUnit();else if(fnLiteral+=isAsync(hook.fn)?`af=await e.afterHandle[${i}](c)
`:`af=e.afterHandle[${i}](c)
`,endUnit("af"),validator.response)fnLiteral+="if(af!==undefined){",reporter.resolve(),fnLiteral+=composeResponseValidation("af"),fnLiteral+="c.response=af}";else fnLiteral+="if(af!==undefined){",reporter.resolve(),fnLiteral+="c.response=af}"}if(reporter.resolve(),fnLiteral+=`r=c.response
`,validator.response)fnLiteral+=composeResponseValidation();fnLiteral+=encodeCookie;let mapResponseReporter=report("mapResponse",{total:hooks.mapResponse?.length});if(hooks.mapResponse?.length)for(let i=0;i<hooks.mapResponse.length;i++){let mapResponse2=hooks.mapResponse[i],endUnit=mapResponseReporter.resolveChild(mapResponse2.fn.name);fnLiteral+=`mr=${isAsyncName(mapResponse2)?"await ":""}e.mapResponse[${i}](c)
if(mr!==undefined)r=c.response=mr
`,endUnit()}if(mapResponseReporter.resolve(),hasSet)fnLiteral+=`return mapResponse(${saveResponse}r,c.set${mapResponseContext})
`;else fnLiteral+=`return mapCompactResponse(${saveResponse}r${mapResponseContext})
`}else{let handleReporter=report("handle",{name:isHandleFn?handler.name:void 0});if(validator.response||hooks.mapResponse?.length){if(fnLiteral+=isAsyncHandler?`let r=await ${handle}
`:`let r=${handle}
`,handleReporter.resolve(),validator.response)fnLiteral+=composeResponseValidation();report("afterHandle").resolve();let mapResponseReporter=report("mapResponse",{total:hooks.mapResponse?.length});if(hooks.mapResponse?.length){fnLiteral+=`
c.response=r
`;for(let i=0;i<hooks.mapResponse.length;i++){let mapResponse2=hooks.mapResponse[i],endUnit=mapResponseReporter.resolveChild(mapResponse2.fn.name);fnLiteral+=`
if(mr===undefined){mr=${isAsyncName(mapResponse2)?"await ":""}e.mapResponse[${i}](c)
if(mr!==undefined)r=c.response=mr}
`,endUnit()}}if(mapResponseReporter.resolve(),fnLiteral+=encodeCookie,handler instanceof Response)fnLiteral+=inference.set?`if(isNotEmpty(c.set.headers)||c.set.status!==200||c.set.redirect||c.set.cookie)return mapResponse(${saveResponse}${handle}.clone(),c.set${mapResponseContext})else return ${handle}.clone()`:`return ${handle}.clone()`,fnLiteral+=`
`;else if(hasSet)fnLiteral+=`return mapResponse(${saveResponse}r,c.set${mapResponseContext})
`;else fnLiteral+=`return mapCompactResponse(${saveResponse}r${mapResponseContext})
`}else if(hasCookie||hasTrace){fnLiteral+=isAsyncHandler?`let r=await ${handle}
`:`let r=${handle}
`,handleReporter.resolve(),report("afterHandle").resolve();let mapResponseReporter=report("mapResponse",{total:hooks.mapResponse?.length});if(hooks.mapResponse?.length){fnLiteral+=`c.response= r
`;for(let i=0;i<hooks.mapResponse.length;i++){let mapResponse2=hooks.mapResponse[i],endUnit=mapResponseReporter.resolveChild(mapResponse2.fn.name);fnLiteral+=`if(mr===undefined){mr=${isAsyncName(mapResponse2)?"await ":""}e.mapResponse[${i}](c)
if(mr!==undefined)r=c.response=mr}`,endUnit()}}if(mapResponseReporter.resolve(),fnLiteral+=encodeCookie,hasSet)fnLiteral+=`return mapResponse(${saveResponse}r,c.set${mapResponseContext})
`;else fnLiteral+=`return mapCompactResponse(${saveResponse}r${mapResponseContext})
`}else{handleReporter.resolve();let handled=isAsyncHandler?`await ${handle}`:handle;if(report("afterHandle").resolve(),handler instanceof Response)fnLiteral+=inference.set?`if(isNotEmpty(c.set.headers)||c.set.status!==200||c.set.redirect||c.set.cookie)return mapResponse(${saveResponse}${handle}.clone(),c.set${mapResponseContext})
else return ${handle}.clone()
`:`return ${handle}.clone()
`;else if(hasSet)fnLiteral+=`return mapResponse(${saveResponse}${handled},c.set${mapResponseContext})
`;else fnLiteral+=`return mapCompactResponse(${saveResponse}${handled}${mapResponseContext})
`}}if(fnLiteral+=`
}catch(error){`,hasBody)fnLiteral+=`if(isParsing)error=new ParseError()
`;if(!maybeAsync)fnLiteral+="return(async()=>{";if(fnLiteral+=`const set=c.set
if(!set.status||set.status<300)set.status=error?.status||500
`,hasTrace&&hooks.trace)for(let i=0;i<hooks.trace.length;i++)fnLiteral+=`report${i}?.resolve(error);reportChild${i}?.(error)
`;let errorReporter=report("error",{total:hooks.error?.length});if(hooks.error?.length){if(fnLiteral+=`c.error=error
`,hasValidation)fnLiteral+=`if(error instanceof TypeBoxError){c.code="VALIDATION"
c.set.status=422}else{c.code=error.code??error[ERROR_CODE]??"UNKNOWN"}`;else fnLiteral+=`c.code=error.code??error[ERROR_CODE]??"UNKNOWN"
`;fnLiteral+=`let er
`;for(let i=0;i<hooks.error.length;i++){let endUnit=errorReporter.resolveChild(hooks.error[i].fn.name);if(isAsync(hooks.error[i]))fnLiteral+=`er=await e.error[${i}](c)
`;else fnLiteral+=`er=e.error[${i}](c)
if(er instanceof Promise)er=await er
`;endUnit();let mapResponseReporter=report("mapResponse",{total:hooks.mapResponse?.length});if(hooks.mapResponse?.length)for(let i2=0;i2<hooks.mapResponse.length;i2++){let mapResponse2=hooks.mapResponse[i2],endUnit2=mapResponseReporter.resolveChild(mapResponse2.fn.name);fnLiteral+=`c.response=er
er=e.mapResponse[${i2}](c)
if(er instanceof Promise)er=await er
`,endUnit2()}if(mapResponseReporter.resolve(),fnLiteral+=`er=mapEarlyResponse(er,set${mapResponseContext})
`,fnLiteral+="if(er){",hasTrace&&hooks.trace){for(let i2=0;i2<hooks.trace.length;i2++)fnLiteral+=`report${i2}.resolve()
`;errorReporter.resolve()}fnLiteral+="return er}"}}if(errorReporter.resolve(),fnLiteral+="return handleError(c,error,true)",!maybeAsync)fnLiteral+="})()";if(fnLiteral+="}",hasAfterResponse||hasTrace){if(fnLiteral+="finally{ ",!maybeAsync)fnLiteral+=";(async()=>{";let reporter=report("afterResponse",{total:hooks.afterResponse?.length});if(hasAfterResponse&&hooks.afterResponse)for(let i=0;i<hooks.afterResponse.length;i++){let endUnit=reporter.resolveChild(hooks.afterResponse[i].fn.name);fnLiteral+=`
await e.afterResponse[${i}](c)
`,endUnit()}if(reporter.resolve(),!maybeAsync)fnLiteral+="})()";fnLiteral+="}"}let adapterVariables=adapter.inject?Object.keys(adapter.inject).join(",")+",":"",init="const {handler,handleError,hooks:e, "+allocateIf("validator,",hasValidation)+"mapResponse,mapCompactResponse,mapEarlyResponse,isNotEmpty,utils:{"+allocateIf("parseQuery,",hasBody)+allocateIf("parseQueryFromURL,",hasQuery)+"},error:{"+allocateIf("ValidationError,",hasValidation)+"InternalServerError,"+allocateIf("ParseError",hasBody)+"},schema,definitions,ERROR_CODE,"+allocateIf("parseCookie,",hasCookie)+allocateIf("signCookie,",hasCookie)+allocateIf("decodeURIComponent,",hasQuery)+"ElysiaCustomStatusResponse,"+allocateIf("ELYSIA_TRACE,",hasTrace)+allocateIf("ELYSIA_REQUEST_ID,",hasTrace)+allocateIf("parser,",hooks.parse?.length)+allocateIf("getServer,",inference.server)+adapterVariables+allocateIf("TypeBoxError",hasValidation)+`}=hooks
const trace=e.trace?.map(x=>typeof x==='function'?x:x.fn)??[]
return ${maybeAsync?"async ":""}function handle(c){`;if(hooks.beforeHandle?.length)init+=`let be
`;if(hooks.afterHandle?.length)init+=`let af
`;if(hooks.mapResponse?.length)init+=`let mr
`;if(allowMeta)init+=`c.schema = schema
c.defs = definitions
`;init+=fnLiteral+"}";try{if(asManifest)return Function("hooks",init);return Function("hooks",init)({handler,hooks:lifeCycleToFn(hooks),validator:hasValidation?validator:void 0,handleError:app.handleError,mapResponse:adapterHandler.mapResponse,mapCompactResponse:adapterHandler.mapCompactResponse,mapEarlyResponse:adapterHandler.mapEarlyResponse,isNotEmpty,utils:{parseQuery:hasBody?parseQuery:void 0,parseQueryFromURL:hasQuery?parseQueryFromURL:void 0},error:{ValidationError:hasValidation?ValidationError:void 0,InternalServerError,ParseError:hasBody?ParseError2:void 0},schema:app.router.history,definitions:app.definitions.type,ERROR_CODE,parseCookie:hasCookie?parseCookie:void 0,signCookie:hasCookie?signCookie:void 0,decodeURIComponent:hasQuery?decode2:void 0,ElysiaCustomStatusResponse,ELYSIA_TRACE:hasTrace?ELYSIA_TRACE:void 0,ELYSIA_REQUEST_ID:hasTrace?ELYSIA_REQUEST_ID:void 0,getServer:()=>app.getServer(),TypeBoxError:hasValidation?TypeBoxError:void 0,parser:app["~parser"],...adapter.inject})}catch(error2){let debugHooks=lifeCycleToFn(hooks);console.log("[Composer] failed to generate optimized handler"),console.log("---"),console.log({handler:typeof handler==="function"?handler.toString():handler,instruction:init,hooks:{...debugHooks,transform:debugHooks?.transform?.map?.((x)=>x.toString()),resolve:debugHooks?.resolve?.map?.((x)=>x.toString()),beforeHandle:debugHooks?.beforeHandle?.map?.((x)=>x.toString()),afterHandle:debugHooks?.afterHandle?.map?.((x)=>x.toString()),mapResponse:debugHooks?.mapResponse?.map?.((x)=>x.toString()),parse:debugHooks?.parse?.map?.((x)=>x.toString()),error:debugHooks?.error?.map?.((x)=>x.toString()),afterResponse:debugHooks?.afterResponse?.map?.((x)=>x.toString()),stop:debugHooks?.stop?.map?.((x)=>x.toString())},validator,definitions:app.definitions.type,error:error2,fnLiteral}),console.log("---"),process.exit(1)}},composeGeneralHandler=(app,{asManifest=!1}={})=>{let adapter=app["~adapter"].composeGeneralHandler;app.router.http.build();let error404=adapter.error404(!!app.event.request?.length,!!app.event.error?.length),hasTrace=app.event.trace?.length,fnLiteral="",router=app.router,findDynamicRoute="const route=router.find(r.method,p)";findDynamicRoute+=router.http.root.ALL?`??router.find("ALL",p)
`:`
`,findDynamicRoute+=error404.code,findDynamicRoute+=`
c.params=route.params
if(route.store.handler)return route.store.handler(c)
return (route.store.handler=route.store.compile())(c)
`;let switchMap="";for(let[path,v]of Object.entries(router.static.http.map)){if(switchMap+=`case'${path}':`,app.config.strictPath!==!0)switchMap+=`case'${getLoosePath(path)}':`;let encoded=encodePath(path);if(path!==encoded)switchMap+=`case'${encoded}':`;switchMap+=`switch(r.method){${v.code}
`+(v.all??"default: break map")+"}"}let maybeAsync=!!app.event.request?.some(isAsync),adapterVariables=adapter.inject?Object.keys(adapter.inject).join(",")+",":"";if(fnLiteral+=`
const {app,mapEarlyResponse,NotFoundError,randomId,handleError,error,redirect,`+allocateIf("ELYSIA_TRACE,",hasTrace)+allocateIf("ELYSIA_REQUEST_ID,",hasTrace)+adapterVariables+`}=data
const store=app.singleton.store
const decorator=app.singleton.decorator
const staticRouter=app.router.static.http
const ht=app.router.history
const router=app.router.http
const trace=app.event.trace?.map(x=>typeof x==='function'?x:x.fn)??[]
const notFound=new NotFoundError()
const hoc=app.extender.higherOrderFunctions.map(x=>x.fn)
`,app.event.request?.length)fnLiteral+=`const onRequest=app.event.request.map(x=>x.fn)
`;if(fnLiteral+=error404.declare,app.event.trace?.length)fnLiteral+="const "+app.event.trace.map((_2,i)=>`tr${i}=app.event.trace[${i}].fn`).join(",")+`
`;if(fnLiteral+=`${maybeAsync?"async ":""}function map(${adapter.parameters}){`,app.event.request?.length)fnLiteral+=`let re
`;if(fnLiteral+=adapter.createContext(app),app.event.trace?.length)fnLiteral+="c[ELYSIA_TRACE]=["+app.event.trace.map((_2,i)=>`tr${i}(c)`).join(",")+`]
`;let reporter=createReport({trace:app.event.trace,addFn(word){fnLiteral+=word}})("request",{total:app.event.request?.length});if(app.event.request?.length){fnLiteral+="try{";for(let i=0;i<app.event.request.length;i++){let hook=app.event.request[i],withReturn=hasReturn(hook),maybeAsync2=isAsync(hook),endUnit=reporter.resolveChild(app.event.request[i].fn.name);if(withReturn)fnLiteral+=`re=mapEarlyResponse(${maybeAsync2?"await ":""}onRequest[${i}](c),c.set)
`,endUnit("re"),fnLiteral+=`if(re!==undefined)return re
`;else fnLiteral+=`${maybeAsync2?"await ":""}onRequest[${i}](c)
`,endUnit()}fnLiteral+="}catch(error){return app.handleError(c,error,false)}"}if(reporter.resolve(),fnLiteral+=adapter.websocket(app),fnLiteral+=`
map:switch(p){
`+switchMap+"default:break}"+findDynamicRoute+`}
`,app.extender.higherOrderFunctions.length){let handler="map";for(let i=0;i<app.extender.higherOrderFunctions.length;i++)handler=`hoc[${i}](${handler},${adapter.parameters})`;fnLiteral+=`return function hocMap(${adapter.parameters}){return ${handler}(${adapter.parameters})}`}else fnLiteral+="return map";let handleError=composeErrorHandler(app);return app.handleError=handleError,Function("data",fnLiteral)({app,mapEarlyResponse:app["~adapter"].handler.mapEarlyResponse,NotFoundError,randomId,handleError,error,redirect,ELYSIA_TRACE:hasTrace?ELYSIA_TRACE:void 0,ELYSIA_REQUEST_ID:hasTrace?ELYSIA_REQUEST_ID:void 0,...adapter.inject})},composeErrorHandler=(app)=>{let hooks=app.event,fnLiteral="",adapter=app["~adapter"].composeError,adapterVariables=adapter.inject?Object.keys(adapter.inject).join(",")+",":"",hasTrace=!!app.event.trace?.length;if(fnLiteral+="const {app:{event:{error:onErrorContainer,afterResponse:resContainer,mapResponse:_onMapResponse,trace:_trace}},mapResponse,ERROR_CODE,ElysiaCustomStatusResponse,"+allocateIf("ELYSIA_TRACE,",hasTrace)+allocateIf("ELYSIA_REQUEST_ID,",hasTrace)+adapterVariables+`}=inject
`,fnLiteral+=`const trace=_trace?.map(x=>typeof x==='function'?x:x.fn)??[]
const onMapResponse=[]
if(_onMapResponse)for(let i=0;i<_onMapResponse.length;i++)onMapResponse.push(_onMapResponse[i].fn??_onMapResponse[i])
delete _onMapResponse
const onError=onErrorContainer?.map(x=>x.fn)??[]
const res=resContainer?.map(x=>x.fn)??[]
return ${app.event.error?.find(isAsync)||app.event.mapResponse?.find(isAsync)?"async ":""}function(context,error,skipGlobal){`,fnLiteral+="",hasTrace)fnLiteral+=`const id=context[ELYSIA_REQUEST_ID]
`;let report=createReport({context:"context",trace:hooks.trace,addFn:(word)=>{fnLiteral+=word}});if(fnLiteral+=`const set=context.set
let _r
if(!context.code)context.code=error.code??error[ERROR_CODE]
if(!(context.error instanceof Error))context.error=error
if(error instanceof ElysiaCustomStatusResponse){set.status=error.status=error.code
error.message=error.response}`,adapter.declare)fnLiteral+=adapter.declare;let saveResponse=hasTrace||!!hooks.afterResponse?.length||!!hooks.afterResponse?.length?"context.response = ":"";if(app.event.error)for(let i=0;i<app.event.error.length;i++){let handler=app.event.error[i],response=`${isAsync(handler)?"await ":""}onError[${i}](context)
`;if(fnLiteral+="if(skipGlobal!==true){",hasReturn(handler)){fnLiteral+=`_r=${response}
if(_r!==undefined){if(_r instanceof Response)return mapResponse(_r,set${adapter.mapResponseContext})
if(_r instanceof ElysiaCustomStatusResponse){error.status=error.code
error.message = error.response}if(set.status===200||!set.status)set.status=error.status
`;let mapResponseReporter2=report("mapResponse",{total:hooks.mapResponse?.length,name:"context"});if(hooks.mapResponse?.length)for(let i2=0;i2<hooks.mapResponse.length;i2++){let mapResponse2=hooks.mapResponse[i2],endUnit=mapResponseReporter2.resolveChild(mapResponse2.fn.name);fnLiteral+=`context.response=_r_r=${isAsyncName(mapResponse2)?"await ":""}onMapResponse[${i2}](context)
`,endUnit()}mapResponseReporter2.resolve(),fnLiteral+=`return mapResponse(${saveResponse}_r,set${adapter.mapResponseContext})}`}else fnLiteral+=response;fnLiteral+="}"}fnLiteral+=`if(error.constructor.name==="ValidationError"||error.constructor.name==="TransformDecodeError"){if(error.error)error=error.error
set.status=error.status??422
`+adapter.validationError+"}",fnLiteral+="if(error instanceof Error){"+adapter.unknownError+"}";let mapResponseReporter=report("mapResponse",{total:hooks.mapResponse?.length,name:"context"});if(fnLiteral+=`
if(!context.response)context.response=error.message??error
`,hooks.mapResponse?.length){fnLiteral+=`let mr
`;for(let i=0;i<hooks.mapResponse.length;i++){let mapResponse2=hooks.mapResponse[i],endUnit=mapResponseReporter.resolveChild(mapResponse2.fn.name);fnLiteral+=`if(mr===undefined){mr=${isAsyncName(mapResponse2)?"await ":""}onMapResponse[${i}](context)
if(mr!==undefined)error=context.response=mr}`,endUnit()}}return mapResponseReporter.resolve(),fnLiteral+=`
return mapResponse(${saveResponse}error,set${adapter.mapResponseContext})}`,Function("inject",fnLiteral)({app,mapResponse:app["~adapter"].handler.mapResponse,ERROR_CODE,ElysiaCustomStatusResponse,ELYSIA_TRACE:hasTrace?ELYSIA_TRACE:void 0,ELYSIA_REQUEST_ID:hasTrace?ELYSIA_REQUEST_ID:void 0,...adapter.inject})},injectDefaultValues=(typeChecker,obj)=>{for(let[key,keySchema]of Object.entries(typeChecker.schema.properties))obj[key]??=keySchema.default},createDynamicHandler=(app)=>{let{mapResponse:mapResponse2,mapEarlyResponse:mapEarlyResponse2}=app["~adapter"].handler;return async(request)=>{let url=request.url,s=url.indexOf("/",11),qi=url.indexOf("?",s+1),path=qi===-1?url.substring(s):url.substring(s,qi),set2={cookie:{},status:200,headers:{}},context=Object.assign({},app.singleton.decorator,{set:set2,store:app.singleton.store,request,path,qi,error,redirect});try{if(app.event.request)for(let i=0;i<app.event.request.length;i++){let onRequest=app.event.request[i].fn,response2=onRequest(context);if(response2 instanceof Promise)response2=await response2;if(response2=mapEarlyResponse2(response2,set2),response2)return context.response=response2}let handler=app.router.dynamic.find(request.method,path)??app.router.dynamic.find("ALL",path);if(!handler)throw new NotFoundError;let{handle,hooks,validator,content,route}=handler.store,body;if(request.method!=="GET"&&request.method!=="HEAD")if(content)switch(content){case"application/json":body=await request.json();break;case"text/plain":body=await request.text();break;case"application/x-www-form-urlencoded":body=parseQuery(await request.text());break;case"application/octet-stream":body=await request.arrayBuffer();break;case"multipart/form-data":body={};let form2=await request.formData();for(let key of form2.keys()){if(body[key])continue;let value=form2.getAll(key);if(value.length===1)body[key]=value[0];else body[key]=value}break}else{let contentType=request.headers.get("content-type");if(contentType){let index=contentType.indexOf(";");if(index!==-1)contentType=contentType.slice(0,index);if(context.contentType=contentType,hooks.parse)for(let i=0;i<hooks.parse.length;i++){let hook=hooks.parse[i].fn,temp=hook(context,contentType);if(temp instanceof Promise)temp=await temp;if(temp){body=temp;break}}if(delete context.contentType,body===void 0)switch(contentType){case"application/json":body=await request.json();break;case"text/plain":body=await request.text();break;case"application/x-www-form-urlencoded":body=parseQuery(await request.text());break;case"application/octet-stream":body=await request.arrayBuffer();break;case"multipart/form-data":body={};let form2=await request.formData();for(let key of form2.keys()){if(body[key])continue;let value=form2.getAll(key);if(value.length===1)body[key]=value[0];else body[key]=value}break}}}context.route=route,context.body=body,context.params=handler?.params||void 0,context.query=qi===-1?{}:parseQuery(url.substring(qi+1)),context.headers={};for(let[key,value]of request.headers.entries())context.headers[key]=value;let cookieMeta=Object.assign({},app.config?.cookie,validator?.cookie?.config),cookieHeaderValue=request.headers.get("cookie");context.cookie=await parseCookie(context.set,cookieHeaderValue,cookieMeta?{secrets:cookieMeta.secrets!==void 0?typeof cookieMeta.secrets==="string"?cookieMeta.secrets:cookieMeta.secrets.join(","):void 0,sign:cookieMeta.sign===!0?!0:cookieMeta.sign!==void 0?typeof cookieMeta.sign==="string"?cookieMeta.sign:cookieMeta.sign.join(","):void 0}:void 0);let headerValidator=validator?.createHeaders?.();if(headerValidator)injectDefaultValues(headerValidator,context.headers);let paramsValidator=validator?.createParams?.();if(paramsValidator)injectDefaultValues(paramsValidator,context.params);let queryValidator=validator?.createQuery?.();if(queryValidator)injectDefaultValues(queryValidator,context.query);if(hooks.transform)for(let i=0;i<hooks.transform.length;i++){let hook=hooks.transform[i],operation=hook.fn(context);if(hook.subType==="derive")if(operation instanceof Promise)Object.assign(context,await operation);else Object.assign(context,operation);else if(operation instanceof Promise)await operation}if(validator){if(headerValidator){let _header=structuredClone(context.headers);for(let[key,value]of request.headers)_header[key]=value;if(validator.headers.Check(_header)===!1)throw new ValidationError("header",validator.headers,_header)}else if(validator.headers?.Decode)context.headers=validator.headers.Decode(context.headers);if(paramsValidator?.Check(context.params)===!1)throw new ValidationError("params",validator.params,context.params);else if(validator.params?.Decode)context.params=validator.params.Decode(context.params);if(queryValidator?.Check(context.query)===!1)throw new ValidationError("query",validator.query,context.query);else if(validator.query?.Decode)context.query=validator.query.Decode(context.query);if(validator.createCookie?.()){let cookieValue={};for(let[key,value]of Object.entries(context.cookie))cookieValue[key]=value.value;if(validator.cookie.Check(cookieValue)===!1)throw new ValidationError("cookie",validator.cookie,cookieValue);else if(validator.cookie?.Decode)cookieValue=validator.cookie.Decode(cookieValue)}if(validator.createBody?.()?.Check(body)===!1)throw new ValidationError("body",validator.body,body);else if(validator.body?.Decode)context.body=validator.body.Decode(body)}if(hooks.beforeHandle)for(let i=0;i<hooks.beforeHandle.length;i++){let hook=hooks.beforeHandle[i],response2=hook.fn(context);if(hook.subType==="resolve"){if(response2 instanceof ElysiaCustomStatusResponse){let result=mapEarlyResponse2(response2,context.set);if(result)return context.response=result}if(response2 instanceof Promise)Object.assign(context,await response2);else Object.assign(context,response2);continue}else if(response2 instanceof Promise)response2=await response2;if(response2!==void 0){if(context.response=response2,hooks.afterHandle)for(let i2=0;i2<hooks.afterHandle.length;i2++){let newResponse=hooks.afterHandle[i2].fn(context);if(newResponse instanceof Promise)newResponse=await newResponse;if(newResponse)response2=newResponse}let result=mapEarlyResponse2(response2,context.set);if(result)return context.response=result}}let response=typeof handle==="function"?handle(context):handle;if(response instanceof Promise)response=await response;if(hooks.afterHandle)if(!hooks.afterHandle.length){let status=response instanceof ElysiaCustomStatusResponse?response.code:set2.status?typeof set2.status==="string"?StatusMap[set2.status]:set2.status:200,responseValidator=validator?.createResponse?.()?.[status];if(responseValidator?.Check(response)===!1)throw new ValidationError("response",responseValidator,response);else if(responseValidator?.Decode)response=responseValidator.Decode(response)}else{context.response=response;for(let i=0;i<hooks.afterHandle.length;i++){let newResponse=hooks.afterHandle[i].fn(context);if(newResponse instanceof Promise)newResponse=await newResponse;let result=mapEarlyResponse2(newResponse,context.set);if(result!==void 0){let responseValidator=validator?.response?.[result.status];if(responseValidator?.Check(result)===!1)throw new ValidationError("response",responseValidator,result);else if(responseValidator?.Decode)response=responseValidator.Decode(response);return context.response=result}}}if(context.set.cookie&&cookieMeta?.sign){let secret=!cookieMeta.secrets?void 0:typeof cookieMeta.secrets==="string"?cookieMeta.secrets:cookieMeta.secrets[0];if(cookieMeta.sign===!0)for(let[key,cookie]of Object.entries(context.set.cookie))context.set.cookie[key].value=await signCookie(cookie.value,"${secret}");else{let properties=validator?.cookie?.schema?.properties;for(let name of cookieMeta.sign){if(!(name in properties))continue;if(context.set.cookie[name]?.value)context.set.cookie[name].value=await signCookie(context.set.cookie[name].value,secret)}}}return mapResponse2(context.response=response,context.set)}catch(error2){let reportedError=error2 instanceof TransformDecodeError&&error2.error?error2.error:error2;return app.handleError(context,reportedError)}finally{if(app.event.afterResponse)for(let afterResponse of app.event.afterResponse)await afterResponse.fn(context)}}},createDynamicErrorHandler=(app)=>{let{mapResponse:mapResponse2}=app["~adapter"].handler;return async(context,error2)=>{let errorContext=Object.assign(context,{error:error2,code:error2.code});if(errorContext.set=context.set,app.event.error)for(let i=0;i<app.event.error.length;i++){let response=app.event.error[i].fn(errorContext);if(response instanceof Promise)response=await response;if(response!==void 0&&response!==null)return context.response=mapResponse2(response,context.set)}return new Response(typeof error2.cause==="string"?error2.cause:error2.message,{headers:context.set.headers,status:error2.status??500})}};class Elysia{config;server=null;dependencies={};_routes={};_types={Prefix:"",Singleton:{},Definitions:{},Metadata:{}};_ephemeral={};_volatile={};singleton={decorator:{},store:{},derive:{},resolve:{}};get store(){return this.singleton.store}get decorator(){return this.singleton.decorator}definitions={typebox:t.Module({}),type:{},error:{}};extender={macros:[],higherOrderFunctions:[]};validator={global:null,scoped:null,local:null,getCandidate(){return mergeSchemaValidator(mergeSchemaValidator(this.global,this.scoped),this.local)}};event={};telemetry={stack:void 0};router={"~http":void 0,get http(){if(!this["~http"])this["~http"]=new _({lazy:!0});return this["~http"]},"~dynamic":void 0,get dynamic(){if(!this["~dynamic"])this["~dynamic"]=new _;return this["~dynamic"]},static:{http:{static:{},map:{},all:""},ws:{}},history:[]};routeTree=new Map;get routes(){return this.router.history}getGlobalRoutes(){return this.router.history}inference={body:!1,cookie:!1,headers:!1,query:!1,set:!1,server:!1,request:!1,route:!1};getServer(){return this.server}getParent(){return null}"~parser"={};_promisedModules;get promisedModules(){if(!this._promisedModules)this._promisedModules=new PromiseGroup;return this._promisedModules}constructor(config={}){if(config.tags)if(!config.detail)config.detail={tags:config.tags};else config.detail.tags=config.tags;if(config.nativeStaticResponse===void 0)config.nativeStaticResponse=!0;if(this.config={},this.applyConfig(config??{}),this["~adapter"]=config.adapter??(typeof Bun!=="undefined"?BunAdapter:WebStandardAdapter),config?.analytic&&(config?.name||config?.seed!==void 0))this.telemetry.stack=new Error().stack}"~adapter";env(model,_env=env2){if(getSchemaValidator(model,{modules:this.definitions.typebox,dynamic:!0,additionalProperties:!0,coerce:!0}).Check(_env)===!1){let error2=new ValidationError("env",model,_env);throw new Error(error2.all.map((x)=>x.summary).join(`
`))}return this}wrap(fn){return this.extender.higherOrderFunctions.push({checksum:checksum(JSON.stringify({name:this.config.name,seed:this.config.seed,content:fn.toString()})),fn}),this}applyMacro(localHook){if(this.extender.macros.length){let manage=createMacroManager({globalHook:this.event,localHook}),manager={events:{global:this.event,local:localHook},get onParse(){return manage("parse")},get onTransform(){return manage("transform")},get onBeforeHandle(){return manage("beforeHandle")},get onAfterHandle(){return manage("afterHandle")},get mapResponse(){return manage("mapResponse")},get onAfterResponse(){return manage("afterResponse")},get onError(){return manage("error")}};for(let macro of this.extender.macros)traceBackMacro(macro.fn(manager),localHook,manage)}}applyConfig(config){return this.config={prefix:"",aot:env2.ELYSIA_AOT!=="false",normalize:!0,...config,cookie:{path:"/",...config?.cookie},experimental:config?.experimental??{},seed:config?.seed===void 0?"":config?.seed},this}get models(){let models={};for(let name of Object.keys(this.definitions.type))models[name]=getSchemaValidator(this.definitions.typebox.Import(name));return models.modules=this.definitions.typebox,models}add(method,path,handle,localHook,{allowMeta=!1,skipPrefix=!1}={allowMeta:!1,skipPrefix:!1}){if(localHook=compressHistoryHook(localHookToLifeCycleStore(localHook)),path!==""&&path.charCodeAt(0)!==47)path="/"+path;if(this.config.prefix&&!skipPrefix)path=this.config.prefix+path;if(localHook?.type)switch(localHook.type){case"text":localHook.type="text/plain";break;case"json":localHook.type="application/json";break;case"formdata":localHook.type="multipart/form-data";break;case"urlencoded":localHook.type="application/x-www-form-urlencoded";break;case"arrayBuffer":localHook.type="application/octet-stream";break;default:break}let models=this.definitions.type,dynamic=!this.config.aot,instanceValidator={...this.validator.getCandidate()},cloned={body:localHook?.body??instanceValidator?.body,headers:localHook?.headers??instanceValidator?.headers,params:localHook?.params??instanceValidator?.params,query:localHook?.query??instanceValidator?.query,cookie:localHook?.cookie??instanceValidator?.cookie,response:localHook?.response??instanceValidator?.response},cookieValidator=()=>cloned.cookie?getCookieValidator({modules,validator:cloned.cookie,defaultConfig:this.config.cookie,config:cloned.cookie?.config??{},dynamic,models}):void 0,normalize=this.config.normalize,modules=this.definitions.typebox,validator=this.config.precompile===!0||typeof this.config.precompile==="object"&&this.config.precompile.schema===!0?{body:getSchemaValidator(cloned.body,{modules,dynamic,models,normalize,additionalCoerce:coercePrimitiveRoot()}),headers:getSchemaValidator(cloned.headers,{modules,dynamic,models,additionalProperties:!this.config.normalize,coerce:!0,additionalCoerce:stringToStructureCoercions()}),params:getSchemaValidator(cloned.params,{modules,dynamic,models,coerce:!0,additionalCoerce:stringToStructureCoercions()}),query:getSchemaValidator(cloned.query,{modules,dynamic,models,normalize,coerce:!0,additionalCoerce:stringToStructureCoercions()}),cookie:cookieValidator(),response:getResponseSchemaValidator(cloned.response,{modules,dynamic,models,normalize})}:{createBody(){if(this.body)return this.body;return this.body=getSchemaValidator(cloned.body,{modules,dynamic,models,normalize,additionalCoerce:coercePrimitiveRoot()})},createHeaders(){if(this.headers)return this.headers;return this.headers=getSchemaValidator(cloned.headers,{modules,dynamic,models,additionalProperties:!normalize,coerce:!0,additionalCoerce:stringToStructureCoercions()})},createParams(){if(this.params)return this.params;return this.params=getSchemaValidator(cloned.params,{modules,dynamic,models,coerce:!0,additionalCoerce:stringToStructureCoercions()})},createQuery(){if(this.query)return this.query;return this.query=getSchemaValidator(cloned.query,{modules,dynamic,models,coerce:!0,additionalCoerce:stringToStructureCoercions()})},createCookie(){if(this.cookie)return this.cookie;return this.cookie=cookieValidator()},createResponse(){if(this.response)return this.response;return this.response=getResponseSchemaValidator(cloned.response,{modules,dynamic,models,normalize})}};if(localHook=mergeHook(localHook,compressHistoryHook(instanceValidator)),localHook.tags)if(!localHook.detail)localHook.detail={tags:localHook.tags};else localHook.detail.tags=localHook.tags;if(isNotEmpty(this.config.detail))localHook.detail=mergeDeep(Object.assign({},this.config.detail),localHook.detail);this.applyMacro(localHook);let hooks=compressHistoryHook(mergeHook(this.event,localHook));if(this.config.aot===!1){this.router.dynamic.add(method,path,{validator,hooks,content:localHook?.type,handle,route:path});let encoded=encodePath(path,{dynamic:!0});if(path!==encoded)this.router.dynamic.add(method,encoded,{validator,hooks,content:localHook?.type,handle,route:path});if(this.config.strictPath===!1){let loosePath=getLoosePath(path);this.router.dynamic.add(method,loosePath,{validator,hooks,content:localHook?.type,handle,route:path});let encoded2=encodePath(loosePath);if(loosePath!==encoded2)this.router.dynamic.add(method,loosePath,{validator,hooks,content:localHook?.type,handle,route:path})}this.router.history.push({method,path,composed:null,handler:handle,hooks});return}let shouldPrecompile=this.config.precompile===!0||typeof this.config.precompile==="object"&&this.config.precompile.compose===!0,inference=cloneInference(this.inference),adapter=this["~adapter"].handler,staticHandler=typeof handle!=="function"&&typeof adapter.createStaticHandler==="function"?adapter.createStaticHandler(handle,hooks,this.setHeaders):void 0,nativeStaticHandler=typeof handle!=="function"?adapter.createNativeStaticHandler?.(handle,hooks,this.setHeaders):void 0;if(this.config.nativeStaticResponse===!0&&nativeStaticHandler&&(method==="GET"||method==="ALL"))this.router.static.http.static[path]=nativeStaticHandler();let compile=(asManifest=!1)=>composeHandler({app:this,path,method,hooks,validator,handler:typeof handle!=="function"&&typeof adapter.createStaticHandler!=="function"?()=>handle:handle,allowMeta,inference,asManifest}),oldIndex;if(this.routeTree.has(method+path))for(let i=0;i<this.router.history.length;i++){let route=this.router.history[i];if(route.path===path&&route.method===method){oldIndex=i;break}}else this.routeTree.set(method+path,this.router.history.length);let history=this.router.history,index=oldIndex??this.router.history.length,mainHandler=shouldPrecompile?compile():(ctx)=>{let temp=(history[index].composed=compile())(ctx);return compile=void 0,temp};if(shouldPrecompile)compile=void 0;let isWebSocket=method==="$INTERNALWS";if(oldIndex!==void 0)this.router.history[oldIndex]=Object.assign({method,path,composed:mainHandler,handler:handle,hooks},localHook.webSocket?{websocket:localHook.websocket}:{});else this.router.history.push(Object.assign({method,path,composed:mainHandler,handler:handle,hooks},localHook.webSocket?{websocket:localHook.websocket}:{}));let staticRouter=this.router.static.http,handler={handler:shouldPrecompile?mainHandler:void 0,compile(){return this.handler=compile()}};if(isWebSocket){if(this.router.http.add("ws",path,handler),!this.config.strictPath)this.router.http.add("ws",getLoosePath(path),handler);let encoded=encodePath(path,{dynamic:!0});if(encoded!==path)this.router.http.add("ws",encoded,handler);return}if(path.indexOf(":")===-1&&path.indexOf("*")===-1){if(!staticRouter.map[path])staticRouter.map[path]={code:""};let ctx=staticHandler?"":"c";if(method==="ALL")staticRouter.map[path].all=`default:return ht[${index}].composed(${ctx})
`;else staticRouter.map[path].code=`case '${method}':return ht[${index}].composed(${ctx})
${staticRouter.map[path].code}`;if(!this.config.strictPath&&this.config.nativeStaticResponse===!0&&nativeStaticHandler&&(method==="GET"||method==="ALL"))this.router.static.http.static[getLoosePath(path)]=nativeStaticHandler()}else{if(this.router.http.add(method,path,handler),!this.config.strictPath){let loosePath=getLoosePath(path);if(this.config.nativeStaticResponse===!0&&staticHandler&&(method==="GET"||method==="ALL"))this.router.static.http.static[loosePath]=staticHandler();this.router.http.add(method,loosePath,handler)}let encoded=encodePath(path,{dynamic:!0});if(path!==encoded){if(this.router.http.add(method,encoded,handler),this.config.nativeStaticResponse===!0&&staticHandler&&(method==="GET"||method==="ALL"))this.router.static.http.static[encoded]=staticHandler();this.router.http.add(method,encoded,handler)}}}setHeaders;headers(header){if(!header)return this;if(!this.setHeaders)this.setHeaders={};return this.setHeaders=mergeDeep(this.setHeaders,header),this}onStart(handler){return this.on("start",handler),this}onRequest(handler){return this.on("request",handler),this}onParse(options,handler){if(!handler){if(typeof options==="string")return this.on("parse",this["~parser"][options]);return this.on("parse",options)}return this.on(options,"parse",handler)}parser(name,parser){return this["~parser"][name]=parser,this}onTransform(options,handler){if(!handler)return this.on("transform",options);return this.on(options,"transform",handler)}resolve(optionsOrResolve,resolve){if(!resolve)resolve=optionsOrResolve,optionsOrResolve={as:"local"};let hook={subType:"resolve",fn:resolve};return this.onBeforeHandle(optionsOrResolve,hook)}mapResolve(optionsOrResolve,mapper){if(!mapper)mapper=optionsOrResolve,optionsOrResolve={as:"local"};let hook={subType:"mapResolve",fn:mapper};return this.onBeforeHandle(optionsOrResolve,hook)}onBeforeHandle(options,handler){if(!handler)return this.on("beforeHandle",options);return this.on(options,"beforeHandle",handler)}onAfterHandle(options,handler){if(!handler)return this.on("afterHandle",options);return this.on(options,"afterHandle",handler)}mapResponse(options,handler){if(!handler)return this.on("mapResponse",options);return this.on(options,"mapResponse",handler)}onAfterResponse(options,handler){if(!handler)return this.on("afterResponse",options);return this.on(options,"afterResponse",handler)}trace(options,handler){if(!handler)handler=options,options={as:"local"};if(!Array.isArray(handler))handler=[handler];for(let fn of handler)this.on(options,"trace",createTracer(fn));return this}error(name,error2){switch(typeof name){case"string":return error2.prototype[ERROR_CODE]=name,this.definitions.error[name]=error2,this;case"function":return this.definitions.error=name(this.definitions.error),this}for(let[code,error3]of Object.entries(name))error3.prototype[ERROR_CODE]=code,this.definitions.error[code]=error3;return this}onError(options,handler){if(!handler)return this.on("error",options);return this.on(options,"error",handler)}onStop(handler){return this.on("stop",handler),this}on(optionsOrType,typeOrHandlers,handlers){let type2;switch(typeof optionsOrType){case"string":type2=optionsOrType,handlers=typeOrHandlers;break;case"object":if(type2=typeOrHandlers,!Array.isArray(typeOrHandlers)&&typeof typeOrHandlers==="object")handlers=typeOrHandlers;break}if(Array.isArray(handlers))handlers=fnToContainer(handlers);else if(typeof handlers==="function")handlers=[{fn:handlers}];else handlers=[handlers];let handles=handlers;for(let handle of handles)if(handle.scope=typeof optionsOrType==="string"?"local":optionsOrType?.as??"local",type2==="resolve"||type2==="derive")handle.subType=type2;if(type2!=="trace")sucrose({[type2]:handles.map((x)=>x.fn)},this.inference);for(let handle of handles){let fn=asHookType(handle,"global",{skipIfHasType:!0});switch(type2){case"start":this.event.start??=[],this.event.start.push(fn);break;case"request":this.event.request??=[],this.event.request.push(fn);break;case"parse":this.event.parse??=[],this.event.parse.push(fn);break;case"transform":this.event.transform??=[],this.event.transform.push(fn);break;case"derive":this.event.transform??=[],this.event.transform.push(fnToContainer(fn,"derive"));break;case"beforeHandle":this.event.beforeHandle??=[],this.event.beforeHandle.push(fn);break;case"resolve":this.event.beforeHandle??=[],this.event.beforeHandle.push(fnToContainer(fn,"resolve"));break;case"afterHandle":this.event.afterHandle??=[],this.event.afterHandle.push(fn);break;case"mapResponse":this.event.mapResponse??=[],this.event.mapResponse.push(fn);break;case"afterResponse":this.event.afterResponse??=[],this.event.afterResponse.push(fn);break;case"trace":this.event.trace??=[],this.event.trace.push(fn);break;case"error":this.event.error??=[],this.event.error.push(fn);break;case"stop":this.event.stop??=[],this.event.stop.push(fn);break}}return this}propagate(){return promoteEvent(this.event.parse),promoteEvent(this.event.transform),promoteEvent(this.event.beforeHandle),promoteEvent(this.event.afterHandle),promoteEvent(this.event.mapResponse),promoteEvent(this.event.afterResponse),promoteEvent(this.event.trace),promoteEvent(this.event.error),this}as(type2){let castType={plugin:"scoped",scoped:"scoped",global:"global"}[type2];if(promoteEvent(this.event.parse,castType),promoteEvent(this.event.transform,castType),promoteEvent(this.event.beforeHandle,castType),promoteEvent(this.event.afterHandle,castType),promoteEvent(this.event.mapResponse,castType),promoteEvent(this.event.afterResponse,castType),promoteEvent(this.event.trace,castType),promoteEvent(this.event.error,castType),type2==="plugin")this.validator.scoped=mergeSchemaValidator(this.validator.scoped,this.validator.local),this.validator.local=null;else if(type2==="global")this.validator.global=mergeSchemaValidator(this.validator.global,mergeSchemaValidator(this.validator.scoped,this.validator.local)),this.validator.scoped=null,this.validator.local=null;return this}group(prefix,schemaOrRun,run){let instance=new Elysia({...this.config,prefix:""});instance.singleton={...this.singleton},instance.definitions={...this.definitions},instance.getServer=()=>this.getServer(),instance.inference=cloneInference(this.inference),instance.extender={...this.extender};let isSchema=typeof schemaOrRun==="object",sandbox=(isSchema?run:schemaOrRun)(instance);if(this.singleton=mergeDeep(this.singleton,instance.singleton),this.definitions=mergeDeep(this.definitions,instance.definitions),sandbox.event.request?.length)this.event.request=[...this.event.request||[],...sandbox.event.request||[]];if(sandbox.event.mapResponse?.length)this.event.mapResponse=[...this.event.mapResponse||[],...sandbox.event.mapResponse||[]];return this.model(sandbox.definitions.type),Object.values(instance.router.history).forEach(({method,path,handler,hooks})=>{if(path=(isSchema?"":this.config.prefix)+prefix+path,isSchema){let hook=schemaOrRun,localHook=hooks;this.add(method,path,handler,mergeHook(hook,{...localHook||{},error:!localHook.error?sandbox.event.error:Array.isArray(localHook.error)?[...localHook.error||{},...sandbox.event.error||{}]:[localHook.error,...sandbox.event.error||{}]}))}else this.add(method,path,handler,mergeHook(hooks,{error:sandbox.event.error}),{skipPrefix:!0})}),this}guard(hook,run){if(!run){if(typeof hook==="object"){this.applyMacro(hook);let type2=hook.as??"local";if(this.validator[type2]={body:hook.body??this.validator[type2]?.body,headers:hook.headers??this.validator[type2]?.headers,params:hook.params??this.validator[type2]?.params,query:hook.query??this.validator[type2]?.query,response:hook.response??this.validator[type2]?.response,cookie:hook.cookie??this.validator[type2]?.cookie},hook.parse)this.on({as:type2},"parse",hook.parse);if(hook.transform)this.on({as:type2},"transform",hook.transform);if(hook.derive)this.on({as:type2},"derive",hook.derive);if(hook.beforeHandle)this.on({as:type2},"beforeHandle",hook.beforeHandle);if(hook.resolve)this.on({as:type2},"resolve",hook.resolve);if(hook.afterHandle)this.on({as:type2},"afterHandle",hook.afterHandle);if(hook.mapResponse)this.on({as:type2},"mapResponse",hook.mapResponse);if(hook.afterResponse)this.on({as:type2},"afterResponse",hook.afterResponse);if(hook.error)this.on({as:type2},"error",hook.error);if(hook.detail)if(this.config.detail)this.config.detail=mergeDeep(Object.assign({},this.config.detail),hook.detail);else this.config.detail=hook.detail;if(hook?.tags)if(!this.config.detail)this.config.detail={tags:hook.tags};else this.config.detail.tags=hook.tags;return this}return this.guard({},hook)}let instance=new Elysia({...this.config,prefix:""});instance.singleton={...this.singleton},instance.definitions={...this.definitions},instance.inference=cloneInference(this.inference),instance.extender={...this.extender};let sandbox=run(instance);if(this.singleton=mergeDeep(this.singleton,instance.singleton),this.definitions=mergeDeep(this.definitions,instance.definitions),sandbox.getServer=()=>this.server,sandbox.event.request?.length)this.event.request=[...this.event.request||[],...sandbox.event.request||[]];if(sandbox.event.mapResponse?.length)this.event.mapResponse=[...this.event.mapResponse||[],...sandbox.event.mapResponse||[]];return this.model(sandbox.definitions.type),Object.values(instance.router.history).forEach(({method,path,handler,hooks:localHook})=>{this.add(method,path,handler,mergeHook(hook,{...localHook||{},error:!localHook.error?sandbox.event.error:Array.isArray(localHook.error)?[...localHook.error||{},...sandbox.event.error||[]]:[localHook.error,...sandbox.event.error||[]]}))}),this}use(plugin,options){if(Array.isArray(plugin)){let app=this;for(let p of plugin)app=app.use(p);return app}if(options?.scoped)return this.guard({},(app)=>app.use(plugin));if(Array.isArray(plugin)){let current=this;for(let p of plugin)current=this.use(p);return current}if(plugin instanceof Promise)return this.promisedModules.add(plugin.then((plugin2)=>{if(typeof plugin2==="function")return plugin2(this);if(plugin2 instanceof Elysia)return this._use(plugin2).compile();if(plugin2.constructor.name==="Elysia")return this._use(plugin2).compile();if(typeof plugin2.default==="function")return plugin2.default(this);if(plugin2.default instanceof Elysia)return this._use(plugin2.default);if(plugin2.constructor.name==="Elysia")return this._use(plugin2.default);if(plugin2.constructor.name==="_Elysia")return this._use(plugin2.default);try{return this._use(plugin2.default)}catch(error2){throw console.error('Invalid plugin type. Expected Elysia instance, function, or module with "default" as Elysia instance or function that returns Elysia instance.'),error2}}).then((v)=>{if(v&&typeof v.compile==="function")v.compile();return v})),this;return this._use(plugin)}propagatePromiseModules(plugin){if(plugin.promisedModules.size<=0)return this;for(let promise of plugin.promisedModules.promises)this.promisedModules.add(promise.then((v)=>{if(!v)return;let t2=this._use(v);if(t2 instanceof Promise)return t2.then((v2)=>{if(v2)v2.compile();else v.compile()});return v.compile()}));return this}_use(plugin){if(typeof plugin==="function"){let instance=plugin(this);if(instance instanceof Promise)return this.promisedModules.add(instance.then((plugin2)=>{if(plugin2 instanceof Elysia){plugin2.getServer=()=>this.getServer(),plugin2.getGlobalRoutes=()=>this.getGlobalRoutes(),plugin2.model(this.definitions.type),plugin2.error(this.definitions.error);for(let{method,path,handler,hooks}of Object.values(plugin2.router.history))this.add(method,path,handler,mergeHook(hooks,{error:plugin2.event.error}));if(plugin2.compile(),plugin2===this)return;return this.propagatePromiseModules(plugin2),plugin2}if(typeof plugin2==="function")return plugin2(this);if(typeof plugin2.default==="function")return plugin2.default(this);return this._use(plugin2)}).then((v)=>{if(v&&typeof v.compile==="function")v.compile();return v})),this;return instance}this.propagatePromiseModules(plugin);let{name,seed}=plugin.config;if(plugin.getParent=()=>this,plugin.getServer=()=>this.getServer(),plugin.getGlobalRoutes=()=>this.getGlobalRoutes(),plugin.model(this.definitions.type),plugin.error(this.definitions.error),this["~parser"]={...plugin["~parser"],...this["~parser"]},this.headers(plugin.setHeaders),name){if(!(name in this.dependencies))this.dependencies[name]=[];let current=seed!==void 0?checksum(name+JSON.stringify(seed)):0;if(!this.dependencies[name].some(({checksum:checksum2})=>current===checksum2))this.extender.macros=this.extender.macros.concat(plugin.extender.macros),this.extender.higherOrderFunctions=this.extender.higherOrderFunctions.concat(plugin.extender.higherOrderFunctions)}else this.extender.macros=this.extender.macros.concat(plugin.extender.macros),this.extender.higherOrderFunctions=this.extender.higherOrderFunctions.concat(plugin.extender.higherOrderFunctions);deduplicateChecksum(this.extender.macros),deduplicateChecksum(this.extender.higherOrderFunctions);let hofHashes=[];for(let i=0;i<this.extender.higherOrderFunctions.length;i++){let hof=this.extender.higherOrderFunctions[i];if(hof.checksum){if(hofHashes.includes(hof.checksum))this.extender.higherOrderFunctions.splice(i,1),i--;hofHashes.push(hof.checksum)}}this.inference={body:this.inference.body||plugin.inference.body,cookie:this.inference.cookie||plugin.inference.cookie,headers:this.inference.headers||plugin.inference.headers,query:this.inference.query||plugin.inference.query,set:this.inference.set||plugin.inference.set,server:this.inference.server||plugin.inference.server,request:this.inference.request||plugin.inference.request,route:this.inference.route||plugin.inference.route},this.decorate(plugin.singleton.decorator),this.state(plugin.singleton.store),this.model(plugin.definitions.type),this.error(plugin.definitions.error),plugin.extender.macros=this.extender.macros.concat(plugin.extender.macros);for(let{method,path,handler,hooks}of Object.values(plugin.router.history))this.add(method,path,handler,mergeHook(hooks,{error:plugin.event.error}));if(name){if(!(name in this.dependencies))this.dependencies[name]=[];let current=seed!==void 0?checksum(name+JSON.stringify(seed)):0;if(this.dependencies[name].some(({checksum:checksum2})=>current===checksum2))return this;this.dependencies[name].push(this.config?.analytic?{name:plugin.config.name,seed:plugin.config.seed,checksum:current,dependencies:plugin.dependencies,stack:plugin.telemetry.stack,routes:plugin.router.history,decorators:plugin.singleton,store:plugin.singleton.store,error:plugin.definitions.error,derive:plugin.event.transform?.filter((x)=>x?.subType==="derive").map((x)=>({fn:x.toString(),stack:new Error().stack??""})),resolve:plugin.event.transform?.filter((x)=>x?.subType==="resolve").map((x)=>({fn:x.toString(),stack:new Error().stack??""}))}:{name:plugin.config.name,seed:plugin.config.seed,checksum:current,dependencies:plugin.dependencies}),this.event=mergeLifeCycle(this.event,filterGlobalHook(plugin.event),current)}else this.event=mergeLifeCycle(this.event,filterGlobalHook(plugin.event));return this.validator.global=mergeHook(this.validator.global,{...plugin.validator.global}),this.validator.local=mergeHook(this.validator.local,{...plugin.validator.scoped}),this}macro(macro){if(typeof macro==="function"){let hook={checksum:checksum(JSON.stringify({name:this.config.name,seed:this.config.seed,content:macro.toString()})),fn:macro};this.extender.macros.push(hook)}else if(typeof macro==="object"){for(let name of Object.keys(macro))if(typeof macro[name]==="object"){let actualValue={...macro[name]};macro[name]=(v)=>{if(v===!0)return actualValue}}let hook={checksum:checksum(JSON.stringify({name:this.config.name,seed:this.config.seed,content:Object.entries(macro).map(([k2,v])=>`${k2}+${v}`).join(",")})),fn:()=>macro};this.extender.macros.push(hook)}return this}mount(path,handle){if(path instanceof Elysia||typeof path==="function"||path.length===0||path==="/"){let run=typeof path==="function"?path:path instanceof Elysia?path.compile().fetch:handle instanceof Elysia?handle.compile().fetch:handle,handler2=({request,path:path2})=>run(new Request(replaceUrlPath(request.url,path2),{method:request.method,headers:request.headers,signal:request.signal,credentials:request.credentials,referrerPolicy:request.referrerPolicy,duplex:request.duplex,redirect:request.redirect,mode:request.mode,keepalive:request.keepalive,integrity:request.integrity,body:request.body}));return this.all("/*",handler2,{parse:"none"}),this}if(!handle)return this;let length=path.length-(path.endsWith("*")?1:0);if(handle instanceof Elysia)handle=handle.compile().fetch;let handler=({request,path:path2})=>handle(new Request(replaceUrlPath(request.url,path2.slice(length)||"/"),{method:request.method,headers:request.headers,signal:request.signal,credentials:request.credentials,referrerPolicy:request.referrerPolicy,duplex:request.duplex,redirect:request.redirect,mode:request.mode,keepalive:request.keepalive,integrity:request.integrity,body:request.body}));return this.all(path,handler,{parse:"none"}),this.all(path+(path.endsWith("/")?"*":"/*"),handler,{parse:"none"}),this}get(path,handler,hook){return this.add("GET",path,handler,hook),this}post(path,handler,hook){return this.add("POST",path,handler,hook),this}put(path,handler,hook){return this.add("PUT",path,handler,hook),this}patch(path,handler,hook){return this.add("PATCH",path,handler,hook),this}delete(path,handler,hook){return this.add("DELETE",path,handler,hook),this}options(path,handler,hook){return this.add("OPTIONS",path,handler,hook),this}all(path,handler,hook){return this.add("ALL",path,handler,hook),this}head(path,handler,hook){return this.add("HEAD",path,handler,hook),this}connect(path,handler,hook){return this.add("CONNECT",path,handler,hook),this}route(method,path,handler,hook){return this.add(method.toUpperCase(),path,handler,hook,hook?.config),this}ws(path,options){if(this["~adapter"].ws)this["~adapter"].ws(this,path,options);else console.warn("Current adapter doesn't support WebSocket");return this}state(options,name,value){if(name===void 0)value=options,options={as:"append"},name="";else if(value===void 0){if(typeof options==="string")value=name,name=options,options={as:"append"};else if(typeof options==="object")value=name,name=""}let{as}=options;if(typeof name!=="string")return this;switch(typeof value){case"object":if(name){if(name in this.singleton.store)this.singleton.store[name]=mergeDeep(this.singleton.store[name],value,{override:as==="override"});else this.singleton.store[name]=value;return this}if(value===null)return this;return this.singleton.store=mergeDeep(this.singleton.store,value,{override:as==="override"}),this;case"function":if(name){if(as==="override"||!(name in this.singleton.store))this.singleton.store[name]=value}else this.singleton.store=value(this.singleton.store);return this;default:if(as==="override"||!(name in this.singleton.store))this.singleton.store[name]=value;return this}}decorate(options,name,value){if(name===void 0)value=options,options={as:"append"},name="";else if(value===void 0){if(typeof options==="string")value=name,name=options,options={as:"append"};else if(typeof options==="object")value=name,name=""}let{as}=options;if(typeof name!=="string")return this;switch(typeof value){case"object":if(name){if(name in this.singleton.decorator)this.singleton.decorator[name]=mergeDeep(this.singleton.decorator[name],value,{override:as==="override"});else this.singleton.decorator[name]=value;return this}if(value===null)return this;return this.singleton.decorator=mergeDeep(this.singleton.decorator,value,{override:as==="override"}),this;case"function":if(name){if(as==="override"||!(name in this.singleton.decorator))this.singleton.decorator[name]=value}else this.singleton.decorator=value(this.singleton.decorator);return this;default:if(as==="override"||!(name in this.singleton.decorator))this.singleton.decorator[name]=value;return this}}derive(optionsOrTransform,transform2){if(!transform2)transform2=optionsOrTransform,optionsOrTransform={as:"local"};let hook={subType:"derive",fn:transform2};return this.onTransform(optionsOrTransform,hook)}model(name,model){let coerce=(schema)=>replaceSchemaType(schema,[{from:t.Number(),to:(options)=>t.Numeric(options),untilObjectFound:!0},{from:t.Boolean(),to:(options)=>t.BooleanString(options),untilObjectFound:!0}]);switch(typeof name){case"object":let parsedSchemas={},kvs=Object.entries(name);for(let[key,value]of kvs){if(key in this.definitions.type)continue;parsedSchemas[key]=this.definitions.type[key]=coerce(value),parsedSchemas[key].$id??=`#/components/schemas/${key}`}return this.definitions.typebox=t.Module({...this.definitions.typebox.$defs,...parsedSchemas}),this;case"function":let result=coerce(name(this.definitions.type));return this.definitions.type=result,this.definitions.typebox=t.Module(result),this;case"string":if(!model)break;let newModel={...model,id:model.$id??`#/components/schemas/${name}`};return this.definitions.type[name]=model,this.definitions.typebox=t.Module({...this.definitions.typebox.$defs,...newModel}),this}return this.definitions.type[name]=model,this.definitions.typebox=t.Module({...this.definitions.typebox.$defs,[name]:model}),this}mapDerive(optionsOrDerive,mapper){if(!mapper)mapper=optionsOrDerive,optionsOrDerive={as:"local"};let hook={subType:"mapDerive",fn:mapper};return this.onTransform(optionsOrDerive,hook)}affix(base,type2,word){if(word==="")return this;let delimieter=["_","-"," "],capitalize=(word2)=>word2[0].toUpperCase()+word2.slice(1),joinKey=base==="prefix"?(prefix,word2)=>delimieter.includes(prefix.at(-1)??"")?prefix+word2:prefix+capitalize(word2):delimieter.includes(word.at(-1)??"")?(suffix,word2)=>word2+suffix:(suffix,word2)=>word2+capitalize(suffix),remap=(type3)=>{let store={};switch(type3){case"decorator":for(let key in this.singleton.decorator)store[joinKey(word,key)]=this.singleton.decorator[key];this.singleton.decorator=store;break;case"state":for(let key in this.singleton.store)store[joinKey(word,key)]=this.singleton.store[key];this.singleton.store=store;break;case"model":for(let key in this.definitions.type)store[joinKey(word,key)]=this.definitions.type[key];this.definitions.type=store;break;case"error":for(let key in this.definitions.error)store[joinKey(word,key)]=this.definitions.error[key];this.definitions.error=store;break}},types=Array.isArray(type2)?type2:[type2];for(let type3 of types.some((x)=>x==="all")?["decorator","state","model","error"]:types)remap(type3);return this}prefix(type2,word){return this.affix("prefix",type2,word)}suffix(type2,word){return this.affix("suffix",type2,word)}compile(){if(this["~adapter"].isWebStandard){if(this.fetch=this.config.aot?composeGeneralHandler(this):createDynamicHandler(this),typeof this.server?.reload==="function")this.server.reload({...this.server||{},fetch:this.fetch});return this}if(typeof this.server?.reload==="function")this.server.reload(this.server||{});return this._handle=composeGeneralHandler(this),this}handle=async(request)=>this.fetch(request);fetch=(request)=>{return(this.fetch=this.config.aot?composeGeneralHandler(this):createDynamicHandler(this))(request)};handleError=async(context,error2)=>{return(this.handleError=this.config.aot?composeErrorHandler(this):createDynamicErrorHandler(this))(context,error2)};outerErrorHandler=(error2)=>new Response(error2.message||error2.name||"Error",{status:error2?.status??500});listen=(options,callback)=>{return this["~adapter"].listen(this)(options,callback),this};stop=async(closeActiveConnections)=>{if(!this.server)throw new Error("Elysia isn't running. Call `app.listen` to start the server.");if(this.server){if(this.server.stop(closeActiveConnections),this.server=null,this.event.stop?.length)for(let i=0;i<this.event.stop.length;i++)this.event.stop[i].fn(this)}};get modules(){return this.promisedModules}}var entityKind=Symbol.for("drizzle:entityKind"),hasOwnEntityKind=Symbol.for("drizzle:hasOwnEntityKind");function is(value,type2){if(!value||typeof value!=="object")return!1;if(value instanceof type2)return!0;if(!Object.prototype.hasOwnProperty.call(type2,entityKind))throw new Error(`Class "${type2.name??"<unknown>"}" doesn't look like a Drizzle entity. If this is incorrect and the class is provided by Drizzle, please report this as a bug.`);let cls=Object.getPrototypeOf(value).constructor;if(cls)while(cls){if(entityKind in cls&&cls[entityKind]===type2[entityKind])return!0;cls=Object.getPrototypeOf(cls)}return!1}class Column{constructor(table,config){this.table=table,this.config=config,this.name=config.name,this.keyAsName=config.keyAsName,this.notNull=config.notNull,this.default=config.default,this.defaultFn=config.defaultFn,this.onUpdateFn=config.onUpdateFn,this.hasDefault=config.hasDefault,this.primary=config.primaryKey,this.isUnique=config.isUnique,this.uniqueName=config.uniqueName,this.uniqueType=config.uniqueType,this.dataType=config.dataType,this.columnType=config.columnType,this.generated=config.generated,this.generatedIdentity=config.generatedIdentity}static[entityKind]="Column";name;keyAsName;primary;notNull;default;defaultFn;onUpdateFn;hasDefault;isUnique;uniqueName;uniqueType;dataType;columnType;enumValues=void 0;generated=void 0;generatedIdentity=void 0;config;mapFromDriverValue(value){return value}mapToDriverValue(value){return value}shouldDisableInsert(){return this.config.generated!==void 0&&this.config.generated.type!=="byDefault"}}class ColumnBuilder{static[entityKind]="ColumnBuilder";config;constructor(name,dataType,columnType){this.config={name,keyAsName:name==="",notNull:!1,default:void 0,hasDefault:!1,primaryKey:!1,isUnique:!1,uniqueName:void 0,uniqueType:void 0,dataType,columnType,generated:void 0}}$type(){return this}notNull(){return this.config.notNull=!0,this}default(value){return this.config.default=value,this.config.hasDefault=!0,this}$defaultFn(fn){return this.config.defaultFn=fn,this.config.hasDefault=!0,this}$default=this.$defaultFn;$onUpdateFn(fn){return this.config.onUpdateFn=fn,this.config.hasDefault=!0,this}$onUpdate=this.$onUpdateFn;primaryKey(){return this.config.primaryKey=!0,this.config.notNull=!0,this}setName(name){if(this.config.name!=="")return;this.config.name=name}}var TableName=Symbol.for("drizzle:Name");class ForeignKeyBuilder{static[entityKind]="PgForeignKeyBuilder";reference;_onUpdate="no action";_onDelete="no action";constructor(config,actions){if(this.reference=()=>{let{name,columns,foreignColumns}=config();return{name,columns,foreignTable:foreignColumns[0].table,foreignColumns}},actions)this._onUpdate=actions.onUpdate,this._onDelete=actions.onDelete}onUpdate(action){return this._onUpdate=action===void 0?"no action":action,this}onDelete(action){return this._onDelete=action===void 0?"no action":action,this}build(table){return new ForeignKey(table,this)}}class ForeignKey{constructor(table,builder){this.table=table,this.reference=builder.reference,this.onUpdate=builder._onUpdate,this.onDelete=builder._onDelete}static[entityKind]="PgForeignKey";reference;onUpdate;onDelete;getName(){let{name,columns,foreignColumns}=this.reference(),columnNames=columns.map((column)=>column.name),foreignColumnNames=foreignColumns.map((column)=>column.name),chunks=[this.table[TableName],...columnNames,foreignColumns[0].table[TableName],...foreignColumnNames];return name??`${chunks.join("_")}_fk`}}function iife(fn,...args){return fn(...args)}function uniqueKeyName(table,columns){return`${table[TableName]}_${columns.join("_")}_unique`}function parsePgArrayValue(arrayString,startFrom,inQuotes){for(let i=startFrom;i<arrayString.length;i++){let char=arrayString[i];if(char==="\\"){i++;continue}if(char==='"')return[arrayString.slice(startFrom,i).replace(/\\/g,""),i+1];if(inQuotes)continue;if(char===","||char==="}")return[arrayString.slice(startFrom,i).replace(/\\/g,""),i]}return[arrayString.slice(startFrom).replace(/\\/g,""),arrayString.length]}function parsePgNestedArray(arrayString,startFrom=0){let result=[],i=startFrom,lastCharIsComma=!1;while(i<arrayString.length){let char=arrayString[i];if(char===","){if(lastCharIsComma||i===startFrom)result.push("");lastCharIsComma=!0,i++;continue}if(lastCharIsComma=!1,char==="\\"){i+=2;continue}if(char==='"'){let[value2,startFrom2]=parsePgArrayValue(arrayString,i+1,!0);result.push(value2),i=startFrom2;continue}if(char==="}")return[result,i+1];if(char==="{"){let[value2,startFrom2]=parsePgNestedArray(arrayString,i+1);result.push(value2),i=startFrom2;continue}let[value,newStartFrom]=parsePgArrayValue(arrayString,i,!1);result.push(value),i=newStartFrom}return[result,i]}function parsePgArray(arrayString){let[result]=parsePgNestedArray(arrayString,1);return result}function makePgArray(array){return`{${array.map((item)=>{if(Array.isArray(item))return makePgArray(item);if(typeof item==="string")return`"${item.replace(/\\/g,"\\\\").replace(/"/g,"\\\"")}"`;return`${item}`}).join(",")}}`}class PgColumnBuilder extends ColumnBuilder{foreignKeyConfigs=[];static[entityKind]="PgColumnBuilder";array(size){return new PgArrayBuilder(this.config.name,this,size)}references(ref,actions={}){return this.foreignKeyConfigs.push({ref,actions}),this}unique(name,config){return this.config.isUnique=!0,this.config.uniqueName=name,this.config.uniqueType=config?.nulls,this}generatedAlwaysAs(as){return this.config.generated={as,type:"always",mode:"stored"},this}buildForeignKeys(column,table){return this.foreignKeyConfigs.map(({ref,actions})=>{return iife((ref2,actions2)=>{let builder=new ForeignKeyBuilder(()=>{let foreignColumn=ref2();return{columns:[column],foreignColumns:[foreignColumn]}});if(actions2.onUpdate)builder.onUpdate(actions2.onUpdate);if(actions2.onDelete)builder.onDelete(actions2.onDelete);return builder.build(table)},ref,actions)})}buildExtraConfigColumn(table){return new ExtraConfigColumn(table,this.config)}}class PgColumn extends Column{constructor(table,config){if(!config.uniqueName)config.uniqueName=uniqueKeyName(table,[config.name]);super(table,config);this.table=table}static[entityKind]="PgColumn"}class ExtraConfigColumn extends PgColumn{static[entityKind]="ExtraConfigColumn";getSQLType(){return this.getSQLType()}indexConfig={order:this.config.order??"asc",nulls:this.config.nulls??"last",opClass:this.config.opClass};defaultConfig={order:"asc",nulls:"last",opClass:void 0};asc(){return this.indexConfig.order="asc",this}desc(){return this.indexConfig.order="desc",this}nullsFirst(){return this.indexConfig.nulls="first",this}nullsLast(){return this.indexConfig.nulls="last",this}op(opClass){return this.indexConfig.opClass=opClass,this}}class IndexedColumn{static[entityKind]="IndexedColumn";constructor(name,keyAsName,type2,indexConfig){this.name=name,this.keyAsName=keyAsName,this.type=type2,this.indexConfig=indexConfig}name;keyAsName;type;indexConfig}class PgArrayBuilder extends PgColumnBuilder{static[entityKind]="PgArrayBuilder";constructor(name,baseBuilder,size){super(name,"array","PgArray");this.config.baseBuilder=baseBuilder,this.config.size=size}build(table){let baseColumn=this.config.baseBuilder.build(table);return new PgArray(table,this.config,baseColumn)}}class PgArray extends PgColumn{constructor(table,config,baseColumn,range){super(table,config);this.baseColumn=baseColumn,this.range=range,this.size=config.size}size;static[entityKind]="PgArray";getSQLType(){return`${this.baseColumn.getSQLType()}[${typeof this.size==="number"?this.size:""}]`}mapFromDriverValue(value){if(typeof value==="string")value=parsePgArray(value);return value.map((v)=>this.baseColumn.mapFromDriverValue(v))}mapToDriverValue(value,isNestedArray=!1){let a=value.map((v)=>v===null?null:is(this.baseColumn,PgArray)?this.baseColumn.mapToDriverValue(v,!0):this.baseColumn.mapToDriverValue(v));if(isNestedArray)return a;return makePgArray(a)}}class PgEnumObjectColumn extends PgColumn{static[entityKind]="PgEnumObjectColumn";enum;enumValues=this.config.enum.enumValues;constructor(table,config){super(table,config);this.enum=config.enum}getSQLType(){return this.enum.enumName}}var isPgEnumSym=Symbol.for("drizzle:isPgEnum");function isPgEnum(obj){return!!obj&&typeof obj==="function"&&isPgEnumSym in obj&&obj[isPgEnumSym]===!0}class PgEnumColumn extends PgColumn{static[entityKind]="PgEnumColumn";enum=this.config.enum;enumValues=this.config.enum.enumValues;constructor(table,config){super(table,config);this.enum=config.enum}getSQLType(){return this.enum.enumName}}class Subquery{static[entityKind]="Subquery";constructor(sql,selection,alias,isWith=!1){this._={brand:"Subquery",sql,selectedFields:selection,alias,isWith}}}class WithSubquery extends Subquery{static[entityKind]="WithSubquery"}var version="0.43.1";var otel,rawTracer,tracer={startActiveSpan(name,fn){if(!otel)return fn();if(!rawTracer)rawTracer=otel.trace.getTracer("drizzle-orm",version);return iife((otel2,rawTracer2)=>rawTracer2.startActiveSpan(name,(span)=>{try{return fn(span)}catch(e){throw span.setStatus({code:otel2.SpanStatusCode.ERROR,message:e instanceof Error?e.message:"Unknown error"}),e}finally{span.end()}}),otel,rawTracer)}};var ViewBaseConfig=Symbol.for("drizzle:ViewBaseConfig");var Schema=Symbol.for("drizzle:Schema"),Columns=Symbol.for("drizzle:Columns"),ExtraConfigColumns=Symbol.for("drizzle:ExtraConfigColumns"),OriginalName=Symbol.for("drizzle:OriginalName"),BaseName=Symbol.for("drizzle:BaseName"),IsAlias=Symbol.for("drizzle:IsAlias"),ExtraConfigBuilder=Symbol.for("drizzle:ExtraConfigBuilder"),IsDrizzleTable=Symbol.for("drizzle:IsDrizzleTable");class Table{static[entityKind]="Table";static Symbol={Name:TableName,Schema,OriginalName,Columns,ExtraConfigColumns,BaseName,IsAlias,ExtraConfigBuilder};[TableName];[OriginalName];[Schema];[Columns];[ExtraConfigColumns];[BaseName];[IsAlias]=!1;[IsDrizzleTable]=!0;[ExtraConfigBuilder]=void 0;constructor(name,schema,baseName){this[TableName]=this[OriginalName]=name,this[Schema]=schema,this[BaseName]=baseName}}function getTableName(table){return table[TableName]}function getTableUniqueName(table){return`${table[Schema]??"public"}.${table[TableName]}`}function isSQLWrapper(value){return value!==null&&value!==void 0&&typeof value.getSQL==="function"}function mergeQueries(queries){let result={sql:"",params:[]};for(let query of queries)if(result.sql+=query.sql,result.params.push(...query.params),query.typings?.length){if(!result.typings)result.typings=[];result.typings.push(...query.typings)}return result}class StringChunk{static[entityKind]="StringChunk";value;constructor(value){this.value=Array.isArray(value)?value:[value]}getSQL(){return new SQL([this])}}class SQL{constructor(queryChunks){this.queryChunks=queryChunks}static[entityKind]="SQL";decoder=noopDecoder;shouldInlineParams=!1;append(query){return this.queryChunks.push(...query.queryChunks),this}toQuery(config){return tracer.startActiveSpan("drizzle.buildSQL",(span)=>{let query=this.buildQueryFromSourceParams(this.queryChunks,config);return span?.setAttributes({"drizzle.query.text":query.sql,"drizzle.query.params":JSON.stringify(query.params)}),query})}buildQueryFromSourceParams(chunks,_config){let config=Object.assign({},_config,{inlineParams:_config.inlineParams||this.shouldInlineParams,paramStartIndex:_config.paramStartIndex||{value:0}}),{casing,escapeName,escapeParam,prepareTyping,inlineParams,paramStartIndex}=config;return mergeQueries(chunks.map((chunk)=>{if(is(chunk,StringChunk))return{sql:chunk.value.join(""),params:[]};if(is(chunk,Name))return{sql:escapeName(chunk.value),params:[]};if(chunk===void 0)return{sql:"",params:[]};if(Array.isArray(chunk)){let result=[new StringChunk("(")];for(let[i,p]of chunk.entries())if(result.push(p),i<chunk.length-1)result.push(new StringChunk(", "));return result.push(new StringChunk(")")),this.buildQueryFromSourceParams(result,config)}if(is(chunk,SQL))return this.buildQueryFromSourceParams(chunk.queryChunks,{...config,inlineParams:inlineParams||chunk.shouldInlineParams});if(is(chunk,Table)){let schemaName=chunk[Table.Symbol.Schema],tableName=chunk[Table.Symbol.Name];return{sql:schemaName===void 0||chunk[IsAlias]?escapeName(tableName):escapeName(schemaName)+"."+escapeName(tableName),params:[]}}if(is(chunk,Column)){let columnName=casing.getColumnCasing(chunk);if(_config.invokeSource==="indexes")return{sql:escapeName(columnName),params:[]};let schemaName=chunk.table[Table.Symbol.Schema];return{sql:chunk.table[IsAlias]||schemaName===void 0?escapeName(chunk.table[Table.Symbol.Name])+"."+escapeName(columnName):escapeName(schemaName)+"."+escapeName(chunk.table[Table.Symbol.Name])+"."+escapeName(columnName),params:[]}}if(is(chunk,View)){let schemaName=chunk[ViewBaseConfig].schema,viewName=chunk[ViewBaseConfig].name;return{sql:schemaName===void 0||chunk[ViewBaseConfig].isAlias?escapeName(viewName):escapeName(schemaName)+"."+escapeName(viewName),params:[]}}if(is(chunk,Param)){if(is(chunk.value,Placeholder))return{sql:escapeParam(paramStartIndex.value++,chunk),params:[chunk],typings:["none"]};let mappedValue=chunk.value===null?null:chunk.encoder.mapToDriverValue(chunk.value);if(is(mappedValue,SQL))return this.buildQueryFromSourceParams([mappedValue],config);if(inlineParams)return{sql:this.mapInlineParam(mappedValue,config),params:[]};let typings=["none"];if(prepareTyping)typings=[prepareTyping(chunk.encoder)];return{sql:escapeParam(paramStartIndex.value++,mappedValue),params:[mappedValue],typings}}if(is(chunk,Placeholder))return{sql:escapeParam(paramStartIndex.value++,chunk),params:[chunk],typings:["none"]};if(is(chunk,SQL.Aliased)&&chunk.fieldAlias!==void 0)return{sql:escapeName(chunk.fieldAlias),params:[]};if(is(chunk,Subquery)){if(chunk._.isWith)return{sql:escapeName(chunk._.alias),params:[]};return this.buildQueryFromSourceParams([new StringChunk("("),chunk._.sql,new StringChunk(") "),new Name(chunk._.alias)],config)}if(isPgEnum(chunk)){if(chunk.schema)return{sql:escapeName(chunk.schema)+"."+escapeName(chunk.enumName),params:[]};return{sql:escapeName(chunk.enumName),params:[]}}if(isSQLWrapper(chunk)){if(chunk.shouldOmitSQLParens?.())return this.buildQueryFromSourceParams([chunk.getSQL()],config);return this.buildQueryFromSourceParams([new StringChunk("("),chunk.getSQL(),new StringChunk(")")],config)}if(inlineParams)return{sql:this.mapInlineParam(chunk,config),params:[]};return{sql:escapeParam(paramStartIndex.value++,chunk),params:[chunk],typings:["none"]}}))}mapInlineParam(chunk,{escapeString}){if(chunk===null)return"null";if(typeof chunk==="number"||typeof chunk==="boolean")return chunk.toString();if(typeof chunk==="string")return escapeString(chunk);if(typeof chunk==="object"){let mappedValueAsString=chunk.toString();if(mappedValueAsString==="[object Object]")return escapeString(JSON.stringify(chunk));return escapeString(mappedValueAsString)}throw new Error("Unexpected param value: "+chunk)}getSQL(){return this}as(alias){if(alias===void 0)return this;return new SQL.Aliased(this,alias)}mapWith(decoder){return this.decoder=typeof decoder==="function"?{mapFromDriverValue:decoder}:decoder,this}inlineParams(){return this.shouldInlineParams=!0,this}if(condition){return condition?this:void 0}}class Name{constructor(value){this.value=value}static[entityKind]="Name";brand;getSQL(){return new SQL([this])}}function isDriverValueEncoder(value){return typeof value==="object"&&value!==null&&"mapToDriverValue"in value&&typeof value.mapToDriverValue==="function"}var noopDecoder={mapFromDriverValue:(value)=>value},noopEncoder={mapToDriverValue:(value)=>value},noopMapper={...noopDecoder,...noopEncoder};class Param{constructor(value,encoder2=noopEncoder){this.value=value,this.encoder=encoder2}static[entityKind]="Param";brand;getSQL(){return new SQL([this])}}function sql(strings,...params){let queryChunks=[];if(params.length>0||strings.length>0&&strings[0]!=="")queryChunks.push(new StringChunk(strings[0]));for(let[paramIndex,param2]of params.entries())queryChunks.push(param2,new StringChunk(strings[paramIndex+1]));return new SQL(queryChunks)}((sql2)=>{function empty(){return new SQL([])}sql2.empty=empty;function fromList(list){return new SQL(list)}sql2.fromList=fromList;function raw(str){return new SQL([new StringChunk(str)])}sql2.raw=raw;function join(chunks,separator){let result=[];for(let[i,chunk]of chunks.entries()){if(i>0&&separator!==void 0)result.push(separator);result.push(chunk)}return new SQL(result)}sql2.join=join;function identifier(value){return new Name(value)}sql2.identifier=identifier;function placeholder2(name2){return new Placeholder(name2)}sql2.placeholder=placeholder2;function param2(value,encoder2){return new Param(value,encoder2)}sql2.param=param2})(sql||(sql={}));((SQL2)=>{class Aliased{constructor(sql2,fieldAlias){this.sql=sql2,this.fieldAlias=fieldAlias}static[entityKind]="SQL.Aliased";isSelectionField=!1;getSQL(){return this.sql}clone(){return new Aliased(this.sql,this.fieldAlias)}}SQL2.Aliased=Aliased})(SQL||(SQL={}));class Placeholder{constructor(name2){this.name=name2}static[entityKind]="Placeholder";getSQL(){return new SQL([this])}}function fillPlaceholders(params,values){return params.map((p)=>{if(is(p,Placeholder)){if(!(p.name in values))throw new Error(`No value for placeholder "${p.name}" was provided`);return values[p.name]}if(is(p,Param)&&is(p.value,Placeholder)){if(!(p.value.name in values))throw new Error(`No value for placeholder "${p.value.name}" was provided`);return p.encoder.mapToDriverValue(values[p.value.name])}return p})}var IsDrizzleView=Symbol.for("drizzle:IsDrizzleView");class View{static[entityKind]="View";[ViewBaseConfig];[IsDrizzleView]=!0;constructor({name:name2,schema,selectedFields,query}){this[ViewBaseConfig]={name:name2,originalName:name2,schema,selectedFields,query,isExisting:!query,isAlias:!1}}getSQL(){return new SQL([this])}}Column.prototype.getSQL=function(){return new SQL([this])};Table.prototype.getSQL=function(){return new SQL([this])};Subquery.prototype.getSQL=function(){return new SQL([this])};class ColumnAliasProxyHandler{constructor(table){this.table=table}static[entityKind]="ColumnAliasProxyHandler";get(columnObj,prop){if(prop==="table")return this.table;return columnObj[prop]}}class TableAliasProxyHandler{constructor(alias,replaceOriginalName){this.alias=alias,this.replaceOriginalName=replaceOriginalName}static[entityKind]="TableAliasProxyHandler";get(target,prop){if(prop===Table.Symbol.IsAlias)return!0;if(prop===Table.Symbol.Name)return this.alias;if(this.replaceOriginalName&&prop===Table.Symbol.OriginalName)return this.alias;if(prop===ViewBaseConfig)return{...target[ViewBaseConfig],name:this.alias,isAlias:!0};if(prop===Table.Symbol.Columns){let columns=target[Table.Symbol.Columns];if(!columns)return columns;let proxiedColumns={};return Object.keys(columns).map((key)=>{proxiedColumns[key]=new Proxy(columns[key],new ColumnAliasProxyHandler(new Proxy(target,this)))}),proxiedColumns}let value=target[prop];if(is(value,Column))return new Proxy(value,new ColumnAliasProxyHandler(new Proxy(target,this)));return value}}function aliasedTable(table,tableAlias){return new Proxy(table,new TableAliasProxyHandler(tableAlias,!1))}function aliasedTableColumn(column,tableAlias){return new Proxy(column,new ColumnAliasProxyHandler(new Proxy(column.table,new TableAliasProxyHandler(tableAlias,!1))))}function mapColumnsInAliasedSQLToAlias(query,alias){return new SQL.Aliased(mapColumnsInSQLToAlias(query.sql,alias),query.fieldAlias)}function mapColumnsInSQLToAlias(query,alias){return sql.join(query.queryChunks.map((c)=>{if(is(c,Column))return aliasedTableColumn(c,alias);if(is(c,SQL))return mapColumnsInSQLToAlias(c,alias);if(is(c,SQL.Aliased))return mapColumnsInAliasedSQLToAlias(c,alias);return c}))}class DrizzleError extends Error{static[entityKind]="DrizzleError";constructor({message,cause}){super(message);this.name="DrizzleError",this.cause=cause}}class TransactionRollbackError extends DrizzleError{static[entityKind]="TransactionRollbackError";constructor(){super({message:"Rollback"})}}class ConsoleLogWriter{static[entityKind]="ConsoleLogWriter";write(message){console.log(message)}}class DefaultLogger{static[entityKind]="DefaultLogger";writer;constructor(config){this.writer=config?.writer??new ConsoleLogWriter}logQuery(query,params){let stringifiedParams=params.map((p)=>{try{return JSON.stringify(p)}catch{return String(p)}}),paramsStr=stringifiedParams.length?` -- params: [${stringifiedParams.join(", ")}]`:"";this.writer.write(`Query: ${query}${paramsStr}`)}}class NoopLogger{static[entityKind]="NoopLogger";logQuery(){}}class QueryPromise{static[entityKind]="QueryPromise";[Symbol.toStringTag]="QueryPromise";catch(onRejected){return this.then(void 0,onRejected)}finally(onFinally){return this.then((value)=>{return onFinally?.(),value},(reason)=>{throw onFinally?.(),reason})}then(onFulfilled,onRejected){return this.execute().then(onFulfilled,onRejected)}}function mapResultRow(columns,row,joinsNotNullableMap){let nullifyMap={},result=columns.reduce((result2,{path,field},columnIndex)=>{let decoder;if(is(field,Column))decoder=field;else if(is(field,SQL))decoder=field.decoder;else decoder=field.sql.decoder;let node=result2;for(let[pathChunkIndex,pathChunk]of path.entries())if(pathChunkIndex<path.length-1){if(!(pathChunk in node))node[pathChunk]={};node=node[pathChunk]}else{let rawValue=row[columnIndex],value=node[pathChunk]=rawValue===null?null:decoder.mapFromDriverValue(rawValue);if(joinsNotNullableMap&&is(field,Column)&&path.length===2){let objectName=path[0];if(!(objectName in nullifyMap))nullifyMap[objectName]=value===null?getTableName(field.table):!1;else if(typeof nullifyMap[objectName]==="string"&&nullifyMap[objectName]!==getTableName(field.table))nullifyMap[objectName]=!1}}return result2},{});if(joinsNotNullableMap&&Object.keys(nullifyMap).length>0){for(let[objectName,tableName]of Object.entries(nullifyMap))if(typeof tableName==="string"&&!joinsNotNullableMap[tableName])result[objectName]=null}return result}function orderSelectedFields(fields,pathPrefix){return Object.entries(fields).reduce((result,[name,field])=>{if(typeof name!=="string")return result;let newPath=pathPrefix?[...pathPrefix,name]:[name];if(is(field,Column)||is(field,SQL)||is(field,SQL.Aliased))result.push({path:newPath,field});else if(is(field,Table))result.push(...orderSelectedFields(field[Table.Symbol.Columns],newPath));else result.push(...orderSelectedFields(field,newPath));return result},[])}function haveSameKeys(left,right){let leftKeys=Object.keys(left),rightKeys=Object.keys(right);if(leftKeys.length!==rightKeys.length)return!1;for(let[index,key]of leftKeys.entries())if(key!==rightKeys[index])return!1;return!0}function mapUpdateSet(table,values){let entries=Object.entries(values).filter(([,value])=>value!==void 0).map(([key,value])=>{if(is(value,SQL)||is(value,Column))return[key,value];else return[key,new Param(value,table[Table.Symbol.Columns][key])]});if(entries.length===0)throw new Error("No values to set");return Object.fromEntries(entries)}function applyMixins(baseClass,extendedClasses){for(let extendedClass of extendedClasses)for(let name of Object.getOwnPropertyNames(extendedClass.prototype)){if(name==="constructor")continue;Object.defineProperty(baseClass.prototype,name,Object.getOwnPropertyDescriptor(extendedClass.prototype,name)||Object.create(null))}}function getTableColumns(table){return table[Table.Symbol.Columns]}function getTableLikeName(table){return is(table,Subquery)?table._.alias:is(table,View)?table[ViewBaseConfig].name:is(table,SQL)?void 0:table[Table.Symbol.IsAlias]?table[Table.Symbol.Name]:table[Table.Symbol.BaseName]}function getColumnNameAndConfig(a,b){return{name:typeof a==="string"&&a.length>0?a:"",config:typeof a==="object"?a:b}}function isConfig(data){if(typeof data!=="object"||data===null)return!1;if(data.constructor.name!=="Object")return!1;if("logger"in data){let type2=typeof data.logger;if(type2!=="boolean"&&(type2!=="object"||typeof data.logger.logQuery!=="function")&&type2!=="undefined")return!1;return!0}if("schema"in data){let type2=typeof data.schema;if(type2!=="object"&&type2!=="undefined")return!1;return!0}if("casing"in data){let type2=typeof data.casing;if(type2!=="string"&&type2!=="undefined")return!1;return!0}if("mode"in data){if(data.mode!=="default"||data.mode!=="planetscale"||data.mode!==void 0)return!1;return!0}if("connection"in data){let type2=typeof data.connection;if(type2!=="string"&&type2!=="object"&&type2!=="undefined")return!1;return!0}if("client"in data){let type2=typeof data.client;if(type2!=="object"&&type2!=="function"&&type2!=="undefined")return!1;return!0}if(Object.keys(data).length===0)return!0;return!1}class PgIntColumnBaseBuilder extends PgColumnBuilder{static[entityKind]="PgIntColumnBaseBuilder";generatedAlwaysAsIdentity(sequence){if(sequence){let{name,...options}=sequence;this.config.generatedIdentity={type:"always",sequenceName:name,sequenceOptions:options}}else this.config.generatedIdentity={type:"always"};return this.config.hasDefault=!0,this.config.notNull=!0,this}generatedByDefaultAsIdentity(sequence){if(sequence){let{name,...options}=sequence;this.config.generatedIdentity={type:"byDefault",sequenceName:name,sequenceOptions:options}}else this.config.generatedIdentity={type:"byDefault"};return this.config.hasDefault=!0,this.config.notNull=!0,this}}class PgBigInt53Builder extends PgIntColumnBaseBuilder{static[entityKind]="PgBigInt53Builder";constructor(name){super(name,"number","PgBigInt53")}build(table){return new PgBigInt53(table,this.config)}}class PgBigInt53 extends PgColumn{static[entityKind]="PgBigInt53";getSQLType(){return"bigint"}mapFromDriverValue(value){if(typeof value==="number")return value;return Number(value)}}class PgBigInt64Builder extends PgIntColumnBaseBuilder{static[entityKind]="PgBigInt64Builder";constructor(name){super(name,"bigint","PgBigInt64")}build(table){return new PgBigInt64(table,this.config)}}class PgBigInt64 extends PgColumn{static[entityKind]="PgBigInt64";getSQLType(){return"bigint"}mapFromDriverValue(value){return BigInt(value)}}function bigint(a,b){let{name,config}=getColumnNameAndConfig(a,b);if(config.mode==="number")return new PgBigInt53Builder(name);return new PgBigInt64Builder(name)}class PgBigSerial53Builder extends PgColumnBuilder{static[entityKind]="PgBigSerial53Builder";constructor(name){super(name,"number","PgBigSerial53");this.config.hasDefault=!0,this.config.notNull=!0}build(table){return new PgBigSerial53(table,this.config)}}class PgBigSerial53 extends PgColumn{static[entityKind]="PgBigSerial53";getSQLType(){return"bigserial"}mapFromDriverValue(value){if(typeof value==="number")return value;return Number(value)}}class PgBigSerial64Builder extends PgColumnBuilder{static[entityKind]="PgBigSerial64Builder";constructor(name){super(name,"bigint","PgBigSerial64");this.config.hasDefault=!0}build(table){return new PgBigSerial64(table,this.config)}}class PgBigSerial64 extends PgColumn{static[entityKind]="PgBigSerial64";getSQLType(){return"bigserial"}mapFromDriverValue(value){return BigInt(value)}}function bigserial(a,b){let{name,config}=getColumnNameAndConfig(a,b);if(config.mode==="number")return new PgBigSerial53Builder(name);return new PgBigSerial64Builder(name)}class PgBooleanBuilder extends PgColumnBuilder{static[entityKind]="PgBooleanBuilder";constructor(name){super(name,"boolean","PgBoolean")}build(table){return new PgBoolean(table,this.config)}}class PgBoolean extends PgColumn{static[entityKind]="PgBoolean";getSQLType(){return"boolean"}}function boolean(name){return new PgBooleanBuilder(name??"")}class PgCharBuilder extends PgColumnBuilder{static[entityKind]="PgCharBuilder";constructor(name,config){super(name,"string","PgChar");this.config.length=config.length,this.config.enumValues=config.enum}build(table){return new PgChar(table,this.config)}}class PgChar extends PgColumn{static[entityKind]="PgChar";length=this.config.length;enumValues=this.config.enumValues;getSQLType(){return this.length===void 0?"char":`char(${this.length})`}}function char(a,b={}){let{name,config}=getColumnNameAndConfig(a,b);return new PgCharBuilder(name,config)}class PgCidrBuilder extends PgColumnBuilder{static[entityKind]="PgCidrBuilder";constructor(name){super(name,"string","PgCidr")}build(table){return new PgCidr(table,this.config)}}class PgCidr extends PgColumn{static[entityKind]="PgCidr";getSQLType(){return"cidr"}}function cidr(name){return new PgCidrBuilder(name??"")}class PgCustomColumnBuilder extends PgColumnBuilder{static[entityKind]="PgCustomColumnBuilder";constructor(name,fieldConfig,customTypeParams){super(name,"custom","PgCustomColumn");this.config.fieldConfig=fieldConfig,this.config.customTypeParams=customTypeParams}build(table){return new PgCustomColumn(table,this.config)}}class PgCustomColumn extends PgColumn{static[entityKind]="PgCustomColumn";sqlName;mapTo;mapFrom;constructor(table,config){super(table,config);this.sqlName=config.customTypeParams.dataType(config.fieldConfig),this.mapTo=config.customTypeParams.toDriver,this.mapFrom=config.customTypeParams.fromDriver}getSQLType(){return this.sqlName}mapFromDriverValue(value){return typeof this.mapFrom==="function"?this.mapFrom(value):value}mapToDriverValue(value){return typeof this.mapTo==="function"?this.mapTo(value):value}}function customType(customTypeParams){return(a,b)=>{let{name,config}=getColumnNameAndConfig(a,b);return new PgCustomColumnBuilder(name,config,customTypeParams)}}class PgDateColumnBaseBuilder extends PgColumnBuilder{static[entityKind]="PgDateColumnBaseBuilder";defaultNow(){return this.default(sql`now()`)}}class PgDateBuilder extends PgDateColumnBaseBuilder{static[entityKind]="PgDateBuilder";constructor(name){super(name,"date","PgDate")}build(table){return new PgDate(table,this.config)}}class PgDate extends PgColumn{static[entityKind]="PgDate";getSQLType(){return"date"}mapFromDriverValue(value){return new Date(value)}mapToDriverValue(value){return value.toISOString()}}class PgDateStringBuilder extends PgDateColumnBaseBuilder{static[entityKind]="PgDateStringBuilder";constructor(name){super(name,"string","PgDateString")}build(table){return new PgDateString(table,this.config)}}class PgDateString extends PgColumn{static[entityKind]="PgDateString";getSQLType(){return"date"}}function date2(a,b){let{name,config}=getColumnNameAndConfig(a,b);if(config?.mode==="date")return new PgDateBuilder(name);return new PgDateStringBuilder(name)}class PgDoublePrecisionBuilder extends PgColumnBuilder{static[entityKind]="PgDoublePrecisionBuilder";constructor(name){super(name,"number","PgDoublePrecision")}build(table){return new PgDoublePrecision(table,this.config)}}class PgDoublePrecision extends PgColumn{static[entityKind]="PgDoublePrecision";getSQLType(){return"double precision"}mapFromDriverValue(value){if(typeof value==="string")return Number.parseFloat(value);return value}}function doublePrecision(name){return new PgDoublePrecisionBuilder(name??"")}class PgInetBuilder extends PgColumnBuilder{static[entityKind]="PgInetBuilder";constructor(name){super(name,"string","PgInet")}build(table){return new PgInet(table,this.config)}}class PgInet extends PgColumn{static[entityKind]="PgInet";getSQLType(){return"inet"}}function inet(name){return new PgInetBuilder(name??"")}class PgIntegerBuilder extends PgIntColumnBaseBuilder{static[entityKind]="PgIntegerBuilder";constructor(name){super(name,"number","PgInteger")}build(table){return new PgInteger(table,this.config)}}class PgInteger extends PgColumn{static[entityKind]="PgInteger";getSQLType(){return"integer"}mapFromDriverValue(value){if(typeof value==="string")return Number.parseInt(value);return value}}function integer(name){return new PgIntegerBuilder(name??"")}class PgIntervalBuilder extends PgColumnBuilder{static[entityKind]="PgIntervalBuilder";constructor(name,intervalConfig){super(name,"string","PgInterval");this.config.intervalConfig=intervalConfig}build(table){return new PgInterval(table,this.config)}}class PgInterval extends PgColumn{static[entityKind]="PgInterval";fields=this.config.intervalConfig.fields;precision=this.config.intervalConfig.precision;getSQLType(){let fields=this.fields?` ${this.fields}`:"",precision=this.precision?`(${this.precision})`:"";return`interval${fields}${precision}`}}function interval(a,b={}){let{name,config}=getColumnNameAndConfig(a,b);return new PgIntervalBuilder(name,config)}class PgJsonBuilder extends PgColumnBuilder{static[entityKind]="PgJsonBuilder";constructor(name){super(name,"json","PgJson")}build(table){return new PgJson(table,this.config)}}class PgJson extends PgColumn{static[entityKind]="PgJson";constructor(table,config){super(table,config)}getSQLType(){return"json"}mapToDriverValue(value){return JSON.stringify(value)}mapFromDriverValue(value){if(typeof value==="string")try{return JSON.parse(value)}catch{return value}return value}}function json(name){return new PgJsonBuilder(name??"")}class PgJsonbBuilder extends PgColumnBuilder{static[entityKind]="PgJsonbBuilder";constructor(name){super(name,"json","PgJsonb")}build(table){return new PgJsonb(table,this.config)}}class PgJsonb extends PgColumn{static[entityKind]="PgJsonb";constructor(table,config){super(table,config)}getSQLType(){return"jsonb"}mapToDriverValue(value){return JSON.stringify(value)}mapFromDriverValue(value){if(typeof value==="string")try{return JSON.parse(value)}catch{return value}return value}}function jsonb(name){return new PgJsonbBuilder(name??"")}class PgLineBuilder extends PgColumnBuilder{static[entityKind]="PgLineBuilder";constructor(name){super(name,"array","PgLine")}build(table){return new PgLineTuple(table,this.config)}}class PgLineTuple extends PgColumn{static[entityKind]="PgLine";getSQLType(){return"line"}mapFromDriverValue(value){let[a,b,c]=value.slice(1,-1).split(",");return[Number.parseFloat(a),Number.parseFloat(b),Number.parseFloat(c)]}mapToDriverValue(value){return`{${value[0]},${value[1]},${value[2]}}`}}class PgLineABCBuilder extends PgColumnBuilder{static[entityKind]="PgLineABCBuilder";constructor(name){super(name,"json","PgLineABC")}build(table){return new PgLineABC(table,this.config)}}class PgLineABC extends PgColumn{static[entityKind]="PgLineABC";getSQLType(){return"line"}mapFromDriverValue(value){let[a,b,c]=value.slice(1,-1).split(",");return{a:Number.parseFloat(a),b:Number.parseFloat(b),c:Number.parseFloat(c)}}mapToDriverValue(value){return`{${value.a},${value.b},${value.c}}`}}function line(a,b){let{name,config}=getColumnNameAndConfig(a,b);if(!config?.mode||config.mode==="tuple")return new PgLineBuilder(name);return new PgLineABCBuilder(name)}class PgMacaddrBuilder extends PgColumnBuilder{static[entityKind]="PgMacaddrBuilder";constructor(name){super(name,"string","PgMacaddr")}build(table){return new PgMacaddr(table,this.config)}}class PgMacaddr extends PgColumn{static[entityKind]="PgMacaddr";getSQLType(){return"macaddr"}}function macaddr(name){return new PgMacaddrBuilder(name??"")}class PgMacaddr8Builder extends PgColumnBuilder{static[entityKind]="PgMacaddr8Builder";constructor(name){super(name,"string","PgMacaddr8")}build(table){return new PgMacaddr8(table,this.config)}}class PgMacaddr8 extends PgColumn{static[entityKind]="PgMacaddr8";getSQLType(){return"macaddr8"}}function macaddr8(name){return new PgMacaddr8Builder(name??"")}class PgNumericBuilder extends PgColumnBuilder{static[entityKind]="PgNumericBuilder";constructor(name,precision,scale){super(name,"string","PgNumeric");this.config.precision=precision,this.config.scale=scale}build(table){return new PgNumeric(table,this.config)}}class PgNumeric extends PgColumn{static[entityKind]="PgNumeric";precision;scale;constructor(table,config){super(table,config);this.precision=config.precision,this.scale=config.scale}mapFromDriverValue(value){if(typeof value==="string")return value;return String(value)}getSQLType(){if(this.precision!==void 0&&this.scale!==void 0)return`numeric(${this.precision}, ${this.scale})`;else if(this.precision===void 0)return"numeric";else return`numeric(${this.precision})`}}class PgNumericNumberBuilder extends PgColumnBuilder{static[entityKind]="PgNumericNumberBuilder";constructor(name,precision,scale){super(name,"number","PgNumericNumber");this.config.precision=precision,this.config.scale=scale}build(table){return new PgNumericNumber(table,this.config)}}class PgNumericNumber extends PgColumn{static[entityKind]="PgNumericNumber";precision;scale;constructor(table,config){super(table,config);this.precision=config.precision,this.scale=config.scale}mapFromDriverValue(value){if(typeof value==="number")return value;return Number(value)}mapToDriverValue=String;getSQLType(){if(this.precision!==void 0&&this.scale!==void 0)return`numeric(${this.precision}, ${this.scale})`;else if(this.precision===void 0)return"numeric";else return`numeric(${this.precision})`}}class PgNumericBigIntBuilder extends PgColumnBuilder{static[entityKind]="PgNumericBigIntBuilder";constructor(name,precision,scale){super(name,"bigint","PgNumericBigInt");this.config.precision=precision,this.config.scale=scale}build(table){return new PgNumericBigInt(table,this.config)}}class PgNumericBigInt extends PgColumn{static[entityKind]="PgNumericBigInt";precision;scale;constructor(table,config){super(table,config);this.precision=config.precision,this.scale=config.scale}mapFromDriverValue=BigInt;mapToDriverValue=String;getSQLType(){if(this.precision!==void 0&&this.scale!==void 0)return`numeric(${this.precision}, ${this.scale})`;else if(this.precision===void 0)return"numeric";else return`numeric(${this.precision})`}}function numeric(a,b){let{name,config}=getColumnNameAndConfig(a,b),mode=config?.mode;return mode==="number"?new PgNumericNumberBuilder(name,config?.precision,config?.scale):mode==="bigint"?new PgNumericBigIntBuilder(name,config?.precision,config?.scale):new PgNumericBuilder(name,config?.precision,config?.scale)}var decimal=numeric;class PgPointTupleBuilder extends PgColumnBuilder{static[entityKind]="PgPointTupleBuilder";constructor(name){super(name,"array","PgPointTuple")}build(table){return new PgPointTuple(table,this.config)}}class PgPointTuple extends PgColumn{static[entityKind]="PgPointTuple";getSQLType(){return"point"}mapFromDriverValue(value){if(typeof value==="string"){let[x,y]=value.slice(1,-1).split(",");return[Number.parseFloat(x),Number.parseFloat(y)]}return[value.x,value.y]}mapToDriverValue(value){return`(${value[0]},${value[1]})`}}class PgPointObjectBuilder extends PgColumnBuilder{static[entityKind]="PgPointObjectBuilder";constructor(name){super(name,"json","PgPointObject")}build(table){return new PgPointObject(table,this.config)}}class PgPointObject extends PgColumn{static[entityKind]="PgPointObject";getSQLType(){return"point"}mapFromDriverValue(value){if(typeof value==="string"){let[x,y]=value.slice(1,-1).split(",");return{x:Number.parseFloat(x),y:Number.parseFloat(y)}}return value}mapToDriverValue(value){return`(${value.x},${value.y})`}}function point(a,b){let{name,config}=getColumnNameAndConfig(a,b);if(!config?.mode||config.mode==="tuple")return new PgPointTupleBuilder(name);return new PgPointObjectBuilder(name)}function hexToBytes(hex2){let bytes=[];for(let c=0;c<hex2.length;c+=2)bytes.push(Number.parseInt(hex2.slice(c,c+2),16));return new Uint8Array(bytes)}function bytesToFloat64(bytes,offset){let buffer=new ArrayBuffer(8),view=new DataView(buffer);for(let i=0;i<8;i++)view.setUint8(i,bytes[offset+i]);return view.getFloat64(0,!0)}function parseEWKB(hex2){let bytes=hexToBytes(hex2),offset=0,byteOrder=bytes[offset];offset+=1;let view=new DataView(bytes.buffer),geomType=view.getUint32(offset,byteOrder===1);offset+=4;let _srid;if(geomType&536870912)_srid=view.getUint32(offset,byteOrder===1),offset+=4;if((geomType&65535)===1){let x=bytesToFloat64(bytes,offset);offset+=8;let y=bytesToFloat64(bytes,offset);return offset+=8,[x,y]}throw new Error("Unsupported geometry type")}class PgGeometryBuilder extends PgColumnBuilder{static[entityKind]="PgGeometryBuilder";constructor(name){super(name,"array","PgGeometry")}build(table){return new PgGeometry(table,this.config)}}class PgGeometry extends PgColumn{static[entityKind]="PgGeometry";getSQLType(){return"geometry(point)"}mapFromDriverValue(value){return parseEWKB(value)}mapToDriverValue(value){return`point(${value[0]} ${value[1]})`}}class PgGeometryObjectBuilder extends PgColumnBuilder{static[entityKind]="PgGeometryObjectBuilder";constructor(name){super(name,"json","PgGeometryObject")}build(table){return new PgGeometryObject(table,this.config)}}class PgGeometryObject extends PgColumn{static[entityKind]="PgGeometryObject";getSQLType(){return"geometry(point)"}mapFromDriverValue(value){let parsed=parseEWKB(value);return{x:parsed[0],y:parsed[1]}}mapToDriverValue(value){return`point(${value.x} ${value.y})`}}function geometry(a,b){let{name,config}=getColumnNameAndConfig(a,b);if(!config?.mode||config.mode==="tuple")return new PgGeometryBuilder(name);return new PgGeometryObjectBuilder(name)}class PgRealBuilder extends PgColumnBuilder{static[entityKind]="PgRealBuilder";constructor(name,length){super(name,"number","PgReal");this.config.length=length}build(table){return new PgReal(table,this.config)}}class PgReal extends PgColumn{static[entityKind]="PgReal";constructor(table,config){super(table,config)}getSQLType(){return"real"}mapFromDriverValue=(value)=>{if(typeof value==="string")return Number.parseFloat(value);return value}}function real(name){return new PgRealBuilder(name??"")}class PgSerialBuilder extends PgColumnBuilder{static[entityKind]="PgSerialBuilder";constructor(name){super(name,"number","PgSerial");this.config.hasDefault=!0,this.config.notNull=!0}build(table){return new PgSerial(table,this.config)}}class PgSerial extends PgColumn{static[entityKind]="PgSerial";getSQLType(){return"serial"}}function serial(name){return new PgSerialBuilder(name??"")}class PgSmallIntBuilder extends PgIntColumnBaseBuilder{static[entityKind]="PgSmallIntBuilder";constructor(name){super(name,"number","PgSmallInt")}build(table){return new PgSmallInt(table,this.config)}}class PgSmallInt extends PgColumn{static[entityKind]="PgSmallInt";getSQLType(){return"smallint"}mapFromDriverValue=(value)=>{if(typeof value==="string")return Number(value);return value}}function smallint(name){return new PgSmallIntBuilder(name??"")}class PgSmallSerialBuilder extends PgColumnBuilder{static[entityKind]="PgSmallSerialBuilder";constructor(name){super(name,"number","PgSmallSerial");this.config.hasDefault=!0,this.config.notNull=!0}build(table){return new PgSmallSerial(table,this.config)}}class PgSmallSerial extends PgColumn{static[entityKind]="PgSmallSerial";getSQLType(){return"smallserial"}}function smallserial(name){return new PgSmallSerialBuilder(name??"")}class PgTextBuilder extends PgColumnBuilder{static[entityKind]="PgTextBuilder";constructor(name,config){super(name,"string","PgText");this.config.enumValues=config.enum}build(table){return new PgText(table,this.config)}}class PgText extends PgColumn{static[entityKind]="PgText";enumValues=this.config.enumValues;getSQLType(){return"text"}}function text(a,b={}){let{name,config}=getColumnNameAndConfig(a,b);return new PgTextBuilder(name,config)}class PgTimeBuilder extends PgDateColumnBaseBuilder{constructor(name,withTimezone,precision){super(name,"string","PgTime");this.withTimezone=withTimezone,this.precision=precision,this.config.withTimezone=withTimezone,this.config.precision=precision}static[entityKind]="PgTimeBuilder";build(table){return new PgTime(table,this.config)}}class PgTime extends PgColumn{static[entityKind]="PgTime";withTimezone;precision;constructor(table,config){super(table,config);this.withTimezone=config.withTimezone,this.precision=config.precision}getSQLType(){return`time${this.precision===void 0?"":`(${this.precision})`}${this.withTimezone?" with time zone":""}`}}function time(a,b={}){let{name,config}=getColumnNameAndConfig(a,b);return new PgTimeBuilder(name,config.withTimezone??!1,config.precision)}class PgTimestampBuilder extends PgDateColumnBaseBuilder{static[entityKind]="PgTimestampBuilder";constructor(name,withTimezone,precision){super(name,"date","PgTimestamp");this.config.withTimezone=withTimezone,this.config.precision=precision}build(table){return new PgTimestamp(table,this.config)}}class PgTimestamp extends PgColumn{static[entityKind]="PgTimestamp";withTimezone;precision;constructor(table,config){super(table,config);this.withTimezone=config.withTimezone,this.precision=config.precision}getSQLType(){return`timestamp${this.precision===void 0?"":` (${this.precision})`}${this.withTimezone?" with time zone":""}`}mapFromDriverValue=(value)=>{return new Date(this.withTimezone?value:value+"+0000")};mapToDriverValue=(value)=>{return value.toISOString()}}class PgTimestampStringBuilder extends PgDateColumnBaseBuilder{static[entityKind]="PgTimestampStringBuilder";constructor(name,withTimezone,precision){super(name,"string","PgTimestampString");this.config.withTimezone=withTimezone,this.config.precision=precision}build(table){return new PgTimestampString(table,this.config)}}class PgTimestampString extends PgColumn{static[entityKind]="PgTimestampString";withTimezone;precision;constructor(table,config){super(table,config);this.withTimezone=config.withTimezone,this.precision=config.precision}getSQLType(){return`timestamp${this.precision===void 0?"":`(${this.precision})`}${this.withTimezone?" with time zone":""}`}}function timestamp(a,b={}){let{name,config}=getColumnNameAndConfig(a,b);if(config?.mode==="string")return new PgTimestampStringBuilder(name,config.withTimezone??!1,config.precision);return new PgTimestampBuilder(name,config?.withTimezone??!1,config?.precision)}class PgUUIDBuilder extends PgColumnBuilder{static[entityKind]="PgUUIDBuilder";constructor(name){super(name,"string","PgUUID")}defaultRandom(){return this.default(sql`gen_random_uuid()`)}build(table){return new PgUUID(table,this.config)}}class PgUUID extends PgColumn{static[entityKind]="PgUUID";getSQLType(){return"uuid"}}function uuid(name){return new PgUUIDBuilder(name??"")}class PgVarcharBuilder extends PgColumnBuilder{static[entityKind]="PgVarcharBuilder";constructor(name,config){super(name,"string","PgVarchar");this.config.length=config.length,this.config.enumValues=config.enum}build(table){return new PgVarchar(table,this.config)}}class PgVarchar extends PgColumn{static[entityKind]="PgVarchar";length=this.config.length;enumValues=this.config.enumValues;getSQLType(){return this.length===void 0?"varchar":`varchar(${this.length})`}}function varchar(a,b={}){let{name,config}=getColumnNameAndConfig(a,b);return new PgVarcharBuilder(name,config)}class PgBinaryVectorBuilder extends PgColumnBuilder{static[entityKind]="PgBinaryVectorBuilder";constructor(name,config){super(name,"string","PgBinaryVector");this.config.dimensions=config.dimensions}build(table){return new PgBinaryVector(table,this.config)}}class PgBinaryVector extends PgColumn{static[entityKind]="PgBinaryVector";dimensions=this.config.dimensions;getSQLType(){return`bit(${this.dimensions})`}}function bit(a,b){let{name,config}=getColumnNameAndConfig(a,b);return new PgBinaryVectorBuilder(name,config)}class PgHalfVectorBuilder extends PgColumnBuilder{static[entityKind]="PgHalfVectorBuilder";constructor(name,config){super(name,"array","PgHalfVector");this.config.dimensions=config.dimensions}build(table){return new PgHalfVector(table,this.config)}}class PgHalfVector extends PgColumn{static[entityKind]="PgHalfVector";dimensions=this.config.dimensions;getSQLType(){return`halfvec(${this.dimensions})`}mapToDriverValue(value){return JSON.stringify(value)}mapFromDriverValue(value){return value.slice(1,-1).split(",").map((v)=>Number.parseFloat(v))}}function halfvec(a,b){let{name,config}=getColumnNameAndConfig(a,b);return new PgHalfVectorBuilder(name,config)}class PgSparseVectorBuilder extends PgColumnBuilder{static[entityKind]="PgSparseVectorBuilder";constructor(name,config){super(name,"string","PgSparseVector");this.config.dimensions=config.dimensions}build(table){return new PgSparseVector(table,this.config)}}class PgSparseVector extends PgColumn{static[entityKind]="PgSparseVector";dimensions=this.config.dimensions;getSQLType(){return`sparsevec(${this.dimensions})`}}function sparsevec(a,b){let{name,config}=getColumnNameAndConfig(a,b);return new PgSparseVectorBuilder(name,config)}class PgVectorBuilder extends PgColumnBuilder{static[entityKind]="PgVectorBuilder";constructor(name,config){super(name,"array","PgVector");this.config.dimensions=config.dimensions}build(table){return new PgVector(table,this.config)}}class PgVector extends PgColumn{static[entityKind]="PgVector";dimensions=this.config.dimensions;getSQLType(){return`vector(${this.dimensions})`}mapToDriverValue(value){return JSON.stringify(value)}mapFromDriverValue(value){return value.slice(1,-1).split(",").map((v)=>Number.parseFloat(v))}}function vector(a,b){let{name,config}=getColumnNameAndConfig(a,b);return new PgVectorBuilder(name,config)}function getPgColumnBuilders(){return{bigint,bigserial,boolean,char,cidr,customType,date:date2,doublePrecision,inet,integer,interval,json,jsonb,line,macaddr,macaddr8,numeric,point,geometry,real,serial,smallint,smallserial,text,time,timestamp,uuid,varchar,bit,halfvec,sparsevec,vector}}var InlineForeignKeys=Symbol.for("drizzle:PgInlineForeignKeys"),EnableRLS=Symbol.for("drizzle:EnableRLS");class PgTable extends Table{static[entityKind]="PgTable";static Symbol=Object.assign({},Table.Symbol,{InlineForeignKeys,EnableRLS});[InlineForeignKeys]=[];[EnableRLS]=!1;[Table.Symbol.ExtraConfigBuilder]=void 0;[Table.Symbol.ExtraConfigColumns]={}}function pgTableWithSchema(name,columns,extraConfig,schema,baseName=name){let rawTable=new PgTable(name,schema,baseName),parsedColumns=typeof columns==="function"?columns(getPgColumnBuilders()):columns,builtColumns=Object.fromEntries(Object.entries(parsedColumns).map(([name2,colBuilderBase])=>{let colBuilder=colBuilderBase;colBuilder.setName(name2);let column=colBuilder.build(rawTable);return rawTable[InlineForeignKeys].push(...colBuilder.buildForeignKeys(column,rawTable)),[name2,column]})),builtColumnsForExtraConfig=Object.fromEntries(Object.entries(parsedColumns).map(([name2,colBuilderBase])=>{let colBuilder=colBuilderBase;colBuilder.setName(name2);let column=colBuilder.buildExtraConfigColumn(rawTable);return[name2,column]})),table=Object.assign(rawTable,builtColumns);if(table[Table.Symbol.Columns]=builtColumns,table[Table.Symbol.ExtraConfigColumns]=builtColumnsForExtraConfig,extraConfig)table[PgTable.Symbol.ExtraConfigBuilder]=extraConfig;return Object.assign(table,{enableRLS:()=>{return table[PgTable.Symbol.EnableRLS]=!0,table}})}var pgTable=(name,columns,extraConfig)=>{return pgTableWithSchema(name,columns,extraConfig,void 0)};class PrimaryKeyBuilder{static[entityKind]="PgPrimaryKeyBuilder";columns;name;constructor(columns,name){this.columns=columns,this.name=name}build(table){return new PrimaryKey(table,this.columns,this.name)}}class PrimaryKey{constructor(table,columns,name){this.table=table,this.columns=columns,this.name=name}static[entityKind]="PgPrimaryKey";columns;name;getName(){return this.name??`${this.table[PgTable.Symbol.Name]}_${this.columns.map((column)=>column.name).join("_")}_pk`}}function bindIfParam(value,column){if(isDriverValueEncoder(column)&&!isSQLWrapper(value)&&!is(value,Param)&&!is(value,Placeholder)&&!is(value,Column)&&!is(value,Table)&&!is(value,View))return new Param(value,column);return value}var eq=(left,right)=>{return sql`${left} = ${bindIfParam(right,left)}`},ne=(left,right)=>{return sql`${left} <> ${bindIfParam(right,left)}`};function and(...unfilteredConditions){let conditions=unfilteredConditions.filter((c)=>c!==void 0);if(conditions.length===0)return;if(conditions.length===1)return new SQL(conditions);return new SQL([new StringChunk("("),sql.join(conditions,new StringChunk(" and ")),new StringChunk(")")])}function or(...unfilteredConditions){let conditions=unfilteredConditions.filter((c)=>c!==void 0);if(conditions.length===0)return;if(conditions.length===1)return new SQL(conditions);return new SQL([new StringChunk("("),sql.join(conditions,new StringChunk(" or ")),new StringChunk(")")])}function not(condition){return sql`not ${condition}`}var gt=(left,right)=>{return sql`${left} > ${bindIfParam(right,left)}`},gte=(left,right)=>{return sql`${left} >= ${bindIfParam(right,left)}`},lt=(left,right)=>{return sql`${left} < ${bindIfParam(right,left)}`},lte=(left,right)=>{return sql`${left} <= ${bindIfParam(right,left)}`};function inArray(column,values){if(Array.isArray(values)){if(values.length===0)return sql`false`;return sql`${column} in ${values.map((v)=>bindIfParam(v,column))}`}return sql`${column} in ${bindIfParam(values,column)}`}function notInArray(column,values){if(Array.isArray(values)){if(values.length===0)return sql`true`;return sql`${column} not in ${values.map((v)=>bindIfParam(v,column))}`}return sql`${column} not in ${bindIfParam(values,column)}`}function isNull(value){return sql`${value} is null`}function isNotNull(value){return sql`${value} is not null`}function exists(subquery){return sql`exists ${subquery}`}function notExists(subquery){return sql`not exists ${subquery}`}function between(column,min,max){return sql`${column} between ${bindIfParam(min,column)} and ${bindIfParam(max,column)}`}function notBetween(column,min,max){return sql`${column} not between ${bindIfParam(min,column)} and ${bindIfParam(max,column)}`}function like(column,value){return sql`${column} like ${value}`}function notLike(column,value){return sql`${column} not like ${value}`}function ilike(column,value){return sql`${column} ilike ${value}`}function notIlike(column,value){return sql`${column} not ilike ${value}`}function asc(column){return sql`${column} asc`}function desc(column){return sql`${column} desc`}class Relation{constructor(sourceTable,referencedTable,relationName){this.sourceTable=sourceTable,this.referencedTable=referencedTable,this.relationName=relationName,this.referencedTableName=referencedTable[Table.Symbol.Name]}static[entityKind]="Relation";referencedTableName;fieldName}class Relations{constructor(table,config){this.table=table,this.config=config}static[entityKind]="Relations"}class One extends Relation{constructor(sourceTable,referencedTable,config,isNullable){super(sourceTable,referencedTable,config?.relationName);this.config=config,this.isNullable=isNullable}static[entityKind]="One";withFieldName(fieldName){let relation=new One(this.sourceTable,this.referencedTable,this.config,this.isNullable);return relation.fieldName=fieldName,relation}}class Many extends Relation{constructor(sourceTable,referencedTable,config){super(sourceTable,referencedTable,config?.relationName);this.config=config}static[entityKind]="Many";withFieldName(fieldName){let relation=new Many(this.sourceTable,this.referencedTable,this.config);return relation.fieldName=fieldName,relation}}function getOperators(){return{and,between,eq,exists,gt,gte,ilike,inArray,isNull,isNotNull,like,lt,lte,ne,not,notBetween,notExists,notLike,notIlike,notInArray,or,sql}}function getOrderByOperators(){return{sql,asc,desc}}function extractTablesRelationalConfig(schema,configHelpers){if(Object.keys(schema).length===1&&"default"in schema&&!is(schema.default,Table))schema=schema.default;let tableNamesMap={},relationsBuffer={},tablesConfig={};for(let[key,value]of Object.entries(schema))if(is(value,Table)){let dbName=getTableUniqueName(value),bufferedRelations=relationsBuffer[dbName];tableNamesMap[dbName]=key,tablesConfig[key]={tsName:key,dbName:value[Table.Symbol.Name],schema:value[Table.Symbol.Schema],columns:value[Table.Symbol.Columns],relations:bufferedRelations?.relations??{},primaryKey:bufferedRelations?.primaryKey??[]};for(let column of Object.values(value[Table.Symbol.Columns]))if(column.primary)tablesConfig[key].primaryKey.push(column);let extraConfig=value[Table.Symbol.ExtraConfigBuilder]?.(value[Table.Symbol.ExtraConfigColumns]);if(extraConfig){for(let configEntry of Object.values(extraConfig))if(is(configEntry,PrimaryKeyBuilder))tablesConfig[key].primaryKey.push(...configEntry.columns)}}else if(is(value,Relations)){let dbName=getTableUniqueName(value.table),tableName=tableNamesMap[dbName],relations2=value.config(configHelpers(value.table)),primaryKey;for(let[relationName,relation]of Object.entries(relations2))if(tableName){let tableConfig=tablesConfig[tableName];if(tableConfig.relations[relationName]=relation,primaryKey)tableConfig.primaryKey.push(...primaryKey)}else{if(!(dbName in relationsBuffer))relationsBuffer[dbName]={relations:{},primaryKey};relationsBuffer[dbName].relations[relationName]=relation}}return{tables:tablesConfig,tableNamesMap}}function createOne(sourceTable){return function one(table,config){return new One(sourceTable,table,config,config?.fields.reduce((res,f)=>res&&f.notNull,!0)??!1)}}function createMany(sourceTable){return function many(referencedTable,config){return new Many(sourceTable,referencedTable,config)}}function normalizeRelation(schema,tableNamesMap,relation){if(is(relation,One)&&relation.config)return{fields:relation.config.fields,references:relation.config.references};let referencedTableTsName=tableNamesMap[getTableUniqueName(relation.referencedTable)];if(!referencedTableTsName)throw new Error(`Table "${relation.referencedTable[Table.Symbol.Name]}" not found in schema`);let referencedTableConfig=schema[referencedTableTsName];if(!referencedTableConfig)throw new Error(`Table "${referencedTableTsName}" not found in schema`);let sourceTable=relation.sourceTable,sourceTableTsName=tableNamesMap[getTableUniqueName(sourceTable)];if(!sourceTableTsName)throw new Error(`Table "${sourceTable[Table.Symbol.Name]}" not found in schema`);let reverseRelations=[];for(let referencedTableRelation of Object.values(referencedTableConfig.relations))if(relation.relationName&&relation!==referencedTableRelation&&referencedTableRelation.relationName===relation.relationName||!relation.relationName&&referencedTableRelation.referencedTable===relation.sourceTable)reverseRelations.push(referencedTableRelation);if(reverseRelations.length>1)throw relation.relationName?new Error(`There are multiple relations with name "${relation.relationName}" in table "${referencedTableTsName}"`):new Error(`There are multiple relations between "${referencedTableTsName}" and "${relation.sourceTable[Table.Symbol.Name]}". Please specify relation name`);if(reverseRelations[0]&&is(reverseRelations[0],One)&&reverseRelations[0].config)return{fields:reverseRelations[0].config.references,references:reverseRelations[0].config.fields};throw new Error(`There is not enough information to infer relation "${sourceTableTsName}.${relation.fieldName}"`)}function createTableRelationsHelpers(sourceTable){return{one:createOne(sourceTable),many:createMany(sourceTable)}}function mapRelationalRow(tablesConfig,tableConfig,row,buildQueryResultSelection,mapColumnValue=(value)=>value){let result={};for(let[selectionItemIndex,selectionItem]of buildQueryResultSelection.entries())if(selectionItem.isJson){let relation=tableConfig.relations[selectionItem.tsKey],rawSubRows=row[selectionItemIndex],subRows=typeof rawSubRows==="string"?JSON.parse(rawSubRows):rawSubRows;result[selectionItem.tsKey]=is(relation,One)?subRows&&mapRelationalRow(tablesConfig,tablesConfig[selectionItem.relationTableTsKey],subRows,selectionItem.selection,mapColumnValue):subRows.map((subRow)=>mapRelationalRow(tablesConfig,tablesConfig[selectionItem.relationTableTsKey],subRow,selectionItem.selection,mapColumnValue))}else{let value=mapColumnValue(row[selectionItemIndex]),field=selectionItem.field,decoder;if(is(field,Column))decoder=field;else if(is(field,SQL))decoder=field.decoder;else decoder=field.sql.decoder;result[selectionItem.tsKey]=value===null?null:decoder.mapFromDriverValue(value)}return result}function count(expression){return sql`count(${expression||sql.raw("*")})`.mapWith(Number)}var import_config=__toESM(require_config(),1);import os from"os";import fs from"fs";var originCache=new Map,originStackCache=new Map,originError=Symbol("OriginError"),CLOSE={};class Query extends Promise{constructor(strings,args,handler,canceller,options={}){let resolve,reject;super((a,b)=>{resolve=a,reject=b});this.tagged=Array.isArray(strings.raw),this.strings=strings,this.args=args,this.handler=handler,this.canceller=canceller,this.options=options,this.state=null,this.statement=null,this.resolve=(x)=>(this.active=!1,resolve(x)),this.reject=(x)=>(this.active=!1,reject(x)),this.active=!1,this.cancelled=null,this.executed=!1,this.signature="",this[originError]=this.handler.debug?new Error:this.tagged&&cachedError(this.strings)}get origin(){return(this.handler.debug?this[originError].stack:this.tagged&&originStackCache.has(this.strings)?originStackCache.get(this.strings):originStackCache.set(this.strings,this[originError].stack).get(this.strings))||""}static get[Symbol.species](){return Promise}cancel(){return this.canceller&&(this.canceller(this),this.canceller=null)}simple(){return this.options.simple=!0,this.options.prepare=!1,this}async readable(){return this.simple(),this.streaming=!0,this}async writable(){return this.simple(),this.streaming=!0,this}cursor(rows=1,fn){if(this.options.simple=!1,typeof rows==="function")fn=rows,rows=1;if(this.cursorRows=rows,typeof fn==="function")return this.cursorFn=fn,this;let prev;return{[Symbol.asyncIterator]:()=>({next:()=>{if(this.executed&&!this.active)return{done:!0};prev&&prev();let promise=new Promise((resolve,reject)=>{this.cursorFn=(value)=>{return resolve({value,done:!1}),new Promise((r)=>prev=r)},this.resolve=()=>(this.active=!1,resolve({done:!0})),this.reject=(x)=>(this.active=!1,reject(x))});return this.execute(),promise},return(){return prev&&prev(CLOSE),{done:!0}}})}}describe(){return this.options.simple=!1,this.onlyDescribe=this.options.prepare=!0,this}stream(){throw new Error(".stream has been renamed to .forEach")}forEach(fn){return this.forEachFn=fn,this.handle(),this}raw(){return this.isRaw=!0,this}values(){return this.isRaw="values",this}async handle(){!this.executed&&(this.executed=!0)&&await 1&&this.handler(this)}execute(){return this.handle(),this}then(){return this.handle(),super.then.apply(this,arguments)}catch(){return this.handle(),super.catch.apply(this,arguments)}finally(){return this.handle(),super.finally.apply(this,arguments)}}function cachedError(xs){if(originCache.has(xs))return originCache.get(xs);let x=Error.stackTraceLimit;return Error.stackTraceLimit=4,originCache.set(xs,new Error),Error.stackTraceLimit=x,originCache.get(xs)}class PostgresError extends Error{constructor(x){super(x.message);this.name=this.constructor.name,Object.assign(this,x)}}var Errors2={connection,postgres,generic,notSupported};function connection(x,options,socket){let{host,port}=socket||options,error2=Object.assign(new Error("write "+x+" "+(options.path||host+":"+port)),{code:x,errno:x,address:options.path||host},options.path?{}:{port});return Error.captureStackTrace(error2,connection),error2}function postgres(x){let error2=new PostgresError(x);return Error.captureStackTrace(error2,postgres),error2}function generic(code,message){let error2=Object.assign(new Error(code+": "+message),{code});return Error.captureStackTrace(error2,generic),error2}function notSupported(x){let error2=Object.assign(new Error(x+" (B) is not supported"),{code:"MESSAGE_NOT_SUPPORTED",name:x});return Error.captureStackTrace(error2,notSupported),error2}var types={string:{to:25,from:null,serialize:(x)=>""+x},number:{to:0,from:[21,23,26,700,701],serialize:(x)=>""+x,parse:(x)=>+x},json:{to:114,from:[114,3802],serialize:(x)=>JSON.stringify(x),parse:(x)=>JSON.parse(x)},boolean:{to:16,from:16,serialize:(x)=>x===!0?"t":"f",parse:(x)=>x==="t"},date:{to:1184,from:[1082,1114,1184],serialize:(x)=>(x instanceof Date?x:new Date(x)).toISOString(),parse:(x)=>new Date(x)},bytea:{to:17,from:17,serialize:(x)=>"\\x"+Buffer.from(x).toString("hex"),parse:(x)=>Buffer.from(x.slice(2),"hex")}};class NotTagged{then(){notTagged()}catch(){notTagged()}finally(){notTagged()}}class Identifier2 extends NotTagged{constructor(value){super();this.value=escapeIdentifier(value)}}class Parameter extends NotTagged{constructor(value,type2,array){super();this.value=value,this.type=type2,this.array=array}}class Builder extends NotTagged{constructor(first,rest){super();this.first=first,this.rest=rest}build(before,parameters,types2,options){let keyword=builders.map(([x,fn])=>({fn,i:before.search(x)})).sort((a,b)=>a.i-b.i).pop();return keyword.i===-1?escapeIdentifiers(this.first,options):keyword.fn(this.first,this.rest,parameters,types2,options)}}function handleValue(x,parameters,types2,options){let value=x instanceof Parameter?x.value:x;if(value===void 0){if(x instanceof Parameter?x.value=options.transform.undefined:value=x=options.transform.undefined,value===void 0)throw Errors2.generic("UNDEFINED_VALUE","Undefined values are not allowed")}return"$"+types2.push(x instanceof Parameter?(parameters.push(x.value),x.array?x.array[x.type||inferType(x.value)]||x.type||firstIsString(x.value):x.type):(parameters.push(x),inferType(x)))}var defaultHandlers=typeHandlers(types);function stringify(q,string,value,parameters,types2,options){for(let i=1;i<q.strings.length;i++)string+=stringifyValue(string,value,parameters,types2,options)+q.strings[i],value=q.args[i];return string}function stringifyValue(string,value,parameters,types2,o){return value instanceof Builder?value.build(string,parameters,types2,o):value instanceof Query?fragment(value,parameters,types2,o):value instanceof Identifier2?value.value:value&&value[0]instanceof Query?value.reduce((acc,x)=>acc+" "+fragment(x,parameters,types2,o),""):handleValue(value,parameters,types2,o)}function fragment(q,parameters,types2,options){return q.fragment=!0,stringify(q,q.strings[0],q.args[0],parameters,types2,options)}function valuesBuilder(first,parameters,types2,columns,options){return first.map((row)=>"("+columns.map((column)=>stringifyValue("values",row[column],parameters,types2,options)).join(",")+")").join(",")}function values(first,rest,parameters,types2,options){let multi=Array.isArray(first[0]),columns=rest.length?rest.flat():Object.keys(multi?first[0]:first);return valuesBuilder(multi?first:[first],parameters,types2,columns,options)}function select(first,rest,parameters,types2,options){if(typeof first==="string"&&(first=[first].concat(rest)),Array.isArray(first))return escapeIdentifiers(first,options);let value;return(rest.length?rest.flat():Object.keys(first)).map((x)=>{return value=first[x],(value instanceof Query?fragment(value,parameters,types2,options):value instanceof Identifier2?value.value:handleValue(value,parameters,types2,options))+" as "+escapeIdentifier(options.transform.column.to?options.transform.column.to(x):x)}).join(",")}var builders=Object.entries({values,in:(...xs)=>{let x=values(...xs);return x==="()"?"(null)":x},select,as:select,returning:select,"\\(":select,update(first,rest,parameters,types2,options){return(rest.length?rest.flat():Object.keys(first)).map((x)=>escapeIdentifier(options.transform.column.to?options.transform.column.to(x):x)+"="+stringifyValue("values",first[x],parameters,types2,options))},insert(first,rest,parameters,types2,options){let columns=rest.length?rest.flat():Object.keys(Array.isArray(first)?first[0]:first);return"("+escapeIdentifiers(columns,options)+")values"+valuesBuilder(Array.isArray(first)?first:[first],parameters,types2,columns,options)}}).map(([x,fn])=>[new RegExp("((?:^|[\\s(])"+x+"(?:$|[\\s(]))(?![\\s\\S]*\\1)","i"),fn]);function notTagged(){throw Errors2.generic("NOT_TAGGED_CALL","Query not called as a tagged template literal")}var{serializers,parsers}=defaultHandlers;function firstIsString(x){if(Array.isArray(x))return firstIsString(x[0]);return typeof x==="string"?1009:0}var mergeUserTypes=function(types2){let user=typeHandlers(types2||{});return{serializers:Object.assign({},serializers,user.serializers),parsers:Object.assign({},parsers,user.parsers)}};function typeHandlers(types2){return Object.keys(types2).reduce((acc,k2)=>{if(types2[k2].from&&[].concat(types2[k2].from).forEach((x)=>acc.parsers[x]=types2[k2].parse),types2[k2].serialize)acc.serializers[types2[k2].to]=types2[k2].serialize,types2[k2].from&&[].concat(types2[k2].from).forEach((x)=>acc.serializers[x]=types2[k2].serialize);return acc},{parsers:{},serializers:{}})}function escapeIdentifiers(xs,{transform:{column}}){return xs.map((x)=>escapeIdentifier(column.to?column.to(x):x)).join(",")}var escapeIdentifier=function escape(str){return'"'+str.replace(/"/g,'""').replace(/\./g,'"."')+'"'},inferType=function inferType2(x){return x instanceof Parameter?x.type:x instanceof Date?1184:x instanceof Uint8Array?17:x===!0||x===!1?16:typeof x==="bigint"?20:Array.isArray(x)?inferType2(x[0]):0},escapeBackslash=/\\/g,escapeQuote=/"/g;function arrayEscape(x){return x.replace(escapeBackslash,"\\\\").replace(escapeQuote,"\\\"")}var arraySerializer=function arraySerializer2(xs,serializer,options,typarray){if(Array.isArray(xs)===!1)return xs;if(!xs.length)return"{}";let first=xs[0],delimiter=typarray===1020?";":",";if(Array.isArray(first)&&!first.type)return"{"+xs.map((x)=>arraySerializer2(x,serializer,options,typarray)).join(delimiter)+"}";return"{"+xs.map((x)=>{if(x===void 0){if(x=options.transform.undefined,x===void 0)throw Errors2.generic("UNDEFINED_VALUE","Undefined values are not allowed")}return x===null?"null":'"'+arrayEscape(serializer?serializer(x.type?x.value:x):""+x)+'"'}).join(delimiter)+"}"},arrayParserState={i:0,char:null,str:"",quoted:!1,last:0},arrayParser=function arrayParser2(x,parser,typarray){return arrayParserState.i=arrayParserState.last=0,arrayParserLoop(arrayParserState,x,parser,typarray)};function arrayParserLoop(s,x,parser,typarray){let xs=[],delimiter=typarray===1020?";":",";for(;s.i<x.length;s.i++){if(s.char=x[s.i],s.quoted)if(s.char==="\\")s.str+=x[++s.i];else if(s.char==='"')xs.push(parser?parser(s.str):s.str),s.str="",s.quoted=x[s.i+1]==='"',s.last=s.i+2;else s.str+=s.char;else if(s.char==='"')s.quoted=!0;else if(s.char==="{")s.last=++s.i,xs.push(arrayParserLoop(s,x,parser,typarray));else if(s.char==="}"){s.quoted=!1,s.last<s.i&&xs.push(parser?parser(x.slice(s.last,s.i)):x.slice(s.last,s.i)),s.last=s.i+1;break}else if(s.char===delimiter&&s.p!=="}"&&s.p!=='"')xs.push(parser?parser(x.slice(s.last,s.i)):x.slice(s.last,s.i)),s.last=s.i+1;s.p=s.char}return s.last<s.i&&xs.push(parser?parser(x.slice(s.last,s.i+1)):x.slice(s.last,s.i+1)),xs}var toCamel=(x)=>{let str=x[0];for(let i=1;i<x.length;i++)str+=x[i]==="_"?x[++i].toUpperCase():x[i];return str},toPascal=(x)=>{let str=x[0].toUpperCase();for(let i=1;i<x.length;i++)str+=x[i]==="_"?x[++i].toUpperCase():x[i];return str},toKebab=(x)=>x.replace(/_/g,"-"),fromCamel=(x)=>x.replace(/([A-Z])/g,"_$1").toLowerCase(),fromPascal=(x)=>(x.slice(0,1)+x.slice(1).replace(/([A-Z])/g,"_$1")).toLowerCase(),fromKebab=(x)=>x.replace(/-/g,"_");function createJsonTransform(fn){return function jsonTransform(x,column){return typeof x==="object"&&x!==null&&(column.type===114||column.type===3802)?Array.isArray(x)?x.map((x2)=>jsonTransform(x2,column)):Object.entries(x).reduce((acc,[k2,v])=>Object.assign(acc,{[fn(k2)]:jsonTransform(v,column)}),{}):x}}toCamel.column={from:toCamel};toCamel.value={from:createJsonTransform(toCamel)};fromCamel.column={to:fromCamel};var camel={...toCamel};camel.column.to=fromCamel;toPascal.column={from:toPascal};toPascal.value={from:createJsonTransform(toPascal)};fromPascal.column={to:fromPascal};var pascal={...toPascal};pascal.column.to=fromPascal;toKebab.column={from:toKebab};toKebab.value={from:createJsonTransform(toKebab)};fromKebab.column={to:fromKebab};var kebab={...toKebab};kebab.column.to=fromKebab;import net from"net";import tls from"tls";import crypto2 from"crypto";import Stream from"stream";import{performance as performance2}from"perf_hooks";class Result extends Array{constructor(){super();Object.defineProperties(this,{count:{value:null,writable:!0},state:{value:null,writable:!0},command:{value:null,writable:!0},columns:{value:null,writable:!0},statement:{value:null,writable:!0}})}static get[Symbol.species](){return Array}}var queue_default=Queue;function Queue(initial=[]){let xs=initial.slice(),index=0;return{get length(){return xs.length-index},remove:(x)=>{let index2=xs.indexOf(x);return index2===-1?null:(xs.splice(index2,1),x)},push:(x)=>(xs.push(x),x),shift:()=>{let out=xs[index++];if(index===xs.length)index=0,xs=[];else xs[index-1]=void 0;return out}}}var buffer=Buffer.allocUnsafe(256),messages="BCcDdEFfHPpQSX".split("").reduce((acc,x)=>{let v=x.charCodeAt(0);return acc[x]=()=>{return buffer[0]=v,b.i=5,b},acc},{}),b=Object.assign(reset,messages,{N:String.fromCharCode(0),i:0,inc(x){return b.i+=x,b},str(x){let length=Buffer.byteLength(x);return fit(length),b.i+=buffer.write(x,b.i,length,"utf8"),b},i16(x){return fit(2),buffer.writeUInt16BE(x,b.i),b.i+=2,b},i32(x,i){if(i||i===0)return buffer.writeUInt32BE(x,i),b;return fit(4),buffer.writeUInt32BE(x,b.i),b.i+=4,b},z(x){return fit(x),buffer.fill(0,b.i,b.i+x),b.i+=x,b},raw(x){return buffer=Buffer.concat([buffer.subarray(0,b.i),x]),b.i=buffer.length,b},end(at=1){buffer.writeUInt32BE(b.i-at,at);let out=buffer.subarray(0,b.i);return b.i=0,buffer=Buffer.allocUnsafe(256),out}}),bytes_default=b;function fit(x){if(buffer.length-b.i<x){let prev=buffer,length=prev.length;buffer=Buffer.allocUnsafe(length+(length>>1)+x),prev.copy(buffer)}}function reset(){return b.i=0,b}var connection_default=Connection,uid=1,Sync=bytes_default().S().end(),Flush=bytes_default().H().end(),SSLRequest=bytes_default().i32(8).i32(80877103).end(8),ExecuteUnnamed=Buffer.concat([bytes_default().E().str(bytes_default.N).i32(0).end(),Sync]),DescribeUnnamed=bytes_default().D().str("S").str(bytes_default.N).end(),noop=()=>{},retryRoutines=new Set(["FetchPreparedStatement","RevalidateCachedQuery","transformAssignedExpr"]),errorFields={83:"severity_local",86:"severity",67:"code",77:"message",68:"detail",72:"hint",80:"position",112:"internal_position",113:"internal_query",87:"where",115:"schema_name",116:"table_name",99:"column_name",100:"data type_name",110:"constraint_name",70:"file",76:"line",82:"routine"};function Connection(options,queues={},{onopen=noop,onend=noop,onclose=noop}={}){let{ssl,max,user,host,port,database,parsers:parsers2,transform:transform2,onnotice,onnotify,onparameter,max_pipeline,keep_alive,backoff,target_session_attrs}=options,sent=queue_default(),id=uid++,backend={pid:null,secret:null},idleTimer=timer(end,options.idle_timeout),lifeTimer=timer(end,options.max_lifetime),connectTimer=timer(connectTimedOut,options.connect_timeout),socket=null,cancelMessage,result=new Result,incoming=Buffer.alloc(0),needsTypes=options.fetch_types,backendParameters={},statements={},statementId=Math.random().toString(36).slice(2),statementCount=1,closedDate=0,remaining=0,hostIndex=0,retries=0,length=0,delay=0,rows=0,serverSignature=null,nextWriteTimer=null,terminated=!1,incomings=null,results=null,initial=null,ending=null,stream=null,chunk=null,ended=null,nonce=null,query=null,final=null,connection2={queue:queues.closed,idleTimer,connect(query2){initial=query2,reconnect()},terminate,execute,cancel,end,count:0,id};return queues.closed&&queues.closed.push(connection2),connection2;async function createSocket(){let x;try{x=options.socket?await Promise.resolve(options.socket(options)):new net.Socket}catch(e){error2(e);return}return x.on("error",error2),x.on("close",closed),x.on("drain",drain),x}async function cancel({pid,secret},resolve,reject){try{cancelMessage=bytes_default().i32(16).i32(80877102).i32(pid).i32(secret).end(16),await connect(),socket.once("error",reject),socket.once("close",resolve)}catch(error3){reject(error3)}}function execute(q){if(terminated)return queryError(q,Errors2.connection("CONNECTION_DESTROYED",options));if(q.cancelled)return;try{return q.state=backend,query?sent.push(q):(query=q,query.active=!0),build(q),write(toBuffer(q))&&!q.describeFirst&&!q.cursorFn&&sent.length<max_pipeline&&(!q.options.onexecute||q.options.onexecute(connection2))}catch(error3){return sent.length===0&&write(Sync),errored(error3),!0}}function toBuffer(q){if(q.parameters.length>=65534)throw Errors2.generic("MAX_PARAMETERS_EXCEEDED","Max number of parameters (65534) exceeded");return q.options.simple?bytes_default().Q().str(q.statement.string+bytes_default.N).end():q.describeFirst?Buffer.concat([describe(q),Flush]):q.prepare?q.prepared?prepared(q):Buffer.concat([describe(q),prepared(q)]):unnamed(q)}function describe(q){return Buffer.concat([Parse2(q.statement.string,q.parameters,q.statement.types,q.statement.name),Describe("S",q.statement.name)])}function prepared(q){return Buffer.concat([Bind(q.parameters,q.statement.types,q.statement.name,q.cursorName),q.cursorFn?Execute("",q.cursorRows):ExecuteUnnamed])}function unnamed(q){return Buffer.concat([Parse2(q.statement.string,q.parameters,q.statement.types),DescribeUnnamed,prepared(q)])}function build(q){let parameters=[],types2=[],string=stringify(q,q.strings[0],q.args[0],parameters,types2,options);!q.tagged&&q.args.forEach((x)=>handleValue(x,parameters,types2,options)),q.prepare=options.prepare&&("prepare"in q.options?q.options.prepare:!0),q.string=string,q.signature=q.prepare&&types2+string,q.onlyDescribe&&delete statements[q.signature],q.parameters=q.parameters||parameters,q.prepared=q.prepare&&q.signature in statements,q.describeFirst=q.onlyDescribe||parameters.length&&!q.prepared,q.statement=q.prepared?statements[q.signature]:{string,types:types2,name:q.prepare?statementId+statementCount++:""},typeof options.debug==="function"&&options.debug(id,string,parameters,types2)}function write(x,fn){if(chunk=chunk?Buffer.concat([chunk,x]):Buffer.from(x),fn||chunk.length>=1024)return nextWrite(fn);return nextWriteTimer===null&&(nextWriteTimer=setImmediate(nextWrite)),!0}function nextWrite(fn){let x=socket.write(chunk,fn);return nextWriteTimer!==null&&clearImmediate(nextWriteTimer),chunk=nextWriteTimer=null,x}function connectTimedOut(){errored(Errors2.connection("CONNECT_TIMEOUT",options,socket)),socket.destroy()}async function secure(){if(write(SSLRequest),!await new Promise((r)=>socket.once("data",(x)=>r(x[0]===83)))&&ssl==="prefer")return connected();socket.removeAllListeners(),socket=tls.connect({socket,servername:net.isIP(socket.host)?void 0:socket.host,...ssl==="require"||ssl==="allow"||ssl==="prefer"?{rejectUnauthorized:!1}:ssl==="verify-full"?{}:typeof ssl==="object"?ssl:{}}),socket.on("secureConnect",connected),socket.on("error",error2),socket.on("close",closed),socket.on("drain",drain)}function drain(){!query&&onopen(connection2)}function data(x){if(incomings){if(incomings.push(x),remaining-=x.length,remaining>0)return}incoming=incomings?Buffer.concat(incomings,length-remaining):incoming.length===0?x:Buffer.concat([incoming,x],incoming.length+x.length);while(incoming.length>4){if(length=incoming.readUInt32BE(1),length>=incoming.length){remaining=length-incoming.length,incomings=[incoming];break}try{handle(incoming.subarray(0,length+1))}catch(e){query&&(query.cursorFn||query.describeFirst)&&write(Sync),errored(e)}incoming=incoming.subarray(length+1),remaining=0,incomings=null}}async function connect(){if(terminated=!1,backendParameters={},socket||(socket=await createSocket()),!socket)return;if(connectTimer.start(),options.socket)return ssl?secure():connected();if(socket.on("connect",ssl?secure:connected),options.path)return socket.connect(options.path);socket.ssl=ssl,socket.connect(port[hostIndex],host[hostIndex]),socket.host=host[hostIndex],socket.port=port[hostIndex],hostIndex=(hostIndex+1)%port.length}function reconnect(){setTimeout(connect,closedDate?closedDate+delay-performance2.now():0)}function connected(){try{statements={},needsTypes=options.fetch_types,statementId=Math.random().toString(36).slice(2),statementCount=1,lifeTimer.start(),socket.on("data",data),keep_alive&&socket.setKeepAlive&&socket.setKeepAlive(!0,1000*keep_alive);let s=StartupMessage();write(s)}catch(err){error2(err)}}function error2(err){if(connection2.queue===queues.connecting&&options.host[retries+1])return;errored(err);while(sent.length)queryError(sent.shift(),err)}function errored(err){stream&&(stream.destroy(err),stream=null),query&&queryError(query,err),initial&&(queryError(initial,err),initial=null)}function queryError(query2,err){if(query2.reserve)return query2.reject(err);if(!err||typeof err!=="object")err=new Error(err);"query"in err||"parameters"in err||Object.defineProperties(err,{stack:{value:err.stack+query2.origin.replace(/.*\n/,`
`),enumerable:options.debug},query:{value:query2.string,enumerable:options.debug},parameters:{value:query2.parameters,enumerable:options.debug},args:{value:query2.args,enumerable:options.debug},types:{value:query2.statement&&query2.statement.types,enumerable:options.debug}}),query2.reject(err)}function end(){return ending||(!connection2.reserved&&onend(connection2),!connection2.reserved&&!initial&&!query&&sent.length===0?(terminate(),new Promise((r)=>socket&&socket.readyState!=="closed"?socket.once("close",r):r())):ending=new Promise((r)=>ended=r))}function terminate(){if(terminated=!0,stream||query||initial||sent.length)error2(Errors2.connection("CONNECTION_DESTROYED",options));if(clearImmediate(nextWriteTimer),socket)socket.removeListener("data",data),socket.removeListener("connect",connected),socket.readyState==="open"&&socket.end(bytes_default().X().end());ended&&(ended(),ending=ended=null)}async function closed(hadError){if(incoming=Buffer.alloc(0),remaining=0,incomings=null,clearImmediate(nextWriteTimer),socket.removeListener("data",data),socket.removeListener("connect",connected),idleTimer.cancel(),lifeTimer.cancel(),connectTimer.cancel(),socket.removeAllListeners(),socket=null,initial)return reconnect();!hadError&&(query||sent.length)&&error2(Errors2.connection("CONNECTION_CLOSED",options,socket)),closedDate=performance2.now(),hadError&&options.shared.retries++,delay=(typeof backoff==="function"?backoff(options.shared.retries):backoff)*1000,onclose(connection2,Errors2.connection("CONNECTION_CLOSED",options,socket))}function handle(xs,x=xs[0]){(x===68?DataRow:x===100?CopyData:x===65?NotificationResponse:x===83?ParameterStatus:x===90?ReadyForQuery:x===67?CommandComplete:x===50?BindComplete:x===49?ParseComplete:x===116?ParameterDescription:x===84?RowDescription:x===82?Authentication:x===110?NoData:x===75?BackendKeyData:x===69?ErrorResponse:x===115?PortalSuspended:x===51?CloseComplete:x===71?CopyInResponse:x===78?NoticeResponse:x===72?CopyOutResponse:x===99?CopyDone:x===73?EmptyQueryResponse:x===86?FunctionCallResponse:x===118?NegotiateProtocolVersion:x===87?CopyBothResponse:UnknownMessage)(xs)}function DataRow(x){let index=7,length2,column,value,row=query.isRaw?new Array(query.statement.columns.length):{};for(let i=0;i<query.statement.columns.length;i++)column=query.statement.columns[i],length2=x.readInt32BE(index),index+=4,value=length2===-1?null:query.isRaw===!0?x.subarray(index,index+=length2):column.parser===void 0?x.toString("utf8",index,index+=length2):column.parser.array===!0?column.parser(x.toString("utf8",index+1,index+=length2)):column.parser(x.toString("utf8",index,index+=length2)),query.isRaw?row[i]=query.isRaw===!0?value:transform2.value.from?transform2.value.from(value,column):value:row[column.name]=transform2.value.from?transform2.value.from(value,column):value;query.forEachFn?query.forEachFn(transform2.row.from?transform2.row.from(row):row,result):result[rows++]=transform2.row.from?transform2.row.from(row):row}function ParameterStatus(x){let[k2,v]=x.toString("utf8",5,x.length-1).split(bytes_default.N);if(backendParameters[k2]=v,options.parameters[k2]!==v)options.parameters[k2]=v,onparameter&&onparameter(k2,v)}function ReadyForQuery(x){if(query&&query.options.simple&&query.resolve(results||result),query=results=null,result=new Result,connectTimer.cancel(),initial){if(target_session_attrs){if(!backendParameters.in_hot_standby||!backendParameters.default_transaction_read_only)return fetchState();else if(tryNext(target_session_attrs,backendParameters))return terminate()}if(needsTypes)return initial.reserve&&(initial=null),fetchArrayTypes();initial&&!initial.reserve&&execute(initial),options.shared.retries=retries=0,initial=null;return}while(sent.length&&(query=sent.shift())&&(query.active=!0,query.cancelled))Connection(options).cancel(query.state,query.cancelled.resolve,query.cancelled.reject);if(query)return;connection2.reserved?!connection2.reserved.release&&x[5]===73?ending?terminate():(connection2.reserved=null,onopen(connection2)):connection2.reserved():ending?terminate():onopen(connection2)}function CommandComplete(x){rows=0;for(let i=x.length-1;i>0;i--){if(x[i]===32&&x[i+1]<58&&result.count===null)result.count=+x.toString("utf8",i+1,x.length-1);if(x[i-1]>=65){result.command=x.toString("utf8",5,i),result.state=backend;break}}if(final&&(final(),final=null),result.command==="BEGIN"&&max!==1&&!connection2.reserved)return errored(Errors2.generic("UNSAFE_TRANSACTION","Only use sql.begin, sql.reserved or max: 1"));if(query.options.simple)return BindComplete();if(query.cursorFn)result.count&&query.cursorFn(result),write(Sync);query.resolve(result)}function ParseComplete(){query.parsing=!1}function BindComplete(){!result.statement&&(result.statement=query.statement),result.columns=query.statement.columns}function ParameterDescription(x){let length2=x.readUInt16BE(5);for(let i=0;i<length2;++i)!query.statement.types[i]&&(query.statement.types[i]=x.readUInt32BE(7+i*4));query.prepare&&(statements[query.signature]=query.statement),query.describeFirst&&!query.onlyDescribe&&(write(prepared(query)),query.describeFirst=!1)}function RowDescription(x){if(result.command)results=results||[result],results.push(result=new Result),result.count=null,query.statement.columns=null;let length2=x.readUInt16BE(5),index=7,start;query.statement.columns=Array(length2);for(let i=0;i<length2;++i){start=index;while(x[index++]!==0);let table=x.readUInt32BE(index),number=x.readUInt16BE(index+4),type2=x.readUInt32BE(index+6);query.statement.columns[i]={name:transform2.column.from?transform2.column.from(x.toString("utf8",start,index-1)):x.toString("utf8",start,index-1),parser:parsers2[type2],table,number,type:type2},index+=18}if(result.statement=query.statement,query.onlyDescribe)return query.resolve(query.statement),write(Sync)}async function Authentication(x,type2=x.readUInt32BE(5)){(type2===3?AuthenticationCleartextPassword:type2===5?AuthenticationMD5Password:type2===10?SASL:type2===11?SASLContinue:type2===12?SASLFinal:type2!==0?UnknownAuth:noop)(x,type2)}async function AuthenticationCleartextPassword(){let payload=await Pass();write(bytes_default().p().str(payload).z(1).end())}async function AuthenticationMD5Password(x){let payload="md5"+await md5(Buffer.concat([Buffer.from(await md5(await Pass()+user)),x.subarray(9)]));write(bytes_default().p().str(payload).z(1).end())}async function SASL(){nonce=(await crypto2.randomBytes(18)).toString("base64"),bytes_default().p().str("SCRAM-SHA-256"+bytes_default.N);let i=bytes_default.i;write(bytes_default.inc(4).str("n,,n=*,r="+nonce).i32(bytes_default.i-i-4,i).end())}async function SASLContinue(x){let res=x.toString("utf8",9).split(",").reduce((acc,x2)=>(acc[x2[0]]=x2.slice(2),acc),{}),saltedPassword=await crypto2.pbkdf2Sync(await Pass(),Buffer.from(res.s,"base64"),parseInt(res.i),32,"sha256"),clientKey=await hmac(saltedPassword,"Client Key"),auth="n=*,r="+nonce+",r="+res.r+",s="+res.s+",i="+res.i+",c=biws,r="+res.r;serverSignature=(await hmac(await hmac(saltedPassword,"Server Key"),auth)).toString("base64");let payload="c=biws,r="+res.r+",p="+xor(clientKey,Buffer.from(await hmac(await sha256(clientKey),auth))).toString("base64");write(bytes_default().p().str(payload).end())}function SASLFinal(x){if(x.toString("utf8",9).split(bytes_default.N,1)[0].slice(2)===serverSignature)return;errored(Errors2.generic("SASL_SIGNATURE_MISMATCH","The server did not return the correct signature")),socket.destroy()}function Pass(){return Promise.resolve(typeof options.pass==="function"?options.pass():options.pass)}function NoData(){if(result.statement=query.statement,result.statement.columns=[],query.onlyDescribe)return query.resolve(query.statement),write(Sync)}function BackendKeyData(x){backend.pid=x.readUInt32BE(5),backend.secret=x.readUInt32BE(9)}async function fetchArrayTypes(){needsTypes=!1,(await new Query([`
      select b.oid, b.typarray
      from pg_catalog.pg_type a
      left join pg_catalog.pg_type b on b.oid = a.typelem
      where a.typcategory = 'A'
      group by b.oid, b.typarray
      order by b.oid
    `],[],execute)).forEach(({oid,typarray})=>addArrayType(oid,typarray))}function addArrayType(oid,typarray){if(!!options.parsers[typarray]&&!!options.serializers[typarray])return;let parser=options.parsers[oid];options.shared.typeArrayMap[oid]=typarray,options.parsers[typarray]=(xs)=>arrayParser(xs,parser,typarray),options.parsers[typarray].array=!0,options.serializers[typarray]=(xs)=>arraySerializer(xs,options.serializers[oid],options,typarray)}function tryNext(x,xs){return x==="read-write"&&xs.default_transaction_read_only==="on"||x==="read-only"&&xs.default_transaction_read_only==="off"||x==="primary"&&xs.in_hot_standby==="on"||x==="standby"&&xs.in_hot_standby==="off"||x==="prefer-standby"&&xs.in_hot_standby==="off"&&options.host[retries]}function fetchState(){let query2=new Query([`
      show transaction_read_only;
      select pg_catalog.pg_is_in_recovery()
    `],[],execute,null,{simple:!0});query2.resolve=([[a],[b2]])=>{backendParameters.default_transaction_read_only=a.transaction_read_only,backendParameters.in_hot_standby=b2.pg_is_in_recovery?"on":"off"},query2.execute()}function ErrorResponse(x){query&&(query.cursorFn||query.describeFirst)&&write(Sync);let error3=Errors2.postgres(parseError(x));query&&query.retried?errored(query.retried):query&&query.prepared&&retryRoutines.has(error3.routine)?retry(query,error3):errored(error3)}function retry(q,error3){delete statements[q.signature],q.retried=error3,execute(q)}function NotificationResponse(x){if(!onnotify)return;let index=9;while(x[index++]!==0);onnotify(x.toString("utf8",9,index-1),x.toString("utf8",index,x.length-1))}async function PortalSuspended(){try{let x=await Promise.resolve(query.cursorFn(result));rows=0,x===CLOSE?write(Close(query.portal)):(result=new Result,write(Execute("",query.cursorRows)))}catch(err){write(Sync),query.reject(err)}}function CloseComplete(){result.count&&query.cursorFn(result),query.resolve(result)}function CopyInResponse(){stream=new Stream.Writable({autoDestroy:!0,write(chunk2,encoding,callback){socket.write(bytes_default().d().raw(chunk2).end(),callback)},destroy(error3,callback){callback(error3),socket.write(bytes_default().f().str(error3+bytes_default.N).end()),stream=null},final(callback){socket.write(bytes_default().c().end()),final=callback}}),query.resolve(stream)}function CopyOutResponse(){stream=new Stream.Readable({read(){socket.resume()}}),query.resolve(stream)}function CopyBothResponse(){stream=new Stream.Duplex({autoDestroy:!0,read(){socket.resume()},write(chunk2,encoding,callback){socket.write(bytes_default().d().raw(chunk2).end(),callback)},destroy(error3,callback){callback(error3),socket.write(bytes_default().f().str(error3+bytes_default.N).end()),stream=null},final(callback){socket.write(bytes_default().c().end()),final=callback}}),query.resolve(stream)}function CopyData(x){stream&&(stream.push(x.subarray(5))||socket.pause())}function CopyDone(){stream&&stream.push(null),stream=null}function NoticeResponse(x){onnotice?onnotice(parseError(x)):console.log(parseError(x))}function EmptyQueryResponse(){}function FunctionCallResponse(){errored(Errors2.notSupported("FunctionCallResponse"))}function NegotiateProtocolVersion(){errored(Errors2.notSupported("NegotiateProtocolVersion"))}function UnknownMessage(x){console.error("Postgres.js : Unknown Message:",x[0])}function UnknownAuth(x,type2){console.error("Postgres.js : Unknown Auth:",type2)}function Bind(parameters,types2,statement="",portal=""){let prev,type2;return bytes_default().B().str(portal+bytes_default.N).str(statement+bytes_default.N).i16(0).i16(parameters.length),parameters.forEach((x,i)=>{if(x===null)return bytes_default.i32(4294967295);type2=types2[i],parameters[i]=x=type2 in options.serializers?options.serializers[type2](x):""+x,prev=bytes_default.i,bytes_default.inc(4).str(x).i32(bytes_default.i-prev-4,prev)}),bytes_default.i16(0),bytes_default.end()}function Parse2(str,parameters,types2,name=""){return bytes_default().P().str(name+bytes_default.N).str(str+bytes_default.N).i16(parameters.length),parameters.forEach((x,i)=>bytes_default.i32(types2[i]||0)),bytes_default.end()}function Describe(x,name=""){return bytes_default().D().str(x).str(name+bytes_default.N).end()}function Execute(portal="",rows2=0){return Buffer.concat([bytes_default().E().str(portal+bytes_default.N).i32(rows2).end(),Flush])}function Close(portal=""){return Buffer.concat([bytes_default().C().str("P").str(portal+bytes_default.N).end(),bytes_default().S().end()])}function StartupMessage(){return cancelMessage||bytes_default().inc(4).i16(3).z(2).str(Object.entries(Object.assign({user,database,client_encoding:"UTF8"},options.connection)).filter(([,v])=>v).map(([k2,v])=>k2+bytes_default.N+v).join(bytes_default.N)).z(2).end(0)}}function parseError(x){let error2={},start=5;for(let i=5;i<x.length-1;i++)if(x[i]===0)error2[errorFields[x[start]]]=x.toString("utf8",start+1,i),start=i+1;return error2}function md5(x){return crypto2.createHash("md5").update(x).digest("hex")}function hmac(key,x){return crypto2.createHmac("sha256",key).update(x).digest()}function sha256(x){return crypto2.createHash("sha256").update(x).digest()}function xor(a,b2){let length=Math.max(a.length,b2.length),buffer2=Buffer.allocUnsafe(length);for(let i=0;i<length;i++)buffer2[i]=a[i]^b2[i];return buffer2}function timer(fn,seconds){if(seconds=typeof seconds==="function"?seconds():seconds,!seconds)return{cancel:noop,start:noop};let timer2;return{cancel(){timer2&&(clearTimeout(timer2),timer2=null)},start(){timer2&&clearTimeout(timer2),timer2=setTimeout(done,seconds*1000,arguments)}};function done(args){fn.apply(null,args),timer2=null}}var noop2=()=>{};function Subscribe(postgres2,options){let subscribers=new Map,slot="postgresjs_"+Math.random().toString(36).slice(2),state={},connection2,stream,ended=!1,sql2=subscribe.sql=postgres2({...options,transform:{column:{},value:{},row:{}},max:1,fetch_types:!1,idle_timeout:null,max_lifetime:null,connection:{...options.connection,replication:"database"},onclose:async function(){if(ended)return;stream=null,state.pid=state.secret=void 0,connected(await init(sql2,slot,options.publications)),subscribers.forEach((event)=>event.forEach(({onsubscribe})=>onsubscribe()))},no_subscribe:!0}),end=sql2.end,close=sql2.close;return sql2.end=async()=>{return ended=!0,stream&&await new Promise((r)=>(stream.once("close",r),stream.end())),end()},sql2.close=async()=>{return stream&&await new Promise((r)=>(stream.once("close",r),stream.end())),close()},subscribe;async function subscribe(event,fn,onsubscribe=noop2,onerror=noop2){if(event=parseEvent(event),!connection2)connection2=init(sql2,slot,options.publications);let subscriber={fn,onsubscribe},fns=subscribers.has(event)?subscribers.get(event).add(subscriber):subscribers.set(event,new Set([subscriber])).get(event),unsubscribe=()=>{fns.delete(subscriber),fns.size===0&&subscribers.delete(event)};return connection2.then((x)=>{return connected(x),onsubscribe(),stream&&stream.on("error",onerror),{unsubscribe,state,sql:sql2}})}function connected(x){stream=x.stream,state.pid=x.state.pid,state.secret=x.state.secret}async function init(sql3,slot2,publications){if(!publications)throw new Error("Missing publication names");let xs=await sql3.unsafe(`CREATE_REPLICATION_SLOT ${slot2} TEMPORARY LOGICAL pgoutput NOEXPORT_SNAPSHOT`),[x]=xs,stream2=await sql3.unsafe(`START_REPLICATION SLOT ${slot2} LOGICAL ${x.consistent_point} (proto_version '1', publication_names '${publications}')`).writable(),state2={lsn:Buffer.concat(x.consistent_point.split("/").map((x2)=>Buffer.from(("00000000"+x2).slice(-8),"hex")))};return stream2.on("data",data),stream2.on("error",error2),stream2.on("close",sql3.close),{stream:stream2,state:xs.state};function error2(e){console.error("Unexpected error during logical streaming - reconnecting",e)}function data(x2){if(x2[0]===119)parse3(x2.subarray(25),state2,sql3.options.parsers,handle,options.transform);else if(x2[0]===107&&x2[17])state2.lsn=x2.subarray(1,9),pong()}function handle(a,b2){let path=b2.relation.schema+"."+b2.relation.table;call("*",a,b2),call("*:"+path,a,b2),b2.relation.keys.length&&call("*:"+path+"="+b2.relation.keys.map((x2)=>a[x2.name]),a,b2),call(b2.command,a,b2),call(b2.command+":"+path,a,b2),b2.relation.keys.length&&call(b2.command+":"+path+"="+b2.relation.keys.map((x2)=>a[x2.name]),a,b2)}function pong(){let x2=Buffer.alloc(34);x2[0]=114,x2.fill(state2.lsn,1),x2.writeBigInt64BE(BigInt(Date.now()-Date.UTC(2000,0,1))*BigInt(1000),25),stream2.write(x2)}}function call(x,a,b2){subscribers.has(x)&&subscribers.get(x).forEach(({fn})=>fn(a,b2,x))}}function Time(x){return new Date(Date.UTC(2000,0,1)+Number(x/BigInt(1000)))}function parse3(x,state,parsers2,handle,transform2){let char2=(acc,[k2,v])=>(acc[k2.charCodeAt(0)]=v,acc);Object.entries({R:(x2)=>{let i=1,r=state[x2.readUInt32BE(i)]={schema:x2.toString("utf8",i+=4,i=x2.indexOf(0,i))||"pg_catalog",table:x2.toString("utf8",i+1,i=x2.indexOf(0,i+1)),columns:Array(x2.readUInt16BE(i+=2)),keys:[]};i+=2;let columnIndex=0,column;while(i<x2.length)column=r.columns[columnIndex++]={key:x2[i++],name:transform2.column.from?transform2.column.from(x2.toString("utf8",i,i=x2.indexOf(0,i))):x2.toString("utf8",i,i=x2.indexOf(0,i)),type:x2.readUInt32BE(i+=1),parser:parsers2[x2.readUInt32BE(i)],atttypmod:x2.readUInt32BE(i+=4)},column.key&&r.keys.push(column),i+=4},Y:()=>{},O:()=>{},B:(x2)=>{state.date=Time(x2.readBigInt64BE(9)),state.lsn=x2.subarray(1,9)},I:(x2)=>{let i=1,relation=state[x2.readUInt32BE(i)],{row}=tuples(x2,relation.columns,i+=7,transform2);handle(row,{command:"insert",relation})},D:(x2)=>{let i=1,relation=state[x2.readUInt32BE(i)];i+=4;let key=x2[i]===75;handle(key||x2[i]===79?tuples(x2,relation.columns,i+=3,transform2).row:null,{command:"delete",relation,key})},U:(x2)=>{let i=1,relation=state[x2.readUInt32BE(i)];i+=4;let key=x2[i]===75,xs=key||x2[i]===79?tuples(x2,relation.columns,i+=3,transform2):null;xs&&(i=xs.i);let{row}=tuples(x2,relation.columns,i+3,transform2);handle(row,{command:"update",relation,key,old:xs&&xs.row})},T:()=>{},C:()=>{}}).reduce(char2,{})[x[0]](x)}function tuples(x,columns,xi,transform2){let type2,column,value,row=transform2.raw?new Array(columns.length):{};for(let i=0;i<columns.length;i++)type2=x[xi++],column=columns[i],value=type2===110?null:type2===117?void 0:column.parser===void 0?x.toString("utf8",xi+4,xi+=4+x.readUInt32BE(xi)):column.parser.array===!0?column.parser(x.toString("utf8",xi+5,xi+=4+x.readUInt32BE(xi))):column.parser(x.toString("utf8",xi+4,xi+=4+x.readUInt32BE(xi))),transform2.raw?row[i]=transform2.raw===!0?value:transform2.value.from?transform2.value.from(value,column):value:row[column.name]=transform2.value.from?transform2.value.from(value,column):value;return{i:xi,row:transform2.row.from?transform2.row.from(row):row}}function parseEvent(x){let xs=x.match(/^(\*|insert|update|delete)?:?([^.]+?\.?[^=]+)?=?(.+)?/i)||[];if(!xs)throw new Error("Malformed subscribe pattern: "+x);let[,command,path,key]=xs;return(command||"*")+(path?":"+(path.indexOf(".")===-1?"public."+path:path):"")+(key?"="+key:"")}import Stream2 from"stream";function largeObject(sql2,oid,mode=393216){return new Promise(async(resolve,reject)=>{await sql2.begin(async(sql3)=>{let finish;!oid&&([{oid}]=await sql3`select lo_creat(-1) as oid`);let[{fd}]=await sql3`select lo_open(${oid}, ${mode}) as fd`,lo={writable,readable,close:()=>sql3`select lo_close(${fd})`.then(finish),tell:()=>sql3`select lo_tell64(${fd})`,read:(x)=>sql3`select loread(${fd}, ${x}) as data`,write:(x)=>sql3`select lowrite(${fd}, ${x})`,truncate:(x)=>sql3`select lo_truncate64(${fd}, ${x})`,seek:(x,whence=0)=>sql3`select lo_lseek64(${fd}, ${x}, ${whence})`,size:()=>sql3`
          select
            lo_lseek64(${fd}, location, 0) as position,
            seek.size
          from (
            select
              lo_lseek64($1, 0, 2) as size,
              tell.location
            from (select lo_tell64($1) as location) tell
          ) seek
        `};return resolve(lo),new Promise(async(r)=>finish=r);async function readable({highWaterMark=16384,start=0,end=1/0}={}){let max=end-start;return start&&await lo.seek(start),new Stream2.Readable({highWaterMark,async read(size){let l=size>max?size-max:size;max-=size;let[{data}]=await lo.read(l);if(this.push(data),data.length<size)this.push(null)}})}async function writable({highWaterMark=16384,start=0}={}){return start&&await lo.seek(start),new Stream2.Writable({highWaterMark,write(chunk,encoding,callback){lo.write(chunk).then(()=>callback(),callback)}})}}).catch(reject)})}Object.assign(Postgres,{PostgresError,toPascal,pascal,toCamel,camel,toKebab,kebab,fromPascal,fromCamel,fromKebab,BigInt:{to:20,from:[20],parse:(x)=>BigInt(x),serialize:(x)=>x.toString()}});var src_default=Postgres;function Postgres(a,b2){let options=parseOptions(a,b2),subscribe=options.no_subscribe||Subscribe(Postgres,{...options}),ending=!1,queries=queue_default(),connecting=queue_default(),reserved=queue_default(),closed=queue_default(),ended=queue_default(),open=queue_default(),busy=queue_default(),full=queue_default(),queues={connecting,reserved,closed,ended,open,busy,full},connections=[...Array(options.max)].map(()=>connection_default(options,queues,{onopen,onend,onclose})),sql2=Sql(handler);return Object.assign(sql2,{get parameters(){return options.parameters},largeObject:largeObject.bind(null,sql2),subscribe,CLOSE,END:CLOSE,PostgresError,options,reserve,listen,begin,close,end}),sql2;function Sql(handler2){return handler2.debug=options.debug,Object.entries(options.types).reduce((acc,[name,type2])=>{return acc[name]=(x)=>new Parameter(x,type2.to),acc},typed),Object.assign(sql3,{types:typed,typed,unsafe,notify,array,json:json2,file}),sql3;function typed(value,type2){return new Parameter(value,type2)}function sql3(strings,...args){return strings&&Array.isArray(strings.raw)?new Query(strings,args,handler2,cancel):typeof strings==="string"&&!args.length?new Identifier2(options.transform.column.to?options.transform.column.to(strings):strings):new Builder(strings,args)}function unsafe(string,args=[],options2={}){return arguments.length===2&&!Array.isArray(args)&&(options2=args,args=[]),new Query([string],args,handler2,cancel,{prepare:!1,...options2,simple:"simple"in options2?options2.simple:args.length===0})}function file(path,args=[],options2={}){return arguments.length===2&&!Array.isArray(args)&&(options2=args,args=[]),new Query([],args,(query2)=>{fs.readFile(path,"utf8",(err,string)=>{if(err)return query2.reject(err);query2.strings=[string],handler2(query2)})},cancel,{...options2,simple:"simple"in options2?options2.simple:args.length===0})}}async function listen(name,fn,onlisten){let listener={fn,onlisten},sql3=listen.sql||(listen.sql=Postgres({...options,max:1,idle_timeout:null,max_lifetime:null,fetch_types:!1,onclose(){Object.entries(listen.channels).forEach(([name2,{listeners}])=>{delete listen.channels[name2],Promise.all(listeners.map((l)=>listen(name2,l.fn,l.onlisten).catch(()=>{})))})},onnotify(c,x){c in listen.channels&&listen.channels[c].listeners.forEach((l)=>l.fn(x))}})),channels=listen.channels||(listen.channels={});if(name in channels){channels[name].listeners.push(listener);let result2=await channels[name].result;return listener.onlisten&&listener.onlisten(),{state:result2.state,unlisten}}channels[name]={result:sql3`listen ${sql3.unsafe('"'+name.replace(/"/g,'""')+'"')}`,listeners:[listener]};let result=await channels[name].result;return listener.onlisten&&listener.onlisten(),{state:result.state,unlisten};async function unlisten(){if(name in channels===!1)return;if(channels[name].listeners=channels[name].listeners.filter((x)=>x!==listener),channels[name].listeners.length)return;return delete channels[name],sql3`unlisten ${sql3.unsafe('"'+name.replace(/"/g,'""')+'"')}`}}async function notify(channel,payload){return await sql2`select pg_notify(${channel}, ${""+payload})`}async function reserve(){let queue=queue_default(),c=open.length?open.shift():await new Promise((resolve,reject)=>{let query={reserve:resolve,reject};queries.push(query),closed.length&&connect(closed.shift(),query)});move(c,reserved),c.reserved=()=>queue.length?c.execute(queue.shift()):move(c,reserved),c.reserved.release=!0;let sql3=Sql(handler2);return sql3.release=()=>{c.reserved=null,onopen(c)},sql3;function handler2(q){c.queue===full?queue.push(q):c.execute(q)||move(c,full)}}async function begin(options2,fn){!fn&&(fn=options2,options2="");let queries2=queue_default(),savepoints=0,connection2,prepare=null;try{return await sql2.unsafe("begin "+options2.replace(/[^a-z ]/ig,""),[],{onexecute}).execute(),await Promise.race([scope(connection2,fn),new Promise((_2,reject)=>connection2.onclose=reject)])}catch(error2){throw error2}async function scope(c,fn2,name){let sql3=Sql(handler2);sql3.savepoint=savepoint,sql3.prepare=(x)=>prepare=x.replace(/[^a-z0-9$-_. ]/gi);let uncaughtError,result;name&&await sql3`savepoint ${sql3(name)}`;try{if(result=await new Promise((resolve,reject)=>{let x=fn2(sql3);Promise.resolve(Array.isArray(x)?Promise.all(x):x).then(resolve,reject)}),uncaughtError)throw uncaughtError}catch(e){throw await(name?sql3`rollback to ${sql3(name)}`:sql3`rollback`),e instanceof PostgresError&&e.code==="25P02"&&uncaughtError||e}if(!name)prepare?await sql3`prepare transaction '${sql3.unsafe(prepare)}'`:await sql3`commit`;return result;function savepoint(name2,fn3){if(name2&&Array.isArray(name2.raw))return savepoint((sql4)=>sql4.apply(sql4,arguments));return arguments.length===1&&(fn3=name2,name2=null),scope(c,fn3,"s"+savepoints+++(name2?"_"+name2:""))}function handler2(q){q.catch((e)=>uncaughtError||(uncaughtError=e)),c.queue===full?queries2.push(q):c.execute(q)||move(c,full)}}function onexecute(c){connection2=c,move(c,reserved),c.reserved=()=>queries2.length?c.execute(queries2.shift()):move(c,reserved)}}function move(c,queue){return c.queue.remove(c),queue.push(c),c.queue=queue,queue===open?c.idleTimer.start():c.idleTimer.cancel(),c}function json2(x){return new Parameter(x,3802)}function array(x,type2){if(!Array.isArray(x))return array(Array.from(arguments));return new Parameter(x,type2||(x.length?inferType(x)||25:0),options.shared.typeArrayMap)}function handler(query){if(ending)return query.reject(Errors2.connection("CONNECTION_ENDED",options,options));if(open.length)return go(open.shift(),query);if(closed.length)return connect(closed.shift(),query);busy.length?go(busy.shift(),query):queries.push(query)}function go(c,query){return c.execute(query)?move(c,busy):move(c,full)}function cancel(query){return new Promise((resolve,reject)=>{query.state?query.active?connection_default(options).cancel(query.state,resolve,reject):query.cancelled={resolve,reject}:(queries.remove(query),query.cancelled=!0,query.reject(Errors2.generic("57014","canceling statement due to user request")),resolve())})}async function end({timeout=null}={}){if(ending)return ending;await 1;let timer2;return ending=Promise.race([new Promise((r)=>timeout!==null&&(timer2=setTimeout(destroy,timeout*1000,r))),Promise.all(connections.map((c)=>c.end()).concat(listen.sql?listen.sql.end({timeout:0}):[],subscribe.sql?subscribe.sql.end({timeout:0}):[]))]).then(()=>clearTimeout(timer2))}async function close(){await Promise.all(connections.map((c)=>c.end()))}async function destroy(resolve){await Promise.all(connections.map((c)=>c.terminate()));while(queries.length)queries.shift().reject(Errors2.connection("CONNECTION_DESTROYED",options));resolve()}function connect(c,query){return move(c,connecting),c.connect(query),c}function onend(c){move(c,ended)}function onopen(c){if(queries.length===0)return move(c,open);let max=Math.ceil(queries.length/(connecting.length+1)),ready=!0;while(ready&&queries.length&&max-- >0){let query=queries.shift();if(query.reserve)return query.reserve(c);ready=c.execute(query)}ready?move(c,busy):move(c,full)}function onclose(c,e){move(c,closed),c.reserved=null,c.onclose&&(c.onclose(e),c.onclose=null),options.onclose&&options.onclose(c.id),queries.length&&connect(c,queries.shift())}}function parseOptions(a,b2){if(a&&a.shared)return a;let env3=process.env,o=(!a||typeof a==="string"?b2:a)||{},{url,multihost}=parseUrl(a),query=[...url.searchParams].reduce((a2,[b3,c])=>(a2[b3]=c,a2),{}),host=o.hostname||o.host||multihost||url.hostname||env3.PGHOST||"localhost",port=o.port||url.port||env3.PGPORT||5432,user=o.user||o.username||url.username||env3.PGUSERNAME||env3.PGUSER||osUsername();o.no_prepare&&(o.prepare=!1),query.sslmode&&(query.ssl=query.sslmode,delete query.sslmode),"timeout"in o&&(console.log("The timeout option is deprecated, use idle_timeout instead"),o.idle_timeout=o.timeout),query.sslrootcert==="system"&&(query.ssl="verify-full");let ints=["idle_timeout","connect_timeout","max_lifetime","max_pipeline","backoff","keep_alive"],defaults={max:10,ssl:!1,idle_timeout:null,connect_timeout:30,max_lifetime,max_pipeline:100,backoff,keep_alive:60,prepare:!0,debug:!1,fetch_types:!0,publications:"alltables",target_session_attrs:null};return{host:Array.isArray(host)?host:host.split(",").map((x)=>x.split(":")[0]),port:Array.isArray(port)?port:host.split(",").map((x)=>parseInt(x.split(":")[1]||port)),path:o.path||host.indexOf("/")>-1&&host+"/.s.PGSQL."+port,database:o.database||o.db||(url.pathname||"").slice(1)||env3.PGDATABASE||user,user,pass:o.pass||o.password||url.password||env3.PGPASSWORD||"",...Object.entries(defaults).reduce((acc,[k2,d])=>{let value=k2 in o?o[k2]:(k2 in query)?query[k2]==="disable"||query[k2]==="false"?!1:query[k2]:env3["PG"+k2.toUpperCase()]||d;return acc[k2]=typeof value==="string"&&ints.includes(k2)?+value:value,acc},{}),connection:{application_name:env3.PGAPPNAME||"postgres.js",...o.connection,...Object.entries(query).reduce((acc,[k2,v])=>((k2 in defaults)||(acc[k2]=v),acc),{})},types:o.types||{},target_session_attrs:tsa(o,url,env3),onnotice:o.onnotice,onnotify:o.onnotify,onclose:o.onclose,onparameter:o.onparameter,socket:o.socket,transform:parseTransform(o.transform||{undefined:void 0}),parameters:{},shared:{retries:0,typeArrayMap:{}},...mergeUserTypes(o.types)}}function tsa(o,url,env3){let x=o.target_session_attrs||url.searchParams.get("target_session_attrs")||env3.PGTARGETSESSIONATTRS;if(!x||["read-write","read-only","primary","standby","prefer-standby"].includes(x))return x;throw new Error("target_session_attrs "+x+" is not supported")}function backoff(retries){return(0.5+Math.random()/2)*Math.min(3**retries/100,20)}function max_lifetime(){return 60*(30+Math.random()*30)}function parseTransform(x){return{undefined:x.undefined,column:{from:typeof x.column==="function"?x.column:x.column&&x.column.from,to:x.column&&x.column.to},value:{from:typeof x.value==="function"?x.value:x.value&&x.value.from,to:x.value&&x.value.to},row:{from:typeof x.row==="function"?x.row:x.row&&x.row.from,to:x.row&&x.row.to}}}function parseUrl(url){if(!url||typeof url!=="string")return{url:{searchParams:new Map}};let host=url;host=host.slice(host.indexOf("://")+3).split(/[?/]/)[0],host=decodeURIComponent(host.slice(host.indexOf("@")+1));let urlObj=new URL(url.replace(host,host.split(",")[0]));return{url:{username:decodeURIComponent(urlObj.username),password:decodeURIComponent(urlObj.password),host:urlObj.host,hostname:urlObj.hostname,port:urlObj.port,pathname:urlObj.pathname,searchParams:urlObj.searchParams},multihost:host.indexOf(",")>-1&&host}}function osUsername(){try{return os.userInfo().username}catch(_2){return process.env.USERNAME||process.env.USER||process.env.LOGNAME}}class SelectionProxyHandler{static[entityKind]="SelectionProxyHandler";config;constructor(config){this.config={...config}}get(subquery,prop){if(prop==="_")return{...subquery._,selectedFields:new Proxy(subquery._.selectedFields,this)};if(prop===ViewBaseConfig)return{...subquery[ViewBaseConfig],selectedFields:new Proxy(subquery[ViewBaseConfig].selectedFields,this)};if(typeof prop==="symbol")return subquery[prop];let value=(is(subquery,Subquery)?subquery._.selectedFields:is(subquery,View)?subquery[ViewBaseConfig].selectedFields:subquery)[prop];if(is(value,SQL.Aliased)){if(this.config.sqlAliasedBehavior==="sql"&&!value.isSelectionField)return value.sql;let newValue=value.clone();return newValue.isSelectionField=!0,newValue}if(is(value,SQL)){if(this.config.sqlBehavior==="sql")return value;throw new Error(`You tried to reference "${prop}" field from a subquery, which is a raw SQL field, but it doesn't have an alias declared. Please add an alias to the field using ".as('alias')" method.`)}if(is(value,Column)){if(this.config.alias)return new Proxy(value,new ColumnAliasProxyHandler(new Proxy(value.table,new TableAliasProxyHandler(this.config.alias,this.config.replaceOriginalName??!1))));return value}if(typeof value!=="object"||value===null)return value;return new Proxy(value,new SelectionProxyHandler(this.config))}}class PgDeleteBase extends QueryPromise{constructor(table,session,dialect,withList){super();this.session=session,this.dialect=dialect,this.config={table,withList}}static[entityKind]="PgDelete";config;where(where){return this.config.where=where,this}returning(fields=this.config.table[Table.Symbol.Columns]){return this.config.returningFields=fields,this.config.returning=orderSelectedFields(fields),this}getSQL(){return this.dialect.buildDeleteQuery(this.config)}toSQL(){let{typings:_typings,...rest}=this.dialect.sqlToQuery(this.getSQL());return rest}_prepare(name){return tracer.startActiveSpan("drizzle.prepareQuery",()=>{return this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning,name,!0)})}prepare(name){return this._prepare(name)}authToken;setToken(token){return this.authToken=token,this}execute=(placeholderValues)=>{return tracer.startActiveSpan("drizzle.operation",()=>{return this._prepare().execute(placeholderValues,this.authToken)})};getSelectedFields(){return this.config.returningFields?new Proxy(this.config.returningFields,new SelectionProxyHandler({alias:getTableName(this.config.table),sqlAliasedBehavior:"alias",sqlBehavior:"error"})):void 0}$dynamic(){return this}}function toSnakeCase(input){return(input.replace(/['\u2019]/g,"").match(/[\da-z]+|[A-Z]+(?![a-z])|[A-Z][\da-z]+/g)??[]).map((word)=>word.toLowerCase()).join("_")}function toCamelCase(input){return(input.replace(/['\u2019]/g,"").match(/[\da-z]+|[A-Z]+(?![a-z])|[A-Z][\da-z]+/g)??[]).reduce((acc,word,i)=>{let formattedWord=i===0?word.toLowerCase():`${word[0].toUpperCase()}${word.slice(1)}`;return acc+formattedWord},"")}function noopCase(input){return input}class CasingCache{static[entityKind]="CasingCache";cache={};cachedTables={};convert;constructor(casing){this.convert=casing==="snake_case"?toSnakeCase:casing==="camelCase"?toCamelCase:noopCase}getColumnCasing(column){if(!column.keyAsName)return column.name;let schema=column.table[Table.Symbol.Schema]??"public",tableName=column.table[Table.Symbol.OriginalName],key=`${schema}.${tableName}.${column.name}`;if(!this.cache[key])this.cacheTable(column.table);return this.cache[key]}cacheTable(table){let schema=table[Table.Symbol.Schema]??"public",tableName=table[Table.Symbol.OriginalName],tableKey=`${schema}.${tableName}`;if(!this.cachedTables[tableKey]){for(let column of Object.values(table[Table.Symbol.Columns])){let columnKey=`${tableKey}.${column.name}`;this.cache[columnKey]=this.convert(column.name)}this.cachedTables[tableKey]=!0}}clearCache(){this.cache={},this.cachedTables={}}}class PgViewBase extends View{static[entityKind]="PgViewBase"}class PgDialect{static[entityKind]="PgDialect";casing;constructor(config){this.casing=new CasingCache(config?.casing)}async migrate(migrations,session,config){let migrationsTable=typeof config==="string"?"__drizzle_migrations":config.migrationsTable??"__drizzle_migrations",migrationsSchema=typeof config==="string"?"drizzle":config.migrationsSchema??"drizzle",migrationTableCreate=sql`
			CREATE TABLE IF NOT EXISTS ${sql.identifier(migrationsSchema)}.${sql.identifier(migrationsTable)} (
				id SERIAL PRIMARY KEY,
				hash text NOT NULL,
				created_at bigint
			)
		`;await session.execute(sql`CREATE SCHEMA IF NOT EXISTS ${sql.identifier(migrationsSchema)}`),await session.execute(migrationTableCreate);let lastDbMigration=(await session.all(sql`select id, hash, created_at from ${sql.identifier(migrationsSchema)}.${sql.identifier(migrationsTable)} order by created_at desc limit 1`))[0];await session.transaction(async(tx)=>{for await(let migration of migrations)if(!lastDbMigration||Number(lastDbMigration.created_at)<migration.folderMillis){for(let stmt of migration.sql)await tx.execute(sql.raw(stmt));await tx.execute(sql`insert into ${sql.identifier(migrationsSchema)}.${sql.identifier(migrationsTable)} ("hash", "created_at") values(${migration.hash}, ${migration.folderMillis})`)}})}escapeName(name){return`"${name}"`}escapeParam(num){return`$${num+1}`}escapeString(str){return`'${str.replace(/'/g,"''")}'`}buildWithCTE(queries){if(!queries?.length)return;let withSqlChunks=[sql`with `];for(let[i,w]of queries.entries())if(withSqlChunks.push(sql`${sql.identifier(w._.alias)} as (${w._.sql})`),i<queries.length-1)withSqlChunks.push(sql`, `);return withSqlChunks.push(sql` `),sql.join(withSqlChunks)}buildDeleteQuery({table,where,returning,withList}){let withSql=this.buildWithCTE(withList),returningSql=returning?sql` returning ${this.buildSelection(returning,{isSingleTable:!0})}`:void 0,whereSql=where?sql` where ${where}`:void 0;return sql`${withSql}delete from ${table}${whereSql}${returningSql}`}buildUpdateSet(table,set2){let tableColumns=table[Table.Symbol.Columns],columnNames=Object.keys(tableColumns).filter((colName)=>set2[colName]!==void 0||tableColumns[colName]?.onUpdateFn!==void 0),setSize=columnNames.length;return sql.join(columnNames.flatMap((colName,i)=>{let col=tableColumns[colName],value=set2[colName]??sql.param(col.onUpdateFn(),col),res=sql`${sql.identifier(this.casing.getColumnCasing(col))} = ${value}`;if(i<setSize-1)return[res,sql.raw(", ")];return[res]}))}buildUpdateQuery({table,set:set2,where,returning,withList,from,joins}){let withSql=this.buildWithCTE(withList),tableName=table[PgTable.Symbol.Name],tableSchema=table[PgTable.Symbol.Schema],origTableName=table[PgTable.Symbol.OriginalName],alias=tableName===origTableName?void 0:tableName,tableSql=sql`${tableSchema?sql`${sql.identifier(tableSchema)}.`:void 0}${sql.identifier(origTableName)}${alias&&sql` ${sql.identifier(alias)}`}`,setSql=this.buildUpdateSet(table,set2),fromSql=from&&sql.join([sql.raw(" from "),this.buildFromTable(from)]),joinsSql=this.buildJoins(joins),returningSql=returning?sql` returning ${this.buildSelection(returning,{isSingleTable:!from})}`:void 0,whereSql=where?sql` where ${where}`:void 0;return sql`${withSql}update ${tableSql} set ${setSql}${fromSql}${joinsSql}${whereSql}${returningSql}`}buildSelection(fields,{isSingleTable=!1}={}){let columnsLen=fields.length,chunks=fields.flatMap(({field},i)=>{let chunk=[];if(is(field,SQL.Aliased)&&field.isSelectionField)chunk.push(sql.identifier(field.fieldAlias));else if(is(field,SQL.Aliased)||is(field,SQL)){let query=is(field,SQL.Aliased)?field.sql:field;if(isSingleTable)chunk.push(new SQL(query.queryChunks.map((c)=>{if(is(c,PgColumn))return sql.identifier(this.casing.getColumnCasing(c));return c})));else chunk.push(query);if(is(field,SQL.Aliased))chunk.push(sql` as ${sql.identifier(field.fieldAlias)}`)}else if(is(field,Column))if(isSingleTable)chunk.push(sql.identifier(this.casing.getColumnCasing(field)));else chunk.push(field);if(i<columnsLen-1)chunk.push(sql`, `);return chunk});return sql.join(chunks)}buildJoins(joins){if(!joins||joins.length===0)return;let joinsArray=[];for(let[index,joinMeta]of joins.entries()){if(index===0)joinsArray.push(sql` `);let table=joinMeta.table,lateralSql=joinMeta.lateral?sql` lateral`:void 0,onSql=joinMeta.on?sql` on ${joinMeta.on}`:void 0;if(is(table,PgTable)){let tableName=table[PgTable.Symbol.Name],tableSchema=table[PgTable.Symbol.Schema],origTableName=table[PgTable.Symbol.OriginalName],alias=tableName===origTableName?void 0:joinMeta.alias;joinsArray.push(sql`${sql.raw(joinMeta.joinType)} join${lateralSql} ${tableSchema?sql`${sql.identifier(tableSchema)}.`:void 0}${sql.identifier(origTableName)}${alias&&sql` ${sql.identifier(alias)}`}${onSql}`)}else if(is(table,View)){let viewName=table[ViewBaseConfig].name,viewSchema=table[ViewBaseConfig].schema,origViewName=table[ViewBaseConfig].originalName,alias=viewName===origViewName?void 0:joinMeta.alias;joinsArray.push(sql`${sql.raw(joinMeta.joinType)} join${lateralSql} ${viewSchema?sql`${sql.identifier(viewSchema)}.`:void 0}${sql.identifier(origViewName)}${alias&&sql` ${sql.identifier(alias)}`}${onSql}`)}else joinsArray.push(sql`${sql.raw(joinMeta.joinType)} join${lateralSql} ${table}${onSql}`);if(index<joins.length-1)joinsArray.push(sql` `)}return sql.join(joinsArray)}buildFromTable(table){if(is(table,Table)&&table[Table.Symbol.IsAlias]){let fullName=sql`${sql.identifier(table[Table.Symbol.OriginalName])}`;if(table[Table.Symbol.Schema])fullName=sql`${sql.identifier(table[Table.Symbol.Schema])}.${fullName}`;return sql`${fullName} ${sql.identifier(table[Table.Symbol.Name])}`}return table}buildSelectQuery({withList,fields,fieldsFlat,where,having,table,joins,orderBy,groupBy,limit,offset,lockingClause,distinct,setOperators}){let fieldsList=fieldsFlat??orderSelectedFields(fields);for(let f of fieldsList)if(is(f.field,Column)&&getTableName(f.field.table)!==(is(table,Subquery)?table._.alias:is(table,PgViewBase)?table[ViewBaseConfig].name:is(table,SQL)?void 0:getTableName(table))&&!((table2)=>joins?.some(({alias})=>alias===(table2[Table.Symbol.IsAlias]?getTableName(table2):table2[Table.Symbol.BaseName])))(f.field.table)){let tableName=getTableName(f.field.table);throw new Error(`Your "${f.path.join("->")}" field references a column "${tableName}"."${f.field.name}", but the table "${tableName}" is not part of the query! Did you forget to join it?`)}let isSingleTable=!joins||joins.length===0,withSql=this.buildWithCTE(withList),distinctSql;if(distinct)distinctSql=distinct===!0?sql` distinct`:sql` distinct on (${sql.join(distinct.on,sql`, `)})`;let selection=this.buildSelection(fieldsList,{isSingleTable}),tableSql=this.buildFromTable(table),joinsSql=this.buildJoins(joins),whereSql=where?sql` where ${where}`:void 0,havingSql=having?sql` having ${having}`:void 0,orderBySql;if(orderBy&&orderBy.length>0)orderBySql=sql` order by ${sql.join(orderBy,sql`, `)}`;let groupBySql;if(groupBy&&groupBy.length>0)groupBySql=sql` group by ${sql.join(groupBy,sql`, `)}`;let limitSql=typeof limit==="object"||typeof limit==="number"&&limit>=0?sql` limit ${limit}`:void 0,offsetSql=offset?sql` offset ${offset}`:void 0,lockingClauseSql=sql.empty();if(lockingClause){let clauseSql=sql` for ${sql.raw(lockingClause.strength)}`;if(lockingClause.config.of)clauseSql.append(sql` of ${sql.join(Array.isArray(lockingClause.config.of)?lockingClause.config.of:[lockingClause.config.of],sql`, `)}`);if(lockingClause.config.noWait)clauseSql.append(sql` nowait`);else if(lockingClause.config.skipLocked)clauseSql.append(sql` skip locked`);lockingClauseSql.append(clauseSql)}let finalQuery=sql`${withSql}select${distinctSql} ${selection} from ${tableSql}${joinsSql}${whereSql}${groupBySql}${havingSql}${orderBySql}${limitSql}${offsetSql}${lockingClauseSql}`;if(setOperators.length>0)return this.buildSetOperations(finalQuery,setOperators);return finalQuery}buildSetOperations(leftSelect,setOperators){let[setOperator,...rest]=setOperators;if(!setOperator)throw new Error("Cannot pass undefined values to any set operator");if(rest.length===0)return this.buildSetOperationQuery({leftSelect,setOperator});return this.buildSetOperations(this.buildSetOperationQuery({leftSelect,setOperator}),rest)}buildSetOperationQuery({leftSelect,setOperator:{type:type2,isAll,rightSelect,limit,orderBy,offset}}){let leftChunk=sql`(${leftSelect.getSQL()}) `,rightChunk=sql`(${rightSelect.getSQL()})`,orderBySql;if(orderBy&&orderBy.length>0){let orderByValues=[];for(let singleOrderBy of orderBy)if(is(singleOrderBy,PgColumn))orderByValues.push(sql.identifier(singleOrderBy.name));else if(is(singleOrderBy,SQL)){for(let i=0;i<singleOrderBy.queryChunks.length;i++){let chunk=singleOrderBy.queryChunks[i];if(is(chunk,PgColumn))singleOrderBy.queryChunks[i]=sql.identifier(chunk.name)}orderByValues.push(sql`${singleOrderBy}`)}else orderByValues.push(sql`${singleOrderBy}`);orderBySql=sql` order by ${sql.join(orderByValues,sql`, `)} `}let limitSql=typeof limit==="object"||typeof limit==="number"&&limit>=0?sql` limit ${limit}`:void 0,operatorChunk=sql.raw(`${type2} ${isAll?"all ":""}`),offsetSql=offset?sql` offset ${offset}`:void 0;return sql`${leftChunk}${operatorChunk}${rightChunk}${orderBySql}${limitSql}${offsetSql}`}buildInsertQuery({table,values:valuesOrSelect,onConflict,returning,withList,select:select2,overridingSystemValue_}){let valuesSqlList=[],columns=table[Table.Symbol.Columns],colEntries=Object.entries(columns).filter(([_2,col])=>!col.shouldDisableInsert()),insertOrder=colEntries.map(([,column])=>sql.identifier(this.casing.getColumnCasing(column)));if(select2){let select22=valuesOrSelect;if(is(select22,SQL))valuesSqlList.push(select22);else valuesSqlList.push(select22.getSQL())}else{let values2=valuesOrSelect;valuesSqlList.push(sql.raw("values "));for(let[valueIndex,value]of values2.entries()){let valueList=[];for(let[fieldName,col]of colEntries){let colValue=value[fieldName];if(colValue===void 0||is(colValue,Param)&&colValue.value===void 0)if(col.defaultFn!==void 0){let defaultFnResult=col.defaultFn(),defaultValue=is(defaultFnResult,SQL)?defaultFnResult:sql.param(defaultFnResult,col);valueList.push(defaultValue)}else if(!col.default&&col.onUpdateFn!==void 0){let onUpdateFnResult=col.onUpdateFn(),newValue=is(onUpdateFnResult,SQL)?onUpdateFnResult:sql.param(onUpdateFnResult,col);valueList.push(newValue)}else valueList.push(sql`default`);else valueList.push(colValue)}if(valuesSqlList.push(valueList),valueIndex<values2.length-1)valuesSqlList.push(sql`, `)}}let withSql=this.buildWithCTE(withList),valuesSql=sql.join(valuesSqlList),returningSql=returning?sql` returning ${this.buildSelection(returning,{isSingleTable:!0})}`:void 0,onConflictSql=onConflict?sql` on conflict ${onConflict}`:void 0,overridingSql=overridingSystemValue_===!0?sql`overriding system value `:void 0;return sql`${withSql}insert into ${table} ${insertOrder} ${overridingSql}${valuesSql}${onConflictSql}${returningSql}`}buildRefreshMaterializedViewQuery({view,concurrently,withNoData}){let concurrentlySql=concurrently?sql` concurrently`:void 0,withNoDataSql=withNoData?sql` with no data`:void 0;return sql`refresh materialized view${concurrentlySql} ${view}${withNoDataSql}`}prepareTyping(encoder2){if(is(encoder2,PgJsonb)||is(encoder2,PgJson))return"json";else if(is(encoder2,PgNumeric))return"decimal";else if(is(encoder2,PgTime))return"time";else if(is(encoder2,PgTimestamp)||is(encoder2,PgTimestampString))return"timestamp";else if(is(encoder2,PgDate)||is(encoder2,PgDateString))return"date";else if(is(encoder2,PgUUID))return"uuid";else return"none"}sqlToQuery(sql2,invokeSource){return sql2.toQuery({casing:this.casing,escapeName:this.escapeName,escapeParam:this.escapeParam,escapeString:this.escapeString,prepareTyping:this.prepareTyping,invokeSource})}buildRelationalQueryWithoutPK({fullSchema,schema,tableNamesMap,table,tableConfig,queryConfig:config,tableAlias,nestedQueryRelation,joinOn}){let selection=[],limit,offset,orderBy=[],where,joins=[];if(config===!0)selection=Object.entries(tableConfig.columns).map(([key,value])=>({dbKey:value.name,tsKey:key,field:aliasedTableColumn(value,tableAlias),relationTableTsKey:void 0,isJson:!1,selection:[]}));else{let aliasedColumns=Object.fromEntries(Object.entries(tableConfig.columns).map(([key,value])=>[key,aliasedTableColumn(value,tableAlias)]));if(config.where){let whereSql=typeof config.where==="function"?config.where(aliasedColumns,getOperators()):config.where;where=whereSql&&mapColumnsInSQLToAlias(whereSql,tableAlias)}let fieldsSelection=[],selectedColumns=[];if(config.columns){let isIncludeMode=!1;for(let[field,value]of Object.entries(config.columns)){if(value===void 0)continue;if(field in tableConfig.columns){if(!isIncludeMode&&value===!0)isIncludeMode=!0;selectedColumns.push(field)}}if(selectedColumns.length>0)selectedColumns=isIncludeMode?selectedColumns.filter((c)=>config.columns?.[c]===!0):Object.keys(tableConfig.columns).filter((key)=>!selectedColumns.includes(key))}else selectedColumns=Object.keys(tableConfig.columns);for(let field of selectedColumns){let column=tableConfig.columns[field];fieldsSelection.push({tsKey:field,value:column})}let selectedRelations=[];if(config.with)selectedRelations=Object.entries(config.with).filter((entry)=>!!entry[1]).map(([tsKey,queryConfig])=>({tsKey,queryConfig,relation:tableConfig.relations[tsKey]}));let extras;if(config.extras){extras=typeof config.extras==="function"?config.extras(aliasedColumns,{sql}):config.extras;for(let[tsKey,value]of Object.entries(extras))fieldsSelection.push({tsKey,value:mapColumnsInAliasedSQLToAlias(value,tableAlias)})}for(let{tsKey,value}of fieldsSelection)selection.push({dbKey:is(value,SQL.Aliased)?value.fieldAlias:tableConfig.columns[tsKey].name,tsKey,field:is(value,Column)?aliasedTableColumn(value,tableAlias):value,relationTableTsKey:void 0,isJson:!1,selection:[]});let orderByOrig=typeof config.orderBy==="function"?config.orderBy(aliasedColumns,getOrderByOperators()):config.orderBy??[];if(!Array.isArray(orderByOrig))orderByOrig=[orderByOrig];orderBy=orderByOrig.map((orderByValue)=>{if(is(orderByValue,Column))return aliasedTableColumn(orderByValue,tableAlias);return mapColumnsInSQLToAlias(orderByValue,tableAlias)}),limit=config.limit,offset=config.offset;for(let{tsKey:selectedRelationTsKey,queryConfig:selectedRelationConfigValue,relation}of selectedRelations){let normalizedRelation=normalizeRelation(schema,tableNamesMap,relation),relationTableName=getTableUniqueName(relation.referencedTable),relationTableTsName=tableNamesMap[relationTableName],relationTableAlias=`${tableAlias}_${selectedRelationTsKey}`,joinOn2=and(...normalizedRelation.fields.map((field2,i)=>eq(aliasedTableColumn(normalizedRelation.references[i],relationTableAlias),aliasedTableColumn(field2,tableAlias)))),builtRelation=this.buildRelationalQueryWithoutPK({fullSchema,schema,tableNamesMap,table:fullSchema[relationTableTsName],tableConfig:schema[relationTableTsName],queryConfig:is(relation,One)?selectedRelationConfigValue===!0?{limit:1}:{...selectedRelationConfigValue,limit:1}:selectedRelationConfigValue,tableAlias:relationTableAlias,joinOn:joinOn2,nestedQueryRelation:relation}),field=sql`${sql.identifier(relationTableAlias)}.${sql.identifier("data")}`.as(selectedRelationTsKey);joins.push({on:sql`true`,table:new Subquery(builtRelation.sql,{},relationTableAlias),alias:relationTableAlias,joinType:"left",lateral:!0}),selection.push({dbKey:selectedRelationTsKey,tsKey:selectedRelationTsKey,field,relationTableTsKey:relationTableTsName,isJson:!0,selection:builtRelation.selection})}}if(selection.length===0)throw new DrizzleError({message:`No fields selected for table "${tableConfig.tsName}" ("${tableAlias}")`});let result;if(where=and(joinOn,where),nestedQueryRelation){let field=sql`json_build_array(${sql.join(selection.map(({field:field2,tsKey,isJson})=>isJson?sql`${sql.identifier(`${tableAlias}_${tsKey}`)}.${sql.identifier("data")}`:is(field2,SQL.Aliased)?field2.sql:field2),sql`, `)})`;if(is(nestedQueryRelation,Many))field=sql`coalesce(json_agg(${field}${orderBy.length>0?sql` order by ${sql.join(orderBy,sql`, `)}`:void 0}), '[]'::json)`;let nestedSelection=[{dbKey:"data",tsKey:"data",field:field.as("data"),isJson:!0,relationTableTsKey:tableConfig.tsName,selection}];if(limit!==void 0||offset!==void 0||orderBy.length>0)result=this.buildSelectQuery({table:aliasedTable(table,tableAlias),fields:{},fieldsFlat:[{path:[],field:sql.raw("*")}],where,limit,offset,orderBy,setOperators:[]}),where=void 0,limit=void 0,offset=void 0,orderBy=[];else result=aliasedTable(table,tableAlias);result=this.buildSelectQuery({table:is(result,PgTable)?result:new Subquery(result,{},tableAlias),fields:{},fieldsFlat:nestedSelection.map(({field:field2})=>({path:[],field:is(field2,Column)?aliasedTableColumn(field2,tableAlias):field2})),joins,where,limit,offset,orderBy,setOperators:[]})}else result=this.buildSelectQuery({table:aliasedTable(table,tableAlias),fields:{},fieldsFlat:selection.map(({field})=>({path:[],field:is(field,Column)?aliasedTableColumn(field,tableAlias):field})),joins,where,limit,offset,orderBy,setOperators:[]});return{tableTsKey:tableConfig.tsName,sql:result,selection}}}class TypedQueryBuilder{static[entityKind]="TypedQueryBuilder";getSelectedFields(){return this._.selectedFields}}class PgSelectBuilder{static[entityKind]="PgSelectBuilder";fields;session;dialect;withList=[];distinct;constructor(config){if(this.fields=config.fields,this.session=config.session,this.dialect=config.dialect,config.withList)this.withList=config.withList;this.distinct=config.distinct}authToken;setToken(token){return this.authToken=token,this}from(source){let isPartialSelect=!!this.fields,src=source,fields;if(this.fields)fields=this.fields;else if(is(src,Subquery))fields=Object.fromEntries(Object.keys(src._.selectedFields).map((key)=>[key,src[key]]));else if(is(src,PgViewBase))fields=src[ViewBaseConfig].selectedFields;else if(is(src,SQL))fields={};else fields=getTableColumns(src);return new PgSelectBase({table:src,fields,isPartialSelect,session:this.session,dialect:this.dialect,withList:this.withList,distinct:this.distinct}).setToken(this.authToken)}}class PgSelectQueryBuilderBase extends TypedQueryBuilder{static[entityKind]="PgSelectQueryBuilder";_;config;joinsNotNullableMap;tableName;isPartialSelect;session;dialect;constructor({table,fields,isPartialSelect,session,dialect,withList,distinct}){super();this.config={withList,table,fields:{...fields},distinct,setOperators:[]},this.isPartialSelect=isPartialSelect,this.session=session,this.dialect=dialect,this._={selectedFields:fields},this.tableName=getTableLikeName(table),this.joinsNotNullableMap=typeof this.tableName==="string"?{[this.tableName]:!0}:{}}createJoin(joinType,lateral){return(table,on)=>{let baseTableName=this.tableName,tableName=getTableLikeName(table);if(typeof tableName==="string"&&this.config.joins?.some((join)=>join.alias===tableName))throw new Error(`Alias "${tableName}" is already used in this query`);if(!this.isPartialSelect){if(Object.keys(this.joinsNotNullableMap).length===1&&typeof baseTableName==="string")this.config.fields={[baseTableName]:this.config.fields};if(typeof tableName==="string"&&!is(table,SQL)){let selection=is(table,Subquery)?table._.selectedFields:is(table,View)?table[ViewBaseConfig].selectedFields:table[Table.Symbol.Columns];this.config.fields[tableName]=selection}}if(typeof on==="function")on=on(new Proxy(this.config.fields,new SelectionProxyHandler({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})));if(!this.config.joins)this.config.joins=[];if(this.config.joins.push({on,table,joinType,alias:tableName,lateral}),typeof tableName==="string")switch(joinType){case"left":{this.joinsNotNullableMap[tableName]=!1;break}case"right":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([key])=>[key,!1])),this.joinsNotNullableMap[tableName]=!0;break}case"cross":case"inner":{this.joinsNotNullableMap[tableName]=!0;break}case"full":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([key])=>[key,!1])),this.joinsNotNullableMap[tableName]=!1;break}}return this}}leftJoin=this.createJoin("left",!1);leftJoinLateral=this.createJoin("left",!0);rightJoin=this.createJoin("right",!1);innerJoin=this.createJoin("inner",!1);innerJoinLateral=this.createJoin("inner",!0);fullJoin=this.createJoin("full",!1);crossJoin=this.createJoin("cross",!1);crossJoinLateral=this.createJoin("cross",!0);createSetOperator(type2,isAll){return(rightSelection)=>{let rightSelect=typeof rightSelection==="function"?rightSelection(getPgSetOperators()):rightSelection;if(!haveSameKeys(this.getSelectedFields(),rightSelect.getSelectedFields()))throw new Error("Set operator error (union / intersect / except): selected fields are not the same or are in a different order");return this.config.setOperators.push({type:type2,isAll,rightSelect}),this}}union=this.createSetOperator("union",!1);unionAll=this.createSetOperator("union",!0);intersect=this.createSetOperator("intersect",!1);intersectAll=this.createSetOperator("intersect",!0);except=this.createSetOperator("except",!1);exceptAll=this.createSetOperator("except",!0);addSetOperators(setOperators){return this.config.setOperators.push(...setOperators),this}where(where){if(typeof where==="function")where=where(new Proxy(this.config.fields,new SelectionProxyHandler({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})));return this.config.where=where,this}having(having){if(typeof having==="function")having=having(new Proxy(this.config.fields,new SelectionProxyHandler({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})));return this.config.having=having,this}groupBy(...columns){if(typeof columns[0]==="function"){let groupBy=columns[0](new Proxy(this.config.fields,new SelectionProxyHandler({sqlAliasedBehavior:"alias",sqlBehavior:"sql"})));this.config.groupBy=Array.isArray(groupBy)?groupBy:[groupBy]}else this.config.groupBy=columns;return this}orderBy(...columns){if(typeof columns[0]==="function"){let orderBy=columns[0](new Proxy(this.config.fields,new SelectionProxyHandler({sqlAliasedBehavior:"alias",sqlBehavior:"sql"}))),orderByArray=Array.isArray(orderBy)?orderBy:[orderBy];if(this.config.setOperators.length>0)this.config.setOperators.at(-1).orderBy=orderByArray;else this.config.orderBy=orderByArray}else{let orderByArray=columns;if(this.config.setOperators.length>0)this.config.setOperators.at(-1).orderBy=orderByArray;else this.config.orderBy=orderByArray}return this}limit(limit){if(this.config.setOperators.length>0)this.config.setOperators.at(-1).limit=limit;else this.config.limit=limit;return this}offset(offset){if(this.config.setOperators.length>0)this.config.setOperators.at(-1).offset=offset;else this.config.offset=offset;return this}for(strength,config={}){return this.config.lockingClause={strength,config},this}getSQL(){return this.dialect.buildSelectQuery(this.config)}toSQL(){let{typings:_typings,...rest}=this.dialect.sqlToQuery(this.getSQL());return rest}as(alias){return new Proxy(new Subquery(this.getSQL(),this.config.fields,alias),new SelectionProxyHandler({alias,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}getSelectedFields(){return new Proxy(this.config.fields,new SelectionProxyHandler({alias:this.tableName,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}$dynamic(){return this}}class PgSelectBase extends PgSelectQueryBuilderBase{static[entityKind]="PgSelect";_prepare(name){let{session,config,dialect,joinsNotNullableMap,authToken}=this;if(!session)throw new Error("Cannot execute a query on a query builder. Please use a database instance instead.");return tracer.startActiveSpan("drizzle.prepareQuery",()=>{let fieldsList=orderSelectedFields(config.fields),query=session.prepareQuery(dialect.sqlToQuery(this.getSQL()),fieldsList,name,!0);return query.joinsNotNullableMap=joinsNotNullableMap,query.setToken(authToken)})}prepare(name){return this._prepare(name)}authToken;setToken(token){return this.authToken=token,this}execute=(placeholderValues)=>{return tracer.startActiveSpan("drizzle.operation",()=>{return this._prepare().execute(placeholderValues,this.authToken)})}}applyMixins(PgSelectBase,[QueryPromise]);function createSetOperator(type2,isAll){return(leftSelect,rightSelect,...restSelects)=>{let setOperators=[rightSelect,...restSelects].map((select2)=>({type:type2,isAll,rightSelect:select2}));for(let setOperator of setOperators)if(!haveSameKeys(leftSelect.getSelectedFields(),setOperator.rightSelect.getSelectedFields()))throw new Error("Set operator error (union / intersect / except): selected fields are not the same or are in a different order");return leftSelect.addSetOperators(setOperators)}}var getPgSetOperators=()=>({union,unionAll,intersect,intersectAll,except,exceptAll}),union=createSetOperator("union",!1),unionAll=createSetOperator("union",!0),intersect=createSetOperator("intersect",!1),intersectAll=createSetOperator("intersect",!0),except=createSetOperator("except",!1),exceptAll=createSetOperator("except",!0);class QueryBuilder{static[entityKind]="PgQueryBuilder";dialect;dialectConfig;constructor(dialect){this.dialect=is(dialect,PgDialect)?dialect:void 0,this.dialectConfig=is(dialect,PgDialect)?void 0:dialect}$with=(alias,selection)=>{let queryBuilder=this;return{as:(qb)=>{if(typeof qb==="function")qb=qb(queryBuilder);return new Proxy(new WithSubquery(qb.getSQL(),selection??("getSelectedFields"in qb?qb.getSelectedFields()??{}:{}),alias,!0),new SelectionProxyHandler({alias,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}}};with(...queries){let self2=this;function select2(fields){return new PgSelectBuilder({fields:fields??void 0,session:void 0,dialect:self2.getDialect(),withList:queries})}function selectDistinct(fields){return new PgSelectBuilder({fields:fields??void 0,session:void 0,dialect:self2.getDialect(),distinct:!0})}function selectDistinctOn(on,fields){return new PgSelectBuilder({fields:fields??void 0,session:void 0,dialect:self2.getDialect(),distinct:{on}})}return{select:select2,selectDistinct,selectDistinctOn}}select(fields){return new PgSelectBuilder({fields:fields??void 0,session:void 0,dialect:this.getDialect()})}selectDistinct(fields){return new PgSelectBuilder({fields:fields??void 0,session:void 0,dialect:this.getDialect(),distinct:!0})}selectDistinctOn(on,fields){return new PgSelectBuilder({fields:fields??void 0,session:void 0,dialect:this.getDialect(),distinct:{on}})}getDialect(){if(!this.dialect)this.dialect=new PgDialect(this.dialectConfig);return this.dialect}}class PgInsertBuilder{constructor(table,session,dialect,withList,overridingSystemValue_){this.table=table,this.session=session,this.dialect=dialect,this.withList=withList,this.overridingSystemValue_=overridingSystemValue_}static[entityKind]="PgInsertBuilder";authToken;setToken(token){return this.authToken=token,this}overridingSystemValue(){return this.overridingSystemValue_=!0,this}values(values2){if(values2=Array.isArray(values2)?values2:[values2],values2.length===0)throw new Error("values() must be called with at least one value");let mappedValues=values2.map((entry)=>{let result={},cols=this.table[Table.Symbol.Columns];for(let colKey of Object.keys(entry)){let colValue=entry[colKey];result[colKey]=is(colValue,SQL)?colValue:new Param(colValue,cols[colKey])}return result});return new PgInsertBase(this.table,mappedValues,this.session,this.dialect,this.withList,!1,this.overridingSystemValue_).setToken(this.authToken)}select(selectQuery){let select2=typeof selectQuery==="function"?selectQuery(new QueryBuilder):selectQuery;if(!is(select2,SQL)&&!haveSameKeys(this.table[Columns],select2._.selectedFields))throw new Error("Insert select error: selected fields are not the same or are in a different order compared to the table definition");return new PgInsertBase(this.table,select2,this.session,this.dialect,this.withList,!0)}}class PgInsertBase extends QueryPromise{constructor(table,values2,session,dialect,withList,select2,overridingSystemValue_){super();this.session=session,this.dialect=dialect,this.config={table,values:values2,withList,select:select2,overridingSystemValue_}}static[entityKind]="PgInsert";config;returning(fields=this.config.table[Table.Symbol.Columns]){return this.config.returningFields=fields,this.config.returning=orderSelectedFields(fields),this}onConflictDoNothing(config={}){if(config.target===void 0)this.config.onConflict=sql`do nothing`;else{let targetColumn="";targetColumn=Array.isArray(config.target)?config.target.map((it)=>this.dialect.escapeName(this.dialect.casing.getColumnCasing(it))).join(","):this.dialect.escapeName(this.dialect.casing.getColumnCasing(config.target));let whereSql=config.where?sql` where ${config.where}`:void 0;this.config.onConflict=sql`(${sql.raw(targetColumn)})${whereSql} do nothing`}return this}onConflictDoUpdate(config){if(config.where&&(config.targetWhere||config.setWhere))throw new Error('You cannot use both "where" and "targetWhere"/"setWhere" at the same time - "where" is deprecated, use "targetWhere" or "setWhere" instead.');let whereSql=config.where?sql` where ${config.where}`:void 0,targetWhereSql=config.targetWhere?sql` where ${config.targetWhere}`:void 0,setWhereSql=config.setWhere?sql` where ${config.setWhere}`:void 0,setSql=this.dialect.buildUpdateSet(this.config.table,mapUpdateSet(this.config.table,config.set)),targetColumn="";return targetColumn=Array.isArray(config.target)?config.target.map((it)=>this.dialect.escapeName(this.dialect.casing.getColumnCasing(it))).join(","):this.dialect.escapeName(this.dialect.casing.getColumnCasing(config.target)),this.config.onConflict=sql`(${sql.raw(targetColumn)})${targetWhereSql} do update set ${setSql}${whereSql}${setWhereSql}`,this}getSQL(){return this.dialect.buildInsertQuery(this.config)}toSQL(){let{typings:_typings,...rest}=this.dialect.sqlToQuery(this.getSQL());return rest}_prepare(name){return tracer.startActiveSpan("drizzle.prepareQuery",()=>{return this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning,name,!0)})}prepare(name){return this._prepare(name)}authToken;setToken(token){return this.authToken=token,this}execute=(placeholderValues)=>{return tracer.startActiveSpan("drizzle.operation",()=>{return this._prepare().execute(placeholderValues,this.authToken)})};getSelectedFields(){return this.config.returningFields?new Proxy(this.config.returningFields,new SelectionProxyHandler({alias:getTableName(this.config.table),sqlAliasedBehavior:"alias",sqlBehavior:"error"})):void 0}$dynamic(){return this}}class PgRefreshMaterializedView extends QueryPromise{constructor(view,session,dialect){super();this.session=session,this.dialect=dialect,this.config={view}}static[entityKind]="PgRefreshMaterializedView";config;concurrently(){if(this.config.withNoData!==void 0)throw new Error("Cannot use concurrently and withNoData together");return this.config.concurrently=!0,this}withNoData(){if(this.config.concurrently!==void 0)throw new Error("Cannot use concurrently and withNoData together");return this.config.withNoData=!0,this}getSQL(){return this.dialect.buildRefreshMaterializedViewQuery(this.config)}toSQL(){let{typings:_typings,...rest}=this.dialect.sqlToQuery(this.getSQL());return rest}_prepare(name){return tracer.startActiveSpan("drizzle.prepareQuery",()=>{return this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),void 0,name,!0)})}prepare(name){return this._prepare(name)}authToken;setToken(token){return this.authToken=token,this}execute=(placeholderValues)=>{return tracer.startActiveSpan("drizzle.operation",()=>{return this._prepare().execute(placeholderValues,this.authToken)})}}class PgUpdateBuilder{constructor(table,session,dialect,withList){this.table=table,this.session=session,this.dialect=dialect,this.withList=withList}static[entityKind]="PgUpdateBuilder";authToken;setToken(token){return this.authToken=token,this}set(values2){return new PgUpdateBase(this.table,mapUpdateSet(this.table,values2),this.session,this.dialect,this.withList).setToken(this.authToken)}}class PgUpdateBase extends QueryPromise{constructor(table,set2,session,dialect,withList){super();this.session=session,this.dialect=dialect,this.config={set:set2,table,withList,joins:[]},this.tableName=getTableLikeName(table),this.joinsNotNullableMap=typeof this.tableName==="string"?{[this.tableName]:!0}:{}}static[entityKind]="PgUpdate";config;tableName;joinsNotNullableMap;from(source){let src=source,tableName=getTableLikeName(src);if(typeof tableName==="string")this.joinsNotNullableMap[tableName]=!0;return this.config.from=src,this}getTableLikeFields(table){if(is(table,PgTable))return table[Table.Symbol.Columns];else if(is(table,Subquery))return table._.selectedFields;return table[ViewBaseConfig].selectedFields}createJoin(joinType){return(table,on)=>{let tableName=getTableLikeName(table);if(typeof tableName==="string"&&this.config.joins.some((join)=>join.alias===tableName))throw new Error(`Alias "${tableName}" is already used in this query`);if(typeof on==="function"){let from=this.config.from&&!is(this.config.from,SQL)?this.getTableLikeFields(this.config.from):void 0;on=on(new Proxy(this.config.table[Table.Symbol.Columns],new SelectionProxyHandler({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})),from&&new Proxy(from,new SelectionProxyHandler({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))}if(this.config.joins.push({on,table,joinType,alias:tableName}),typeof tableName==="string")switch(joinType){case"left":{this.joinsNotNullableMap[tableName]=!1;break}case"right":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([key])=>[key,!1])),this.joinsNotNullableMap[tableName]=!0;break}case"inner":{this.joinsNotNullableMap[tableName]=!0;break}case"full":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([key])=>[key,!1])),this.joinsNotNullableMap[tableName]=!1;break}}return this}}leftJoin=this.createJoin("left");rightJoin=this.createJoin("right");innerJoin=this.createJoin("inner");fullJoin=this.createJoin("full");where(where){return this.config.where=where,this}returning(fields){if(!fields){if(fields=Object.assign({},this.config.table[Table.Symbol.Columns]),this.config.from){let tableName=getTableLikeName(this.config.from);if(typeof tableName==="string"&&this.config.from&&!is(this.config.from,SQL)){let fromFields=this.getTableLikeFields(this.config.from);fields[tableName]=fromFields}for(let join of this.config.joins){let tableName2=getTableLikeName(join.table);if(typeof tableName2==="string"&&!is(join.table,SQL)){let fromFields=this.getTableLikeFields(join.table);fields[tableName2]=fromFields}}}}return this.config.returningFields=fields,this.config.returning=orderSelectedFields(fields),this}getSQL(){return this.dialect.buildUpdateQuery(this.config)}toSQL(){let{typings:_typings,...rest}=this.dialect.sqlToQuery(this.getSQL());return rest}_prepare(name){let query=this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning,name,!0);return query.joinsNotNullableMap=this.joinsNotNullableMap,query}prepare(name){return this._prepare(name)}authToken;setToken(token){return this.authToken=token,this}execute=(placeholderValues)=>{return this._prepare().execute(placeholderValues,this.authToken)};getSelectedFields(){return this.config.returningFields?new Proxy(this.config.returningFields,new SelectionProxyHandler({alias:getTableName(this.config.table),sqlAliasedBehavior:"alias",sqlBehavior:"error"})):void 0}$dynamic(){return this}}class PgCountBuilder extends SQL{constructor(params){super(PgCountBuilder.buildEmbeddedCount(params.source,params.filters).queryChunks);this.params=params,this.mapWith(Number),this.session=params.session,this.sql=PgCountBuilder.buildCount(params.source,params.filters)}sql;token;static[entityKind]="PgCountBuilder";[Symbol.toStringTag]="PgCountBuilder";session;static buildEmbeddedCount(source,filters){return sql`(select count(*) from ${source}${sql.raw(" where ").if(filters)}${filters})`}static buildCount(source,filters){return sql`select count(*) as count from ${source}${sql.raw(" where ").if(filters)}${filters};`}setToken(token){return this.token=token,this}then(onfulfilled,onrejected){return Promise.resolve(this.session.count(this.sql,this.token)).then(onfulfilled,onrejected)}catch(onRejected){return this.then(void 0,onRejected)}finally(onFinally){return this.then((value)=>{return onFinally?.(),value},(reason)=>{throw onFinally?.(),reason})}}class RelationalQueryBuilder{constructor(fullSchema,schema,tableNamesMap,table,tableConfig,dialect,session){this.fullSchema=fullSchema,this.schema=schema,this.tableNamesMap=tableNamesMap,this.table=table,this.tableConfig=tableConfig,this.dialect=dialect,this.session=session}static[entityKind]="PgRelationalQueryBuilder";findMany(config){return new PgRelationalQuery(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,config?config:{},"many")}findFirst(config){return new PgRelationalQuery(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,config?{...config,limit:1}:{limit:1},"first")}}class PgRelationalQuery extends QueryPromise{constructor(fullSchema,schema,tableNamesMap,table,tableConfig,dialect,session,config,mode){super();this.fullSchema=fullSchema,this.schema=schema,this.tableNamesMap=tableNamesMap,this.table=table,this.tableConfig=tableConfig,this.dialect=dialect,this.session=session,this.config=config,this.mode=mode}static[entityKind]="PgRelationalQuery";_prepare(name){return tracer.startActiveSpan("drizzle.prepareQuery",()=>{let{query,builtQuery}=this._toSQL();return this.session.prepareQuery(builtQuery,void 0,name,!0,(rawRows,mapColumnValue)=>{let rows=rawRows.map((row)=>mapRelationalRow(this.schema,this.tableConfig,row,query.selection,mapColumnValue));if(this.mode==="first")return rows[0];return rows})})}prepare(name){return this._prepare(name)}_getQuery(){return this.dialect.buildRelationalQueryWithoutPK({fullSchema:this.fullSchema,schema:this.schema,tableNamesMap:this.tableNamesMap,table:this.table,tableConfig:this.tableConfig,queryConfig:this.config,tableAlias:this.tableConfig.tsName})}getSQL(){return this._getQuery().sql}_toSQL(){let query=this._getQuery(),builtQuery=this.dialect.sqlToQuery(query.sql);return{query,builtQuery}}toSQL(){return this._toSQL().builtQuery}authToken;setToken(token){return this.authToken=token,this}execute(){return tracer.startActiveSpan("drizzle.operation",()=>{return this._prepare().execute(void 0,this.authToken)})}}class PgRaw extends QueryPromise{constructor(execute,sql2,query,mapBatchResult){super();this.execute=execute,this.sql=sql2,this.query=query,this.mapBatchResult=mapBatchResult}static[entityKind]="PgRaw";getSQL(){return this.sql}getQuery(){return this.query}mapResult(result,isFromBatch){return isFromBatch?this.mapBatchResult(result):result}_prepare(){return this}isResponseInArrayMode(){return!1}}class PgDatabase{constructor(dialect,session,schema){if(this.dialect=dialect,this.session=session,this._=schema?{schema:schema.schema,fullSchema:schema.fullSchema,tableNamesMap:schema.tableNamesMap,session}:{schema:void 0,fullSchema:{},tableNamesMap:{},session},this.query={},this._.schema)for(let[tableName,columns]of Object.entries(this._.schema))this.query[tableName]=new RelationalQueryBuilder(schema.fullSchema,this._.schema,this._.tableNamesMap,schema.fullSchema[tableName],columns,dialect,session)}static[entityKind]="PgDatabase";query;$with=(alias,selection)=>{let self2=this;return{as:(qb)=>{if(typeof qb==="function")qb=qb(new QueryBuilder(self2.dialect));return new Proxy(new WithSubquery(qb.getSQL(),selection??("getSelectedFields"in qb?qb.getSelectedFields()??{}:{}),alias,!0),new SelectionProxyHandler({alias,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}}};$count(source,filters){return new PgCountBuilder({source,filters,session:this.session})}with(...queries){let self2=this;function select2(fields){return new PgSelectBuilder({fields:fields??void 0,session:self2.session,dialect:self2.dialect,withList:queries})}function selectDistinct(fields){return new PgSelectBuilder({fields:fields??void 0,session:self2.session,dialect:self2.dialect,withList:queries,distinct:!0})}function selectDistinctOn(on,fields){return new PgSelectBuilder({fields:fields??void 0,session:self2.session,dialect:self2.dialect,withList:queries,distinct:{on}})}function update(table){return new PgUpdateBuilder(table,self2.session,self2.dialect,queries)}function insert(table){return new PgInsertBuilder(table,self2.session,self2.dialect,queries)}function delete_(table){return new PgDeleteBase(table,self2.session,self2.dialect,queries)}return{select:select2,selectDistinct,selectDistinctOn,update,insert,delete:delete_}}select(fields){return new PgSelectBuilder({fields:fields??void 0,session:this.session,dialect:this.dialect})}selectDistinct(fields){return new PgSelectBuilder({fields:fields??void 0,session:this.session,dialect:this.dialect,distinct:!0})}selectDistinctOn(on,fields){return new PgSelectBuilder({fields:fields??void 0,session:this.session,dialect:this.dialect,distinct:{on}})}update(table){return new PgUpdateBuilder(table,this.session,this.dialect)}insert(table){return new PgInsertBuilder(table,this.session,this.dialect)}delete(table){return new PgDeleteBase(table,this.session,this.dialect)}refreshMaterializedView(view){return new PgRefreshMaterializedView(view,this.session,this.dialect)}authToken;execute(query){let sequel=typeof query==="string"?sql.raw(query):query.getSQL(),builtQuery=this.dialect.sqlToQuery(sequel),prepared=this.session.prepareQuery(builtQuery,void 0,void 0,!1);return new PgRaw(()=>prepared.execute(void 0,this.authToken),sequel,builtQuery,(result)=>prepared.mapResult(result,!0))}transaction(transaction,config){return this.session.transaction(transaction,config)}}class IndexBuilderOn{constructor(unique,name){this.unique=unique,this.name=name}static[entityKind]="PgIndexBuilderOn";on(...columns){return new IndexBuilder(columns.map((it)=>{if(is(it,SQL))return it;it=it;let clonedIndexedColumn=new IndexedColumn(it.name,!!it.keyAsName,it.columnType,it.indexConfig);return it.indexConfig=JSON.parse(JSON.stringify(it.defaultConfig)),clonedIndexedColumn}),this.unique,!1,this.name)}onOnly(...columns){return new IndexBuilder(columns.map((it)=>{if(is(it,SQL))return it;it=it;let clonedIndexedColumn=new IndexedColumn(it.name,!!it.keyAsName,it.columnType,it.indexConfig);return it.indexConfig=it.defaultConfig,clonedIndexedColumn}),this.unique,!0,this.name)}using(method,...columns){return new IndexBuilder(columns.map((it)=>{if(is(it,SQL))return it;it=it;let clonedIndexedColumn=new IndexedColumn(it.name,!!it.keyAsName,it.columnType,it.indexConfig);return it.indexConfig=JSON.parse(JSON.stringify(it.defaultConfig)),clonedIndexedColumn}),this.unique,!0,this.name,method)}}class IndexBuilder{static[entityKind]="PgIndexBuilder";config;constructor(columns,unique,only,name,method="btree"){this.config={name,columns,unique,only,method}}concurrently(){return this.config.concurrently=!0,this}with(obj){return this.config.with=obj,this}where(condition){return this.config.where=condition,this}build(table){return new Index2(this.config,table)}}class Index2{static[entityKind]="PgIndex";config;constructor(config,table){this.config={...config,table}}}function index(name){return new IndexBuilderOn(!1,name)}function uniqueIndex(name){return new IndexBuilderOn(!0,name)}class PgPreparedQuery{constructor(query){this.query=query}authToken;getQuery(){return this.query}mapResult(response,_isFromBatch){return response}setToken(token){return this.authToken=token,this}static[entityKind]="PgPreparedQuery";joinsNotNullableMap}class PgSession{constructor(dialect){this.dialect=dialect}static[entityKind]="PgSession";execute(query,token){return tracer.startActiveSpan("drizzle.operation",()=>{return tracer.startActiveSpan("drizzle.prepareQuery",()=>{return this.prepareQuery(this.dialect.sqlToQuery(query),void 0,void 0,!1)}).setToken(token).execute(void 0,token)})}all(query){return this.prepareQuery(this.dialect.sqlToQuery(query),void 0,void 0,!1).all()}async count(sql2,token){let res=await this.execute(sql2,token);return Number(res[0].count)}}class PgTransaction extends PgDatabase{constructor(dialect,session,schema,nestedIndex=0){super(dialect,session,schema);this.schema=schema,this.nestedIndex=nestedIndex}static[entityKind]="PgTransaction";rollback(){throw new TransactionRollbackError}getTransactionConfigSQL(config){let chunks=[];if(config.isolationLevel)chunks.push(`isolation level ${config.isolationLevel}`);if(config.accessMode)chunks.push(config.accessMode);if(typeof config.deferrable==="boolean")chunks.push(config.deferrable?"deferrable":"not deferrable");return sql.raw(chunks.join(" "))}setTransaction(config){return this.session.execute(sql`set transaction ${this.getTransactionConfigSQL(config)}`)}}class PostgresJsPreparedQuery extends PgPreparedQuery{constructor(client,queryString,params,logger,fields,_isResponseInArrayMode,customResultMapper){super({sql:queryString,params});this.client=client,this.queryString=queryString,this.params=params,this.logger=logger,this.fields=fields,this._isResponseInArrayMode=_isResponseInArrayMode,this.customResultMapper=customResultMapper}static[entityKind]="PostgresJsPreparedQuery";async execute(placeholderValues={}){return tracer.startActiveSpan("drizzle.execute",async(span)=>{let params=fillPlaceholders(this.params,placeholderValues);span?.setAttributes({"drizzle.query.text":this.queryString,"drizzle.query.params":JSON.stringify(params)}),this.logger.logQuery(this.queryString,params);let{fields,queryString:query,client,joinsNotNullableMap,customResultMapper}=this;if(!fields&&!customResultMapper)return tracer.startActiveSpan("drizzle.driver.execute",()=>{return client.unsafe(query,params)});let rows=await tracer.startActiveSpan("drizzle.driver.execute",()=>{return span?.setAttributes({"drizzle.query.text":query,"drizzle.query.params":JSON.stringify(params)}),client.unsafe(query,params).values()});return tracer.startActiveSpan("drizzle.mapResponse",()=>{return customResultMapper?customResultMapper(rows):rows.map((row)=>mapResultRow(fields,row,joinsNotNullableMap))})})}all(placeholderValues={}){return tracer.startActiveSpan("drizzle.execute",async(span)=>{let params=fillPlaceholders(this.params,placeholderValues);return span?.setAttributes({"drizzle.query.text":this.queryString,"drizzle.query.params":JSON.stringify(params)}),this.logger.logQuery(this.queryString,params),tracer.startActiveSpan("drizzle.driver.execute",()=>{return span?.setAttributes({"drizzle.query.text":this.queryString,"drizzle.query.params":JSON.stringify(params)}),this.client.unsafe(this.queryString,params)})})}isResponseInArrayMode(){return this._isResponseInArrayMode}}class PostgresJsSession extends PgSession{constructor(client,dialect,schema,options={}){super(dialect);this.client=client,this.schema=schema,this.options=options,this.logger=options.logger??new NoopLogger}static[entityKind]="PostgresJsSession";logger;prepareQuery(query,fields,name,isResponseInArrayMode,customResultMapper){return new PostgresJsPreparedQuery(this.client,query.sql,query.params,this.logger,fields,isResponseInArrayMode,customResultMapper)}query(query,params){return this.logger.logQuery(query,params),this.client.unsafe(query,params).values()}queryObjects(query,params){return this.client.unsafe(query,params)}transaction(transaction,config){return this.client.begin(async(client)=>{let session=new PostgresJsSession(client,this.dialect,this.schema,this.options),tx=new PostgresJsTransaction(this.dialect,session,this.schema);if(config)await tx.setTransaction(config);return transaction(tx)})}}class PostgresJsTransaction extends PgTransaction{constructor(dialect,session,schema,nestedIndex=0){super(dialect,session,schema,nestedIndex);this.session=session}static[entityKind]="PostgresJsTransaction";transaction(transaction){return this.session.client.savepoint((client)=>{let session=new PostgresJsSession(client,this.dialect,this.schema,this.session.options),tx=new PostgresJsTransaction(this.dialect,session,this.schema);return transaction(tx)})}}class PostgresJsDatabase extends PgDatabase{static[entityKind]="PostgresJsDatabase"}function construct(client,config={}){let transparentParser=(val)=>val;for(let type2 of["1184","1082","1083","1114","1182","1185","1115","1231"])client.options.parsers[type2]=transparentParser,client.options.serializers[type2]=transparentParser;client.options.serializers["114"]=transparentParser,client.options.serializers["3802"]=transparentParser;let dialect=new PgDialect({casing:config.casing}),logger;if(config.logger===!0)logger=new DefaultLogger;else if(config.logger!==!1)logger=config.logger;let schema;if(config.schema){let tablesConfig=extractTablesRelationalConfig(config.schema,createTableRelationsHelpers);schema={fullSchema:config.schema,schema:tablesConfig.tables,tableNamesMap:tablesConfig.tableNamesMap}}let session=new PostgresJsSession(client,dialect,schema,{logger}),db=new PostgresJsDatabase(dialect,session,schema);return db.$client=client,db}function drizzle(...params){if(typeof params[0]==="string"){let instance=src_default(params[0]);return construct(instance,params[1])}if(isConfig(params[0])){let{connection:connection2,client,...drizzleConfig}=params[0];if(client)return construct(client,drizzleConfig);if(typeof connection2==="object"&&connection2.url!==void 0){let{url,...config}=connection2,instance2=src_default(url,config);return construct(instance2,drizzleConfig)}let instance=src_default(connection2);return construct(instance,drizzleConfig)}return construct(params[0],params[1])}((drizzle2)=>{function mock(config){return construct({options:{parsers:{},serializers:{}}},config)}drizzle2.mock=mock})(drizzle||(drizzle={}));var connectionString=process.env.POSTGRES_URL_LOCAL,queryClient=src_default(connectionString),mainDb=drizzle(queryClient);var users=pgTable("users",{id:uuid("id").defaultRandom().primaryKey(),username:text("username").notNull(),email:text("email").unique().notNull(),password:text("password").notNull(),phoneNumber:text("phoneNumber").unique().notNull(),role:text("role").notNull().default("owner"),createdAt:timestamp("created_at").defaultNow(),updatedAt:timestamp("updated_at").notNull().defaultNow().$onUpdate(()=>new Date)},(table)=>({emailIndex:index("idx_email").on(table.email)})),shops=pgTable("shops",{id:uuid("id").defaultRandom().primaryKey(),name:text("name").unique().notNull(),subscription:text("subscription_type",{enum:["Msingi","Lite","Business","Pro","AI","Trial"]}).default("Trial").notNull(),trialStart:timestamp("trial_start",{mode:"date"}),trialEnd:timestamp("trial_end",{mode:"date"}),paidUntil:timestamp("paid_until",{mode:"date"}),createdAt:timestamp("created_at",{mode:"date"}).defaultNow()}),shopUsers=pgTable("shop_users",{id:uuid("id").defaultRandom().primaryKey(),shopId:uuid("shop_id").notNull().references(()=>shops.id,{onDelete:"cascade"}),userId:uuid("user_id").notNull().references(()=>users.id,{onDelete:"cascade"}),role:text("role").notNull().default("assistant"),isPaid:boolean("is_paid").default(!0)},(table)=>({uniqueUserRole:uniqueIndex("unique_user_role").on(table.shopId,table.userId),uniqueUsername:uniqueIndex("unique_username_per_shop").on(table.shopId,table.userId)})),suppliers=pgTable("suppliers",{id:uuid("id").defaultRandom().primaryKey(),company:text("company").notNull(),contact:text("contact").notNull(),shopId:uuid("shop_id").notNull().references(()=>shops.id,{onDelete:"cascade"}),mostSoldProduct:uuid("most_sold_product"),highestProfitProduct:uuid("highest_profit_product"),createdAt:timestamp("created_at").defaultNow()},(table)=>({idx_suppliers_shop_id:index("idx_suppliers_shop_id").on(table.shopId)})),products=pgTable("products",{id:uuid("id").defaultRandom().primaryKey(),name:text("name").notNull(),priceSold:decimal("price_sold",{precision:15,scale:2}).notNull(),stock:doublePrecision("stock").notNull().default(0),shopId:uuid("shop_id").notNull().references(()=>shops.id,{onDelete:"cascade"}),minStock:doublePrecision("min_stock").notNull().default(0),status:text("status").notNull().default("available"),unit:text("unit"),createdAt:timestamp("created_at").defaultNow(),updatedAt:timestamp("updated_at").defaultNow()},(table)=>({uniqueProductShop:uniqueIndex("unique_product_shop").on(table.name,table.shopId)})),purchases=pgTable("purchases",{id:uuid("id").defaultRandom().primaryKey(),productId:uuid("product_id").notNull().references(()=>products.id,{onDelete:"cascade"}),shopId:uuid("shop_id").notNull().references(()=>shops.id,{onDelete:"cascade"}),quantity:doublePrecision("quantity").notNull().default(0),priceBought:decimal("price_bought",{precision:15,scale:2}).notNull(),totalCost:decimal("total_cost",{precision:15,scale:2}).notNull().default("0"),purchaseDate:timestamp("purchase_date").defaultNow(),createdAt:timestamp("created_at").defaultNow().notNull()},(table)=>({idxProductShop:index("idx_purchases_product_shop").on(table.productId,table.shopId)})),supplierPriceHistory=pgTable("supplier_price_history",{id:uuid("id").defaultRandom().primaryKey(),supplierId:uuid("supplier_id").notNull().references(()=>suppliers.id),productId:uuid("product_id").notNull().references(()=>products.id,{onDelete:"cascade"}),shopId:uuid("shop_id").notNull().references(()=>shops.id),price:decimal("price",{precision:15,scale:2}).notNull(),dateAdded:timestamp("date_added").defaultNow(),createdAt:timestamp("created_at").defaultNow()},(table)=>({uniqueSupplierProduct:uniqueIndex("unique_supplier_product").on(table.supplierId,table.productId,table.shopId)})),sales=pgTable("sales",{id:uuid("id").defaultRandom().primaryKey(),productId:uuid("product_id").notNull().references(()=>products.id,{onDelete:"cascade"}),quantity:doublePrecision("quantity").notNull().default(0),priceSold:decimal("price_sold",{precision:15,scale:2}).notNull(),totalSales:decimal("total_sales",{precision:15,scale:2}).notNull(),discount:doublePrecision("discount").notNull().default(0),shopId:uuid("shop_id").notNull().references(()=>shops.id,{onDelete:"cascade"}),saleType:text("sale_type").notNull().default("cash"),customerId:uuid("customer_id"),createdAt:timestamp("created_at").defaultNow().notNull()},(table)=>({idxProductShop:index("idx_sales_product_shop").on(table.productId,table.shopId)})),debts=pgTable("debts",{id:uuid("id").defaultRandom().primaryKey(),productId:uuid("product_id").notNull().references(()=>products.id,{onDelete:"cascade"}),customerId:uuid("customer_id").notNull().references(()=>customers.id,{onDelete:"cascade"}),totalAmount:decimal("total_amount",{precision:15,scale:2}).notNull(),quantity:doublePrecision("quantity").notNull().default(0),remainingAmount:decimal("remaining_amount",{precision:15,scale:2}).notNull(),priceSold:decimal("price_sold",{precision:15,scale:2}).notNull(),totalSales:decimal("total_sales",{precision:15,scale:2}).notNull(),shopId:uuid("shop_id").notNull().references(()=>shops.id,{onDelete:"cascade"}),lastPaymentDate:timestamp("last_payment_date"),createdAt:timestamp("created_at").defaultNow(),updatedAt:timestamp("updated_at").notNull().defaultNow().$onUpdate(()=>new Date)}),debtPayments=pgTable("debt_payments",{id:uuid("id").defaultRandom().primaryKey(),debtId:uuid("debt_id").references(()=>debts.id,{onDelete:"cascade"}),customerId:uuid("customer_id").notNull().references(()=>customers.id,{onDelete:"cascade"}),shopId:uuid("shop_id").notNull().references(()=>shops.id,{onDelete:"cascade"}),amountPaid:decimal("amount_paid",{precision:15,scale:2}).notNull(),paymentDate:timestamp("payment_date").defaultNow()}),customers=pgTable("customers",{id:uuid("id").defaultRandom().primaryKey(),name:text("name").notNull().unique(),shopId:uuid("shop_id").notNull().references(()=>shops.id),contact:text("contact").notNull(),createdAt:timestamp("created_at").defaultNow(),updatedAt:timestamp("updated_at").notNull().defaultNow().$onUpdate(()=>new Date)},(table)=>({uniqueCustomer:uniqueIndex("unique_customer_name_per_shop").on(table.name,table.shopId),uniqueContact:uniqueIndex("unique_customer_contact_per_shop").on(table.contact,table.shopId)})),returns=pgTable("returns",{id:uuid("id").defaultRandom().primaryKey(),productId:uuid("product_id").notNull().references(()=>products.id,{onDelete:"cascade"}),quantity:doublePrecision("quantity").notNull().default(0),shopId:uuid("shop_id").notNull().references(()=>shops.id,{onDelete:"cascade"}),reason:text("reason").notNull(),returnDate:timestamp("return_date").defaultNow(),createdAt:timestamp("created_at").defaultNow()}),expenses=pgTable("expenses",{id:uuid("id").defaultRandom().primaryKey(),description:text("description").notNull(),amount:decimal("amount",{precision:15,scale:2}).notNull(),shopId:uuid("shop_id").notNull().references(()=>shops.id,{onDelete:"cascade"}),date:timestamp("date").defaultNow(),createdAt:timestamp("created_at").defaultNow(),updatedAt:timestamp("updated_at").notNull().defaultNow().$onUpdate(()=>new Date)}),askedProducts=pgTable("asked_products",{id:uuid("id").defaultRandom().primaryKey(),shopId:uuid("shop_id").notNull().references(()=>shops.id,{onDelete:"cascade"}),productName:text("product_name").notNull(),quantityRequested:integer("quantity_requested").notNull().default(0),date:timestamp("date").defaultNow()}),emailVerifications=pgTable("email_verifications",{id:uuid("id").defaultRandom().primaryKey(),token:uuid("token").defaultRandom().notNull().unique(),email:text("email").notNull(),shopName:text("shop_name").notNull(),username:text("username").notNull(),phone:text("phone").notNull(),password:text("password").notNull(),expiresAt:timestamp("expires_at").notNull(),used:boolean("used").notNull().default(!1),createdAt:timestamp("created_at").defaultNow()}),paymentSaaS=pgTable("payment_saas",{id:uuid("id").defaultRandom().primaryKey(),shopId:uuid("shop_id").notNull().references(()=>shops.id,{onDelete:"cascade"}),token:text("token_clickpesa").notNull(),amountToPay:decimal("amount_to_pay",{precision:15,scale:2}).notNull(),orderId:text("order_id"),createdAt:timestamp("created_At").defaultNow()}),notifications=pgTable("notifications",{id:uuid("id").defaultRandom().primaryKey(),shopId:uuid("shop_id").notNull().references(()=>shops.id,{onDelete:"cascade"}),title:text("title").notNull(),message:text("message").notNull(),type:text("type",{enum:["info","warning","error","upgrade"]}).default("info"),isRead:boolean("is_read").default(!1),createdAt:timestamp("created_at").defaultNow()}),passwordResets=pgTable("password_resets",{id:uuid("id").defaultRandom().primaryKey(),email:text("email").notNull(),token:text("token").notNull(),expiresAt:timestamp("expires_at").notNull()});var homeGet=async()=>{try{return await mainDb.delete(emailVerifications).where(eq(emailVerifications.used,!0)),{success:!0,message:"Karibu kwenye seva ya Elysia na Bun!"}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu imetokea kwenye seva"}}};class MemoryCache{cache=new Map;totalSize=0;maxSizeInMB;maxSizeInBytes;constructor(maxSizeInMB=100){this.maxSizeInMB=maxSizeInMB,this.maxSizeInBytes=maxSizeInMB*1024*1024}estimateSize(value){return Buffer.byteLength(JSON.stringify(value))}set(key,value){let size=this.estimateSize(value);if(size>this.maxSizeInBytes)return;this.cache.set(key,{value,size}),this.totalSize+=size,this.evict()}get(key){let entry=this.cache.get(key);if(!entry)return;return this.cache.delete(key),this.cache.set(key,entry),entry.value}delete(key){let entry=this.cache.get(key);if(entry)this.totalSize-=entry.size,this.cache.delete(key)}clear(){this.cache.clear(),this.totalSize=0}evict(){while(this.totalSize>this.maxSizeInBytes){let firstKey=this.cache.keys().next().value;if(!firstKey)break;let entry=this.cache.get(firstKey);if(entry)this.totalSize-=entry.size;this.cache.delete(firstKey)}}getMemoryUsage(){let usedMB=this.totalSize/1048576,freeMB=this.maxSizeInMB-usedMB,usedPercent=usedMB/this.maxSizeInMB*100;return{usedMB,freeMB,usedPercent}}}var userCheckCache=new MemoryCache(15),shopCheckCache=new MemoryCache(15),loginCache=new MemoryCache(40);class CacheStatsTracker{stats={};caches;constructor(caches){this.caches=caches;for(let name in caches)this.stats[name]={hits:0,misses:0}}recordHit(cacheName){if(this.stats[cacheName])this.stats[cacheName].hits++}recordMiss(cacheName){if(this.stats[cacheName])this.stats[cacheName].misses++}getStats(){let result={};for(let name in this.caches){let cache=this.caches[name];result[name]={hits:this.stats[name]?.hits||0,misses:this.stats[name]?.misses||0,usage:cache.getMemoryUsage()}}return result}resetStats(){for(let name in this.stats)this.stats[name]={hits:0,misses:0}}}var caches={userCheckCache,shopCheckCache,loginCache},cacheStatsTracker=new CacheStatsTracker(caches);var homePlugin=new Elysia().get("/",homeGet).get("/cache/stats",()=>{return{cacheStats:cacheStatsTracker.getStats()}}),home_default=homePlugin;var import_argon2=__toESM(require_argon2(),1),hashPassword=async(password)=>{try{return await import_argon2.default.hash(password,{type:import_argon2.default.argon2id,memoryCost:65536,timeCost:12,parallelism:2})}catch(err){throw console.error("Error hashing password:",err),new Error("Failed to hash the password")}},verifyPassword=async(hashedPassword,inputPassword)=>{try{return await import_argon2.default.verify(hashedPassword,inputPassword)}catch(err){return!1}};var import_xss=__toESM(require_lib2(),1),sanitizeNumber=(input)=>{let num=Number(input);return isNaN(num)?0:num},sanitizeString=(input)=>input?import_xss.default(input):"";var byteToHex=[];for(let i=0;i<256;++i)byteToHex.push((i+256).toString(16).slice(1));function unsafeStringify(arr,offset=0){return(byteToHex[arr[offset+0]]+byteToHex[arr[offset+1]]+byteToHex[arr[offset+2]]+byteToHex[arr[offset+3]]+"-"+byteToHex[arr[offset+4]]+byteToHex[arr[offset+5]]+"-"+byteToHex[arr[offset+6]]+byteToHex[arr[offset+7]]+"-"+byteToHex[arr[offset+8]]+byteToHex[arr[offset+9]]+"-"+byteToHex[arr[offset+10]]+byteToHex[arr[offset+11]]+byteToHex[arr[offset+12]]+byteToHex[arr[offset+13]]+byteToHex[arr[offset+14]]+byteToHex[arr[offset+15]]).toLowerCase()}import{randomFillSync}from"crypto";var rnds8Pool=new Uint8Array(256),poolPtr=rnds8Pool.length;function rng(){if(poolPtr>rnds8Pool.length-16)randomFillSync(rnds8Pool),poolPtr=0;return rnds8Pool.slice(poolPtr,poolPtr+=16)}import{randomUUID}from"crypto";var native_default={randomUUID};function v4(options,buf,offset){if(native_default.randomUUID&&!buf&&!options)return native_default.randomUUID();options=options||{};let rnds=options.random??options.rng?.()??rng();if(rnds.length<16)throw new Error("Random bytes length must be >= 16");if(rnds[6]=rnds[6]&15|64,rnds[8]=rnds[8]&63|128,buf){if(offset=offset||0,offset<0||offset+16>buf.length)throw new RangeError(`UUID byte range ${offset}:${offset+15} is out of buffer bounds`);for(let i=0;i<16;++i)buf[offset+i]=rnds[i];return buf}return unsafeStringify(rnds)}var v4_default=v4;var import_nodemailer=__toESM(require_nodemailer(),1),sendMagicLink=async({frontendURL,link,email})=>{await import_nodemailer.default.createTransport({host:"smtp.zoho.com",port:465,secure:!0,auth:{user:"huduma@mypostech.store",pass:process.env.ZOHO_APP_PASSWORD}}).sendMail({from:'"myPosTech" <huduma@mypostech.store>',to:email,subject:"Hakiki barua pepe",html:`
        <!DOCTYPE html>
        <html lang="sw">
        <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>Thibitisha Barua Pepe</title>
        <style>
            body {
            font-family: 'Quicksand', sans-serif;
            background-color: #e2e8f0;
            padding: 1rem;
            color: #1f2937;
            font-size: 14px;
            margin: 0;
            }
            .container {
            max-width: 28rem;
            margin: 0 auto;
            background: white;
            border: 2px solid #334155;
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            }
            .header {
            text-align: center;
            padding: 2rem 1.5rem;
            background: linear-gradient(to top, #8324f0, #163ce7);
            }
            .header img {
            width: 5rem;
            margin: 0 auto 1rem;
            }
            .header h2 {
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
            }
            .content {
            padding: 2rem 1.5rem;
            text-align: center;
            }
            .content p {
            margin-bottom: 1.5rem;
            font-size: 14px;
            }
            .content a {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border: 2px solid #334155;
            background-color: #c7bbfc;
            color: #111827;
            font-weight: bold;
            border-radius: 9999px;
            text-decoration: none;
            }
            .footer {
            margin-top: 2rem;
            font-size: 12px;
            color: #6b7280;
            }
        </style>
        </head>
        <body>
        <div class="container">
            <div class="header">
                <img src="${frontendURL}/thumbail.png" alt="App Logo">
                <h2>Thibitisha Barua Pepe Yako</h2>
            </div>
            <div class="content">
            <p>Habari! Tafadhali bonyeza kitufe hapa chini kuthibitisha anwani yako ya barua pepe 
                <span style="color: #ef4444;">kabla ya dakika 20</span>.
            </p>
            <a href="${link}">Thibitisha Barua Pepe</a>
            <div class="footer">
                <p>Ikiwa hukutuma ombi la akaunti au ujumbe huu, tafadhali puuza barua pepe hii.</p>
            </div>
            </div>
        </div>
        </body>
        </html>
    `})};var regPost=async({body,headers})=>{let frontendURL=process.env.FRONTEND_URL_DEV;try{let{name,username,email,password,phoneNumber}=body;name=sanitizeString(name.trim().toLowerCase()),username=sanitizeString(username.trim().toLowerCase()),email=sanitizeString(email.trim()),password=sanitizeString(password.trim()),phoneNumber=sanitizeString(phoneNumber.trim());let[existingUserCached,existingShopCached]=await Promise.all([userCheckCache.get(`user:${email}`),shopCheckCache.get(`shop:${name}`)]);if(existingUserCached)return cacheStatsTracker.recordHit("userCheckCache"),{success:!1,message:"Email tayari imeshatumika"};if(existingShopCached)return cacheStatsTracker.recordHit("shopCheckCache"),{success:!1,message:"Duka tayari limesajiliwa"};cacheStatsTracker.recordMiss("userCheckCache"),cacheStatsTracker.recordMiss("shopCheckCache");let[existingUser,existingShop]=await Promise.all([mainDb.select({id:users.id}).from(users).where(eq(users.email,email)).limit(1),mainDb.select({id:shops.id}).from(shops).where(eq(shops.name,name)).limit(1)]);if(existingUser.length>0)return userCheckCache.set(`user:${email}`,{exists:!0}),{success:!1,message:"Email tayari imeshatumika"};if(existingShop.length>0)return shopCheckCache.set(`shop:${name}`,{exists:!0}),{success:!1,message:"Duka tayari limesajiliwa"};let token=v4_default(),hashedPassword=await hashPassword(password);await mainDb.insert(emailVerifications).values({token,email:body.email,password:hashedPassword,phone:body.phoneNumber,shopName:body.name,username:body.username,expiresAt:new Date(Date.now()+1200000),used:!1});let link=`${frontendURL}/email?token=${token}`;return await sendMagicLink({link,frontendURL,email:body.email}),{success:!0,message:"Ingia kwenye email yako kuhakiki"}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:sanitizeString("Hitilafu imetokea kwenye seva")}}};var suppData=t.Object({company:t.String({maxLength:40,minLength:3,error(){return{success:!1,message:"Jina haliwezi kuwa chini ya herufi 3, na juu ya herufi 40"}}}),contact:t.String({maxLength:40,minLength:3,error(){return{success:!1,message:"Mawasiliano haliwezi kuwa chini ya herufi 3, na juu ya herufi 40"}}})}),prodData=t.Object({name:t.String({maxLength:40,minLength:3,error(){return{success:!1,message:"Jina haliwezi kuwa na herufi chini ya 3 na juu ya 40"}}}),unit:t.String({minLength:1,maxLength:20,error(){return{success:!1,message:"Jina haliwezi kuwa na herufi chini ya 3 na juu ya 40"}}}),priceBought:t.Number({maximum:999999999999.99,minimum:1,error(){return{success:!1,message:"Kiwango sio sahihi kama ni chini ya 1 au juu ya trillioni 100"}}}),priceSold:t.Number({maximum:999999999999.99,minimum:1,error(){return{success:!1,message:"Kiwango sio sahihi kama ni chini ya 1 au juu ya trillioni 100"}}}),stock:t.Number({maximum:999999999999.99,minimum:1,error(){return{success:!1,message:"Kiwango sio sahihi kama ni chini ya 1 au juu ya trillioni 100"}}}),minStock:t.Number({maximum:999999999999.99,minimum:1,error(){return{success:!1,message:"Kiwango sio sahihi kama ni chini ya 1 au juu ya trillioni 100"}}})}),prodUpdateValidation=t.Object({name:t.String({maxLength:40,minLength:3,error(){return{success:!1,message:"Jina haliwezi kuwa na herufi chini ya 3 na juu ya 40"}}}),unit:t.String({minLength:1,maxLength:20,error(){return{success:!1,message:"Jina haliwezi kuwa na herufi chini ya 3 na juu ya 40"}}}),priceBought:t.Number({maximum:999999999999.99,minimum:1,error(){return{success:!1,message:"Bei ya kununua sio sahihi kama ni chini ya 1 au juu ya trillioni 100"}}}),priceSold:t.Number({maximum:999999999999.99,minimum:1,error(){return{success:!1,message:"Bei ya kuuza sio sahihi kama ni chini ya 1 au juu ya trillioni 100"}}}),stock:t.Number({maximum:999999999999.99,minimum:0,error(){return{success:!1,message:"Hisa sio sahihi kama ni chini ya 0 au juu ya trillioni 100"}}})}),QrPostData=t.Object({customerId:t.String(),supplierId:t.String(),productId:t.String(),typeDetected:t.String(),description:t.String(),saleType:t.String(),calculatedTotal:t.Number({maximum:999999999999.99,minimum:0,error(){return{success:!1,message:"Mahesabu sio sahihi kama ni chini ya 1 au juu ya trillioni 100"}}}),quantity:t.Number({maximum:999999999999.99,minimum:0,error(){return{success:!1,message:"Hisa sio sahihi kama ni chini ya 1 au juu ya trillioni 100"}}}),discount:t.Number({maximum:999999999999.99,minimum:0,error(){return{success:!1,message:"Pungzo sio sahihi kama ni chini ya 1 au juu ya trillioni 100"}}}),priceBought:t.Number({maximum:999999999999.99,minimum:1,error(){return{success:!1,message:"Bei ya kununua sio sahihi kama ni chini ya 1 au juu ya trillioni 100"}}}),priceSold:t.Number({maximum:999999999999.99,minimum:1,error(){return{success:!1,message:"Bei ya kuuza sio sahihi kama ni chini ya 1 au juu ya trillioni 100"}}})}),customerData=t.Object({name:t.String({maxLength:40,minLength:3,error(){return{success:!1,message:"Jina haliwezi kuwa chini ya herufi 3, na juu ya herufi 40"}}}),contact:t.String({maxLength:40,minLength:3,error(){return{success:!1,message:"Mawasiliano haliwezi kuwa chini ya herufi 3, na juu ya herufi 40"}}})}),salesQueryData=t.Object({search:t.Optional(t.String({maxLength:40,error(){return{success:!1,message:"Maneno mwisho ni 40 kwa ajili ya usalama"}}})),date:t.Optional(t.String()),page:t.Optional(t.String({pattern:"^[0-9]+$"})),limit:t.Optional(t.String({pattern:"^[0-9]+$"})),from:t.Optional(t.String({format:"date"})),to:t.Optional(t.String({format:"date"}))}),loginData=t.Object({username:t.String({maxLength:40,minLength:3,error(){return{success:!1,message:"Jina haliwezi kuwa chini ya herufi 3 na juu ya herufi 40"}}}),password:t.String({minLength:6,error(){return{success:!1,message:"Nenosiri haliwezi kuwa chini ya herufi 6 kwa ajili ya usalama"}}})}),registerData=t.Object({name:t.String({maxLength:40,minLength:3,error(){return{success:!1,message:"Jina la Duka haliwezi kuwa chini ya herufi 3 na juu ya herufi 40"}}}),username:t.String({maxLength:40,minLength:3,error(){return{success:!1,message:"Jina haliwezi kuwa chini ya herufi 3 na juu ya herufi 40"}}}),email:t.String({format:"email",error(){return{success:!1,message:"Email/barua-pepe sio sahihi"}}}),password:t.String({maxLength:40,minLength:6,error(){return{success:!1,message:"Nenosiri haliwezi kuwa chini ya herufi 6 na juu ya herufi 40"}}}),phoneNumber:t.String({maxLength:15,minLength:9,error(){return{success:!1,message:"Namba ya simu sio sahihi"}}})}),shopPutData=t.Object({email:t.String({format:"email",error(){return{success:!1,message:"Email/barua-pepe sio sahihi"}}}),shopName:t.String({maxLength:40,minLength:3,error(){return{success:!1,message:"Jina la duka haliwezi kuwa na herufi chini ya 3 au juu ya 40"}}}),phoneNumber:t.String({maxLength:15,minLength:10,error(){return{success:!1,message:"Namba ya simu haiwezi kuwa na herufi chini ya 10 au juu ya 15"}}})}),changePasswordData=t.Object({currentPassword:t.String({maxLength:40,minLength:6,error(){return{success:!1,message:"Nenosiri haliwezi kuwa na herufi chini ya 6 au juu ya 40"}}}),newPassword:t.String({maxLength:40,minLength:6,error(){return{success:!1,message:"Nenosiri haliwezi kuwa na herufi chini ya 6 au juu ya 40"}}})}),emailData=t.Object({email:t.String({format:"email",error(){return{success:!1,message:"Email/barua-pepe sio sahihi"}}}),name:t.String({maxLength:40,minLength:3,error(){return{success:!1,message:"Jina haliwezi kuwa na herufi chini ya 3 au juu ya 40"}}}),message:t.String({maxLength:40,minLength:3,error(){return{success:!1,message:"Ujumbe hauwezi kuwa na herufi chini ya 5 au juu ya 40"}}})}),authToken=t.Object({token:t.String({minLength:3,error(){return{success:!1,message:"Tokeni sio sahihi"}}})}),debtQuery=t.Object({page:t.Number({maximum:1e4,minimum:0,error(){return{success:!1,message:"Ukurasa hauwezi kuwa chini ya 0 au juu ya 10,000"}}}),pageSize:t.Number({maximum:1e4,minimum:1,error(){return{success:!1,message:"Ukubwa wa ukurasa hauwezi kuwa chini ya 1 au juu ya 10,000"}}})}),askedData=t.Object({name:t.String({minLength:1,maxLength:50,error(){return{success:!1,message:"Jina haliwezi kuwa chini ya herufi moja au juu ya herufi 50"}}})}),updatedAskedData=t.Object({count:t.Number({minimum:0,maximum:50000,error(){return{success:!1,message:"Hesabu haliwezi kuwa chini 0 au juu ya 50,000"}}})}),payDebtData=t.Object({amountPaid:t.Number({minimum:0,maximum:999999999999.99,error(){return{success:!1,message:"Hesabu haliwezi kuwa chini 0 au juu ya trillioni 100"}}}),customerId:t.String({minLength:1,maxLength:50,error(){return{success:!1,message:"ID ya wateja haiwezi kuwa chini ya herufi moja au juu ya herufi 50"}}}),debtId:t.String({minLength:1,maxLength:50,error(){return{success:!1,message:"ID ya taarifa za deni haiwezi kuwa chini ya herufi moja au juu ya herufi 50"}}})}),resetEmailData=t.Object({email:t.String({maxLength:50,minLength:6,format:"email",error(){return{success:!1,message:"barua pepe haiwezi kuwa na herufi chini ya 6 au juu ya 50"}}})}),resetPasswordData=t.Object({password:t.String({maxLength:40,minLength:6,error(){return{success:!1,message:"Nenosiri haliwezi kuwa na herufi chini ya 6 au juu ya 40"}}})}),paymentRequestData=t.Object({price:t.Number({maximum:999999999999.99,minimum:5000,error(){return{success:!1,message:"Bei haiwezi kuwa chini ya 5000 au juu ya trillioni 100"}}}),duration:t.Union([t.Literal(1),t.Literal(6),t.Literal(12)]),paymentMethod:t.Union([t.Literal("TIGO-PESA"),t.Literal("AIRTEL-MONEY")]),plan:t.Union([t.Literal("msingi"),t.Literal("lite")])});/*!
 * cookie
 * Copyright(c) 2012-2014 Roman Shtylman
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */var $parse=parse4,$serialize=serialize2;var __toString=Object.prototype.toString,fieldContentRegExp=/^[\u0009\u0020-\u007e\u0080-\u00ff]+$/;function parse4(str,options){if(typeof str!=="string")throw new TypeError("argument str must be a string");var obj={},opt=options||{},dec=opt.decode||decode3,index2=0;while(index2<str.length){var eqIdx=str.indexOf("=",index2);if(eqIdx===-1)break;var endIdx=str.indexOf(";",index2);if(endIdx===-1)endIdx=str.length;else if(endIdx<eqIdx){index2=str.lastIndexOf(";",eqIdx-1)+1;continue}var key=str.slice(index2,eqIdx).trim();if(obj[key]===void 0){var val=str.slice(eqIdx+1,endIdx).trim();if(val.charCodeAt(0)===34)val=val.slice(1,-1);obj[key]=tryDecode(val,dec)}index2=endIdx+1}return obj}function serialize2(name,val,options){var opt=options||{},enc=opt.encode||encode2;if(typeof enc!=="function")throw new TypeError("option encode is invalid");if(!fieldContentRegExp.test(name))throw new TypeError("argument name is invalid");var value=enc(val);if(value&&!fieldContentRegExp.test(value))throw new TypeError("argument val is invalid");var str=name+"="+value;if(opt.maxAge!=null){var maxAge=opt.maxAge-0;if(isNaN(maxAge)||!isFinite(maxAge))throw new TypeError("option maxAge is invalid");str+="; Max-Age="+Math.floor(maxAge)}if(opt.domain){if(!fieldContentRegExp.test(opt.domain))throw new TypeError("option domain is invalid");str+="; Domain="+opt.domain}if(opt.path){if(!fieldContentRegExp.test(opt.path))throw new TypeError("option path is invalid");str+="; Path="+opt.path}if(opt.expires){var expires=opt.expires;if(!isDate(expires)||isNaN(expires.valueOf()))throw new TypeError("option expires is invalid");str+="; Expires="+expires.toUTCString()}if(opt.httpOnly)str+="; HttpOnly";if(opt.secure)str+="; Secure";if(opt.priority){var priority=typeof opt.priority==="string"?opt.priority.toLowerCase():opt.priority;switch(priority){case"low":str+="; Priority=Low";break;case"medium":str+="; Priority=Medium";break;case"high":str+="; Priority=High";break;default:throw new TypeError("option priority is invalid")}}if(opt.sameSite){var sameSite=typeof opt.sameSite==="string"?opt.sameSite.toLowerCase():opt.sameSite;switch(sameSite){case!0:str+="; SameSite=Strict";break;case"lax":str+="; SameSite=Lax";break;case"strict":str+="; SameSite=Strict";break;case"none":str+="; SameSite=None";break;default:throw new TypeError("option sameSite is invalid")}}return str}function decode3(str){return str.indexOf("%")!==-1?decodeURIComponent(str):str}function encode2(val){return encodeURIComponent(val)}function isDate(val){return __toString.call(val)==="[object Date]"||val instanceof Date}function tryDecode(str,decode4){try{return decode4(str)}catch(e){return str}}var crypto3=__require("crypto");var $sign=function(val,secret){if(typeof val!="string")throw new TypeError("Cookie value must be provided as a string.");if(secret==null)throw new TypeError("Secret key must be provided.");return val+"."+crypto3.createHmac("sha256",secret).update(val).digest("base64").replace(/\=+$/,"")},$unsign=function(input,secret){if(typeof input!="string")throw new TypeError("Signed cookie string must be provided.");if(secret==null)throw new TypeError("Secret key must be provided.");var tentativeValue=input.slice(0,input.lastIndexOf(".")),expectedInput=$sign(tentativeValue,secret),expectedBuffer=Buffer.from(expectedInput),inputBuffer=Buffer.from(input);return expectedBuffer.length===inputBuffer.length&&crypto3.timingSafeEqual(expectedBuffer,inputBuffer)?tentativeValue:!1};var cookie=(options={})=>{let{signed,secret:secretKey,...defaultOptions}=options,secret=!secretKey?void 0:typeof secretKey==="string"?secretKey:secretKey[0],isStringKey=typeof secret==="string";return new Elysia({name:"@elysiajs/cookie",seed:options}).decorate("unsignCookie",(value)=>{if(!secret)throw new Error("No secret is provided to cookie plugin");let unsigned=isStringKey?$unsign(value,secret):!1;if(isStringKey===!1)for(let i=0;i<secret.length;i++){let temp=$unsign(value,secret[i]);if(temp){unsigned=temp;break}}return{valid:unsigned!==!1,value:unsigned||void 0}}).derive((context)=>{let _cookie,getCookie=()=>{if(_cookie)return _cookie;try{let headerCookie=context.request.headers.get("cookie");_cookie=headerCookie?$parse(headerCookie):{}}catch(error2){_cookie={}}return _cookie};return{get cookie(){return getCookie()},setCookie(name,value,{signed:signed2=!1,...options2}={}){if(signed2){if(!secret)throw new Error("No secret is provided to cookie plugin");value=$sign(value,secret)}if(!Array.isArray(context.set.headers["Set-Cookie"]))context.set.headers["Set-Cookie"]=[];if(context.set.headers["Set-Cookie"].push($serialize(name,value,{path:"/",...defaultOptions,...options2})),!_cookie)getCookie();_cookie[name]=value},removeCookie(name){if(!getCookie()[name])return;context.set.headers["Set-Cookie"]=$serialize(name,"",{expires:new Date("Thu, Jan 01 1970 00:00:00 UTC")}),delete _cookie[name]}}})},dist_default=cookie;var webcrypto_default=crypto,isCryptoKey=(key)=>key instanceof CryptoKey;var encoder2=new TextEncoder,decoder=new TextDecoder;function concat(...buffers){let size=buffers.reduce((acc,{length})=>acc+length,0),buf=new Uint8Array(size),i=0;return buffers.forEach((buffer2)=>{buf.set(buffer2,i),i+=buffer2.length}),buf}var encodeBase64=(input)=>{let unencoded=input;if(typeof unencoded==="string")unencoded=encoder2.encode(unencoded);let CHUNK_SIZE=32768,arr=[];for(let i=0;i<unencoded.length;i+=CHUNK_SIZE)arr.push(String.fromCharCode.apply(null,unencoded.subarray(i,i+CHUNK_SIZE)));return btoa(arr.join(""))},encode3=(input)=>{return encodeBase64(input).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")},decodeBase64=(encoded)=>{let binary=atob(encoded),bytes=new Uint8Array(binary.length);for(let i=0;i<binary.length;i++)bytes[i]=binary.charCodeAt(i);return bytes},decode4=(input)=>{let encoded=input;if(encoded instanceof Uint8Array)encoded=decoder.decode(encoded);encoded=encoded.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"");try{return decodeBase64(encoded)}catch(_a){throw new TypeError("The input to be decoded is not correctly encoded.")}};class JOSEError extends Error{static get code(){return"ERR_JOSE_GENERIC"}constructor(message){var _a;super(message);this.code="ERR_JOSE_GENERIC",this.name=this.constructor.name,(_a=Error.captureStackTrace)===null||_a===void 0||_a.call(Error,this,this.constructor)}}class JWTClaimValidationFailed extends JOSEError{static get code(){return"ERR_JWT_CLAIM_VALIDATION_FAILED"}constructor(message,claim="unspecified",reason="unspecified"){super(message);this.code="ERR_JWT_CLAIM_VALIDATION_FAILED",this.claim=claim,this.reason=reason}}class JWTExpired extends JOSEError{static get code(){return"ERR_JWT_EXPIRED"}constructor(message,claim="unspecified",reason="unspecified"){super(message);this.code="ERR_JWT_EXPIRED",this.claim=claim,this.reason=reason}}class JOSEAlgNotAllowed extends JOSEError{constructor(){super(...arguments);this.code="ERR_JOSE_ALG_NOT_ALLOWED"}static get code(){return"ERR_JOSE_ALG_NOT_ALLOWED"}}class JOSENotSupported extends JOSEError{constructor(){super(...arguments);this.code="ERR_JOSE_NOT_SUPPORTED"}static get code(){return"ERR_JOSE_NOT_SUPPORTED"}}class JWSInvalid extends JOSEError{constructor(){super(...arguments);this.code="ERR_JWS_INVALID"}static get code(){return"ERR_JWS_INVALID"}}class JWTInvalid extends JOSEError{constructor(){super(...arguments);this.code="ERR_JWT_INVALID"}static get code(){return"ERR_JWT_INVALID"}}class JWSSignatureVerificationFailed extends JOSEError{constructor(){super(...arguments);this.code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED",this.message="signature verification failed"}static get code(){return"ERR_JWS_SIGNATURE_VERIFICATION_FAILED"}}function unusable(name,prop="algorithm.name"){return new TypeError(`CryptoKey does not support this operation, its ${prop} must be ${name}`)}function isAlgorithm(algorithm,name){return algorithm.name===name}function getHashLength(hash2){return parseInt(hash2.name.slice(4),10)}function getNamedCurve(alg){switch(alg){case"ES256":return"P-256";case"ES384":return"P-384";case"ES512":return"P-521";default:throw new Error("unreachable")}}function checkUsage(key,usages){if(usages.length&&!usages.some((expected)=>key.usages.includes(expected))){let msg="CryptoKey does not support this operation, its usages must include ";if(usages.length>2){let last=usages.pop();msg+=`one of ${usages.join(", ")}, or ${last}.`}else if(usages.length===2)msg+=`one of ${usages[0]} or ${usages[1]}.`;else msg+=`${usages[0]}.`;throw new TypeError(msg)}}function checkSigCryptoKey(key,alg,...usages){switch(alg){case"HS256":case"HS384":case"HS512":{if(!isAlgorithm(key.algorithm,"HMAC"))throw unusable("HMAC");let expected=parseInt(alg.slice(2),10);if(getHashLength(key.algorithm.hash)!==expected)throw unusable(`SHA-${expected}`,"algorithm.hash");break}case"RS256":case"RS384":case"RS512":{if(!isAlgorithm(key.algorithm,"RSASSA-PKCS1-v1_5"))throw unusable("RSASSA-PKCS1-v1_5");let expected=parseInt(alg.slice(2),10);if(getHashLength(key.algorithm.hash)!==expected)throw unusable(`SHA-${expected}`,"algorithm.hash");break}case"PS256":case"PS384":case"PS512":{if(!isAlgorithm(key.algorithm,"RSA-PSS"))throw unusable("RSA-PSS");let expected=parseInt(alg.slice(2),10);if(getHashLength(key.algorithm.hash)!==expected)throw unusable(`SHA-${expected}`,"algorithm.hash");break}case"EdDSA":{if(key.algorithm.name!=="Ed25519"&&key.algorithm.name!=="Ed448")throw unusable("Ed25519 or Ed448");break}case"ES256":case"ES384":case"ES512":{if(!isAlgorithm(key.algorithm,"ECDSA"))throw unusable("ECDSA");let expected=getNamedCurve(alg);if(key.algorithm.namedCurve!==expected)throw unusable(expected,"algorithm.namedCurve");break}default:throw new TypeError("CryptoKey does not support this operation")}checkUsage(key,usages)}function message(msg,actual,...types2){if(types2.length>2){let last=types2.pop();msg+=`one of type ${types2.join(", ")}, or ${last}.`}else if(types2.length===2)msg+=`one of type ${types2[0]} or ${types2[1]}.`;else msg+=`of type ${types2[0]}.`;if(actual==null)msg+=` Received ${actual}`;else if(typeof actual==="function"&&actual.name)msg+=` Received function ${actual.name}`;else if(typeof actual==="object"&&actual!=null){if(actual.constructor&&actual.constructor.name)msg+=` Received an instance of ${actual.constructor.name}`}return msg}var invalid_key_input_default=(actual,...types2)=>{return message("Key must be ",actual,...types2)};function withAlg(alg,actual,...types2){return message(`Key for the ${alg} algorithm must be `,actual,...types2)}var is_key_like_default=(key)=>{return isCryptoKey(key)},types2=["CryptoKey"];var isDisjoint=(...headers)=>{let sources=headers.filter(Boolean);if(sources.length===0||sources.length===1)return!0;let acc;for(let header of sources){let parameters=Object.keys(header);if(!acc||acc.size===0){acc=new Set(parameters);continue}for(let parameter of parameters){if(acc.has(parameter))return!1;acc.add(parameter)}}return!0},is_disjoint_default=isDisjoint;function isObjectLike(value){return typeof value==="object"&&value!==null}function isObject2(input){if(!isObjectLike(input)||Object.prototype.toString.call(input)!=="[object Object]")return!1;if(Object.getPrototypeOf(input)===null)return!0;let proto=input;while(Object.getPrototypeOf(proto)!==null)proto=Object.getPrototypeOf(proto);return Object.getPrototypeOf(input)===proto}var check_key_length_default=(alg,key)=>{if(alg.startsWith("RS")||alg.startsWith("PS")){let{modulusLength}=key.algorithm;if(typeof modulusLength!=="number"||modulusLength<2048)throw new TypeError(`${alg} requires key modulusLength to be 2048 bits or larger`)}};var symmetricTypeCheck=(alg,key)=>{if(key instanceof Uint8Array)return;if(!is_key_like_default(key))throw new TypeError(withAlg(alg,key,...types2,"Uint8Array"));if(key.type!=="secret")throw new TypeError(`${types2.join(" or ")} instances for symmetric algorithms must be of type "secret"`)},asymmetricTypeCheck=(alg,key,usage)=>{if(!is_key_like_default(key))throw new TypeError(withAlg(alg,key,...types2));if(key.type==="secret")throw new TypeError(`${types2.join(" or ")} instances for asymmetric algorithms must not be of type "secret"`);if(usage==="sign"&&key.type==="public")throw new TypeError(`${types2.join(" or ")} instances for asymmetric algorithm signing must be of type "private"`);if(usage==="decrypt"&&key.type==="public")throw new TypeError(`${types2.join(" or ")} instances for asymmetric algorithm decryption must be of type "private"`);if(key.algorithm&&usage==="verify"&&key.type==="private")throw new TypeError(`${types2.join(" or ")} instances for asymmetric algorithm verifying must be of type "public"`);if(key.algorithm&&usage==="encrypt"&&key.type==="private")throw new TypeError(`${types2.join(" or ")} instances for asymmetric algorithm encryption must be of type "public"`)},checkKeyType=(alg,key,usage)=>{if(alg.startsWith("HS")||alg==="dir"||alg.startsWith("PBES2")||/^A\d{3}(?:GCM)?KW$/.test(alg))symmetricTypeCheck(alg,key);else asymmetricTypeCheck(alg,key,usage)},check_key_type_default=checkKeyType;function validateCrit(Err,recognizedDefault,recognizedOption,protectedHeader,joseHeader){if(joseHeader.crit!==void 0&&protectedHeader.crit===void 0)throw new Err('"crit" (Critical) Header Parameter MUST be integrity protected');if(!protectedHeader||protectedHeader.crit===void 0)return new Set;if(!Array.isArray(protectedHeader.crit)||protectedHeader.crit.length===0||protectedHeader.crit.some((input)=>typeof input!=="string"||input.length===0))throw new Err('"crit" (Critical) Header Parameter MUST be an array of non-empty strings when present');let recognized;if(recognizedOption!==void 0)recognized=new Map([...Object.entries(recognizedOption),...recognizedDefault.entries()]);else recognized=recognizedDefault;for(let parameter of protectedHeader.crit){if(!recognized.has(parameter))throw new JOSENotSupported(`Extension Header Parameter "${parameter}" is not recognized`);if(joseHeader[parameter]===void 0)throw new Err(`Extension Header Parameter "${parameter}" is missing`);else if(recognized.get(parameter)&&protectedHeader[parameter]===void 0)throw new Err(`Extension Header Parameter "${parameter}" MUST be integrity protected`)}return new Set(protectedHeader.crit)}var validate_crit_default=validateCrit;var validateAlgorithms=(option,algorithms)=>{if(algorithms!==void 0&&(!Array.isArray(algorithms)||algorithms.some((s)=>typeof s!=="string")))throw new TypeError(`"${option}" option must be an array of strings`);if(!algorithms)return;return new Set(algorithms)},validate_algorithms_default=validateAlgorithms;function subtleDsa(alg,algorithm){let hash2=`SHA-${alg.slice(-3)}`;switch(alg){case"HS256":case"HS384":case"HS512":return{hash:hash2,name:"HMAC"};case"PS256":case"PS384":case"PS512":return{hash:hash2,name:"RSA-PSS",saltLength:alg.slice(-3)>>3};case"RS256":case"RS384":case"RS512":return{hash:hash2,name:"RSASSA-PKCS1-v1_5"};case"ES256":case"ES384":case"ES512":return{hash:hash2,name:"ECDSA",namedCurve:algorithm.namedCurve};case"EdDSA":return{name:algorithm.name};default:throw new JOSENotSupported(`alg ${alg} is not supported either by JOSE or your javascript runtime`)}}function getCryptoKey(alg,key,usage){if(isCryptoKey(key))return checkSigCryptoKey(key,alg,usage),key;if(key instanceof Uint8Array){if(!alg.startsWith("HS"))throw new TypeError(invalid_key_input_default(key,...types2));return webcrypto_default.subtle.importKey("raw",key,{hash:`SHA-${alg.slice(-3)}`,name:"HMAC"},!1,[usage])}throw new TypeError(invalid_key_input_default(key,...types2,"Uint8Array"))}var verify=async(alg,key,signature,data)=>{let cryptoKey=await getCryptoKey(alg,key,"verify");check_key_length_default(alg,cryptoKey);let algorithm=subtleDsa(alg,cryptoKey.algorithm);try{return await webcrypto_default.subtle.verify(algorithm,cryptoKey,signature,data)}catch(_a){return!1}},verify_default=verify;async function flattenedVerify(jws,key,options){var _a;if(!isObject2(jws))throw new JWSInvalid("Flattened JWS must be an object");if(jws.protected===void 0&&jws.header===void 0)throw new JWSInvalid('Flattened JWS must have either of the "protected" or "header" members');if(jws.protected!==void 0&&typeof jws.protected!=="string")throw new JWSInvalid("JWS Protected Header incorrect type");if(jws.payload===void 0)throw new JWSInvalid("JWS Payload missing");if(typeof jws.signature!=="string")throw new JWSInvalid("JWS Signature missing or incorrect type");if(jws.header!==void 0&&!isObject2(jws.header))throw new JWSInvalid("JWS Unprotected Header incorrect type");let parsedProt={};if(jws.protected)try{let protectedHeader=decode4(jws.protected);parsedProt=JSON.parse(decoder.decode(protectedHeader))}catch(_b){throw new JWSInvalid("JWS Protected Header is invalid")}if(!is_disjoint_default(parsedProt,jws.header))throw new JWSInvalid("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");let joseHeader={...parsedProt,...jws.header},extensions=validate_crit_default(JWSInvalid,new Map([["b64",!0]]),options===null||options===void 0?void 0:options.crit,parsedProt,joseHeader),b64=!0;if(extensions.has("b64")){if(b64=parsedProt.b64,typeof b64!=="boolean")throw new JWSInvalid('The "b64" (base64url-encode payload) Header Parameter must be a boolean')}let{alg}=joseHeader;if(typeof alg!=="string"||!alg)throw new JWSInvalid('JWS "alg" (Algorithm) Header Parameter missing or invalid');let algorithms=options&&validate_algorithms_default("algorithms",options.algorithms);if(algorithms&&!algorithms.has(alg))throw new JOSEAlgNotAllowed('"alg" (Algorithm) Header Parameter not allowed');if(b64){if(typeof jws.payload!=="string")throw new JWSInvalid("JWS Payload must be a string")}else if(typeof jws.payload!=="string"&&!(jws.payload instanceof Uint8Array))throw new JWSInvalid("JWS Payload must be a string or an Uint8Array instance");let resolvedKey=!1;if(typeof key==="function")key=await key(parsedProt,jws),resolvedKey=!0;check_key_type_default(alg,key,"verify");let data=concat(encoder2.encode((_a=jws.protected)!==null&&_a!==void 0?_a:""),encoder2.encode("."),typeof jws.payload==="string"?encoder2.encode(jws.payload):jws.payload),signature;try{signature=decode4(jws.signature)}catch(_c){throw new JWSInvalid("Failed to base64url decode the signature")}if(!await verify_default(alg,key,signature,data))throw new JWSSignatureVerificationFailed;let payload;if(b64)try{payload=decode4(jws.payload)}catch(_d){throw new JWSInvalid("Failed to base64url decode the payload")}else if(typeof jws.payload==="string")payload=encoder2.encode(jws.payload);else payload=jws.payload;let result={payload};if(jws.protected!==void 0)result.protectedHeader=parsedProt;if(jws.header!==void 0)result.unprotectedHeader=jws.header;if(resolvedKey)return{...result,key};return result}async function compactVerify(jws,key,options){if(jws instanceof Uint8Array)jws=decoder.decode(jws);if(typeof jws!=="string")throw new JWSInvalid("Compact JWS must be a string or Uint8Array");let{0:protectedHeader,1:payload,2:signature,length}=jws.split(".");if(length!==3)throw new JWSInvalid("Invalid Compact JWS");let verified=await flattenedVerify({payload,protected:protectedHeader,signature},key,options),result={payload:verified.payload,protectedHeader:verified.protectedHeader};if(typeof key==="function")return{...result,key:verified.key};return result}var epoch_default=(date3)=>Math.floor(date3.getTime()/1000);var REGEX=/^(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)$/i,secs_default=(str)=>{let matched=REGEX.exec(str);if(!matched)throw new TypeError("Invalid time period format");let value=parseFloat(matched[1]);switch(matched[2].toLowerCase()){case"sec":case"secs":case"second":case"seconds":case"s":return Math.round(value);case"minute":case"minutes":case"min":case"mins":case"m":return Math.round(value*60);case"hour":case"hours":case"hr":case"hrs":case"h":return Math.round(value*3600);case"day":case"days":case"d":return Math.round(value*86400);case"week":case"weeks":case"w":return Math.round(value*604800);default:return Math.round(value*31557600)}};var normalizeTyp=(value)=>value.toLowerCase().replace(/^application\//,""),checkAudiencePresence=(audPayload,audOption)=>{if(typeof audPayload==="string")return audOption.includes(audPayload);if(Array.isArray(audPayload))return audOption.some(Set.prototype.has.bind(new Set(audPayload)));return!1},jwt_claims_set_default=(protectedHeader,encodedPayload,options={})=>{let{typ}=options;if(typ&&(typeof protectedHeader.typ!=="string"||normalizeTyp(protectedHeader.typ)!==normalizeTyp(typ)))throw new JWTClaimValidationFailed('unexpected "typ" JWT header value',"typ","check_failed");let payload;try{payload=JSON.parse(decoder.decode(encodedPayload))}catch(_a){}if(!isObject2(payload))throw new JWTInvalid("JWT Claims Set must be a top-level JSON object");let{requiredClaims=[],issuer,subject,audience,maxTokenAge}=options;if(maxTokenAge!==void 0)requiredClaims.push("iat");if(audience!==void 0)requiredClaims.push("aud");if(subject!==void 0)requiredClaims.push("sub");if(issuer!==void 0)requiredClaims.push("iss");for(let claim of new Set(requiredClaims.reverse()))if(!(claim in payload))throw new JWTClaimValidationFailed(`missing required "${claim}" claim`,claim,"missing");if(issuer&&!(Array.isArray(issuer)?issuer:[issuer]).includes(payload.iss))throw new JWTClaimValidationFailed('unexpected "iss" claim value',"iss","check_failed");if(subject&&payload.sub!==subject)throw new JWTClaimValidationFailed('unexpected "sub" claim value',"sub","check_failed");if(audience&&!checkAudiencePresence(payload.aud,typeof audience==="string"?[audience]:audience))throw new JWTClaimValidationFailed('unexpected "aud" claim value',"aud","check_failed");let tolerance;switch(typeof options.clockTolerance){case"string":tolerance=secs_default(options.clockTolerance);break;case"number":tolerance=options.clockTolerance;break;case"undefined":tolerance=0;break;default:throw new TypeError("Invalid clockTolerance option type")}let{currentDate}=options,now=epoch_default(currentDate||new Date);if((payload.iat!==void 0||maxTokenAge)&&typeof payload.iat!=="number")throw new JWTClaimValidationFailed('"iat" claim must be a number',"iat","invalid");if(payload.nbf!==void 0){if(typeof payload.nbf!=="number")throw new JWTClaimValidationFailed('"nbf" claim must be a number',"nbf","invalid");if(payload.nbf>now+tolerance)throw new JWTClaimValidationFailed('"nbf" claim timestamp check failed',"nbf","check_failed")}if(payload.exp!==void 0){if(typeof payload.exp!=="number")throw new JWTClaimValidationFailed('"exp" claim must be a number',"exp","invalid");if(payload.exp<=now-tolerance)throw new JWTExpired('"exp" claim timestamp check failed',"exp","check_failed")}if(maxTokenAge){let age=now-payload.iat,max=typeof maxTokenAge==="number"?maxTokenAge:secs_default(maxTokenAge);if(age-tolerance>max)throw new JWTExpired('"iat" claim timestamp check failed (too far in the past)',"iat","check_failed");if(age<0-tolerance)throw new JWTClaimValidationFailed('"iat" claim timestamp check failed (it should be in the past)',"iat","check_failed")}return payload};async function jwtVerify(jwt,key,options){var _a;let verified=await compactVerify(jwt,key,options);if(((_a=verified.protectedHeader.crit)===null||_a===void 0?void 0:_a.includes("b64"))&&verified.protectedHeader.b64===!1)throw new JWTInvalid("JWTs MUST NOT use unencoded payload");let result={payload:jwt_claims_set_default(verified.protectedHeader,verified.payload,options),protectedHeader:verified.protectedHeader};if(typeof key==="function")return{...result,key:verified.key};return result}var sign=async(alg,key,data)=>{let cryptoKey=await getCryptoKey(alg,key,"sign");check_key_length_default(alg,cryptoKey);let signature=await webcrypto_default.subtle.sign(subtleDsa(alg,cryptoKey.algorithm),cryptoKey,data);return new Uint8Array(signature)},sign_default=sign;class FlattenedSign{constructor(payload){if(!(payload instanceof Uint8Array))throw new TypeError("payload must be an instance of Uint8Array");this._payload=payload}setProtectedHeader(protectedHeader){if(this._protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this._protectedHeader=protectedHeader,this}setUnprotectedHeader(unprotectedHeader){if(this._unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this._unprotectedHeader=unprotectedHeader,this}async sign(key,options){if(!this._protectedHeader&&!this._unprotectedHeader)throw new JWSInvalid("either setProtectedHeader or setUnprotectedHeader must be called before #sign()");if(!is_disjoint_default(this._protectedHeader,this._unprotectedHeader))throw new JWSInvalid("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");let joseHeader={...this._protectedHeader,...this._unprotectedHeader},extensions=validate_crit_default(JWSInvalid,new Map([["b64",!0]]),options===null||options===void 0?void 0:options.crit,this._protectedHeader,joseHeader),b64=!0;if(extensions.has("b64")){if(b64=this._protectedHeader.b64,typeof b64!=="boolean")throw new JWSInvalid('The "b64" (base64url-encode payload) Header Parameter must be a boolean')}let{alg}=joseHeader;if(typeof alg!=="string"||!alg)throw new JWSInvalid('JWS "alg" (Algorithm) Header Parameter missing or invalid');check_key_type_default(alg,key,"sign");let payload=this._payload;if(b64)payload=encoder2.encode(encode3(payload));let protectedHeader;if(this._protectedHeader)protectedHeader=encoder2.encode(encode3(JSON.stringify(this._protectedHeader)));else protectedHeader=encoder2.encode("");let data=concat(protectedHeader,encoder2.encode("."),payload),signature=await sign_default(alg,key,data),jws={signature:encode3(signature),payload:""};if(b64)jws.payload=decoder.decode(payload);if(this._unprotectedHeader)jws.header=this._unprotectedHeader;if(this._protectedHeader)jws.protected=decoder.decode(protectedHeader);return jws}}class CompactSign{constructor(payload){this._flattened=new FlattenedSign(payload)}setProtectedHeader(protectedHeader){return this._flattened.setProtectedHeader(protectedHeader),this}async sign(key,options){let jws=await this._flattened.sign(key,options);if(jws.payload===void 0)throw new TypeError("use the flattened module for creating JWS with b64: false");return`${jws.protected}.${jws.payload}.${jws.signature}`}}class ProduceJWT{constructor(payload){if(!isObject2(payload))throw new TypeError("JWT Claims Set MUST be an object");this._payload=payload}setIssuer(issuer){return this._payload={...this._payload,iss:issuer},this}setSubject(subject){return this._payload={...this._payload,sub:subject},this}setAudience(audience){return this._payload={...this._payload,aud:audience},this}setJti(jwtId){return this._payload={...this._payload,jti:jwtId},this}setNotBefore(input){if(typeof input==="number")this._payload={...this._payload,nbf:input};else this._payload={...this._payload,nbf:epoch_default(new Date)+secs_default(input)};return this}setExpirationTime(input){if(typeof input==="number")this._payload={...this._payload,exp:input};else this._payload={...this._payload,exp:epoch_default(new Date)+secs_default(input)};return this}setIssuedAt(input){if(typeof input==="undefined")this._payload={...this._payload,iat:epoch_default(new Date)};else this._payload={...this._payload,iat:input};return this}}class SignJWT extends ProduceJWT{setProtectedHeader(protectedHeader){return this._protectedHeader=protectedHeader,this}async sign(key,options){var _a;let sig=new CompactSign(encoder2.encode(JSON.stringify(this._payload)));if(sig.setProtectedHeader(this._protectedHeader),Array.isArray((_a=this._protectedHeader)===null||_a===void 0?void 0:_a.crit)&&this._protectedHeader.crit.includes("b64")&&this._protectedHeader.b64===!1)throw new JWTInvalid("JWTs MUST NOT use unencoded payload");return sig.sign(key,options)}}var __defProp2=Object.defineProperty,__export2=(target,all)=>{for(var name in all)__defProp2(target,name,{get:all[name],enumerable:!0})},value_exports={};__export2(value_exports,{HasPropertyKey:()=>HasPropertyKey3,IsArray:()=>IsArray5,IsAsyncIterator:()=>IsAsyncIterator5,IsBigInt:()=>IsBigInt5,IsBoolean:()=>IsBoolean5,IsDate:()=>IsDate5,IsFunction:()=>IsFunction5,IsIterator:()=>IsIterator5,IsNull:()=>IsNull5,IsNumber:()=>IsNumber5,IsObject:()=>IsObject5,IsRegExp:()=>IsRegExp4,IsString:()=>IsString5,IsSymbol:()=>IsSymbol5,IsUint8Array:()=>IsUint8Array5,IsUndefined:()=>IsUndefined5});function HasPropertyKey3(value,key){return key in value}function IsAsyncIterator5(value){return IsObject5(value)&&!IsArray5(value)&&!IsUint8Array5(value)&&Symbol.asyncIterator in value}function IsArray5(value){return Array.isArray(value)}function IsBigInt5(value){return typeof value==="bigint"}function IsBoolean5(value){return typeof value==="boolean"}function IsDate5(value){return value instanceof globalThis.Date}function IsFunction5(value){return typeof value==="function"}function IsIterator5(value){return IsObject5(value)&&!IsArray5(value)&&!IsUint8Array5(value)&&Symbol.iterator in value}function IsNull5(value){return value===null}function IsNumber5(value){return typeof value==="number"}function IsObject5(value){return typeof value==="object"&&value!==null}function IsRegExp4(value){return value instanceof globalThis.RegExp}function IsString5(value){return typeof value==="string"}function IsSymbol5(value){return typeof value==="symbol"}function IsUint8Array5(value){return value instanceof globalThis.Uint8Array}function IsUndefined5(value){return value===void 0}function ArrayType6(value){return value.map((value2)=>Visit17(value2))}function DateType4(value){return new Date(value.getTime())}function Uint8ArrayType3(value){return new Uint8Array(value)}function RegExpType2(value){return new RegExp(value.source,value.flags)}function ObjectType6(value){let result={};for(let key of Object.getOwnPropertyNames(value))result[key]=Visit17(value[key]);for(let key of Object.getOwnPropertySymbols(value))result[key]=Visit17(value[key]);return result}function Visit17(value){return IsArray5(value)?ArrayType6(value):IsDate5(value)?DateType4(value):IsUint8Array5(value)?Uint8ArrayType3(value):IsRegExp4(value)?RegExpType2(value):IsObject5(value)?ObjectType6(value):value}function Clone3(value){return Visit17(value)}function CloneType2(schema,options){return options===void 0?Clone3(schema):Clone3({...options,...schema})}function IsObject22(value){return value!==null&&typeof value==="object"}function IsArray22(value){return globalThis.Array.isArray(value)&&!globalThis.ArrayBuffer.isView(value)}function IsUndefined22(value){return value===void 0}function IsNumber22(value){return typeof value==="number"}var TypeSystemPolicy2;(function(TypeSystemPolicy22){TypeSystemPolicy22.InstanceMode="default",TypeSystemPolicy22.ExactOptionalPropertyTypes=!1,TypeSystemPolicy22.AllowArrayObject=!1,TypeSystemPolicy22.AllowNaN=!1,TypeSystemPolicy22.AllowNullVoid=!1;function IsExactOptionalProperty(value,key){return TypeSystemPolicy22.ExactOptionalPropertyTypes?key in value:value[key]!==void 0}TypeSystemPolicy22.IsExactOptionalProperty=IsExactOptionalProperty;function IsObjectLike(value){let isObject3=IsObject22(value);return TypeSystemPolicy22.AllowArrayObject?isObject3:isObject3&&!IsArray22(value)}TypeSystemPolicy22.IsObjectLike=IsObjectLike;function IsRecordLike(value){return IsObjectLike(value)&&!(value instanceof Date)&&!(value instanceof Uint8Array)}TypeSystemPolicy22.IsRecordLike=IsRecordLike;function IsNumberLike(value){return TypeSystemPolicy22.AllowNaN?IsNumber22(value):Number.isFinite(value)}TypeSystemPolicy22.IsNumberLike=IsNumberLike;function IsVoidLike(value){let isUndefined=IsUndefined22(value);return TypeSystemPolicy22.AllowNullVoid?isUndefined||value===null:isUndefined}TypeSystemPolicy22.IsVoidLike=IsVoidLike})(TypeSystemPolicy2||(TypeSystemPolicy2={}));function ImmutableArray2(value){return globalThis.Object.freeze(value).map((value2)=>Immutable2(value2))}function ImmutableDate2(value){return value}function ImmutableUint8Array2(value){return value}function ImmutableRegExp2(value){return value}function ImmutableObject2(value){let result={};for(let key of Object.getOwnPropertyNames(value))result[key]=Immutable2(value[key]);for(let key of Object.getOwnPropertySymbols(value))result[key]=Immutable2(value[key]);return globalThis.Object.freeze(result)}function Immutable2(value){return IsArray5(value)?ImmutableArray2(value):IsDate5(value)?ImmutableDate2(value):IsUint8Array5(value)?ImmutableUint8Array2(value):IsRegExp4(value)?ImmutableRegExp2(value):IsObject5(value)?ImmutableObject2(value):value}function CreateType2(schema,options){let result=options!==void 0?{...options,...schema}:schema;switch(TypeSystemPolicy2.InstanceMode){case"freeze":return Immutable2(result);case"clone":return Clone3(result);default:return result}}var TypeBoxError2=class extends Error{constructor(message2){super(message2)}},TransformKind2=Symbol.for("TypeBox.Transform"),ReadonlyKind2=Symbol.for("TypeBox.Readonly"),OptionalKind2=Symbol.for("TypeBox.Optional"),Hint2=Symbol.for("TypeBox.Hint"),Kind2=Symbol.for("TypeBox.Kind");function IsReadonly3(value){return IsObject5(value)&&value[ReadonlyKind2]==="Readonly"}function IsOptional3(value){return IsObject5(value)&&value[OptionalKind2]==="Optional"}function IsAny3(value){return IsKindOf3(value,"Any")}function IsArgument3(value){return IsKindOf3(value,"Argument")}function IsArray32(value){return IsKindOf3(value,"Array")}function IsAsyncIterator22(value){return IsKindOf3(value,"AsyncIterator")}function IsBigInt22(value){return IsKindOf3(value,"BigInt")}function IsBoolean22(value){return IsKindOf3(value,"Boolean")}function IsComputed3(value){return IsKindOf3(value,"Computed")}function IsConstructor3(value){return IsKindOf3(value,"Constructor")}function IsDate22(value){return IsKindOf3(value,"Date")}function IsFunction22(value){return IsKindOf3(value,"Function")}function IsInteger4(value){return IsKindOf3(value,"Integer")}function IsIntersect3(value){return IsKindOf3(value,"Intersect")}function IsIterator22(value){return IsKindOf3(value,"Iterator")}function IsKindOf3(value,kind){return IsObject5(value)&&Kind2 in value&&value[Kind2]===kind}function IsLiteralValue3(value){return IsBoolean5(value)||IsNumber5(value)||IsString5(value)}function IsLiteral3(value){return IsKindOf3(value,"Literal")}function IsMappedKey3(value){return IsKindOf3(value,"MappedKey")}function IsMappedResult3(value){return IsKindOf3(value,"MappedResult")}function IsNever3(value){return IsKindOf3(value,"Never")}function IsNot3(value){return IsKindOf3(value,"Not")}function IsNull22(value){return IsKindOf3(value,"Null")}function IsNumber32(value){return IsKindOf3(value,"Number")}function IsObject32(value){return IsKindOf3(value,"Object")}function IsPromise4(value){return IsKindOf3(value,"Promise")}function IsRecord3(value){return IsKindOf3(value,"Record")}function IsRef3(value){return IsKindOf3(value,"Ref")}function IsRegExp22(value){return IsKindOf3(value,"RegExp")}function IsString22(value){return IsKindOf3(value,"String")}function IsSymbol22(value){return IsKindOf3(value,"Symbol")}function IsTemplateLiteral3(value){return IsKindOf3(value,"TemplateLiteral")}function IsThis3(value){return IsKindOf3(value,"This")}function IsTransform3(value){return IsObject5(value)&&TransformKind2 in value}function IsTuple3(value){return IsKindOf3(value,"Tuple")}function IsUndefined32(value){return IsKindOf3(value,"Undefined")}function IsUnion3(value){return IsKindOf3(value,"Union")}function IsUint8Array22(value){return IsKindOf3(value,"Uint8Array")}function IsUnknown3(value){return IsKindOf3(value,"Unknown")}function IsUnsafe3(value){return IsKindOf3(value,"Unsafe")}function IsVoid3(value){return IsKindOf3(value,"Void")}function IsKind3(value){return IsObject5(value)&&Kind2 in value&&IsString5(value[Kind2])}function IsSchema3(value){return IsAny3(value)||IsArgument3(value)||IsArray32(value)||IsBoolean22(value)||IsBigInt22(value)||IsAsyncIterator22(value)||IsComputed3(value)||IsConstructor3(value)||IsDate22(value)||IsFunction22(value)||IsInteger4(value)||IsIntersect3(value)||IsIterator22(value)||IsLiteral3(value)||IsMappedKey3(value)||IsMappedResult3(value)||IsNever3(value)||IsNot3(value)||IsNull22(value)||IsNumber32(value)||IsObject32(value)||IsPromise4(value)||IsRecord3(value)||IsRef3(value)||IsRegExp22(value)||IsString22(value)||IsSymbol22(value)||IsTemplateLiteral3(value)||IsThis3(value)||IsTuple3(value)||IsUndefined32(value)||IsUnion3(value)||IsUint8Array22(value)||IsUnknown3(value)||IsUnsafe3(value)||IsVoid3(value)||IsKind3(value)}var type_exports={};__export2(type_exports,{IsAny:()=>IsAny22,IsArgument:()=>IsArgument22,IsArray:()=>IsArray42,IsAsyncIterator:()=>IsAsyncIterator32,IsBigInt:()=>IsBigInt32,IsBoolean:()=>IsBoolean32,IsComputed:()=>IsComputed22,IsConstructor:()=>IsConstructor22,IsDate:()=>IsDate32,IsFunction:()=>IsFunction32,IsImport:()=>IsImport2,IsInteger:()=>IsInteger22,IsIntersect:()=>IsIntersect22,IsIterator:()=>IsIterator32,IsKind:()=>IsKind22,IsKindOf:()=>IsKindOf22,IsLiteral:()=>IsLiteral22,IsLiteralBoolean:()=>IsLiteralBoolean2,IsLiteralNumber:()=>IsLiteralNumber2,IsLiteralString:()=>IsLiteralString2,IsLiteralValue:()=>IsLiteralValue22,IsMappedKey:()=>IsMappedKey22,IsMappedResult:()=>IsMappedResult22,IsNever:()=>IsNever22,IsNot:()=>IsNot22,IsNull:()=>IsNull32,IsNumber:()=>IsNumber42,IsObject:()=>IsObject42,IsOptional:()=>IsOptional22,IsPromise:()=>IsPromise22,IsProperties:()=>IsProperties2,IsReadonly:()=>IsReadonly22,IsRecord:()=>IsRecord22,IsRecursive:()=>IsRecursive2,IsRef:()=>IsRef22,IsRegExp:()=>IsRegExp32,IsSchema:()=>IsSchema22,IsString:()=>IsString32,IsSymbol:()=>IsSymbol32,IsTemplateLiteral:()=>IsTemplateLiteral22,IsThis:()=>IsThis22,IsTransform:()=>IsTransform22,IsTuple:()=>IsTuple22,IsUint8Array:()=>IsUint8Array32,IsUndefined:()=>IsUndefined42,IsUnion:()=>IsUnion22,IsUnionLiteral:()=>IsUnionLiteral2,IsUnknown:()=>IsUnknown22,IsUnsafe:()=>IsUnsafe22,IsVoid:()=>IsVoid22,TypeGuardUnknownTypeError:()=>TypeGuardUnknownTypeError2});var TypeGuardUnknownTypeError2=class extends TypeBoxError2{},KnownTypes2=["Argument","Any","Array","AsyncIterator","BigInt","Boolean","Computed","Constructor","Date","Enum","Function","Integer","Intersect","Iterator","Literal","MappedKey","MappedResult","Not","Null","Number","Object","Promise","Record","Ref","RegExp","String","Symbol","TemplateLiteral","This","Tuple","Undefined","Union","Uint8Array","Unknown","Void"];function IsPattern2(value){try{return new RegExp(value),!0}catch{return!1}}function IsControlCharacterFree2(value){if(!IsString5(value))return!1;for(let i=0;i<value.length;i++){let code=value.charCodeAt(i);if(code>=7&&code<=13||code===27||code===127)return!1}return!0}function IsAdditionalProperties2(value){return IsOptionalBoolean2(value)||IsSchema22(value)}function IsOptionalBigInt2(value){return IsUndefined5(value)||IsBigInt5(value)}function IsOptionalNumber2(value){return IsUndefined5(value)||IsNumber5(value)}function IsOptionalBoolean2(value){return IsUndefined5(value)||IsBoolean5(value)}function IsOptionalString2(value){return IsUndefined5(value)||IsString5(value)}function IsOptionalPattern2(value){return IsUndefined5(value)||IsString5(value)&&IsControlCharacterFree2(value)&&IsPattern2(value)}function IsOptionalFormat2(value){return IsUndefined5(value)||IsString5(value)&&IsControlCharacterFree2(value)}function IsOptionalSchema2(value){return IsUndefined5(value)||IsSchema22(value)}function IsReadonly22(value){return IsObject5(value)&&value[ReadonlyKind2]==="Readonly"}function IsOptional22(value){return IsObject5(value)&&value[OptionalKind2]==="Optional"}function IsAny22(value){return IsKindOf22(value,"Any")&&IsOptionalString2(value.$id)}function IsArgument22(value){return IsKindOf22(value,"Argument")&&IsNumber5(value.index)}function IsArray42(value){return IsKindOf22(value,"Array")&&value.type==="array"&&IsOptionalString2(value.$id)&&IsSchema22(value.items)&&IsOptionalNumber2(value.minItems)&&IsOptionalNumber2(value.maxItems)&&IsOptionalBoolean2(value.uniqueItems)&&IsOptionalSchema2(value.contains)&&IsOptionalNumber2(value.minContains)&&IsOptionalNumber2(value.maxContains)}function IsAsyncIterator32(value){return IsKindOf22(value,"AsyncIterator")&&value.type==="AsyncIterator"&&IsOptionalString2(value.$id)&&IsSchema22(value.items)}function IsBigInt32(value){return IsKindOf22(value,"BigInt")&&value.type==="bigint"&&IsOptionalString2(value.$id)&&IsOptionalBigInt2(value.exclusiveMaximum)&&IsOptionalBigInt2(value.exclusiveMinimum)&&IsOptionalBigInt2(value.maximum)&&IsOptionalBigInt2(value.minimum)&&IsOptionalBigInt2(value.multipleOf)}function IsBoolean32(value){return IsKindOf22(value,"Boolean")&&value.type==="boolean"&&IsOptionalString2(value.$id)}function IsComputed22(value){return IsKindOf22(value,"Computed")&&IsString5(value.target)&&IsArray5(value.parameters)&&value.parameters.every((schema)=>IsSchema22(schema))}function IsConstructor22(value){return IsKindOf22(value,"Constructor")&&value.type==="Constructor"&&IsOptionalString2(value.$id)&&IsArray5(value.parameters)&&value.parameters.every((schema)=>IsSchema22(schema))&&IsSchema22(value.returns)}function IsDate32(value){return IsKindOf22(value,"Date")&&value.type==="Date"&&IsOptionalString2(value.$id)&&IsOptionalNumber2(value.exclusiveMaximumTimestamp)&&IsOptionalNumber2(value.exclusiveMinimumTimestamp)&&IsOptionalNumber2(value.maximumTimestamp)&&IsOptionalNumber2(value.minimumTimestamp)&&IsOptionalNumber2(value.multipleOfTimestamp)}function IsFunction32(value){return IsKindOf22(value,"Function")&&value.type==="Function"&&IsOptionalString2(value.$id)&&IsArray5(value.parameters)&&value.parameters.every((schema)=>IsSchema22(schema))&&IsSchema22(value.returns)}function IsImport2(value){return IsKindOf22(value,"Import")&&HasPropertyKey3(value,"$defs")&&IsObject5(value.$defs)&&IsProperties2(value.$defs)&&HasPropertyKey3(value,"$ref")&&IsString5(value.$ref)&&value.$ref in value.$defs}function IsInteger22(value){return IsKindOf22(value,"Integer")&&value.type==="integer"&&IsOptionalString2(value.$id)&&IsOptionalNumber2(value.exclusiveMaximum)&&IsOptionalNumber2(value.exclusiveMinimum)&&IsOptionalNumber2(value.maximum)&&IsOptionalNumber2(value.minimum)&&IsOptionalNumber2(value.multipleOf)}function IsProperties2(value){return IsObject5(value)&&Object.entries(value).every(([key,schema])=>IsControlCharacterFree2(key)&&IsSchema22(schema))}function IsIntersect22(value){return IsKindOf22(value,"Intersect")&&(IsString5(value.type)&&value.type!=="object"?!1:!0)&&IsArray5(value.allOf)&&value.allOf.every((schema)=>IsSchema22(schema)&&!IsTransform22(schema))&&IsOptionalString2(value.type)&&(IsOptionalBoolean2(value.unevaluatedProperties)||IsOptionalSchema2(value.unevaluatedProperties))&&IsOptionalString2(value.$id)}function IsIterator32(value){return IsKindOf22(value,"Iterator")&&value.type==="Iterator"&&IsOptionalString2(value.$id)&&IsSchema22(value.items)}function IsKindOf22(value,kind){return IsObject5(value)&&Kind2 in value&&value[Kind2]===kind}function IsLiteralString2(value){return IsLiteral22(value)&&IsString5(value.const)}function IsLiteralNumber2(value){return IsLiteral22(value)&&IsNumber5(value.const)}function IsLiteralBoolean2(value){return IsLiteral22(value)&&IsBoolean5(value.const)}function IsLiteral22(value){return IsKindOf22(value,"Literal")&&IsOptionalString2(value.$id)&&IsLiteralValue22(value.const)}function IsLiteralValue22(value){return IsBoolean5(value)||IsNumber5(value)||IsString5(value)}function IsMappedKey22(value){return IsKindOf22(value,"MappedKey")&&IsArray5(value.keys)&&value.keys.every((key)=>IsNumber5(key)||IsString5(key))}function IsMappedResult22(value){return IsKindOf22(value,"MappedResult")&&IsProperties2(value.properties)}function IsNever22(value){return IsKindOf22(value,"Never")&&IsObject5(value.not)&&Object.getOwnPropertyNames(value.not).length===0}function IsNot22(value){return IsKindOf22(value,"Not")&&IsSchema22(value.not)}function IsNull32(value){return IsKindOf22(value,"Null")&&value.type==="null"&&IsOptionalString2(value.$id)}function IsNumber42(value){return IsKindOf22(value,"Number")&&value.type==="number"&&IsOptionalString2(value.$id)&&IsOptionalNumber2(value.exclusiveMaximum)&&IsOptionalNumber2(value.exclusiveMinimum)&&IsOptionalNumber2(value.maximum)&&IsOptionalNumber2(value.minimum)&&IsOptionalNumber2(value.multipleOf)}function IsObject42(value){return IsKindOf22(value,"Object")&&value.type==="object"&&IsOptionalString2(value.$id)&&IsProperties2(value.properties)&&IsAdditionalProperties2(value.additionalProperties)&&IsOptionalNumber2(value.minProperties)&&IsOptionalNumber2(value.maxProperties)}function IsPromise22(value){return IsKindOf22(value,"Promise")&&value.type==="Promise"&&IsOptionalString2(value.$id)&&IsSchema22(value.item)}function IsRecord22(value){return IsKindOf22(value,"Record")&&value.type==="object"&&IsOptionalString2(value.$id)&&IsAdditionalProperties2(value.additionalProperties)&&IsObject5(value.patternProperties)&&((schema)=>{let keys=Object.getOwnPropertyNames(schema.patternProperties);return keys.length===1&&IsPattern2(keys[0])&&IsObject5(schema.patternProperties)&&IsSchema22(schema.patternProperties[keys[0]])})(value)}function IsRecursive2(value){return IsObject5(value)&&Hint2 in value&&value[Hint2]==="Recursive"}function IsRef22(value){return IsKindOf22(value,"Ref")&&IsOptionalString2(value.$id)&&IsString5(value.$ref)}function IsRegExp32(value){return IsKindOf22(value,"RegExp")&&IsOptionalString2(value.$id)&&IsString5(value.source)&&IsString5(value.flags)&&IsOptionalNumber2(value.maxLength)&&IsOptionalNumber2(value.minLength)}function IsString32(value){return IsKindOf22(value,"String")&&value.type==="string"&&IsOptionalString2(value.$id)&&IsOptionalNumber2(value.minLength)&&IsOptionalNumber2(value.maxLength)&&IsOptionalPattern2(value.pattern)&&IsOptionalFormat2(value.format)}function IsSymbol32(value){return IsKindOf22(value,"Symbol")&&value.type==="symbol"&&IsOptionalString2(value.$id)}function IsTemplateLiteral22(value){return IsKindOf22(value,"TemplateLiteral")&&value.type==="string"&&IsString5(value.pattern)&&value.pattern[0]==="^"&&value.pattern[value.pattern.length-1]==="$"}function IsThis22(value){return IsKindOf22(value,"This")&&IsOptionalString2(value.$id)&&IsString5(value.$ref)}function IsTransform22(value){return IsObject5(value)&&TransformKind2 in value}function IsTuple22(value){return IsKindOf22(value,"Tuple")&&value.type==="array"&&IsOptionalString2(value.$id)&&IsNumber5(value.minItems)&&IsNumber5(value.maxItems)&&value.minItems===value.maxItems&&(IsUndefined5(value.items)&&IsUndefined5(value.additionalItems)&&value.minItems===0||IsArray5(value.items)&&value.items.every((schema)=>IsSchema22(schema)))}function IsUndefined42(value){return IsKindOf22(value,"Undefined")&&value.type==="undefined"&&IsOptionalString2(value.$id)}function IsUnionLiteral2(value){return IsUnion22(value)&&value.anyOf.every((schema)=>IsLiteralString2(schema)||IsLiteralNumber2(schema))}function IsUnion22(value){return IsKindOf22(value,"Union")&&IsOptionalString2(value.$id)&&IsObject5(value)&&IsArray5(value.anyOf)&&value.anyOf.every((schema)=>IsSchema22(schema))}function IsUint8Array32(value){return IsKindOf22(value,"Uint8Array")&&value.type==="Uint8Array"&&IsOptionalString2(value.$id)&&IsOptionalNumber2(value.minByteLength)&&IsOptionalNumber2(value.maxByteLength)}function IsUnknown22(value){return IsKindOf22(value,"Unknown")&&IsOptionalString2(value.$id)}function IsUnsafe22(value){return IsKindOf22(value,"Unsafe")}function IsVoid22(value){return IsKindOf22(value,"Void")&&value.type==="void"&&IsOptionalString2(value.$id)}function IsKind22(value){return IsObject5(value)&&Kind2 in value&&IsString5(value[Kind2])&&!KnownTypes2.includes(value[Kind2])}function IsSchema22(value){return IsObject5(value)&&(IsAny22(value)||IsArgument22(value)||IsArray42(value)||IsBoolean32(value)||IsBigInt32(value)||IsAsyncIterator32(value)||IsComputed22(value)||IsConstructor22(value)||IsDate32(value)||IsFunction32(value)||IsInteger22(value)||IsIntersect22(value)||IsIterator32(value)||IsLiteral22(value)||IsMappedKey22(value)||IsMappedResult22(value)||IsNever22(value)||IsNot22(value)||IsNull32(value)||IsNumber42(value)||IsObject42(value)||IsPromise22(value)||IsRecord22(value)||IsRef22(value)||IsRegExp32(value)||IsString32(value)||IsSymbol32(value)||IsTemplateLiteral22(value)||IsThis22(value)||IsTuple22(value)||IsUndefined42(value)||IsUnion22(value)||IsUint8Array32(value)||IsUnknown22(value)||IsUnsafe22(value)||IsVoid22(value)||IsKind22(value))}var PatternBoolean2="(true|false)",PatternNumber2="(0|[1-9][0-9]*)",PatternString2="(.*)",PatternNever="(?!.*)",PatternBooleanExact=`^${PatternBoolean2}$`,PatternNumberExact2=`^${PatternNumber2}$`,PatternStringExact2=`^${PatternString2}$`,PatternNeverExact2=`^${PatternNever}$`;function SetIncludes2(T2,S){return T2.includes(S)}function SetDistinct2(T2){return[...new Set(T2)]}function SetIntersect2(T2,S){return T2.filter((L)=>S.includes(L))}function SetIntersectManyResolve2(T2,Init){return T2.reduce((Acc,L)=>{return SetIntersect2(Acc,L)},Init)}function SetIntersectMany2(T2){return T2.length===1?T2[0]:T2.length>1?SetIntersectManyResolve2(T2.slice(1),T2[0]):[]}function SetUnionMany2(T2){let Acc=[];for(let L of T2)Acc.push(...L);return Acc}function Any2(options){return CreateType2({[Kind2]:"Any"},options)}function Array22(items,options){return CreateType2({[Kind2]:"Array",type:"array",items},options)}function Argument2(index2){return CreateType2({[Kind2]:"Argument",index:index2})}function AsyncIterator2(items,options){return CreateType2({[Kind2]:"AsyncIterator",type:"AsyncIterator",items},options)}function Computed2(target,parameters,options){return CreateType2({[Kind2]:"Computed",target,parameters},options)}function DiscardKey2(value,key){let{[key]:_2,...rest}=value;return rest}function Discard2(value,keys){return keys.reduce((acc,key)=>DiscardKey2(acc,key),value)}function Never2(options){return CreateType2({[Kind2]:"Never",not:{}},options)}function MappedResult2(properties){return CreateType2({[Kind2]:"MappedResult",properties})}function Constructor2(parameters,returns2,options){return CreateType2({[Kind2]:"Constructor",type:"Constructor",parameters,returns:returns2},options)}function Function3(parameters,returns2,options){return CreateType2({[Kind2]:"Function",type:"Function",parameters,returns:returns2},options)}function UnionCreate2(T2,options){return CreateType2({[Kind2]:"Union",anyOf:T2},options)}function IsUnionOptional2(types3){return types3.some((type2)=>IsOptional3(type2))}function RemoveOptionalFromRest3(types3){return types3.map((left)=>IsOptional3(left)?RemoveOptionalFromType3(left):left)}function RemoveOptionalFromType3(T2){return Discard2(T2,[OptionalKind2])}function ResolveUnion2(types3,options){return IsUnionOptional2(types3)?Optional2(UnionCreate2(RemoveOptionalFromRest3(types3),options)):UnionCreate2(RemoveOptionalFromRest3(types3),options)}function UnionEvaluated2(T2,options){return T2.length===1?CreateType2(T2[0],options):T2.length===0?Never2(options):ResolveUnion2(T2,options)}function Union3(types3,options){return types3.length===0?Never2(options):types3.length===1?CreateType2(types3[0],options):UnionCreate2(types3,options)}var TemplateLiteralParserError2=class extends TypeBoxError2{};function Unescape2(pattern){return pattern.replace(/\\\$/g,"$").replace(/\\\*/g,"*").replace(/\\\^/g,"^").replace(/\\\|/g,"|").replace(/\\\(/g,"(").replace(/\\\)/g,")")}function IsNonEscaped2(pattern,index2,char2){return pattern[index2]===char2&&pattern.charCodeAt(index2-1)!==92}function IsOpenParen2(pattern,index2){return IsNonEscaped2(pattern,index2,"(")}function IsCloseParen2(pattern,index2){return IsNonEscaped2(pattern,index2,")")}function IsSeparator2(pattern,index2){return IsNonEscaped2(pattern,index2,"|")}function IsGroup2(pattern){if(!(IsOpenParen2(pattern,0)&&IsCloseParen2(pattern,pattern.length-1)))return!1;let count2=0;for(let index2=0;index2<pattern.length;index2++){if(IsOpenParen2(pattern,index2))count2+=1;if(IsCloseParen2(pattern,index2))count2-=1;if(count2===0&&index2!==pattern.length-1)return!1}return!0}function InGroup2(pattern){return pattern.slice(1,pattern.length-1)}function IsPrecedenceOr2(pattern){let count2=0;for(let index2=0;index2<pattern.length;index2++){if(IsOpenParen2(pattern,index2))count2+=1;if(IsCloseParen2(pattern,index2))count2-=1;if(IsSeparator2(pattern,index2)&&count2===0)return!0}return!1}function IsPrecedenceAnd2(pattern){for(let index2=0;index2<pattern.length;index2++)if(IsOpenParen2(pattern,index2))return!0;return!1}function Or2(pattern){let[count2,start]=[0,0],expressions=[];for(let index2=0;index2<pattern.length;index2++){if(IsOpenParen2(pattern,index2))count2+=1;if(IsCloseParen2(pattern,index2))count2-=1;if(IsSeparator2(pattern,index2)&&count2===0){let range2=pattern.slice(start,index2);if(range2.length>0)expressions.push(TemplateLiteralParse2(range2));start=index2+1}}let range=pattern.slice(start);if(range.length>0)expressions.push(TemplateLiteralParse2(range));if(expressions.length===0)return{type:"const",const:""};if(expressions.length===1)return expressions[0];return{type:"or",expr:expressions}}function And2(pattern){function Group(value,index2){if(!IsOpenParen2(value,index2))throw new TemplateLiteralParserError2("TemplateLiteralParser: Index must point to open parens");let count2=0;for(let scan=index2;scan<value.length;scan++){if(IsOpenParen2(value,scan))count2+=1;if(IsCloseParen2(value,scan))count2-=1;if(count2===0)return[index2,scan]}throw new TemplateLiteralParserError2("TemplateLiteralParser: Unclosed group parens in expression")}function Range(pattern2,index2){for(let scan=index2;scan<pattern2.length;scan++)if(IsOpenParen2(pattern2,scan))return[index2,scan];return[index2,pattern2.length]}let expressions=[];for(let index2=0;index2<pattern.length;index2++)if(IsOpenParen2(pattern,index2)){let[start,end]=Group(pattern,index2),range=pattern.slice(start,end+1);expressions.push(TemplateLiteralParse2(range)),index2=end}else{let[start,end]=Range(pattern,index2),range=pattern.slice(start,end);if(range.length>0)expressions.push(TemplateLiteralParse2(range));index2=end-1}return expressions.length===0?{type:"const",const:""}:expressions.length===1?expressions[0]:{type:"and",expr:expressions}}function TemplateLiteralParse2(pattern){return IsGroup2(pattern)?TemplateLiteralParse2(InGroup2(pattern)):IsPrecedenceOr2(pattern)?Or2(pattern):IsPrecedenceAnd2(pattern)?And2(pattern):{type:"const",const:Unescape2(pattern)}}function TemplateLiteralParseExact2(pattern){return TemplateLiteralParse2(pattern.slice(1,pattern.length-1))}var TemplateLiteralFiniteError2=class extends TypeBoxError2{};function IsNumberExpression2(expression){return expression.type==="or"&&expression.expr.length===2&&expression.expr[0].type==="const"&&expression.expr[0].const==="0"&&expression.expr[1].type==="const"&&expression.expr[1].const==="[1-9][0-9]*"}function IsBooleanExpression2(expression){return expression.type==="or"&&expression.expr.length===2&&expression.expr[0].type==="const"&&expression.expr[0].const==="true"&&expression.expr[1].type==="const"&&expression.expr[1].const==="false"}function IsStringExpression2(expression){return expression.type==="const"&&expression.const===".*"}function IsTemplateLiteralExpressionFinite2(expression){return IsNumberExpression2(expression)||IsStringExpression2(expression)?!1:IsBooleanExpression2(expression)?!0:expression.type==="and"?expression.expr.every((expr)=>IsTemplateLiteralExpressionFinite2(expr)):expression.type==="or"?expression.expr.every((expr)=>IsTemplateLiteralExpressionFinite2(expr)):expression.type==="const"?!0:(()=>{throw new TemplateLiteralFiniteError2("Unknown expression type")})()}function IsTemplateLiteralFinite2(schema){let expression=TemplateLiteralParseExact2(schema.pattern);return IsTemplateLiteralExpressionFinite2(expression)}var TemplateLiteralGenerateError2=class extends TypeBoxError2{};function*GenerateReduce2(buffer2){if(buffer2.length===1)return yield*buffer2[0];for(let left of buffer2[0])for(let right of GenerateReduce2(buffer2.slice(1)))yield`${left}${right}`}function*GenerateAnd2(expression){return yield*GenerateReduce2(expression.expr.map((expr)=>[...TemplateLiteralExpressionGenerate2(expr)]))}function*GenerateOr2(expression){for(let expr of expression.expr)yield*TemplateLiteralExpressionGenerate2(expr)}function*GenerateConst2(expression){return yield expression.const}function*TemplateLiteralExpressionGenerate2(expression){return expression.type==="and"?yield*GenerateAnd2(expression):expression.type==="or"?yield*GenerateOr2(expression):expression.type==="const"?yield*GenerateConst2(expression):(()=>{throw new TemplateLiteralGenerateError2("Unknown expression")})()}function TemplateLiteralGenerate2(schema){let expression=TemplateLiteralParseExact2(schema.pattern);return IsTemplateLiteralExpressionFinite2(expression)?[...TemplateLiteralExpressionGenerate2(expression)]:[]}function Literal2(value,options){return CreateType2({[Kind2]:"Literal",const:value,type:typeof value},options)}function Boolean3(options){return CreateType2({[Kind2]:"Boolean",type:"boolean"},options)}function BigInt3(options){return CreateType2({[Kind2]:"BigInt",type:"bigint"},options)}function Number22(options){return CreateType2({[Kind2]:"Number",type:"number"},options)}function String3(options){return CreateType2({[Kind2]:"String",type:"string"},options)}function*FromUnion21(syntax){let trim=syntax.trim().replace(/"|'/g,"");return trim==="boolean"?yield Boolean3():trim==="number"?yield Number22():trim==="bigint"?yield BigInt3():trim==="string"?yield String3():yield(()=>{let literals=trim.split("|").map((literal)=>Literal2(literal.trim()));return literals.length===0?Never2():literals.length===1?literals[0]:UnionEvaluated2(literals)})()}function*FromTerminal2(syntax){if(syntax[1]!=="{"){let L=Literal2("$"),R=FromSyntax2(syntax.slice(1));return yield*[L,...R]}for(let i=2;i<syntax.length;i++)if(syntax[i]==="}"){let L=FromUnion21(syntax.slice(2,i)),R=FromSyntax2(syntax.slice(i+1));return yield*[...L,...R]}yield Literal2(syntax)}function*FromSyntax2(syntax){for(let i=0;i<syntax.length;i++)if(syntax[i]==="$"){let L=Literal2(syntax.slice(0,i)),R=FromTerminal2(syntax.slice(i));return yield*[L,...R]}yield Literal2(syntax)}function TemplateLiteralSyntax2(syntax){return[...FromSyntax2(syntax)]}var TemplateLiteralPatternError2=class extends TypeBoxError2{};function Escape3(value){return value.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Visit22(schema,acc){return IsTemplateLiteral3(schema)?schema.pattern.slice(1,schema.pattern.length-1):IsUnion3(schema)?`(${schema.anyOf.map((schema2)=>Visit22(schema2,acc)).join("|")})`:IsNumber32(schema)?`${acc}${PatternNumber2}`:IsInteger4(schema)?`${acc}${PatternNumber2}`:IsBigInt22(schema)?`${acc}${PatternNumber2}`:IsString22(schema)?`${acc}${PatternString2}`:IsLiteral3(schema)?`${acc}${Escape3(schema.const.toString())}`:IsBoolean22(schema)?`${acc}${PatternBoolean2}`:(()=>{throw new TemplateLiteralPatternError2(`Unexpected Kind '${schema[Kind2]}'`)})()}function TemplateLiteralPattern2(kinds){return`^${kinds.map((schema)=>Visit22(schema,"")).join("")}$`}function TemplateLiteralToUnion2(schema){let L=TemplateLiteralGenerate2(schema).map((S)=>Literal2(S));return UnionEvaluated2(L)}function TemplateLiteral2(unresolved,options){let pattern=IsString5(unresolved)?TemplateLiteralPattern2(TemplateLiteralSyntax2(unresolved)):TemplateLiteralPattern2(unresolved);return CreateType2({[Kind2]:"TemplateLiteral",type:"string",pattern},options)}function FromTemplateLiteral7(templateLiteral){return TemplateLiteralGenerate2(templateLiteral).map((key)=>key.toString())}function FromUnion22(types3){let result=[];for(let type2 of types3)result.push(...IndexPropertyKeys2(type2));return result}function FromLiteral7(literalValue){return[literalValue.toString()]}function IndexPropertyKeys2(type2){return[...new Set(IsTemplateLiteral3(type2)?FromTemplateLiteral7(type2):IsUnion3(type2)?FromUnion22(type2.anyOf):IsLiteral3(type2)?FromLiteral7(type2.const):IsNumber32(type2)?["[number]"]:IsInteger4(type2)?["[number]"]:[])]}function FromProperties20(type2,properties,options){let result={};for(let K2 of Object.getOwnPropertyNames(properties))result[K2]=Index3(type2,IndexPropertyKeys2(properties[K2]),options);return result}function FromMappedResult13(type2,mappedResult,options){return FromProperties20(type2,mappedResult.properties,options)}function IndexFromMappedResult2(type2,mappedResult,options){let properties=FromMappedResult13(type2,mappedResult,options);return MappedResult2(properties)}function FromRest8(types3,key){return types3.map((type2)=>IndexFromPropertyKey2(type2,key))}function FromIntersectRest2(types3){return types3.filter((type2)=>!IsNever3(type2))}function FromIntersect19(types3,key){return IntersectEvaluated2(FromIntersectRest2(FromRest8(types3,key)))}function FromUnionRest2(types3){return types3.some((L)=>IsNever3(L))?[]:types3}function FromUnion32(types3,key){return UnionEvaluated2(FromUnionRest2(FromRest8(types3,key)))}function FromTuple16(types3,key){return key in types3?types3[key]:key==="[number]"?UnionEvaluated2(types3):Never2()}function FromArray18(type2,key){return key==="[number]"?type2:Never2()}function FromProperty4(properties,propertyKey){return propertyKey in properties?properties[propertyKey]:Never2()}function IndexFromPropertyKey2(type2,propertyKey){return IsIntersect3(type2)?FromIntersect19(type2.allOf,propertyKey):IsUnion3(type2)?FromUnion32(type2.anyOf,propertyKey):IsTuple3(type2)?FromTuple16(type2.items??[],propertyKey):IsArray32(type2)?FromArray18(type2.items,propertyKey):IsObject32(type2)?FromProperty4(type2.properties,propertyKey):Never2()}function IndexFromPropertyKeys2(type2,propertyKeys){return propertyKeys.map((propertyKey)=>IndexFromPropertyKey2(type2,propertyKey))}function FromSchema2(type2,propertyKeys){return UnionEvaluated2(IndexFromPropertyKeys2(type2,propertyKeys))}function Index3(type2,key,options){if(IsRef3(type2)||IsRef3(key)){if(!IsSchema3(type2)||!IsSchema3(key))throw new TypeBoxError2("Index types using Ref parameters require both Type and Key to be of TSchema");return Computed2("Index",[type2,key])}if(IsMappedResult3(key))return IndexFromMappedResult2(type2,key,options);if(IsMappedKey3(key))return IndexFromMappedKey2(type2,key,options);return CreateType2(IsSchema3(key)?FromSchema2(type2,IndexPropertyKeys2(key)):FromSchema2(type2,key),options)}function MappedIndexPropertyKey2(type2,key,options){return{[key]:Index3(type2,[key],Clone3(options))}}function MappedIndexPropertyKeys2(type2,propertyKeys,options){return propertyKeys.reduce((result,left)=>{return{...result,...MappedIndexPropertyKey2(type2,left,options)}},{})}function MappedIndexProperties2(type2,mappedKey,options){return MappedIndexPropertyKeys2(type2,mappedKey.keys,options)}function IndexFromMappedKey2(type2,mappedKey,options){let properties=MappedIndexProperties2(type2,mappedKey,options);return MappedResult2(properties)}function Iterator2(items,options){return CreateType2({[Kind2]:"Iterator",type:"Iterator",items},options)}function RequiredKeys2(properties){let keys=[];for(let key in properties)if(!IsOptional3(properties[key]))keys.push(key);return keys}function _Object2(properties,options){let required=RequiredKeys2(properties),schematic=required.length>0?{[Kind2]:"Object",type:"object",properties,required}:{[Kind2]:"Object",type:"object",properties};return CreateType2(schematic,options)}var Object22=_Object2;function Promise22(item,options){return CreateType2({[Kind2]:"Promise",type:"Promise",item},options)}function RemoveReadonly2(schema){return CreateType2(Discard2(schema,[ReadonlyKind2]))}function AddReadonly2(schema){return CreateType2({...schema,[ReadonlyKind2]:"Readonly"})}function ReadonlyWithFlag2(schema,F){return F===!1?RemoveReadonly2(schema):AddReadonly2(schema)}function Readonly2(schema,enable){let F=enable??!0;return IsMappedResult3(schema)?ReadonlyFromMappedResult2(schema,F):ReadonlyWithFlag2(schema,F)}function FromProperties22(K,F){let Acc={};for(let K2 of globalThis.Object.getOwnPropertyNames(K))Acc[K2]=Readonly2(K[K2],F);return Acc}function FromMappedResult22(R,F){return FromProperties22(R.properties,F)}function ReadonlyFromMappedResult2(R,F){let P=FromMappedResult22(R,F);return MappedResult2(P)}function Tuple2(types3,options){return CreateType2(types3.length>0?{[Kind2]:"Tuple",type:"array",items:types3,additionalItems:!1,minItems:types3.length,maxItems:types3.length}:{[Kind2]:"Tuple",type:"array",minItems:types3.length,maxItems:types3.length},options)}function FromMappedResult32(K,P){return K in P?FromSchemaType2(K,P[K]):MappedResult2(P)}function MappedKeyToKnownMappedResultProperties2(K){return{[K]:Literal2(K)}}function MappedKeyToUnknownMappedResultProperties2(P){let Acc={};for(let L of P)Acc[L]=Literal2(L);return Acc}function MappedKeyToMappedResultProperties2(K,P){return SetIncludes2(P,K)?MappedKeyToKnownMappedResultProperties2(K):MappedKeyToUnknownMappedResultProperties2(P)}function FromMappedKey5(K,P){let R=MappedKeyToMappedResultProperties2(K,P);return FromMappedResult32(K,R)}function FromRest22(K,T2){return T2.map((L)=>FromSchemaType2(K,L))}function FromProperties32(K,T2){let Acc={};for(let K2 of globalThis.Object.getOwnPropertyNames(T2))Acc[K2]=FromSchemaType2(K,T2[K2]);return Acc}function FromSchemaType2(K,T2){let options={...T2};return IsOptional3(T2)?Optional2(FromSchemaType2(K,Discard2(T2,[OptionalKind2]))):IsReadonly3(T2)?Readonly2(FromSchemaType2(K,Discard2(T2,[ReadonlyKind2]))):IsMappedResult3(T2)?FromMappedResult32(K,T2.properties):IsMappedKey3(T2)?FromMappedKey5(K,T2.keys):IsConstructor3(T2)?Constructor2(FromRest22(K,T2.parameters),FromSchemaType2(K,T2.returns),options):IsFunction22(T2)?Function3(FromRest22(K,T2.parameters),FromSchemaType2(K,T2.returns),options):IsAsyncIterator22(T2)?AsyncIterator2(FromSchemaType2(K,T2.items),options):IsIterator22(T2)?Iterator2(FromSchemaType2(K,T2.items),options):IsIntersect3(T2)?Intersect3(FromRest22(K,T2.allOf),options):IsUnion3(T2)?Union3(FromRest22(K,T2.anyOf),options):IsTuple3(T2)?Tuple2(FromRest22(K,T2.items??[]),options):IsObject32(T2)?Object22(FromProperties32(K,T2.properties),options):IsArray32(T2)?Array22(FromSchemaType2(K,T2.items),options):IsPromise4(T2)?Promise22(FromSchemaType2(K,T2.item),options):T2}function MappedFunctionReturnType2(K,T2){let Acc={};for(let L of K)Acc[L]=FromSchemaType2(L,T2);return Acc}function Mapped2(key,map3,options){let K=IsSchema3(key)?IndexPropertyKeys2(key):key,RT=map3({[Kind2]:"MappedKey",keys:K}),R=MappedFunctionReturnType2(K,RT);return Object22(R,options)}function RemoveOptional2(schema){return CreateType2(Discard2(schema,[OptionalKind2]))}function AddOptional2(schema){return CreateType2({...schema,[OptionalKind2]:"Optional"})}function OptionalWithFlag2(schema,F){return F===!1?RemoveOptional2(schema):AddOptional2(schema)}function Optional2(schema,enable){let F=enable??!0;return IsMappedResult3(schema)?OptionalFromMappedResult2(schema,F):OptionalWithFlag2(schema,F)}function FromProperties42(P,F){let Acc={};for(let K2 of globalThis.Object.getOwnPropertyNames(P))Acc[K2]=Optional2(P[K2],F);return Acc}function FromMappedResult42(R,F){return FromProperties42(R.properties,F)}function OptionalFromMappedResult2(R,F){let P=FromMappedResult42(R,F);return MappedResult2(P)}function IntersectCreate2(T2,options={}){let allObjects=T2.every((schema)=>IsObject32(schema)),clonedUnevaluatedProperties=IsSchema3(options.unevaluatedProperties)?{unevaluatedProperties:options.unevaluatedProperties}:{};return CreateType2(options.unevaluatedProperties===!1||IsSchema3(options.unevaluatedProperties)||allObjects?{...clonedUnevaluatedProperties,[Kind2]:"Intersect",type:"object",allOf:T2}:{...clonedUnevaluatedProperties,[Kind2]:"Intersect",allOf:T2},options)}function IsIntersectOptional2(types3){return types3.every((left)=>IsOptional3(left))}function RemoveOptionalFromType22(type2){return Discard2(type2,[OptionalKind2])}function RemoveOptionalFromRest22(types3){return types3.map((left)=>IsOptional3(left)?RemoveOptionalFromType22(left):left)}function ResolveIntersect2(types3,options){return IsIntersectOptional2(types3)?Optional2(IntersectCreate2(RemoveOptionalFromRest22(types3),options)):IntersectCreate2(RemoveOptionalFromRest22(types3),options)}function IntersectEvaluated2(types3,options={}){if(types3.length===1)return CreateType2(types3[0],options);if(types3.length===0)return Never2(options);if(types3.some((schema)=>IsTransform3(schema)))throw new Error("Cannot intersect transform types");return ResolveIntersect2(types3,options)}function Intersect3(types3,options){if(types3.length===1)return CreateType2(types3[0],options);if(types3.length===0)return Never2(options);if(types3.some((schema)=>IsTransform3(schema)))throw new Error("Cannot intersect transform types");return IntersectCreate2(types3,options)}function Ref2(...args){let[$ref,options]=typeof args[0]==="string"?[args[0],args[1]]:[args[0].$id,args[1]];if(typeof $ref!=="string")throw new TypeBoxError2("Ref: $ref must be a string");return CreateType2({[Kind2]:"Ref",$ref},options)}function FromComputed6(target,parameters){return Computed2("Awaited",[Computed2(target,parameters)])}function FromRef15($ref){return Computed2("Awaited",[Ref2($ref)])}function FromIntersect22(types3){return Intersect3(FromRest32(types3))}function FromUnion42(types3){return Union3(FromRest32(types3))}function FromPromise8(type2){return Awaited2(type2)}function FromRest32(types3){return types3.map((type2)=>Awaited2(type2))}function Awaited2(type2,options){return CreateType2(IsComputed3(type2)?FromComputed6(type2.target,type2.parameters):IsIntersect3(type2)?FromIntersect22(type2.allOf):IsUnion3(type2)?FromUnion42(type2.anyOf):IsPromise4(type2)?FromPromise8(type2.item):IsRef3(type2)?FromRef15(type2.$ref):type2,options)}function FromRest42(types3){let result=[];for(let L of types3)result.push(KeyOfPropertyKeys2(L));return result}function FromIntersect32(types3){let propertyKeysArray=FromRest42(types3);return SetUnionMany2(propertyKeysArray)}function FromUnion52(types3){let propertyKeysArray=FromRest42(types3);return SetIntersectMany2(propertyKeysArray)}function FromTuple22(types3){return types3.map((_2,indexer)=>indexer.toString())}function FromArray22(_2){return["[number]"]}function FromProperties52(T2){return globalThis.Object.getOwnPropertyNames(T2)}function FromPatternProperties2(patternProperties){if(!includePatternProperties2)return[];return globalThis.Object.getOwnPropertyNames(patternProperties).map((key)=>{return key[0]==="^"&&key[key.length-1]==="$"?key.slice(1,key.length-1):key})}function KeyOfPropertyKeys2(type2){return IsIntersect3(type2)?FromIntersect32(type2.allOf):IsUnion3(type2)?FromUnion52(type2.anyOf):IsTuple3(type2)?FromTuple22(type2.items??[]):IsArray32(type2)?FromArray22(type2.items):IsObject32(type2)?FromProperties52(type2.properties):IsRecord3(type2)?FromPatternProperties2(type2.patternProperties):[]}var includePatternProperties2=!1;function FromComputed22(target,parameters){return Computed2("KeyOf",[Computed2(target,parameters)])}function FromRef22($ref){return Computed2("KeyOf",[Ref2($ref)])}function KeyOfFromType2(type2,options){let propertyKeys=KeyOfPropertyKeys2(type2),propertyKeyTypes=KeyOfPropertyKeysToRest2(propertyKeys),result=UnionEvaluated2(propertyKeyTypes);return CreateType2(result,options)}function KeyOfPropertyKeysToRest2(propertyKeys){return propertyKeys.map((L)=>L==="[number]"?Number22():Literal2(L))}function KeyOf2(type2,options){return IsComputed3(type2)?FromComputed22(type2.target,type2.parameters):IsRef3(type2)?FromRef22(type2.$ref):IsMappedResult3(type2)?KeyOfFromMappedResult2(type2,options):KeyOfFromType2(type2,options)}function FromProperties62(properties,options){let result={};for(let K2 of globalThis.Object.getOwnPropertyNames(properties))result[K2]=KeyOf2(properties[K2],Clone3(options));return result}function FromMappedResult52(mappedResult,options){return FromProperties62(mappedResult.properties,options)}function KeyOfFromMappedResult2(mappedResult,options){let properties=FromMappedResult52(mappedResult,options);return MappedResult2(properties)}function CompositeKeys2(T2){let Acc=[];for(let L of T2)Acc.push(...KeyOfPropertyKeys2(L));return SetDistinct2(Acc)}function FilterNever2(T2){return T2.filter((L)=>!IsNever3(L))}function CompositeProperty2(T2,K){let Acc=[];for(let L of T2)Acc.push(...IndexFromPropertyKeys2(L,[K]));return FilterNever2(Acc)}function CompositeProperties2(T2,K){let Acc={};for(let L of K)Acc[L]=IntersectEvaluated2(CompositeProperty2(T2,L));return Acc}function Composite2(T2,options){let K=CompositeKeys2(T2),P=CompositeProperties2(T2,K);return Object22(P,options)}function Date22(options){return CreateType2({[Kind2]:"Date",type:"Date"},options)}function Null2(options){return CreateType2({[Kind2]:"Null",type:"null"},options)}function Symbol22(options){return CreateType2({[Kind2]:"Symbol",type:"symbol"},options)}function Undefined2(options){return CreateType2({[Kind2]:"Undefined",type:"undefined"},options)}function Uint8Array22(options){return CreateType2({[Kind2]:"Uint8Array",type:"Uint8Array"},options)}function Unknown2(options){return CreateType2({[Kind2]:"Unknown"},options)}function FromArray32(T2){return T2.map((L)=>FromValue3(L,!1))}function FromProperties72(value){let Acc={};for(let K of globalThis.Object.getOwnPropertyNames(value))Acc[K]=Readonly2(FromValue3(value[K],!1));return Acc}function ConditionalReadonly2(T2,root){return root===!0?T2:Readonly2(T2)}function FromValue3(value,root){return IsAsyncIterator5(value)?ConditionalReadonly2(Any2(),root):IsIterator5(value)?ConditionalReadonly2(Any2(),root):IsArray5(value)?Readonly2(Tuple2(FromArray32(value))):IsUint8Array5(value)?Uint8Array22():IsDate5(value)?Date22():IsObject5(value)?ConditionalReadonly2(Object22(FromProperties72(value)),root):IsFunction5(value)?ConditionalReadonly2(Function3([],Unknown2()),root):IsUndefined5(value)?Undefined2():IsNull5(value)?Null2():IsSymbol5(value)?Symbol22():IsBigInt5(value)?BigInt3():IsNumber5(value)?Literal2(value):IsBoolean5(value)?Literal2(value):IsString5(value)?Literal2(value):Object22({})}function Const2(T2,options){return CreateType2(FromValue3(T2,!0),options)}function ConstructorParameters2(schema,options){return IsConstructor3(schema)?Tuple2(schema.parameters,options):Never2(options)}function Enum2(item,options){if(IsUndefined5(item))throw new Error("Enum undefined or empty");let values1=globalThis.Object.getOwnPropertyNames(item).filter((key)=>isNaN(key)).map((key)=>item[key]),anyOf=[...new Set(values1)].map((value)=>Literal2(value));return Union3(anyOf,{...options,[Hint2]:"Enum"})}var ExtendsResolverError2=class extends TypeBoxError2{},ExtendsResult2;(function(ExtendsResult22){ExtendsResult22[ExtendsResult22.Union=0]="Union",ExtendsResult22[ExtendsResult22.True=1]="True",ExtendsResult22[ExtendsResult22.False=2]="False"})(ExtendsResult2||(ExtendsResult2={}));function IntoBooleanResult2(result){return result===ExtendsResult2.False?result:ExtendsResult2.True}function Throw2(message2){throw new ExtendsResolverError2(message2)}function IsStructuralRight2(right){return type_exports.IsNever(right)||type_exports.IsIntersect(right)||type_exports.IsUnion(right)||type_exports.IsUnknown(right)||type_exports.IsAny(right)}function StructuralRight2(left,right){return type_exports.IsNever(right)?FromNeverRight2(left,right):type_exports.IsIntersect(right)?FromIntersectRight2(left,right):type_exports.IsUnion(right)?FromUnionRight2(left,right):type_exports.IsUnknown(right)?FromUnknownRight2(left,right):type_exports.IsAny(right)?FromAnyRight2(left,right):Throw2("StructuralRight")}function FromAnyRight2(left,right){return ExtendsResult2.True}function FromAny5(left,right){return type_exports.IsIntersect(right)?FromIntersectRight2(left,right):type_exports.IsUnion(right)&&right.anyOf.some((schema)=>type_exports.IsAny(schema)||type_exports.IsUnknown(schema))?ExtendsResult2.True:type_exports.IsUnion(right)?ExtendsResult2.Union:type_exports.IsUnknown(right)?ExtendsResult2.True:type_exports.IsAny(right)?ExtendsResult2.True:ExtendsResult2.Union}function FromArrayRight2(left,right){return type_exports.IsUnknown(left)?ExtendsResult2.False:type_exports.IsAny(left)?ExtendsResult2.Union:type_exports.IsNever(left)?ExtendsResult2.True:ExtendsResult2.False}function FromArray42(left,right){return type_exports.IsObject(right)&&IsObjectArrayLike2(right)?ExtendsResult2.True:IsStructuralRight2(right)?StructuralRight2(left,right):!type_exports.IsArray(right)?ExtendsResult2.False:IntoBooleanResult2(Visit32(left.items,right.items))}function FromAsyncIterator8(left,right){return IsStructuralRight2(right)?StructuralRight2(left,right):!type_exports.IsAsyncIterator(right)?ExtendsResult2.False:IntoBooleanResult2(Visit32(left.items,right.items))}function FromBigInt6(left,right){return IsStructuralRight2(right)?StructuralRight2(left,right):type_exports.IsObject(right)?FromObjectRight2(left,right):type_exports.IsRecord(right)?FromRecordRight2(left,right):type_exports.IsBigInt(right)?ExtendsResult2.True:ExtendsResult2.False}function FromBooleanRight2(left,right){return type_exports.IsLiteralBoolean(left)?ExtendsResult2.True:type_exports.IsBoolean(left)?ExtendsResult2.True:ExtendsResult2.False}function FromBoolean6(left,right){return IsStructuralRight2(right)?StructuralRight2(left,right):type_exports.IsObject(right)?FromObjectRight2(left,right):type_exports.IsRecord(right)?FromRecordRight2(left,right):type_exports.IsBoolean(right)?ExtendsResult2.True:ExtendsResult2.False}function FromConstructor9(left,right){return IsStructuralRight2(right)?StructuralRight2(left,right):type_exports.IsObject(right)?FromObjectRight2(left,right):!type_exports.IsConstructor(right)?ExtendsResult2.False:left.parameters.length>right.parameters.length?ExtendsResult2.False:!left.parameters.every((schema,index2)=>IntoBooleanResult2(Visit32(right.parameters[index2],schema))===ExtendsResult2.True)?ExtendsResult2.False:IntoBooleanResult2(Visit32(left.returns,right.returns))}function FromDate8(left,right){return IsStructuralRight2(right)?StructuralRight2(left,right):type_exports.IsObject(right)?FromObjectRight2(left,right):type_exports.IsRecord(right)?FromRecordRight2(left,right):type_exports.IsDate(right)?ExtendsResult2.True:ExtendsResult2.False}function FromFunction8(left,right){return IsStructuralRight2(right)?StructuralRight2(left,right):type_exports.IsObject(right)?FromObjectRight2(left,right):!type_exports.IsFunction(right)?ExtendsResult2.False:left.parameters.length>right.parameters.length?ExtendsResult2.False:!left.parameters.every((schema,index2)=>IntoBooleanResult2(Visit32(right.parameters[index2],schema))===ExtendsResult2.True)?ExtendsResult2.False:IntoBooleanResult2(Visit32(left.returns,right.returns))}function FromIntegerRight2(left,right){return type_exports.IsLiteral(left)&&value_exports.IsNumber(left.const)?ExtendsResult2.True:type_exports.IsNumber(left)||type_exports.IsInteger(left)?ExtendsResult2.True:ExtendsResult2.False}function FromInteger6(left,right){return type_exports.IsInteger(right)||type_exports.IsNumber(right)?ExtendsResult2.True:IsStructuralRight2(right)?StructuralRight2(left,right):type_exports.IsObject(right)?FromObjectRight2(left,right):type_exports.IsRecord(right)?FromRecordRight2(left,right):ExtendsResult2.False}function FromIntersectRight2(left,right){return right.allOf.every((schema)=>Visit32(left,schema)===ExtendsResult2.True)?ExtendsResult2.True:ExtendsResult2.False}function FromIntersect42(left,right){return left.allOf.some((schema)=>Visit32(schema,right)===ExtendsResult2.True)?ExtendsResult2.True:ExtendsResult2.False}function FromIterator8(left,right){return IsStructuralRight2(right)?StructuralRight2(left,right):!type_exports.IsIterator(right)?ExtendsResult2.False:IntoBooleanResult2(Visit32(left.items,right.items))}function FromLiteral22(left,right){return type_exports.IsLiteral(right)&&right.const===left.const?ExtendsResult2.True:IsStructuralRight2(right)?StructuralRight2(left,right):type_exports.IsObject(right)?FromObjectRight2(left,right):type_exports.IsRecord(right)?FromRecordRight2(left,right):type_exports.IsString(right)?FromStringRight2(left,right):type_exports.IsNumber(right)?FromNumberRight2(left,right):type_exports.IsInteger(right)?FromIntegerRight2(left,right):type_exports.IsBoolean(right)?FromBooleanRight2(left,right):ExtendsResult2.False}function FromNeverRight2(left,right){return ExtendsResult2.False}function FromNever6(left,right){return ExtendsResult2.True}function UnwrapTNot2(schema){let[current,depth]=[schema,0];while(!0){if(!type_exports.IsNot(current))break;current=current.not,depth+=1}return depth%2===0?current:Unknown2()}function FromNot8(left,right){return type_exports.IsNot(left)?Visit32(UnwrapTNot2(left),right):type_exports.IsNot(right)?Visit32(left,UnwrapTNot2(right)):Throw2("Invalid fallthrough for Not")}function FromNull6(left,right){return IsStructuralRight2(right)?StructuralRight2(left,right):type_exports.IsObject(right)?FromObjectRight2(left,right):type_exports.IsRecord(right)?FromRecordRight2(left,right):type_exports.IsNull(right)?ExtendsResult2.True:ExtendsResult2.False}function FromNumberRight2(left,right){return type_exports.IsLiteralNumber(left)?ExtendsResult2.True:type_exports.IsNumber(left)||type_exports.IsInteger(left)?ExtendsResult2.True:ExtendsResult2.False}function FromNumber6(left,right){return IsStructuralRight2(right)?StructuralRight2(left,right):type_exports.IsObject(right)?FromObjectRight2(left,right):type_exports.IsRecord(right)?FromRecordRight2(left,right):type_exports.IsInteger(right)||type_exports.IsNumber(right)?ExtendsResult2.True:ExtendsResult2.False}function IsObjectPropertyCount2(schema,count2){return Object.getOwnPropertyNames(schema.properties).length===count2}function IsObjectStringLike2(schema){return IsObjectArrayLike2(schema)}function IsObjectSymbolLike2(schema){return IsObjectPropertyCount2(schema,0)||IsObjectPropertyCount2(schema,1)&&"description"in schema.properties&&type_exports.IsUnion(schema.properties.description)&&schema.properties.description.anyOf.length===2&&(type_exports.IsString(schema.properties.description.anyOf[0])&&type_exports.IsUndefined(schema.properties.description.anyOf[1])||type_exports.IsString(schema.properties.description.anyOf[1])&&type_exports.IsUndefined(schema.properties.description.anyOf[0]))}function IsObjectNumberLike2(schema){return IsObjectPropertyCount2(schema,0)}function IsObjectBooleanLike2(schema){return IsObjectPropertyCount2(schema,0)}function IsObjectBigIntLike2(schema){return IsObjectPropertyCount2(schema,0)}function IsObjectDateLike2(schema){return IsObjectPropertyCount2(schema,0)}function IsObjectUint8ArrayLike2(schema){return IsObjectArrayLike2(schema)}function IsObjectFunctionLike2(schema){let length=Number22();return IsObjectPropertyCount2(schema,0)||IsObjectPropertyCount2(schema,1)&&"length"in schema.properties&&IntoBooleanResult2(Visit32(schema.properties.length,length))===ExtendsResult2.True}function IsObjectConstructorLike2(schema){return IsObjectPropertyCount2(schema,0)}function IsObjectArrayLike2(schema){let length=Number22();return IsObjectPropertyCount2(schema,0)||IsObjectPropertyCount2(schema,1)&&"length"in schema.properties&&IntoBooleanResult2(Visit32(schema.properties.length,length))===ExtendsResult2.True}function IsObjectPromiseLike2(schema){let then=Function3([Any2()],Any2());return IsObjectPropertyCount2(schema,0)||IsObjectPropertyCount2(schema,1)&&"then"in schema.properties&&IntoBooleanResult2(Visit32(schema.properties.then,then))===ExtendsResult2.True}function Property2(left,right){return Visit32(left,right)===ExtendsResult2.False?ExtendsResult2.False:type_exports.IsOptional(left)&&!type_exports.IsOptional(right)?ExtendsResult2.False:ExtendsResult2.True}function FromObjectRight2(left,right){return type_exports.IsUnknown(left)?ExtendsResult2.False:type_exports.IsAny(left)?ExtendsResult2.Union:type_exports.IsNever(left)||type_exports.IsLiteralString(left)&&IsObjectStringLike2(right)||type_exports.IsLiteralNumber(left)&&IsObjectNumberLike2(right)||type_exports.IsLiteralBoolean(left)&&IsObjectBooleanLike2(right)||type_exports.IsSymbol(left)&&IsObjectSymbolLike2(right)||type_exports.IsBigInt(left)&&IsObjectBigIntLike2(right)||type_exports.IsString(left)&&IsObjectStringLike2(right)||type_exports.IsSymbol(left)&&IsObjectSymbolLike2(right)||type_exports.IsNumber(left)&&IsObjectNumberLike2(right)||type_exports.IsInteger(left)&&IsObjectNumberLike2(right)||type_exports.IsBoolean(left)&&IsObjectBooleanLike2(right)||type_exports.IsUint8Array(left)&&IsObjectUint8ArrayLike2(right)||type_exports.IsDate(left)&&IsObjectDateLike2(right)||type_exports.IsConstructor(left)&&IsObjectConstructorLike2(right)||type_exports.IsFunction(left)&&IsObjectFunctionLike2(right)?ExtendsResult2.True:type_exports.IsRecord(left)&&type_exports.IsString(RecordKey3(left))?(()=>{return right[Hint2]==="Record"?ExtendsResult2.True:ExtendsResult2.False})():type_exports.IsRecord(left)&&type_exports.IsNumber(RecordKey3(left))?(()=>{return IsObjectPropertyCount2(right,0)?ExtendsResult2.True:ExtendsResult2.False})():ExtendsResult2.False}function FromObject19(left,right){return IsStructuralRight2(right)?StructuralRight2(left,right):type_exports.IsRecord(right)?FromRecordRight2(left,right):!type_exports.IsObject(right)?ExtendsResult2.False:(()=>{for(let key of Object.getOwnPropertyNames(right.properties)){if(!(key in left.properties)&&!type_exports.IsOptional(right.properties[key]))return ExtendsResult2.False;if(type_exports.IsOptional(right.properties[key]))return ExtendsResult2.True;if(Property2(left.properties[key],right.properties[key])===ExtendsResult2.False)return ExtendsResult2.False}return ExtendsResult2.True})()}function FromPromise22(left,right){return IsStructuralRight2(right)?StructuralRight2(left,right):type_exports.IsObject(right)&&IsObjectPromiseLike2(right)?ExtendsResult2.True:!type_exports.IsPromise(right)?ExtendsResult2.False:IntoBooleanResult2(Visit32(left.item,right.item))}function RecordKey3(schema){return PatternNumberExact2 in schema.patternProperties?Number22():(PatternStringExact2 in schema.patternProperties)?String3():Throw2("Unknown record key pattern")}function RecordValue3(schema){return PatternNumberExact2 in schema.patternProperties?schema.patternProperties[PatternNumberExact2]:(PatternStringExact2 in schema.patternProperties)?schema.patternProperties[PatternStringExact2]:Throw2("Unable to get record value schema")}function FromRecordRight2(left,right){let[Key,Value]=[RecordKey3(right),RecordValue3(right)];return type_exports.IsLiteralString(left)&&type_exports.IsNumber(Key)&&IntoBooleanResult2(Visit32(left,Value))===ExtendsResult2.True?ExtendsResult2.True:type_exports.IsUint8Array(left)&&type_exports.IsNumber(Key)?Visit32(left,Value):type_exports.IsString(left)&&type_exports.IsNumber(Key)?Visit32(left,Value):type_exports.IsArray(left)&&type_exports.IsNumber(Key)?Visit32(left,Value):type_exports.IsObject(left)?(()=>{for(let key of Object.getOwnPropertyNames(left.properties))if(Property2(Value,left.properties[key])===ExtendsResult2.False)return ExtendsResult2.False;return ExtendsResult2.True})():ExtendsResult2.False}function FromRecord14(left,right){return IsStructuralRight2(right)?StructuralRight2(left,right):type_exports.IsObject(right)?FromObjectRight2(left,right):!type_exports.IsRecord(right)?ExtendsResult2.False:Visit32(RecordValue3(left),RecordValue3(right))}function FromRegExp5(left,right){let L=type_exports.IsRegExp(left)?String3():left,R=type_exports.IsRegExp(right)?String3():right;return Visit32(L,R)}function FromStringRight2(left,right){return type_exports.IsLiteral(left)&&value_exports.IsString(left.const)?ExtendsResult2.True:type_exports.IsString(left)?ExtendsResult2.True:ExtendsResult2.False}function FromString6(left,right){return IsStructuralRight2(right)?StructuralRight2(left,right):type_exports.IsObject(right)?FromObjectRight2(left,right):type_exports.IsRecord(right)?FromRecordRight2(left,right):type_exports.IsString(right)?ExtendsResult2.True:ExtendsResult2.False}function FromSymbol6(left,right){return IsStructuralRight2(right)?StructuralRight2(left,right):type_exports.IsObject(right)?FromObjectRight2(left,right):type_exports.IsRecord(right)?FromRecordRight2(left,right):type_exports.IsSymbol(right)?ExtendsResult2.True:ExtendsResult2.False}function FromTemplateLiteral22(left,right){return type_exports.IsTemplateLiteral(left)?Visit32(TemplateLiteralToUnion2(left),right):type_exports.IsTemplateLiteral(right)?Visit32(left,TemplateLiteralToUnion2(right)):Throw2("Invalid fallthrough for TemplateLiteral")}function IsArrayOfTuple2(left,right){return type_exports.IsArray(right)&&left.items!==void 0&&left.items.every((schema)=>Visit32(schema,right.items)===ExtendsResult2.True)}function FromTupleRight2(left,right){return type_exports.IsNever(left)?ExtendsResult2.True:type_exports.IsUnknown(left)?ExtendsResult2.False:type_exports.IsAny(left)?ExtendsResult2.Union:ExtendsResult2.False}function FromTuple32(left,right){return IsStructuralRight2(right)?StructuralRight2(left,right):type_exports.IsObject(right)&&IsObjectArrayLike2(right)?ExtendsResult2.True:type_exports.IsArray(right)&&IsArrayOfTuple2(left,right)?ExtendsResult2.True:!type_exports.IsTuple(right)?ExtendsResult2.False:value_exports.IsUndefined(left.items)&&!value_exports.IsUndefined(right.items)||!value_exports.IsUndefined(left.items)&&value_exports.IsUndefined(right.items)?ExtendsResult2.False:value_exports.IsUndefined(left.items)&&!value_exports.IsUndefined(right.items)?ExtendsResult2.True:left.items.every((schema,index2)=>Visit32(schema,right.items[index2])===ExtendsResult2.True)?ExtendsResult2.True:ExtendsResult2.False}function FromUint8Array5(left,right){return IsStructuralRight2(right)?StructuralRight2(left,right):type_exports.IsObject(right)?FromObjectRight2(left,right):type_exports.IsRecord(right)?FromRecordRight2(left,right):type_exports.IsUint8Array(right)?ExtendsResult2.True:ExtendsResult2.False}function FromUndefined6(left,right){return IsStructuralRight2(right)?StructuralRight2(left,right):type_exports.IsObject(right)?FromObjectRight2(left,right):type_exports.IsRecord(right)?FromRecordRight2(left,right):type_exports.IsVoid(right)?FromVoidRight2(left,right):type_exports.IsUndefined(right)?ExtendsResult2.True:ExtendsResult2.False}function FromUnionRight2(left,right){return right.anyOf.some((schema)=>Visit32(left,schema)===ExtendsResult2.True)?ExtendsResult2.True:ExtendsResult2.False}function FromUnion62(left,right){return left.anyOf.every((schema)=>Visit32(schema,right)===ExtendsResult2.True)?ExtendsResult2.True:ExtendsResult2.False}function FromUnknownRight2(left,right){return ExtendsResult2.True}function FromUnknown5(left,right){return type_exports.IsNever(right)?FromNeverRight2(left,right):type_exports.IsIntersect(right)?FromIntersectRight2(left,right):type_exports.IsUnion(right)?FromUnionRight2(left,right):type_exports.IsAny(right)?FromAnyRight2(left,right):type_exports.IsString(right)?FromStringRight2(left,right):type_exports.IsNumber(right)?FromNumberRight2(left,right):type_exports.IsInteger(right)?FromIntegerRight2(left,right):type_exports.IsBoolean(right)?FromBooleanRight2(left,right):type_exports.IsArray(right)?FromArrayRight2(left,right):type_exports.IsTuple(right)?FromTupleRight2(left,right):type_exports.IsObject(right)?FromObjectRight2(left,right):type_exports.IsUnknown(right)?ExtendsResult2.True:ExtendsResult2.False}function FromVoidRight2(left,right){return type_exports.IsUndefined(left)?ExtendsResult2.True:type_exports.IsUndefined(left)?ExtendsResult2.True:ExtendsResult2.False}function FromVoid5(left,right){return type_exports.IsIntersect(right)?FromIntersectRight2(left,right):type_exports.IsUnion(right)?FromUnionRight2(left,right):type_exports.IsUnknown(right)?FromUnknownRight2(left,right):type_exports.IsAny(right)?FromAnyRight2(left,right):type_exports.IsObject(right)?FromObjectRight2(left,right):type_exports.IsVoid(right)?ExtendsResult2.True:ExtendsResult2.False}function Visit32(left,right){return type_exports.IsTemplateLiteral(left)||type_exports.IsTemplateLiteral(right)?FromTemplateLiteral22(left,right):type_exports.IsRegExp(left)||type_exports.IsRegExp(right)?FromRegExp5(left,right):type_exports.IsNot(left)||type_exports.IsNot(right)?FromNot8(left,right):type_exports.IsAny(left)?FromAny5(left,right):type_exports.IsArray(left)?FromArray42(left,right):type_exports.IsBigInt(left)?FromBigInt6(left,right):type_exports.IsBoolean(left)?FromBoolean6(left,right):type_exports.IsAsyncIterator(left)?FromAsyncIterator8(left,right):type_exports.IsConstructor(left)?FromConstructor9(left,right):type_exports.IsDate(left)?FromDate8(left,right):type_exports.IsFunction(left)?FromFunction8(left,right):type_exports.IsInteger(left)?FromInteger6(left,right):type_exports.IsIntersect(left)?FromIntersect42(left,right):type_exports.IsIterator(left)?FromIterator8(left,right):type_exports.IsLiteral(left)?FromLiteral22(left,right):type_exports.IsNever(left)?FromNever6(left,right):type_exports.IsNull(left)?FromNull6(left,right):type_exports.IsNumber(left)?FromNumber6(left,right):type_exports.IsObject(left)?FromObject19(left,right):type_exports.IsRecord(left)?FromRecord14(left,right):type_exports.IsString(left)?FromString6(left,right):type_exports.IsSymbol(left)?FromSymbol6(left,right):type_exports.IsTuple(left)?FromTuple32(left,right):type_exports.IsPromise(left)?FromPromise22(left,right):type_exports.IsUint8Array(left)?FromUint8Array5(left,right):type_exports.IsUndefined(left)?FromUndefined6(left,right):type_exports.IsUnion(left)?FromUnion62(left,right):type_exports.IsUnknown(left)?FromUnknown5(left,right):type_exports.IsVoid(left)?FromVoid5(left,right):Throw2(`Unknown left type operand '${left[Kind2]}'`)}function ExtendsCheck2(left,right){return Visit32(left,right)}function FromProperties82(P,Right,True,False,options){let Acc={};for(let K2 of globalThis.Object.getOwnPropertyNames(P))Acc[K2]=Extends2(P[K2],Right,True,False,Clone3(options));return Acc}function FromMappedResult62(Left,Right,True,False,options){return FromProperties82(Left.properties,Right,True,False,options)}function ExtendsFromMappedResult2(Left,Right,True,False,options){let P=FromMappedResult62(Left,Right,True,False,options);return MappedResult2(P)}function ExtendsResolve2(left,right,trueType,falseType){let R=ExtendsCheck2(left,right);return R===ExtendsResult2.Union?Union3([trueType,falseType]):R===ExtendsResult2.True?trueType:falseType}function Extends2(L,R,T2,F,options){return IsMappedResult3(L)?ExtendsFromMappedResult2(L,R,T2,F,options):IsMappedKey3(L)?CreateType2(ExtendsFromMappedKey2(L,R,T2,F,options)):CreateType2(ExtendsResolve2(L,R,T2,F),options)}function FromPropertyKey4(K,U,L,R,options){return{[K]:Extends2(Literal2(K),U,L,R,Clone3(options))}}function FromPropertyKeys4(K,U,L,R,options){return K.reduce((Acc,LK)=>{return{...Acc,...FromPropertyKey4(LK,U,L,R,options)}},{})}function FromMappedKey22(K,U,L,R,options){return FromPropertyKeys4(K.keys,U,L,R,options)}function ExtendsFromMappedKey2(T2,U,L,R,options){let P=FromMappedKey22(T2,U,L,R,options);return MappedResult2(P)}function ExcludeFromTemplateLiteral2(L,R){return Exclude2(TemplateLiteralToUnion2(L),R)}function ExcludeRest2(L,R){let excluded=L.filter((inner)=>ExtendsCheck2(inner,R)===ExtendsResult2.False);return excluded.length===1?excluded[0]:Union3(excluded)}function Exclude2(L,R,options={}){if(IsTemplateLiteral3(L))return CreateType2(ExcludeFromTemplateLiteral2(L,R),options);if(IsMappedResult3(L))return CreateType2(ExcludeFromMappedResult2(L,R),options);return CreateType2(IsUnion3(L)?ExcludeRest2(L.anyOf,R):ExtendsCheck2(L,R)!==ExtendsResult2.False?Never2():L,options)}function FromProperties92(P,U){let Acc={};for(let K2 of globalThis.Object.getOwnPropertyNames(P))Acc[K2]=Exclude2(P[K2],U);return Acc}function FromMappedResult72(R,T2){return FromProperties92(R.properties,T2)}function ExcludeFromMappedResult2(R,T2){let P=FromMappedResult72(R,T2);return MappedResult2(P)}function ExtractFromTemplateLiteral2(L,R){return Extract2(TemplateLiteralToUnion2(L),R)}function ExtractRest2(L,R){let extracted=L.filter((inner)=>ExtendsCheck2(inner,R)!==ExtendsResult2.False);return extracted.length===1?extracted[0]:Union3(extracted)}function Extract2(L,R,options){if(IsTemplateLiteral3(L))return CreateType2(ExtractFromTemplateLiteral2(L,R),options);if(IsMappedResult3(L))return CreateType2(ExtractFromMappedResult2(L,R),options);return CreateType2(IsUnion3(L)?ExtractRest2(L.anyOf,R):ExtendsCheck2(L,R)!==ExtendsResult2.False?L:Never2(),options)}function FromProperties102(P,T2){let Acc={};for(let K2 of globalThis.Object.getOwnPropertyNames(P))Acc[K2]=Extract2(P[K2],T2);return Acc}function FromMappedResult82(R,T2){return FromProperties102(R.properties,T2)}function ExtractFromMappedResult2(R,T2){let P=FromMappedResult82(R,T2);return MappedResult2(P)}function InstanceType2(schema,options){return IsConstructor3(schema)?CreateType2(schema.returns,options):Never2(options)}function ReadonlyOptional2(schema){return Readonly2(Optional2(schema))}function RecordCreateFromPattern2(pattern,T2,options){return CreateType2({[Kind2]:"Record",type:"object",patternProperties:{[pattern]:T2}},options)}function RecordCreateFromKeys2(K,T2,options){let result={};for(let K2 of K)result[K2]=T2;return Object22(result,{...options,[Hint2]:"Record"})}function FromTemplateLiteralKey2(K,T2,options){return IsTemplateLiteralFinite2(K)?RecordCreateFromKeys2(IndexPropertyKeys2(K),T2,options):RecordCreateFromPattern2(K.pattern,T2,options)}function FromUnionKey2(key,type2,options){return RecordCreateFromKeys2(IndexPropertyKeys2(Union3(key)),type2,options)}function FromLiteralKey2(key,type2,options){return RecordCreateFromKeys2([key.toString()],type2,options)}function FromRegExpKey2(key,type2,options){return RecordCreateFromPattern2(key.source,type2,options)}function FromStringKey2(key,type2,options){let pattern=IsUndefined5(key.pattern)?PatternStringExact2:key.pattern;return RecordCreateFromPattern2(pattern,type2,options)}function FromAnyKey2(_2,type2,options){return RecordCreateFromPattern2(PatternStringExact2,type2,options)}function FromNeverKey2(_key,type2,options){return RecordCreateFromPattern2(PatternNeverExact2,type2,options)}function FromBooleanKey2(_key,type2,options){return Object22({true:type2,false:type2},options)}function FromIntegerKey2(_key,type2,options){return RecordCreateFromPattern2(PatternNumberExact2,type2,options)}function FromNumberKey2(_2,type2,options){return RecordCreateFromPattern2(PatternNumberExact2,type2,options)}function Record2(key,type2,options={}){return IsUnion3(key)?FromUnionKey2(key.anyOf,type2,options):IsTemplateLiteral3(key)?FromTemplateLiteralKey2(key,type2,options):IsLiteral3(key)?FromLiteralKey2(key.const,type2,options):IsBoolean22(key)?FromBooleanKey2(key,type2,options):IsInteger4(key)?FromIntegerKey2(key,type2,options):IsNumber32(key)?FromNumberKey2(key,type2,options):IsRegExp22(key)?FromRegExpKey2(key,type2,options):IsString22(key)?FromStringKey2(key,type2,options):IsAny3(key)?FromAnyKey2(key,type2,options):IsNever3(key)?FromNeverKey2(key,type2,options):Never2(options)}function RecordPattern2(record){return globalThis.Object.getOwnPropertyNames(record.patternProperties)[0]}function RecordKey22(type2){let pattern=RecordPattern2(type2);return pattern===PatternStringExact2?String3():pattern===PatternNumberExact2?Number22():String3({pattern})}function RecordValue22(type2){return type2.patternProperties[RecordPattern2(type2)]}function FromConstructor22(args,type2){return type2.parameters=FromTypes3(args,type2.parameters),type2.returns=FromType3(args,type2.returns),type2}function FromFunction22(args,type2){return type2.parameters=FromTypes3(args,type2.parameters),type2.returns=FromType3(args,type2.returns),type2}function FromIntersect52(args,type2){return type2.allOf=FromTypes3(args,type2.allOf),type2}function FromUnion72(args,type2){return type2.anyOf=FromTypes3(args,type2.anyOf),type2}function FromTuple42(args,type2){if(IsUndefined5(type2.items))return type2;return type2.items=FromTypes3(args,type2.items),type2}function FromArray52(args,type2){return type2.items=FromType3(args,type2.items),type2}function FromAsyncIterator22(args,type2){return type2.items=FromType3(args,type2.items),type2}function FromIterator22(args,type2){return type2.items=FromType3(args,type2.items),type2}function FromPromise32(args,type2){return type2.item=FromType3(args,type2.item),type2}function FromObject22(args,type2){let mappedProperties=FromProperties112(args,type2.properties);return{...type2,...Object22(mappedProperties)}}function FromRecord22(args,type2){let mappedKey=FromType3(args,RecordKey22(type2)),mappedValue=FromType3(args,RecordValue22(type2)),result=Record2(mappedKey,mappedValue);return{...type2,...result}}function FromArgument5(args,argument){return argument.index in args?args[argument.index]:Unknown2()}function FromProperty22(args,type2){let isReadonly=IsReadonly3(type2),isOptional2=IsOptional3(type2),mapped=FromType3(args,type2);return isReadonly&&isOptional2?ReadonlyOptional2(mapped):isReadonly&&!isOptional2?Readonly2(mapped):!isReadonly&&isOptional2?Optional2(mapped):mapped}function FromProperties112(args,properties){return globalThis.Object.getOwnPropertyNames(properties).reduce((result,key)=>{return{...result,[key]:FromProperty22(args,properties[key])}},{})}function FromTypes3(args,types3){return types3.map((type2)=>FromType3(args,type2))}function FromType3(args,type2){return IsConstructor3(type2)?FromConstructor22(args,type2):IsFunction22(type2)?FromFunction22(args,type2):IsIntersect3(type2)?FromIntersect52(args,type2):IsUnion3(type2)?FromUnion72(args,type2):IsTuple3(type2)?FromTuple42(args,type2):IsArray32(type2)?FromArray52(args,type2):IsAsyncIterator22(type2)?FromAsyncIterator22(args,type2):IsIterator22(type2)?FromIterator22(args,type2):IsPromise4(type2)?FromPromise32(args,type2):IsObject32(type2)?FromObject22(args,type2):IsRecord3(type2)?FromRecord22(args,type2):IsArgument3(type2)?FromArgument5(args,type2):type2}function Instantiate2(type2,args){return FromType3(args,CloneType2(type2))}function Integer2(options){return CreateType2({[Kind2]:"Integer",type:"integer"},options)}function MappedIntrinsicPropertyKey2(K,M,options){return{[K]:Intrinsic2(Literal2(K),M,Clone3(options))}}function MappedIntrinsicPropertyKeys2(K,M,options){return K.reduce((Acc,L)=>{return{...Acc,...MappedIntrinsicPropertyKey2(L,M,options)}},{})}function MappedIntrinsicProperties2(T2,M,options){return MappedIntrinsicPropertyKeys2(T2.keys,M,options)}function IntrinsicFromMappedKey2(T2,M,options){let P=MappedIntrinsicProperties2(T2,M,options);return MappedResult2(P)}function ApplyUncapitalize2(value){let[first,rest]=[value.slice(0,1),value.slice(1)];return[first.toLowerCase(),rest].join("")}function ApplyCapitalize2(value){let[first,rest]=[value.slice(0,1),value.slice(1)];return[first.toUpperCase(),rest].join("")}function ApplyUppercase2(value){return value.toUpperCase()}function ApplyLowercase2(value){return value.toLowerCase()}function FromTemplateLiteral32(schema,mode,options){let expression=TemplateLiteralParseExact2(schema.pattern);if(!IsTemplateLiteralExpressionFinite2(expression))return{...schema,pattern:FromLiteralValue2(schema.pattern,mode)};let literals=[...TemplateLiteralExpressionGenerate2(expression)].map((value)=>Literal2(value)),mapped=FromRest52(literals,mode),union2=Union3(mapped);return TemplateLiteral2([union2],options)}function FromLiteralValue2(value,mode){return typeof value==="string"?mode==="Uncapitalize"?ApplyUncapitalize2(value):mode==="Capitalize"?ApplyCapitalize2(value):mode==="Uppercase"?ApplyUppercase2(value):mode==="Lowercase"?ApplyLowercase2(value):value:value.toString()}function FromRest52(T2,M){return T2.map((L)=>Intrinsic2(L,M))}function Intrinsic2(schema,mode,options={}){return IsMappedKey3(schema)?IntrinsicFromMappedKey2(schema,mode,options):IsTemplateLiteral3(schema)?FromTemplateLiteral32(schema,mode,options):IsUnion3(schema)?Union3(FromRest52(schema.anyOf,mode),options):IsLiteral3(schema)?Literal2(FromLiteralValue2(schema.const,mode),options):CreateType2(schema,options)}function Capitalize2(T2,options={}){return Intrinsic2(T2,"Capitalize",options)}function Lowercase2(T2,options={}){return Intrinsic2(T2,"Lowercase",options)}function Uncapitalize2(T2,options={}){return Intrinsic2(T2,"Uncapitalize",options)}function Uppercase2(T2,options={}){return Intrinsic2(T2,"Uppercase",options)}function FromProperties122(properties,propertyKeys,options){let result={};for(let K2 of globalThis.Object.getOwnPropertyNames(properties))result[K2]=Omit2(properties[K2],propertyKeys,Clone3(options));return result}function FromMappedResult92(mappedResult,propertyKeys,options){return FromProperties122(mappedResult.properties,propertyKeys,options)}function OmitFromMappedResult2(mappedResult,propertyKeys,options){let properties=FromMappedResult92(mappedResult,propertyKeys,options);return MappedResult2(properties)}function FromIntersect62(types3,propertyKeys){return types3.map((type2)=>OmitResolve2(type2,propertyKeys))}function FromUnion82(types3,propertyKeys){return types3.map((type2)=>OmitResolve2(type2,propertyKeys))}function FromProperty32(properties,key){let{[key]:_2,...R}=properties;return R}function FromProperties132(properties,propertyKeys){return propertyKeys.reduce((T2,K2)=>FromProperty32(T2,K2),properties)}function FromObject32(properties,propertyKeys){let options=Discard2(properties,[TransformKind2,"$id","required","properties"]),omittedProperties=FromProperties132(properties.properties,propertyKeys);return Object22(omittedProperties,options)}function UnionFromPropertyKeys3(propertyKeys){let result=propertyKeys.reduce((result2,key)=>IsLiteralValue3(key)?[...result2,Literal2(key)]:result2,[]);return Union3(result)}function OmitResolve2(properties,propertyKeys){return IsIntersect3(properties)?Intersect3(FromIntersect62(properties.allOf,propertyKeys)):IsUnion3(properties)?Union3(FromUnion82(properties.anyOf,propertyKeys)):IsObject32(properties)?FromObject32(properties,propertyKeys):Object22({})}function Omit2(type2,key,options){let typeKey=IsArray5(key)?UnionFromPropertyKeys3(key):key,propertyKeys=IsSchema3(key)?IndexPropertyKeys2(key):key,isTypeRef=IsRef3(type2),isKeyRef=IsRef3(key);return IsMappedResult3(type2)?OmitFromMappedResult2(type2,propertyKeys,options):IsMappedKey3(key)?OmitFromMappedKey2(type2,key,options):isTypeRef&&isKeyRef?Computed2("Omit",[type2,typeKey],options):!isTypeRef&&isKeyRef?Computed2("Omit",[type2,typeKey],options):isTypeRef&&!isKeyRef?Computed2("Omit",[type2,typeKey],options):CreateType2({...OmitResolve2(type2,propertyKeys),...options})}function FromPropertyKey22(type2,key,options){return{[key]:Omit2(type2,[key],Clone3(options))}}function FromPropertyKeys22(type2,propertyKeys,options){return propertyKeys.reduce((Acc,LK)=>{return{...Acc,...FromPropertyKey22(type2,LK,options)}},{})}function FromMappedKey32(type2,mappedKey,options){return FromPropertyKeys22(type2,mappedKey.keys,options)}function OmitFromMappedKey2(type2,mappedKey,options){let properties=FromMappedKey32(type2,mappedKey,options);return MappedResult2(properties)}function FromProperties142(properties,propertyKeys,options){let result={};for(let K2 of globalThis.Object.getOwnPropertyNames(properties))result[K2]=Pick2(properties[K2],propertyKeys,Clone3(options));return result}function FromMappedResult102(mappedResult,propertyKeys,options){return FromProperties142(mappedResult.properties,propertyKeys,options)}function PickFromMappedResult2(mappedResult,propertyKeys,options){let properties=FromMappedResult102(mappedResult,propertyKeys,options);return MappedResult2(properties)}function FromIntersect72(types3,propertyKeys){return types3.map((type2)=>PickResolve2(type2,propertyKeys))}function FromUnion92(types3,propertyKeys){return types3.map((type2)=>PickResolve2(type2,propertyKeys))}function FromProperties152(properties,propertyKeys){let result={};for(let K2 of propertyKeys)if(K2 in properties)result[K2]=properties[K2];return result}function FromObject42(T2,K){let options=Discard2(T2,[TransformKind2,"$id","required","properties"]),properties=FromProperties152(T2.properties,K);return Object22(properties,options)}function UnionFromPropertyKeys22(propertyKeys){let result=propertyKeys.reduce((result2,key)=>IsLiteralValue3(key)?[...result2,Literal2(key)]:result2,[]);return Union3(result)}function PickResolve2(properties,propertyKeys){return IsIntersect3(properties)?Intersect3(FromIntersect72(properties.allOf,propertyKeys)):IsUnion3(properties)?Union3(FromUnion92(properties.anyOf,propertyKeys)):IsObject32(properties)?FromObject42(properties,propertyKeys):Object22({})}function Pick2(type2,key,options){let typeKey=IsArray5(key)?UnionFromPropertyKeys22(key):key,propertyKeys=IsSchema3(key)?IndexPropertyKeys2(key):key,isTypeRef=IsRef3(type2),isKeyRef=IsRef3(key);return IsMappedResult3(type2)?PickFromMappedResult2(type2,propertyKeys,options):IsMappedKey3(key)?PickFromMappedKey2(type2,key,options):isTypeRef&&isKeyRef?Computed2("Pick",[type2,typeKey],options):!isTypeRef&&isKeyRef?Computed2("Pick",[type2,typeKey],options):isTypeRef&&!isKeyRef?Computed2("Pick",[type2,typeKey],options):CreateType2({...PickResolve2(type2,propertyKeys),...options})}function FromPropertyKey32(type2,key,options){return{[key]:Pick2(type2,[key],Clone3(options))}}function FromPropertyKeys32(type2,propertyKeys,options){return propertyKeys.reduce((result,leftKey)=>{return{...result,...FromPropertyKey32(type2,leftKey,options)}},{})}function FromMappedKey42(type2,mappedKey,options){return FromPropertyKeys32(type2,mappedKey.keys,options)}function PickFromMappedKey2(type2,mappedKey,options){let properties=FromMappedKey42(type2,mappedKey,options);return MappedResult2(properties)}function FromComputed32(target,parameters){return Computed2("Partial",[Computed2(target,parameters)])}function FromRef32($ref){return Computed2("Partial",[Ref2($ref)])}function FromProperties162(properties){let partialProperties={};for(let K of globalThis.Object.getOwnPropertyNames(properties))partialProperties[K]=Optional2(properties[K]);return partialProperties}function FromObject52(type2){let options=Discard2(type2,[TransformKind2,"$id","required","properties"]),properties=FromProperties162(type2.properties);return Object22(properties,options)}function FromRest62(types3){return types3.map((type2)=>PartialResolve2(type2))}function PartialResolve2(type2){return IsComputed3(type2)?FromComputed32(type2.target,type2.parameters):IsRef3(type2)?FromRef32(type2.$ref):IsIntersect3(type2)?Intersect3(FromRest62(type2.allOf)):IsUnion3(type2)?Union3(FromRest62(type2.anyOf)):IsObject32(type2)?FromObject52(type2):IsBigInt22(type2)?type2:IsBoolean22(type2)?type2:IsInteger4(type2)?type2:IsLiteral3(type2)?type2:IsNull22(type2)?type2:IsNumber32(type2)?type2:IsString22(type2)?type2:IsSymbol22(type2)?type2:IsUndefined32(type2)?type2:Object22({})}function Partial2(type2,options){if(IsMappedResult3(type2))return PartialFromMappedResult2(type2,options);else return CreateType2({...PartialResolve2(type2),...options})}function FromProperties172(K,options){let Acc={};for(let K2 of globalThis.Object.getOwnPropertyNames(K))Acc[K2]=Partial2(K[K2],Clone3(options));return Acc}function FromMappedResult112(R,options){return FromProperties172(R.properties,options)}function PartialFromMappedResult2(R,options){let P=FromMappedResult112(R,options);return MappedResult2(P)}function FromComputed42(target,parameters){return Computed2("Required",[Computed2(target,parameters)])}function FromRef42($ref){return Computed2("Required",[Ref2($ref)])}function FromProperties182(properties){let requiredProperties={};for(let K of globalThis.Object.getOwnPropertyNames(properties))requiredProperties[K]=Discard2(properties[K],[OptionalKind2]);return requiredProperties}function FromObject62(type2){let options=Discard2(type2,[TransformKind2,"$id","required","properties"]),properties=FromProperties182(type2.properties);return Object22(properties,options)}function FromRest72(types3){return types3.map((type2)=>RequiredResolve2(type2))}function RequiredResolve2(type2){return IsComputed3(type2)?FromComputed42(type2.target,type2.parameters):IsRef3(type2)?FromRef42(type2.$ref):IsIntersect3(type2)?Intersect3(FromRest72(type2.allOf)):IsUnion3(type2)?Union3(FromRest72(type2.anyOf)):IsObject32(type2)?FromObject62(type2):IsBigInt22(type2)?type2:IsBoolean22(type2)?type2:IsInteger4(type2)?type2:IsLiteral3(type2)?type2:IsNull22(type2)?type2:IsNumber32(type2)?type2:IsString22(type2)?type2:IsSymbol22(type2)?type2:IsUndefined32(type2)?type2:Object22({})}function Required2(type2,options){if(IsMappedResult3(type2))return RequiredFromMappedResult2(type2,options);else return CreateType2({...RequiredResolve2(type2),...options})}function FromProperties192(P,options){let Acc={};for(let K2 of globalThis.Object.getOwnPropertyNames(P))Acc[K2]=Required2(P[K2],options);return Acc}function FromMappedResult122(R,options){return FromProperties192(R.properties,options)}function RequiredFromMappedResult2(R,options){let P=FromMappedResult122(R,options);return MappedResult2(P)}function DereferenceParameters2(moduleProperties,types3){return types3.map((type2)=>{return IsRef3(type2)?Dereference2(moduleProperties,type2.$ref):FromType22(moduleProperties,type2)})}function Dereference2(moduleProperties,ref){return ref in moduleProperties?IsRef3(moduleProperties[ref])?Dereference2(moduleProperties,moduleProperties[ref].$ref):FromType22(moduleProperties,moduleProperties[ref]):Never2()}function FromAwaited2(parameters){return Awaited2(parameters[0])}function FromIndex2(parameters){return Index3(parameters[0],parameters[1])}function FromKeyOf2(parameters){return KeyOf2(parameters[0])}function FromPartial2(parameters){return Partial2(parameters[0])}function FromOmit2(parameters){return Omit2(parameters[0],parameters[1])}function FromPick2(parameters){return Pick2(parameters[0],parameters[1])}function FromRequired2(parameters){return Required2(parameters[0])}function FromComputed52(moduleProperties,target,parameters){let dereferenced=DereferenceParameters2(moduleProperties,parameters);return target==="Awaited"?FromAwaited2(dereferenced):target==="Index"?FromIndex2(dereferenced):target==="KeyOf"?FromKeyOf2(dereferenced):target==="Partial"?FromPartial2(dereferenced):target==="Omit"?FromOmit2(dereferenced):target==="Pick"?FromPick2(dereferenced):target==="Required"?FromRequired2(dereferenced):Never2()}function FromArray62(moduleProperties,type2){return Array22(FromType22(moduleProperties,type2))}function FromAsyncIterator32(moduleProperties,type2){return AsyncIterator2(FromType22(moduleProperties,type2))}function FromConstructor32(moduleProperties,parameters,instanceType){return Constructor2(FromTypes22(moduleProperties,parameters),FromType22(moduleProperties,instanceType))}function FromFunction32(moduleProperties,parameters,returnType){return Function3(FromTypes22(moduleProperties,parameters),FromType22(moduleProperties,returnType))}function FromIntersect82(moduleProperties,types3){return Intersect3(FromTypes22(moduleProperties,types3))}function FromIterator32(moduleProperties,type2){return Iterator2(FromType22(moduleProperties,type2))}function FromObject72(moduleProperties,properties){return Object22(globalThis.Object.keys(properties).reduce((result,key)=>{return{...result,[key]:FromType22(moduleProperties,properties[key])}},{}))}function FromRecord32(moduleProperties,type2){let[value,pattern]=[FromType22(moduleProperties,RecordValue22(type2)),RecordPattern2(type2)],result=CloneType2(type2);return result.patternProperties[pattern]=value,result}function FromTransform2(moduleProperties,transform2){return IsRef3(transform2)?{...Dereference2(moduleProperties,transform2.$ref),[TransformKind2]:transform2[TransformKind2]}:transform2}function FromTuple52(moduleProperties,types3){return Tuple2(FromTypes22(moduleProperties,types3))}function FromUnion102(moduleProperties,types3){return Union3(FromTypes22(moduleProperties,types3))}function FromTypes22(moduleProperties,types3){return types3.map((type2)=>FromType22(moduleProperties,type2))}function FromType22(moduleProperties,type2){return IsOptional3(type2)?CreateType2(FromType22(moduleProperties,Discard2(type2,[OptionalKind2])),type2):IsReadonly3(type2)?CreateType2(FromType22(moduleProperties,Discard2(type2,[ReadonlyKind2])),type2):IsTransform3(type2)?CreateType2(FromTransform2(moduleProperties,type2),type2):IsArray32(type2)?CreateType2(FromArray62(moduleProperties,type2.items),type2):IsAsyncIterator22(type2)?CreateType2(FromAsyncIterator32(moduleProperties,type2.items),type2):IsComputed3(type2)?CreateType2(FromComputed52(moduleProperties,type2.target,type2.parameters)):IsConstructor3(type2)?CreateType2(FromConstructor32(moduleProperties,type2.parameters,type2.returns),type2):IsFunction22(type2)?CreateType2(FromFunction32(moduleProperties,type2.parameters,type2.returns),type2):IsIntersect3(type2)?CreateType2(FromIntersect82(moduleProperties,type2.allOf),type2):IsIterator22(type2)?CreateType2(FromIterator32(moduleProperties,type2.items),type2):IsObject32(type2)?CreateType2(FromObject72(moduleProperties,type2.properties),type2):IsRecord3(type2)?CreateType2(FromRecord32(moduleProperties,type2)):IsTuple3(type2)?CreateType2(FromTuple52(moduleProperties,type2.items||[]),type2):IsUnion3(type2)?CreateType2(FromUnion102(moduleProperties,type2.anyOf),type2):type2}function ComputeType2(moduleProperties,key){return key in moduleProperties?FromType22(moduleProperties,moduleProperties[key]):Never2()}function ComputeModuleProperties2(moduleProperties){return globalThis.Object.getOwnPropertyNames(moduleProperties).reduce((result,key)=>{return{...result,[key]:ComputeType2(moduleProperties,key)}},{})}var TModule2=class{constructor($defs){let computed=ComputeModuleProperties2($defs),identified=this.WithIdentifiers(computed);this.$defs=identified}Import(key,options){let $defs={...this.$defs,[key]:CreateType2(this.$defs[key],options)};return CreateType2({[Kind2]:"Import",$defs,$ref:key})}WithIdentifiers($defs){return globalThis.Object.getOwnPropertyNames($defs).reduce((result,key)=>{return{...result,[key]:{...$defs[key],$id:key}}},{})}};function Module2(properties){return new TModule2(properties)}function Not3(type2,options){return CreateType2({[Kind2]:"Not",not:type2},options)}function Parameters2(schema,options){return IsFunction22(schema)?Tuple2(schema.parameters,options):Never2()}var Ordinal2=0;function Recursive2(callback,options={}){if(IsUndefined5(options.$id))options.$id=`T${Ordinal2++}`;let thisType=CloneType2(callback({[Kind2]:"This",$ref:`${options.$id}`}));return thisType.$id=options.$id,CreateType2({[Hint2]:"Recursive",...thisType},options)}function RegExp22(unresolved,options){let expr=IsString5(unresolved)?new globalThis.RegExp(unresolved):unresolved;return CreateType2({[Kind2]:"RegExp",type:"RegExp",source:expr.source,flags:expr.flags},options)}function RestResolve2(T2){return IsIntersect3(T2)?T2.allOf:IsUnion3(T2)?T2.anyOf:IsTuple3(T2)?T2.items??[]:[]}function Rest2(T2){return RestResolve2(T2)}function ReturnType2(schema,options){return IsFunction22(schema)?CreateType2(schema.returns,options):Never2(options)}var TransformDecodeBuilder2=class{constructor(schema){this.schema=schema}Decode(decode5){return new TransformEncodeBuilder2(this.schema,decode5)}},TransformEncodeBuilder2=class{constructor(schema,decode5){this.schema=schema,this.decode=decode5}EncodeTransform(encode4,schema){let Codec={Encode:(value)=>schema[TransformKind2].Encode(encode4(value)),Decode:(value)=>this.decode(schema[TransformKind2].Decode(value))};return{...schema,[TransformKind2]:Codec}}EncodeSchema(encode4,schema){let Codec={Decode:this.decode,Encode:encode4};return{...schema,[TransformKind2]:Codec}}Encode(encode4){return IsTransform3(this.schema)?this.EncodeTransform(encode4,this.schema):this.EncodeSchema(encode4,this.schema)}};function Transform2(schema){return new TransformDecodeBuilder2(schema)}function Unsafe2(options={}){return CreateType2({[Kind2]:options[Kind2]??"Unsafe"},options)}function Void2(options){return CreateType2({[Kind2]:"Void",type:"void"},options)}var type_exports2={};__export2(type_exports2,{Any:()=>Any2,Argument:()=>Argument2,Array:()=>Array22,AsyncIterator:()=>AsyncIterator2,Awaited:()=>Awaited2,BigInt:()=>BigInt3,Boolean:()=>Boolean3,Capitalize:()=>Capitalize2,Composite:()=>Composite2,Const:()=>Const2,Constructor:()=>Constructor2,ConstructorParameters:()=>ConstructorParameters2,Date:()=>Date22,Enum:()=>Enum2,Exclude:()=>Exclude2,Extends:()=>Extends2,Extract:()=>Extract2,Function:()=>Function3,Index:()=>Index3,InstanceType:()=>InstanceType2,Instantiate:()=>Instantiate2,Integer:()=>Integer2,Intersect:()=>Intersect3,Iterator:()=>Iterator2,KeyOf:()=>KeyOf2,Literal:()=>Literal2,Lowercase:()=>Lowercase2,Mapped:()=>Mapped2,Module:()=>Module2,Never:()=>Never2,Not:()=>Not3,Null:()=>Null2,Number:()=>Number22,Object:()=>Object22,Omit:()=>Omit2,Optional:()=>Optional2,Parameters:()=>Parameters2,Partial:()=>Partial2,Pick:()=>Pick2,Promise:()=>Promise22,Readonly:()=>Readonly2,ReadonlyOptional:()=>ReadonlyOptional2,Record:()=>Record2,Recursive:()=>Recursive2,Ref:()=>Ref2,RegExp:()=>RegExp22,Required:()=>Required2,Rest:()=>Rest2,ReturnType:()=>ReturnType2,String:()=>String3,Symbol:()=>Symbol22,TemplateLiteral:()=>TemplateLiteral2,Transform:()=>Transform2,Tuple:()=>Tuple2,Uint8Array:()=>Uint8Array22,Uncapitalize:()=>Uncapitalize2,Undefined:()=>Undefined2,Union:()=>Union3,Unknown:()=>Unknown2,Unsafe:()=>Unsafe2,Uppercase:()=>Uppercase2,Void:()=>Void2});var Type2=type_exports2,jwt=({name="jwt",secret,alg="HS256",crit,schema,nbf,exp,...payload})=>{if(!secret)throw new Error("Secret can't be empty");let key=typeof secret==="string"?new TextEncoder().encode(secret):secret,validator=schema?getSchemaValidator(Type2.Intersect([schema,Type2.Object({iss:Type2.Optional(Type2.String()),sub:Type2.Optional(Type2.String()),aud:Type2.Optional(Type2.Union([Type2.String(),Type2.Array(Type2.String())])),jti:Type2.Optional(Type2.String()),nbf:Type2.Optional(Type2.Union([Type2.String(),Type2.Number()])),exp:Type2.Optional(Type2.Union([Type2.String(),Type2.Number()])),iat:Type2.Optional(Type2.String())})]),{modules:Type2.Module({})}):void 0;return new Elysia({name:"@elysiajs/jwt",seed:{name,secret,alg,crit,schema,nbf,exp,...payload}}).decorate(name,{sign(morePayload){let jwt2=new SignJWT({...payload,...morePayload,nbf:void 0,exp:void 0}).setProtectedHeader({alg,crit});if(nbf)jwt2=jwt2.setNotBefore(nbf);if(exp)jwt2=jwt2.setExpirationTime(exp);return jwt2.sign(key)},async verify(jwt2){if(!jwt2)return!1;try{let data=(await jwtVerify(jwt2,key)).payload;if(validator&&!validator.Check(data))throw new ValidationError("JWT",validator,data);return data}catch(_2){return!1}}})},index_default=jwt;var JWT_SECRET=process.env.JWT_TOKEN||"something@#morecomplicated<>es>??><Ess5%",frontendURL=process.env.FRONTEND_URL_DEV,regPlugin=new Elysia().use(dist_default()).use(index_default({name:"jwt",secret:JWT_SECRET})).post("/register",regPost,{body:registerData}).get("/verify-email",async({headers,query,cookie:{auth_token},jwt:jwt2})=>{let token=query.token;if(!token)return{success:!1,message:"Huwezi kusajiliwa bila email na tokeni sahihi"};try{let result=await mainDb.select().from(emailVerifications).where(eq(emailVerifications.token,token));if(result.length===0)return{success:!1,message:"Token sio sahihi, fuata njia ya halali"};if(new Date>result[0].expiresAt)return{success:!1,message:"Token imeisha muda wake"};await mainDb.update(emailVerifications).set({used:!0}).where(eq(emailVerifications.token,token));let user=await mainDb.insert(users).values({username:result[0].username,email:result[0].email,password:result[0].password,phoneNumber:result[0].phone}).returning({id:users.id,username:users.username}).then((res)=>res[0]);if(!user)return{success:!1,message:"Mtumiaji hayupo!"};let shop=await mainDb.insert(shops).values({name:result[0].shopName,trialStart:new Date(Date.now()),trialEnd:new Date(Date.now()+1209600000)}).returning({id:shops.id}).then((res)=>res[0]);if(!shop)return{success:!1,message:"Duka halipo!"};let credetials=await mainDb.insert(shopUsers).values({shopId:shop.id,userId:user.id,role:"owner"}).returning({userId:shopUsers.userId,shopId:shopUsers.shopId});if(credetials.length===0)return;let{userId,shopId}=credetials[0];if(!await jwt2.sign({userId,shopId}))return{success:!1,message:"Hakuna tokeni"};return auth_token.set({value:token,httpOnly:!0,secure:!1,sameSite:"lax",maxAge:604800,path:"/",domain:void 0}),{success:!0,message:"\uD83C\uDF89 Email imehakikiwa kiukamilifu! inakupeleka ..."}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu kwenye seva"}}}),registration_default=regPlugin;var isBun3=typeof new Headers()?.toJSON==="function",processHeaders=(headers)=>{if(isBun3)return Object.keys(headers.toJSON()).join(", ");let keys="";if(headers.forEach((_2,key)=>{keys+=key+", "}),keys)keys=keys.slice(0,-1);return keys},processOrigin=(origin,request,from)=>{if(Array.isArray(origin))return origin.some((o)=>processOrigin(o,request,from));switch(typeof origin){case"string":if(origin.indexOf("://")===-1)return from.includes(origin);return origin===from;case"function":return origin(request)===!0;case"object":if(origin instanceof RegExp)return origin.test(from)}return!1},cors=(config)=>{let{aot=!0,origin=!0,methods=!0,allowedHeaders=!0,exposeHeaders=!0,credentials=!0,maxAge=5,preflight=!0}=config??{};if(Array.isArray(allowedHeaders))allowedHeaders=allowedHeaders.join(", ");if(Array.isArray(exposeHeaders))exposeHeaders=exposeHeaders.join(", ");let origins=typeof origin==="boolean"?void 0:Array.isArray(origin)?origin:[origin],app=new Elysia({name:"@elysiajs/cors",seed:config,aot}),anyOrigin=origins?.some((o)=>o==="*"),handleOrigin=(set2,request)=>{if(origin===!0){set2.headers.vary="*",set2.headers["access-control-allow-origin"]=request.headers.get("Origin")||"*";return}if(anyOrigin){set2.headers.vary="*",set2.headers["access-control-allow-origin"]="*";return}if(!origins?.length)return;let headers=[];if(origins.length){let from=request.headers.get("Origin")??"";for(let i=0;i<origins.length;i++){let value=processOrigin(origins[i],request,from);if(value===!0){set2.headers.vary=origin?"Origin":"*",set2.headers["access-control-allow-origin"]=from||"*";return}if(value)headers.push(value)}}if(set2.headers.vary="Origin",headers.length)set2.headers["access-control-allow-origin"]=headers.join(", ")},handleMethod=(set2,method)=>{if(!method)return;if(methods===!0)return set2.headers["access-control-allow-methods"]=method??"*";if(methods===!1||!methods?.length)return;if(methods==="*")return set2.headers["access-control-allow-methods"]="*";if(!Array.isArray(methods))return set2.headers["access-control-allow-methods"]=methods;set2.headers["access-control-allow-methods"]=methods.join(", ")},defaultHeaders={};if(typeof exposeHeaders==="string")defaultHeaders["access-control-expose-headers"]=exposeHeaders;if(typeof allowedHeaders==="string")defaultHeaders["access-control-allow-headers"]=allowedHeaders;if(credentials===!0)defaultHeaders["access-control-allow-credentials"]="true";app.headers(defaultHeaders);function handleOption({set:set2,request,headers}){if(handleOrigin(set2,request),handleMethod(set2,request.headers.get("access-control-request-method")),allowedHeaders===!0||exposeHeaders===!0){if(allowedHeaders===!0)set2.headers["access-control-allow-headers"]=headers["access-control-request-headers"];if(exposeHeaders===!0)set2.headers["access-control-expose-headers"]=Object.keys(headers).join(",")}if(maxAge)set2.headers["access-control-max-age"]=maxAge.toString();return new Response(null,{status:204})}if(preflight)app.options("/",handleOption).options("/*",handleOption);return app.onRequest(function processCors({set:set2,request}){if(handleOrigin(set2,request),handleMethod(set2,request.method),allowedHeaders===!0||exposeHeaders===!0){let headers=processHeaders(request.headers);if(allowedHeaders===!0)set2.headers["access-control-allow-headers"]=headers;if(exposeHeaders===!0)set2.headers["access-control-expose-headers"]=headers}})};var suppPost=async({body,headers,shopId})=>{try{let{company,contact}=body;if(company=sanitizeString(company.trim().toLowerCase()),contact=sanitizeString(contact.trim()),(await mainDb.select().from(suppliers).where(eq(suppliers.company,company))).length>0)return{success:!1,message:"Tayari taarifa zipo"};return await mainDb.insert(suppliers).values({shopId,company,contact}),{success:!0,message:"Umefanikiwa kuhifadhi taarifa"}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu kwenye seva"}}},suppGet=async({headers,shopId,userId,query})=>{console.time("fetchSuppliers");try{let page=parseInt(query.page||"1"),limit=parseInt(query.limit||"5"),search=query.search||"",offset=(page-1)*limit,where=and(eq(suppliers.shopId,shopId),search?ilike(suppliers.company,`%${search}%`):void 0),total=await mainDb.select({count:sql`count(*)`}).from(suppliers).where(where||void 0).then((rows)=>Number(rows[0].count)),existingSuppliers=await mainDb.select().from(suppliers).where(where).orderBy(suppliers.createdAt).limit(limit).offset(offset);if(existingSuppliers.length===0)return{success:!1,message:"Hakuna kilichopatikana kwenye hifadhi",data:[],total};return console.timeEnd("fetchSuppliers"),{success:!0,message:"umefanikiwa kupata taarifa",data:existingSuppliers,total,page,limit,pages:Math.ceil(total/limit)}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu kwenye seva"}}},suppGetAll=async({shopId,userId})=>{console.time("fetchSuppliers");try{console.time("fetchAllSupp");let existingSuppliers=await mainDb.select().from(suppliers).where(eq(suppliers.shopId,shopId)).orderBy(suppliers.createdAt);if(existingSuppliers.length===0)return{success:!1,message:"Hakuna kilichopatikana kwenye hifadhi",data:[]};return console.timeEnd("fetchAllSupp"),{success:!0,message:"umefanikiwa kupata taarifa",data:existingSuppliers}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu kwenye seva"}}},suppPut=async({body,headers,supplierId})=>{try{console.time("suppUpdate");let{company,contact}=body;if(company=sanitizeString(company.trim().toLowerCase()),contact=sanitizeString(contact),!supplierId||supplierId.length<5)return{success:!1,message:"ID sio sahihi"};let updateSupp=await mainDb.update(suppliers).set({company,contact}).where(eq(suppliers.id,supplierId)).returning({id:suppliers.id,company:suppliers.company,contact:suppliers.contact});if(!updateSupp)return{success:!1,message:"Hakuna taarifa iliyopatikana"};return console.timeEnd("suppUpdate"),{success:!0,data:updateSupp,message:"Umefainikiwa ku-update taarifa"}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu kwenye seva"}}},suppDel=async({headers,supplierId,shopId})=>{try{if(!supplierId||supplierId.length<5)return{success:!1,message:"id ya msambazaji haipo!"};if(!await mainDb.delete(suppliers).where(and(eq(suppliers.id,supplierId),eq(suppliers.shopId,shopId))))return{success:!1,message:"Hakuna taarifa ya kufutwa"};return{success:!0,message:"umefanikiwa kufuta taarifa"}}catch(error2){if(error2 instanceof Error)return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu kwenye seva"}}};function isDecodedToken(token){if(typeof token==="object"&&token!==null){let t2=token;return typeof t2.userId==="string"&&typeof t2.shopId==="string"}return!1}var extractId=async({jwt:jwt2,cookie:cookie2})=>{let token=cookie2.auth_token?.value;if(!token)return{success:!1,message:"Huna ruhusa! - hakuna token"};let decoded=await jwt2.verify(token);if(!isDecodedToken(decoded))return{success:!1,message:"Huna ruhusa! - Token sio sahihi"};let{userId,shopId}=decoded;if(!shopId||!userId)return{success:!1,message:"shopId au userId haipo"};if((await mainDb.select({userId:shopUsers.userId,shopId:shopUsers.shopId}).from(shopUsers).where(and(eq(shopUsers.shopId,shopId),eq(shopUsers.userId,userId)))).length===0)return{success:!1,message:"Mtumiaji hayupo!"};return{userId,shopId}};var JWT_SECRET2=process.env.JWT_TOKEN||"something@#morecomplicated<>es>??><Ess5%",suppPlugin=new Elysia().use(index_default({name:"jwt",secret:JWT_SECRET2})).get("/suppliers",async({jwt:jwt2,cookie:cookie2,headers,query})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;return suppGet({headers,shopId,userId,query})}).get("/suppliersAll",async({jwt:jwt2,cookie:cookie2})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;return suppGetAll({shopId,userId})}).post("/suppliers",async({jwt:jwt2,cookie:cookie2,headers,body})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;return suppPost({shopId,body,headers})},{body:suppData}).put("/suppliers/:id",async({jwt:jwt2,cookie:cookie2,headers,params,body})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2}),supplierId=params.id;if(!supplierId)return{success:!1,message:"Product ID is required."};return suppPut({body,headers,supplierId})},{body:suppData}).delete("/suppliers/:id",async({jwt:jwt2,cookie:cookie2,headers,params})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2}),supplierId=params.id;if(!supplierId)return{success:!1,message:"Product ID is required."};if(!shopId||!userId)return;return suppDel({supplierId,headers,shopId})}),supplier_default=suppPlugin;var import_argon22=__toESM(require_argon2(),1);var JWT_SECRET3=process.env.JWT_TOKEN||"something@#morecomplicated<>es>??><Ess5%",loginPlugin=new Elysia().use(cookie()).use(jwt({name:"jwt",secret:JWT_SECRET3})).post("/login",async({body,jwt:jwt2,cookie:{auth_token},headers})=>{try{let{username,password}=body;if(username=sanitizeString(username.trim().toLowerCase()),password=sanitizeString(password.trim()),!username||!password)return{success:!1,message:"Taarifa ulizoweka sio sahihi"};let cacheKey=`LoginData:${username}`,cached=loginCache.get(cacheKey);if(cached&&typeof cached==="object"){let token2=await jwt2.sign({userId:cached.payload.userId,shopId:cached.payload.shopId});if(!token2)return{success:!1,message:"Hakuna tokeni, hujaruhusiwa"};return auth_token.set({value:token2,httpOnly:!0,secure:!1,sameSite:"lax",maxAge:604800,path:"/",domain:void 0}),{success:!0,message:`Umefanikiwa kuingia kama ${username}`,...cached.payload}}let user=await mainDb.select({id:users.id,username:users.username,password:users.password}).from(users).where(eq(users.username,username)).limit(1);if(!user.length)return{success:!1,message:"Mtumiaji hayupo!"};let userData=user[0];if(!await import_argon22.default.verify(userData.password,password))return{success:!1,message:"Taarifa ulizoweka sio sahihi"};let shop=await mainDb.select({shopId:shopUsers.shopId}).from(shopUsers).where(eq(shopUsers.userId,userData.id)).limit(1);if(!shop.length)return{success:!1,message:"Hakuna duka lililosajiliwa kwa ajili yako"};let shopData=shop[0],token=await jwt2.sign({userId:userData.id,shopId:shopData.shopId});if(!token)return{success:!1,message:"Hakuna tokeni, hujaruhusiwa"};auth_token.set({value:token,httpOnly:!0,secure:!1,sameSite:"lax",maxAge:604800,path:"/",domain:void 0});let payload={userId:userData.id,shopId:shopData.shopId};return loginCache.set(cacheKey,{payload}),{success:!0,message:`Umefanikiwa kuingia kama ${username}`,...payload}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu kwenye seva"}}},{body:loginData});/*!
 *  decimal.js v10.5.0
 *  An arbitrary-precision Decimal type for JavaScript.
 *  https://github.com/MikeMcl/decimal.js
 *  Copyright (c) 2025 Michael Mclaughlin <M8ch88l@gmail.com>
 *  MIT Licence
 */var EXP_LIMIT=9000000000000000,MAX_DIGITS=1e9,NUMERALS="0123456789abcdef",LN10="2.3025850929940456840179914546843642076011014886287729760333279009675726096773524802359972050895982983419677840422862486334095254650828067566662873690987816894829072083255546808437998948262331985283935053089653777326288461633662222876982198867465436674744042432743651550489343149393914796194044002221051017141748003688084012647080685567743216228355220114804663715659121373450747856947683463616792101806445070648000277502684916746550586856935673420670581136429224554405758925724208241314695689016758940256776311356919292033376587141660230105703089634572075440370847469940168269282808481184289314848524948644871927809676271275775397027668605952496716674183485704422507197965004714951050492214776567636938662976979522110718264549734772662425709429322582798502585509785265383207606726317164309505995087807523710333101197857547331541421808427543863591778117054309827482385045648019095610299291824318237525357709750539565187697510374970888692180205189339507238539205144634197265287286965110862571492198849978748873771345686209167058",PI="3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632789",DEFAULTS={precision:20,rounding:4,modulo:1,toExpNeg:-7,toExpPos:21,minE:-EXP_LIMIT,maxE:EXP_LIMIT,crypto:!1},inexact,quadrant,external=!0,decimalError="[DecimalError] ",invalidArgument=decimalError+"Invalid argument: ",precisionLimitExceeded=decimalError+"Precision limit exceeded",cryptoUnavailable=decimalError+"crypto unavailable",tag="[object Decimal]",mathfloor=Math.floor,mathpow=Math.pow,isBinary=/^0b([01]+(\.[01]*)?|\.[01]+)(p[+-]?\d+)?$/i,isHex=/^0x([0-9a-f]+(\.[0-9a-f]*)?|\.[0-9a-f]+)(p[+-]?\d+)?$/i,isOctal=/^0o([0-7]+(\.[0-7]*)?|\.[0-7]+)(p[+-]?\d+)?$/i,isDecimal=/^(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,BASE=1e7,LOG_BASE=7,MAX_SAFE_INTEGER=9007199254740991,LN10_PRECISION=LN10.length-1,PI_PRECISION=PI.length-1,P={toStringTag:tag};P.absoluteValue=P.abs=function(){var x=new this.constructor(this);if(x.s<0)x.s=1;return finalise(x)};P.ceil=function(){return finalise(new this.constructor(this),this.e+1,2)};P.clampedTo=P.clamp=function(min,max){var k2,x=this,Ctor=x.constructor;if(min=new Ctor(min),max=new Ctor(max),!min.s||!max.s)return new Ctor(NaN);if(min.gt(max))throw Error(invalidArgument+max);return k2=x.cmp(min),k2<0?min:x.cmp(max)>0?max:new Ctor(x)};P.comparedTo=P.cmp=function(y){var i,j,xdL,ydL,x=this,xd=x.d,yd=(y=new x.constructor(y)).d,xs=x.s,ys=y.s;if(!xd||!yd)return!xs||!ys?NaN:xs!==ys?xs:xd===yd?0:!xd^xs<0?1:-1;if(!xd[0]||!yd[0])return xd[0]?xs:yd[0]?-ys:0;if(xs!==ys)return xs;if(x.e!==y.e)return x.e>y.e^xs<0?1:-1;xdL=xd.length,ydL=yd.length;for(i=0,j=xdL<ydL?xdL:ydL;i<j;++i)if(xd[i]!==yd[i])return xd[i]>yd[i]^xs<0?1:-1;return xdL===ydL?0:xdL>ydL^xs<0?1:-1};P.cosine=P.cos=function(){var pr,rm,x=this,Ctor=x.constructor;if(!x.d)return new Ctor(NaN);if(!x.d[0])return new Ctor(1);return pr=Ctor.precision,rm=Ctor.rounding,Ctor.precision=pr+Math.max(x.e,x.sd())+LOG_BASE,Ctor.rounding=1,x=cosine(Ctor,toLessThanHalfPi(Ctor,x)),Ctor.precision=pr,Ctor.rounding=rm,finalise(quadrant==2||quadrant==3?x.neg():x,pr,rm,!0)};P.cubeRoot=P.cbrt=function(){var e,m,n,r,rep,s,sd,t2,t3,t3plusx,x=this,Ctor=x.constructor;if(!x.isFinite()||x.isZero())return new Ctor(x);if(external=!1,s=x.s*mathpow(x.s*x,0.3333333333333333),!s||Math.abs(s)==1/0){if(n=digitsToString(x.d),e=x.e,s=(e-n.length+1)%3)n+=s==1||s==-2?"0":"00";if(s=mathpow(n,0.3333333333333333),e=mathfloor((e+1)/3)-(e%3==(e<0?-1:2)),s==1/0)n="5e"+e;else n=s.toExponential(),n=n.slice(0,n.indexOf("e")+1)+e;r=new Ctor(n),r.s=x.s}else r=new Ctor(s.toString());sd=(e=Ctor.precision)+3;for(;;)if(t2=r,t3=t2.times(t2).times(t2),t3plusx=t3.plus(x),r=divide(t3plusx.plus(x).times(t2),t3plusx.plus(t3),sd+2,1),digitsToString(t2.d).slice(0,sd)===(n=digitsToString(r.d)).slice(0,sd))if(n=n.slice(sd-3,sd+1),n=="9999"||!rep&&n=="4999"){if(!rep){if(finalise(t2,e+1,0),t2.times(t2).times(t2).eq(x)){r=t2;break}}sd+=4,rep=1}else{if(!+n||!+n.slice(1)&&n.charAt(0)=="5")finalise(r,e+1,1),m=!r.times(r).times(r).eq(x);break}return external=!0,finalise(r,e,Ctor.rounding,m)};P.decimalPlaces=P.dp=function(){var w,d=this.d,n=NaN;if(d){if(w=d.length-1,n=(w-mathfloor(this.e/LOG_BASE))*LOG_BASE,w=d[w],w)for(;w%10==0;w/=10)n--;if(n<0)n=0}return n};P.dividedBy=P.div=function(y){return divide(this,new this.constructor(y))};P.dividedToIntegerBy=P.divToInt=function(y){var x=this,Ctor=x.constructor;return finalise(divide(x,new Ctor(y),0,1,1),Ctor.precision,Ctor.rounding)};P.equals=P.eq=function(y){return this.cmp(y)===0};P.floor=function(){return finalise(new this.constructor(this),this.e+1,3)};P.greaterThan=P.gt=function(y){return this.cmp(y)>0};P.greaterThanOrEqualTo=P.gte=function(y){var k2=this.cmp(y);return k2==1||k2===0};P.hyperbolicCosine=P.cosh=function(){var k2,n,pr,rm,len,x=this,Ctor=x.constructor,one=new Ctor(1);if(!x.isFinite())return new Ctor(x.s?1/0:NaN);if(x.isZero())return one;if(pr=Ctor.precision,rm=Ctor.rounding,Ctor.precision=pr+Math.max(x.e,x.sd())+4,Ctor.rounding=1,len=x.d.length,len<32)k2=Math.ceil(len/3),n=(1/tinyPow(4,k2)).toString();else k2=16,n="2.3283064365386962890625e-10";x=taylorSeries(Ctor,1,x.times(n),new Ctor(1),!0);var cosh2_x,i=k2,d8=new Ctor(8);for(;i--;)cosh2_x=x.times(x),x=one.minus(cosh2_x.times(d8.minus(cosh2_x.times(d8))));return finalise(x,Ctor.precision=pr,Ctor.rounding=rm,!0)};P.hyperbolicSine=P.sinh=function(){var k2,pr,rm,len,x=this,Ctor=x.constructor;if(!x.isFinite()||x.isZero())return new Ctor(x);if(pr=Ctor.precision,rm=Ctor.rounding,Ctor.precision=pr+Math.max(x.e,x.sd())+4,Ctor.rounding=1,len=x.d.length,len<3)x=taylorSeries(Ctor,2,x,x,!0);else{k2=1.4*Math.sqrt(len),k2=k2>16?16:k2|0,x=x.times(1/tinyPow(5,k2)),x=taylorSeries(Ctor,2,x,x,!0);var sinh2_x,d5=new Ctor(5),d16=new Ctor(16),d20=new Ctor(20);for(;k2--;)sinh2_x=x.times(x),x=x.times(d5.plus(sinh2_x.times(d16.times(sinh2_x).plus(d20))))}return Ctor.precision=pr,Ctor.rounding=rm,finalise(x,pr,rm,!0)};P.hyperbolicTangent=P.tanh=function(){var pr,rm,x=this,Ctor=x.constructor;if(!x.isFinite())return new Ctor(x.s);if(x.isZero())return new Ctor(x);return pr=Ctor.precision,rm=Ctor.rounding,Ctor.precision=pr+7,Ctor.rounding=1,divide(x.sinh(),x.cosh(),Ctor.precision=pr,Ctor.rounding=rm)};P.inverseCosine=P.acos=function(){var x=this,Ctor=x.constructor,k2=x.abs().cmp(1),pr=Ctor.precision,rm=Ctor.rounding;if(k2!==-1)return k2===0?x.isNeg()?getPi(Ctor,pr,rm):new Ctor(0):new Ctor(NaN);if(x.isZero())return getPi(Ctor,pr+4,rm).times(0.5);return Ctor.precision=pr+6,Ctor.rounding=1,x=new Ctor(1).minus(x).div(x.plus(1)).sqrt().atan(),Ctor.precision=pr,Ctor.rounding=rm,x.times(2)};P.inverseHyperbolicCosine=P.acosh=function(){var pr,rm,x=this,Ctor=x.constructor;if(x.lte(1))return new Ctor(x.eq(1)?0:NaN);if(!x.isFinite())return new Ctor(x);return pr=Ctor.precision,rm=Ctor.rounding,Ctor.precision=pr+Math.max(Math.abs(x.e),x.sd())+4,Ctor.rounding=1,external=!1,x=x.times(x).minus(1).sqrt().plus(x),external=!0,Ctor.precision=pr,Ctor.rounding=rm,x.ln()};P.inverseHyperbolicSine=P.asinh=function(){var pr,rm,x=this,Ctor=x.constructor;if(!x.isFinite()||x.isZero())return new Ctor(x);return pr=Ctor.precision,rm=Ctor.rounding,Ctor.precision=pr+2*Math.max(Math.abs(x.e),x.sd())+6,Ctor.rounding=1,external=!1,x=x.times(x).plus(1).sqrt().plus(x),external=!0,Ctor.precision=pr,Ctor.rounding=rm,x.ln()};P.inverseHyperbolicTangent=P.atanh=function(){var pr,rm,wpr,xsd,x=this,Ctor=x.constructor;if(!x.isFinite())return new Ctor(NaN);if(x.e>=0)return new Ctor(x.abs().eq(1)?x.s/0:x.isZero()?x:NaN);if(pr=Ctor.precision,rm=Ctor.rounding,xsd=x.sd(),Math.max(xsd,pr)<2*-x.e-1)return finalise(new Ctor(x),pr,rm,!0);return Ctor.precision=wpr=xsd-x.e,x=divide(x.plus(1),new Ctor(1).minus(x),wpr+pr,1),Ctor.precision=pr+4,Ctor.rounding=1,x=x.ln(),Ctor.precision=pr,Ctor.rounding=rm,x.times(0.5)};P.inverseSine=P.asin=function(){var halfPi,k2,pr,rm,x=this,Ctor=x.constructor;if(x.isZero())return new Ctor(x);if(k2=x.abs().cmp(1),pr=Ctor.precision,rm=Ctor.rounding,k2!==-1){if(k2===0)return halfPi=getPi(Ctor,pr+4,rm).times(0.5),halfPi.s=x.s,halfPi;return new Ctor(NaN)}return Ctor.precision=pr+6,Ctor.rounding=1,x=x.div(new Ctor(1).minus(x.times(x)).sqrt().plus(1)).atan(),Ctor.precision=pr,Ctor.rounding=rm,x.times(2)};P.inverseTangent=P.atan=function(){var i,j,k2,n,px,t2,r,wpr,x2,x=this,Ctor=x.constructor,pr=Ctor.precision,rm=Ctor.rounding;if(!x.isFinite()){if(!x.s)return new Ctor(NaN);if(pr+4<=PI_PRECISION)return r=getPi(Ctor,pr+4,rm).times(0.5),r.s=x.s,r}else if(x.isZero())return new Ctor(x);else if(x.abs().eq(1)&&pr+4<=PI_PRECISION)return r=getPi(Ctor,pr+4,rm).times(0.25),r.s=x.s,r;Ctor.precision=wpr=pr+10,Ctor.rounding=1,k2=Math.min(28,wpr/LOG_BASE+2|0);for(i=k2;i;--i)x=x.div(x.times(x).plus(1).sqrt().plus(1));external=!1,j=Math.ceil(wpr/LOG_BASE),n=1,x2=x.times(x),r=new Ctor(x),px=x;for(;i!==-1;)if(px=px.times(x2),t2=r.minus(px.div(n+=2)),px=px.times(x2),r=t2.plus(px.div(n+=2)),r.d[j]!==void 0)for(i=j;r.d[i]===t2.d[i]&&i--;);if(k2)r=r.times(2<<k2-1);return external=!0,finalise(r,Ctor.precision=pr,Ctor.rounding=rm,!0)};P.isFinite=function(){return!!this.d};P.isInteger=P.isInt=function(){return!!this.d&&mathfloor(this.e/LOG_BASE)>this.d.length-2};P.isNaN=function(){return!this.s};P.isNegative=P.isNeg=function(){return this.s<0};P.isPositive=P.isPos=function(){return this.s>0};P.isZero=function(){return!!this.d&&this.d[0]===0};P.lessThan=P.lt=function(y){return this.cmp(y)<0};P.lessThanOrEqualTo=P.lte=function(y){return this.cmp(y)<1};P.logarithm=P.log=function(base){var isBase10,d,denominator,k2,inf,num,sd,r,arg=this,Ctor=arg.constructor,pr=Ctor.precision,rm=Ctor.rounding,guard2=5;if(base==null)base=new Ctor(10),isBase10=!0;else{if(base=new Ctor(base),d=base.d,base.s<0||!d||!d[0]||base.eq(1))return new Ctor(NaN);isBase10=base.eq(10)}if(d=arg.d,arg.s<0||!d||!d[0]||arg.eq(1))return new Ctor(d&&!d[0]?-1/0:arg.s!=1?NaN:d?0:1/0);if(isBase10)if(d.length>1)inf=!0;else{for(k2=d[0];k2%10===0;)k2/=10;inf=k2!==1}if(external=!1,sd=pr+guard2,num=naturalLogarithm(arg,sd),denominator=isBase10?getLn10(Ctor,sd+10):naturalLogarithm(base,sd),r=divide(num,denominator,sd,1),checkRoundingDigits(r.d,k2=pr,rm))do if(sd+=10,num=naturalLogarithm(arg,sd),denominator=isBase10?getLn10(Ctor,sd+10):naturalLogarithm(base,sd),r=divide(num,denominator,sd,1),!inf){if(+digitsToString(r.d).slice(k2+1,k2+15)+1==100000000000000)r=finalise(r,pr+1,0);break}while(checkRoundingDigits(r.d,k2+=10,rm));return external=!0,finalise(r,pr,rm)};P.minus=P.sub=function(y){var d,e,i,j,k2,len,pr,rm,xd,xe,xLTy,yd,x=this,Ctor=x.constructor;if(y=new Ctor(y),!x.d||!y.d){if(!x.s||!y.s)y=new Ctor(NaN);else if(x.d)y.s=-y.s;else y=new Ctor(y.d||x.s!==y.s?x:NaN);return y}if(x.s!=y.s)return y.s=-y.s,x.plus(y);if(xd=x.d,yd=y.d,pr=Ctor.precision,rm=Ctor.rounding,!xd[0]||!yd[0]){if(yd[0])y.s=-y.s;else if(xd[0])y=new Ctor(x);else return new Ctor(rm===3?-0:0);return external?finalise(y,pr,rm):y}if(e=mathfloor(y.e/LOG_BASE),xe=mathfloor(x.e/LOG_BASE),xd=xd.slice(),k2=xe-e,k2){if(xLTy=k2<0,xLTy)d=xd,k2=-k2,len=yd.length;else d=yd,e=xe,len=xd.length;if(i=Math.max(Math.ceil(pr/LOG_BASE),len)+2,k2>i)k2=i,d.length=1;d.reverse();for(i=k2;i--;)d.push(0);d.reverse()}else{if(i=xd.length,len=yd.length,xLTy=i<len,xLTy)len=i;for(i=0;i<len;i++)if(xd[i]!=yd[i]){xLTy=xd[i]<yd[i];break}k2=0}if(xLTy)d=xd,xd=yd,yd=d,y.s=-y.s;len=xd.length;for(i=yd.length-len;i>0;--i)xd[len++]=0;for(i=yd.length;i>k2;){if(xd[--i]<yd[i]){for(j=i;j&&xd[--j]===0;)xd[j]=BASE-1;--xd[j],xd[i]+=BASE}xd[i]-=yd[i]}for(;xd[--len]===0;)xd.pop();for(;xd[0]===0;xd.shift())--e;if(!xd[0])return new Ctor(rm===3?-0:0);return y.d=xd,y.e=getBase10Exponent(xd,e),external?finalise(y,pr,rm):y};P.modulo=P.mod=function(y){var q,x=this,Ctor=x.constructor;if(y=new Ctor(y),!x.d||!y.s||y.d&&!y.d[0])return new Ctor(NaN);if(!y.d||x.d&&!x.d[0])return finalise(new Ctor(x),Ctor.precision,Ctor.rounding);if(external=!1,Ctor.modulo==9)q=divide(x,y.abs(),0,3,1),q.s*=y.s;else q=divide(x,y,0,Ctor.modulo,1);return q=q.times(y),external=!0,x.minus(q)};P.naturalExponential=P.exp=function(){return naturalExponential(this)};P.naturalLogarithm=P.ln=function(){return naturalLogarithm(this)};P.negated=P.neg=function(){var x=new this.constructor(this);return x.s=-x.s,finalise(x)};P.plus=P.add=function(y){var carry,d,e,i,k2,len,pr,rm,xd,yd,x=this,Ctor=x.constructor;if(y=new Ctor(y),!x.d||!y.d){if(!x.s||!y.s)y=new Ctor(NaN);else if(!x.d)y=new Ctor(y.d||x.s===y.s?x:NaN);return y}if(x.s!=y.s)return y.s=-y.s,x.minus(y);if(xd=x.d,yd=y.d,pr=Ctor.precision,rm=Ctor.rounding,!xd[0]||!yd[0]){if(!yd[0])y=new Ctor(x);return external?finalise(y,pr,rm):y}if(k2=mathfloor(x.e/LOG_BASE),e=mathfloor(y.e/LOG_BASE),xd=xd.slice(),i=k2-e,i){if(i<0)d=xd,i=-i,len=yd.length;else d=yd,e=k2,len=xd.length;if(k2=Math.ceil(pr/LOG_BASE),len=k2>len?k2+1:len+1,i>len)i=len,d.length=1;d.reverse();for(;i--;)d.push(0);d.reverse()}if(len=xd.length,i=yd.length,len-i<0)i=len,d=yd,yd=xd,xd=d;for(carry=0;i;)carry=(xd[--i]=xd[i]+yd[i]+carry)/BASE|0,xd[i]%=BASE;if(carry)xd.unshift(carry),++e;for(len=xd.length;xd[--len]==0;)xd.pop();return y.d=xd,y.e=getBase10Exponent(xd,e),external?finalise(y,pr,rm):y};P.precision=P.sd=function(z){var k2,x=this;if(z!==void 0&&z!==!!z&&z!==1&&z!==0)throw Error(invalidArgument+z);if(x.d){if(k2=getPrecision(x.d),z&&x.e+1>k2)k2=x.e+1}else k2=NaN;return k2};P.round=function(){var x=this,Ctor=x.constructor;return finalise(new Ctor(x),x.e+1,Ctor.rounding)};P.sine=P.sin=function(){var pr,rm,x=this,Ctor=x.constructor;if(!x.isFinite())return new Ctor(NaN);if(x.isZero())return new Ctor(x);return pr=Ctor.precision,rm=Ctor.rounding,Ctor.precision=pr+Math.max(x.e,x.sd())+LOG_BASE,Ctor.rounding=1,x=sine(Ctor,toLessThanHalfPi(Ctor,x)),Ctor.precision=pr,Ctor.rounding=rm,finalise(quadrant>2?x.neg():x,pr,rm,!0)};P.squareRoot=P.sqrt=function(){var m,n,sd,r,rep,t2,x=this,d=x.d,e=x.e,s=x.s,Ctor=x.constructor;if(s!==1||!d||!d[0])return new Ctor(!s||s<0&&(!d||d[0])?NaN:d?x:1/0);if(external=!1,s=Math.sqrt(+x),s==0||s==1/0){if(n=digitsToString(d),(n.length+e)%2==0)n+="0";if(s=Math.sqrt(n),e=mathfloor((e+1)/2)-(e<0||e%2),s==1/0)n="5e"+e;else n=s.toExponential(),n=n.slice(0,n.indexOf("e")+1)+e;r=new Ctor(n)}else r=new Ctor(s.toString());sd=(e=Ctor.precision)+3;for(;;)if(t2=r,r=t2.plus(divide(x,t2,sd+2,1)).times(0.5),digitsToString(t2.d).slice(0,sd)===(n=digitsToString(r.d)).slice(0,sd))if(n=n.slice(sd-3,sd+1),n=="9999"||!rep&&n=="4999"){if(!rep){if(finalise(t2,e+1,0),t2.times(t2).eq(x)){r=t2;break}}sd+=4,rep=1}else{if(!+n||!+n.slice(1)&&n.charAt(0)=="5")finalise(r,e+1,1),m=!r.times(r).eq(x);break}return external=!0,finalise(r,e,Ctor.rounding,m)};P.tangent=P.tan=function(){var pr,rm,x=this,Ctor=x.constructor;if(!x.isFinite())return new Ctor(NaN);if(x.isZero())return new Ctor(x);return pr=Ctor.precision,rm=Ctor.rounding,Ctor.precision=pr+10,Ctor.rounding=1,x=x.sin(),x.s=1,x=divide(x,new Ctor(1).minus(x.times(x)).sqrt(),pr+10,0),Ctor.precision=pr,Ctor.rounding=rm,finalise(quadrant==2||quadrant==4?x.neg():x,pr,rm,!0)};P.times=P.mul=function(y){var carry,e,i,k2,r,rL,t2,xdL,ydL,x=this,Ctor=x.constructor,xd=x.d,yd=(y=new Ctor(y)).d;if(y.s*=x.s,!xd||!xd[0]||!yd||!yd[0])return new Ctor(!y.s||xd&&!xd[0]&&!yd||yd&&!yd[0]&&!xd?NaN:!xd||!yd?y.s/0:y.s*0);if(e=mathfloor(x.e/LOG_BASE)+mathfloor(y.e/LOG_BASE),xdL=xd.length,ydL=yd.length,xdL<ydL)r=xd,xd=yd,yd=r,rL=xdL,xdL=ydL,ydL=rL;r=[],rL=xdL+ydL;for(i=rL;i--;)r.push(0);for(i=ydL;--i>=0;){carry=0;for(k2=xdL+i;k2>i;)t2=r[k2]+yd[i]*xd[k2-i-1]+carry,r[k2--]=t2%BASE|0,carry=t2/BASE|0;r[k2]=(r[k2]+carry)%BASE|0}for(;!r[--rL];)r.pop();if(carry)++e;else r.shift();return y.d=r,y.e=getBase10Exponent(r,e),external?finalise(y,Ctor.precision,Ctor.rounding):y};P.toBinary=function(sd,rm){return toStringBinary(this,2,sd,rm)};P.toDecimalPlaces=P.toDP=function(dp,rm){var x=this,Ctor=x.constructor;if(x=new Ctor(x),dp===void 0)return x;if(checkInt32(dp,0,MAX_DIGITS),rm===void 0)rm=Ctor.rounding;else checkInt32(rm,0,8);return finalise(x,dp+x.e+1,rm)};P.toExponential=function(dp,rm){var str,x=this,Ctor=x.constructor;if(dp===void 0)str=finiteToString(x,!0);else{if(checkInt32(dp,0,MAX_DIGITS),rm===void 0)rm=Ctor.rounding;else checkInt32(rm,0,8);x=finalise(new Ctor(x),dp+1,rm),str=finiteToString(x,!0,dp+1)}return x.isNeg()&&!x.isZero()?"-"+str:str};P.toFixed=function(dp,rm){var str,y,x=this,Ctor=x.constructor;if(dp===void 0)str=finiteToString(x);else{if(checkInt32(dp,0,MAX_DIGITS),rm===void 0)rm=Ctor.rounding;else checkInt32(rm,0,8);y=finalise(new Ctor(x),dp+x.e+1,rm),str=finiteToString(y,!1,dp+y.e+1)}return x.isNeg()&&!x.isZero()?"-"+str:str};P.toFraction=function(maxD){var d,d0,d1,d2,e,k2,n,n0,n1,pr,q,r,x=this,xd=x.d,Ctor=x.constructor;if(!xd)return new Ctor(x);if(n1=d0=new Ctor(1),d1=n0=new Ctor(0),d=new Ctor(d1),e=d.e=getPrecision(xd)-x.e-1,k2=e%LOG_BASE,d.d[0]=mathpow(10,k2<0?LOG_BASE+k2:k2),maxD==null)maxD=e>0?d:n1;else{if(n=new Ctor(maxD),!n.isInt()||n.lt(n1))throw Error(invalidArgument+n);maxD=n.gt(d)?e>0?d:n1:n}external=!1,n=new Ctor(digitsToString(xd)),pr=Ctor.precision,Ctor.precision=e=xd.length*LOG_BASE*2;for(;;){if(q=divide(n,d,0,1,1),d2=d0.plus(q.times(d1)),d2.cmp(maxD)==1)break;d0=d1,d1=d2,d2=n1,n1=n0.plus(q.times(d2)),n0=d2,d2=d,d=n.minus(q.times(d2)),n=d2}return d2=divide(maxD.minus(d0),d1,0,1,1),n0=n0.plus(d2.times(n1)),d0=d0.plus(d2.times(d1)),n0.s=n1.s=x.s,r=divide(n1,d1,e,1).minus(x).abs().cmp(divide(n0,d0,e,1).minus(x).abs())<1?[n1,d1]:[n0,d0],Ctor.precision=pr,external=!0,r};P.toHexadecimal=P.toHex=function(sd,rm){return toStringBinary(this,16,sd,rm)};P.toNearest=function(y,rm){var x=this,Ctor=x.constructor;if(x=new Ctor(x),y==null){if(!x.d)return x;y=new Ctor(1),rm=Ctor.rounding}else{if(y=new Ctor(y),rm===void 0)rm=Ctor.rounding;else checkInt32(rm,0,8);if(!x.d)return y.s?x:y;if(!y.d){if(y.s)y.s=x.s;return y}}if(y.d[0])external=!1,x=divide(x,y,0,rm,1).times(y),external=!0,finalise(x);else y.s=x.s,x=y;return x};P.toNumber=function(){return+this};P.toOctal=function(sd,rm){return toStringBinary(this,8,sd,rm)};P.toPower=P.pow=function(y){var e,k2,pr,r,rm,s,x=this,Ctor=x.constructor,yn=+(y=new Ctor(y));if(!x.d||!y.d||!x.d[0]||!y.d[0])return new Ctor(mathpow(+x,yn));if(x=new Ctor(x),x.eq(1))return x;if(pr=Ctor.precision,rm=Ctor.rounding,y.eq(1))return finalise(x,pr,rm);if(e=mathfloor(y.e/LOG_BASE),e>=y.d.length-1&&(k2=yn<0?-yn:yn)<=MAX_SAFE_INTEGER)return r=intPow(Ctor,x,k2,pr),y.s<0?new Ctor(1).div(r):finalise(r,pr,rm);if(s=x.s,s<0){if(e<y.d.length-1)return new Ctor(NaN);if((y.d[e]&1)==0)s=1;if(x.e==0&&x.d[0]==1&&x.d.length==1)return x.s=s,x}if(k2=mathpow(+x,yn),e=k2==0||!isFinite(k2)?mathfloor(yn*(Math.log("0."+digitsToString(x.d))/Math.LN10+x.e+1)):new Ctor(k2+"").e,e>Ctor.maxE+1||e<Ctor.minE-1)return new Ctor(e>0?s/0:0);if(external=!1,Ctor.rounding=x.s=1,k2=Math.min(12,(e+"").length),r=naturalExponential(y.times(naturalLogarithm(x,pr+k2)),pr),r.d){if(r=finalise(r,pr+5,1),checkRoundingDigits(r.d,pr,rm)){if(e=pr+10,r=finalise(naturalExponential(y.times(naturalLogarithm(x,e+k2)),e),e+5,1),+digitsToString(r.d).slice(pr+1,pr+15)+1==100000000000000)r=finalise(r,pr+1,0)}}return r.s=s,external=!0,Ctor.rounding=rm,finalise(r,pr,rm)};P.toPrecision=function(sd,rm){var str,x=this,Ctor=x.constructor;if(sd===void 0)str=finiteToString(x,x.e<=Ctor.toExpNeg||x.e>=Ctor.toExpPos);else{if(checkInt32(sd,1,MAX_DIGITS),rm===void 0)rm=Ctor.rounding;else checkInt32(rm,0,8);x=finalise(new Ctor(x),sd,rm),str=finiteToString(x,sd<=x.e||x.e<=Ctor.toExpNeg,sd)}return x.isNeg()&&!x.isZero()?"-"+str:str};P.toSignificantDigits=P.toSD=function(sd,rm){var x=this,Ctor=x.constructor;if(sd===void 0)sd=Ctor.precision,rm=Ctor.rounding;else if(checkInt32(sd,1,MAX_DIGITS),rm===void 0)rm=Ctor.rounding;else checkInt32(rm,0,8);return finalise(new Ctor(x),sd,rm)};P.toString=function(){var x=this,Ctor=x.constructor,str=finiteToString(x,x.e<=Ctor.toExpNeg||x.e>=Ctor.toExpPos);return x.isNeg()&&!x.isZero()?"-"+str:str};P.truncated=P.trunc=function(){return finalise(new this.constructor(this),this.e+1,1)};P.valueOf=P.toJSON=function(){var x=this,Ctor=x.constructor,str=finiteToString(x,x.e<=Ctor.toExpNeg||x.e>=Ctor.toExpPos);return x.isNeg()?"-"+str:str};function digitsToString(d){var i,k2,ws,indexOfLastWord=d.length-1,str="",w=d[0];if(indexOfLastWord>0){str+=w;for(i=1;i<indexOfLastWord;i++){if(ws=d[i]+"",k2=LOG_BASE-ws.length,k2)str+=getZeroString(k2);str+=ws}if(w=d[i],ws=w+"",k2=LOG_BASE-ws.length,k2)str+=getZeroString(k2)}else if(w===0)return"0";for(;w%10===0;)w/=10;return str+w}function checkInt32(i,min,max){if(i!==~~i||i<min||i>max)throw Error(invalidArgument+i)}function checkRoundingDigits(d,i,rm,repeating){var di,k2,r,rd;for(k2=d[0];k2>=10;k2/=10)--i;if(--i<0)i+=LOG_BASE,di=0;else di=Math.ceil((i+1)/LOG_BASE),i%=LOG_BASE;if(k2=mathpow(10,LOG_BASE-i),rd=d[di]%k2|0,repeating==null)if(i<3){if(i==0)rd=rd/100|0;else if(i==1)rd=rd/10|0;r=rm<4&&rd==99999||rm>3&&rd==49999||rd==50000||rd==0}else r=(rm<4&&rd+1==k2||rm>3&&rd+1==k2/2)&&(d[di+1]/k2/100|0)==mathpow(10,i-2)-1||(rd==k2/2||rd==0)&&(d[di+1]/k2/100|0)==0;else if(i<4){if(i==0)rd=rd/1000|0;else if(i==1)rd=rd/100|0;else if(i==2)rd=rd/10|0;r=(repeating||rm<4)&&rd==9999||!repeating&&rm>3&&rd==4999}else r=((repeating||rm<4)&&rd+1==k2||!repeating&&rm>3&&rd+1==k2/2)&&(d[di+1]/k2/1000|0)==mathpow(10,i-3)-1;return r}function convertBase(str,baseIn,baseOut){var j,arr=[0],arrL,i=0,strL=str.length;for(;i<strL;){for(arrL=arr.length;arrL--;)arr[arrL]*=baseIn;arr[0]+=NUMERALS.indexOf(str.charAt(i++));for(j=0;j<arr.length;j++)if(arr[j]>baseOut-1){if(arr[j+1]===void 0)arr[j+1]=0;arr[j+1]+=arr[j]/baseOut|0,arr[j]%=baseOut}}return arr.reverse()}function cosine(Ctor,x){var k2,len,y;if(x.isZero())return x;if(len=x.d.length,len<32)k2=Math.ceil(len/3),y=(1/tinyPow(4,k2)).toString();else k2=16,y="2.3283064365386962890625e-10";Ctor.precision+=k2,x=taylorSeries(Ctor,1,x.times(y),new Ctor(1));for(var i=k2;i--;){var cos2x=x.times(x);x=cos2x.times(cos2x).minus(cos2x).times(8).plus(1)}return Ctor.precision-=k2,x}var divide=function(){function multiplyInteger(x,k2,base){var temp,carry=0,i=x.length;for(x=x.slice();i--;)temp=x[i]*k2+carry,x[i]=temp%base|0,carry=temp/base|0;if(carry)x.unshift(carry);return x}function compare(a,b2,aL,bL){var i,r;if(aL!=bL)r=aL>bL?1:-1;else for(i=r=0;i<aL;i++)if(a[i]!=b2[i]){r=a[i]>b2[i]?1:-1;break}return r}function subtract(a,b2,aL,base){var i=0;for(;aL--;)a[aL]-=i,i=a[aL]<b2[aL]?1:0,a[aL]=i*base+a[aL]-b2[aL];for(;!a[0]&&a.length>1;)a.shift()}return function(x,y,pr,rm,dp,base){var cmp,e,i,k2,logBase,more,prod,prodL,q,qd,rem,remL,rem0,sd,t2,xi,xL,yd0,yL,yz,Ctor=x.constructor,sign2=x.s==y.s?1:-1,xd=x.d,yd=y.d;if(!xd||!xd[0]||!yd||!yd[0])return new Ctor(!x.s||!y.s||(xd?yd&&xd[0]==yd[0]:!yd)?NaN:xd&&xd[0]==0||!yd?sign2*0:sign2/0);if(base)logBase=1,e=x.e-y.e;else base=BASE,logBase=LOG_BASE,e=mathfloor(x.e/logBase)-mathfloor(y.e/logBase);yL=yd.length,xL=xd.length,q=new Ctor(sign2),qd=q.d=[];for(i=0;yd[i]==(xd[i]||0);i++);if(yd[i]>(xd[i]||0))e--;if(pr==null)sd=pr=Ctor.precision,rm=Ctor.rounding;else if(dp)sd=pr+(x.e-y.e)+1;else sd=pr;if(sd<0)qd.push(1),more=!0;else{if(sd=sd/logBase+2|0,i=0,yL==1){k2=0,yd=yd[0],sd++;for(;(i<xL||k2)&&sd--;i++)t2=k2*base+(xd[i]||0),qd[i]=t2/yd|0,k2=t2%yd|0;more=k2||i<xL}else{if(k2=base/(yd[0]+1)|0,k2>1)yd=multiplyInteger(yd,k2,base),xd=multiplyInteger(xd,k2,base),yL=yd.length,xL=xd.length;xi=yL,rem=xd.slice(0,yL),remL=rem.length;for(;remL<yL;)rem[remL++]=0;if(yz=yd.slice(),yz.unshift(0),yd0=yd[0],yd[1]>=base/2)++yd0;do{if(k2=0,cmp=compare(yd,rem,yL,remL),cmp<0){if(rem0=rem[0],yL!=remL)rem0=rem0*base+(rem[1]||0);if(k2=rem0/yd0|0,k2>1){if(k2>=base)k2=base-1;if(prod=multiplyInteger(yd,k2,base),prodL=prod.length,remL=rem.length,cmp=compare(prod,rem,prodL,remL),cmp==1)k2--,subtract(prod,yL<prodL?yz:yd,prodL,base)}else{if(k2==0)cmp=k2=1;prod=yd.slice()}if(prodL=prod.length,prodL<remL)prod.unshift(0);if(subtract(rem,prod,remL,base),cmp==-1){if(remL=rem.length,cmp=compare(yd,rem,yL,remL),cmp<1)k2++,subtract(rem,yL<remL?yz:yd,remL,base)}remL=rem.length}else if(cmp===0)k2++,rem=[0];if(qd[i++]=k2,cmp&&rem[0])rem[remL++]=xd[xi]||0;else rem=[xd[xi]],remL=1}while((xi++<xL||rem[0]!==void 0)&&sd--);more=rem[0]!==void 0}if(!qd[0])qd.shift()}if(logBase==1)q.e=e,inexact=more;else{for(i=1,k2=qd[0];k2>=10;k2/=10)i++;q.e=i+e*logBase-1,finalise(q,dp?pr+q.e+1:pr,rm,more)}return q}}();function finalise(x,sd,rm,isTruncated){var digits,i,j,k2,rd,roundUp,w,xd,xdi,Ctor=x.constructor;out:if(sd!=null){if(xd=x.d,!xd)return x;for(digits=1,k2=xd[0];k2>=10;k2/=10)digits++;if(i=sd-digits,i<0)i+=LOG_BASE,j=sd,w=xd[xdi=0],rd=w/mathpow(10,digits-j-1)%10|0;else if(xdi=Math.ceil((i+1)/LOG_BASE),k2=xd.length,xdi>=k2)if(isTruncated){for(;k2++<=xdi;)xd.push(0);w=rd=0,digits=1,i%=LOG_BASE,j=i-LOG_BASE+1}else break out;else{w=k2=xd[xdi];for(digits=1;k2>=10;k2/=10)digits++;i%=LOG_BASE,j=i-LOG_BASE+digits,rd=j<0?0:w/mathpow(10,digits-j-1)%10|0}if(isTruncated=isTruncated||sd<0||xd[xdi+1]!==void 0||(j<0?w:w%mathpow(10,digits-j-1)),roundUp=rm<4?(rd||isTruncated)&&(rm==0||rm==(x.s<0?3:2)):rd>5||rd==5&&(rm==4||isTruncated||rm==6&&(i>0?j>0?w/mathpow(10,digits-j):0:xd[xdi-1])%10&1||rm==(x.s<0?8:7)),sd<1||!xd[0]){if(xd.length=0,roundUp)sd-=x.e+1,xd[0]=mathpow(10,(LOG_BASE-sd%LOG_BASE)%LOG_BASE),x.e=-sd||0;else xd[0]=x.e=0;return x}if(i==0)xd.length=xdi,k2=1,xdi--;else xd.length=xdi+1,k2=mathpow(10,LOG_BASE-i),xd[xdi]=j>0?(w/mathpow(10,digits-j)%mathpow(10,j)|0)*k2:0;if(roundUp)for(;;)if(xdi==0){for(i=1,j=xd[0];j>=10;j/=10)i++;j=xd[0]+=k2;for(k2=1;j>=10;j/=10)k2++;if(i!=k2){if(x.e++,xd[0]==BASE)xd[0]=1}break}else{if(xd[xdi]+=k2,xd[xdi]!=BASE)break;xd[xdi--]=0,k2=1}for(i=xd.length;xd[--i]===0;)xd.pop()}if(external){if(x.e>Ctor.maxE)x.d=null,x.e=NaN;else if(x.e<Ctor.minE)x.e=0,x.d=[0]}return x}function finiteToString(x,isExp,sd){if(!x.isFinite())return nonFiniteToString(x);var k2,e=x.e,str=digitsToString(x.d),len=str.length;if(isExp){if(sd&&(k2=sd-len)>0)str=str.charAt(0)+"."+str.slice(1)+getZeroString(k2);else if(len>1)str=str.charAt(0)+"."+str.slice(1);str=str+(x.e<0?"e":"e+")+x.e}else if(e<0){if(str="0."+getZeroString(-e-1)+str,sd&&(k2=sd-len)>0)str+=getZeroString(k2)}else if(e>=len){if(str+=getZeroString(e+1-len),sd&&(k2=sd-e-1)>0)str=str+"."+getZeroString(k2)}else{if((k2=e+1)<len)str=str.slice(0,k2)+"."+str.slice(k2);if(sd&&(k2=sd-len)>0){if(e+1===len)str+=".";str+=getZeroString(k2)}}return str}function getBase10Exponent(digits,e){var w=digits[0];for(e*=LOG_BASE;w>=10;w/=10)e++;return e}function getLn10(Ctor,sd,pr){if(sd>LN10_PRECISION){if(external=!0,pr)Ctor.precision=pr;throw Error(precisionLimitExceeded)}return finalise(new Ctor(LN10),sd,1,!0)}function getPi(Ctor,sd,rm){if(sd>PI_PRECISION)throw Error(precisionLimitExceeded);return finalise(new Ctor(PI),sd,rm,!0)}function getPrecision(digits){var w=digits.length-1,len=w*LOG_BASE+1;if(w=digits[w],w){for(;w%10==0;w/=10)len--;for(w=digits[0];w>=10;w/=10)len++}return len}function getZeroString(k2){var zs="";for(;k2--;)zs+="0";return zs}function intPow(Ctor,x,n,pr){var isTruncated,r=new Ctor(1),k2=Math.ceil(pr/LOG_BASE+4);external=!1;for(;;){if(n%2){if(r=r.times(x),truncate(r.d,k2))isTruncated=!0}if(n=mathfloor(n/2),n===0){if(n=r.d.length-1,isTruncated&&r.d[n]===0)++r.d[n];break}x=x.times(x),truncate(x.d,k2)}return external=!0,r}function isOdd(n){return n.d[n.d.length-1]&1}function maxOrMin(Ctor,args,n){var k2,y,x=new Ctor(args[0]),i=0;for(;++i<args.length;){if(y=new Ctor(args[i]),!y.s){x=y;break}if(k2=x.cmp(y),k2===n||k2===0&&x.s===n)x=y}return x}function naturalExponential(x,sd){var denominator,guard2,j,pow,sum,t2,wpr,rep=0,i=0,k2=0,Ctor=x.constructor,rm=Ctor.rounding,pr=Ctor.precision;if(!x.d||!x.d[0]||x.e>17)return new Ctor(x.d?!x.d[0]?1:x.s<0?0:1/0:x.s?x.s<0?0:x:NaN);if(sd==null)external=!1,wpr=pr;else wpr=sd;t2=new Ctor(0.03125);while(x.e>-2)x=x.times(t2),k2+=5;guard2=Math.log(mathpow(2,k2))/Math.LN10*2+5|0,wpr+=guard2,denominator=pow=sum=new Ctor(1),Ctor.precision=wpr;for(;;){if(pow=finalise(pow.times(x),wpr,1),denominator=denominator.times(++i),t2=sum.plus(divide(pow,denominator,wpr,1)),digitsToString(t2.d).slice(0,wpr)===digitsToString(sum.d).slice(0,wpr)){j=k2;while(j--)sum=finalise(sum.times(sum),wpr,1);if(sd==null)if(rep<3&&checkRoundingDigits(sum.d,wpr-guard2,rm,rep))Ctor.precision=wpr+=10,denominator=pow=t2=new Ctor(1),i=0,rep++;else return finalise(sum,Ctor.precision=pr,rm,external=!0);else return Ctor.precision=pr,sum}sum=t2}}function naturalLogarithm(y,sd){var c,c0,denominator,e,numerator,rep,sum,t2,wpr,x1,x2,n=1,guard2=10,x=y,xd=x.d,Ctor=x.constructor,rm=Ctor.rounding,pr=Ctor.precision;if(x.s<0||!xd||!xd[0]||!x.e&&xd[0]==1&&xd.length==1)return new Ctor(xd&&!xd[0]?-1/0:x.s!=1?NaN:xd?0:x);if(sd==null)external=!1,wpr=pr;else wpr=sd;if(Ctor.precision=wpr+=guard2,c=digitsToString(xd),c0=c.charAt(0),Math.abs(e=x.e)<1500000000000000){while(c0<7&&c0!=1||c0==1&&c.charAt(1)>3)x=x.times(y),c=digitsToString(x.d),c0=c.charAt(0),n++;if(e=x.e,c0>1)x=new Ctor("0."+c),e++;else x=new Ctor(c0+"."+c.slice(1))}else return t2=getLn10(Ctor,wpr+2,pr).times(e+""),x=naturalLogarithm(new Ctor(c0+"."+c.slice(1)),wpr-guard2).plus(t2),Ctor.precision=pr,sd==null?finalise(x,pr,rm,external=!0):x;x1=x,sum=numerator=x=divide(x.minus(1),x.plus(1),wpr,1),x2=finalise(x.times(x),wpr,1),denominator=3;for(;;){if(numerator=finalise(numerator.times(x2),wpr,1),t2=sum.plus(divide(numerator,new Ctor(denominator),wpr,1)),digitsToString(t2.d).slice(0,wpr)===digitsToString(sum.d).slice(0,wpr)){if(sum=sum.times(2),e!==0)sum=sum.plus(getLn10(Ctor,wpr+2,pr).times(e+""));if(sum=divide(sum,new Ctor(n),wpr,1),sd==null)if(checkRoundingDigits(sum.d,wpr-guard2,rm,rep))Ctor.precision=wpr+=guard2,t2=numerator=x=divide(x1.minus(1),x1.plus(1),wpr,1),x2=finalise(x.times(x),wpr,1),denominator=rep=1;else return finalise(sum,Ctor.precision=pr,rm,external=!0);else return Ctor.precision=pr,sum}sum=t2,denominator+=2}}function nonFiniteToString(x){return String(x.s*x.s/0)}function parseDecimal(x,str){var e,i,len;if((e=str.indexOf("."))>-1)str=str.replace(".","");if((i=str.search(/e/i))>0){if(e<0)e=i;e+=+str.slice(i+1),str=str.substring(0,i)}else if(e<0)e=str.length;for(i=0;str.charCodeAt(i)===48;i++);for(len=str.length;str.charCodeAt(len-1)===48;--len);if(str=str.slice(i,len),str){if(len-=i,x.e=e=e-i-1,x.d=[],i=(e+1)%LOG_BASE,e<0)i+=LOG_BASE;if(i<len){if(i)x.d.push(+str.slice(0,i));for(len-=LOG_BASE;i<len;)x.d.push(+str.slice(i,i+=LOG_BASE));str=str.slice(i),i=LOG_BASE-str.length}else i-=len;for(;i--;)str+="0";if(x.d.push(+str),external){if(x.e>x.constructor.maxE)x.d=null,x.e=NaN;else if(x.e<x.constructor.minE)x.e=0,x.d=[0]}}else x.e=0,x.d=[0];return x}function parseOther(x,str){var base,Ctor,divisor,i,isFloat,len,p,xd,xe;if(str.indexOf("_")>-1){if(str=str.replace(/(\d)_(?=\d)/g,"$1"),isDecimal.test(str))return parseDecimal(x,str)}else if(str==="Infinity"||str==="NaN"){if(!+str)x.s=NaN;return x.e=NaN,x.d=null,x}if(isHex.test(str))base=16,str=str.toLowerCase();else if(isBinary.test(str))base=2;else if(isOctal.test(str))base=8;else throw Error(invalidArgument+str);if(i=str.search(/p/i),i>0)p=+str.slice(i+1),str=str.substring(2,i);else str=str.slice(2);if(i=str.indexOf("."),isFloat=i>=0,Ctor=x.constructor,isFloat)str=str.replace(".",""),len=str.length,i=len-i,divisor=intPow(Ctor,new Ctor(base),i,i*2);xd=convertBase(str,base,BASE),xe=xd.length-1;for(i=xe;xd[i]===0;--i)xd.pop();if(i<0)return new Ctor(x.s*0);if(x.e=getBase10Exponent(xd,xe),x.d=xd,external=!1,isFloat)x=divide(x,divisor,len*4);if(p)x=x.times(Math.abs(p)<54?mathpow(2,p):Decimal.pow(2,p));return external=!0,x}function sine(Ctor,x){var k2,len=x.d.length;if(len<3)return x.isZero()?x:taylorSeries(Ctor,2,x,x);k2=1.4*Math.sqrt(len),k2=k2>16?16:k2|0,x=x.times(1/tinyPow(5,k2)),x=taylorSeries(Ctor,2,x,x);var sin2_x,d5=new Ctor(5),d16=new Ctor(16),d20=new Ctor(20);for(;k2--;)sin2_x=x.times(x),x=x.times(d5.plus(sin2_x.times(d16.times(sin2_x).minus(d20))));return x}function taylorSeries(Ctor,n,x,y,isHyperbolic){var j,t2,u,x2,i=1,pr=Ctor.precision,k2=Math.ceil(pr/LOG_BASE);external=!1,x2=x.times(x),u=new Ctor(y);for(;;){if(t2=divide(u.times(x2),new Ctor(n++*n++),pr,1),u=isHyperbolic?y.plus(t2):y.minus(t2),y=divide(t2.times(x2),new Ctor(n++*n++),pr,1),t2=u.plus(y),t2.d[k2]!==void 0){for(j=k2;t2.d[j]===u.d[j]&&j--;);if(j==-1)break}j=u,u=y,y=t2,t2=j,i++}return external=!0,t2.d.length=k2+1,t2}function tinyPow(b2,e){var n=b2;while(--e)n*=b2;return n}function toLessThanHalfPi(Ctor,x){var t2,isNeg=x.s<0,pi=getPi(Ctor,Ctor.precision,1),halfPi=pi.times(0.5);if(x=x.abs(),x.lte(halfPi))return quadrant=isNeg?4:1,x;if(t2=x.divToInt(pi),t2.isZero())quadrant=isNeg?3:2;else{if(x=x.minus(t2.times(pi)),x.lte(halfPi))return quadrant=isOdd(t2)?isNeg?2:3:isNeg?4:1,x;quadrant=isOdd(t2)?isNeg?1:4:isNeg?3:2}return x.minus(pi).abs()}function toStringBinary(x,baseOut,sd,rm){var base,e,i,k2,len,roundUp,str,xd,y,Ctor=x.constructor,isExp=sd!==void 0;if(isExp)if(checkInt32(sd,1,MAX_DIGITS),rm===void 0)rm=Ctor.rounding;else checkInt32(rm,0,8);else sd=Ctor.precision,rm=Ctor.rounding;if(!x.isFinite())str=nonFiniteToString(x);else{if(str=finiteToString(x),i=str.indexOf("."),isExp){if(base=2,baseOut==16)sd=sd*4-3;else if(baseOut==8)sd=sd*3-2}else base=baseOut;if(i>=0)str=str.replace(".",""),y=new Ctor(1),y.e=str.length-i,y.d=convertBase(finiteToString(y),10,base),y.e=y.d.length;xd=convertBase(str,10,base),e=len=xd.length;for(;xd[--len]==0;)xd.pop();if(!xd[0])str=isExp?"0p+0":"0";else{if(i<0)e--;else x=new Ctor(x),x.d=xd,x.e=e,x=divide(x,y,sd,rm,0,base),xd=x.d,e=x.e,roundUp=inexact;if(i=xd[sd],k2=base/2,roundUp=roundUp||xd[sd+1]!==void 0,roundUp=rm<4?(i!==void 0||roundUp)&&(rm===0||rm===(x.s<0?3:2)):i>k2||i===k2&&(rm===4||roundUp||rm===6&&xd[sd-1]&1||rm===(x.s<0?8:7)),xd.length=sd,roundUp){for(;++xd[--sd]>base-1;)if(xd[sd]=0,!sd)++e,xd.unshift(1)}for(len=xd.length;!xd[len-1];--len);for(i=0,str="";i<len;i++)str+=NUMERALS.charAt(xd[i]);if(isExp){if(len>1)if(baseOut==16||baseOut==8){i=baseOut==16?4:3;for(--len;len%i;len++)str+="0";xd=convertBase(str,base,baseOut);for(len=xd.length;!xd[len-1];--len);for(i=1,str="1.";i<len;i++)str+=NUMERALS.charAt(xd[i])}else str=str.charAt(0)+"."+str.slice(1);str=str+(e<0?"p":"p+")+e}else if(e<0){for(;++e;)str="0"+str;str="0."+str}else if(++e>len)for(e-=len;e--;)str+="0";else if(e<len)str=str.slice(0,e)+"."+str.slice(e)}str=(baseOut==16?"0x":baseOut==2?"0b":baseOut==8?"0o":"")+str}return x.s<0?"-"+str:str}function truncate(arr,len){if(arr.length>len)return arr.length=len,!0}function abs(x){return new this(x).abs()}function acos(x){return new this(x).acos()}function acosh(x){return new this(x).acosh()}function add(x,y){return new this(x).plus(y)}function asin(x){return new this(x).asin()}function asinh(x){return new this(x).asinh()}function atan(x){return new this(x).atan()}function atanh(x){return new this(x).atanh()}function atan2(y,x){y=new this(y),x=new this(x);var r,pr=this.precision,rm=this.rounding,wpr=pr+4;if(!y.s||!x.s)r=new this(NaN);else if(!y.d&&!x.d)r=getPi(this,wpr,1).times(x.s>0?0.25:0.75),r.s=y.s;else if(!x.d||y.isZero())r=x.s<0?getPi(this,pr,rm):new this(0),r.s=y.s;else if(!y.d||x.isZero())r=getPi(this,wpr,1).times(0.5),r.s=y.s;else if(x.s<0)this.precision=wpr,this.rounding=1,r=this.atan(divide(y,x,wpr,1)),x=getPi(this,wpr,1),this.precision=pr,this.rounding=rm,r=y.s<0?r.minus(x):r.plus(x);else r=this.atan(divide(y,x,wpr,1));return r}function cbrt(x){return new this(x).cbrt()}function ceil(x){return finalise(x=new this(x),x.e+1,2)}function clamp(x,min,max){return new this(x).clamp(min,max)}function config(obj){if(!obj||typeof obj!=="object")throw Error(decimalError+"Object expected");var i,p,v,useDefaults=obj.defaults===!0,ps=["precision",1,MAX_DIGITS,"rounding",0,8,"toExpNeg",-EXP_LIMIT,0,"toExpPos",0,EXP_LIMIT,"maxE",0,EXP_LIMIT,"minE",-EXP_LIMIT,0,"modulo",0,9];for(i=0;i<ps.length;i+=3){if(p=ps[i],useDefaults)this[p]=DEFAULTS[p];if((v=obj[p])!==void 0)if(mathfloor(v)===v&&v>=ps[i+1]&&v<=ps[i+2])this[p]=v;else throw Error(invalidArgument+p+": "+v)}if(p="crypto",useDefaults)this[p]=DEFAULTS[p];if((v=obj[p])!==void 0)if(v===!0||v===!1||v===0||v===1)if(v)if(typeof crypto!="undefined"&&crypto&&(crypto.getRandomValues||crypto.randomBytes))this[p]=!0;else throw Error(cryptoUnavailable);else this[p]=!1;else throw Error(invalidArgument+p+": "+v);return this}function cos(x){return new this(x).cos()}function cosh(x){return new this(x).cosh()}function clone2(obj){var i,p,ps;function Decimal(v){var e,i2,t2,x=this;if(!(x instanceof Decimal))return new Decimal(v);if(x.constructor=Decimal,isDecimalInstance(v)){if(x.s=v.s,external)if(!v.d||v.e>Decimal.maxE)x.e=NaN,x.d=null;else if(v.e<Decimal.minE)x.e=0,x.d=[0];else x.e=v.e,x.d=v.d.slice();else x.e=v.e,x.d=v.d?v.d.slice():v.d;return}if(t2=typeof v,t2==="number"){if(v===0){x.s=1/v<0?-1:1,x.e=0,x.d=[0];return}if(v<0)v=-v,x.s=-1;else x.s=1;if(v===~~v&&v<1e7){for(e=0,i2=v;i2>=10;i2/=10)e++;if(external)if(e>Decimal.maxE)x.e=NaN,x.d=null;else if(e<Decimal.minE)x.e=0,x.d=[0];else x.e=e,x.d=[v];else x.e=e,x.d=[v];return}if(v*0!==0){if(!v)x.s=NaN;x.e=NaN,x.d=null;return}return parseDecimal(x,v.toString())}if(t2==="string"){if((i2=v.charCodeAt(0))===45)v=v.slice(1),x.s=-1;else{if(i2===43)v=v.slice(1);x.s=1}return isDecimal.test(v)?parseDecimal(x,v):parseOther(x,v)}if(t2==="bigint"){if(v<0)v=-v,x.s=-1;else x.s=1;return parseDecimal(x,v.toString())}throw Error(invalidArgument+v)}if(Decimal.prototype=P,Decimal.ROUND_UP=0,Decimal.ROUND_DOWN=1,Decimal.ROUND_CEIL=2,Decimal.ROUND_FLOOR=3,Decimal.ROUND_HALF_UP=4,Decimal.ROUND_HALF_DOWN=5,Decimal.ROUND_HALF_EVEN=6,Decimal.ROUND_HALF_CEIL=7,Decimal.ROUND_HALF_FLOOR=8,Decimal.EUCLID=9,Decimal.config=Decimal.set=config,Decimal.clone=clone2,Decimal.isDecimal=isDecimalInstance,Decimal.abs=abs,Decimal.acos=acos,Decimal.acosh=acosh,Decimal.add=add,Decimal.asin=asin,Decimal.asinh=asinh,Decimal.atan=atan,Decimal.atanh=atanh,Decimal.atan2=atan2,Decimal.cbrt=cbrt,Decimal.ceil=ceil,Decimal.clamp=clamp,Decimal.cos=cos,Decimal.cosh=cosh,Decimal.div=div,Decimal.exp=exp,Decimal.floor=floor,Decimal.hypot=hypot,Decimal.ln=ln,Decimal.log=log,Decimal.log10=log10,Decimal.log2=log2,Decimal.max=max,Decimal.min=min,Decimal.mod=mod,Decimal.mul=mul,Decimal.pow=pow,Decimal.random=random,Decimal.round=round,Decimal.sign=sign2,Decimal.sin=sin,Decimal.sinh=sinh,Decimal.sqrt=sqrt,Decimal.sub=sub,Decimal.sum=sum,Decimal.tan=tan,Decimal.tanh=tanh,Decimal.trunc=trunc,obj===void 0)obj={};if(obj){if(obj.defaults!==!0){ps=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"];for(i=0;i<ps.length;)if(!obj.hasOwnProperty(p=ps[i++]))obj[p]=this[p]}}return Decimal.config(obj),Decimal}function div(x,y){return new this(x).div(y)}function exp(x){return new this(x).exp()}function floor(x){return finalise(x=new this(x),x.e+1,3)}function hypot(){var i,n,t2=new this(0);external=!1;for(i=0;i<arguments.length;)if(n=new this(arguments[i++]),!n.d){if(n.s)return external=!0,new this(1/0);t2=n}else if(t2.d)t2=t2.plus(n.times(n));return external=!0,t2.sqrt()}function isDecimalInstance(obj){return obj instanceof Decimal||obj&&obj.toStringTag===tag||!1}function ln(x){return new this(x).ln()}function log(x,y){return new this(x).log(y)}function log2(x){return new this(x).log(2)}function log10(x){return new this(x).log(10)}function max(){return maxOrMin(this,arguments,-1)}function min(){return maxOrMin(this,arguments,1)}function mod(x,y){return new this(x).mod(y)}function mul(x,y){return new this(x).mul(y)}function pow(x,y){return new this(x).pow(y)}function random(sd){var d,e,k2,n,i=0,r=new this(1),rd=[];if(sd===void 0)sd=this.precision;else checkInt32(sd,1,MAX_DIGITS);if(k2=Math.ceil(sd/LOG_BASE),!this.crypto)for(;i<k2;)rd[i++]=Math.random()*1e7|0;else if(crypto.getRandomValues){d=crypto.getRandomValues(new Uint32Array(k2));for(;i<k2;)if(n=d[i],n>=4290000000)d[i]=crypto.getRandomValues(new Uint32Array(1))[0];else rd[i++]=n%1e7}else if(crypto.randomBytes){d=crypto.randomBytes(k2*=4);for(;i<k2;)if(n=d[i]+(d[i+1]<<8)+(d[i+2]<<16)+((d[i+3]&127)<<24),n>=2140000000)crypto.randomBytes(4).copy(d,i);else rd.push(n%1e7),i+=4;i=k2/4}else throw Error(cryptoUnavailable);if(k2=rd[--i],sd%=LOG_BASE,k2&&sd)n=mathpow(10,LOG_BASE-sd),rd[i]=(k2/n|0)*n;for(;rd[i]===0;i--)rd.pop();if(i<0)e=0,rd=[0];else{e=-1;for(;rd[0]===0;e-=LOG_BASE)rd.shift();for(k2=1,n=rd[0];n>=10;n/=10)k2++;if(k2<LOG_BASE)e-=LOG_BASE-k2}return r.e=e,r.d=rd,r}function round(x){return finalise(x=new this(x),x.e+1,this.rounding)}function sign2(x){return x=new this(x),x.d?x.d[0]?x.s:0*x.s:x.s||NaN}function sin(x){return new this(x).sin()}function sinh(x){return new this(x).sinh()}function sqrt(x){return new this(x).sqrt()}function sub(x,y){return new this(x).sub(y)}function sum(){var i=0,args=arguments,x=new this(args[i]);external=!1;for(;x.s&&++i<args.length;)x=x.plus(args[i]);return external=!0,finalise(x,this.precision,this.rounding)}function tan(x){return new this(x).tan()}function tanh(x){return new this(x).tanh()}function trunc(x){return finalise(x=new this(x),x.e+1,1)}P[Symbol.for("nodejs.util.inspect.custom")]=P.toString;P[Symbol.toStringTag]="Decimal";var Decimal=P.constructor=clone2(DEFAULTS);LN10=new Decimal(LN10);PI=new Decimal(PI);var decimal_default=Decimal;function calculateTotal(price,quantity){return new decimal_default(price).times(quantity).toFixed(2)}function formatFloatToFixed(value){return new decimal_default(value).toFixed(2)}var subscriptionLimits={Trial:50,Msingi:50,Lite:300,Business:1/0,Pro:1500,AI:1/0},retentionPeriods={Trial:1,Msingi:3,Lite:6,Pro:12,Business:24,AI:36},prodCheck=async({shopId})=>{let[productsResult,subscriptionResult]=await Promise.all([mainDb.select({total:count()}).from(products).where(eq(products.shopId,shopId)),mainDb.select({subscrib:shops.subscription,trialEnd:shops.trialEnd}).from(shops).where(eq(shops.id,shopId))]),prodCount=productsResult[0]?.total,shopSubscription=subscriptionResult[0]?.subscrib||"Trial",trialEnd=subscriptionResult[0]?.trialEnd,limit=subscriptionLimits[shopSubscription];if(prodCount>limit)return{success:!1,message:`Aina za bidhaa ulizosajili zimetosha, ongeza kifurushi cha juu kufungua aina zaidi ya ${limit}`};return{success:!0,data:{shopSubscription,trialEnd},message:`Umesajili bidhaa ${prodCount} kati ya ${limit}`}},serviceAccessRules={customers:{minLevel:"Lite",message:"Huwezi kuchagua wateja, chagua kifurushi cha Lite au zaidi"},prdFreqCheck:{minLevel:"Business",message:"Ukaguzi wa mara kwa mara unahitaji kifurushi cha Business au juu"},assistant:{minLevel:"Lite",message:"Kusajili msaidizi au mfanyakazi, chagua kifurushi cha Lite au zaidi"},exportCSV:{minLevel:"Lite",message:"Kuhamisha Taarifa kunahitaji kifurushi cha Lite au juu"}},subscriptionHierarchy={Msingi:0,Lite:1,Business:2,Pro:3,AI:4,Trial:1},checkServiceAccess=async({shopId,service})=>{let[shop]=await mainDb.select({subscription:shops.subscription}).from(shops).where(eq(shops.id,shopId));if(!shop)return{success:!1,message:"Duka halijapatikana"};let currentSubscription=shop.subscription,requiredLevel=serviceAccessRules[service].minLevel;if(subscriptionHierarchy[currentSubscription]<subscriptionHierarchy[requiredLevel])return{success:!1,message:serviceAccessRules[service].message};return{success:!0,message:"done!"}};var prodPost=async({body,headers,shopId,userId})=>{try{let{name,priceBought,priceSold,stock,minStock,unit}=body;name=sanitizeString(name).trim().toLowerCase(),priceBought=sanitizeNumber(priceBought),priceSold=sanitizeNumber(priceSold),stock=sanitizeNumber(stock),minStock=sanitizeNumber(minStock),unit=sanitizeString(unit).trim();let prdResult=await prodCheck({shopId});if(!prdResult.success)return{success:!1,message:prdResult.message};if(await mainDb.select().from(products).where(and(eq(products.name,name),eq(products.shopId,shopId))).then((rows)=>rows[0]))return{success:!1,message:"Bidhaa hii tayari ipo"};let[insertedProduct]=await mainDb.insert(products).values({name,priceSold:formatFloatToFixed(priceSold),stock,shopId,minStock,unit}).returning({id:products.id}),productId=insertedProduct.id;if(!insertedProduct||!insertedProduct.id)return{success:!1,message:"Hakuna bidhaa kwa jina hili"};return await mainDb.insert(purchases).values({productId,shopId,quantity:stock,priceBought:formatFloatToFixed(priceBought),totalCost:calculateTotal(String(priceBought),stock)}),{success:!0,data:{name,priceBought,priceSold,stock,minStock,shopId,userId,unit},message:"Umefanikiwa kusajili bidhaa"}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:sanitizeString("Hitilafu imetokea kwenye seva")}}},prodGet=async({userId,shopId,query,set:set2,headers})=>{let page=parseInt(query.page||"1"),limit=parseInt(query.limit||"10"),search=query.search||"",offset=(page-1)*limit,where=and(eq(products.shopId,shopId),search?ilike(products.name,`%${search}%`):void 0);try{let latestPurchase=mainDb.select({productId:purchases.productId,priceBought:purchases.priceBought,rowNumber:sql`ROW_NUMBER() OVER (PARTITION BY ${purchases.productId} ORDER BY ${purchases.createdAt} DESC)`}).from(purchases).where(eq(purchases.shopId,shopId)).as("latestPurchase"),latestOnly=mainDb.select({productId:latestPurchase.productId,priceBought:latestPurchase.priceBought}).from(latestPurchase).where(sql`row_number = 1`).as("latestOnly"),total=await mainDb.select({count:sql`count(*)`}).from(products).where(where).then((rows2)=>Number(rows2[0].count)),rows=await mainDb.select({id:products.id,name:products.name,priceSold:products.priceSold,stock:products.stock,shopId:products.shopId,minStock:products.minStock,status:products.status,unit:products.unit,createdAt:products.createdAt,updatedAt:products.updatedAt,priceBought:latestOnly.priceBought}).from(products).where(where).leftJoin(latestOnly,eq(products.id,latestOnly.productId)).orderBy(desc(products.createdAt)).limit(limit).offset(offset);if(rows.length===0)return set2.status=204,{success:!1,data:[],total};return set2.status=200,{success:!0,data:rows.map((row)=>({...row,priceSold:Number(row.priceSold),priceBought:row.priceBought!==null?Number(row.priceBought):null})),total}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:sanitizeString("Hitilafu imetokea kwenye seva")}}},prodDel=async({userId,shopId,productId,headers})=>{try{if(!await mainDb.select().from(products).where(and(eq(products.id,productId),eq(products.shopId,shopId))).then((rows)=>rows[0]))return{success:!1,message:"Hakuna bidhaa kwa jina hili"};return await mainDb.delete(products).where(eq(products.id,productId)),{success:!0,message:"Bidhaa imeondolewa kwa mafanikio"}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:sanitizeString("Hitilafu imetokea kwenye seva")}}},prodSearch=async({shopId,userId,query})=>{try{return console.log("Search:",query),{success:!0,data:await mainDb.select({name:products.name}).from(products).where(eq(products.shopId,shopId)&&ilike(products.name,`%${query}%`)).limit(10),message:"Umefanikiwa kupata bidhaa."}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu kwenye seva"}}},prodUpdate=async({userId,shopId,productId,body,headers})=>{try{let{name,priceBought,priceSold,stock,minStock,unit}=body;if(name=sanitizeString(name),priceBought=sanitizeNumber(priceBought),priceSold=sanitizeNumber(priceSold),stock=sanitizeNumber(stock),minStock=sanitizeNumber(minStock),unit=sanitizeString(unit),!await mainDb.select().from(products).where(and(eq(products.id,productId),eq(products.shopId,shopId))).then((rows)=>rows[0]))return{success:!1,message:"Hakuna bidhaa kwa jina hili"};let sanitizedStock=Math.max(0,stock);await mainDb.update(products).set({name,stock:sanitizedStock,minStock,unit,status:sanitizedStock<=0?"finished":"available",priceSold:formatFloatToFixed(priceSold),updatedAt:new Date}).where(eq(products.id,productId)),await mainDb.update(purchases).set({quantity:sanitizedStock,priceBought:formatFloatToFixed(priceBought),totalCost:calculateTotal(String(priceBought),sanitizedStock)}).where(eq(purchases.productId,productId));let updatedProduct=await mainDb.select({id:products.id,name:products.name,stock:products.stock,minStock:products.minStock,unit:products.unit,status:products.status,priceSold:products.priceSold,updatedAt:products.updatedAt,priceBought:purchases.priceBought}).from(products).leftJoin(purchases,eq(products.id,purchases.productId)).where(eq(products.id,productId)).limit(1).then((rows)=>rows[0]);if(!updatedProduct)throw new Error("Hakuna bidhaa kwa jina hili");return{success:!0,data:updatedProduct,message:"Umefanikiwa ku-update bidhaa"}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:sanitizeString("Hitilafu imetokea kwenye seva")}}},QrPost=async({body,headers,userId,shopId})=>{try{let{calculatedTotal,quantity,saleType,discount,description,typeDetected,productId,priceSold,priceBought,supplierId,customerId}=body;switch(saleType=sanitizeString(saleType),calculatedTotal=sanitizeNumber(calculatedTotal),quantity=sanitizeNumber(quantity),discount=sanitizeNumber(discount),typeDetected=sanitizeString(typeDetected),description=sanitizeString(description),productId=sanitizeString(productId),priceSold=sanitizeNumber(priceSold),priceBought=sanitizeNumber(priceBought),customerId=sanitizeString(customerId),typeDetected){case"expenses":return await mainDb.insert(expenses).values({description,amount:formatFloatToFixed(calculatedTotal),shopId}),{success:!0,message:"Matumizi yamehifadhiwa kikamilifu"};case"sales":{let current=await mainDb.select({stock:products.stock}).from(products).where(eq(products.id,productId)).then((res)=>res[0]);if(!current||current.stock<quantity)return{success:!1,message:"Bidhaa haina stock ya kutosha"};if(await mainDb.update(products).set({stock:sql`${products.stock} - ${quantity}`}).where(eq(products.id,productId)),current.stock-quantity<=0)await mainDb.update(products).set({status:"finished"}).where(eq(products.id,productId));if(saleType==="cash")await mainDb.insert(sales).values({productId,quantity,priceSold:formatFloatToFixed(priceSold),totalSales:formatFloatToFixed(calculatedTotal),discount,shopId,saleType:"cash",customerId:null});else await mainDb.insert(debts).values({customerId,productId,quantity,priceSold:formatFloatToFixed(priceSold),totalSales:formatFloatToFixed(calculatedTotal),totalAmount:formatFloatToFixed(calculatedTotal),remainingAmount:formatFloatToFixed(calculatedTotal),shopId});return{success:!0,message:"Mauzo yamehifadhiwa kiukamilifu"}}case"purchases":return await mainDb.update(products).set({stock:sql`${products.stock} + ${quantity}`}).where(eq(products.id,productId)),await mainDb.insert(purchases).values({productId,shopId,quantity,priceBought:formatFloatToFixed(priceBought),totalCost:formatFloatToFixed(calculatedTotal)}),{success:!0,message:"Manunuzi yamehifadhiwa kiukamilifu"};default:return{success:!1,message:"Aina ya muamala haijatambuliwa"}}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu kwenye seva"}}};var JWT_SECRET4=process.env.JWT_TOKEN||"something@#morecomplicated<>es>??><Ess5%",prodPlugin=new Elysia().use(index_default({name:"jwt",secret:JWT_SECRET4})).get("/products",async({jwt:jwt2,cookie:cookie2,headers,query})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;return await prodGet({userId,shopId,headers,query,set:{status:200}})}).get("/productSearch",async({jwt:jwt2,cookie:cookie2,headers,query})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;let search=query.search||"";return await prodSearch({userId,shopId,query:search})}).post("/products",async({jwt:jwt2,cookie:cookie2,body,headers})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;return await prodPost({body,userId,shopId,headers})},{body:prodData}).delete("/products/:id",async({jwt:jwt2,cookie:cookie2,set:set2,params,headers})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;let productId=params.id;if(!productId)return set2.status=400,{success:!1,message:"Product ID is required."};return await prodDel({userId,shopId,headers,productId})}).put("/products/:id",async({jwt:jwt2,cookie:cookie2,set:set2,params,body,headers})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;let productId=params.id;if(!productId)return set2.status=400,{success:!1,message:"Product ID is required."};return await prodUpdate({body,userId,shopId,headers,productId})},{body:prodUpdateValidation}).post("/get-data",async({jwt:jwt2,cookie:cookie2,body,headers})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;return await QrPost({body,userId,shopId,headers})},{body:QrPostData});var import_nodemailer2=__toESM(require_nodemailer(),1),import_config2=__toESM(require_config(),1);var zohoEmail="huduma@mypostech.store",transporter=import_nodemailer2.default.createTransport({host:"smtp.zoho.com",port:465,secure:!0,auth:{user:zohoEmail,pass:process.env.ZOHO_APP_PASSWORD}}),mailPlugin=new Elysia;mailPlugin.post("/sendMail",async({body})=>{try{let{name,email,message:message2}=body;if(name=sanitizeString(name),email=sanitizeString(email),message2=sanitizeString(message2),!name||!email||!message2)return new Response(JSON.stringify({success:!1,message:"Sehemu zote zinahitajika"}),{status:400});return await transporter.sendMail({from:`"${name}" <${zohoEmail}>`,to:process.env.TO_EMAIL,subject:"myPosTech message",html:`
            <!DOCTYPE html>
            <html lang="sw">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Contact Form Submission</title>
            </head>
            <body>
                <div style="font-family: Arial, sans-serif; font-size: 14px; color: #333333; line-height: 1.6; padding: 20px; background-color: #f4f4f4;">
                    <h2 style="color: #0056b3; font-size: 18px; margin-bottom: 20px;">New Contact Form Submission</h2>
                    <p style="margin: 0 0 10px 0;">
                        <strong style="font-weight: bold; color: #555555;">Name:</strong> <span style="font-weight: normal;">${name}</span>
                    </p>
                    <p style="margin: 0 0 10px 0;">
                        <strong style="font-weight: bold; color: #555555;">Email:</strong> <span style="font-weight: normal; color: #007bff;"><a href="mailto:${email}" style="color: #007bff; text-decoration: none;">${email}</a></span>
                    </p>
                    <p style="margin: 0 0 10px 0;">
                        <strong style="font-weight: bold; color: #555555;">Message:</strong>
                    </p>
                    <p style="margin: 0 0 10px 0; padding: 10px; border: 1px solid #dddddd; background-color: #ffffff;">
                        ${message2}
                    </p>
                    <p style="font-size: 12px; color: #888888; margin-top: 20px;">
                        This email was sent from your website's contact form.
                    </p>
                </div>
            </body>
            </html>
            `}),new Response(JSON.stringify({success:!0,message:"Ujumbe wako umetumwa kiukamilifu!"}),{status:200})}catch(error2){return console.error("Email Error:",error2),new Response(JSON.stringify({success:!1,error:"Imeshindwa kutuma barua pepe"}),{status:500})}},{body:emailData});var customerPost=async({body,userId,shopId,headers})=>{try{console.time("customerPost");let{name,contact}=body;if(name=sanitizeString(name.trim().toLowerCase()),contact=sanitizeString(contact.trim().toLowerCase()),(await mainDb.select({name:customers.name,contact:customers.contact}).from(customers).where(and(eq(customers.shopId,shopId),or(eq(customers.name,name),eq(customers.contact,contact))))).length>0)return{success:!1,message:"Mteja huyu tayari yupo au namba za simu zimesajiliwa"};let data=(await mainDb.insert(customers).values({name,contact,shopId}).returning())[0];return console.timeEnd("customerPost"),{success:!0,message:"Umefanikiwa kuingiza mteja",data}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu imetokea kwenye seva"}}},customerGet=async({userId,shopId,headers,query})=>{let page=parseInt(query.page||"1"),limit=parseInt(query.limit||"5"),search=query.search||"",offset=(page-1)*limit;try{let where=and(eq(customers.shopId,shopId),search?ilike(customers.name,`%${search}%`):void 0),total=await mainDb.select({count:sql`count(*)`}).from(customers).where(where).then((rows)=>Number(rows[0].count)),existingCustomer=await mainDb.select().from(customers).where(where).orderBy(customers.createdAt).limit(limit).offset(offset);if(existingCustomer.length===0)return{success:!1,message:"Hakuna mteja aliyeingizwa",data:[],total};return{success:!0,message:"Umefanikiwa kupata taarifa",data:existingCustomer,total,page,limit,pages:Math.ceil(total/limit)}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:sanitizeString("Hitilafu imetokea kwenye seva")}}},customerFetch=async({userId,shopId,headers})=>{try{let existingCustomer=await mainDb.select().from(customers).where(eq(customers.shopId,shopId));if(existingCustomer.length===0)return{success:!1,message:"Hakuna mteja aliyeingizwa",data:[]};return{success:!0,data:existingCustomer}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:sanitizeString("Hitilafu imetokea kwenye seva")}}},CustomerDel=async({userId,shopId,customerId,headers})=>{try{if(!await mainDb.select().from(customers).where(and(eq(customers.shopId,shopId),eq(customers.id,customerId))).then((rows)=>rows[0]))return{success:!1,message:"Hakuna bidhaa kwa jina hili"};return await mainDb.delete(customers).where(and(eq(customers.id,customerId),eq(customers.shopId,shopId))),{success:!0,message:"Mteja ameondolewa kwa mafanikio"}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:sanitizeString("Hitilafu imetokea kwenye seva")}}},customerUpdate=async({userId,shopId,customerId,body,headers})=>{try{let{name,contact}=body;if(name=sanitizeString(name).trim(),contact=sanitizeString(contact).trim(),!await mainDb.select().from(customers).where(and(eq(customers.id,customerId),eq(customers.shopId,shopId))).then((rows)=>rows[0]))return{success:!1,message:"Hakuna mteja kwa jina hili"};return{success:!0,data:await mainDb.update(customers).set({name,contact}).where(and(eq(customers.id,customerId),eq(customers.shopId,shopId))),message:"Umefanikiwa ku-update taarifa"}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:sanitizeString("Hitilafu imetokea kwenye seva")}}},customerSearch=async({shopId,userId,query})=>{try{return{success:!0,data:await mainDb.select({name:customers.name}).from(customers).where(eq(customers.shopId,shopId)&&ilike(customers.name,`%${query}%`)).limit(10),message:"Umefanikiwa kupata wateja"}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu kwenye seva"}}};var JWT_SECRET5=process.env.JWT_TOKEN||"something@#morecomplicated<>es>??><Ess5%",CustomersPlugin=new Elysia().use(index_default({name:"jwt",secret:JWT_SECRET5})).get("/customers",async({jwt:jwt2,cookie:cookie2,headers,query})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;return await customerGet({userId,shopId,headers,query})}).get("/customerSearch",async({jwt:jwt2,cookie:cookie2,headers,query})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;let search=query.search||"";return await customerSearch({userId,shopId,query:search})}).get("/getCustomers",async({jwt:jwt2,cookie:cookie2,headers})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;let customerCheck=await checkServiceAccess({shopId,service:"customers"});if(!customerCheck.success)return{success:!1,message:customerCheck.message};return await customerFetch({userId,shopId,headers})}).post("/customers",async({jwt:jwt2,cookie:cookie2,body,headers})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;return await customerPost({body,userId,shopId,headers})},{body:customerData}).delete("/customers/:id",async({jwt:jwt2,cookie:cookie2,set:set2,params,headers})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;let customerId=params.id;if(!customerId)return set2.status=400,{success:!1,message:"Mteja anahitajika."};return await CustomerDel({userId,shopId,headers,customerId})}).put("/customers/:id",async({jwt:jwt2,cookie:cookie2,set:set2,params,body,headers})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;let customerId=params.id;if(!customerId)return set2.status=400,{success:!1,message:"Mteja anahitajika."};return await customerUpdate({body,userId,shopId,headers,customerId})},{body:customerData});var maxTime=Math.pow(10,8)*24*60*60*1000,minTime=-maxTime;var millisecondsInDay=86400000,millisecondsInMinute=60000,millisecondsInHour=3600000;var minutesInMonth=43200,minutesInDay=1440;var constructFromSymbol=Symbol.for("constructDateFrom");function constructFrom(date3,value){if(typeof date3==="function")return date3(value);if(date3&&typeof date3==="object"&&constructFromSymbol in date3)return date3[constructFromSymbol](value);if(date3 instanceof Date)return new date3.constructor(value);return new Date(value)}function toDate(argument,context){return constructFrom(context||argument,argument)}var defaultOptions={};function getDefaultOptions(){return defaultOptions}function getTimezoneOffsetInMilliseconds(date3){let _date=toDate(date3),utcDate=new Date(Date.UTC(_date.getFullYear(),_date.getMonth(),_date.getDate(),_date.getHours(),_date.getMinutes(),_date.getSeconds(),_date.getMilliseconds()));return utcDate.setUTCFullYear(_date.getFullYear()),+date3-+utcDate}function normalizeDates(context,...dates){let normalize=constructFrom.bind(null,context||dates.find((date3)=>typeof date3==="object"));return dates.map(normalize)}function startOfDay(date3,options){let _date=toDate(date3,options?.in);return _date.setHours(0,0,0,0),_date}function differenceInCalendarDays(laterDate,earlierDate,options){let[laterDate_,earlierDate_]=normalizeDates(options?.in,laterDate,earlierDate),laterStartOfDay=startOfDay(laterDate_),earlierStartOfDay=startOfDay(earlierDate_),laterTimestamp=+laterStartOfDay-getTimezoneOffsetInMilliseconds(laterStartOfDay),earlierTimestamp=+earlierStartOfDay-getTimezoneOffsetInMilliseconds(earlierStartOfDay);return Math.round((laterTimestamp-earlierTimestamp)/millisecondsInDay)}function compareAsc(dateLeft,dateRight){let diff=+toDate(dateLeft)-+toDate(dateRight);if(diff<0)return-1;else if(diff>0)return 1;return diff}function constructNow(date3){return constructFrom(date3,Date.now())}function differenceInCalendarMonths(laterDate,earlierDate,options){let[laterDate_,earlierDate_]=normalizeDates(options?.in,laterDate,earlierDate),yearsDiff=laterDate_.getFullYear()-earlierDate_.getFullYear(),monthsDiff=laterDate_.getMonth()-earlierDate_.getMonth();return yearsDiff*12+monthsDiff}function differenceInDays(laterDate,earlierDate,options){let[laterDate_,earlierDate_]=normalizeDates(options?.in,laterDate,earlierDate),sign3=compareLocalAsc(laterDate_,earlierDate_),difference=Math.abs(differenceInCalendarDays(laterDate_,earlierDate_));laterDate_.setDate(laterDate_.getDate()-sign3*difference);let isLastDayNotFull=Number(compareLocalAsc(laterDate_,earlierDate_)===-sign3),result=sign3*(difference-isLastDayNotFull);return result===0?0:result}function compareLocalAsc(laterDate,earlierDate){let diff=laterDate.getFullYear()-earlierDate.getFullYear()||laterDate.getMonth()-earlierDate.getMonth()||laterDate.getDate()-earlierDate.getDate()||laterDate.getHours()-earlierDate.getHours()||laterDate.getMinutes()-earlierDate.getMinutes()||laterDate.getSeconds()-earlierDate.getSeconds()||laterDate.getMilliseconds()-earlierDate.getMilliseconds();if(diff<0)return-1;if(diff>0)return 1;return diff}function getRoundingMethod(method){return(number)=>{let result=(method?Math[method]:Math.trunc)(number);return result===0?0:result}}function differenceInHours(laterDate,earlierDate,options){let[laterDate_,earlierDate_]=normalizeDates(options?.in,laterDate,earlierDate),diff=(+laterDate_-+earlierDate_)/millisecondsInHour;return getRoundingMethod(options?.roundingMethod)(diff)}function differenceInMilliseconds(laterDate,earlierDate){return+toDate(laterDate)-+toDate(earlierDate)}function differenceInMinutes(dateLeft,dateRight,options){let diff=differenceInMilliseconds(dateLeft,dateRight)/millisecondsInMinute;return getRoundingMethod(options?.roundingMethod)(diff)}function endOfDay(date3,options){let _date=toDate(date3,options?.in);return _date.setHours(23,59,59,999),_date}function endOfMonth(date3,options){let _date=toDate(date3,options?.in),month=_date.getMonth();return _date.setFullYear(_date.getFullYear(),month+1,0),_date.setHours(23,59,59,999),_date}function isLastDayOfMonth(date3,options){let _date=toDate(date3,options?.in);return+endOfDay(_date,options)===+endOfMonth(_date,options)}function differenceInMonths(laterDate,earlierDate,options){let[laterDate_,workingLaterDate,earlierDate_]=normalizeDates(options?.in,laterDate,laterDate,earlierDate),sign3=compareAsc(workingLaterDate,earlierDate_),difference=Math.abs(differenceInCalendarMonths(workingLaterDate,earlierDate_));if(difference<1)return 0;if(workingLaterDate.getMonth()===1&&workingLaterDate.getDate()>27)workingLaterDate.setDate(30);workingLaterDate.setMonth(workingLaterDate.getMonth()-sign3*difference);let isLastMonthNotFull=compareAsc(workingLaterDate,earlierDate_)===-sign3;if(isLastDayOfMonth(laterDate_)&&difference===1&&compareAsc(laterDate_,earlierDate_)===1)isLastMonthNotFull=!1;let result=sign3*(difference-+isLastMonthNotFull);return result===0?0:result}function differenceInSeconds(laterDate,earlierDate,options){let diff=differenceInMilliseconds(laterDate,earlierDate)/1000;return getRoundingMethod(options?.roundingMethod)(diff)}var formatDistanceLocale={lessThanXSeconds:{one:"less than a second",other:"less than {{count}} seconds"},xSeconds:{one:"1 second",other:"{{count}} seconds"},halfAMinute:"half a minute",lessThanXMinutes:{one:"less than a minute",other:"less than {{count}} minutes"},xMinutes:{one:"1 minute",other:"{{count}} minutes"},aboutXHours:{one:"about 1 hour",other:"about {{count}} hours"},xHours:{one:"1 hour",other:"{{count}} hours"},xDays:{one:"1 day",other:"{{count}} days"},aboutXWeeks:{one:"about 1 week",other:"about {{count}} weeks"},xWeeks:{one:"1 week",other:"{{count}} weeks"},aboutXMonths:{one:"about 1 month",other:"about {{count}} months"},xMonths:{one:"1 month",other:"{{count}} months"},aboutXYears:{one:"about 1 year",other:"about {{count}} years"},xYears:{one:"1 year",other:"{{count}} years"},overXYears:{one:"over 1 year",other:"over {{count}} years"},almostXYears:{one:"almost 1 year",other:"almost {{count}} years"}},formatDistance=(token,count2,options)=>{let result,tokenValue=formatDistanceLocale[token];if(typeof tokenValue==="string")result=tokenValue;else if(count2===1)result=tokenValue.one;else result=tokenValue.other.replace("{{count}}",count2.toString());if(options?.addSuffix)if(options.comparison&&options.comparison>0)return"in "+result;else return result+" ago";return result};function buildFormatLongFn(args){return(options={})=>{let width=options.width?String(options.width):args.defaultWidth;return args.formats[width]||args.formats[args.defaultWidth]}}var dateFormats={full:"EEEE, MMMM do, y",long:"MMMM do, y",medium:"MMM d, y",short:"MM/dd/yyyy"},timeFormats={full:"h:mm:ss a zzzz",long:"h:mm:ss a z",medium:"h:mm:ss a",short:"h:mm a"},dateTimeFormats={full:"{{date}} 'at' {{time}}",long:"{{date}} 'at' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},formatLong={date:buildFormatLongFn({formats:dateFormats,defaultWidth:"full"}),time:buildFormatLongFn({formats:timeFormats,defaultWidth:"full"}),dateTime:buildFormatLongFn({formats:dateTimeFormats,defaultWidth:"full"})};var formatRelativeLocale={lastWeek:"'last' eeee 'at' p",yesterday:"'yesterday at' p",today:"'today at' p",tomorrow:"'tomorrow at' p",nextWeek:"eeee 'at' p",other:"P"},formatRelative=(token,_date,_baseDate,_options)=>formatRelativeLocale[token];function buildLocalizeFn(args){return(value,options)=>{let context=options?.context?String(options.context):"standalone",valuesArray;if(context==="formatting"&&args.formattingValues){let defaultWidth=args.defaultFormattingWidth||args.defaultWidth,width=options?.width?String(options.width):defaultWidth;valuesArray=args.formattingValues[width]||args.formattingValues[defaultWidth]}else{let defaultWidth=args.defaultWidth,width=options?.width?String(options.width):args.defaultWidth;valuesArray=args.values[width]||args.values[defaultWidth]}let index2=args.argumentCallback?args.argumentCallback(value):value;return valuesArray[index2]}}var eraValues={narrow:["B","A"],abbreviated:["BC","AD"],wide:["Before Christ","Anno Domini"]},quarterValues={narrow:["1","2","3","4"],abbreviated:["Q1","Q2","Q3","Q4"],wide:["1st quarter","2nd quarter","3rd quarter","4th quarter"]},monthValues={narrow:["J","F","M","A","M","J","J","A","S","O","N","D"],abbreviated:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],wide:["January","February","March","April","May","June","July","August","September","October","November","December"]},dayValues={narrow:["S","M","T","W","T","F","S"],short:["Su","Mo","Tu","We","Th","Fr","Sa"],abbreviated:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],wide:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},dayPeriodValues={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"}},formattingDayPeriodValues={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"}},ordinalNumber=(dirtyNumber,_options)=>{let number=Number(dirtyNumber),rem100=number%100;if(rem100>20||rem100<10)switch(rem100%10){case 1:return number+"st";case 2:return number+"nd";case 3:return number+"rd"}return number+"th"},localize={ordinalNumber,era:buildLocalizeFn({values:eraValues,defaultWidth:"wide"}),quarter:buildLocalizeFn({values:quarterValues,defaultWidth:"wide",argumentCallback:(quarter)=>quarter-1}),month:buildLocalizeFn({values:monthValues,defaultWidth:"wide"}),day:buildLocalizeFn({values:dayValues,defaultWidth:"wide"}),dayPeriod:buildLocalizeFn({values:dayPeriodValues,defaultWidth:"wide",formattingValues:formattingDayPeriodValues,defaultFormattingWidth:"wide"})};function buildMatchFn(args){return(string,options={})=>{let width=options.width,matchPattern=width&&args.matchPatterns[width]||args.matchPatterns[args.defaultMatchWidth],matchResult=string.match(matchPattern);if(!matchResult)return null;let matchedString=matchResult[0],parsePatterns=width&&args.parsePatterns[width]||args.parsePatterns[args.defaultParseWidth],key=Array.isArray(parsePatterns)?findIndex(parsePatterns,(pattern)=>pattern.test(matchedString)):findKey(parsePatterns,(pattern)=>pattern.test(matchedString)),value;value=args.valueCallback?args.valueCallback(key):key,value=options.valueCallback?options.valueCallback(value):value;let rest=string.slice(matchedString.length);return{value,rest}}}function findKey(object,predicate){for(let key in object)if(Object.prototype.hasOwnProperty.call(object,key)&&predicate(object[key]))return key;return}function findIndex(array,predicate){for(let key=0;key<array.length;key++)if(predicate(array[key]))return key;return}function buildMatchPatternFn(args){return(string,options={})=>{let matchResult=string.match(args.matchPattern);if(!matchResult)return null;let matchedString=matchResult[0],parseResult=string.match(args.parsePattern);if(!parseResult)return null;let value=args.valueCallback?args.valueCallback(parseResult[0]):parseResult[0];value=options.valueCallback?options.valueCallback(value):value;let rest=string.slice(matchedString.length);return{value,rest}}}var matchOrdinalNumberPattern=/^(\d+)(th|st|nd|rd)?/i,parseOrdinalNumberPattern=/\d+/i,matchEraPatterns={narrow:/^(b|a)/i,abbreviated:/^(b\.?\s?c\.?|b\.?\s?c\.?\s?e\.?|a\.?\s?d\.?|c\.?\s?e\.?)/i,wide:/^(before christ|before common era|anno domini|common era)/i},parseEraPatterns={any:[/^b/i,/^(a|c)/i]},matchQuarterPatterns={narrow:/^[1234]/i,abbreviated:/^q[1234]/i,wide:/^[1234](th|st|nd|rd)? quarter/i},parseQuarterPatterns={any:[/1/i,/2/i,/3/i,/4/i]},matchMonthPatterns={narrow:/^[jfmasond]/i,abbreviated:/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i,wide:/^(january|february|march|april|may|june|july|august|september|october|november|december)/i},parseMonthPatterns={narrow:[/^j/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^ja/i,/^f/i,/^mar/i,/^ap/i,/^may/i,/^jun/i,/^jul/i,/^au/i,/^s/i,/^o/i,/^n/i,/^d/i]},matchDayPatterns={narrow:/^[smtwf]/i,short:/^(su|mo|tu|we|th|fr|sa)/i,abbreviated:/^(sun|mon|tue|wed|thu|fri|sat)/i,wide:/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)/i},parseDayPatterns={narrow:[/^s/i,/^m/i,/^t/i,/^w/i,/^t/i,/^f/i,/^s/i],any:[/^su/i,/^m/i,/^tu/i,/^w/i,/^th/i,/^f/i,/^sa/i]},matchDayPeriodPatterns={narrow:/^(a|p|mi|n|(in the|at) (morning|afternoon|evening|night))/i,any:/^([ap]\.?\s?m\.?|midnight|noon|(in the|at) (morning|afternoon|evening|night))/i},parseDayPeriodPatterns={any:{am:/^a/i,pm:/^p/i,midnight:/^mi/i,noon:/^no/i,morning:/morning/i,afternoon:/afternoon/i,evening:/evening/i,night:/night/i}},match={ordinalNumber:buildMatchPatternFn({matchPattern:matchOrdinalNumberPattern,parsePattern:parseOrdinalNumberPattern,valueCallback:(value)=>parseInt(value,10)}),era:buildMatchFn({matchPatterns:matchEraPatterns,defaultMatchWidth:"wide",parsePatterns:parseEraPatterns,defaultParseWidth:"any"}),quarter:buildMatchFn({matchPatterns:matchQuarterPatterns,defaultMatchWidth:"wide",parsePatterns:parseQuarterPatterns,defaultParseWidth:"any",valueCallback:(index2)=>index2+1}),month:buildMatchFn({matchPatterns:matchMonthPatterns,defaultMatchWidth:"wide",parsePatterns:parseMonthPatterns,defaultParseWidth:"any"}),day:buildMatchFn({matchPatterns:matchDayPatterns,defaultMatchWidth:"wide",parsePatterns:parseDayPatterns,defaultParseWidth:"any"}),dayPeriod:buildMatchFn({matchPatterns:matchDayPeriodPatterns,defaultMatchWidth:"any",parsePatterns:parseDayPeriodPatterns,defaultParseWidth:"any"})};var enUS={code:"en-US",formatDistance,formatLong,formatRelative,localize,match,options:{weekStartsOn:0,firstWeekContainsDate:1}};function formatDistance2(laterDate,earlierDate,options){let defaultOptions2=getDefaultOptions(),locale=options?.locale??defaultOptions2.locale??enUS,minutesInAlmostTwoDays=2520,comparison=compareAsc(laterDate,earlierDate);if(isNaN(comparison))throw new RangeError("Invalid time value");let localizeOptions=Object.assign({},options,{addSuffix:options?.addSuffix,comparison}),[laterDate_,earlierDate_]=normalizeDates(options?.in,...comparison>0?[earlierDate,laterDate]:[laterDate,earlierDate]),seconds=differenceInSeconds(earlierDate_,laterDate_),offsetInSeconds=(getTimezoneOffsetInMilliseconds(earlierDate_)-getTimezoneOffsetInMilliseconds(laterDate_))/1000,minutes=Math.round((seconds-offsetInSeconds)/60),months;if(minutes<2)if(options?.includeSeconds)if(seconds<5)return locale.formatDistance("lessThanXSeconds",5,localizeOptions);else if(seconds<10)return locale.formatDistance("lessThanXSeconds",10,localizeOptions);else if(seconds<20)return locale.formatDistance("lessThanXSeconds",20,localizeOptions);else if(seconds<40)return locale.formatDistance("halfAMinute",0,localizeOptions);else if(seconds<60)return locale.formatDistance("lessThanXMinutes",1,localizeOptions);else return locale.formatDistance("xMinutes",1,localizeOptions);else if(minutes===0)return locale.formatDistance("lessThanXMinutes",1,localizeOptions);else return locale.formatDistance("xMinutes",minutes,localizeOptions);else if(minutes<45)return locale.formatDistance("xMinutes",minutes,localizeOptions);else if(minutes<90)return locale.formatDistance("aboutXHours",1,localizeOptions);else if(minutes<minutesInDay){let hours=Math.round(minutes/60);return locale.formatDistance("aboutXHours",hours,localizeOptions)}else if(minutes<2520)return locale.formatDistance("xDays",1,localizeOptions);else if(minutes<minutesInMonth){let days=Math.round(minutes/minutesInDay);return locale.formatDistance("xDays",days,localizeOptions)}else if(minutes<minutesInMonth*2)return months=Math.round(minutes/minutesInMonth),locale.formatDistance("aboutXMonths",months,localizeOptions);if(months=differenceInMonths(earlierDate_,laterDate_),months<12){let nearestMonth=Math.round(minutes/minutesInMonth);return locale.formatDistance("xMonths",nearestMonth,localizeOptions)}else{let monthsSinceStartOfYear=months%12,years=Math.trunc(months/12);if(monthsSinceStartOfYear<3)return locale.formatDistance("aboutXYears",years,localizeOptions);else if(monthsSinceStartOfYear<9)return locale.formatDistance("overXYears",years,localizeOptions);else return locale.formatDistance("almostXYears",years+1,localizeOptions)}}function formatDistanceToNow(date3,options){return formatDistance2(date3,constructNow(date3),options)}function timeRemainingUntil(dateStr){let targetDate=new Date(dateStr),now=new Date;if(targetDate<now)return"Imepita";let minutes=differenceInMinutes(targetDate,now),hours=differenceInHours(targetDate,now),days=differenceInDays(targetDate,now),months=differenceInMonths(targetDate,now);if(minutes<60)return`Zimebaki dakika ${minutes}`;if(hours<24)return`Zimebaki saa ${hours}`;if(days<31)return`Zimebaki siku ${days}`;if(months<12)return`Zimebaki miezi ${months}`;return`Zimebaki: ${formatDistanceToNow(targetDate,{addSuffix:!0})}`}var getAnalytics=async({userId,shopId})=>{try{console.time("Analytics");let[profitData,lowestStockProductResult,lowStockProductsResult,mostSoldByQuantityProductResult,debtorData,weeklySummaryData]=await Promise.all([mainDb.execute(sql`
            SELECT
                p.id AS productId,
                p.name AS productName,
                COALESCE(s.totalSales, 0) AS totalSales,
                COALESCE(pur.totalCost, 0) AS totalCost,
                COALESCE(s.totalSales, 0) - COALESCE(pur.totalCost, 0) AS profit
            FROM products p
            LEFT JOIN (
                SELECT product_id, SUM(quantity * price_sold) AS totalSales
                FROM sales
                WHERE shop_id = ${shopId}
                GROUP BY product_id
            ) s ON s.product_id = p.id
            LEFT JOIN (
                SELECT product_id, SUM(quantity * price_bought) AS totalCost
                FROM purchases
                WHERE shop_id = ${shopId}
                GROUP BY product_id
            ) pur ON pur.product_id = p.id
            WHERE p.shop_id = ${shopId}
            ORDER BY profit DESC
        `),mainDb.select().from(products).where(and(eq(products.shopId,shopId),lte(products.stock,products.minStock))).orderBy(asc(products.stock)).limit(1),mainDb.select().from(products).where(and(eq(products.shopId,shopId),lte(products.stock,products.minStock))).orderBy(asc(products.stock)),mainDb.execute(sql`
                SELECT
                    p.id AS productId,
                    p.name AS productName,
                    p.unit AS unit,
                    SUM(s.quantity) AS totalQuantitySold,
                    COUNT(*) AS timesSold
                FROM sales s
                INNER JOIN products p ON s.product_id = p.id
                WHERE s.shop_id = ${shopId}
                GROUP BY p.id, p.name, p.unit
                ORDER BY totalQuantitySold DESC
                LIMIT 1
            `),Promise.all([mainDb.select({debtId:debts.id,customerId:debts.customerId,remainingAmount:debts.remainingAmount,createdAt:debts.createdAt,name:customers.name}).from(debts).where(eq(debts.shopId,shopId)).innerJoin(customers,eq(customers.id,debts.customerId)).orderBy(asc(debts.createdAt)).limit(1),mainDb.select({debtId:debts.id,customerId:debts.customerId,remainingAmount:debts.remainingAmount,createdAt:debts.createdAt,name:customers.name}).from(debts).where(eq(debts.shopId,shopId)).innerJoin(customers,eq(customers.id,debts.customerId)).orderBy(desc(debts.remainingAmount)).limit(1)]),mainDb.execute(sql`
              WITH sales_data AS (
                  SELECT TO_CHAR(created_at, 'Dy') AS day, SUM(total_sales) AS daily_sales
                  FROM sales
                  WHERE shop_id = ${shopId} AND created_at >= NOW() - INTERVAL '7 days'
                  GROUP BY 1
              ),
              expenses_data AS (
                  SELECT TO_CHAR(date, 'Dy') AS day, SUM(amount) AS daily_expenses
                  FROM expenses
                  WHERE shop_id = ${shopId} AND date >= NOW() - INTERVAL '7 days'
                  GROUP BY 1
              ),
              purchases_data AS (
                  SELECT TO_CHAR(created_at, 'Dy') AS day, SUM(quantity * price_bought) AS daily_purchases
                  FROM purchases
                  WHERE shop_id = ${shopId} AND created_at >= NOW() - INTERVAL '7 days'
                  GROUP BY 1
              ),
              profits_data AS (
                  SELECT 
                    TO_CHAR(s.created_at, 'Dy') AS day,
                    SUM(s.total_sales - (COALESCE(p.price_bought, 0) * s.quantity)) AS daily_profit
                  FROM sales s
                  LEFT JOIN purchases p ON s.product_id = p.product_id
                  WHERE s.shop_id = ${shopId} AND s.created_at >= NOW() - INTERVAL '7 days'
                  GROUP BY 1
              )
              SELECT
                COALESCE(sd.day, ed.day, pd.day, prd.day) AS day,
                COALESCE(sd.daily_sales, 0) AS sales,
                COALESCE(ed.daily_expenses, 0) AS expenses,
                COALESCE(pd.daily_purchases, 0) AS purchases,
                COALESCE(prd.daily_profit, 0) AS profit
              FROM sales_data sd
              FULL OUTER JOIN expenses_data ed ON sd.day = ed.day
              FULL OUTER JOIN purchases_data pd ON COALESCE(sd.day, ed.day) = pd.day
              FULL OUTER JOIN profits_data prd ON COALESCE(sd.day, ed.day, pd.day) = prd.day
              ORDER BY
                CASE COALESCE(sd.day, ed.day, pd.day, prd.day)
                  WHEN 'Mon' THEN 1
                  WHEN 'Tue' THEN 2
                  WHEN 'Wed' THEN 3
                  WHEN 'Thu' THEN 4
                  WHEN 'Fri' THEN 5
                  WHEN 'Sat' THEN 6
                  WHEN 'Sun' THEN 7
                END
            `)]),profitPerProduct=profitData||[],highestProfitProduct=await mainDb.select({productname:products.name,profit:sql`SUM(${sales.totalSales} - (COALESCE(${purchases.priceBought}, 0) * ${sales.quantity}))`}).from(sales).leftJoin(products,eq(sales.productId,products.id)).leftJoin(purchases,eq(sales.productId,purchases.productId)).where(eq(sales.shopId,shopId)).groupBy(products.name).orderBy(desc(sql`SUM(${sales.totalSales} - (COALESCE(${purchases.priceBought}, 0) * ${sales.quantity}))`)).limit(1).then((rows)=>rows[0]||{productName:null,totalProfit:0}),totalProfitFromProducts=await mainDb.select({date:sales.createdAt,name:products.name,totalSales:sales.totalSales,priceBought:purchases.priceBought,quantity:sales.quantity}).from(sales).leftJoin(products,eq(sales.productId,products.id)).leftJoin(purchases,eq(sales.productId,purchases.productId)).where(eq(sales.shopId,shopId)).then((rows)=>{if(!rows.length)return 0;return rows.reduce((totalProfit,row)=>{let cost=row.priceBought?Number(row.priceBought)*row.quantity:0;return totalProfit+(Number(row.totalSales)-cost)},0)}),totalSalesFromProducts=profitPerProduct.reduce((sum2,item)=>{return sum2+Number(item.totalsales||0)},0),totalPurchasesFromProducts=profitPerProduct.reduce((sum2,item)=>{return sum2+Number(item.totalcost||0)},0),expenseResult=await mainDb.execute(sql`
            SELECT COALESCE(SUM(e.amount), 0) AS totalExpenses
            FROM expenses e
            WHERE e.shop_id = ${shopId}
        `),totalExpenses=Number(expenseResult?.[0]?.totalexpenses||0),netProfit={totalExpenses,totalSales:totalSalesFromProducts,totalPurchases:totalPurchasesFromProducts,netProfit:totalProfitFromProducts-totalExpenses},lowestProduct=lowestStockProductResult[0]||null,lowStockProducts=lowStockProductsResult||[],mostSoldProductByQuantity=mostSoldByQuantityProductResult?.[0]?{...mostSoldByQuantityProductResult[0],timesSold:Number(mostSoldByQuantityProductResult[0].timessold||0),unit:mostSoldByQuantityProductResult[0].unit||"kipimo"}:null,[longTermDebtUserArray,mostDebtUserArray]=debtorData,longTermDebtUser=longTermDebtUserArray[0]||null,mostDebtUser=mostDebtUserArray[0]||null,daysSinceDebt="Haijulikani";if(longTermDebtUser?.createdAt){let rawDate=new Date(longTermDebtUser.createdAt);rawDate.setHours(rawDate.getHours()-3),daysSinceDebt=formatDistanceToNow(rawDate,{addSuffix:!0})}let salesByDay=[],expensesByDay=[],purchasesPerDay=[],netSalesByDay=[],weekDaysOrder=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],dailyDataMap=new Map;weekDaysOrder.forEach((day)=>{dailyDataMap.set(day,{sales:0,expenses:0,purchases:0,profit:0})});for(let row of weeklySummaryData){let day=row.day;if(dailyDataMap.has(day))dailyDataMap.get(day).sales=Number(row.sales||0),dailyDataMap.get(day).expenses=Number(row.expenses||0),dailyDataMap.get(day).purchases=Number(row.purchases||0),dailyDataMap.get(day).profit=Number(row.profit||0)}for(let[day,data]of dailyDataMap.entries()){salesByDay.push({day,sales:data.sales}),expensesByDay.push({day,expenses:data.expenses}),purchasesPerDay.push({day,purchases:data.purchases});let netSales=data.profit-data.expenses;netSalesByDay.push({day,netSales})}let result=await prodCheck({shopId}),trialData=result.data?.trialEnd?.toString();if(!trialData)return;let trialEnd=timeRemainingUntil(trialData),mostAsked=await mainDb.select({name:askedProducts.productName}).from(askedProducts).where(eq(askedProducts.shopId,shopId)).orderBy(desc(askedProducts.quantityRequested)).limit(1).then((rows)=>rows[0]?.name??"Hakuna");return console.timeEnd("Analytics"),{success:!0,data:[{profitPerProduct,mostAsked,highestProfitProduct,netProfit,lowestProduct,lowStockProducts,mostSoldProductByQuantity,longTermDebtUser,mostDebtUser,daysSinceDebt,salesByDay,expensesByDay,netSalesByDay,purchasesPerDay,prodMessage:result.message,subscription:result.data?.shopSubscription,trialEnd}]}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu kwenye seva"}}},salesAnalytics=async({userId,shopId,query})=>{try{let{search="",date:date3="Leo",from="",to="",page="1",limit="10"}=query,pageNum=parseInt(page)||1,perPage=parseInt(limit)||10,offset=(pageNum-1)*perPage,filters=[];filters.push(eq(sales.shopId,shopId));let searchTrimmed=search.trim();if(searchTrimmed)filters.push(or(ilike(customers.name,`%${searchTrimmed}%`),ilike(products.name,`%${searchTrimmed}%`)));if(date3&&date3!=="Tarehe_maalumu"){let today=new Date;today.setHours(today.getHours()+3);let start,end;switch(date3){case"Leo":start=new Date(today.toDateString()),end=new Date(start),end.setDate(end.getDate()+1);break;case"Wiki_hii":start=new Date(today),start.setDate(start.getDate()-7),end=today;break;case"Mwezi_huu":start=new Date(today.getFullYear(),today.getMonth(),1),end=today;break;case"Jana":start=new Date(today),start.setDate(today.getDate()-1),end=new Date(start),end.setDate(end.getDate()+1);break;default:start=end=today}filters.push(and(gte(sales.createdAt,start),lte(sales.createdAt,end)))}if(date3==="Tarehe_maalumu"&&from&&to)filters.push(and(gte(sales.createdAt,new Date(from)),lte(sales.createdAt,new Date(to))));let whereClause=filters.length?and(...filters):void 0,total=(await mainDb.select({count:sql`COUNT(*)`}).from(sales).leftJoin(customers,eq(sales.customerId,customers.id)).leftJoin(products,eq(sales.productId,products.id)).where(and(whereClause,eq(sales.shopId,shopId))))[0].count;return{success:!0,data:await mainDb.select({date:sales.createdAt,name:products.name,total:sales.totalSales,priceBought:purchases.priceBought,quantity:sales.quantity}).from(sales).leftJoin(customers,eq(sales.customerId,customers.id)).leftJoin(products,eq(sales.productId,products.id)).leftJoin(purchases,eq(sales.productId,purchases.productId)).where(and(whereClause,eq(sales.shopId,shopId))).limit(perPage).offset(offset).orderBy(desc(sales.createdAt)),total}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu imetokea kwenye seva"}}},exportSales=async({userId,shopId,set:set2})=>{try{let salesData=await mainDb.select({date:sales.createdAt,productName:products.name,total:sales.totalSales,priceBought:purchases.priceBought,quantity:sales.quantity}).from(sales).leftJoin(customers,eq(sales.customerId,customers.id)).leftJoin(products,eq(sales.productId,products.id)).leftJoin(purchases,eq(sales.productId,purchases.productId)).where(eq(sales.shopId,shopId)).orderBy(desc(sales.createdAt)),csvHeader=`Tarehe,Jina la Bidhaa,Jumla,Faida,Idadi
`,csvContent=`Tarehe,Jina la Bidhaa,Jumla,Faida,Idadi
`+salesData.map((row)=>{let dateObj=new Date(row.date),formattedDate=`${String(dateObj.getDate()).padStart(2,"0")}/${String(dateObj.getMonth()+1).padStart(2,"0")}/${dateObj.getFullYear()} ${String(dateObj.getHours()).padStart(2,"0")}:${String(dateObj.getMinutes()).padStart(2,"0")}:${String(dateObj.getSeconds()).padStart(2,"0")}`,profit=Number(row.total)-Number(row.priceBought)*row.quantity;return`${formattedDate},"${row.productName}",${row.total},${profit},"${row.quantity}"`}).join(`
`);return set2.headers={"Content-Type":"text/csv","Content-Disposition":'attachment; filename="Mauzo.csv"'},new Response(csvContent)}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu imetokea kwenye seva"}}},graphFunc=async({shopId,userId})=>{try{let weekDaysOrder=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],stocksByDay=await mainDb.select({day:sql`TO_CHAR(${products.createdAt}, 'Dy')`.as("day_of_week"),totalStock:sql`SUM(${products.stock})`.as("total_stock")}).from(products).where(eq(products.shopId,shopId)).groupBy(sql`day_of_week`).orderBy(sql`day_of_week`),stocksByDayMap=new Map;weekDaysOrder.forEach((day)=>stocksByDayMap.set(day,0));for(let row of stocksByDay){let day=row.day;if(stocksByDayMap.has(day))stocksByDayMap.set(day,Number(row.totalStock||0))}let dailyStockTrend=Array.from(stocksByDayMap).map(([day,totalStock])=>({day,totalStock})),DebtsByCustomer=await mainDb.select({customerName:customers.name,totalDebts:sql`SUM(${debts.remainingAmount})`.as("total_debts")}).from(debts).innerJoin(customers,eq(debts.customerId,customers.id)).where(eq(debts.shopId,shopId)).groupBy(customers.name).orderBy(sql`total_debts DESC`),cashDebtData=await mainDb.select({type:sales.saleType,amount:sql`SUM(${sales.priceSold} * ${sales.quantity})`.as("amount")}).from(sales).where(eq(sales.shopId,shopId)).groupBy(sales.saleType);return{success:!0,data:[{stockTrend:dailyStockTrend,DebtsByCustomer,cashDebtData}],message:"Taarifa za mauzo zimepatikana kwa mafanikio"}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu imetokea kwenye seva"}}};var JWT_SECRET6=process.env.JWT_TOKEN||"something@#morecomplicated<>es>??><Ess5%",analyticsRoute=new Elysia().use(index_default({name:"jwt",secret:JWT_SECRET6})).get("/analytics",async({jwt:jwt2,cookie:cookie2})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;return await getAnalytics({userId,shopId})}).get("/sales",async({jwt:jwt2,cookie:cookie2,query})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;return await salesAnalytics({userId,shopId,query})},{query:salesQueryData}).get("/export-sales",async({jwt:jwt2,cookie:cookie2,set:set2})=>{let{shopId,userId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;let serviceResult=await checkServiceAccess({shopId,service:"exportCSV"});if(!serviceResult.success)return{success:!1,message:serviceResult.message};return await exportSales({shopId,userId,set:set2})}).get("/graph",async({jwt:jwt2,cookie:cookie2})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;return await graphFunc({userId,shopId})}),analytics_default=analyticsRoute;var JWT_SECRET7=process.env.JWT_TOKEN||"something@#morecomplicated<>es>??><Ess5%",authPlugin=new Elysia().use(dist_default()).use(index_default({name:"jwt",secret:JWT_SECRET7})).post("/verify-cookie",async({jwt:jwt2,body,headers})=>{try{let token=body.token,decoded=await jwt2.verify(token);if(!isDecodedToken(decoded))return{success:!1,message:"Huna ruhusa! - Token sio sahihi"};return{success:!0,message:"Umefanikiwa kukaguliwa"}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu kwenye seva"}}},{body:authToken}).get("/delete-cookie",async({headers,cookie:cookie2})=>{try{return cookie2.auth_token.set({value:"",httpOnly:!0,secure:!1,sameSite:"lax",maxAge:0,path:"/",domain:void 0}),{success:!0,message:"umefanikiwa kutoka"}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu kwenye seva"}}}).get("/me",async({jwt:jwt2,cookie:cookie2,headers})=>{try{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!userId)return;let username=(await mainDb.select({username:users.username}).from(users).where(eq(users.id,userId)))[0].username;return cookie2.username.set({value:username,httpOnly:!0,secure:!1,sameSite:"lax",maxAge:604800,path:"/",domain:void 0}),{success:!0,data:[{username}],message:"successful"}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu kwenye seva"}}});var shopSettingsFunc=async({shopId,userId,headers})=>{try{let fetchShop=await mainDb.select({shopName:shops.name}).from(shops).where(eq(shops.id,shopId)),fetchEmail=await mainDb.select({email:users.email}).from(users).where(eq(users.id,userId)),fetchPhone=await mainDb.select({phoneNumber:users.phoneNumber}).from(users).where(eq(users.id,userId));if(fetchShop.length===0||fetchEmail.length===0||fetchPhone.length===0)return{success:!1,message:"Hakuna kilichopatikana"};return{success:!0,data:[{shopName:fetchShop[0],email:fetchEmail[0],phoneNumber:fetchPhone[0]}],message:"Umefanikiwa kupata taarifa"}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu imetokea kwenye seva"}}},shopSettingsPut=async({shopId,userId,headers,body})=>{try{let{email,shopName,phoneNumber}=body;return email=sanitizeString(email).trim(),shopName=sanitizeString(shopName).trim(),phoneNumber=sanitizeString(phoneNumber).trim(),await mainDb.update(users).set({email,phoneNumber}).where(eq(users.id,userId)),await mainDb.update(shops).set({name:shopName}).where(eq(shops.id,shopId)),{success:!0,message:"Umefanikiwa kubadili taarifa zako kiukamilifu"}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu imetokea kwenye seva"}}},updatePassword=async({shopId,userId,headers,body})=>{try{let{currentPassword,newPassword}=body;currentPassword=sanitizeString(currentPassword).trim(),newPassword=sanitizeString(newPassword).trim();let fetchedPswd=(await mainDb.select({pswd:users.password}).from(users).where(eq(users.id,userId)))[0].pswd;if(!await verifyPassword(fetchedPswd,currentPassword))return{success:!1,message:"Nenosiri la zamani sio sahihi, jaribu tena"};let hashedNewPassword=await hashPassword(newPassword);return await mainDb.update(users).set({password:hashedNewPassword}).where(eq(users.id,userId)).returning(),{success:!0,message:"Umefanikiwa kubadili nenosiri, tafadhali itunze"}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu kwenye seva"}}},deleteShop=async({shopId,userId,cookie:cookie2})=>{try{if((await mainDb.select({role:users.role}).from(users).where(eq(users.id,userId)))[0].role!=="owner")return{success:!1,message:"Hauna mamlaka ya kufuta duka"};let tables=[askedProducts,supplierPriceHistory,debtPayments,debts,sales,purchases,returns,expenses,products,suppliers,customers];return await mainDb.transaction(async(tx)=>{for(let table of tables)await tx.delete(table).where(eq(table.shopId,shopId))}),cookie2.auth_token.set({value:"",httpOnly:!0,secure:!1,sameSite:"lax",maxAge:0,path:"/",domain:void 0}),cookie2.username.set({value:"",httpOnly:!0,secure:!1,sameSite:"lax",maxAge:0,path:"/",domain:void 0}),{success:!0,message:"Umefanikiwa kufuta duka"}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu kwenye seva"}}};var JWT_SECRET8=process.env.JWT_TOKEN||"something@#morecomplicated<>es>??><Ess5%",settingsPlugin=new Elysia().use(index_default({name:"jwt",secret:JWT_SECRET8})).get("/shop",async({jwt:jwt2,cookie:cookie2,headers})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;return await shopSettingsFunc({shopId,userId,headers})}).put("/shop",async({jwt:jwt2,cookie:cookie2,headers,body})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;return await shopSettingsPut({shopId,userId,headers,body})},{body:shopPutData}).put("/update-password",async({jwt:jwt2,cookie:cookie2,headers,body})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;return await updatePassword({shopId,userId,headers,body})},{body:changePasswordData}).delete("/delete-shop",async({jwt:jwt2,cookie:cookie2})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;return await deleteShop({shopId,userId,cookie:cookie2})}),settings_default=settingsPlugin;import{randomBytes}from"crypto";var generateUsername=async(name)=>{let base=name.trim().split(" ")[0].toLowerCase().replace(/[^a-z0-9]/g,""),suffix=Math.floor(Math.random()*1000),newUser=`${base}_${suffix}`,attempts=0,maxAttempts=5;while(attempts<maxAttempts){if((await mainDb.select({usr:users.username}).from(users).where(eq(users.username,newUser))).length===0)return newUser;suffix=Math.floor(Math.random()*1000),newUser=`${base}_${suffix}`,attempts++}return`${base}_${Date.now()}`},generateShopName=async(name)=>{let base=name.trim().split(" ")[0].toLowerCase().replace(/[^a-z0-9]/g,""),suffix=Math.floor(Math.random()*1e4),newShop=`${base}'s Shop_${suffix}`,attempts=0,maxAttempts=5;while(attempts<maxAttempts){if((await mainDb.select({shop:shops.name}).from(shops).where(eq(shops.name,newShop))).length===0)return newShop;suffix=Math.floor(Math.random()*1e4),newShop=`${base}_${suffix}`,attempts++}return`${base}'s Shop_${Date.now()}`},createUser=async(anyName,type2)=>{try{let name=type2==="user"?await generateUsername(anyName):await generateShopName(anyName);if(typeof name!=="string")return{success:!1,message:"username sio string, haifai"};return{success:!0,data:name}}catch(err){return{success:!1,message:err instanceof Error?err.message:" \u274C Tatizo wakati wa kutengeneza username"}}};var GOOGLE_CLIENT_ID=process.env.GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET=process.env.GOOGLE_CLIENT_SECRET,backendURL=process.env.BACKEND_URL_DEV,frontendURL2=process.env.FRONTEND_URL_DEV,REDIRECT_URI=`${backendURL}/auth/google/callback`,JWT_SECRET9=process.env.JWT_TOKEN||"something@#morecomplicated<>es>??><Ess5%",googlePlugin=new Elysia().use(dist_default()).use(index_default({name:"jwt",secret:JWT_SECRET9})).get("/auth/google",()=>{let url=new URL("https://accounts.google.com/o/oauth2/v2/auth");return url.searchParams.set("client_id",GOOGLE_CLIENT_ID),url.searchParams.set("redirect_uri",REDIRECT_URI),url.searchParams.set("response_type","code"),url.searchParams.set("scope","email profile openid"),redirect(url.toString(),302)}).get("/auth/google/callback",async({query,headers,jwt:jwt2,cookie:{auth_token}})=>{let code=query.code,tokenRes=await fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({code,client_id:GOOGLE_CLIENT_ID,client_secret:GOOGLE_CLIENT_SECRET,redirect_uri:REDIRECT_URI,grant_type:"authorization_code"})});try{let{access_token,id_token}=await tokenRes.json(),userInfo=await fetch("https://www.googleapis.com/oauth2/v3/userinfo",{headers:{Authorization:`Bearer ${access_token}`}}).then((res)=>res.json()),{email,name,picture,sub:googleId}=userInfo;if((await mainDb.select({email:users.email}).from(users).where(eq(users.email,email))).length===0){let generatePassword=()=>randomBytes(6).toString("base64").slice(0,7),generatePhone=()=>{return"255"+(()=>{let usedNumbers=new Set;return()=>{let num;do num=(Math.floor(Math.random()*9000000000)+1e9).toString();while(usedNumbers.has(num));return usedNumbers.add(num),num}})()()},password=generatePassword(),hashedPassword=await hashPassword(password),usernameRes=await createUser(name,"user"),shopNameRes=await createUser(name,"shop"),username=usernameRes.success?usernameRes.data:void 0,shopName=shopNameRes.success?shopNameRes.data:void 0;if(!username||!shopName)return;let phoneNumber=generatePhone(),user=await mainDb.insert(users).values({username,email,password:hashedPassword,phoneNumber}).returning({id:users.id,username:users.username}).then((res)=>res[0]);if(!user)return{success:!1,message:"Mtumiaji hayupo!"};let shop=await mainDb.insert(shops).values({name:shopName,trialStart:new Date(Date.now()),trialEnd:new Date(Date.now()+1209600000)}).returning({id:shops.id}).then((res)=>res[0]);if(!shop)return{success:!1,message:"Duka lililosajiliwa kwa ajili yako halipo!"};let credetials=await mainDb.insert(shopUsers).values({shopId:shop.id,userId:user.id,role:"owner"}).returning({userId:shopUsers.userId,shopId:shopUsers.shopId});if(credetials.length===0)return;let{userId,shopId}=credetials[0],jwtToken=await jwt2.sign({userId,shopId});if(!jwtToken)return{success:!1,message:"hakuna tokeni, hujaruhusiwa"};return auth_token.set({value:jwtToken,httpOnly:!0,secure:!1,sameSite:"lax",maxAge:604800,path:"/",domain:void 0}),redirect(`${frontendURL2}/private`,302)}else{let userId=(await mainDb.select({userId:users.id,username:users.username}).from(users).where(eq(users.email,email)))[0].userId,shopId=(await mainDb.select({shopId:shopUsers.shopId}).from(shopUsers).where(eq(shopUsers.userId,userId)))[0].shopId,jwtToken=await jwt2.sign({userId,shopId});if(!jwtToken)return{success:!1,message:"hakuna tokeni, hujaruhusiwa"};return auth_token.set({value:jwtToken,httpOnly:!0,secure:!1,sameSite:"lax",maxAge:604800,path:"/",domain:void 0}),redirect(`${frontendURL2}/private`,302)}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Google failed"}}}).post("/verify-captcha",async({body})=>{let token=body.token;if(!token)return{success:!1,message:"Tokeni ya reCAPTCHA haipo! jaribu tena"};try{let result=await(await fetch("https://www.google.com/recaptcha/api/siteverify",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({secret:process.env.GOOGLE_RECAPTCHA_SECRET_KEY,response:token}).toString()})).json();if(result.success)return{success:!0,message:"Success"};else return{success:!1,message:result["error-codes"]}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Imeshindwa kuhakiki reCAPTCHA!"}}}),google_default=googlePlugin;import{randomBytes as randomBytes2,createCipheriv,createDecipheriv}from"crypto";var createPayloadChecksum=async(checksumKey,payload)=>{let sortedPayload=Object.keys(payload).sort().reduce((acc,key)=>{return acc[key]=payload[key],acc},{}),payloadString=Object.values(sortedPayload).join(""),encoder3=new TextEncoder,keyData=encoder3.encode(checksumKey),data=encoder3.encode(payloadString),cryptoKey=await crypto.subtle.importKey("raw",keyData,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),signature=await crypto.subtle.sign("HMAC",cryptoKey,data);return Array.from(new Uint8Array(signature)).map((b2)=>b2.toString(16).padStart(2,"0")).join("")};var generateOrderRef=()=>{let timestamp2=Date.now().toString(36).toUpperCase(),random2=Math.random().toString(36).substring(2,8).toUpperCase();return`ORD${timestamp2}${random2}`},ENCRYPTION_KEY=process.env.CLICKPESA_ENCRYPT;if(!ENCRYPTION_KEY)throw new Error("encryption key is not available");var key=Buffer.from(ENCRYPTION_KEY,"base64"),encrypt=(data)=>{let iv=randomBytes2(12),cipher=createCipheriv("aes-256-gcm",key,iv),encrypted=Buffer.concat([cipher.update(data,"utf8"),cipher.final()]),authTag=cipher.getAuthTag();return Buffer.concat([iv,authTag,encrypted]).toString("base64")},decrypt=(encryptedData)=>{let buffer2=Buffer.from(encryptedData,"base64"),iv=buffer2.subarray(0,12),authTag=buffer2.subarray(12,28),encrypted=buffer2.subarray(28),decipher=createDecipheriv("aes-256-gcm",key,iv);return decipher.setAuthTag(authTag),Buffer.concat([decipher.update(encrypted),decipher.final()]).toString("utf8")};var clientID=process.env.CLICKPESA_CLIENT_ID,apiKey=process.env.CLICKPESA_API_KEY,genToken=async({userId,shopId,headers})=>{try{let result=await(await fetch("https://api.clickpesa.com/third-parties/generate-token",{method:"POST",headers:{"client-id":clientID,"api-key":apiKey}})).json().catch((err)=>{return{success:!1,message:err instanceof Error?err.message:"Seva ya malipo imefeli"}});if(!result.token||!result.success)return{success:!1,message:"API-key ya malipo imeisha muda au sio sahihi"};let clickpesaBearer=result.token,encryptedToken=encrypt(clickpesaBearer);return await mainDb.insert(paymentSaaS).values({token:encryptedToken,shopId,amountToPay:"0"}),{success:!0,message:"API-Key ipo sahihi, umepata tokeni ya malipo"}}catch(err){return{success:!1,message:err instanceof Error?err.message:"Hitilafu imetokea kwenye seva"}}},checkUSSD=async({userId,shopId,headers,body})=>{try{let{price,duration,paymentMethod,plan}=body;console.log(paymentMethod);let value=(await mainDb.select({token:paymentSaaS.token}).from(paymentSaaS).where(eq(paymentSaaS.shopId,shopId)).orderBy(desc(paymentSaaS.createdAt)))[0].token,resultToken=decrypt(value),orderReference=generateOrderRef();await mainDb.update(paymentSaaS).set({orderId:orderReference,amountToPay:price.toString()}).where(eq(paymentSaaS.shopId,shopId));let checksumKey=process.env.CLICKPESA_CHECKSUMKEY;if(!checksumKey)return;let payload={amount:price.toString(),currency:"TZS",orderReference},checksum2=await createPayloadChecksum(checksumKey,payload),USSDpayload={...payload,checksum:checksum2},options2={method:"POST",headers:{Authorization:`${resultToken}`,"Content-Type":"application/json"},body:JSON.stringify(USSDpayload)},checkUSSDResult=await(await fetch("https://api.clickpesa.com/third-parties/payments/preview-ussd-push-request",options2)).json().catch((err)=>{return{success:!1,message:err instanceof Error?err.message:"Seva ya malipo imefeli"}});console.log("checkUSSDResult:",checkUSSDResult);let method=checkUSSDResult.activeMethods.find((m)=>m.name.toUpperCase()===paymentMethod);return console.log("method:",method.status),{success:!0,message:"Huduma ya USSD inapatikana kwenye mtandao wako."}}catch(err){return{success:!1,message:err instanceof Error?err.message:"Hitilafu imetokea kwenye seva"}}},USSDPush=async({userId,shopId,headers})=>{try{let value=(await mainDb.select({token:paymentSaaS.token}).from(paymentSaaS).where(eq(paymentSaaS.shopId,shopId)).orderBy(desc(paymentSaaS.createdAt)))[0].token,resultToken=decrypt(value),userAgent=headers["user-agent"]??"";if(!isPhoneRequest(userAgent))return{success:!1,message:"Huduma hii inapatikana kwa watumiaji wa simu tu yenye SIM card (laini)"};let orderData=await mainDb.select({orderId:paymentSaaS.orderId,amountToPay:paymentSaaS.amountToPay}).from(paymentSaaS).where(eq(paymentSaaS.shopId,shopId)),orderId=orderData[0].orderId,amountToPay=orderData[0].amountToPay;if(!orderId)return{success:!1,message:"orderId haipo kwenye database"};let checksumKey=process.env.CLICKPESA_CHECKSUMKEY;if(!checksumKey)return;let payload={amount:amountToPay,currency:"TZS",orderReference:orderId},checksum2=await createPayloadChecksum(checksumKey,payload),phoneNumber=(await mainDb.select({phoneNumber:users.phoneNumber}).from(users).where(eq(users.id,userId)))[0].phoneNumber,USSDpayload={...payload,checksum:checksum2,phoneNumber},options={method:"POST",headers:{Authorization:`${resultToken}`,"Content-Type":"application/json"},body:JSON.stringify(USSDpayload)},ussdPush=await(await fetch("https://api.clickpesa.com/third-parties/payments/initiate-ussd-push-request",options)).json().catch((err)=>{return{success:!1,message:err instanceof Error?err.message:"Seva ya malipo imefeli"}});return console.log("ussdPush:",ussdPush),{success:!0,message:"Ingiza namba ya siri kulipia..."}}catch(err){return{success:!1,message:err instanceof Error?err.message:"Hitilafu imetokea kwenye seva"}}},PayStatus=async({userId,shopId,headers})=>{try{let value=(await mainDb.select({token:paymentSaaS.token}).from(paymentSaaS).where(eq(paymentSaaS.shopId,shopId)).orderBy(desc(paymentSaaS.createdAt)))[0].token,resultToken=decrypt(value),orderId=(await mainDb.select({orderId:paymentSaaS.orderId}).from(paymentSaaS).where(eq(paymentSaaS.shopId,shopId)))[0].orderId;if(!orderId)return;let options={method:"GET",headers:{Authorization:`${resultToken}`}},checkStatus=await(await fetch(`https://api.clickpesa.com/third-parties/payments/{${orderId}}`,options)).json().catch((err)=>{return{success:!1,message:err instanceof Error?err.message:"Seva ya malipo imefeli"}});return console.log("Status: ",checkStatus),{success:!0,message:"Imeona hali ya malipo uliofanya"}}catch(err){return{success:!1,message:err instanceof Error?err.message:"Hitilafu imetokea kwenye seva"}}},checkBalance=async({userId,shopId,headers})=>{try{let value=(await mainDb.select({token:paymentSaaS.token}).from(paymentSaaS).where(eq(paymentSaaS.shopId,shopId)).orderBy(desc(paymentSaaS.createdAt)))[0].token,options={method:"GET",headers:{Authorization:`${decrypt(value)}`}},result=await(await fetch("https://api.clickpesa.com/third-parties/account/balance",options)).json();return console.log("TZS Balance:",result.balances.find((b2)=>b2.currency==="TZS")?.balance),{success:!0,message:"Umefanikiwa kuangalia salio lako la ClickPesa",data:[{Balance:result.balances.find((b2)=>b2.currency==="TZS")?.balance}]}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu imetokea kwenye seva"}}};function isPhoneRequest(userAgent){if(!userAgent)return!1;let mobileKeywords=["mobile","android","iphone","ipod","blackberry","windows phone","nokia","opera mini","opera mobi"],tabletKeywords=["ipad","tablet","kindle"],lowerUserAgent=userAgent.toLowerCase();return mobileKeywords.some((keyword)=>lowerUserAgent.includes(keyword))&&!tabletKeywords.some((keyword)=>lowerUserAgent.includes(keyword))}var JWT_SECRET10=process.env.JWT_TOKEN||"something@#morecomplicated<>es>??><Ess5%",paymentPlugin=new Elysia().use(index_default({name:"jwt",secret:JWT_SECRET10})).get("/mobile/generate-token",async({jwt:jwt2,cookie:cookie2,headers})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!userId||!shopId)return{success:!1,message:"Tafadhali login kwanza ili kulipia"};return await genToken({userId,shopId,headers})}).post("/mobile/check-USSD",async({jwt:jwt2,cookie:cookie2,headers,body})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!userId||!shopId)return{success:!1,message:"Tafadhali login kwanza ili kulipia"};return await checkUSSD({userId,shopId,headers,body})},{body:paymentRequestData}).get("/mobile/USSD-push",async({jwt:jwt2,cookie:cookie2,headers})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!userId||!shopId)return{success:!1,message:"Tafadhali login kwanza ili kulipia"};return await USSDPush({userId,shopId,headers})}).get("/mobile/payment-status",async({jwt:jwt2,cookie:cookie2,headers})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!userId||!shopId)return{success:!1,message:"Tafadhali login kwanza ili kulipia"};return await PayStatus({userId,shopId,headers})}).get("/mobile/checkBalanceBlackCoder123",async({jwt:jwt2,cookie:cookie2,headers})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!userId||!shopId)return{success:!1,message:"Tafadhali login kwanza ili kulipia"};return await checkBalance({userId,shopId,headers})}),payment_default=paymentPlugin;var notifyCount=async({userId,shopId})=>{try{return{success:!0,data:[{count:(await mainDb.select({count:count()}).from(notifications).where(and(eq(notifications.isRead,!1),eq(notifications.shopId,shopId))))[0]?.count??0}],message:"Kuna message hazijasomwa"}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu imetokea kwenye seva"}}};var JWT_SECRET11=process.env.JWT_TOKEN||"something@#morecomplicated<>es>??><Ess5%",notifyPlugin=new Elysia().use(index_default({name:"jwt",secret:JWT_SECRET11})).get("/notifyCount",async({jwt:jwt2,cookie:cookie2})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;return await notifyCount({userId,shopId})}),notifications_default=notifyPlugin;var expFunc=async({shopId,userId,query})=>{try{let page=query.page||1,limit=query.limit||5,[amountRow]=await mainDb.select({totalAmount:sql`SUM(${expenses.amount})`.as("total")}).from(expenses).where(eq(expenses.shopId,shopId)),totalAmount=Number(amountRow?.totalAmount??0),[countRow]=await mainDb.select({count:sql`COUNT(*)`}).from(expenses).where(eq(expenses.shopId,shopId)),totalItems=countRow?.count??0,totalPages=Math.max(1,Math.ceil(totalItems/limit)),items=await mainDb.select({id:expenses.id,description:expenses.description,amount:expenses.amount,date:expenses.date}).from(expenses).where(eq(expenses.shopId,shopId)).orderBy(desc(expenses.date)).limit(limit).offset((page-1)*limit);return{success:!0,message:"Umefanikiwa kupata taarifa",data:[{totalAmount,currentPage:page,totalPages,itemsPerPage:limit,items}]}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu imetokea kwenye seva"}}},delExp=async({shopId,userId,expenseId})=>{try{return await mainDb.delete(expenses).where(and(eq(expenses.shopId,shopId),eq(expenses.id,expenseId))),{success:!0,message:"Umefanikiwa kufuta taarifa"}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu imetokea kwenye seva"}}};var JWT_SECRET12=process.env.JWT_TOKEN||"something@#morecomplicated<>es>??><Ess5%",expensesPlugin=new Elysia().use(index_default({name:"jwt",secret:JWT_SECRET12})).get("/expenses",async({cookie:cookie2,jwt:jwt2,query})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;return await expFunc({shopId,userId,query})}).delete("/expenses/:id",async({cookie:cookie2,jwt:jwt2,params})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;let expenseId=params.id;return await delExp({shopId,userId,expenseId})});async function debtFunc({shopId,userId,query}){console.log("reached",shopId,userId,query);try{let{page,pageSize}=query;console.log(page,pageSize,typeof page,typeof pageSize);let[stats]=await mainDb.select({totalDebts:sql`SUM(${debts.totalAmount})`,totalDebters:sql`COUNT(DISTINCT ${debts.customerId})`,totalRemaining:sql`SUM(${debts.remainingAmount})`,lastPayment:sql`MAX(${debts.lastPaymentDate})`}).from(debts).where(eq(debts.shopId,shopId)),fullyPaidDebtsCount=await mainDb.select({count:sql`COUNT(*)`}).from(debts).where(and(eq(debts.shopId,shopId),eq(debts.remainingAmount,"0.00"))),[totalCollected]=await mainDb.select({total:sql`SUM(${debtPayments.amountPaid})`}).from(debtPayments).where(eq(debtPayments.shopId,shopId)),customerDebts=await mainDb.select({debtId:debts.id,customerId:debts.customerId,name:customers.name,totalDebt:debts.totalAmount,remainingAmount:debts.remainingAmount,lastPaymentDate:debts.lastPaymentDate,createdAt:debts.createdAt}).from(debts).innerJoin(customers,eq(debts.customerId,customers.id)).where(and(eq(debts.shopId,shopId),eq(customers.shopId,shopId))).orderBy(desc(debts.remainingAmount)),paymentHistory=await mainDb.select({customerId:customers.id,name:customers.name,totalPaid:sql`SUM(${debtPayments.amountPaid})`,paymentDate:sql`MAX(${debtPayments.paymentDate})`}).from(debtPayments).innerJoin(customers,eq(debtPayments.customerId,customers.id)).where(and(eq(debtPayments.shopId,shopId),eq(customers.shopId,shopId))).groupBy(customers.id,customers.name).orderBy(desc(sql`MAX(${debtPayments.paymentDate})`)).limit(5),debtReceipts=await mainDb.select({date:sql`DATE(${debts.createdAt})`.as("date"),customerId:debts.customerId,product:products.name,quantity:debts.quantity,priceSold:debts.priceSold,total:debts.totalSales}).from(debts).innerJoin(products,eq(debts.productId,products.id)).where(eq(debts.shopId,shopId)).orderBy(desc(debts.createdAt)),resultMap=new Map;for(let debt of customerDebts)resultMap.set(debt.customerId,{...debt,payment:null,receipts:[]});for(let payment of paymentHistory)if(resultMap.has(payment.customerId))resultMap.get(payment.customerId).payment={totalPaid:payment.totalPaid,lastPayment:payment.paymentDate};for(let receipt of debtReceipts){let customer=resultMap.get(receipt.customerId);if(customer)customer.receipts.push({date:receipt.date,product:receipt.product,quantity:receipt.quantity,priceSold:receipt.priceSold,total:receipt.total})}let mergedData=Array.from(resultMap.values()),paginatedData=mergedData.slice((page-1)*pageSize,page*pageSize);console.log(paginatedData);let totalCustomDebt=await mainDb.select({count:sql`count(distinct ${debts.customerId})`}).from(debts).where(eq(debts.shopId,shopId));return console.log("Total debtors: ",totalCustomDebt[0].count,mergedData.length),{success:!0,data:[{statistics:stats,madeniYaliyolipwa:fullyPaidDebtsCount[0].count,malipoYaliyokusanywa:totalCollected.total||0,totalCollected:Number(totalCollected.total)||0,pagination:{currentPage:page,pageSize,totalCount:totalCustomDebt[0].count},paginatedData}],message:"Madeni ya wateja yamepatikana kwa mafanikio."}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Seva imeshindwa."}}}var payDebt=async({shopId,userId,body})=>{try{let{amountPaid,customerId,debtId}=body;amountPaid=sanitizeNumber(amountPaid);let debtValue=await mainDb.select({amount:debts.remainingAmount}).from(debts).where(and(eq(debts.id,debtId),eq(debts.shopId,shopId),eq(debts.customerId,customerId))).then((res)=>res[0]);if(amountPaid>Number(debtValue.amount))return{success:!1,message:"Kiasi cha kulipia hakiwezi kuzidi deni. Ingiza taarifa vizuri"};await mainDb.insert(debtPayments).values({customerId,amountPaid:amountPaid.toString().trim(),debtId,shopId});let[remainingAmount]=await mainDb.select({remainingAmount:debts.remainingAmount}).from(debts).where(and(eq(debts.id,debtId),eq(debts.shopId,shopId))),newAmount=new decimal_default(remainingAmount.remainingAmount).minus(amountPaid).toFixed(2);return await mainDb.update(debts).set({remainingAmount:newAmount.toString(),lastPaymentDate:new Date(Date.now())}).where(and(eq(debts.id,debtId),eq(debts.shopId,shopId))),{success:!0,message:"Taarifa zimebadilishwa kwa mafanikio"}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Seva imeshindwa."}}};var JWT_SECRET13=process.env.JWT_TOKEN||"something@#morecomplicated<>es>??><Ess5%",debtPlugin=new Elysia().use(index_default({name:"jwt",secret:JWT_SECRET13})).get("/get-debts",async({jwt:jwt2,cookie:cookie2,query})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;return await debtFunc({userId,shopId,query})},{query:debtQuery}).post("/pay-debt",async({jwt:jwt2,cookie:cookie2,body})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;return await payDebt({userId,shopId,body})},{body:payDebtData});var visitorDetails=pgTable("visitor_details",{id:uuid("id").defaultRandom().primaryKey(),visitorId:text("visitor_id").notNull(),proxy:text("proxy"),type:text("type"),continent:text("continent"),country:text("country"),city:text("city"),region:text("region"),latitude:text("latitude"),longitude:text("longitude"),timezone:text("timezone"),provider:text("provider"),currency:text("currency"),userAgent:text("user_agent"),referer:text("referer"),refererDomain:text("referer_domain"),date:text("date"),ip:text("ip")});var trackingVisitors=new Elysia().post("/sign-visitorDetails",async({body,request})=>{let{visitorId}=body;try{if(console.log(`Visitor ID: ${visitorId}`),(await mainDb.select({id:visitorDetails.id}).from(visitorDetails).where(eq(visitorDetails.visitorId,visitorId))).length===0){let ip=request.headers.get("x-forwarded-for")||request.headers.get("x-real-ip")||"127.0.0.1",userAgent=request.headers.get("user-agent")||"",referer=request.headers.get("referer")||"",refererDomain=referer.split("/").slice(2).join("/"),date3=new Date().toISOString().split("T")[0];if(ip==="127.0.0.1")return console.warn(`Visitor ID: ${visitorId} - Localhost IP detected: ${ip}`),{success:!1,message:"Localhost IP detected. Please use a real IP address."};let visitorInfo=await(await fetch(`https://proxycheck.io/v2/${ip}?vpn=1&asn=1`)).json(),data=Object.keys(visitorInfo).find((k2)=>k2!=="status"),details=visitorInfo[data];await mainDb.insert(visitorDetails).values({visitorId,proxy:details.proxy,type:details.type,continent:details.continent,country:details.country,region:details.region,city:details.city,latitude:details.latitude,longitude:details.longitude,timezone:details.timezone,provider:details.provider,currency:details.currency.name+` (${details.currency.code})`,userAgent,referer,refererDomain,date:date3,ip}),console.log(`New visitor added: ${visitorId} from ${ip} on ${date3}`)}return console.log(`Visitor already exists: ${visitorId} on ${new Date().toISOString()}`),{success:!0,message:"Visitor details saved successfully"}}catch(error2){return console.error(error2 instanceof Error?error2.message:error2),{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu kwenye seva"}}}).get("count-visitorDetails",async()=>{let totalCount=await mainDb.select({total:sql`COUNT(DISTINCT ${visitorDetails.visitorId})`,date:visitorDetails.date}).from(visitorDetails).groupBy(visitorDetails.date);if(totalCount.length===0)return{success:!0,total:0,users:{index:[],dates:[]}};let usersCount=mainDb.select({total:sql`COUNT(DISTINCT ${visitorDetails.visitorId})`}).from(users).where(eq(users.role,"owner"));return{success:!0,total:totalCount[0].total,users:{index:totalCount.map((_2,i)=>i),dates:totalCount.map((t3)=>t3.date)}}});var askedFuncFetch=async({shopId,userId,query})=>{try{let page=Number(query.page||1),limit=Number(query.limit||3),offset=(page-1)*limit,[countRow]=await mainDb.select({count:sql`COUNT(*)`}).from(askedProducts).where(eq(askedProducts.shopId,shopId)),totalItems=countRow?.count??0,totalPages=Math.max(1,Math.ceil(totalItems/limit)),data=await mainDb.select({name:askedProducts.productName,count:askedProducts.quantityRequested,id:askedProducts.id}).from(askedProducts).where(eq(askedProducts.shopId,shopId)).orderBy(desc(askedProducts.quantityRequested),desc(askedProducts.id)).offset(offset).limit(limit);if(data.length===0)return{success:!0,message:"Hakuna taarifa zilizopatikana",data:[{data:[],totalPages,itemsPerPage:limit,currentPage:page}]};return{success:!0,message:"taarifa zimepatikana",data:[{data,totalPages,itemsPerPage:limit,currentPage:page}]}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Tatizo limetokea wakati wa kupata data"}}},askedFuncPost=async({shopId,userId,body})=>{try{let{name}=body;if(name=sanitizeString(name).trim().toLowerCase(),(await mainDb.select({name:askedProducts.productName}).from(askedProducts).where(and(eq(askedProducts.productName,name),eq(askedProducts.shopId,shopId)))).length>0)return{success:!1,message:"Jina tayari lipo, tumia jingine"};return await mainDb.insert(askedProducts).values({productName:name,shopId}),{success:!0,message:"Taarifa zimehifadhiwa kwa mafanikio"}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Tatizo limetokea wakati wa kutuma data"}}},deleteAsked=async({userId,shopId,id})=>{try{return await mainDb.delete(askedProducts).where(and(eq(askedProducts.id,id),eq(askedProducts.shopId,shopId))),{success:!0,message:"Umefanikiwa kufuta taarifa"}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Tatizo limetokea wakati wa kutuma data"}}},updateAsked=async({userId,shopId,id,body})=>{try{return await mainDb.update(askedProducts).set({quantityRequested:body.count}).where(and(eq(askedProducts.shopId,shopId),eq(askedProducts.id,id))),{success:!0,message:"Umefanikiwa ku-edit taarifa"}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Tatizo limetokea wakati wa kutuma data"}}};var JWT_SECRET14=process.env.JWT_TOKEN||"something@#morecomplicated<>es>??><Ess5%",askedPlugin=new Elysia().use(index_default({name:"jwt",secret:JWT_SECRET14})).get("/asked",async({cookie:cookie2,jwt:jwt2,query})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;return await askedFuncFetch({shopId,userId,query})}).post("/asked",async({cookie:cookie2,jwt:jwt2,body})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;return await askedFuncPost({shopId,userId,body})},{body:askedData}).delete("/asked/:id",async({cookie:cookie2,jwt:jwt2,params})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;let{id}=params;return await deleteAsked({shopId,userId,id})}).put("/asked/:id",async({cookie:cookie2,jwt:jwt2,params,body})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;let{id}=params;return await updateAsked({shopId,userId,id,body})},{body:updatedAskedData});import crypto4 from"crypto";var import_nodemailer3=__toESM(require_nodemailer(),1),sendResetEmail=async({email,link})=>{let html=`
    <!DOCTYPE html>
    <html lang="sw">
    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Badilisha Nenosiri</title>
      <style>
        body {
          font-family: Arial, sans-serif;
          background-color: #f4f4f7;
          margin: 0;
          padding: 0;
        }
        .container {
          max-width: 600px;
          background: #ffffff;
          padding: 30px;
          border-radius: 12px;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }
        .header { text-align: center; padding-bottom: 20px; }
        .header h2 { margin: 0; color: #1a202c; }
        .content p {
          font-size: 15px;
          color: #4a5568;
          line-height: 1.6;
        }
        .button {
          display: inline-block;
          margin-top: 20px;
          padding: 12px 24px;
          background-color: #44464d;
          color: #ffffff !important;
          text-decoration: none;
          border-radius: 8px;
          font-weight: bold;
        }
        .footer {
          margin-top: 30px;
          font-size: 13px;
          text-align: center;
          color: #a0aec0;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h2>Ombi la Kubadili Nenosiri</h2>
        </div>
        <div class="content">
          <p>Habari,</p>
          <p>
            Ulituma ombi la kubadili nenosiri kwa akaunti yako kwenye
            <strong>MyPostech</strong>. Ikiwa hili halikuwa wewe, unaweza kupuuza barua hii.
          </p>
          <p>Bonyeza kitufe hapa chini kubadili nenosiri lako:</p>
          <a href="{{RESET_LINK}}" class="button">Badilisha Nenosiri</a>
          <p>
            Link hii itatimia ndani ya dakika 15 kwa sababu za kiusalama.
          </p>
        </div>
        <div class="footer">
          <p>&copy; 2025 MyPostech. Haki zote zimehifadhiwa.</p>
        </div>
      </div>
    </body>
    </html>
  `.replace("{{RESET_LINK}}",link);await import_nodemailer3.default.createTransport({host:"smtp.zoho.com",port:465,secure:!0,auth:{user:"huduma@mypostech.store",pass:process.env.ZOHO_APP_PASSWORD}}).sendMail({from:'"myPosTech" <huduma@mypostech.store>',to:email,subject:"Badilisha Nenosiri - MyPostech",html})};var resetPlugin=new Elysia().post("/reset-password",async({body})=>{try{let{email}=body;if(!await mainDb.select().from(users).where(eq(users.email,email)).then((res)=>res[0]))return{success:!1,message:"Kama barua pepe ni sahihi, utapokea link ya kubadili nenosiri."};let token=crypto4.randomBytes(32).toString("hex"),expiresAt=new Date(Date.now()+900000);await mainDb.insert(passwordResets).values({email,token,expiresAt});let link=`${process.env.FRONTEND_URL_DEV}/reset-password?token=${token}&email=${encodeURIComponent(email)}`;return await sendResetEmail({email,link}),{success:!0,message:"Umepokea link ya kubadili nenosiri, Angalia Gmail yako."}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu kwenye seva"}}},{body:resetEmailData}).post("/reset-confirm",async({body})=>{try{let{email,token,password}=body,passwordReset=await mainDb.select({token:passwordResets.token,expiresAt:passwordResets.expiresAt}).from(passwordResets).where(eq(passwordResets.token,token)).then((res)=>res[0]);if(!passwordReset)return{success:!1,message:"Token sio sahihi, fuata njia ya halali"};if(new Date>passwordReset.expiresAt)return{success:!1,message:"Token imeisha muda wake"};if(!await mainDb.select({id:users.id}).from(users).where(eq(users.email,email)).then((res)=>res[0]))return{success:!1,message:"Kama barua pepe ni sahihi, utapokea link ya kubadili nenosiri."};return await mainDb.update(users).set({password:await hashPassword(password)}).where(eq(users.email,email)),{success:!0,message:"Nenosiri limebadilishwa kwa mafanikio. Tafadhali ingia tena."}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu kwenye seva"}}});function isPotentialXSS(input){return/<\s*script|on\w+=|javascript:|<\s*iframe|<\s*img|document\.|window\.|eval\(|innerHTML\s*=|src\s*=|href\s*=/gi.test(input)}var fetchProducts=async(shopId)=>{try{let result=await mainDb.select({name:products.name}).from(products).where(eq(products.shopId,shopId));if(result.length===0)return{success:!1,name:[],message:"hakuna bidhaa kwenye mfumo."};return{success:!0,message:"Bidhaa imepatikana.",name:result.map((item)=>item.name)}}catch(error2){return{success:!1,name:[],message:error2 instanceof Error?error2.message:"Hitilafu imetokea wakati wa kutafuta bidhaa"}}},fetchCustomers=async(shopId)=>{try{let result=await mainDb.select({name:customers.name}).from(customers).where(eq(customers.shopId,shopId));if(result.length===0)return{success:!1,name:[],message:"hakuna mteja kwenye mfumo."};return{success:!0,message:"Mteja amepatikana.",name:result.map((item)=>item.name)}}catch(error2){return{success:!1,name:[],message:error2 instanceof Error?error2.message:"Hitilafu imetokea wakati wa kutafuta mteja"}}};function parseNimetumiaSentence(sentence){let words=sentence.toLowerCase().trim().split(/\s+/);if(!words[0]?.match(/nime(tumia|letumia|litumia)/))throw new Error('Sentensi lazima ianze na "nimetumia", "niletumia", n.k.');let action="nimetumia",activity="nyumbani",product="nothing",money=0,quantity=1;console.log("nimetumia is processing ...");let activityIndex=words.findIndex((w,i)=>w==="kwa"&&words[i+1]==="ajili"&&words[i+2]==="ya");if(activityIndex!==-1&&words[activityIndex+3])activity=words.slice(activityIndex+3).join(" ");let potentialProductOrMoneyWords=activityIndex!==-1?words.slice(1,activityIndex):words.slice(1),phrase=potentialProductOrMoneyWords.join(" ").trim(),directNum=parseFloat(phrase);if(!isNaN(directNum))money=directNum,product="nothing";else{let fullParse=swahiliToNumber(phrase);if(fullParse!==null&&!isNaN(fullParse))money=fullParse,product="";else{let lastNumericIndex=-1;for(let i=potentialProductOrMoneyWords.length-1;i>=0;i--){let part=potentialProductOrMoneyWords.slice(i).join(" "),parsed=swahiliToNumber(part);if(parsed!==null&&!isNaN(parsed)){lastNumericIndex=i,quantity=parsed;break}}if(lastNumericIndex>-1)product=potentialProductOrMoneyWords.slice(0,lastNumericIndex).join(" ")||"hakijajulikani";else product=potentialProductOrMoneyWords.join(" ")}}return console.log("nimetumia datas ...: ",action,product.trim(),quantity,activity,money),{action,product:product.trim()||"haijajulikana",quantity:quantity||1,activity,money}}var verbMap={nimeuza:"nimeuza",niliuza:"nimeuza",nauza:"nimeuza",nimemuuzia:"nimeuza",nimenunua:"nimenunua",niliagiza:"nimenunua",nimemnunulia:"nimenunua",nimeongeza:"nimenunua",nimetumia:"nimetumia",nilitumia:"nimetumia",nimekopesha:"nimemkopesha",nilikopesha:"nimemkopesha",ninamkopesha:"nimemkopesha",namkopesha:"nimemkopesha"},similarity=(a,b2)=>{let matches=0,len=Math.max(a.length,b2.length);for(let i=0;i<len;i++)if(a[i]===b2[i])matches++;return matches/len};async function detectSwahiliTransaction(text2,shopId){let normalized=text2.toLowerCase().trim(),words=normalized.split(/\s+/),actionKey=Object.keys(verbMap).find((key2)=>similarity(words[0],key2)>0.7);if(!actionKey)throw new Error("Hatua haijatambulika.");let action=verbMap[actionKey];if(action==="nimetumia")parseNimetumiaSentence(normalized);let restOfText=normalized.replace(actionKey,"").trim(),customers2=(await fetchCustomers(shopId)).name,products2=(await fetchProducts(shopId)).name,customer=null,afterCustomerText=restOfText;if(action==="nimemkopesha"){for(let c of customers2.sort((a,b2)=>b2.length-a.length))if(restOfText.includes(c)){customer=c,afterCustomerText=restOfText.replace(c,"").trim();break}}afterCustomerText=customer?restOfText.replace(customer,"").trim():restOfText;let product=null,normalizedText=afterCustomerText.toLowerCase(),exactMatch=products2.find((p)=>normalizedText.includes(p.toLowerCase()));if(exactMatch)product=exactMatch;else{let partialMatches=products2.map((p)=>({name:p,score:similarity(normalizedText,p.toLowerCase())})).filter((item)=>item.score>0.5).sort((a,b2)=>b2.score-a.score);if(partialMatches.length===1)product=partialMatches[0].name;else if(partialMatches.length>1){let names=partialMatches.map((p)=>`"${p.name}"`).join(", ");throw new Error(`Tafadhali fafanua bidhaa: ${names} zote zinafanana. Tafadhali taja bidhaa kamili.`)}}if(!product)throw new Error("Bidhaa haijatambulika. Hakikisha jina lake lipo sahihi.");let tokens=afterCustomerText.replace(product,"").trim().split(/\s+/),punguzoIndex=tokens.findIndex((w)=>w==="punguzo"),quantityWords=punguzoIndex!==-1?tokens.slice(0,punguzoIndex):tokens,quantity=1;for(let word of quantityWords.reverse()){let num=parseFloat(word);if(console.log(word),word.length>0&&isNaN(num))throw new Error("Tafadhali weka idadi halali kwa namba (mfano: 2 au 4.5), si maneno kama 'tano'.");if(!isNaN(num)){quantity=num;break}}let punguzo=0;if(punguzoIndex!==-1&&punguzoIndex+1<tokens.length){let word=tokens[punguzoIndex+1];if(punguzo=parseFloat(word),isNaN(punguzo))throw new Error("Tafadhali weka punguzo kama namba halali (mfano: 2, 5.5)")}return{action,customer,product,quantity,punguzo}}var BASE2={sifuri:0,moja:1,mbili:2,tatu:3,nne:4,tano:5,sita:6,saba:7,nane:8,tisa:9,kumi:10,ishirini:20,thelathini:30,arobaini:40,hamsini:50,sitini:60,sabini:70,thembani:80,tisini:90},MULTIPLIERS={mia:100,elfu:1000},FRACTIONS={nusu:0.5,robo:0.25,"robo tatu":0.75,"nusu na robo":0.75};function swahiliToNumber(text2){let phrase=text2.toLowerCase().replace(/_/g," ").trim();if(FRACTIONS[phrase])return FRACTIONS[phrase];let words=phrase.split(/\s+/),total=0,currentValue=0,i=0;while(i<words.length){let word=words[i];if(word==="na"){i++;continue}if(word in FRACTIONS){total+=FRACTIONS[word],i++;continue}if(!isNaN(parseFloat(word))){total+=parseFloat(word),i++;continue}if(word in BASE2){currentValue+=BASE2[word],i++;continue}if(word in MULTIPLIERS){let multiplier=MULTIPLIERS[word];if(word==="elfu"&&currentValue>0){if(total+=currentValue*multiplier,currentValue=0,i+1<words.length&&words[i+1]==="na"){i+=2;continue}}else if(currentValue>0)total+=currentValue*multiplier,currentValue=0;else{let nextWord=words[i+1];if(nextWord&&nextWord in BASE2)total+=BASE2[nextWord]*multiplier,i++;else total+=1*multiplier}i++;continue}return console.warn(`Unknown word: ${word}`),null}if(total+=currentValue,total>1e4)return console.warn(`Value exceeds 10,000: ${total}`),null;return total}var handleSpeech=async(shopId,userId,text2)=>{try{if(console.time("CoreService"),isPotentialXSS(text2))return{success:!1,message:"Maandishi yako yana vitu visivyo salama. Huwezi kudukua kirahisi hivyo."};let sanitizedText=sanitizeString(text2),action,customer,product,quantity,punguzo,activity,money;if(sanitizedText.toLowerCase().includes("nimetumia")){let parsed=parseNimetumiaSentence(sanitizedText);if(action=parsed.action,activity=parsed.activity,product=parsed.product,quantity=parsed.quantity,money=parsed.money,console.log("nimetumia parse:",{action,activity,product,quantity,money}),product!=="nothing"){let productUse=await mainDb.select({id:products.id,priceSold:products.priceSold,stock:products.stock}).from(products).where(like(products.name,`%${product.split(" ")[0]}%`)).then((res)=>res[0]);if(!productUse)return{success:!1,message:`Bidhaa '${product}' haijapatikana.`};if(productUse.stock<quantity)return{success:!1,message:"Bidhaa haina stock ya kutosha"};if(await mainDb.update(products).set({stock:sql`${products.stock} - ${quantity}`}).where(eq(products.id,productUse.id)),productUse.stock-quantity<=0)await mainDb.update(products).set({status:"finished"}).where(eq(products.id,productUse.id));if(money===0)money=Number(productUse.priceSold)*quantity}return await mainDb.insert(expenses).values({description:activity,amount:formatFloatToFixed(money),shopId}),{success:!0,message:"Matumizi yamehifadhiwa kikamilifu"}}let transaction=await detectSwahiliTransaction(sanitizedText,shopId);action=transaction.action,customer=transaction.customer||null,product=transaction.product,quantity=transaction.quantity||1,punguzo=transaction.punguzo,console.log("regular transaction:",{action,customer,product,quantity,punguzo});let productDetails=await mainDb.select({id:products.id,priceSold:products.priceSold,stock:products.stock}).from(products).where(eq(products.name,product)).then((res)=>res[0]);if(!productDetails)return{success:!1,message:`Bidhaa '${product}' haijapatikana.`};switch(action){case"nimeuza":{if(productDetails.stock<quantity)return{success:!1,message:"Bidhaa haina stock ya kutosha"};if(await mainDb.update(products).set({stock:sql`${products.stock} - ${quantity}`}).where(eq(products.id,productDetails.id)),productDetails.stock-quantity<=0)await mainDb.update(products).set({status:"finished"}).where(eq(products.id,productDetails.id));return await mainDb.insert(sales).values({productId:productDetails.id,quantity,discount:punguzo,priceSold:productDetails.priceSold,totalSales:formatFloatToFixed(Number(productDetails.priceSold)*quantity-punguzo),shopId,saleType:"cash",customerId:null}),{success:!0,message:"Mauzo yamehifadhiwa kikamilifu"}}case"nimemkopesha":{if(productDetails.stock<quantity)return{success:!1,message:"Bidhaa haina stock ya kutosha"};if(await mainDb.update(products).set({stock:sql`${products.stock} - ${quantity}`}).where(eq(products.id,productDetails.id)),productDetails.stock-quantity<=0)await mainDb.update(products).set({status:"finished"}).where(eq(products.id,productDetails.id));let customerId=null;if(customer)customerId=await mainDb.select({id:customers.id}).from(customers).where(eq(customers.name,customer)).then((res)=>res[0]?.id||null);if(customerId===null)return{success:!1,message:"Mteja hayupo! msajili kwanza"};return await mainDb.insert(debts).values({customerId,productId:productDetails.id,quantity,priceSold:productDetails.priceSold,totalSales:formatFloatToFixed(Number(productDetails.priceSold)*quantity-punguzo),totalAmount:formatFloatToFixed(Number(productDetails.priceSold)*quantity-punguzo),remainingAmount:formatFloatToFixed(Number(productDetails.priceSold)*quantity-punguzo),shopId}),{success:!0,message:"Deni limehifadhiwa kikamilifu"}}case"nimenunua":{let priceBought=await mainDb.select({priceBought:purchases.priceBought}).from(purchases).where(eq(purchases.productId,productDetails.id)).then((res)=>res[0]?.priceBought||"0");return await mainDb.update(products).set({stock:sql`${products.stock} + ${quantity}`,status:"available"}).where(eq(products.id,productDetails.id)),await mainDb.insert(purchases).values({productId:productDetails.id,shopId,quantity,priceBought,totalCost:formatFloatToFixed(Number(priceBought)*quantity)}),{success:!0,message:"Manunuzi yamehifadhiwa kikamilifu"}}default:return{success:!1,message:"Hatua ya muamala haijatambuliwa"}}}catch(error2){return{success:!1,message:error2 instanceof Error?error2.message:"Hitilafu imetokea kwenye seva"}}finally{console.timeEnd("CoreService")}};var JWT_SECRET15=process.env.JWT_TOKEN||"something@#morecomplicated<>es>??><Ess5%",speechPlugin=new Elysia().use(index_default({name:"jwt",secret:JWT_SECRET15})).post("/speech",async({jwt:jwt2,cookie:cookie2,body})=>{let{userId,shopId}=await extractId({jwt:jwt2,cookie:cookie2});if(!shopId||!userId)return;let{text:text2}=body;return text2=text2.trim(),await handleSpeech(shopId,userId,text2)});var frontendURL3=process.env.FRONTEND_URL_DEV,allowedOrigins=[`${frontendURL3}`],csrfProtection=(app)=>app.onBeforeHandle(({request,set:set2})=>{let origin=request.headers.get("origin"),method=request.method.toUpperCase();if(["POST","PUT","PATCH","DELETE"].includes(method)){if(!origin||!allowedOrigins.includes(origin))return set2.status=403,"Blocked: CSRF protection (invalid origin)"}});var rateLimitMap=new Map,rateLimitMiddleware=async({request,set:set2})=>{let ip=request.headers.get("x-forwarded-for")||request.headers.get("cf-connecting-ip")||request.headers.get("x-real-ip")||"unknown-ip",limit=15,resetTime=60000,now=Date.now(),entry=rateLimitMap.get(ip)??{count:0,reset:now+60000};if(now>entry.reset)entry.count=0,entry.reset=now+60000;if(entry.count>=15)return set2.status=429,{success:!1,message:"Umetuma maombi mengi kwa sasa, Jaribu tena baadae."};entry.count++,rateLimitMap.set(ip,entry)};function minitz(y,m,d,h,i,s,tz,throwOnInvalid){return minitz.fromTZ(minitz.tp(y,m,d,h,i,s,tz),throwOnInvalid)}minitz.fromTZISO=(localTimeStr,tz,throwOnInvalid)=>{return minitz.fromTZ(parseISOLocal(localTimeStr,tz),throwOnInvalid)};minitz.fromTZ=function(tp,throwOnInvalid){let inDate=new Date(Date.UTC(tp.y,tp.m-1,tp.d,tp.h,tp.i,tp.s)),offset=getTimezoneOffset(tp.tz,inDate),dateGuess=new Date(inDate.getTime()-offset),dateOffsGuess=getTimezoneOffset(tp.tz,dateGuess);if(dateOffsGuess-offset===0)return dateGuess;else{let dateGuess2=new Date(inDate.getTime()-dateOffsGuess),dateOffsGuess2=getTimezoneOffset(tp.tz,dateGuess2);if(dateOffsGuess2-dateOffsGuess===0)return dateGuess2;else if(!throwOnInvalid&&dateOffsGuess2-dateOffsGuess>0)return dateGuess2;else if(!throwOnInvalid)return dateGuess;else throw new Error("Invalid date passed to fromTZ()")}};minitz.toTZ=function(d,tzStr){let localDateString=d.toLocaleString("en-US",{timeZone:tzStr}).replace(/[\u202f]/," "),td=new Date(localDateString);return{y:td.getFullYear(),m:td.getMonth()+1,d:td.getDate(),h:td.getHours(),i:td.getMinutes(),s:td.getSeconds(),tz:tzStr}};minitz.tp=(y,m,d,h,i,s,tz)=>{return{y,m,d,h,i,s,tz}};function getTimezoneOffset(timeZone,date3=new Date){let tz=date3.toLocaleString("en-US",{timeZone,timeZoneName:"short"}).split(" ").slice(-1)[0],dateString=date3.toLocaleString("en-US").replace(/[\u202f]/," ");return Date.parse(`${dateString} GMT`)-Date.parse(`${dateString} ${tz}`)}function parseISOLocal(dtStr,tz){let pd=new Date(Date.parse(dtStr));if(isNaN(pd))throw new Error("minitz: Invalid ISO8601 passed to parser.");let stringEnd=dtStr.substring(9);if(dtStr.includes("Z")||stringEnd.includes("-")||stringEnd.includes("+"))return minitz.tp(pd.getUTCFullYear(),pd.getUTCMonth()+1,pd.getUTCDate(),pd.getUTCHours(),pd.getUTCMinutes(),pd.getUTCSeconds(),"Etc/UTC");else return minitz.tp(pd.getFullYear(),pd.getMonth()+1,pd.getDate(),pd.getHours(),pd.getMinutes(),pd.getSeconds(),tz)}minitz.minitz=minitz;function CronOptions(options){if(options===void 0)options={};if(delete options.name,options.legacyMode=options.legacyMode===void 0?!0:options.legacyMode,options.paused=options.paused===void 0?!1:options.paused,options.maxRuns=options.maxRuns===void 0?1/0:options.maxRuns,options.catch=options.catch===void 0?!1:options.catch,options.interval=options.interval===void 0?0:parseInt(options.interval,10),options.utcOffset=options.utcOffset===void 0?void 0:parseInt(options.utcOffset,10),options.unref=options.unref===void 0?!1:options.unref,options.startAt)options.startAt=new CronDate(options.startAt,options.timezone);if(options.stopAt)options.stopAt=new CronDate(options.stopAt,options.timezone);if(options.interval!==null){if(isNaN(options.interval))throw new Error("CronOptions: Supplied value for interval is not a number");else if(options.interval<0)throw new Error("CronOptions: Supplied value for interval can not be negative")}if(options.utcOffset!==void 0){if(isNaN(options.utcOffset))throw new Error("CronOptions: Invalid value passed for utcOffset, should be number representing minutes offset from UTC.");else if(options.utcOffset<-870||options.utcOffset>870)throw new Error("CronOptions: utcOffset out of bounds.");if(options.utcOffset!==void 0&&options.timezone)throw new Error("CronOptions: Combining 'utcOffset' with 'timezone' is not allowed.")}if(options.unref!==!0&&options.unref!==!1)throw new Error("CronOptions: Unref should be either true, false or undefined(false).");return options}var DaysOfMonth=[31,28,31,30,31,30,31,31,30,31,30,31],RecursionSteps=[["month","year",0],["day","month",-1],["hour","day",0],["minute","hour",0],["second","minute",0]];function CronDate(d,tz){if(this.tz=tz,d&&d instanceof Date)if(!isNaN(d))this.fromDate(d);else throw new TypeError("CronDate: Invalid date passed to CronDate constructor");else if(d===void 0)this.fromDate(new Date);else if(d&&typeof d==="string")this.fromString(d);else if(d instanceof CronDate)this.fromCronDate(d);else throw new TypeError("CronDate: Invalid type ("+typeof d+") passed to CronDate constructor")}CronDate.prototype.fromDate=function(inDate){if(this.tz!==void 0)if(typeof this.tz==="number")this.ms=inDate.getUTCMilliseconds(),this.second=inDate.getUTCSeconds(),this.minute=inDate.getUTCMinutes()+this.tz,this.hour=inDate.getUTCHours(),this.day=inDate.getUTCDate(),this.month=inDate.getUTCMonth(),this.year=inDate.getUTCFullYear(),this.apply();else{let d=minitz.toTZ(inDate,this.tz);this.ms=inDate.getMilliseconds(),this.second=d.s,this.minute=d.i,this.hour=d.h,this.day=d.d,this.month=d.m-1,this.year=d.y}else this.ms=inDate.getMilliseconds(),this.second=inDate.getSeconds(),this.minute=inDate.getMinutes(),this.hour=inDate.getHours(),this.day=inDate.getDate(),this.month=inDate.getMonth(),this.year=inDate.getFullYear()};CronDate.prototype.fromCronDate=function(d){this.tz=d.tz,this.year=d.year,this.month=d.month,this.day=d.day,this.hour=d.hour,this.minute=d.minute,this.second=d.second,this.ms=d.ms};CronDate.prototype.apply=function(){if(this.month>11||this.day>DaysOfMonth[this.month]||this.hour>59||this.minute>59||this.second>59||this.hour<0||this.minute<0||this.second<0){let d=new Date(Date.UTC(this.year,this.month,this.day,this.hour,this.minute,this.second,this.ms));return this.ms=d.getUTCMilliseconds(),this.second=d.getUTCSeconds(),this.minute=d.getUTCMinutes(),this.hour=d.getUTCHours(),this.day=d.getUTCDate(),this.month=d.getUTCMonth(),this.year=d.getUTCFullYear(),!0}else return!1};CronDate.prototype.fromString=function(str){return this.fromDate(minitz.fromTZISO(str,this.tz))};CronDate.prototype.findNext=function(options,target,pattern,offset){let originalTarget=this[target],lastDayOfMonth;if(pattern.lastDayOfMonth||pattern.lastWeekdayOfMonth)if(this.month!==1)lastDayOfMonth=DaysOfMonth[this.month];else lastDayOfMonth=new Date(Date.UTC(this.year,this.month+1,0,0,0,0,0)).getUTCDate();let fDomWeekDay=!pattern.starDOW&&target=="day"?new Date(Date.UTC(this.year,this.month,1,0,0,0,0)).getUTCDay():void 0;for(let i=this[target]+offset;i<pattern[target].length;i++){let match2=pattern[target][i];if(target==="day"&&pattern.lastDayOfMonth&&i-offset==lastDayOfMonth)match2=!0;if(target==="day"&&!pattern.starDOW){let dowMatch=pattern.dayOfWeek[(fDomWeekDay+(i-offset-1))%7];if(dowMatch&&pattern.lastWeekdayOfMonth)dowMatch=dowMatch&&i-offset>lastDayOfMonth-7;if(options.legacyMode&&!pattern.starDOM)match2=match2||dowMatch;else match2=match2&&dowMatch}if(match2)return this[target]=i-offset,originalTarget!==this[target]?2:1}return 3};CronDate.prototype.recurse=function(pattern,options,doing){let res=this.findNext(options,RecursionSteps[doing][0],pattern,RecursionSteps[doing][2]);if(res>1){let resetLevel=doing+1;while(resetLevel<RecursionSteps.length)this[RecursionSteps[resetLevel][0]]=-RecursionSteps[resetLevel][2],resetLevel++;if(res===3)return this[RecursionSteps[doing][1]]++,this[RecursionSteps[doing][0]]=-RecursionSteps[doing][2],this.apply(),this.recurse(pattern,options,0);else if(this.apply())return this.recurse(pattern,options,doing-1)}if(doing+=1,doing>=RecursionSteps.length)return this;else if(this.year>=3000)return null;else return this.recurse(pattern,options,doing)};CronDate.prototype.increment=function(pattern,options,hasPreviousRun){return this.second+=options.interval>1&&hasPreviousRun?options.interval:1,this.ms=0,this.apply(),this.recurse(pattern,options,0)};CronDate.prototype.getDate=function(internal){if(internal||this.tz===void 0)return new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.ms);else if(typeof this.tz==="number")return new Date(Date.UTC(this.year,this.month,this.day,this.hour,this.minute-this.tz,this.second,this.ms));else return minitz(this.year,this.month+1,this.day,this.hour,this.minute,this.second,this.tz)};CronDate.prototype.getTime=function(){return this.getDate().getTime()};function CronPattern(pattern,timezone){this.pattern=pattern,this.timezone=timezone,this.second=Array(60).fill(0),this.minute=Array(60).fill(0),this.hour=Array(24).fill(0),this.day=Array(31).fill(0),this.month=Array(12).fill(0),this.dayOfWeek=Array(8).fill(0),this.lastDayOfMonth=!1,this.lastWeekdayOfMonth=!1,this.starDOM=!1,this.starDOW=!1,this.parse()}CronPattern.prototype.parse=function(){if(!(typeof this.pattern==="string"||this.pattern.constructor===String))throw new TypeError("CronPattern: Pattern has to be of type string.");if(this.pattern.indexOf("@")>=0)this.pattern=this.handleNicknames(this.pattern).trim();let parts=this.pattern.replace(/\s+/g," ").split(" ");if(parts.length<5||parts.length>6)throw new TypeError("CronPattern: invalid configuration format ('"+this.pattern+"'), exacly five or six space separated parts required.");if(parts.length===5)parts.unshift("0");if(parts[3].indexOf("L")>=0)parts[3]=parts[3].replace("L",""),this.lastDayOfMonth=!0;if(parts[5].indexOf("L")>=0)parts[5]=parts[5].replace("L",""),this.lastWeekdayOfMonth=!0;if(parts[3]=="*")this.starDOM=!0;if(parts[4].length>=3)parts[4]=this.replaceAlphaMonths(parts[4]);if(parts[5].length>=3)parts[5]=this.replaceAlphaDays(parts[5]);if(parts[5]=="*")this.starDOW=!0;if(this.pattern.indexOf("?")>=0){let initDate=new CronDate(new Date,this.timezone).getDate(!0);if(parts[0]=parts[0].replace("?",initDate.getSeconds()),parts[1]=parts[1].replace("?",initDate.getMinutes()),parts[2]=parts[2].replace("?",initDate.getHours()),!this.starDOM)parts[3]=parts[3].replace("?",initDate.getDate());if(parts[4]=parts[4].replace("?",initDate.getMonth()+1),!this.starDOW)parts[5]=parts[5].replace("?",initDate.getDay())}if(this.throwAtIllegalCharacters(parts),this.partToArray("second",parts[0],0),this.partToArray("minute",parts[1],0),this.partToArray("hour",parts[2],0),this.partToArray("day",parts[3],-1),this.partToArray("month",parts[4],-1),this.partToArray("dayOfWeek",parts[5],0),this.dayOfWeek[7])this.dayOfWeek[0]=1};CronPattern.prototype.partToArray=function(type2,conf,valueIndexOffset){let arr=this[type2];if(conf==="*")return arr.fill(1);let split=conf.split(",");if(split.length>1)for(let i=0;i<split.length;i++)this.partToArray(type2,split[i],valueIndexOffset);else if(conf.indexOf("-")!==-1&&conf.indexOf("/")!==-1)this.handleRangeWithStepping(conf,type2,valueIndexOffset);else if(conf.indexOf("-")!==-1)this.handleRange(conf,type2,valueIndexOffset);else if(conf.indexOf("/")!==-1)this.handleStepping(conf,type2,valueIndexOffset);else if(conf!=="")this.handleNumber(conf,type2,valueIndexOffset)};CronPattern.prototype.throwAtIllegalCharacters=function(parts){let reValidCron=/[^/*0-9,-]+/;for(let i=0;i<parts.length;i++)if(reValidCron.test(parts[i]))throw new TypeError("CronPattern: configuration entry "+i+" ("+parts[i]+") contains illegal characters.")};CronPattern.prototype.handleNumber=function(conf,type2,valueIndexOffset){let i=parseInt(conf,10)+valueIndexOffset;if(isNaN(i))throw new TypeError("CronPattern: "+type2+" is not a number: '"+conf+"'");if(i<0||i>=this[type2].length)throw new TypeError("CronPattern: "+type2+" value out of range: '"+conf+"'");this[type2][i]=1};CronPattern.prototype.handleRangeWithStepping=function(conf,type2,valueIndexOffset){let matches=conf.match(/^(\d+)-(\d+)\/(\d+)$/);if(matches===null)throw new TypeError("CronPattern: Syntax error, illegal range with stepping: '"+conf+"'");let[,lower,upper,steps]=matches;if(lower=parseInt(lower,10)+valueIndexOffset,upper=parseInt(upper,10)+valueIndexOffset,steps=parseInt(steps,10),isNaN(lower))throw new TypeError("CronPattern: Syntax error, illegal lower range (NaN)");if(isNaN(upper))throw new TypeError("CronPattern: Syntax error, illegal upper range (NaN)");if(isNaN(steps))throw new TypeError("CronPattern: Syntax error, illegal stepping: (NaN)");if(steps===0)throw new TypeError("CronPattern: Syntax error, illegal stepping: 0");if(steps>this[type2].length)throw new TypeError("CronPattern: Syntax error, steps cannot be greater than maximum value of part ("+this[type2].length+")");if(lower<0||upper>=this[type2].length)throw new TypeError("CronPattern: Value out of range: '"+conf+"'");if(lower>upper)throw new TypeError("CronPattern: From value is larger than to value: '"+conf+"'");for(let i=lower;i<=upper;i+=steps)this[type2][i]=1};CronPattern.prototype.handleRange=function(conf,type2,valueIndexOffset){let split=conf.split("-");if(split.length!==2)throw new TypeError("CronPattern: Syntax error, illegal range: '"+conf+"'");let lower=parseInt(split[0],10)+valueIndexOffset,upper=parseInt(split[1],10)+valueIndexOffset;if(isNaN(lower))throw new TypeError("CronPattern: Syntax error, illegal lower range (NaN)");else if(isNaN(upper))throw new TypeError("CronPattern: Syntax error, illegal upper range (NaN)");if(lower<0||upper>=this[type2].length)throw new TypeError("CronPattern: Value out of range: '"+conf+"'");if(lower>upper)throw new TypeError("CronPattern: From value is larger than to value: '"+conf+"'");for(let i=lower;i<=upper;i++)this[type2][i]=1};CronPattern.prototype.handleStepping=function(conf,type2){let split=conf.split("/");if(split.length!==2)throw new TypeError("CronPattern: Syntax error, illegal stepping: '"+conf+"'");let start=0;if(split[0]!=="*")start=parseInt(split[0],10);let steps=parseInt(split[1],10);if(isNaN(steps))throw new TypeError("CronPattern: Syntax error, illegal stepping: (NaN)");if(steps===0)throw new TypeError("CronPattern: Syntax error, illegal stepping: 0");if(steps>this[type2].length)throw new TypeError("CronPattern: Syntax error, max steps for part is ("+this[type2].length+")");for(let i=start;i<this[type2].length;i+=steps)this[type2][i]=1};CronPattern.prototype.replaceAlphaDays=function(conf){return conf.replace(/-sun/gi,"-7").replace(/sun/gi,"0").replace(/mon/gi,"1").replace(/tue/gi,"2").replace(/wed/gi,"3").replace(/thu/gi,"4").replace(/fri/gi,"5").replace(/sat/gi,"6")};CronPattern.prototype.replaceAlphaMonths=function(conf){return conf.replace(/jan/gi,"1").replace(/feb/gi,"2").replace(/mar/gi,"3").replace(/apr/gi,"4").replace(/may/gi,"5").replace(/jun/gi,"6").replace(/jul/gi,"7").replace(/aug/gi,"8").replace(/sep/gi,"9").replace(/oct/gi,"10").replace(/nov/gi,"11").replace(/dec/gi,"12")};CronPattern.prototype.handleNicknames=function(pattern){let cleanPattern=pattern.trim().toLowerCase();if(cleanPattern==="@yearly"||cleanPattern==="@annually")return"0 0 1 1 *";else if(cleanPattern==="@monthly")return"0 0 1 * *";else if(cleanPattern==="@weekly")return"0 0 * * 0";else if(cleanPattern==="@daily")return"0 0 * * *";else if(cleanPattern==="@hourly")return"0 * * * *";else return pattern};function isFunction(v){return Object.prototype.toString.call(v)==="[object Function]"||typeof v==="function"||v instanceof Function}function unrefTimer(timer2){if(typeof Deno!=="undefined"&&typeof Deno.unrefTimer!=="undefined")Deno.unrefTimer(timer2);else if(timer2&&typeof timer2.unref!=="undefined")timer2.unref()}var maxDelay=30000,scheduledJobs=[];function Cron(pattern,fnOrOptions1,fnOrOptions2){if(!(this instanceof Cron))return new Cron(pattern,fnOrOptions1,fnOrOptions2);let options,func;if(isFunction(fnOrOptions1))func=fnOrOptions1;else if(typeof fnOrOptions1==="object")options=fnOrOptions1;else if(fnOrOptions1!==void 0)throw new Error("Cron: Invalid argument passed for optionsIn. Should be one of function, or object (options).");if(isFunction(fnOrOptions2))func=fnOrOptions2;else if(typeof fnOrOptions2==="object")options=fnOrOptions2;else if(fnOrOptions2!==void 0)throw new Error("Cron: Invalid argument passed for funcIn. Should be one of function, or object (options).");if(this.name=options?options.name:void 0,this.options=CronOptions(options),this._states={kill:!1,blocking:!1,previousRun:void 0,currentRun:void 0,once:void 0,currentTimeout:void 0,maxRuns:options?options.maxRuns:void 0,paused:options?options.paused:!1,pattern:void 0},pattern&&(pattern instanceof Date||typeof pattern==="string"&&pattern.indexOf(":")>0))this._states.once=new CronDate(pattern,this.options.timezone||this.options.utcOffset);else this._states.pattern=new CronPattern(pattern,this.options.timezone);if(this.name)if(scheduledJobs.find((j)=>j.name===this.name))throw new Error("Cron: Tried to initialize new named job '"+this.name+"', but name already taken.");else scheduledJobs.push(this);if(func!==void 0)this.fn=func,this.schedule();return this}Cron.prototype.nextRun=function(prev){let next2=this._next(prev);return next2?next2.getDate():null};Cron.prototype.nextRuns=function(n,previous){if(n>this._states.maxRuns)n=this._states.maxRuns;let enumeration=[],prev=previous||this._states.currentRun;while(n--&&(prev=this.nextRun(prev)))enumeration.push(prev);return enumeration};Cron.prototype.getPattern=function(){return this._states.pattern?this._states.pattern.pattern:void 0};Cron.prototype.isRunning=function(){let msLeft=this.msToNext(this._states.currentRun),isRunning=!this._states.paused,isScheduled=this.fn!==void 0,notIsKilled=!this._states.kill;return isRunning&&isScheduled&&notIsKilled&&msLeft!==null};Cron.prototype.isStopped=function(){return this._states.kill};Cron.prototype.isBusy=function(){return this._states.blocking};Cron.prototype.currentRun=function(){return this._states.currentRun?this._states.currentRun.getDate():null};Cron.prototype.previousRun=function(){return this._states.previousRun?this._states.previousRun.getDate():null};Cron.prototype.msToNext=function(prev){let next2=this._next(prev);if(prev=new CronDate(prev,this.options.timezone||this.options.utcOffset),next2)return next2.getTime(!0)-prev.getTime(!0);else return null};Cron.prototype.stop=function(){if(this._states.kill=!0,this._states.currentTimeout)clearTimeout(this._states.currentTimeout);let jobIndex=scheduledJobs.indexOf(this);if(jobIndex>=0)scheduledJobs.splice(jobIndex,1)};Cron.prototype.pause=function(){return this._states.paused=!0,!this._states.kill};Cron.prototype.resume=function(){return this._states.paused=!1,!this._states.kill};Cron.prototype.schedule=function(func,partial){if(func&&this.fn)throw new Error("Cron: It is not allowed to schedule two functions using the same Croner instance.");else if(func)this.fn=func;let waitMs=this.msToNext(partial?partial:this._states.currentRun),target=this.nextRun(partial?partial:this._states.currentRun);if(waitMs===null||target===null)return this;if(waitMs>maxDelay)waitMs=maxDelay;if(this._states.currentTimeout=setTimeout(()=>this._checkTrigger(target),waitMs),this._states.currentTimeout&&this.options.unref)unrefTimer(this._states.currentTimeout);return this};Cron.prototype._trigger=async function(initiationDate){if(this._states.blocking=!0,this._states.currentRun=new CronDate(void 0,this.options.timezone||this.options.utcOffset),this.options.catch)try{await this.fn(this,this.options.context)}catch(_e){if(isFunction(this.options.catch))this.options.catch(_e,this)}else await this.fn(this,this.options.context);this._states.previousRun=new CronDate(initiationDate,this.options.timezone||this.options.utcOffset),this._states.blocking=!1};Cron.prototype.trigger=async function(){await this._trigger()};Cron.prototype._checkTrigger=function(target){let now=new Date,shouldRun=!this._states.paused&&now.getTime()>=target,isBlocked=this._states.blocking&&this.options.protect;if(shouldRun&&!isBlocked)this._states.maxRuns--,this._trigger();else if(shouldRun&&isBlocked&&isFunction(this.options.protect))setTimeout(()=>this.options.protect(this),0);this.schedule(void 0,now)};Cron.prototype._next=function(prev){let hasPreviousRun=prev||this._states.currentRun?!0:!1;if(prev=new CronDate(prev,this.options.timezone||this.options.utcOffset),this.options.startAt&&prev&&prev.getTime()<this.options.startAt.getTime())prev=this.options.startAt;let nextRun=this._states.once||new CronDate(prev,this.options.timezone||this.options.utcOffset).increment(this._states.pattern,this.options,hasPreviousRun);if(this._states.once&&this._states.once.getTime()<=prev.getTime())return null;else if(nextRun===null||this._states.maxRuns<=0||this._states.kill||this.options.stopAt&&nextRun.getTime()>=this.options.stopAt.getTime())return null;else return nextRun};Cron.Cron=Cron;Cron.scheduledJobs=scheduledJobs;var Days=((Days2)=>{return Days2[Days2.SUNDAY=0]="SUNDAY",Days2[Days2.MONDAY=1]="MONDAY",Days2[Days2.TUESDAY=2]="TUESDAY",Days2[Days2.WEDNESAY=3]="WEDNESAY",Days2[Days2.THURSDAY=4]="THURSDAY",Days2[Days2.FRIDAY=5]="FRIDAY",Days2[Days2.SATURDAY=6]="SATURDAY",Days2})(Days||{}),ConstantExpressions=((ConstantExpressions2)=>{return ConstantExpressions2.EVERY_SECOND="* * * * * *",ConstantExpressions2.EVERY_5_SECONDS="*/5 * * * * *",ConstantExpressions2.EVERY_10_SECONDS="*/10 * * * * *",ConstantExpressions2.EVERY_30_SECONDS="*/30 * * * * *",ConstantExpressions2.EVERY_MINUTE="*/1 * * * *",ConstantExpressions2.EVERY_5_MINUTES="0 */5 * * * *",ConstantExpressions2.EVERY_10_MINUTES="0 */10 * * * *",ConstantExpressions2.EVERY_30_MINUTES="0 */30 * * * *",ConstantExpressions2.EVERY_HOUR="0 0-23/1 * * *",ConstantExpressions2.EVERY_2_HOURS="0 0-23/2 * * *",ConstantExpressions2.EVERY_3_HOURS="0 0-23/3 * * *",ConstantExpressions2.EVERY_4_HOURS="0 0-23/4 * * *",ConstantExpressions2.EVERY_5_HOURS="0 0-23/5 * * *",ConstantExpressions2.EVERY_6_HOURS="0 0-23/6 * * *",ConstantExpressions2.EVERY_7_HOURS="0 0-23/7 * * *",ConstantExpressions2.EVERY_8_HOURS="0 0-23/8 * * *",ConstantExpressions2.EVERY_9_HOURS="0 0-23/9 * * *",ConstantExpressions2.EVERY_10_HOURS="0 0-23/10 * * *",ConstantExpressions2.EVERY_11_HOURS="0 0-23/11 * * *",ConstantExpressions2.EVERY_12_HOURS="0 0-23/12 * * *",ConstantExpressions2.EVERY_DAY_AT_1AM="0 01 * * *",ConstantExpressions2.EVERY_DAY_AT_2AM="0 02 * * *",ConstantExpressions2.EVERY_DAY_AT_3AM="0 03 * * *",ConstantExpressions2.EVERY_DAY_AT_4AM="0 04 * * *",ConstantExpressions2.EVERY_DAY_AT_5AM="0 05 * * *",ConstantExpressions2.EVERY_DAY_AT_6AM="0 06 * * *",ConstantExpressions2.EVERY_DAY_AT_7AM="0 07 * * *",ConstantExpressions2.EVERY_DAY_AT_8AM="0 08 * * *",ConstantExpressions2.EVERY_DAY_AT_9AM="0 09 * * *",ConstantExpressions2.EVERY_DAY_AT_10AM="0 10 * * *",ConstantExpressions2.EVERY_DAY_AT_11AM="0 11 * * *",ConstantExpressions2.EVERY_DAY_AT_NOON="0 12 * * *",ConstantExpressions2.EVERY_DAY_AT_1PM="0 13 * * *",ConstantExpressions2.EVERY_DAY_AT_2PM="0 14 * * *",ConstantExpressions2.EVERY_DAY_AT_3PM="0 15 * * *",ConstantExpressions2.EVERY_DAY_AT_4PM="0 16 * * *",ConstantExpressions2.EVERY_DAY_AT_5PM="0 17 * * *",ConstantExpressions2.EVERY_DAY_AT_6PM="0 18 * * *",ConstantExpressions2.EVERY_DAY_AT_7PM="0 19 * * *",ConstantExpressions2.EVERY_DAY_AT_8PM="0 20 * * *",ConstantExpressions2.EVERY_DAY_AT_9PM="0 21 * * *",ConstantExpressions2.EVERY_DAY_AT_10PM="0 22 * * *",ConstantExpressions2.EVERY_DAY_AT_11PM="0 23 * * *",ConstantExpressions2.EVERY_DAY_AT_MIDNIGHT="0 0 * * *",ConstantExpressions2.EVERY_WEEK="0 0 * * 0",ConstantExpressions2.EVERY_WEEKDAY="0 0 * * 1-5",ConstantExpressions2.EVERY_WEEKEND="0 0 * * 6,0",ConstantExpressions2.EVERY_1ST_DAY_OF_MONTH_AT_MIDNIGHT="0 0 1 * *",ConstantExpressions2.EVERY_1ST_DAY_OF_MONTH_AT_NOON="0 12 1 * *",ConstantExpressions2.EVERY_2ND_HOUR="0 */2 * * *",ConstantExpressions2.EVERY_2ND_HOUR_FROM_1AM_THROUGH_11PM="0 1-23/2 * * *",ConstantExpressions2.EVERY_2ND_MONTH="0 0 1 */2 *",ConstantExpressions2.EVERY_QUARTER="0 0 1 */3 *",ConstantExpressions2.EVERY_6_MONTHS="0 0 1 */6 *",ConstantExpressions2.EVERY_YEAR="0 0 1 1 *",ConstantExpressions2.EVERY_30_MINUTES_BETWEEN_9AM_AND_5PM="0 */30 9-17 * * *",ConstantExpressions2.EVERY_30_MINUTES_BETWEEN_9AM_AND_6PM="0 */30 9-18 * * *",ConstantExpressions2.EVERY_30_MINUTES_BETWEEN_10AM_AND_7PM="0 */30 10-19 * * *",ConstantExpressions2})(ConstantExpressions||{}),FunctionExpressions={everySenconds(seconds=1){return`*/${seconds} * * * * *`},everyMinutes(minutes=1){return`0 */${minutes} * * * *`},everyHours(hours=1){return`0 0-23/${hours} * * *`},everyHoursAt(hours,minutes=0){return`${minutes} 0-23/${hours} * * *`},everyDayAt(time2="00:00"){let[hours,minutes]=time2.split(":");return`${minutes} ${hours} 0 * *`},everyWeekOn(day,time2="00:00"){let[hours,minutes]=time2.split(":");return`${minutes} ${hours} * * ${day}`},everyWeekdayAt(time2="00:00"){let[hours,minutes]=time2.split(":");return`${minutes} ${hours} * * 1-5`},everyWeekendAt(time2="00:00"){let[hours,minutes]=time2.split(":");return`${minutes} ${hours} * * 6,0`},everySecond(){return"* * * * * *"},everyMinute(){return"*/1 * * * *"},hourly(){return"0 0-23/1 * * *"},daily(){return"0 0 * * *"},everyWeekday(){return"0 0 * * 1-5"},everyWeekend(){return"0 0 * * 6,0"},weekly(){return"0 0 * * 0"},monthly(){return"0 0 1 * *"},everyQuarter(){return"0 0 1 */3 *"},yearly(){return"0 0 1 1 *"}},Patterns={...FunctionExpressions,...Days,...ConstantExpressions},cron=({pattern,name,run,...options})=>(app)=>{if(!pattern)throw new Error("pattern is required");if(!name)throw new Error("name is required");return app.state((store)=>{let prevCron=app.singleton.store?.cron??{};return{...store,cron:{...prevCron,[name]:new Cron(pattern,options,()=>run(app.singleton.store))}}})};var import_config3=__toESM(require_config(),1);var import_nodemailer4=__toESM(require_nodemailer(),1),notifyTrialEnd=async({email,shopName,link})=>{let html=`
    <!DOCTYPE html>
    <html lang="sw">
    <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Muda umekwisha</title>
    <style>
        body {
        font-family: 'Quicksand', sans-serif;
        background-color: #e2e8f0;
        padding: 1rem;
        color: #1f2937;
        font-size: 14px;
        margin: 0;
        }
        .container {
        max-width: 28rem;
        margin: 0 auto;
        background: white;
        border: 2px solid #334155;
        border-radius: 1.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        overflow: hidden;
        }
        .header {
        text-align: center;
        padding: 2rem 1.5rem;
        background: linear-gradient(to top, #8324f0, #163ce7);
        }
        .header img {
        width: 5rem;
        margin: 0 auto 1rem;
        }
        .header h2 {
        color: white;
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
        }
        .content {
        padding: 2rem 1.5rem;
        text-align: center;
        }
        .content p {
        margin-bottom: 1.5rem;
        font-size: 14px;
        }
        .content a {
        display: inline-block;
        padding: 0.75rem 1.5rem;
        border: 2px solid #334155;
        background-color: #c7bbfc;
        color: #111827;
        font-weight: bold;
        border-radius: 9999px;
        text-decoration: none;
        }
        .footer {
        margin-top: 2rem;
        font-size: 12px;
        color: #6b7280;
        }
    </style>
    </head>
    <body>
    <div class="container">
        <div class="header">
            <img src="https://www.mypostech.store/thumbail.png" alt="App Logo">
            <h2>Muda wa Jaribio Umeisha \u23F3</h2>
        </div>
        <div class="content">
        <p>
            Habari <strong>"${shopName}"</strong>,
        </p>
        <p style="line-height: 1.6;">
            Jaribio lako la siku 14 kwenye <strong>myPosTech</strong> limeisha. Ili kuendelea kutumia mfumo na kuona ripoti, faida na kufanya mauzo, tafadhali boresha kifurushi chako sasa.
        </p>
        <p style="line-height:1.6;">
            Tunapendekeza kujiunga na kifurushi <strong>Lite</strong> au <strong>Business</strong> kulingana na ukubwa wa biashara yako.
        </p>
        <a href="${link}" target="_blank">Boresha Sasa</a>
        <div class="footer">
            <p>Asante kwa kutumia mfumo wetu. myPosTech - Biashara yako, Teknolojia yetu.</p>
        </div>
        </div>
    </div>
    </body>
    </html>
  `;await import_nodemailer4.default.createTransport({host:"smtp.zoho.com",port:465,secure:!0,auth:{user:"huduma@mypostech.store",pass:process.env.ZOHO_APP_PASSWORD}}).sendMail({from:'"myPosTech" <huduma@mypostech.store>',to:email,subject:"Kuisha muda wa siku 14 - MyPostech",html})};var import_nodemailer5=__toESM(require_nodemailer(),1),sendDelWarning=async({email,shopName,monthsToKeep,warningDays})=>{let html=`
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>Ufutaji wa taarifa za zamani</title>
        <style>
            body {
                line-height: 1.6;
                color: #333;
                max-width: 600px;
                margin: 0 auto;
                padding: 20px;
            }
            .header {
                background-color: #1e293b;
                color: white;
                padding: 20px;
                text-align: center;
                border-radius: 5px 5px 0 0;
            }
            .content {
                padding: 25px;
                background-color: #f9f9f9;
                border-left: 1px solid #ddd;
                border-right: 1px solid #ddd;
            }
            .footer {
                padding: 15px;
                text-align: center;
                font-size: 12px;
                color: #777;
                background-color: #eee;
                border-radius: 0 0 5px 5px;
                border: 1px solid #ddd;
                border-top: none;
            }
            .button {
                display: inline-block;
                padding: 12px 25px;
                background-color: #1e293b;
                color: white;
                text-decoration: none;
                border-radius: 4px;
                font-weight: bold;
                margin: 20px 0;
            }
            .button:hover {
                background-color: #303641;
            }
        </style>
    </head>
    <body>
        <div class="header">
            <h1>Ufutaji wa taarifa za zamani</h1>
        </div>
        
        <div class="content">
            <p>Habari <strong>"${shopName}"</strong>,</p>
            
            <p>Katika Sera yetu ya uhifadhi wa Taarifa, Tutafuta taarifa zako za zamani ndani ya <strong>siku ${warningDays}</strong>.</p>
            
            <p>Kifurushi chako kinasapoti muda wa <strong> ${monthsToKeep===1?"mwezi":"miezi"} ${monthsToKeep}</strong></p>
            
            <p>Kama unataka kuhifadhi taarifa zako, Pakua nakala (copy) yake kabla ya tarehe ya ufutaji</p>
            
            <center>
                <a href="#" class="button" download>
                    Pakua nakala yako (PDF)
                </a>
            </center>
            
            <p>Baada ya kufikia tarehe ya kufuta, taarifa haziwezi kurudishwa.</p>
                    
            <p>Best regards,<br>
            MyPosTeach Team</p>
        </div>
        
        <div class="footer">
            <p>\xA9 2025 myPosTech. All rights reserved.</p>
        </div>
    </body>
    </html>
  `;await import_nodemailer5.default.createTransport({host:"smtp.zoho.com",port:465,secure:!0,auth:{user:"huduma@mypostech.store",pass:process.env.ZOHO_APP_PASSWORD}}).sendMail({from:'"myPosTech" <huduma@mypostech.store>',to:email,subject:"Ufutaji wa taarifa za zamani - MyPostech",html})};var clearVerifiedEmails=async()=>{try{await mainDb.delete(emailVerifications).where(eq(emailVerifications.used,!0)),console.log("Tumefuta email zilizohakikiwa")}catch(error2){console.log(error2 instanceof Error?error2.message:"Hitilafu imetokea kwenye seva")}},pingAPI=()=>{try{console.log("Karibu kwenye seva ya Elysia na Bun!")}catch(error2){console.log(error2 instanceof Error?error2.message:"Hitilafu imetokea kwenye seva")}},isTrialEnd=async()=>{try{let dbTime=await mainDb.select({trialEnd:shops.trialEnd,id:shops.id,subscription:shops.subscription,email:users.email}).from(shops).innerJoin(shopUsers,eq(shops.id,shopUsers.shopId)).innerJoin(users,eq(users.id,shopUsers.userId));for(let shop of dbTime){if(!shop.trialEnd)continue;if(new Date>new Date(shop.trialEnd)&&shop.subscription==="Trial"){await mainDb.update(shopUsers).set({isPaid:!1}).where(eq(shopUsers.shopId,shop.id));let shopName=await mainDb.select({name:shops.name}).from(shops).where(eq(shops.id,shop.id)),link=process.env.FRONTEND_URL_DEV;await notifyTrialEnd({shopName:shopName[0].name,link,email:shop.email})}}}catch(error2){console.log(error2 instanceof Error?error2.message:"Hitilafu imetokea kwenye seva")}},notifyBeforeEnds=async()=>{try{let dbTime=await mainDb.select({trialEnd:shops.trialEnd,id:shops.id,subscription:shops.subscription}).from(shops),currentTime=new Date().getTime();for(let shop of dbTime){if(!shop.trialEnd)continue;let subscription=shop.subscription,trialEndTime=new Date(shop.trialEnd).getTime(),notifyTime=trialEndTime-604800000;if(currentTime>=notifyTime&&currentTime<trialEndTime){if((await mainDb.select().from(notifications).where(and(eq(notifications.shopId,shop.id),eq(notifications.type,"upgrade"))).limit(1)).length===0)await mainDb.insert(notifications).values({shopId:shop.id,title:"Lipia account yako!",message:`Kifurushi chako cha ${subscription} kitaisha ${new Date(shop.trialEnd).toDateString()}.`,type:"upgrade",createdAt:new Date})}}}catch(error2){console.log(error2 instanceof Error?error2.message:"Hitilafu imetokea kwenye seva")}},cleanResets=async()=>{let expiredResets=await mainDb.select({id:passwordResets.id}).from(passwordResets).where(lt(passwordResets.expiresAt,new Date));for(let reset2 of expiredResets)await mainDb.delete(passwordResets).where(eq(passwordResets.id,reset2.id))};async function cleanupOldData(){let shopsWithSubs=await mainDb.select({shopId:shops.id,subscription:shops.subscription,shopName:shops.name,email:users.email,phoneNumber:users.phoneNumber}).from(shops).innerJoin(shopUsers,eq(shops.id,shopUsers.shopId)).innerJoin(users,eq(shopUsers.userId,users.id)),tables=[expenses,sales,purchases,returns,supplierPriceHistory,products];for(let{shopId,subscription,shopName,email}of shopsWithSubs){let monthsToKeep=retentionPeriods[subscription];if(!monthsToKeep)continue;let cutoffDate=new Date;cutoffDate.setMonth(cutoffDate.getMonth()-monthsToKeep);let deletionCutoff=new Date;deletionCutoff.setMonth(deletionCutoff.getMonth()-monthsToKeep);let notificationCutoff=new Date(deletionCutoff);if(notificationCutoff.setDate(notificationCutoff.getDate()-7),new Date>=notificationCutoff&&new Date<deletionCutoff)await mainDb.insert(notifications).values({shopId,title:"Ufutaji wa taarifa",message:`Taarifa zako za zaidi ya ${monthsToKeep===1?"mwezi":"miezi"} ${monthsToKeep}, zitafutwa tarehe ${deletionCutoff.toLocaleDateString()}. Tafadhali pakua nakala yako kama unazihitaji`,type:"warning"}),await sendDelWarning({shopName,email,monthsToKeep,warningDays:7});for(let table of tables){let attempts=0,batchSize=1000;while(attempts<3)try{while(!0){let rowsToDelete=await mainDb.select({id:table.id}).from(table).where(and(eq(table.shopId,shopId),lt(table.createdAt,cutoffDate))).limit(batchSize);if(rowsToDelete.length===0)break;let ids=rowsToDelete.map((r)=>r.id);await mainDb.delete(table).where(inArray(table.id,ids)),console.log(`Deleted ${ids.length} rows from ${table._.name} for shop ${shopId}`),await new Promise((resolve)=>setTimeout(resolve,300))}break}catch(error2){attempts++,console.error(`Attempt ${attempts} failed for table ${table._.name}, shop ${shopId}:`,error2),await new Promise((resolve)=>setTimeout(resolve,600))}}}}var bgJobsPlugin=new Elysia().use(cron({name:"clear-emails",pattern:"0 */12 * * *",async run(){try{console.time("clearVerifiedEmails"),await clearVerifiedEmails(),console.timeEnd("clearVerifiedEmails")}catch(error2){console.error("[Cron] clearVerifiedEmails failed:",error2)}}})).use(cron({name:"api-warmup",pattern:"*/20 * * * *",run(){try{console.time("pingAPI"),pingAPI(),console.timeEnd("pingAPI")}catch(error2){console.error("[Cron] API warmup failed:",error2)}}})).use(cron({name:"trial-check",pattern:"30 */12 * * *",async run(){try{console.time("trialCheck"),await isTrialEnd(),console.timeEnd("trialCheck")}catch(error2){console.error("[Cron] Trial check failed:",error2)}}})).use(cron({name:"data-cleanup",pattern:"0 0 */2 * *",async run(){try{console.time("cleanupOldData"),await cleanupOldData(),console.timeEnd("cleanupOldData")}catch(error2){console.error("[Cron] Data cleanup failed:",error2)}}})).use(cron({name:"reset-cleanup",pattern:"15 8 * * *",async run(){try{console.time("reset-cleanup"),await cleanResets(),console.timeEnd("reset-cleanup")}catch(error2){console.error("[Cron] Reset cleanup failed:",error2)}}})).use(cron({name:"trial-notifications",pattern:"30 9 * * *",async run(){try{console.time("trial-notification"),await notifyBeforeEnds(),console.timeEnd("trial-notification")}catch(error2){console.error("[Cron] Trial notifications failed:",error2)}}}));var startTime=Date.now(),frontendURL4=process.env.FRONTEND_URL_DEV;new Elysia().use(dist_default()).use(cors({allowedHeaders:["Content-Type","Authorization","Accept-Language"],credentials:!0,methods:["GET","POST","PUT","DELETE","OPTIONS"],maxAge:3600,origin:frontendURL4})).onRequest(({set:set2})=>{set2.headers["Content-Security-Policy"]="default-src 'self'; script-src 'self'",set2.headers["X-Frame-Options"]="DENY",set2.headers["X-Content-Type-Options"]="nosniff"}).use(csrfProtection).onRequest(rateLimitMiddleware).use(home_default).use(registration_default).use(loginPlugin).use(supplier_default).use(prodPlugin).use(mailPlugin).use(CustomersPlugin).use(analytics_default).use(authPlugin).use(settings_default).use(google_default).use(payment_default).use(notifications_default).use(expensesPlugin).use(debtPlugin).use(trackingVisitors).use(askedPlugin).use(resetPlugin).use(speechPlugin).use(bgJobsPlugin).listen(process.env.PORT??3000);var endTime=Date.now();console.log(`Server Execution Time: ${endTime-startTime}ms`);console.log("Server is running ... ");

//# debugId=1D92DE7AD44508E064756E2164756E21
//# sourceMappingURL=server.map
